(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function s(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(a){if(a.ep)return;a.ep=!0;const l=s(a);fetch(a.href,l)}})();function $v(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var yd={exports:{}},No={};var Sy;function qv(){if(Sy)return No;Sy=1;var e=Symbol.for("react.transitional.element"),t=Symbol.for("react.fragment");function s(o,a,l){var u=null;if(l!==void 0&&(u=""+l),a.key!==void 0&&(u=""+a.key),"key"in a){l={};for(var f in a)f!=="key"&&(l[f]=a[f])}else l=a;return a=l.ref,{$$typeof:e,type:o,key:u,ref:a!==void 0?a:null,props:l}}return No.Fragment=t,No.jsx=s,No.jsxs=s,No}var vy;function zv(){return vy||(vy=1,yd.exports=qv()),yd.exports}var g=zv(),gd={exports:{}},Te={};var Ay;function Vv(){if(Ay)return Te;Ay=1;var e=Symbol.for("react.transitional.element"),t=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),a=Symbol.for("react.profiler"),l=Symbol.for("react.consumer"),u=Symbol.for("react.context"),f=Symbol.for("react.forward_ref"),p=Symbol.for("react.suspense"),m=Symbol.for("react.memo"),y=Symbol.for("react.lazy"),b=Symbol.for("react.activity"),v=Symbol.iterator;function T(B){return B===null||typeof B!="object"?null:(B=v&&B[v]||B["@@iterator"],typeof B=="function"?B:null)}var S={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},x=Object.assign,_={};function E(B,W,X){this.props=B,this.context=W,this.refs=_,this.updater=X||S}E.prototype.isReactComponent={},E.prototype.setState=function(B,W){if(typeof B!="object"&&typeof B!="function"&&B!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,B,W,"setState")},E.prototype.forceUpdate=function(B){this.updater.enqueueForceUpdate(this,B,"forceUpdate")};function w(){}w.prototype=E.prototype;function M(B,W,X){this.props=B,this.context=W,this.refs=_,this.updater=X||S}var k=M.prototype=new w;k.constructor=M,x(k,E.prototype),k.isPureReactComponent=!0;var R=Array.isArray;function O(){}var I={H:null,A:null,T:null,S:null},D=Object.prototype.hasOwnProperty;function j(B,W,X){var ae=X.ref;return{$$typeof:e,type:B,key:W,ref:ae!==void 0?ae:null,props:X}}function U(B,W){return j(B.type,W,B.props)}function q(B){return typeof B=="object"&&B!==null&&B.$$typeof===e}function se(B){var W={"=":"=0",":":"=2"};return"$"+B.replace(/[=:]/g,function(X){return W[X]})}var ee=/\/+/g;function oe(B,W){return typeof B=="object"&&B!==null&&B.key!=null?se(""+B.key):W.toString(36)}function F(B){switch(B.status){case"fulfilled":return B.value;case"rejected":throw B.reason;default:switch(typeof B.status=="string"?B.then(O,O):(B.status="pending",B.then(function(W){B.status==="pending"&&(B.status="fulfilled",B.value=W)},function(W){B.status==="pending"&&(B.status="rejected",B.reason=W)})),B.status){case"fulfilled":return B.value;case"rejected":throw B.reason}}throw B}function P(B,W,X,ae,le){var ue=typeof B;(ue==="undefined"||ue==="boolean")&&(B=null);var be=!1;if(B===null)be=!0;else switch(ue){case"bigint":case"string":case"number":be=!0;break;case"object":switch(B.$$typeof){case e:case t:be=!0;break;case y:return be=B._init,P(be(B._payload),W,X,ae,le)}}if(be)return le=le(B),be=ae===""?"."+oe(B,0):ae,R(le)?(X="",be!=null&&(X=be.replace(ee,"$&/")+"/"),P(le,W,X,"",function(at){return at})):le!=null&&(q(le)&&(le=U(le,X+(le.key==null||B&&B.key===le.key?"":(""+le.key).replace(ee,"$&/")+"/")+be)),W.push(le)),1;be=0;var $e=ae===""?".":ae+":";if(R(B))for(var Ee=0;Ee<B.length;Ee++)ae=B[Ee],ue=$e+oe(ae,Ee),be+=P(ae,W,X,ue,le);else if(Ee=T(B),typeof Ee=="function")for(B=Ee.call(B),Ee=0;!(ae=B.next()).done;)ae=ae.value,ue=$e+oe(ae,Ee++),be+=P(ae,W,X,ue,le);else if(ue==="object"){if(typeof B.then=="function")return P(F(B),W,X,ae,le);throw W=String(B),Error("Objects are not valid as a React child (found: "+(W==="[object Object]"?"object with keys {"+Object.keys(B).join(", ")+"}":W)+"). If you meant to render a collection of children, use an array instead.")}return be}function z(B,W,X){if(B==null)return B;var ae=[],le=0;return P(B,ae,"","",function(ue){return W.call(X,ue,le++)}),ae}function Z(B){if(B._status===-1){var W=B._result;W=W(),W.then(function(X){(B._status===0||B._status===-1)&&(B._status=1,B._result=X)},function(X){(B._status===0||B._status===-1)&&(B._status=2,B._result=X)}),B._status===-1&&(B._status=0,B._result=W)}if(B._status===1)return B._result.default;throw B._result}var re=typeof reportError=="function"?reportError:function(B){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var W=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof B=="object"&&B!==null&&typeof B.message=="string"?String(B.message):String(B),error:B});if(!window.dispatchEvent(W))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",B);return}console.error(B)},pe={map:z,forEach:function(B,W,X){z(B,function(){W.apply(this,arguments)},X)},count:function(B){var W=0;return z(B,function(){W++}),W},toArray:function(B){return z(B,function(W){return W})||[]},only:function(B){if(!q(B))throw Error("React.Children.only expected to receive a single React element child.");return B}};return Te.Activity=b,Te.Children=pe,Te.Component=E,Te.Fragment=s,Te.Profiler=a,Te.PureComponent=M,Te.StrictMode=o,Te.Suspense=p,Te.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=I,Te.__COMPILER_RUNTIME={__proto__:null,c:function(B){return I.H.useMemoCache(B)}},Te.cache=function(B){return function(){return B.apply(null,arguments)}},Te.cacheSignal=function(){return null},Te.cloneElement=function(B,W,X){if(B==null)throw Error("The argument must be a React element, but you passed "+B+".");var ae=x({},B.props),le=B.key;if(W!=null)for(ue in W.key!==void 0&&(le=""+W.key),W)!D.call(W,ue)||ue==="key"||ue==="__self"||ue==="__source"||ue==="ref"&&W.ref===void 0||(ae[ue]=W[ue]);var ue=arguments.length-2;if(ue===1)ae.children=X;else if(1<ue){for(var be=Array(ue),$e=0;$e<ue;$e++)be[$e]=arguments[$e+2];ae.children=be}return j(B.type,le,ae)},Te.createContext=function(B){return B={$$typeof:u,_currentValue:B,_currentValue2:B,_threadCount:0,Provider:null,Consumer:null},B.Provider=B,B.Consumer={$$typeof:l,_context:B},B},Te.createElement=function(B,W,X){var ae,le={},ue=null;if(W!=null)for(ae in W.key!==void 0&&(ue=""+W.key),W)D.call(W,ae)&&ae!=="key"&&ae!=="__self"&&ae!=="__source"&&(le[ae]=W[ae]);var be=arguments.length-2;if(be===1)le.children=X;else if(1<be){for(var $e=Array(be),Ee=0;Ee<be;Ee++)$e[Ee]=arguments[Ee+2];le.children=$e}if(B&&B.defaultProps)for(ae in be=B.defaultProps,be)le[ae]===void 0&&(le[ae]=be[ae]);return j(B,ue,le)},Te.createRef=function(){return{current:null}},Te.forwardRef=function(B){return{$$typeof:f,render:B}},Te.isValidElement=q,Te.lazy=function(B){return{$$typeof:y,_payload:{_status:-1,_result:B},_init:Z}},Te.memo=function(B,W){return{$$typeof:m,type:B,compare:W===void 0?null:W}},Te.startTransition=function(B){var W=I.T,X={};I.T=X;try{var ae=B(),le=I.S;le!==null&&le(X,ae),typeof ae=="object"&&ae!==null&&typeof ae.then=="function"&&ae.then(O,re)}catch(ue){re(ue)}finally{W!==null&&X.types!==null&&(W.types=X.types),I.T=W}},Te.unstable_useCacheRefresh=function(){return I.H.useCacheRefresh()},Te.use=function(B){return I.H.use(B)},Te.useActionState=function(B,W,X){return I.H.useActionState(B,W,X)},Te.useCallback=function(B,W){return I.H.useCallback(B,W)},Te.useContext=function(B){return I.H.useContext(B)},Te.useDebugValue=function(){},Te.useDeferredValue=function(B,W){return I.H.useDeferredValue(B,W)},Te.useEffect=function(B,W){return I.H.useEffect(B,W)},Te.useEffectEvent=function(B){return I.H.useEffectEvent(B)},Te.useId=function(){return I.H.useId()},Te.useImperativeHandle=function(B,W,X){return I.H.useImperativeHandle(B,W,X)},Te.useInsertionEffect=function(B,W){return I.H.useInsertionEffect(B,W)},Te.useLayoutEffect=function(B,W){return I.H.useLayoutEffect(B,W)},Te.useMemo=function(B,W){return I.H.useMemo(B,W)},Te.useOptimistic=function(B,W){return I.H.useOptimistic(B,W)},Te.useReducer=function(B,W,X){return I.H.useReducer(B,W,X)},Te.useRef=function(B){return I.H.useRef(B)},Te.useState=function(B){return I.H.useState(B)},Te.useSyncExternalStore=function(B,W,X){return I.H.useSyncExternalStore(B,W,X)},Te.useTransition=function(){return I.H.useTransition()},Te.version="19.2.3",Te}var xy;function df(){return xy||(xy=1,gd.exports=Vv()),gd.exports}var N=df();const Ln=$v(N);var bd={exports:{}},Ro={},Sd={exports:{}},vd={};var Ty;function Yv(){return Ty||(Ty=1,(function(e){function t(P,z){var Z=P.length;P.push(z);e:for(;0<Z;){var re=Z-1>>>1,pe=P[re];if(0<a(pe,z))P[re]=z,P[Z]=pe,Z=re;else break e}}function s(P){return P.length===0?null:P[0]}function o(P){if(P.length===0)return null;var z=P[0],Z=P.pop();if(Z!==z){P[0]=Z;e:for(var re=0,pe=P.length,B=pe>>>1;re<B;){var W=2*(re+1)-1,X=P[W],ae=W+1,le=P[ae];if(0>a(X,Z))ae<pe&&0>a(le,X)?(P[re]=le,P[ae]=Z,re=ae):(P[re]=X,P[W]=Z,re=W);else if(ae<pe&&0>a(le,Z))P[re]=le,P[ae]=Z,re=ae;else break e}}return z}function a(P,z){var Z=P.sortIndex-z.sortIndex;return Z!==0?Z:P.id-z.id}if(e.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var l=performance;e.unstable_now=function(){return l.now()}}else{var u=Date,f=u.now();e.unstable_now=function(){return u.now()-f}}var p=[],m=[],y=1,b=null,v=3,T=!1,S=!1,x=!1,_=!1,E=typeof setTimeout=="function"?setTimeout:null,w=typeof clearTimeout=="function"?clearTimeout:null,M=typeof setImmediate<"u"?setImmediate:null;function k(P){for(var z=s(m);z!==null;){if(z.callback===null)o(m);else if(z.startTime<=P)o(m),z.sortIndex=z.expirationTime,t(p,z);else break;z=s(m)}}function R(P){if(x=!1,k(P),!S)if(s(p)!==null)S=!0,O||(O=!0,se());else{var z=s(m);z!==null&&F(R,z.startTime-P)}}var O=!1,I=-1,D=5,j=-1;function U(){return _?!0:!(e.unstable_now()-j<D)}function q(){if(_=!1,O){var P=e.unstable_now();j=P;var z=!0;try{e:{S=!1,x&&(x=!1,w(I),I=-1),T=!0;var Z=v;try{t:{for(k(P),b=s(p);b!==null&&!(b.expirationTime>P&&U());){var re=b.callback;if(typeof re=="function"){b.callback=null,v=b.priorityLevel;var pe=re(b.expirationTime<=P);if(P=e.unstable_now(),typeof pe=="function"){b.callback=pe,k(P),z=!0;break t}b===s(p)&&o(p),k(P)}else o(p);b=s(p)}if(b!==null)z=!0;else{var B=s(m);B!==null&&F(R,B.startTime-P),z=!1}}break e}finally{b=null,v=Z,T=!1}z=void 0}}finally{z?se():O=!1}}}var se;if(typeof M=="function")se=function(){M(q)};else if(typeof MessageChannel<"u"){var ee=new MessageChannel,oe=ee.port2;ee.port1.onmessage=q,se=function(){oe.postMessage(null)}}else se=function(){E(q,0)};function F(P,z){I=E(function(){P(e.unstable_now())},z)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(P){P.callback=null},e.unstable_forceFrameRate=function(P){0>P||125<P?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):D=0<P?Math.floor(1e3/P):5},e.unstable_getCurrentPriorityLevel=function(){return v},e.unstable_next=function(P){switch(v){case 1:case 2:case 3:var z=3;break;default:z=v}var Z=v;v=z;try{return P()}finally{v=Z}},e.unstable_requestPaint=function(){_=!0},e.unstable_runWithPriority=function(P,z){switch(P){case 1:case 2:case 3:case 4:case 5:break;default:P=3}var Z=v;v=P;try{return z()}finally{v=Z}},e.unstable_scheduleCallback=function(P,z,Z){var re=e.unstable_now();switch(typeof Z=="object"&&Z!==null?(Z=Z.delay,Z=typeof Z=="number"&&0<Z?re+Z:re):Z=re,P){case 1:var pe=-1;break;case 2:pe=250;break;case 5:pe=1073741823;break;case 4:pe=1e4;break;default:pe=5e3}return pe=Z+pe,P={id:y++,callback:z,priorityLevel:P,startTime:Z,expirationTime:pe,sortIndex:-1},Z>re?(P.sortIndex=Z,t(m,P),s(p)===null&&P===s(m)&&(x?(w(I),I=-1):x=!0,F(R,Z-re))):(P.sortIndex=pe,t(p,P),S||T||(S=!0,O||(O=!0,se()))),P},e.unstable_shouldYield=U,e.unstable_wrapCallback=function(P){var z=v;return function(){var Z=v;v=z;try{return P.apply(this,arguments)}finally{v=Z}}}})(vd)),vd}var Ey;function Kv(){return Ey||(Ey=1,Sd.exports=Yv()),Sd.exports}var Ad={exports:{}},Vt={};var _y;function Fv(){if(_y)return Vt;_y=1;var e=df();function t(p){var m="https://react.dev/errors/"+p;if(1<arguments.length){m+="?args[]="+encodeURIComponent(arguments[1]);for(var y=2;y<arguments.length;y++)m+="&args[]="+encodeURIComponent(arguments[y])}return"Minified React error #"+p+"; visit "+m+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function s(){}var o={d:{f:s,r:function(){throw Error(t(522))},D:s,C:s,L:s,m:s,X:s,S:s,M:s},p:0,findDOMNode:null},a=Symbol.for("react.portal");function l(p,m,y){var b=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:a,key:b==null?null:""+b,children:p,containerInfo:m,implementation:y}}var u=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function f(p,m){if(p==="font")return"";if(typeof m=="string")return m==="use-credentials"?m:""}return Vt.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=o,Vt.createPortal=function(p,m){var y=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!m||m.nodeType!==1&&m.nodeType!==9&&m.nodeType!==11)throw Error(t(299));return l(p,m,null,y)},Vt.flushSync=function(p){var m=u.T,y=o.p;try{if(u.T=null,o.p=2,p)return p()}finally{u.T=m,o.p=y,o.d.f()}},Vt.preconnect=function(p,m){typeof p=="string"&&(m?(m=m.crossOrigin,m=typeof m=="string"?m==="use-credentials"?m:"":void 0):m=null,o.d.C(p,m))},Vt.prefetchDNS=function(p){typeof p=="string"&&o.d.D(p)},Vt.preinit=function(p,m){if(typeof p=="string"&&m&&typeof m.as=="string"){var y=m.as,b=f(y,m.crossOrigin),v=typeof m.integrity=="string"?m.integrity:void 0,T=typeof m.fetchPriority=="string"?m.fetchPriority:void 0;y==="style"?o.d.S(p,typeof m.precedence=="string"?m.precedence:void 0,{crossOrigin:b,integrity:v,fetchPriority:T}):y==="script"&&o.d.X(p,{crossOrigin:b,integrity:v,fetchPriority:T,nonce:typeof m.nonce=="string"?m.nonce:void 0})}},Vt.preinitModule=function(p,m){if(typeof p=="string")if(typeof m=="object"&&m!==null){if(m.as==null||m.as==="script"){var y=f(m.as,m.crossOrigin);o.d.M(p,{crossOrigin:y,integrity:typeof m.integrity=="string"?m.integrity:void 0,nonce:typeof m.nonce=="string"?m.nonce:void 0})}}else m==null&&o.d.M(p)},Vt.preload=function(p,m){if(typeof p=="string"&&typeof m=="object"&&m!==null&&typeof m.as=="string"){var y=m.as,b=f(y,m.crossOrigin);o.d.L(p,y,{crossOrigin:b,integrity:typeof m.integrity=="string"?m.integrity:void 0,nonce:typeof m.nonce=="string"?m.nonce:void 0,type:typeof m.type=="string"?m.type:void 0,fetchPriority:typeof m.fetchPriority=="string"?m.fetchPriority:void 0,referrerPolicy:typeof m.referrerPolicy=="string"?m.referrerPolicy:void 0,imageSrcSet:typeof m.imageSrcSet=="string"?m.imageSrcSet:void 0,imageSizes:typeof m.imageSizes=="string"?m.imageSizes:void 0,media:typeof m.media=="string"?m.media:void 0})}},Vt.preloadModule=function(p,m){if(typeof p=="string")if(m){var y=f(m.as,m.crossOrigin);o.d.m(p,{as:typeof m.as=="string"&&m.as!=="script"?m.as:void 0,crossOrigin:y,integrity:typeof m.integrity=="string"?m.integrity:void 0})}else o.d.m(p)},Vt.requestFormReset=function(p){o.d.r(p)},Vt.unstable_batchedUpdates=function(p,m){return p(m)},Vt.useFormState=function(p,m,y){return u.H.useFormState(p,m,y)},Vt.useFormStatus=function(){return u.H.useHostTransitionStatus()},Vt.version="19.2.3",Vt}var My;function Wv(){if(My)return Ad.exports;My=1;function e(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(t){console.error(t)}}return e(),Ad.exports=Fv(),Ad.exports}var wy;function Xv(){if(wy)return Ro;wy=1;var e=Kv(),t=df(),s=Wv();function o(n){var i="https://react.dev/errors/"+n;if(1<arguments.length){i+="?args[]="+encodeURIComponent(arguments[1]);for(var r=2;r<arguments.length;r++)i+="&args[]="+encodeURIComponent(arguments[r])}return"Minified React error #"+n+"; visit "+i+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function a(n){return!(!n||n.nodeType!==1&&n.nodeType!==9&&n.nodeType!==11)}function l(n){var i=n,r=n;if(n.alternate)for(;i.return;)i=i.return;else{n=i;do i=n,(i.flags&4098)!==0&&(r=i.return),n=i.return;while(n)}return i.tag===3?r:null}function u(n){if(n.tag===13){var i=n.memoizedState;if(i===null&&(n=n.alternate,n!==null&&(i=n.memoizedState)),i!==null)return i.dehydrated}return null}function f(n){if(n.tag===31){var i=n.memoizedState;if(i===null&&(n=n.alternate,n!==null&&(i=n.memoizedState)),i!==null)return i.dehydrated}return null}function p(n){if(l(n)!==n)throw Error(o(188))}function m(n){var i=n.alternate;if(!i){if(i=l(n),i===null)throw Error(o(188));return i!==n?null:n}for(var r=n,c=i;;){var d=r.return;if(d===null)break;var h=d.alternate;if(h===null){if(c=d.return,c!==null){r=c;continue}break}if(d.child===h.child){for(h=d.child;h;){if(h===r)return p(d),n;if(h===c)return p(d),i;h=h.sibling}throw Error(o(188))}if(r.return!==c.return)r=d,c=h;else{for(var A=!1,C=d.child;C;){if(C===r){A=!0,r=d,c=h;break}if(C===c){A=!0,c=d,r=h;break}C=C.sibling}if(!A){for(C=h.child;C;){if(C===r){A=!0,r=h,c=d;break}if(C===c){A=!0,c=h,r=d;break}C=C.sibling}if(!A)throw Error(o(189))}}if(r.alternate!==c)throw Error(o(190))}if(r.tag!==3)throw Error(o(188));return r.stateNode.current===r?n:i}function y(n){var i=n.tag;if(i===5||i===26||i===27||i===6)return n;for(n=n.child;n!==null;){if(i=y(n),i!==null)return i;n=n.sibling}return null}var b=Object.assign,v=Symbol.for("react.element"),T=Symbol.for("react.transitional.element"),S=Symbol.for("react.portal"),x=Symbol.for("react.fragment"),_=Symbol.for("react.strict_mode"),E=Symbol.for("react.profiler"),w=Symbol.for("react.consumer"),M=Symbol.for("react.context"),k=Symbol.for("react.forward_ref"),R=Symbol.for("react.suspense"),O=Symbol.for("react.suspense_list"),I=Symbol.for("react.memo"),D=Symbol.for("react.lazy"),j=Symbol.for("react.activity"),U=Symbol.for("react.memo_cache_sentinel"),q=Symbol.iterator;function se(n){return n===null||typeof n!="object"?null:(n=q&&n[q]||n["@@iterator"],typeof n=="function"?n:null)}var ee=Symbol.for("react.client.reference");function oe(n){if(n==null)return null;if(typeof n=="function")return n.$$typeof===ee?null:n.displayName||n.name||null;if(typeof n=="string")return n;switch(n){case x:return"Fragment";case E:return"Profiler";case _:return"StrictMode";case R:return"Suspense";case O:return"SuspenseList";case j:return"Activity"}if(typeof n=="object")switch(n.$$typeof){case S:return"Portal";case M:return n.displayName||"Context";case w:return(n._context.displayName||"Context")+".Consumer";case k:var i=n.render;return n=n.displayName,n||(n=i.displayName||i.name||"",n=n!==""?"ForwardRef("+n+")":"ForwardRef"),n;case I:return i=n.displayName||null,i!==null?i:oe(n.type)||"Memo";case D:i=n._payload,n=n._init;try{return oe(n(i))}catch{}}return null}var F=Array.isArray,P=t.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,z=s.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,Z={pending:!1,data:null,method:null,action:null},re=[],pe=-1;function B(n){return{current:n}}function W(n){0>pe||(n.current=re[pe],re[pe]=null,pe--)}function X(n,i){pe++,re[pe]=n.current,n.current=i}var ae=B(null),le=B(null),ue=B(null),be=B(null);function $e(n,i){switch(X(ue,i),X(le,n),X(ae,null),i.nodeType){case 9:case 11:n=(n=i.documentElement)&&(n=n.namespaceURI)?qh(n):0;break;default:if(n=i.tagName,i=i.namespaceURI)i=qh(i),n=zh(i,n);else switch(n){case"svg":n=1;break;case"math":n=2;break;default:n=0}}W(ae),X(ae,n)}function Ee(){W(ae),W(le),W(ue)}function at(n){n.memoizedState!==null&&X(be,n);var i=ae.current,r=zh(i,n.type);i!==r&&(X(le,n),X(ae,r))}function ot(n){le.current===n&&(W(ae),W(le)),be.current===n&&(W(be),wo._currentValue=Z)}var kt,wt;function ke(n){if(kt===void 0)try{throw Error()}catch(r){var i=r.stack.trim().match(/\n( *(at )?)/);kt=i&&i[1]||"",wt=-1<r.stack.indexOf(`
    at`)?" (<anonymous>)":-1<r.stack.indexOf("@")?"@unknown:0:0":""}return`
`+kt+n+wt}var et=!1;function Gt(n,i){if(!n||et)return"";et=!0;var r=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var c={DetermineComponentFrameRoot:function(){try{if(i){var ie=function(){throw Error()};if(Object.defineProperty(ie.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(ie,[])}catch(Q){var K=Q}Reflect.construct(n,[],ie)}else{try{ie.call()}catch(Q){K=Q}n.call(ie.prototype)}}else{try{throw Error()}catch(Q){K=Q}(ie=n())&&typeof ie.catch=="function"&&ie.catch(function(){})}}catch(Q){if(Q&&K&&typeof Q.stack=="string")return[Q.stack,K.stack]}return[null,null]}};c.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var d=Object.getOwnPropertyDescriptor(c.DetermineComponentFrameRoot,"name");d&&d.configurable&&Object.defineProperty(c.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var h=c.DetermineComponentFrameRoot(),A=h[0],C=h[1];if(A&&C){var L=A.split(`
`),Y=C.split(`
`);for(d=c=0;c<L.length&&!L[c].includes("DetermineComponentFrameRoot");)c++;for(;d<Y.length&&!Y[d].includes("DetermineComponentFrameRoot");)d++;if(c===L.length||d===Y.length)for(c=L.length-1,d=Y.length-1;1<=c&&0<=d&&L[c]!==Y[d];)d--;for(;1<=c&&0<=d;c--,d--)if(L[c]!==Y[d]){if(c!==1||d!==1)do if(c--,d--,0>d||L[c]!==Y[d]){var te=`
`+L[c].replace(" at new "," at ");return n.displayName&&te.includes("<anonymous>")&&(te=te.replace("<anonymous>",n.displayName)),te}while(1<=c&&0<=d);break}}}finally{et=!1,Error.prepareStackTrace=r}return(r=n?n.displayName||n.name:"")?ke(r):""}function Ft(n,i){switch(n.tag){case 26:case 27:case 5:return ke(n.type);case 16:return ke("Lazy");case 13:return n.child!==i&&i!==null?ke("Suspense Fallback"):ke("Suspense");case 19:return ke("SuspenseList");case 0:case 15:return Gt(n.type,!1);case 11:return Gt(n.type.render,!1);case 1:return Gt(n.type,!0);case 31:return ke("Activity");default:return""}}function Cn(n){try{var i="",r=null;do i+=Ft(n,r),r=n,n=n.return;while(n);return i}catch(c){return`
Error generating stack: `+c.message+`
`+c.stack}}var jn=Object.prototype.hasOwnProperty,Dn=e.unstable_scheduleCallback,is=e.unstable_cancelCallback,Ia=e.unstable_shouldYield,Ls=e.unstable_requestPaint,It=e.unstable_now,La=e.unstable_getCurrentPriorityLevel,Bs=e.unstable_ImmediatePriority,Ps=e.unstable_UserBlockingPriority,Kn=e.unstable_NormalPriority,ss=e.unstable_LowPriority,as=e.unstable_IdlePriority,Ba=e.log,Pa=e.unstable_setDisableYieldValue,Fn=null,Lt=null;function mt(n){if(typeof Ba=="function"&&Pa(n),Lt&&typeof Lt.setStrictMode=="function")try{Lt.setStrictMode(Fn,n)}catch{}}var pt=Math.clz32?Math.clz32:ht,Ha=Math.log,_e=Math.LN2;function ht(n){return n>>>=0,n===0?32:31-(Ha(n)/_e|0)|0}var Bt=256,rt=262144,pn=4194304;function on(n){var i=n&42;if(i!==0)return i;switch(n&-n){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return n&261888;case 262144:case 524288:case 1048576:case 2097152:return n&3932160;case 4194304:case 8388608:case 16777216:case 33554432:return n&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return n}}function Ai(n,i,r){var c=n.pendingLanes;if(c===0)return 0;var d=0,h=n.suspendedLanes,A=n.pingedLanes;n=n.warmLanes;var C=c&134217727;return C!==0?(c=C&~h,c!==0?d=on(c):(A&=C,A!==0?d=on(A):r||(r=C&~n,r!==0&&(d=on(r))))):(C=c&~h,C!==0?d=on(C):A!==0?d=on(A):r||(r=c&~n,r!==0&&(d=on(r)))),d===0?0:i!==0&&i!==d&&(i&h)===0&&(h=d&-d,r=i&-i,h>=r||h===32&&(r&4194048)!==0)?i:d}function os(n,i){return(n.pendingLanes&~(n.suspendedLanes&~n.pingedLanes)&i)===0}function oc(n,i){switch(n){case 1:case 2:case 4:case 8:case 64:return i+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return i+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function ja(){var n=pn;return pn<<=1,(pn&62914560)===0&&(pn=4194304),n}function Hs(n){for(var i=[],r=0;31>r;r++)i.push(n);return i}function rs(n,i){n.pendingLanes|=i,i!==268435456&&(n.suspendedLanes=0,n.pingedLanes=0,n.warmLanes=0)}function Jt(n,i,r,c,d,h){var A=n.pendingLanes;n.pendingLanes=r,n.suspendedLanes=0,n.pingedLanes=0,n.warmLanes=0,n.expiredLanes&=r,n.entangledLanes&=r,n.errorRecoveryDisabledLanes&=r,n.shellSuspendCounter=0;var C=n.entanglements,L=n.expirationTimes,Y=n.hiddenUpdates;for(r=A&~r;0<r;){var te=31-pt(r),ie=1<<te;C[te]=0,L[te]=-1;var K=Y[te];if(K!==null)for(Y[te]=null,te=0;te<K.length;te++){var Q=K[te];Q!==null&&(Q.lane&=-536870913)}r&=~ie}c!==0&&Pt(n,c,0),h!==0&&d===0&&n.tag!==0&&(n.suspendedLanes|=h&~(A&~i))}function Pt(n,i,r){n.pendingLanes|=i,n.suspendedLanes&=~i;var c=31-pt(i);n.entangledLanes|=i,n.entanglements[c]=n.entanglements[c]|1073741824|r&261930}function On(n,i){var r=n.entangledLanes|=i;for(n=n.entanglements;r;){var c=31-pt(r),d=1<<c;d&i|n[c]&i&&(n[c]|=i),r&=~d}}function js(n,i){var r=i&-i;return r=(r&42)!==0?1:Da(r),(r&(n.suspendedLanes|i))!==0?0:r}function Da(n){switch(n){case 2:n=1;break;case 8:n=4;break;case 32:n=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:n=128;break;case 268435456:n=134217728;break;default:n=0}return n}function Ds(n){return n&=-n,2<n?8<n?(n&134217727)!==0?32:268435456:8:2}function Ua(){var n=z.p;return n!==0?n:(n=window.event,n===void 0?32:fy(n.type))}function Cf(n,i){var r=z.p;try{return z.p=n,i()}finally{z.p=r}}var xi=Math.random().toString(36).slice(2),Ht="__reactFiber$"+xi,Qt="__reactProps$"+xi,Us="__reactContainer$"+xi,rc="__reactEvents$"+xi,kb="__reactListeners$"+xi,Nb="__reactHandles$"+xi,Of="__reactResources$"+xi,$a="__reactMarker$"+xi;function lc(n){delete n[Ht],delete n[Qt],delete n[rc],delete n[kb],delete n[Nb]}function $s(n){var i=n[Ht];if(i)return i;for(var r=n.parentNode;r;){if(i=r[Us]||r[Ht]){if(r=i.alternate,i.child!==null||r!==null&&r.child!==null)for(n=Gh(n);n!==null;){if(r=n[Ht])return r;n=Gh(n)}return i}n=r,r=n.parentNode}return null}function qs(n){if(n=n[Ht]||n[Us]){var i=n.tag;if(i===5||i===6||i===13||i===31||i===26||i===27||i===3)return n}return null}function qa(n){var i=n.tag;if(i===5||i===26||i===27||i===6)return n.stateNode;throw Error(o(33))}function zs(n){var i=n[Of];return i||(i=n[Of]={hoistableStyles:new Map,hoistableScripts:new Map}),i}function Nt(n){n[$a]=!0}var kf=new Set,Nf={};function ls(n,i){Vs(n,i),Vs(n+"Capture",i)}function Vs(n,i){for(Nf[n]=i,n=0;n<i.length;n++)kf.add(i[n])}var Rb=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),Rf={},If={};function Ib(n){return jn.call(If,n)?!0:jn.call(Rf,n)?!1:Rb.test(n)?If[n]=!0:(Rf[n]=!0,!1)}function er(n,i,r){if(Ib(i))if(r===null)n.removeAttribute(i);else{switch(typeof r){case"undefined":case"function":case"symbol":n.removeAttribute(i);return;case"boolean":var c=i.toLowerCase().slice(0,5);if(c!=="data-"&&c!=="aria-"){n.removeAttribute(i);return}}n.setAttribute(i,""+r)}}function tr(n,i,r){if(r===null)n.removeAttribute(i);else{switch(typeof r){case"undefined":case"function":case"symbol":case"boolean":n.removeAttribute(i);return}n.setAttribute(i,""+r)}}function Wn(n,i,r,c){if(c===null)n.removeAttribute(r);else{switch(typeof c){case"undefined":case"function":case"symbol":case"boolean":n.removeAttribute(r);return}n.setAttributeNS(i,r,""+c)}}function hn(n){switch(typeof n){case"bigint":case"boolean":case"number":case"string":case"undefined":return n;case"object":return n;default:return""}}function Lf(n){var i=n.type;return(n=n.nodeName)&&n.toLowerCase()==="input"&&(i==="checkbox"||i==="radio")}function Lb(n,i,r){var c=Object.getOwnPropertyDescriptor(n.constructor.prototype,i);if(!n.hasOwnProperty(i)&&typeof c<"u"&&typeof c.get=="function"&&typeof c.set=="function"){var d=c.get,h=c.set;return Object.defineProperty(n,i,{configurable:!0,get:function(){return d.call(this)},set:function(A){r=""+A,h.call(this,A)}}),Object.defineProperty(n,i,{enumerable:c.enumerable}),{getValue:function(){return r},setValue:function(A){r=""+A},stopTracking:function(){n._valueTracker=null,delete n[i]}}}}function cc(n){if(!n._valueTracker){var i=Lf(n)?"checked":"value";n._valueTracker=Lb(n,i,""+n[i])}}function Bf(n){if(!n)return!1;var i=n._valueTracker;if(!i)return!0;var r=i.getValue(),c="";return n&&(c=Lf(n)?n.checked?"true":"false":n.value),n=c,n!==r?(i.setValue(n),!0):!1}function nr(n){if(n=n||(typeof document<"u"?document:void 0),typeof n>"u")return null;try{return n.activeElement||n.body}catch{return n.body}}var Bb=/[\n"\\]/g;function yn(n){return n.replace(Bb,function(i){return"\\"+i.charCodeAt(0).toString(16)+" "})}function uc(n,i,r,c,d,h,A,C){n.name="",A!=null&&typeof A!="function"&&typeof A!="symbol"&&typeof A!="boolean"?n.type=A:n.removeAttribute("type"),i!=null?A==="number"?(i===0&&n.value===""||n.value!=i)&&(n.value=""+hn(i)):n.value!==""+hn(i)&&(n.value=""+hn(i)):A!=="submit"&&A!=="reset"||n.removeAttribute("value"),i!=null?dc(n,A,hn(i)):r!=null?dc(n,A,hn(r)):c!=null&&n.removeAttribute("value"),d==null&&h!=null&&(n.defaultChecked=!!h),d!=null&&(n.checked=d&&typeof d!="function"&&typeof d!="symbol"),C!=null&&typeof C!="function"&&typeof C!="symbol"&&typeof C!="boolean"?n.name=""+hn(C):n.removeAttribute("name")}function Pf(n,i,r,c,d,h,A,C){if(h!=null&&typeof h!="function"&&typeof h!="symbol"&&typeof h!="boolean"&&(n.type=h),i!=null||r!=null){if(!(h!=="submit"&&h!=="reset"||i!=null)){cc(n);return}r=r!=null?""+hn(r):"",i=i!=null?""+hn(i):r,C||i===n.value||(n.value=i),n.defaultValue=i}c=c??d,c=typeof c!="function"&&typeof c!="symbol"&&!!c,n.checked=C?n.checked:!!c,n.defaultChecked=!!c,A!=null&&typeof A!="function"&&typeof A!="symbol"&&typeof A!="boolean"&&(n.name=A),cc(n)}function dc(n,i,r){i==="number"&&nr(n.ownerDocument)===n||n.defaultValue===""+r||(n.defaultValue=""+r)}function Ys(n,i,r,c){if(n=n.options,i){i={};for(var d=0;d<r.length;d++)i["$"+r[d]]=!0;for(r=0;r<n.length;r++)d=i.hasOwnProperty("$"+n[r].value),n[r].selected!==d&&(n[r].selected=d),d&&c&&(n[r].defaultSelected=!0)}else{for(r=""+hn(r),i=null,d=0;d<n.length;d++){if(n[d].value===r){n[d].selected=!0,c&&(n[d].defaultSelected=!0);return}i!==null||n[d].disabled||(i=n[d])}i!==null&&(i.selected=!0)}}function Hf(n,i,r){if(i!=null&&(i=""+hn(i),i!==n.value&&(n.value=i),r==null)){n.defaultValue!==i&&(n.defaultValue=i);return}n.defaultValue=r!=null?""+hn(r):""}function jf(n,i,r,c){if(i==null){if(c!=null){if(r!=null)throw Error(o(92));if(F(c)){if(1<c.length)throw Error(o(93));c=c[0]}r=c}r==null&&(r=""),i=r}r=hn(i),n.defaultValue=r,c=n.textContent,c===r&&c!==""&&c!==null&&(n.value=c),cc(n)}function Ks(n,i){if(i){var r=n.firstChild;if(r&&r===n.lastChild&&r.nodeType===3){r.nodeValue=i;return}}n.textContent=i}var Pb=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function Df(n,i,r){var c=i.indexOf("--")===0;r==null||typeof r=="boolean"||r===""?c?n.setProperty(i,""):i==="float"?n.cssFloat="":n[i]="":c?n.setProperty(i,r):typeof r!="number"||r===0||Pb.has(i)?i==="float"?n.cssFloat=r:n[i]=(""+r).trim():n[i]=r+"px"}function Uf(n,i,r){if(i!=null&&typeof i!="object")throw Error(o(62));if(n=n.style,r!=null){for(var c in r)!r.hasOwnProperty(c)||i!=null&&i.hasOwnProperty(c)||(c.indexOf("--")===0?n.setProperty(c,""):c==="float"?n.cssFloat="":n[c]="");for(var d in i)c=i[d],i.hasOwnProperty(d)&&r[d]!==c&&Df(n,d,c)}else for(var h in i)i.hasOwnProperty(h)&&Df(n,h,i[h])}function fc(n){if(n.indexOf("-")===-1)return!1;switch(n){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Hb=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),jb=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function ir(n){return jb.test(""+n)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":n}function Xn(){}var mc=null;function pc(n){return n=n.target||n.srcElement||window,n.correspondingUseElement&&(n=n.correspondingUseElement),n.nodeType===3?n.parentNode:n}var Fs=null,Ws=null;function $f(n){var i=qs(n);if(i&&(n=i.stateNode)){var r=n[Qt]||null;e:switch(n=i.stateNode,i.type){case"input":if(uc(n,r.value,r.defaultValue,r.defaultValue,r.checked,r.defaultChecked,r.type,r.name),i=r.name,r.type==="radio"&&i!=null){for(r=n;r.parentNode;)r=r.parentNode;for(r=r.querySelectorAll('input[name="'+yn(""+i)+'"][type="radio"]'),i=0;i<r.length;i++){var c=r[i];if(c!==n&&c.form===n.form){var d=c[Qt]||null;if(!d)throw Error(o(90));uc(c,d.value,d.defaultValue,d.defaultValue,d.checked,d.defaultChecked,d.type,d.name)}}for(i=0;i<r.length;i++)c=r[i],c.form===n.form&&Bf(c)}break e;case"textarea":Hf(n,r.value,r.defaultValue);break e;case"select":i=r.value,i!=null&&Ys(n,!!r.multiple,i,!1)}}}var hc=!1;function qf(n,i,r){if(hc)return n(i,r);hc=!0;try{var c=n(i);return c}finally{if(hc=!1,(Fs!==null||Ws!==null)&&(Vr(),Fs&&(i=Fs,n=Ws,Ws=Fs=null,$f(i),n)))for(i=0;i<n.length;i++)$f(n[i])}}function za(n,i){var r=n.stateNode;if(r===null)return null;var c=r[Qt]||null;if(c===null)return null;r=c[i];e:switch(i){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(c=!c.disabled)||(n=n.type,c=!(n==="button"||n==="input"||n==="select"||n==="textarea")),n=!c;break e;default:n=!1}if(n)return null;if(r&&typeof r!="function")throw Error(o(231,i,typeof r));return r}var Gn=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),yc=!1;if(Gn)try{var Va={};Object.defineProperty(Va,"passive",{get:function(){yc=!0}}),window.addEventListener("test",Va,Va),window.removeEventListener("test",Va,Va)}catch{yc=!1}var Ti=null,gc=null,sr=null;function zf(){if(sr)return sr;var n,i=gc,r=i.length,c,d="value"in Ti?Ti.value:Ti.textContent,h=d.length;for(n=0;n<r&&i[n]===d[n];n++);var A=r-n;for(c=1;c<=A&&i[r-c]===d[h-c];c++);return sr=d.slice(n,1<c?1-c:void 0)}function ar(n){var i=n.keyCode;return"charCode"in n?(n=n.charCode,n===0&&i===13&&(n=13)):n=i,n===10&&(n=13),32<=n||n===13?n:0}function or(){return!0}function Vf(){return!1}function Zt(n){function i(r,c,d,h,A){this._reactName=r,this._targetInst=d,this.type=c,this.nativeEvent=h,this.target=A,this.currentTarget=null;for(var C in n)n.hasOwnProperty(C)&&(r=n[C],this[C]=r?r(h):h[C]);return this.isDefaultPrevented=(h.defaultPrevented!=null?h.defaultPrevented:h.returnValue===!1)?or:Vf,this.isPropagationStopped=Vf,this}return b(i.prototype,{preventDefault:function(){this.defaultPrevented=!0;var r=this.nativeEvent;r&&(r.preventDefault?r.preventDefault():typeof r.returnValue!="unknown"&&(r.returnValue=!1),this.isDefaultPrevented=or)},stopPropagation:function(){var r=this.nativeEvent;r&&(r.stopPropagation?r.stopPropagation():typeof r.cancelBubble!="unknown"&&(r.cancelBubble=!0),this.isPropagationStopped=or)},persist:function(){},isPersistent:or}),i}var cs={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(n){return n.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},rr=Zt(cs),Ya=b({},cs,{view:0,detail:0}),Db=Zt(Ya),bc,Sc,Ka,lr=b({},Ya,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Ac,button:0,buttons:0,relatedTarget:function(n){return n.relatedTarget===void 0?n.fromElement===n.srcElement?n.toElement:n.fromElement:n.relatedTarget},movementX:function(n){return"movementX"in n?n.movementX:(n!==Ka&&(Ka&&n.type==="mousemove"?(bc=n.screenX-Ka.screenX,Sc=n.screenY-Ka.screenY):Sc=bc=0,Ka=n),bc)},movementY:function(n){return"movementY"in n?n.movementY:Sc}}),Yf=Zt(lr),Ub=b({},lr,{dataTransfer:0}),$b=Zt(Ub),qb=b({},Ya,{relatedTarget:0}),vc=Zt(qb),zb=b({},cs,{animationName:0,elapsedTime:0,pseudoElement:0}),Vb=Zt(zb),Yb=b({},cs,{clipboardData:function(n){return"clipboardData"in n?n.clipboardData:window.clipboardData}}),Kb=Zt(Yb),Fb=b({},cs,{data:0}),Kf=Zt(Fb),Wb={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Xb={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Gb={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Jb(n){var i=this.nativeEvent;return i.getModifierState?i.getModifierState(n):(n=Gb[n])?!!i[n]:!1}function Ac(){return Jb}var Qb=b({},Ya,{key:function(n){if(n.key){var i=Wb[n.key]||n.key;if(i!=="Unidentified")return i}return n.type==="keypress"?(n=ar(n),n===13?"Enter":String.fromCharCode(n)):n.type==="keydown"||n.type==="keyup"?Xb[n.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Ac,charCode:function(n){return n.type==="keypress"?ar(n):0},keyCode:function(n){return n.type==="keydown"||n.type==="keyup"?n.keyCode:0},which:function(n){return n.type==="keypress"?ar(n):n.type==="keydown"||n.type==="keyup"?n.keyCode:0}}),Zb=Zt(Qb),eS=b({},lr,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Ff=Zt(eS),tS=b({},Ya,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Ac}),nS=Zt(tS),iS=b({},cs,{propertyName:0,elapsedTime:0,pseudoElement:0}),sS=Zt(iS),aS=b({},lr,{deltaX:function(n){return"deltaX"in n?n.deltaX:"wheelDeltaX"in n?-n.wheelDeltaX:0},deltaY:function(n){return"deltaY"in n?n.deltaY:"wheelDeltaY"in n?-n.wheelDeltaY:"wheelDelta"in n?-n.wheelDelta:0},deltaZ:0,deltaMode:0}),oS=Zt(aS),rS=b({},cs,{newState:0,oldState:0}),lS=Zt(rS),cS=[9,13,27,32],xc=Gn&&"CompositionEvent"in window,Fa=null;Gn&&"documentMode"in document&&(Fa=document.documentMode);var uS=Gn&&"TextEvent"in window&&!Fa,Wf=Gn&&(!xc||Fa&&8<Fa&&11>=Fa),Xf=" ",Gf=!1;function Jf(n,i){switch(n){case"keyup":return cS.indexOf(i.keyCode)!==-1;case"keydown":return i.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Qf(n){return n=n.detail,typeof n=="object"&&"data"in n?n.data:null}var Xs=!1;function dS(n,i){switch(n){case"compositionend":return Qf(i);case"keypress":return i.which!==32?null:(Gf=!0,Xf);case"textInput":return n=i.data,n===Xf&&Gf?null:n;default:return null}}function fS(n,i){if(Xs)return n==="compositionend"||!xc&&Jf(n,i)?(n=zf(),sr=gc=Ti=null,Xs=!1,n):null;switch(n){case"paste":return null;case"keypress":if(!(i.ctrlKey||i.altKey||i.metaKey)||i.ctrlKey&&i.altKey){if(i.char&&1<i.char.length)return i.char;if(i.which)return String.fromCharCode(i.which)}return null;case"compositionend":return Wf&&i.locale!=="ko"?null:i.data;default:return null}}var mS={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Zf(n){var i=n&&n.nodeName&&n.nodeName.toLowerCase();return i==="input"?!!mS[n.type]:i==="textarea"}function em(n,i,r,c){Fs?Ws?Ws.push(c):Ws=[c]:Fs=c,i=Jr(i,"onChange"),0<i.length&&(r=new rr("onChange","change",null,r,c),n.push({event:r,listeners:i}))}var Wa=null,Xa=null;function pS(n){Ph(n,0)}function cr(n){var i=qa(n);if(Bf(i))return n}function tm(n,i){if(n==="change")return i}var nm=!1;if(Gn){var Tc;if(Gn){var Ec="oninput"in document;if(!Ec){var im=document.createElement("div");im.setAttribute("oninput","return;"),Ec=typeof im.oninput=="function"}Tc=Ec}else Tc=!1;nm=Tc&&(!document.documentMode||9<document.documentMode)}function sm(){Wa&&(Wa.detachEvent("onpropertychange",am),Xa=Wa=null)}function am(n){if(n.propertyName==="value"&&cr(Xa)){var i=[];em(i,Xa,n,pc(n)),qf(pS,i)}}function hS(n,i,r){n==="focusin"?(sm(),Wa=i,Xa=r,Wa.attachEvent("onpropertychange",am)):n==="focusout"&&sm()}function yS(n){if(n==="selectionchange"||n==="keyup"||n==="keydown")return cr(Xa)}function gS(n,i){if(n==="click")return cr(i)}function bS(n,i){if(n==="input"||n==="change")return cr(i)}function SS(n,i){return n===i&&(n!==0||1/n===1/i)||n!==n&&i!==i}var rn=typeof Object.is=="function"?Object.is:SS;function Ga(n,i){if(rn(n,i))return!0;if(typeof n!="object"||n===null||typeof i!="object"||i===null)return!1;var r=Object.keys(n),c=Object.keys(i);if(r.length!==c.length)return!1;for(c=0;c<r.length;c++){var d=r[c];if(!jn.call(i,d)||!rn(n[d],i[d]))return!1}return!0}function om(n){for(;n&&n.firstChild;)n=n.firstChild;return n}function rm(n,i){var r=om(n);n=0;for(var c;r;){if(r.nodeType===3){if(c=n+r.textContent.length,n<=i&&c>=i)return{node:r,offset:i-n};n=c}e:{for(;r;){if(r.nextSibling){r=r.nextSibling;break e}r=r.parentNode}r=void 0}r=om(r)}}function lm(n,i){return n&&i?n===i?!0:n&&n.nodeType===3?!1:i&&i.nodeType===3?lm(n,i.parentNode):"contains"in n?n.contains(i):n.compareDocumentPosition?!!(n.compareDocumentPosition(i)&16):!1:!1}function cm(n){n=n!=null&&n.ownerDocument!=null&&n.ownerDocument.defaultView!=null?n.ownerDocument.defaultView:window;for(var i=nr(n.document);i instanceof n.HTMLIFrameElement;){try{var r=typeof i.contentWindow.location.href=="string"}catch{r=!1}if(r)n=i.contentWindow;else break;i=nr(n.document)}return i}function _c(n){var i=n&&n.nodeName&&n.nodeName.toLowerCase();return i&&(i==="input"&&(n.type==="text"||n.type==="search"||n.type==="tel"||n.type==="url"||n.type==="password")||i==="textarea"||n.contentEditable==="true")}var vS=Gn&&"documentMode"in document&&11>=document.documentMode,Gs=null,Mc=null,Ja=null,wc=!1;function um(n,i,r){var c=r.window===r?r.document:r.nodeType===9?r:r.ownerDocument;wc||Gs==null||Gs!==nr(c)||(c=Gs,"selectionStart"in c&&_c(c)?c={start:c.selectionStart,end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset}),Ja&&Ga(Ja,c)||(Ja=c,c=Jr(Mc,"onSelect"),0<c.length&&(i=new rr("onSelect","select",null,i,r),n.push({event:i,listeners:c}),i.target=Gs)))}function us(n,i){var r={};return r[n.toLowerCase()]=i.toLowerCase(),r["Webkit"+n]="webkit"+i,r["Moz"+n]="moz"+i,r}var Js={animationend:us("Animation","AnimationEnd"),animationiteration:us("Animation","AnimationIteration"),animationstart:us("Animation","AnimationStart"),transitionrun:us("Transition","TransitionRun"),transitionstart:us("Transition","TransitionStart"),transitioncancel:us("Transition","TransitionCancel"),transitionend:us("Transition","TransitionEnd")},Cc={},dm={};Gn&&(dm=document.createElement("div").style,"AnimationEvent"in window||(delete Js.animationend.animation,delete Js.animationiteration.animation,delete Js.animationstart.animation),"TransitionEvent"in window||delete Js.transitionend.transition);function ds(n){if(Cc[n])return Cc[n];if(!Js[n])return n;var i=Js[n],r;for(r in i)if(i.hasOwnProperty(r)&&r in dm)return Cc[n]=i[r];return n}var fm=ds("animationend"),mm=ds("animationiteration"),pm=ds("animationstart"),AS=ds("transitionrun"),xS=ds("transitionstart"),TS=ds("transitioncancel"),hm=ds("transitionend"),ym=new Map,Oc="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");Oc.push("scrollEnd");function kn(n,i){ym.set(n,i),ls(i,[n])}var ur=typeof reportError=="function"?reportError:function(n){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var i=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof n=="object"&&n!==null&&typeof n.message=="string"?String(n.message):String(n),error:n});if(!window.dispatchEvent(i))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",n);return}console.error(n)},gn=[],Qs=0,kc=0;function dr(){for(var n=Qs,i=kc=Qs=0;i<n;){var r=gn[i];gn[i++]=null;var c=gn[i];gn[i++]=null;var d=gn[i];gn[i++]=null;var h=gn[i];if(gn[i++]=null,c!==null&&d!==null){var A=c.pending;A===null?d.next=d:(d.next=A.next,A.next=d),c.pending=d}h!==0&&gm(r,d,h)}}function fr(n,i,r,c){gn[Qs++]=n,gn[Qs++]=i,gn[Qs++]=r,gn[Qs++]=c,kc|=c,n.lanes|=c,n=n.alternate,n!==null&&(n.lanes|=c)}function Nc(n,i,r,c){return fr(n,i,r,c),mr(n)}function fs(n,i){return fr(n,null,null,i),mr(n)}function gm(n,i,r){n.lanes|=r;var c=n.alternate;c!==null&&(c.lanes|=r);for(var d=!1,h=n.return;h!==null;)h.childLanes|=r,c=h.alternate,c!==null&&(c.childLanes|=r),h.tag===22&&(n=h.stateNode,n===null||n._visibility&1||(d=!0)),n=h,h=h.return;return n.tag===3?(h=n.stateNode,d&&i!==null&&(d=31-pt(r),n=h.hiddenUpdates,c=n[d],c===null?n[d]=[i]:c.push(i),i.lane=r|536870912),h):null}function mr(n){if(50<vo)throw vo=0,Uu=null,Error(o(185));for(var i=n.return;i!==null;)n=i,i=n.return;return n.tag===3?n.stateNode:null}var Zs={};function ES(n,i,r,c){this.tag=n,this.key=r,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=i,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=c,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function ln(n,i,r,c){return new ES(n,i,r,c)}function Rc(n){return n=n.prototype,!(!n||!n.isReactComponent)}function Jn(n,i){var r=n.alternate;return r===null?(r=ln(n.tag,i,n.key,n.mode),r.elementType=n.elementType,r.type=n.type,r.stateNode=n.stateNode,r.alternate=n,n.alternate=r):(r.pendingProps=i,r.type=n.type,r.flags=0,r.subtreeFlags=0,r.deletions=null),r.flags=n.flags&65011712,r.childLanes=n.childLanes,r.lanes=n.lanes,r.child=n.child,r.memoizedProps=n.memoizedProps,r.memoizedState=n.memoizedState,r.updateQueue=n.updateQueue,i=n.dependencies,r.dependencies=i===null?null:{lanes:i.lanes,firstContext:i.firstContext},r.sibling=n.sibling,r.index=n.index,r.ref=n.ref,r.refCleanup=n.refCleanup,r}function bm(n,i){n.flags&=65011714;var r=n.alternate;return r===null?(n.childLanes=0,n.lanes=i,n.child=null,n.subtreeFlags=0,n.memoizedProps=null,n.memoizedState=null,n.updateQueue=null,n.dependencies=null,n.stateNode=null):(n.childLanes=r.childLanes,n.lanes=r.lanes,n.child=r.child,n.subtreeFlags=0,n.deletions=null,n.memoizedProps=r.memoizedProps,n.memoizedState=r.memoizedState,n.updateQueue=r.updateQueue,n.type=r.type,i=r.dependencies,n.dependencies=i===null?null:{lanes:i.lanes,firstContext:i.firstContext}),n}function pr(n,i,r,c,d,h){var A=0;if(c=n,typeof n=="function")Rc(n)&&(A=1);else if(typeof n=="string")A=Ov(n,r,ae.current)?26:n==="html"||n==="head"||n==="body"?27:5;else e:switch(n){case j:return n=ln(31,r,i,d),n.elementType=j,n.lanes=h,n;case x:return ms(r.children,d,h,i);case _:A=8,d|=24;break;case E:return n=ln(12,r,i,d|2),n.elementType=E,n.lanes=h,n;case R:return n=ln(13,r,i,d),n.elementType=R,n.lanes=h,n;case O:return n=ln(19,r,i,d),n.elementType=O,n.lanes=h,n;default:if(typeof n=="object"&&n!==null)switch(n.$$typeof){case M:A=10;break e;case w:A=9;break e;case k:A=11;break e;case I:A=14;break e;case D:A=16,c=null;break e}A=29,r=Error(o(130,n===null?"null":typeof n,"")),c=null}return i=ln(A,r,i,d),i.elementType=n,i.type=c,i.lanes=h,i}function ms(n,i,r,c){return n=ln(7,n,c,i),n.lanes=r,n}function Ic(n,i,r){return n=ln(6,n,null,i),n.lanes=r,n}function Sm(n){var i=ln(18,null,null,0);return i.stateNode=n,i}function Lc(n,i,r){return i=ln(4,n.children!==null?n.children:[],n.key,i),i.lanes=r,i.stateNode={containerInfo:n.containerInfo,pendingChildren:null,implementation:n.implementation},i}var vm=new WeakMap;function bn(n,i){if(typeof n=="object"&&n!==null){var r=vm.get(n);return r!==void 0?r:(i={value:n,source:i,stack:Cn(i)},vm.set(n,i),i)}return{value:n,source:i,stack:Cn(i)}}var ea=[],ta=0,hr=null,Qa=0,Sn=[],vn=0,Ei=null,Un=1,$n="";function Qn(n,i){ea[ta++]=Qa,ea[ta++]=hr,hr=n,Qa=i}function Am(n,i,r){Sn[vn++]=Un,Sn[vn++]=$n,Sn[vn++]=Ei,Ei=n;var c=Un;n=$n;var d=32-pt(c)-1;c&=~(1<<d),r+=1;var h=32-pt(i)+d;if(30<h){var A=d-d%5;h=(c&(1<<A)-1).toString(32),c>>=A,d-=A,Un=1<<32-pt(i)+d|r<<d|c,$n=h+n}else Un=1<<h|r<<d|c,$n=n}function Bc(n){n.return!==null&&(Qn(n,1),Am(n,1,0))}function Pc(n){for(;n===hr;)hr=ea[--ta],ea[ta]=null,Qa=ea[--ta],ea[ta]=null;for(;n===Ei;)Ei=Sn[--vn],Sn[vn]=null,$n=Sn[--vn],Sn[vn]=null,Un=Sn[--vn],Sn[vn]=null}function xm(n,i){Sn[vn++]=Un,Sn[vn++]=$n,Sn[vn++]=Ei,Un=i.id,$n=i.overflow,Ei=n}var jt=null,Je=null,Pe=!1,_i=null,An=!1,Hc=Error(o(519));function Mi(n){var i=Error(o(418,1<arguments.length&&arguments[1]!==void 0&&arguments[1]?"text":"HTML",""));throw Za(bn(i,n)),Hc}function Tm(n){var i=n.stateNode,r=n.type,c=n.memoizedProps;switch(i[Ht]=n,i[Qt]=c,r){case"dialog":Re("cancel",i),Re("close",i);break;case"iframe":case"object":case"embed":Re("load",i);break;case"video":case"audio":for(r=0;r<xo.length;r++)Re(xo[r],i);break;case"source":Re("error",i);break;case"img":case"image":case"link":Re("error",i),Re("load",i);break;case"details":Re("toggle",i);break;case"input":Re("invalid",i),Pf(i,c.value,c.defaultValue,c.checked,c.defaultChecked,c.type,c.name,!0);break;case"select":Re("invalid",i);break;case"textarea":Re("invalid",i),jf(i,c.value,c.defaultValue,c.children)}r=c.children,typeof r!="string"&&typeof r!="number"&&typeof r!="bigint"||i.textContent===""+r||c.suppressHydrationWarning===!0||Uh(i.textContent,r)?(c.popover!=null&&(Re("beforetoggle",i),Re("toggle",i)),c.onScroll!=null&&Re("scroll",i),c.onScrollEnd!=null&&Re("scrollend",i),c.onClick!=null&&(i.onclick=Xn),i=!0):i=!1,i||Mi(n,!0)}function Em(n){for(jt=n.return;jt;)switch(jt.tag){case 5:case 31:case 13:An=!1;return;case 27:case 3:An=!0;return;default:jt=jt.return}}function na(n){if(n!==jt)return!1;if(!Pe)return Em(n),Pe=!0,!1;var i=n.tag,r;if((r=i!==3&&i!==27)&&((r=i===5)&&(r=n.type,r=!(r!=="form"&&r!=="button")||td(n.type,n.memoizedProps)),r=!r),r&&Je&&Mi(n),Em(n),i===13){if(n=n.memoizedState,n=n!==null?n.dehydrated:null,!n)throw Error(o(317));Je=Xh(n)}else if(i===31){if(n=n.memoizedState,n=n!==null?n.dehydrated:null,!n)throw Error(o(317));Je=Xh(n)}else i===27?(i=Je,Ui(n.type)?(n=od,od=null,Je=n):Je=i):Je=jt?Tn(n.stateNode.nextSibling):null;return!0}function ps(){Je=jt=null,Pe=!1}function jc(){var n=_i;return n!==null&&(sn===null?sn=n:sn.push.apply(sn,n),_i=null),n}function Za(n){_i===null?_i=[n]:_i.push(n)}var Dc=B(null),hs=null,Zn=null;function wi(n,i,r){X(Dc,i._currentValue),i._currentValue=r}function ei(n){n._currentValue=Dc.current,W(Dc)}function Uc(n,i,r){for(;n!==null;){var c=n.alternate;if((n.childLanes&i)!==i?(n.childLanes|=i,c!==null&&(c.childLanes|=i)):c!==null&&(c.childLanes&i)!==i&&(c.childLanes|=i),n===r)break;n=n.return}}function $c(n,i,r,c){var d=n.child;for(d!==null&&(d.return=n);d!==null;){var h=d.dependencies;if(h!==null){var A=d.child;h=h.firstContext;e:for(;h!==null;){var C=h;h=d;for(var L=0;L<i.length;L++)if(C.context===i[L]){h.lanes|=r,C=h.alternate,C!==null&&(C.lanes|=r),Uc(h.return,r,n),c||(A=null);break e}h=C.next}}else if(d.tag===18){if(A=d.return,A===null)throw Error(o(341));A.lanes|=r,h=A.alternate,h!==null&&(h.lanes|=r),Uc(A,r,n),A=null}else A=d.child;if(A!==null)A.return=d;else for(A=d;A!==null;){if(A===n){A=null;break}if(d=A.sibling,d!==null){d.return=A.return,A=d;break}A=A.return}d=A}}function ia(n,i,r,c){n=null;for(var d=i,h=!1;d!==null;){if(!h){if((d.flags&524288)!==0)h=!0;else if((d.flags&262144)!==0)break}if(d.tag===10){var A=d.alternate;if(A===null)throw Error(o(387));if(A=A.memoizedProps,A!==null){var C=d.type;rn(d.pendingProps.value,A.value)||(n!==null?n.push(C):n=[C])}}else if(d===be.current){if(A=d.alternate,A===null)throw Error(o(387));A.memoizedState.memoizedState!==d.memoizedState.memoizedState&&(n!==null?n.push(wo):n=[wo])}d=d.return}n!==null&&$c(i,n,r,c),i.flags|=262144}function yr(n){for(n=n.firstContext;n!==null;){if(!rn(n.context._currentValue,n.memoizedValue))return!0;n=n.next}return!1}function ys(n){hs=n,Zn=null,n=n.dependencies,n!==null&&(n.firstContext=null)}function Dt(n){return _m(hs,n)}function gr(n,i){return hs===null&&ys(n),_m(n,i)}function _m(n,i){var r=i._currentValue;if(i={context:i,memoizedValue:r,next:null},Zn===null){if(n===null)throw Error(o(308));Zn=i,n.dependencies={lanes:0,firstContext:i},n.flags|=524288}else Zn=Zn.next=i;return r}var _S=typeof AbortController<"u"?AbortController:function(){var n=[],i=this.signal={aborted:!1,addEventListener:function(r,c){n.push(c)}};this.abort=function(){i.aborted=!0,n.forEach(function(r){return r()})}},MS=e.unstable_scheduleCallback,wS=e.unstable_NormalPriority,St={$$typeof:M,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function qc(){return{controller:new _S,data:new Map,refCount:0}}function eo(n){n.refCount--,n.refCount===0&&MS(wS,function(){n.controller.abort()})}var to=null,zc=0,sa=0,aa=null;function CS(n,i){if(to===null){var r=to=[];zc=0,sa=Ku(),aa={status:"pending",value:void 0,then:function(c){r.push(c)}}}return zc++,i.then(Mm,Mm),i}function Mm(){if(--zc===0&&to!==null){aa!==null&&(aa.status="fulfilled");var n=to;to=null,sa=0,aa=null;for(var i=0;i<n.length;i++)(0,n[i])()}}function OS(n,i){var r=[],c={status:"pending",value:null,reason:null,then:function(d){r.push(d)}};return n.then(function(){c.status="fulfilled",c.value=i;for(var d=0;d<r.length;d++)(0,r[d])(i)},function(d){for(c.status="rejected",c.reason=d,d=0;d<r.length;d++)(0,r[d])(void 0)}),c}var wm=P.S;P.S=function(n,i){uh=It(),typeof i=="object"&&i!==null&&typeof i.then=="function"&&CS(n,i),wm!==null&&wm(n,i)};var gs=B(null);function Vc(){var n=gs.current;return n!==null?n:Xe.pooledCache}function br(n,i){i===null?X(gs,gs.current):X(gs,i.pool)}function Cm(){var n=Vc();return n===null?null:{parent:St._currentValue,pool:n}}var oa=Error(o(460)),Yc=Error(o(474)),Sr=Error(o(542)),vr={then:function(){}};function Om(n){return n=n.status,n==="fulfilled"||n==="rejected"}function km(n,i,r){switch(r=n[r],r===void 0?n.push(i):r!==i&&(i.then(Xn,Xn),i=r),i.status){case"fulfilled":return i.value;case"rejected":throw n=i.reason,Rm(n),n;default:if(typeof i.status=="string")i.then(Xn,Xn);else{if(n=Xe,n!==null&&100<n.shellSuspendCounter)throw Error(o(482));n=i,n.status="pending",n.then(function(c){if(i.status==="pending"){var d=i;d.status="fulfilled",d.value=c}},function(c){if(i.status==="pending"){var d=i;d.status="rejected",d.reason=c}})}switch(i.status){case"fulfilled":return i.value;case"rejected":throw n=i.reason,Rm(n),n}throw Ss=i,oa}}function bs(n){try{var i=n._init;return i(n._payload)}catch(r){throw r!==null&&typeof r=="object"&&typeof r.then=="function"?(Ss=r,oa):r}}var Ss=null;function Nm(){if(Ss===null)throw Error(o(459));var n=Ss;return Ss=null,n}function Rm(n){if(n===oa||n===Sr)throw Error(o(483))}var ra=null,no=0;function Ar(n){var i=no;return no+=1,ra===null&&(ra=[]),km(ra,n,i)}function io(n,i){i=i.props.ref,n.ref=i!==void 0?i:null}function xr(n,i){throw i.$$typeof===v?Error(o(525)):(n=Object.prototype.toString.call(i),Error(o(31,n==="[object Object]"?"object with keys {"+Object.keys(i).join(", ")+"}":n)))}function Im(n){function i($,H){if(n){var V=$.deletions;V===null?($.deletions=[H],$.flags|=16):V.push(H)}}function r($,H){if(!n)return null;for(;H!==null;)i($,H),H=H.sibling;return null}function c($){for(var H=new Map;$!==null;)$.key!==null?H.set($.key,$):H.set($.index,$),$=$.sibling;return H}function d($,H){return $=Jn($,H),$.index=0,$.sibling=null,$}function h($,H,V){return $.index=V,n?(V=$.alternate,V!==null?(V=V.index,V<H?($.flags|=67108866,H):V):($.flags|=67108866,H)):($.flags|=1048576,H)}function A($){return n&&$.alternate===null&&($.flags|=67108866),$}function C($,H,V,ne){return H===null||H.tag!==6?(H=Ic(V,$.mode,ne),H.return=$,H):(H=d(H,V),H.return=$,H)}function L($,H,V,ne){var Se=V.type;return Se===x?te($,H,V.props.children,ne,V.key):H!==null&&(H.elementType===Se||typeof Se=="object"&&Se!==null&&Se.$$typeof===D&&bs(Se)===H.type)?(H=d(H,V.props),io(H,V),H.return=$,H):(H=pr(V.type,V.key,V.props,null,$.mode,ne),io(H,V),H.return=$,H)}function Y($,H,V,ne){return H===null||H.tag!==4||H.stateNode.containerInfo!==V.containerInfo||H.stateNode.implementation!==V.implementation?(H=Lc(V,$.mode,ne),H.return=$,H):(H=d(H,V.children||[]),H.return=$,H)}function te($,H,V,ne,Se){return H===null||H.tag!==7?(H=ms(V,$.mode,ne,Se),H.return=$,H):(H=d(H,V),H.return=$,H)}function ie($,H,V){if(typeof H=="string"&&H!==""||typeof H=="number"||typeof H=="bigint")return H=Ic(""+H,$.mode,V),H.return=$,H;if(typeof H=="object"&&H!==null){switch(H.$$typeof){case T:return V=pr(H.type,H.key,H.props,null,$.mode,V),io(V,H),V.return=$,V;case S:return H=Lc(H,$.mode,V),H.return=$,H;case D:return H=bs(H),ie($,H,V)}if(F(H)||se(H))return H=ms(H,$.mode,V,null),H.return=$,H;if(typeof H.then=="function")return ie($,Ar(H),V);if(H.$$typeof===M)return ie($,gr($,H),V);xr($,H)}return null}function K($,H,V,ne){var Se=H!==null?H.key:null;if(typeof V=="string"&&V!==""||typeof V=="number"||typeof V=="bigint")return Se!==null?null:C($,H,""+V,ne);if(typeof V=="object"&&V!==null){switch(V.$$typeof){case T:return V.key===Se?L($,H,V,ne):null;case S:return V.key===Se?Y($,H,V,ne):null;case D:return V=bs(V),K($,H,V,ne)}if(F(V)||se(V))return Se!==null?null:te($,H,V,ne,null);if(typeof V.then=="function")return K($,H,Ar(V),ne);if(V.$$typeof===M)return K($,H,gr($,V),ne);xr($,V)}return null}function Q($,H,V,ne,Se){if(typeof ne=="string"&&ne!==""||typeof ne=="number"||typeof ne=="bigint")return $=$.get(V)||null,C(H,$,""+ne,Se);if(typeof ne=="object"&&ne!==null){switch(ne.$$typeof){case T:return $=$.get(ne.key===null?V:ne.key)||null,L(H,$,ne,Se);case S:return $=$.get(ne.key===null?V:ne.key)||null,Y(H,$,ne,Se);case D:return ne=bs(ne),Q($,H,V,ne,Se)}if(F(ne)||se(ne))return $=$.get(V)||null,te(H,$,ne,Se,null);if(typeof ne.then=="function")return Q($,H,V,Ar(ne),Se);if(ne.$$typeof===M)return Q($,H,V,gr(H,ne),Se);xr(H,ne)}return null}function me($,H,V,ne){for(var Se=null,He=null,ge=H,Ce=H=0,Be=null;ge!==null&&Ce<V.length;Ce++){ge.index>Ce?(Be=ge,ge=null):Be=ge.sibling;var je=K($,ge,V[Ce],ne);if(je===null){ge===null&&(ge=Be);break}n&&ge&&je.alternate===null&&i($,ge),H=h(je,H,Ce),He===null?Se=je:He.sibling=je,He=je,ge=Be}if(Ce===V.length)return r($,ge),Pe&&Qn($,Ce),Se;if(ge===null){for(;Ce<V.length;Ce++)ge=ie($,V[Ce],ne),ge!==null&&(H=h(ge,H,Ce),He===null?Se=ge:He.sibling=ge,He=ge);return Pe&&Qn($,Ce),Se}for(ge=c(ge);Ce<V.length;Ce++)Be=Q(ge,$,Ce,V[Ce],ne),Be!==null&&(n&&Be.alternate!==null&&ge.delete(Be.key===null?Ce:Be.key),H=h(Be,H,Ce),He===null?Se=Be:He.sibling=Be,He=Be);return n&&ge.forEach(function(Yi){return i($,Yi)}),Pe&&Qn($,Ce),Se}function ve($,H,V,ne){if(V==null)throw Error(o(151));for(var Se=null,He=null,ge=H,Ce=H=0,Be=null,je=V.next();ge!==null&&!je.done;Ce++,je=V.next()){ge.index>Ce?(Be=ge,ge=null):Be=ge.sibling;var Yi=K($,ge,je.value,ne);if(Yi===null){ge===null&&(ge=Be);break}n&&ge&&Yi.alternate===null&&i($,ge),H=h(Yi,H,Ce),He===null?Se=Yi:He.sibling=Yi,He=Yi,ge=Be}if(je.done)return r($,ge),Pe&&Qn($,Ce),Se;if(ge===null){for(;!je.done;Ce++,je=V.next())je=ie($,je.value,ne),je!==null&&(H=h(je,H,Ce),He===null?Se=je:He.sibling=je,He=je);return Pe&&Qn($,Ce),Se}for(ge=c(ge);!je.done;Ce++,je=V.next())je=Q(ge,$,Ce,je.value,ne),je!==null&&(n&&je.alternate!==null&&ge.delete(je.key===null?Ce:je.key),H=h(je,H,Ce),He===null?Se=je:He.sibling=je,He=je);return n&&ge.forEach(function(Uv){return i($,Uv)}),Pe&&Qn($,Ce),Se}function We($,H,V,ne){if(typeof V=="object"&&V!==null&&V.type===x&&V.key===null&&(V=V.props.children),typeof V=="object"&&V!==null){switch(V.$$typeof){case T:e:{for(var Se=V.key;H!==null;){if(H.key===Se){if(Se=V.type,Se===x){if(H.tag===7){r($,H.sibling),ne=d(H,V.props.children),ne.return=$,$=ne;break e}}else if(H.elementType===Se||typeof Se=="object"&&Se!==null&&Se.$$typeof===D&&bs(Se)===H.type){r($,H.sibling),ne=d(H,V.props),io(ne,V),ne.return=$,$=ne;break e}r($,H);break}else i($,H);H=H.sibling}V.type===x?(ne=ms(V.props.children,$.mode,ne,V.key),ne.return=$,$=ne):(ne=pr(V.type,V.key,V.props,null,$.mode,ne),io(ne,V),ne.return=$,$=ne)}return A($);case S:e:{for(Se=V.key;H!==null;){if(H.key===Se)if(H.tag===4&&H.stateNode.containerInfo===V.containerInfo&&H.stateNode.implementation===V.implementation){r($,H.sibling),ne=d(H,V.children||[]),ne.return=$,$=ne;break e}else{r($,H);break}else i($,H);H=H.sibling}ne=Lc(V,$.mode,ne),ne.return=$,$=ne}return A($);case D:return V=bs(V),We($,H,V,ne)}if(F(V))return me($,H,V,ne);if(se(V)){if(Se=se(V),typeof Se!="function")throw Error(o(150));return V=Se.call(V),ve($,H,V,ne)}if(typeof V.then=="function")return We($,H,Ar(V),ne);if(V.$$typeof===M)return We($,H,gr($,V),ne);xr($,V)}return typeof V=="string"&&V!==""||typeof V=="number"||typeof V=="bigint"?(V=""+V,H!==null&&H.tag===6?(r($,H.sibling),ne=d(H,V),ne.return=$,$=ne):(r($,H),ne=Ic(V,$.mode,ne),ne.return=$,$=ne),A($)):r($,H)}return function($,H,V,ne){try{no=0;var Se=We($,H,V,ne);return ra=null,Se}catch(ge){if(ge===oa||ge===Sr)throw ge;var He=ln(29,ge,null,$.mode);return He.lanes=ne,He.return=$,He}}}var vs=Im(!0),Lm=Im(!1),Ci=!1;function Kc(n){n.updateQueue={baseState:n.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function Fc(n,i){n=n.updateQueue,i.updateQueue===n&&(i.updateQueue={baseState:n.baseState,firstBaseUpdate:n.firstBaseUpdate,lastBaseUpdate:n.lastBaseUpdate,shared:n.shared,callbacks:null})}function Oi(n){return{lane:n,tag:0,payload:null,callback:null,next:null}}function ki(n,i,r){var c=n.updateQueue;if(c===null)return null;if(c=c.shared,(De&2)!==0){var d=c.pending;return d===null?i.next=i:(i.next=d.next,d.next=i),c.pending=i,i=mr(n),gm(n,null,r),i}return fr(n,c,i,r),mr(n)}function so(n,i,r){if(i=i.updateQueue,i!==null&&(i=i.shared,(r&4194048)!==0)){var c=i.lanes;c&=n.pendingLanes,r|=c,i.lanes=r,On(n,r)}}function Wc(n,i){var r=n.updateQueue,c=n.alternate;if(c!==null&&(c=c.updateQueue,r===c)){var d=null,h=null;if(r=r.firstBaseUpdate,r!==null){do{var A={lane:r.lane,tag:r.tag,payload:r.payload,callback:null,next:null};h===null?d=h=A:h=h.next=A,r=r.next}while(r!==null);h===null?d=h=i:h=h.next=i}else d=h=i;r={baseState:c.baseState,firstBaseUpdate:d,lastBaseUpdate:h,shared:c.shared,callbacks:c.callbacks},n.updateQueue=r;return}n=r.lastBaseUpdate,n===null?r.firstBaseUpdate=i:n.next=i,r.lastBaseUpdate=i}var Xc=!1;function ao(){if(Xc){var n=aa;if(n!==null)throw n}}function oo(n,i,r,c){Xc=!1;var d=n.updateQueue;Ci=!1;var h=d.firstBaseUpdate,A=d.lastBaseUpdate,C=d.shared.pending;if(C!==null){d.shared.pending=null;var L=C,Y=L.next;L.next=null,A===null?h=Y:A.next=Y,A=L;var te=n.alternate;te!==null&&(te=te.updateQueue,C=te.lastBaseUpdate,C!==A&&(C===null?te.firstBaseUpdate=Y:C.next=Y,te.lastBaseUpdate=L))}if(h!==null){var ie=d.baseState;A=0,te=Y=L=null,C=h;do{var K=C.lane&-536870913,Q=K!==C.lane;if(Q?(Le&K)===K:(c&K)===K){K!==0&&K===sa&&(Xc=!0),te!==null&&(te=te.next={lane:0,tag:C.tag,payload:C.payload,callback:null,next:null});e:{var me=n,ve=C;K=i;var We=r;switch(ve.tag){case 1:if(me=ve.payload,typeof me=="function"){ie=me.call(We,ie,K);break e}ie=me;break e;case 3:me.flags=me.flags&-65537|128;case 0:if(me=ve.payload,K=typeof me=="function"?me.call(We,ie,K):me,K==null)break e;ie=b({},ie,K);break e;case 2:Ci=!0}}K=C.callback,K!==null&&(n.flags|=64,Q&&(n.flags|=8192),Q=d.callbacks,Q===null?d.callbacks=[K]:Q.push(K))}else Q={lane:K,tag:C.tag,payload:C.payload,callback:C.callback,next:null},te===null?(Y=te=Q,L=ie):te=te.next=Q,A|=K;if(C=C.next,C===null){if(C=d.shared.pending,C===null)break;Q=C,C=Q.next,Q.next=null,d.lastBaseUpdate=Q,d.shared.pending=null}}while(!0);te===null&&(L=ie),d.baseState=L,d.firstBaseUpdate=Y,d.lastBaseUpdate=te,h===null&&(d.shared.lanes=0),Bi|=A,n.lanes=A,n.memoizedState=ie}}function Bm(n,i){if(typeof n!="function")throw Error(o(191,n));n.call(i)}function Pm(n,i){var r=n.callbacks;if(r!==null)for(n.callbacks=null,n=0;n<r.length;n++)Bm(r[n],i)}var la=B(null),Tr=B(0);function Hm(n,i){n=ci,X(Tr,n),X(la,i),ci=n|i.baseLanes}function Gc(){X(Tr,ci),X(la,la.current)}function Jc(){ci=Tr.current,W(la),W(Tr)}var cn=B(null),xn=null;function Ni(n){var i=n.alternate;X(yt,yt.current&1),X(cn,n),xn===null&&(i===null||la.current!==null||i.memoizedState!==null)&&(xn=n)}function Qc(n){X(yt,yt.current),X(cn,n),xn===null&&(xn=n)}function jm(n){n.tag===22?(X(yt,yt.current),X(cn,n),xn===null&&(xn=n)):Ri()}function Ri(){X(yt,yt.current),X(cn,cn.current)}function un(n){W(cn),xn===n&&(xn=null),W(yt)}var yt=B(0);function Er(n){for(var i=n;i!==null;){if(i.tag===13){var r=i.memoizedState;if(r!==null&&(r=r.dehydrated,r===null||sd(r)||ad(r)))return i}else if(i.tag===19&&(i.memoizedProps.revealOrder==="forwards"||i.memoizedProps.revealOrder==="backwards"||i.memoizedProps.revealOrder==="unstable_legacy-backwards"||i.memoizedProps.revealOrder==="together")){if((i.flags&128)!==0)return i}else if(i.child!==null){i.child.return=i,i=i.child;continue}if(i===n)break;for(;i.sibling===null;){if(i.return===null||i.return===n)return null;i=i.return}i.sibling.return=i.return,i=i.sibling}return null}var ti=0,Me=null,Ke=null,vt=null,_r=!1,ca=!1,As=!1,Mr=0,ro=0,ua=null,kS=0;function ut(){throw Error(o(321))}function Zc(n,i){if(i===null)return!1;for(var r=0;r<i.length&&r<n.length;r++)if(!rn(n[r],i[r]))return!1;return!0}function eu(n,i,r,c,d,h){return ti=h,Me=i,i.memoizedState=null,i.updateQueue=null,i.lanes=0,P.H=n===null||n.memoizedState===null?Ap:hu,As=!1,h=r(c,d),As=!1,ca&&(h=Um(i,r,c,d)),Dm(n),h}function Dm(n){P.H=uo;var i=Ke!==null&&Ke.next!==null;if(ti=0,vt=Ke=Me=null,_r=!1,ro=0,ua=null,i)throw Error(o(300));n===null||At||(n=n.dependencies,n!==null&&yr(n)&&(At=!0))}function Um(n,i,r,c){Me=n;var d=0;do{if(ca&&(ua=null),ro=0,ca=!1,25<=d)throw Error(o(301));if(d+=1,vt=Ke=null,n.updateQueue!=null){var h=n.updateQueue;h.lastEffect=null,h.events=null,h.stores=null,h.memoCache!=null&&(h.memoCache.index=0)}P.H=xp,h=i(r,c)}while(ca);return h}function NS(){var n=P.H,i=n.useState()[0];return i=typeof i.then=="function"?lo(i):i,n=n.useState()[0],(Ke!==null?Ke.memoizedState:null)!==n&&(Me.flags|=1024),i}function tu(){var n=Mr!==0;return Mr=0,n}function nu(n,i,r){i.updateQueue=n.updateQueue,i.flags&=-2053,n.lanes&=~r}function iu(n){if(_r){for(n=n.memoizedState;n!==null;){var i=n.queue;i!==null&&(i.pending=null),n=n.next}_r=!1}ti=0,vt=Ke=Me=null,ca=!1,ro=Mr=0,ua=null}function Wt(){var n={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return vt===null?Me.memoizedState=vt=n:vt=vt.next=n,vt}function gt(){if(Ke===null){var n=Me.alternate;n=n!==null?n.memoizedState:null}else n=Ke.next;var i=vt===null?Me.memoizedState:vt.next;if(i!==null)vt=i,Ke=n;else{if(n===null)throw Me.alternate===null?Error(o(467)):Error(o(310));Ke=n,n={memoizedState:Ke.memoizedState,baseState:Ke.baseState,baseQueue:Ke.baseQueue,queue:Ke.queue,next:null},vt===null?Me.memoizedState=vt=n:vt=vt.next=n}return vt}function wr(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function lo(n){var i=ro;return ro+=1,ua===null&&(ua=[]),n=km(ua,n,i),i=Me,(vt===null?i.memoizedState:vt.next)===null&&(i=i.alternate,P.H=i===null||i.memoizedState===null?Ap:hu),n}function Cr(n){if(n!==null&&typeof n=="object"){if(typeof n.then=="function")return lo(n);if(n.$$typeof===M)return Dt(n)}throw Error(o(438,String(n)))}function su(n){var i=null,r=Me.updateQueue;if(r!==null&&(i=r.memoCache),i==null){var c=Me.alternate;c!==null&&(c=c.updateQueue,c!==null&&(c=c.memoCache,c!=null&&(i={data:c.data.map(function(d){return d.slice()}),index:0})))}if(i==null&&(i={data:[],index:0}),r===null&&(r=wr(),Me.updateQueue=r),r.memoCache=i,r=i.data[i.index],r===void 0)for(r=i.data[i.index]=Array(n),c=0;c<n;c++)r[c]=U;return i.index++,r}function ni(n,i){return typeof i=="function"?i(n):i}function Or(n){var i=gt();return au(i,Ke,n)}function au(n,i,r){var c=n.queue;if(c===null)throw Error(o(311));c.lastRenderedReducer=r;var d=n.baseQueue,h=c.pending;if(h!==null){if(d!==null){var A=d.next;d.next=h.next,h.next=A}i.baseQueue=d=h,c.pending=null}if(h=n.baseState,d===null)n.memoizedState=h;else{i=d.next;var C=A=null,L=null,Y=i,te=!1;do{var ie=Y.lane&-536870913;if(ie!==Y.lane?(Le&ie)===ie:(ti&ie)===ie){var K=Y.revertLane;if(K===0)L!==null&&(L=L.next={lane:0,revertLane:0,gesture:null,action:Y.action,hasEagerState:Y.hasEagerState,eagerState:Y.eagerState,next:null}),ie===sa&&(te=!0);else if((ti&K)===K){Y=Y.next,K===sa&&(te=!0);continue}else ie={lane:0,revertLane:Y.revertLane,gesture:null,action:Y.action,hasEagerState:Y.hasEagerState,eagerState:Y.eagerState,next:null},L===null?(C=L=ie,A=h):L=L.next=ie,Me.lanes|=K,Bi|=K;ie=Y.action,As&&r(h,ie),h=Y.hasEagerState?Y.eagerState:r(h,ie)}else K={lane:ie,revertLane:Y.revertLane,gesture:Y.gesture,action:Y.action,hasEagerState:Y.hasEagerState,eagerState:Y.eagerState,next:null},L===null?(C=L=K,A=h):L=L.next=K,Me.lanes|=ie,Bi|=ie;Y=Y.next}while(Y!==null&&Y!==i);if(L===null?A=h:L.next=C,!rn(h,n.memoizedState)&&(At=!0,te&&(r=aa,r!==null)))throw r;n.memoizedState=h,n.baseState=A,n.baseQueue=L,c.lastRenderedState=h}return d===null&&(c.lanes=0),[n.memoizedState,c.dispatch]}function ou(n){var i=gt(),r=i.queue;if(r===null)throw Error(o(311));r.lastRenderedReducer=n;var c=r.dispatch,d=r.pending,h=i.memoizedState;if(d!==null){r.pending=null;var A=d=d.next;do h=n(h,A.action),A=A.next;while(A!==d);rn(h,i.memoizedState)||(At=!0),i.memoizedState=h,i.baseQueue===null&&(i.baseState=h),r.lastRenderedState=h}return[h,c]}function $m(n,i,r){var c=Me,d=gt(),h=Pe;if(h){if(r===void 0)throw Error(o(407));r=r()}else r=i();var A=!rn((Ke||d).memoizedState,r);if(A&&(d.memoizedState=r,At=!0),d=d.queue,cu(Vm.bind(null,c,d,n),[n]),d.getSnapshot!==i||A||vt!==null&&vt.memoizedState.tag&1){if(c.flags|=2048,da(9,{destroy:void 0},zm.bind(null,c,d,r,i),null),Xe===null)throw Error(o(349));h||(ti&127)!==0||qm(c,i,r)}return r}function qm(n,i,r){n.flags|=16384,n={getSnapshot:i,value:r},i=Me.updateQueue,i===null?(i=wr(),Me.updateQueue=i,i.stores=[n]):(r=i.stores,r===null?i.stores=[n]:r.push(n))}function zm(n,i,r,c){i.value=r,i.getSnapshot=c,Ym(i)&&Km(n)}function Vm(n,i,r){return r(function(){Ym(i)&&Km(n)})}function Ym(n){var i=n.getSnapshot;n=n.value;try{var r=i();return!rn(n,r)}catch{return!0}}function Km(n){var i=fs(n,2);i!==null&&an(i,n,2)}function ru(n){var i=Wt();if(typeof n=="function"){var r=n;if(n=r(),As){mt(!0);try{r()}finally{mt(!1)}}}return i.memoizedState=i.baseState=n,i.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:ni,lastRenderedState:n},i}function Fm(n,i,r,c){return n.baseState=r,au(n,Ke,typeof c=="function"?c:ni)}function RS(n,i,r,c,d){if(Rr(n))throw Error(o(485));if(n=i.action,n!==null){var h={payload:d,action:n,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(A){h.listeners.push(A)}};P.T!==null?r(!0):h.isTransition=!1,c(h),r=i.pending,r===null?(h.next=i.pending=h,Wm(i,h)):(h.next=r.next,i.pending=r.next=h)}}function Wm(n,i){var r=i.action,c=i.payload,d=n.state;if(i.isTransition){var h=P.T,A={};P.T=A;try{var C=r(d,c),L=P.S;L!==null&&L(A,C),Xm(n,i,C)}catch(Y){lu(n,i,Y)}finally{h!==null&&A.types!==null&&(h.types=A.types),P.T=h}}else try{h=r(d,c),Xm(n,i,h)}catch(Y){lu(n,i,Y)}}function Xm(n,i,r){r!==null&&typeof r=="object"&&typeof r.then=="function"?r.then(function(c){Gm(n,i,c)},function(c){return lu(n,i,c)}):Gm(n,i,r)}function Gm(n,i,r){i.status="fulfilled",i.value=r,Jm(i),n.state=r,i=n.pending,i!==null&&(r=i.next,r===i?n.pending=null:(r=r.next,i.next=r,Wm(n,r)))}function lu(n,i,r){var c=n.pending;if(n.pending=null,c!==null){c=c.next;do i.status="rejected",i.reason=r,Jm(i),i=i.next;while(i!==c)}n.action=null}function Jm(n){n=n.listeners;for(var i=0;i<n.length;i++)(0,n[i])()}function Qm(n,i){return i}function Zm(n,i){if(Pe){var r=Xe.formState;if(r!==null){e:{var c=Me;if(Pe){if(Je){t:{for(var d=Je,h=An;d.nodeType!==8;){if(!h){d=null;break t}if(d=Tn(d.nextSibling),d===null){d=null;break t}}h=d.data,d=h==="F!"||h==="F"?d:null}if(d){Je=Tn(d.nextSibling),c=d.data==="F!";break e}}Mi(c)}c=!1}c&&(i=r[0])}}return r=Wt(),r.memoizedState=r.baseState=i,c={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Qm,lastRenderedState:i},r.queue=c,r=bp.bind(null,Me,c),c.dispatch=r,c=ru(!1),h=pu.bind(null,Me,!1,c.queue),c=Wt(),d={state:i,dispatch:null,action:n,pending:null},c.queue=d,r=RS.bind(null,Me,d,h,r),d.dispatch=r,c.memoizedState=n,[i,r,!1]}function ep(n){var i=gt();return tp(i,Ke,n)}function tp(n,i,r){if(i=au(n,i,Qm)[0],n=Or(ni)[0],typeof i=="object"&&i!==null&&typeof i.then=="function")try{var c=lo(i)}catch(A){throw A===oa?Sr:A}else c=i;i=gt();var d=i.queue,h=d.dispatch;return r!==i.memoizedState&&(Me.flags|=2048,da(9,{destroy:void 0},IS.bind(null,d,r),null)),[c,h,n]}function IS(n,i){n.action=i}function np(n){var i=gt(),r=Ke;if(r!==null)return tp(i,r,n);gt(),i=i.memoizedState,r=gt();var c=r.queue.dispatch;return r.memoizedState=n,[i,c,!1]}function da(n,i,r,c){return n={tag:n,create:r,deps:c,inst:i,next:null},i=Me.updateQueue,i===null&&(i=wr(),Me.updateQueue=i),r=i.lastEffect,r===null?i.lastEffect=n.next=n:(c=r.next,r.next=n,n.next=c,i.lastEffect=n),n}function ip(){return gt().memoizedState}function kr(n,i,r,c){var d=Wt();Me.flags|=n,d.memoizedState=da(1|i,{destroy:void 0},r,c===void 0?null:c)}function Nr(n,i,r,c){var d=gt();c=c===void 0?null:c;var h=d.memoizedState.inst;Ke!==null&&c!==null&&Zc(c,Ke.memoizedState.deps)?d.memoizedState=da(i,h,r,c):(Me.flags|=n,d.memoizedState=da(1|i,h,r,c))}function sp(n,i){kr(8390656,8,n,i)}function cu(n,i){Nr(2048,8,n,i)}function LS(n){Me.flags|=4;var i=Me.updateQueue;if(i===null)i=wr(),Me.updateQueue=i,i.events=[n];else{var r=i.events;r===null?i.events=[n]:r.push(n)}}function ap(n){var i=gt().memoizedState;return LS({ref:i,nextImpl:n}),function(){if((De&2)!==0)throw Error(o(440));return i.impl.apply(void 0,arguments)}}function op(n,i){return Nr(4,2,n,i)}function rp(n,i){return Nr(4,4,n,i)}function lp(n,i){if(typeof i=="function"){n=n();var r=i(n);return function(){typeof r=="function"?r():i(null)}}if(i!=null)return n=n(),i.current=n,function(){i.current=null}}function cp(n,i,r){r=r!=null?r.concat([n]):null,Nr(4,4,lp.bind(null,i,n),r)}function uu(){}function up(n,i){var r=gt();i=i===void 0?null:i;var c=r.memoizedState;return i!==null&&Zc(i,c[1])?c[0]:(r.memoizedState=[n,i],n)}function dp(n,i){var r=gt();i=i===void 0?null:i;var c=r.memoizedState;if(i!==null&&Zc(i,c[1]))return c[0];if(c=n(),As){mt(!0);try{n()}finally{mt(!1)}}return r.memoizedState=[c,i],c}function du(n,i,r){return r===void 0||(ti&1073741824)!==0&&(Le&261930)===0?n.memoizedState=i:(n.memoizedState=r,n=fh(),Me.lanes|=n,Bi|=n,r)}function fp(n,i,r,c){return rn(r,i)?r:la.current!==null?(n=du(n,r,c),rn(n,i)||(At=!0),n):(ti&42)===0||(ti&1073741824)!==0&&(Le&261930)===0?(At=!0,n.memoizedState=r):(n=fh(),Me.lanes|=n,Bi|=n,i)}function mp(n,i,r,c,d){var h=z.p;z.p=h!==0&&8>h?h:8;var A=P.T,C={};P.T=C,pu(n,!1,i,r);try{var L=d(),Y=P.S;if(Y!==null&&Y(C,L),L!==null&&typeof L=="object"&&typeof L.then=="function"){var te=OS(L,c);co(n,i,te,mn(n))}else co(n,i,c,mn(n))}catch(ie){co(n,i,{then:function(){},status:"rejected",reason:ie},mn())}finally{z.p=h,A!==null&&C.types!==null&&(A.types=C.types),P.T=A}}function BS(){}function fu(n,i,r,c){if(n.tag!==5)throw Error(o(476));var d=pp(n).queue;mp(n,d,i,Z,r===null?BS:function(){return hp(n),r(c)})}function pp(n){var i=n.memoizedState;if(i!==null)return i;i={memoizedState:Z,baseState:Z,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:ni,lastRenderedState:Z},next:null};var r={};return i.next={memoizedState:r,baseState:r,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:ni,lastRenderedState:r},next:null},n.memoizedState=i,n=n.alternate,n!==null&&(n.memoizedState=i),i}function hp(n){var i=pp(n);i.next===null&&(i=n.alternate.memoizedState),co(n,i.next.queue,{},mn())}function mu(){return Dt(wo)}function yp(){return gt().memoizedState}function gp(){return gt().memoizedState}function PS(n){for(var i=n.return;i!==null;){switch(i.tag){case 24:case 3:var r=mn();n=Oi(r);var c=ki(i,n,r);c!==null&&(an(c,i,r),so(c,i,r)),i={cache:qc()},n.payload=i;return}i=i.return}}function HS(n,i,r){var c=mn();r={lane:c,revertLane:0,gesture:null,action:r,hasEagerState:!1,eagerState:null,next:null},Rr(n)?Sp(i,r):(r=Nc(n,i,r,c),r!==null&&(an(r,n,c),vp(r,i,c)))}function bp(n,i,r){var c=mn();co(n,i,r,c)}function co(n,i,r,c){var d={lane:c,revertLane:0,gesture:null,action:r,hasEagerState:!1,eagerState:null,next:null};if(Rr(n))Sp(i,d);else{var h=n.alternate;if(n.lanes===0&&(h===null||h.lanes===0)&&(h=i.lastRenderedReducer,h!==null))try{var A=i.lastRenderedState,C=h(A,r);if(d.hasEagerState=!0,d.eagerState=C,rn(C,A))return fr(n,i,d,0),Xe===null&&dr(),!1}catch{}if(r=Nc(n,i,d,c),r!==null)return an(r,n,c),vp(r,i,c),!0}return!1}function pu(n,i,r,c){if(c={lane:2,revertLane:Ku(),gesture:null,action:c,hasEagerState:!1,eagerState:null,next:null},Rr(n)){if(i)throw Error(o(479))}else i=Nc(n,r,c,2),i!==null&&an(i,n,2)}function Rr(n){var i=n.alternate;return n===Me||i!==null&&i===Me}function Sp(n,i){ca=_r=!0;var r=n.pending;r===null?i.next=i:(i.next=r.next,r.next=i),n.pending=i}function vp(n,i,r){if((r&4194048)!==0){var c=i.lanes;c&=n.pendingLanes,r|=c,i.lanes=r,On(n,r)}}var uo={readContext:Dt,use:Cr,useCallback:ut,useContext:ut,useEffect:ut,useImperativeHandle:ut,useLayoutEffect:ut,useInsertionEffect:ut,useMemo:ut,useReducer:ut,useRef:ut,useState:ut,useDebugValue:ut,useDeferredValue:ut,useTransition:ut,useSyncExternalStore:ut,useId:ut,useHostTransitionStatus:ut,useFormState:ut,useActionState:ut,useOptimistic:ut,useMemoCache:ut,useCacheRefresh:ut};uo.useEffectEvent=ut;var Ap={readContext:Dt,use:Cr,useCallback:function(n,i){return Wt().memoizedState=[n,i===void 0?null:i],n},useContext:Dt,useEffect:sp,useImperativeHandle:function(n,i,r){r=r!=null?r.concat([n]):null,kr(4194308,4,lp.bind(null,i,n),r)},useLayoutEffect:function(n,i){return kr(4194308,4,n,i)},useInsertionEffect:function(n,i){kr(4,2,n,i)},useMemo:function(n,i){var r=Wt();i=i===void 0?null:i;var c=n();if(As){mt(!0);try{n()}finally{mt(!1)}}return r.memoizedState=[c,i],c},useReducer:function(n,i,r){var c=Wt();if(r!==void 0){var d=r(i);if(As){mt(!0);try{r(i)}finally{mt(!1)}}}else d=i;return c.memoizedState=c.baseState=d,n={pending:null,lanes:0,dispatch:null,lastRenderedReducer:n,lastRenderedState:d},c.queue=n,n=n.dispatch=HS.bind(null,Me,n),[c.memoizedState,n]},useRef:function(n){var i=Wt();return n={current:n},i.memoizedState=n},useState:function(n){n=ru(n);var i=n.queue,r=bp.bind(null,Me,i);return i.dispatch=r,[n.memoizedState,r]},useDebugValue:uu,useDeferredValue:function(n,i){var r=Wt();return du(r,n,i)},useTransition:function(){var n=ru(!1);return n=mp.bind(null,Me,n.queue,!0,!1),Wt().memoizedState=n,[!1,n]},useSyncExternalStore:function(n,i,r){var c=Me,d=Wt();if(Pe){if(r===void 0)throw Error(o(407));r=r()}else{if(r=i(),Xe===null)throw Error(o(349));(Le&127)!==0||qm(c,i,r)}d.memoizedState=r;var h={value:r,getSnapshot:i};return d.queue=h,sp(Vm.bind(null,c,h,n),[n]),c.flags|=2048,da(9,{destroy:void 0},zm.bind(null,c,h,r,i),null),r},useId:function(){var n=Wt(),i=Xe.identifierPrefix;if(Pe){var r=$n,c=Un;r=(c&~(1<<32-pt(c)-1)).toString(32)+r,i="_"+i+"R_"+r,r=Mr++,0<r&&(i+="H"+r.toString(32)),i+="_"}else r=kS++,i="_"+i+"r_"+r.toString(32)+"_";return n.memoizedState=i},useHostTransitionStatus:mu,useFormState:Zm,useActionState:Zm,useOptimistic:function(n){var i=Wt();i.memoizedState=i.baseState=n;var r={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return i.queue=r,i=pu.bind(null,Me,!0,r),r.dispatch=i,[n,i]},useMemoCache:su,useCacheRefresh:function(){return Wt().memoizedState=PS.bind(null,Me)},useEffectEvent:function(n){var i=Wt(),r={impl:n};return i.memoizedState=r,function(){if((De&2)!==0)throw Error(o(440));return r.impl.apply(void 0,arguments)}}},hu={readContext:Dt,use:Cr,useCallback:up,useContext:Dt,useEffect:cu,useImperativeHandle:cp,useInsertionEffect:op,useLayoutEffect:rp,useMemo:dp,useReducer:Or,useRef:ip,useState:function(){return Or(ni)},useDebugValue:uu,useDeferredValue:function(n,i){var r=gt();return fp(r,Ke.memoizedState,n,i)},useTransition:function(){var n=Or(ni)[0],i=gt().memoizedState;return[typeof n=="boolean"?n:lo(n),i]},useSyncExternalStore:$m,useId:yp,useHostTransitionStatus:mu,useFormState:ep,useActionState:ep,useOptimistic:function(n,i){var r=gt();return Fm(r,Ke,n,i)},useMemoCache:su,useCacheRefresh:gp};hu.useEffectEvent=ap;var xp={readContext:Dt,use:Cr,useCallback:up,useContext:Dt,useEffect:cu,useImperativeHandle:cp,useInsertionEffect:op,useLayoutEffect:rp,useMemo:dp,useReducer:ou,useRef:ip,useState:function(){return ou(ni)},useDebugValue:uu,useDeferredValue:function(n,i){var r=gt();return Ke===null?du(r,n,i):fp(r,Ke.memoizedState,n,i)},useTransition:function(){var n=ou(ni)[0],i=gt().memoizedState;return[typeof n=="boolean"?n:lo(n),i]},useSyncExternalStore:$m,useId:yp,useHostTransitionStatus:mu,useFormState:np,useActionState:np,useOptimistic:function(n,i){var r=gt();return Ke!==null?Fm(r,Ke,n,i):(r.baseState=n,[n,r.queue.dispatch])},useMemoCache:su,useCacheRefresh:gp};xp.useEffectEvent=ap;function yu(n,i,r,c){i=n.memoizedState,r=r(c,i),r=r==null?i:b({},i,r),n.memoizedState=r,n.lanes===0&&(n.updateQueue.baseState=r)}var gu={enqueueSetState:function(n,i,r){n=n._reactInternals;var c=mn(),d=Oi(c);d.payload=i,r!=null&&(d.callback=r),i=ki(n,d,c),i!==null&&(an(i,n,c),so(i,n,c))},enqueueReplaceState:function(n,i,r){n=n._reactInternals;var c=mn(),d=Oi(c);d.tag=1,d.payload=i,r!=null&&(d.callback=r),i=ki(n,d,c),i!==null&&(an(i,n,c),so(i,n,c))},enqueueForceUpdate:function(n,i){n=n._reactInternals;var r=mn(),c=Oi(r);c.tag=2,i!=null&&(c.callback=i),i=ki(n,c,r),i!==null&&(an(i,n,r),so(i,n,r))}};function Tp(n,i,r,c,d,h,A){return n=n.stateNode,typeof n.shouldComponentUpdate=="function"?n.shouldComponentUpdate(c,h,A):i.prototype&&i.prototype.isPureReactComponent?!Ga(r,c)||!Ga(d,h):!0}function Ep(n,i,r,c){n=i.state,typeof i.componentWillReceiveProps=="function"&&i.componentWillReceiveProps(r,c),typeof i.UNSAFE_componentWillReceiveProps=="function"&&i.UNSAFE_componentWillReceiveProps(r,c),i.state!==n&&gu.enqueueReplaceState(i,i.state,null)}function xs(n,i){var r=i;if("ref"in i){r={};for(var c in i)c!=="ref"&&(r[c]=i[c])}if(n=n.defaultProps){r===i&&(r=b({},r));for(var d in n)r[d]===void 0&&(r[d]=n[d])}return r}function _p(n){ur(n)}function Mp(n){console.error(n)}function wp(n){ur(n)}function Ir(n,i){try{var r=n.onUncaughtError;r(i.value,{componentStack:i.stack})}catch(c){setTimeout(function(){throw c})}}function Cp(n,i,r){try{var c=n.onCaughtError;c(r.value,{componentStack:r.stack,errorBoundary:i.tag===1?i.stateNode:null})}catch(d){setTimeout(function(){throw d})}}function bu(n,i,r){return r=Oi(r),r.tag=3,r.payload={element:null},r.callback=function(){Ir(n,i)},r}function Op(n){return n=Oi(n),n.tag=3,n}function kp(n,i,r,c){var d=r.type.getDerivedStateFromError;if(typeof d=="function"){var h=c.value;n.payload=function(){return d(h)},n.callback=function(){Cp(i,r,c)}}var A=r.stateNode;A!==null&&typeof A.componentDidCatch=="function"&&(n.callback=function(){Cp(i,r,c),typeof d!="function"&&(Pi===null?Pi=new Set([this]):Pi.add(this));var C=c.stack;this.componentDidCatch(c.value,{componentStack:C!==null?C:""})})}function jS(n,i,r,c,d){if(r.flags|=32768,c!==null&&typeof c=="object"&&typeof c.then=="function"){if(i=r.alternate,i!==null&&ia(i,r,d,!0),r=cn.current,r!==null){switch(r.tag){case 31:case 13:return xn===null?Yr():r.alternate===null&&dt===0&&(dt=3),r.flags&=-257,r.flags|=65536,r.lanes=d,c===vr?r.flags|=16384:(i=r.updateQueue,i===null?r.updateQueue=new Set([c]):i.add(c),zu(n,c,d)),!1;case 22:return r.flags|=65536,c===vr?r.flags|=16384:(i=r.updateQueue,i===null?(i={transitions:null,markerInstances:null,retryQueue:new Set([c])},r.updateQueue=i):(r=i.retryQueue,r===null?i.retryQueue=new Set([c]):r.add(c)),zu(n,c,d)),!1}throw Error(o(435,r.tag))}return zu(n,c,d),Yr(),!1}if(Pe)return i=cn.current,i!==null?((i.flags&65536)===0&&(i.flags|=256),i.flags|=65536,i.lanes=d,c!==Hc&&(n=Error(o(422),{cause:c}),Za(bn(n,r)))):(c!==Hc&&(i=Error(o(423),{cause:c}),Za(bn(i,r))),n=n.current.alternate,n.flags|=65536,d&=-d,n.lanes|=d,c=bn(c,r),d=bu(n.stateNode,c,d),Wc(n,d),dt!==4&&(dt=2)),!1;var h=Error(o(520),{cause:c});if(h=bn(h,r),So===null?So=[h]:So.push(h),dt!==4&&(dt=2),i===null)return!0;c=bn(c,r),r=i;do{switch(r.tag){case 3:return r.flags|=65536,n=d&-d,r.lanes|=n,n=bu(r.stateNode,c,n),Wc(r,n),!1;case 1:if(i=r.type,h=r.stateNode,(r.flags&128)===0&&(typeof i.getDerivedStateFromError=="function"||h!==null&&typeof h.componentDidCatch=="function"&&(Pi===null||!Pi.has(h))))return r.flags|=65536,d&=-d,r.lanes|=d,d=Op(d),kp(d,n,r,c),Wc(r,d),!1}r=r.return}while(r!==null);return!1}var Su=Error(o(461)),At=!1;function Ut(n,i,r,c){i.child=n===null?Lm(i,null,r,c):vs(i,n.child,r,c)}function Np(n,i,r,c,d){r=r.render;var h=i.ref;if("ref"in c){var A={};for(var C in c)C!=="ref"&&(A[C]=c[C])}else A=c;return ys(i),c=eu(n,i,r,A,h,d),C=tu(),n!==null&&!At?(nu(n,i,d),ii(n,i,d)):(Pe&&C&&Bc(i),i.flags|=1,Ut(n,i,c,d),i.child)}function Rp(n,i,r,c,d){if(n===null){var h=r.type;return typeof h=="function"&&!Rc(h)&&h.defaultProps===void 0&&r.compare===null?(i.tag=15,i.type=h,Ip(n,i,h,c,d)):(n=pr(r.type,null,c,i,i.mode,d),n.ref=i.ref,n.return=i,i.child=n)}if(h=n.child,!wu(n,d)){var A=h.memoizedProps;if(r=r.compare,r=r!==null?r:Ga,r(A,c)&&n.ref===i.ref)return ii(n,i,d)}return i.flags|=1,n=Jn(h,c),n.ref=i.ref,n.return=i,i.child=n}function Ip(n,i,r,c,d){if(n!==null){var h=n.memoizedProps;if(Ga(h,c)&&n.ref===i.ref)if(At=!1,i.pendingProps=c=h,wu(n,d))(n.flags&131072)!==0&&(At=!0);else return i.lanes=n.lanes,ii(n,i,d)}return vu(n,i,r,c,d)}function Lp(n,i,r,c){var d=c.children,h=n!==null?n.memoizedState:null;if(n===null&&i.stateNode===null&&(i.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),c.mode==="hidden"){if((i.flags&128)!==0){if(h=h!==null?h.baseLanes|r:r,n!==null){for(c=i.child=n.child,d=0;c!==null;)d=d|c.lanes|c.childLanes,c=c.sibling;c=d&~h}else c=0,i.child=null;return Bp(n,i,h,r,c)}if((r&536870912)!==0)i.memoizedState={baseLanes:0,cachePool:null},n!==null&&br(i,h!==null?h.cachePool:null),h!==null?Hm(i,h):Gc(),jm(i);else return c=i.lanes=536870912,Bp(n,i,h!==null?h.baseLanes|r:r,r,c)}else h!==null?(br(i,h.cachePool),Hm(i,h),Ri(),i.memoizedState=null):(n!==null&&br(i,null),Gc(),Ri());return Ut(n,i,d,r),i.child}function fo(n,i){return n!==null&&n.tag===22||i.stateNode!==null||(i.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),i.sibling}function Bp(n,i,r,c,d){var h=Vc();return h=h===null?null:{parent:St._currentValue,pool:h},i.memoizedState={baseLanes:r,cachePool:h},n!==null&&br(i,null),Gc(),jm(i),n!==null&&ia(n,i,c,!0),i.childLanes=d,null}function Lr(n,i){return i=Pr({mode:i.mode,children:i.children},n.mode),i.ref=n.ref,n.child=i,i.return=n,i}function Pp(n,i,r){return vs(i,n.child,null,r),n=Lr(i,i.pendingProps),n.flags|=2,un(i),i.memoizedState=null,n}function DS(n,i,r){var c=i.pendingProps,d=(i.flags&128)!==0;if(i.flags&=-129,n===null){if(Pe){if(c.mode==="hidden")return n=Lr(i,c),i.lanes=536870912,fo(null,n);if(Qc(i),(n=Je)?(n=Wh(n,An),n=n!==null&&n.data==="&"?n:null,n!==null&&(i.memoizedState={dehydrated:n,treeContext:Ei!==null?{id:Un,overflow:$n}:null,retryLane:536870912,hydrationErrors:null},r=Sm(n),r.return=i,i.child=r,jt=i,Je=null)):n=null,n===null)throw Mi(i);return i.lanes=536870912,null}return Lr(i,c)}var h=n.memoizedState;if(h!==null){var A=h.dehydrated;if(Qc(i),d)if(i.flags&256)i.flags&=-257,i=Pp(n,i,r);else if(i.memoizedState!==null)i.child=n.child,i.flags|=128,i=null;else throw Error(o(558));else if(At||ia(n,i,r,!1),d=(r&n.childLanes)!==0,At||d){if(c=Xe,c!==null&&(A=js(c,r),A!==0&&A!==h.retryLane))throw h.retryLane=A,fs(n,A),an(c,n,A),Su;Yr(),i=Pp(n,i,r)}else n=h.treeContext,Je=Tn(A.nextSibling),jt=i,Pe=!0,_i=null,An=!1,n!==null&&xm(i,n),i=Lr(i,c),i.flags|=4096;return i}return n=Jn(n.child,{mode:c.mode,children:c.children}),n.ref=i.ref,i.child=n,n.return=i,n}function Br(n,i){var r=i.ref;if(r===null)n!==null&&n.ref!==null&&(i.flags|=4194816);else{if(typeof r!="function"&&typeof r!="object")throw Error(o(284));(n===null||n.ref!==r)&&(i.flags|=4194816)}}function vu(n,i,r,c,d){return ys(i),r=eu(n,i,r,c,void 0,d),c=tu(),n!==null&&!At?(nu(n,i,d),ii(n,i,d)):(Pe&&c&&Bc(i),i.flags|=1,Ut(n,i,r,d),i.child)}function Hp(n,i,r,c,d,h){return ys(i),i.updateQueue=null,r=Um(i,c,r,d),Dm(n),c=tu(),n!==null&&!At?(nu(n,i,h),ii(n,i,h)):(Pe&&c&&Bc(i),i.flags|=1,Ut(n,i,r,h),i.child)}function jp(n,i,r,c,d){if(ys(i),i.stateNode===null){var h=Zs,A=r.contextType;typeof A=="object"&&A!==null&&(h=Dt(A)),h=new r(c,h),i.memoizedState=h.state!==null&&h.state!==void 0?h.state:null,h.updater=gu,i.stateNode=h,h._reactInternals=i,h=i.stateNode,h.props=c,h.state=i.memoizedState,h.refs={},Kc(i),A=r.contextType,h.context=typeof A=="object"&&A!==null?Dt(A):Zs,h.state=i.memoizedState,A=r.getDerivedStateFromProps,typeof A=="function"&&(yu(i,r,A,c),h.state=i.memoizedState),typeof r.getDerivedStateFromProps=="function"||typeof h.getSnapshotBeforeUpdate=="function"||typeof h.UNSAFE_componentWillMount!="function"&&typeof h.componentWillMount!="function"||(A=h.state,typeof h.componentWillMount=="function"&&h.componentWillMount(),typeof h.UNSAFE_componentWillMount=="function"&&h.UNSAFE_componentWillMount(),A!==h.state&&gu.enqueueReplaceState(h,h.state,null),oo(i,c,h,d),ao(),h.state=i.memoizedState),typeof h.componentDidMount=="function"&&(i.flags|=4194308),c=!0}else if(n===null){h=i.stateNode;var C=i.memoizedProps,L=xs(r,C);h.props=L;var Y=h.context,te=r.contextType;A=Zs,typeof te=="object"&&te!==null&&(A=Dt(te));var ie=r.getDerivedStateFromProps;te=typeof ie=="function"||typeof h.getSnapshotBeforeUpdate=="function",C=i.pendingProps!==C,te||typeof h.UNSAFE_componentWillReceiveProps!="function"&&typeof h.componentWillReceiveProps!="function"||(C||Y!==A)&&Ep(i,h,c,A),Ci=!1;var K=i.memoizedState;h.state=K,oo(i,c,h,d),ao(),Y=i.memoizedState,C||K!==Y||Ci?(typeof ie=="function"&&(yu(i,r,ie,c),Y=i.memoizedState),(L=Ci||Tp(i,r,L,c,K,Y,A))?(te||typeof h.UNSAFE_componentWillMount!="function"&&typeof h.componentWillMount!="function"||(typeof h.componentWillMount=="function"&&h.componentWillMount(),typeof h.UNSAFE_componentWillMount=="function"&&h.UNSAFE_componentWillMount()),typeof h.componentDidMount=="function"&&(i.flags|=4194308)):(typeof h.componentDidMount=="function"&&(i.flags|=4194308),i.memoizedProps=c,i.memoizedState=Y),h.props=c,h.state=Y,h.context=A,c=L):(typeof h.componentDidMount=="function"&&(i.flags|=4194308),c=!1)}else{h=i.stateNode,Fc(n,i),A=i.memoizedProps,te=xs(r,A),h.props=te,ie=i.pendingProps,K=h.context,Y=r.contextType,L=Zs,typeof Y=="object"&&Y!==null&&(L=Dt(Y)),C=r.getDerivedStateFromProps,(Y=typeof C=="function"||typeof h.getSnapshotBeforeUpdate=="function")||typeof h.UNSAFE_componentWillReceiveProps!="function"&&typeof h.componentWillReceiveProps!="function"||(A!==ie||K!==L)&&Ep(i,h,c,L),Ci=!1,K=i.memoizedState,h.state=K,oo(i,c,h,d),ao();var Q=i.memoizedState;A!==ie||K!==Q||Ci||n!==null&&n.dependencies!==null&&yr(n.dependencies)?(typeof C=="function"&&(yu(i,r,C,c),Q=i.memoizedState),(te=Ci||Tp(i,r,te,c,K,Q,L)||n!==null&&n.dependencies!==null&&yr(n.dependencies))?(Y||typeof h.UNSAFE_componentWillUpdate!="function"&&typeof h.componentWillUpdate!="function"||(typeof h.componentWillUpdate=="function"&&h.componentWillUpdate(c,Q,L),typeof h.UNSAFE_componentWillUpdate=="function"&&h.UNSAFE_componentWillUpdate(c,Q,L)),typeof h.componentDidUpdate=="function"&&(i.flags|=4),typeof h.getSnapshotBeforeUpdate=="function"&&(i.flags|=1024)):(typeof h.componentDidUpdate!="function"||A===n.memoizedProps&&K===n.memoizedState||(i.flags|=4),typeof h.getSnapshotBeforeUpdate!="function"||A===n.memoizedProps&&K===n.memoizedState||(i.flags|=1024),i.memoizedProps=c,i.memoizedState=Q),h.props=c,h.state=Q,h.context=L,c=te):(typeof h.componentDidUpdate!="function"||A===n.memoizedProps&&K===n.memoizedState||(i.flags|=4),typeof h.getSnapshotBeforeUpdate!="function"||A===n.memoizedProps&&K===n.memoizedState||(i.flags|=1024),c=!1)}return h=c,Br(n,i),c=(i.flags&128)!==0,h||c?(h=i.stateNode,r=c&&typeof r.getDerivedStateFromError!="function"?null:h.render(),i.flags|=1,n!==null&&c?(i.child=vs(i,n.child,null,d),i.child=vs(i,null,r,d)):Ut(n,i,r,d),i.memoizedState=h.state,n=i.child):n=ii(n,i,d),n}function Dp(n,i,r,c){return ps(),i.flags|=256,Ut(n,i,r,c),i.child}var Au={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function xu(n){return{baseLanes:n,cachePool:Cm()}}function Tu(n,i,r){return n=n!==null?n.childLanes&~r:0,i&&(n|=fn),n}function Up(n,i,r){var c=i.pendingProps,d=!1,h=(i.flags&128)!==0,A;if((A=h)||(A=n!==null&&n.memoizedState===null?!1:(yt.current&2)!==0),A&&(d=!0,i.flags&=-129),A=(i.flags&32)!==0,i.flags&=-33,n===null){if(Pe){if(d?Ni(i):Ri(),(n=Je)?(n=Wh(n,An),n=n!==null&&n.data!=="&"?n:null,n!==null&&(i.memoizedState={dehydrated:n,treeContext:Ei!==null?{id:Un,overflow:$n}:null,retryLane:536870912,hydrationErrors:null},r=Sm(n),r.return=i,i.child=r,jt=i,Je=null)):n=null,n===null)throw Mi(i);return ad(n)?i.lanes=32:i.lanes=536870912,null}var C=c.children;return c=c.fallback,d?(Ri(),d=i.mode,C=Pr({mode:"hidden",children:C},d),c=ms(c,d,r,null),C.return=i,c.return=i,C.sibling=c,i.child=C,c=i.child,c.memoizedState=xu(r),c.childLanes=Tu(n,A,r),i.memoizedState=Au,fo(null,c)):(Ni(i),Eu(i,C))}var L=n.memoizedState;if(L!==null&&(C=L.dehydrated,C!==null)){if(h)i.flags&256?(Ni(i),i.flags&=-257,i=_u(n,i,r)):i.memoizedState!==null?(Ri(),i.child=n.child,i.flags|=128,i=null):(Ri(),C=c.fallback,d=i.mode,c=Pr({mode:"visible",children:c.children},d),C=ms(C,d,r,null),C.flags|=2,c.return=i,C.return=i,c.sibling=C,i.child=c,vs(i,n.child,null,r),c=i.child,c.memoizedState=xu(r),c.childLanes=Tu(n,A,r),i.memoizedState=Au,i=fo(null,c));else if(Ni(i),ad(C)){if(A=C.nextSibling&&C.nextSibling.dataset,A)var Y=A.dgst;A=Y,c=Error(o(419)),c.stack="",c.digest=A,Za({value:c,source:null,stack:null}),i=_u(n,i,r)}else if(At||ia(n,i,r,!1),A=(r&n.childLanes)!==0,At||A){if(A=Xe,A!==null&&(c=js(A,r),c!==0&&c!==L.retryLane))throw L.retryLane=c,fs(n,c),an(A,n,c),Su;sd(C)||Yr(),i=_u(n,i,r)}else sd(C)?(i.flags|=192,i.child=n.child,i=null):(n=L.treeContext,Je=Tn(C.nextSibling),jt=i,Pe=!0,_i=null,An=!1,n!==null&&xm(i,n),i=Eu(i,c.children),i.flags|=4096);return i}return d?(Ri(),C=c.fallback,d=i.mode,L=n.child,Y=L.sibling,c=Jn(L,{mode:"hidden",children:c.children}),c.subtreeFlags=L.subtreeFlags&65011712,Y!==null?C=Jn(Y,C):(C=ms(C,d,r,null),C.flags|=2),C.return=i,c.return=i,c.sibling=C,i.child=c,fo(null,c),c=i.child,C=n.child.memoizedState,C===null?C=xu(r):(d=C.cachePool,d!==null?(L=St._currentValue,d=d.parent!==L?{parent:L,pool:L}:d):d=Cm(),C={baseLanes:C.baseLanes|r,cachePool:d}),c.memoizedState=C,c.childLanes=Tu(n,A,r),i.memoizedState=Au,fo(n.child,c)):(Ni(i),r=n.child,n=r.sibling,r=Jn(r,{mode:"visible",children:c.children}),r.return=i,r.sibling=null,n!==null&&(A=i.deletions,A===null?(i.deletions=[n],i.flags|=16):A.push(n)),i.child=r,i.memoizedState=null,r)}function Eu(n,i){return i=Pr({mode:"visible",children:i},n.mode),i.return=n,n.child=i}function Pr(n,i){return n=ln(22,n,null,i),n.lanes=0,n}function _u(n,i,r){return vs(i,n.child,null,r),n=Eu(i,i.pendingProps.children),n.flags|=2,i.memoizedState=null,n}function $p(n,i,r){n.lanes|=i;var c=n.alternate;c!==null&&(c.lanes|=i),Uc(n.return,i,r)}function Mu(n,i,r,c,d,h){var A=n.memoizedState;A===null?n.memoizedState={isBackwards:i,rendering:null,renderingStartTime:0,last:c,tail:r,tailMode:d,treeForkCount:h}:(A.isBackwards=i,A.rendering=null,A.renderingStartTime=0,A.last=c,A.tail=r,A.tailMode=d,A.treeForkCount=h)}function qp(n,i,r){var c=i.pendingProps,d=c.revealOrder,h=c.tail;c=c.children;var A=yt.current,C=(A&2)!==0;if(C?(A=A&1|2,i.flags|=128):A&=1,X(yt,A),Ut(n,i,c,r),c=Pe?Qa:0,!C&&n!==null&&(n.flags&128)!==0)e:for(n=i.child;n!==null;){if(n.tag===13)n.memoizedState!==null&&$p(n,r,i);else if(n.tag===19)$p(n,r,i);else if(n.child!==null){n.child.return=n,n=n.child;continue}if(n===i)break e;for(;n.sibling===null;){if(n.return===null||n.return===i)break e;n=n.return}n.sibling.return=n.return,n=n.sibling}switch(d){case"forwards":for(r=i.child,d=null;r!==null;)n=r.alternate,n!==null&&Er(n)===null&&(d=r),r=r.sibling;r=d,r===null?(d=i.child,i.child=null):(d=r.sibling,r.sibling=null),Mu(i,!1,d,r,h,c);break;case"backwards":case"unstable_legacy-backwards":for(r=null,d=i.child,i.child=null;d!==null;){if(n=d.alternate,n!==null&&Er(n)===null){i.child=d;break}n=d.sibling,d.sibling=r,r=d,d=n}Mu(i,!0,r,null,h,c);break;case"together":Mu(i,!1,null,null,void 0,c);break;default:i.memoizedState=null}return i.child}function ii(n,i,r){if(n!==null&&(i.dependencies=n.dependencies),Bi|=i.lanes,(r&i.childLanes)===0)if(n!==null){if(ia(n,i,r,!1),(r&i.childLanes)===0)return null}else return null;if(n!==null&&i.child!==n.child)throw Error(o(153));if(i.child!==null){for(n=i.child,r=Jn(n,n.pendingProps),i.child=r,r.return=i;n.sibling!==null;)n=n.sibling,r=r.sibling=Jn(n,n.pendingProps),r.return=i;r.sibling=null}return i.child}function wu(n,i){return(n.lanes&i)!==0?!0:(n=n.dependencies,!!(n!==null&&yr(n)))}function US(n,i,r){switch(i.tag){case 3:$e(i,i.stateNode.containerInfo),wi(i,St,n.memoizedState.cache),ps();break;case 27:case 5:at(i);break;case 4:$e(i,i.stateNode.containerInfo);break;case 10:wi(i,i.type,i.memoizedProps.value);break;case 31:if(i.memoizedState!==null)return i.flags|=128,Qc(i),null;break;case 13:var c=i.memoizedState;if(c!==null)return c.dehydrated!==null?(Ni(i),i.flags|=128,null):(r&i.child.childLanes)!==0?Up(n,i,r):(Ni(i),n=ii(n,i,r),n!==null?n.sibling:null);Ni(i);break;case 19:var d=(n.flags&128)!==0;if(c=(r&i.childLanes)!==0,c||(ia(n,i,r,!1),c=(r&i.childLanes)!==0),d){if(c)return qp(n,i,r);i.flags|=128}if(d=i.memoizedState,d!==null&&(d.rendering=null,d.tail=null,d.lastEffect=null),X(yt,yt.current),c)break;return null;case 22:return i.lanes=0,Lp(n,i,r,i.pendingProps);case 24:wi(i,St,n.memoizedState.cache)}return ii(n,i,r)}function zp(n,i,r){if(n!==null)if(n.memoizedProps!==i.pendingProps)At=!0;else{if(!wu(n,r)&&(i.flags&128)===0)return At=!1,US(n,i,r);At=(n.flags&131072)!==0}else At=!1,Pe&&(i.flags&1048576)!==0&&Am(i,Qa,i.index);switch(i.lanes=0,i.tag){case 16:e:{var c=i.pendingProps;if(n=bs(i.elementType),i.type=n,typeof n=="function")Rc(n)?(c=xs(n,c),i.tag=1,i=jp(null,i,n,c,r)):(i.tag=0,i=vu(null,i,n,c,r));else{if(n!=null){var d=n.$$typeof;if(d===k){i.tag=11,i=Np(null,i,n,c,r);break e}else if(d===I){i.tag=14,i=Rp(null,i,n,c,r);break e}}throw i=oe(n)||n,Error(o(306,i,""))}}return i;case 0:return vu(n,i,i.type,i.pendingProps,r);case 1:return c=i.type,d=xs(c,i.pendingProps),jp(n,i,c,d,r);case 3:e:{if($e(i,i.stateNode.containerInfo),n===null)throw Error(o(387));c=i.pendingProps;var h=i.memoizedState;d=h.element,Fc(n,i),oo(i,c,null,r);var A=i.memoizedState;if(c=A.cache,wi(i,St,c),c!==h.cache&&$c(i,[St],r,!0),ao(),c=A.element,h.isDehydrated)if(h={element:c,isDehydrated:!1,cache:A.cache},i.updateQueue.baseState=h,i.memoizedState=h,i.flags&256){i=Dp(n,i,c,r);break e}else if(c!==d){d=bn(Error(o(424)),i),Za(d),i=Dp(n,i,c,r);break e}else for(n=i.stateNode.containerInfo,n.nodeType===9?n=n.body:n=n.nodeName==="HTML"?n.ownerDocument.body:n,Je=Tn(n.firstChild),jt=i,Pe=!0,_i=null,An=!0,r=Lm(i,null,c,r),i.child=r;r;)r.flags=r.flags&-3|4096,r=r.sibling;else{if(ps(),c===d){i=ii(n,i,r);break e}Ut(n,i,c,r)}i=i.child}return i;case 26:return Br(n,i),n===null?(r=ey(i.type,null,i.pendingProps,null))?i.memoizedState=r:Pe||(r=i.type,n=i.pendingProps,c=Qr(ue.current).createElement(r),c[Ht]=i,c[Qt]=n,$t(c,r,n),Nt(c),i.stateNode=c):i.memoizedState=ey(i.type,n.memoizedProps,i.pendingProps,n.memoizedState),null;case 27:return at(i),n===null&&Pe&&(c=i.stateNode=Jh(i.type,i.pendingProps,ue.current),jt=i,An=!0,d=Je,Ui(i.type)?(od=d,Je=Tn(c.firstChild)):Je=d),Ut(n,i,i.pendingProps.children,r),Br(n,i),n===null&&(i.flags|=4194304),i.child;case 5:return n===null&&Pe&&((d=c=Je)&&(c=yv(c,i.type,i.pendingProps,An),c!==null?(i.stateNode=c,jt=i,Je=Tn(c.firstChild),An=!1,d=!0):d=!1),d||Mi(i)),at(i),d=i.type,h=i.pendingProps,A=n!==null?n.memoizedProps:null,c=h.children,td(d,h)?c=null:A!==null&&td(d,A)&&(i.flags|=32),i.memoizedState!==null&&(d=eu(n,i,NS,null,null,r),wo._currentValue=d),Br(n,i),Ut(n,i,c,r),i.child;case 6:return n===null&&Pe&&((n=r=Je)&&(r=gv(r,i.pendingProps,An),r!==null?(i.stateNode=r,jt=i,Je=null,n=!0):n=!1),n||Mi(i)),null;case 13:return Up(n,i,r);case 4:return $e(i,i.stateNode.containerInfo),c=i.pendingProps,n===null?i.child=vs(i,null,c,r):Ut(n,i,c,r),i.child;case 11:return Np(n,i,i.type,i.pendingProps,r);case 7:return Ut(n,i,i.pendingProps,r),i.child;case 8:return Ut(n,i,i.pendingProps.children,r),i.child;case 12:return Ut(n,i,i.pendingProps.children,r),i.child;case 10:return c=i.pendingProps,wi(i,i.type,c.value),Ut(n,i,c.children,r),i.child;case 9:return d=i.type._context,c=i.pendingProps.children,ys(i),d=Dt(d),c=c(d),i.flags|=1,Ut(n,i,c,r),i.child;case 14:return Rp(n,i,i.type,i.pendingProps,r);case 15:return Ip(n,i,i.type,i.pendingProps,r);case 19:return qp(n,i,r);case 31:return DS(n,i,r);case 22:return Lp(n,i,r,i.pendingProps);case 24:return ys(i),c=Dt(St),n===null?(d=Vc(),d===null&&(d=Xe,h=qc(),d.pooledCache=h,h.refCount++,h!==null&&(d.pooledCacheLanes|=r),d=h),i.memoizedState={parent:c,cache:d},Kc(i),wi(i,St,d)):((n.lanes&r)!==0&&(Fc(n,i),oo(i,null,null,r),ao()),d=n.memoizedState,h=i.memoizedState,d.parent!==c?(d={parent:c,cache:c},i.memoizedState=d,i.lanes===0&&(i.memoizedState=i.updateQueue.baseState=d),wi(i,St,c)):(c=h.cache,wi(i,St,c),c!==d.cache&&$c(i,[St],r,!0))),Ut(n,i,i.pendingProps.children,r),i.child;case 29:throw i.pendingProps}throw Error(o(156,i.tag))}function si(n){n.flags|=4}function Cu(n,i,r,c,d){if((i=(n.mode&32)!==0)&&(i=!1),i){if(n.flags|=16777216,(d&335544128)===d)if(n.stateNode.complete)n.flags|=8192;else if(yh())n.flags|=8192;else throw Ss=vr,Yc}else n.flags&=-16777217}function Vp(n,i){if(i.type!=="stylesheet"||(i.state.loading&4)!==0)n.flags&=-16777217;else if(n.flags|=16777216,!ay(i))if(yh())n.flags|=8192;else throw Ss=vr,Yc}function Hr(n,i){i!==null&&(n.flags|=4),n.flags&16384&&(i=n.tag!==22?ja():536870912,n.lanes|=i,ha|=i)}function mo(n,i){if(!Pe)switch(n.tailMode){case"hidden":i=n.tail;for(var r=null;i!==null;)i.alternate!==null&&(r=i),i=i.sibling;r===null?n.tail=null:r.sibling=null;break;case"collapsed":r=n.tail;for(var c=null;r!==null;)r.alternate!==null&&(c=r),r=r.sibling;c===null?i||n.tail===null?n.tail=null:n.tail.sibling=null:c.sibling=null}}function Qe(n){var i=n.alternate!==null&&n.alternate.child===n.child,r=0,c=0;if(i)for(var d=n.child;d!==null;)r|=d.lanes|d.childLanes,c|=d.subtreeFlags&65011712,c|=d.flags&65011712,d.return=n,d=d.sibling;else for(d=n.child;d!==null;)r|=d.lanes|d.childLanes,c|=d.subtreeFlags,c|=d.flags,d.return=n,d=d.sibling;return n.subtreeFlags|=c,n.childLanes=r,i}function $S(n,i,r){var c=i.pendingProps;switch(Pc(i),i.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Qe(i),null;case 1:return Qe(i),null;case 3:return r=i.stateNode,c=null,n!==null&&(c=n.memoizedState.cache),i.memoizedState.cache!==c&&(i.flags|=2048),ei(St),Ee(),r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),(n===null||n.child===null)&&(na(i)?si(i):n===null||n.memoizedState.isDehydrated&&(i.flags&256)===0||(i.flags|=1024,jc())),Qe(i),null;case 26:var d=i.type,h=i.memoizedState;return n===null?(si(i),h!==null?(Qe(i),Vp(i,h)):(Qe(i),Cu(i,d,null,c,r))):h?h!==n.memoizedState?(si(i),Qe(i),Vp(i,h)):(Qe(i),i.flags&=-16777217):(n=n.memoizedProps,n!==c&&si(i),Qe(i),Cu(i,d,n,c,r)),null;case 27:if(ot(i),r=ue.current,d=i.type,n!==null&&i.stateNode!=null)n.memoizedProps!==c&&si(i);else{if(!c){if(i.stateNode===null)throw Error(o(166));return Qe(i),null}n=ae.current,na(i)?Tm(i):(n=Jh(d,c,r),i.stateNode=n,si(i))}return Qe(i),null;case 5:if(ot(i),d=i.type,n!==null&&i.stateNode!=null)n.memoizedProps!==c&&si(i);else{if(!c){if(i.stateNode===null)throw Error(o(166));return Qe(i),null}if(h=ae.current,na(i))Tm(i);else{var A=Qr(ue.current);switch(h){case 1:h=A.createElementNS("http://www.w3.org/2000/svg",d);break;case 2:h=A.createElementNS("http://www.w3.org/1998/Math/MathML",d);break;default:switch(d){case"svg":h=A.createElementNS("http://www.w3.org/2000/svg",d);break;case"math":h=A.createElementNS("http://www.w3.org/1998/Math/MathML",d);break;case"script":h=A.createElement("div"),h.innerHTML="<script><\/script>",h=h.removeChild(h.firstChild);break;case"select":h=typeof c.is=="string"?A.createElement("select",{is:c.is}):A.createElement("select"),c.multiple?h.multiple=!0:c.size&&(h.size=c.size);break;default:h=typeof c.is=="string"?A.createElement(d,{is:c.is}):A.createElement(d)}}h[Ht]=i,h[Qt]=c;e:for(A=i.child;A!==null;){if(A.tag===5||A.tag===6)h.appendChild(A.stateNode);else if(A.tag!==4&&A.tag!==27&&A.child!==null){A.child.return=A,A=A.child;continue}if(A===i)break e;for(;A.sibling===null;){if(A.return===null||A.return===i)break e;A=A.return}A.sibling.return=A.return,A=A.sibling}i.stateNode=h;e:switch($t(h,d,c),d){case"button":case"input":case"select":case"textarea":c=!!c.autoFocus;break e;case"img":c=!0;break e;default:c=!1}c&&si(i)}}return Qe(i),Cu(i,i.type,n===null?null:n.memoizedProps,i.pendingProps,r),null;case 6:if(n&&i.stateNode!=null)n.memoizedProps!==c&&si(i);else{if(typeof c!="string"&&i.stateNode===null)throw Error(o(166));if(n=ue.current,na(i)){if(n=i.stateNode,r=i.memoizedProps,c=null,d=jt,d!==null)switch(d.tag){case 27:case 5:c=d.memoizedProps}n[Ht]=i,n=!!(n.nodeValue===r||c!==null&&c.suppressHydrationWarning===!0||Uh(n.nodeValue,r)),n||Mi(i,!0)}else n=Qr(n).createTextNode(c),n[Ht]=i,i.stateNode=n}return Qe(i),null;case 31:if(r=i.memoizedState,n===null||n.memoizedState!==null){if(c=na(i),r!==null){if(n===null){if(!c)throw Error(o(318));if(n=i.memoizedState,n=n!==null?n.dehydrated:null,!n)throw Error(o(557));n[Ht]=i}else ps(),(i.flags&128)===0&&(i.memoizedState=null),i.flags|=4;Qe(i),n=!1}else r=jc(),n!==null&&n.memoizedState!==null&&(n.memoizedState.hydrationErrors=r),n=!0;if(!n)return i.flags&256?(un(i),i):(un(i),null);if((i.flags&128)!==0)throw Error(o(558))}return Qe(i),null;case 13:if(c=i.memoizedState,n===null||n.memoizedState!==null&&n.memoizedState.dehydrated!==null){if(d=na(i),c!==null&&c.dehydrated!==null){if(n===null){if(!d)throw Error(o(318));if(d=i.memoizedState,d=d!==null?d.dehydrated:null,!d)throw Error(o(317));d[Ht]=i}else ps(),(i.flags&128)===0&&(i.memoizedState=null),i.flags|=4;Qe(i),d=!1}else d=jc(),n!==null&&n.memoizedState!==null&&(n.memoizedState.hydrationErrors=d),d=!0;if(!d)return i.flags&256?(un(i),i):(un(i),null)}return un(i),(i.flags&128)!==0?(i.lanes=r,i):(r=c!==null,n=n!==null&&n.memoizedState!==null,r&&(c=i.child,d=null,c.alternate!==null&&c.alternate.memoizedState!==null&&c.alternate.memoizedState.cachePool!==null&&(d=c.alternate.memoizedState.cachePool.pool),h=null,c.memoizedState!==null&&c.memoizedState.cachePool!==null&&(h=c.memoizedState.cachePool.pool),h!==d&&(c.flags|=2048)),r!==n&&r&&(i.child.flags|=8192),Hr(i,i.updateQueue),Qe(i),null);case 4:return Ee(),n===null&&Gu(i.stateNode.containerInfo),Qe(i),null;case 10:return ei(i.type),Qe(i),null;case 19:if(W(yt),c=i.memoizedState,c===null)return Qe(i),null;if(d=(i.flags&128)!==0,h=c.rendering,h===null)if(d)mo(c,!1);else{if(dt!==0||n!==null&&(n.flags&128)!==0)for(n=i.child;n!==null;){if(h=Er(n),h!==null){for(i.flags|=128,mo(c,!1),n=h.updateQueue,i.updateQueue=n,Hr(i,n),i.subtreeFlags=0,n=r,r=i.child;r!==null;)bm(r,n),r=r.sibling;return X(yt,yt.current&1|2),Pe&&Qn(i,c.treeForkCount),i.child}n=n.sibling}c.tail!==null&&It()>qr&&(i.flags|=128,d=!0,mo(c,!1),i.lanes=4194304)}else{if(!d)if(n=Er(h),n!==null){if(i.flags|=128,d=!0,n=n.updateQueue,i.updateQueue=n,Hr(i,n),mo(c,!0),c.tail===null&&c.tailMode==="hidden"&&!h.alternate&&!Pe)return Qe(i),null}else 2*It()-c.renderingStartTime>qr&&r!==536870912&&(i.flags|=128,d=!0,mo(c,!1),i.lanes=4194304);c.isBackwards?(h.sibling=i.child,i.child=h):(n=c.last,n!==null?n.sibling=h:i.child=h,c.last=h)}return c.tail!==null?(n=c.tail,c.rendering=n,c.tail=n.sibling,c.renderingStartTime=It(),n.sibling=null,r=yt.current,X(yt,d?r&1|2:r&1),Pe&&Qn(i,c.treeForkCount),n):(Qe(i),null);case 22:case 23:return un(i),Jc(),c=i.memoizedState!==null,n!==null?n.memoizedState!==null!==c&&(i.flags|=8192):c&&(i.flags|=8192),c?(r&536870912)!==0&&(i.flags&128)===0&&(Qe(i),i.subtreeFlags&6&&(i.flags|=8192)):Qe(i),r=i.updateQueue,r!==null&&Hr(i,r.retryQueue),r=null,n!==null&&n.memoizedState!==null&&n.memoizedState.cachePool!==null&&(r=n.memoizedState.cachePool.pool),c=null,i.memoizedState!==null&&i.memoizedState.cachePool!==null&&(c=i.memoizedState.cachePool.pool),c!==r&&(i.flags|=2048),n!==null&&W(gs),null;case 24:return r=null,n!==null&&(r=n.memoizedState.cache),i.memoizedState.cache!==r&&(i.flags|=2048),ei(St),Qe(i),null;case 25:return null;case 30:return null}throw Error(o(156,i.tag))}function qS(n,i){switch(Pc(i),i.tag){case 1:return n=i.flags,n&65536?(i.flags=n&-65537|128,i):null;case 3:return ei(St),Ee(),n=i.flags,(n&65536)!==0&&(n&128)===0?(i.flags=n&-65537|128,i):null;case 26:case 27:case 5:return ot(i),null;case 31:if(i.memoizedState!==null){if(un(i),i.alternate===null)throw Error(o(340));ps()}return n=i.flags,n&65536?(i.flags=n&-65537|128,i):null;case 13:if(un(i),n=i.memoizedState,n!==null&&n.dehydrated!==null){if(i.alternate===null)throw Error(o(340));ps()}return n=i.flags,n&65536?(i.flags=n&-65537|128,i):null;case 19:return W(yt),null;case 4:return Ee(),null;case 10:return ei(i.type),null;case 22:case 23:return un(i),Jc(),n!==null&&W(gs),n=i.flags,n&65536?(i.flags=n&-65537|128,i):null;case 24:return ei(St),null;case 25:return null;default:return null}}function Yp(n,i){switch(Pc(i),i.tag){case 3:ei(St),Ee();break;case 26:case 27:case 5:ot(i);break;case 4:Ee();break;case 31:i.memoizedState!==null&&un(i);break;case 13:un(i);break;case 19:W(yt);break;case 10:ei(i.type);break;case 22:case 23:un(i),Jc(),n!==null&&W(gs);break;case 24:ei(St)}}function po(n,i){try{var r=i.updateQueue,c=r!==null?r.lastEffect:null;if(c!==null){var d=c.next;r=d;do{if((r.tag&n)===n){c=void 0;var h=r.create,A=r.inst;c=h(),A.destroy=c}r=r.next}while(r!==d)}}catch(C){Ve(i,i.return,C)}}function Ii(n,i,r){try{var c=i.updateQueue,d=c!==null?c.lastEffect:null;if(d!==null){var h=d.next;c=h;do{if((c.tag&n)===n){var A=c.inst,C=A.destroy;if(C!==void 0){A.destroy=void 0,d=i;var L=r,Y=C;try{Y()}catch(te){Ve(d,L,te)}}}c=c.next}while(c!==h)}}catch(te){Ve(i,i.return,te)}}function Kp(n){var i=n.updateQueue;if(i!==null){var r=n.stateNode;try{Pm(i,r)}catch(c){Ve(n,n.return,c)}}}function Fp(n,i,r){r.props=xs(n.type,n.memoizedProps),r.state=n.memoizedState;try{r.componentWillUnmount()}catch(c){Ve(n,i,c)}}function ho(n,i){try{var r=n.ref;if(r!==null){switch(n.tag){case 26:case 27:case 5:var c=n.stateNode;break;case 30:c=n.stateNode;break;default:c=n.stateNode}typeof r=="function"?n.refCleanup=r(c):r.current=c}}catch(d){Ve(n,i,d)}}function qn(n,i){var r=n.ref,c=n.refCleanup;if(r!==null)if(typeof c=="function")try{c()}catch(d){Ve(n,i,d)}finally{n.refCleanup=null,n=n.alternate,n!=null&&(n.refCleanup=null)}else if(typeof r=="function")try{r(null)}catch(d){Ve(n,i,d)}else r.current=null}function Wp(n){var i=n.type,r=n.memoizedProps,c=n.stateNode;try{e:switch(i){case"button":case"input":case"select":case"textarea":r.autoFocus&&c.focus();break e;case"img":r.src?c.src=r.src:r.srcSet&&(c.srcset=r.srcSet)}}catch(d){Ve(n,n.return,d)}}function Ou(n,i,r){try{var c=n.stateNode;uv(c,n.type,r,i),c[Qt]=i}catch(d){Ve(n,n.return,d)}}function Xp(n){return n.tag===5||n.tag===3||n.tag===26||n.tag===27&&Ui(n.type)||n.tag===4}function ku(n){e:for(;;){for(;n.sibling===null;){if(n.return===null||Xp(n.return))return null;n=n.return}for(n.sibling.return=n.return,n=n.sibling;n.tag!==5&&n.tag!==6&&n.tag!==18;){if(n.tag===27&&Ui(n.type)||n.flags&2||n.child===null||n.tag===4)continue e;n.child.return=n,n=n.child}if(!(n.flags&2))return n.stateNode}}function Nu(n,i,r){var c=n.tag;if(c===5||c===6)n=n.stateNode,i?(r.nodeType===9?r.body:r.nodeName==="HTML"?r.ownerDocument.body:r).insertBefore(n,i):(i=r.nodeType===9?r.body:r.nodeName==="HTML"?r.ownerDocument.body:r,i.appendChild(n),r=r._reactRootContainer,r!=null||i.onclick!==null||(i.onclick=Xn));else if(c!==4&&(c===27&&Ui(n.type)&&(r=n.stateNode,i=null),n=n.child,n!==null))for(Nu(n,i,r),n=n.sibling;n!==null;)Nu(n,i,r),n=n.sibling}function jr(n,i,r){var c=n.tag;if(c===5||c===6)n=n.stateNode,i?r.insertBefore(n,i):r.appendChild(n);else if(c!==4&&(c===27&&Ui(n.type)&&(r=n.stateNode),n=n.child,n!==null))for(jr(n,i,r),n=n.sibling;n!==null;)jr(n,i,r),n=n.sibling}function Gp(n){var i=n.stateNode,r=n.memoizedProps;try{for(var c=n.type,d=i.attributes;d.length;)i.removeAttributeNode(d[0]);$t(i,c,r),i[Ht]=n,i[Qt]=r}catch(h){Ve(n,n.return,h)}}var ai=!1,xt=!1,Ru=!1,Jp=typeof WeakSet=="function"?WeakSet:Set,Rt=null;function zS(n,i){if(n=n.containerInfo,Zu=al,n=cm(n),_c(n)){if("selectionStart"in n)var r={start:n.selectionStart,end:n.selectionEnd};else e:{r=(r=n.ownerDocument)&&r.defaultView||window;var c=r.getSelection&&r.getSelection();if(c&&c.rangeCount!==0){r=c.anchorNode;var d=c.anchorOffset,h=c.focusNode;c=c.focusOffset;try{r.nodeType,h.nodeType}catch{r=null;break e}var A=0,C=-1,L=-1,Y=0,te=0,ie=n,K=null;t:for(;;){for(var Q;ie!==r||d!==0&&ie.nodeType!==3||(C=A+d),ie!==h||c!==0&&ie.nodeType!==3||(L=A+c),ie.nodeType===3&&(A+=ie.nodeValue.length),(Q=ie.firstChild)!==null;)K=ie,ie=Q;for(;;){if(ie===n)break t;if(K===r&&++Y===d&&(C=A),K===h&&++te===c&&(L=A),(Q=ie.nextSibling)!==null)break;ie=K,K=ie.parentNode}ie=Q}r=C===-1||L===-1?null:{start:C,end:L}}else r=null}r=r||{start:0,end:0}}else r=null;for(ed={focusedElem:n,selectionRange:r},al=!1,Rt=i;Rt!==null;)if(i=Rt,n=i.child,(i.subtreeFlags&1028)!==0&&n!==null)n.return=i,Rt=n;else for(;Rt!==null;){switch(i=Rt,h=i.alternate,n=i.flags,i.tag){case 0:if((n&4)!==0&&(n=i.updateQueue,n=n!==null?n.events:null,n!==null))for(r=0;r<n.length;r++)d=n[r],d.ref.impl=d.nextImpl;break;case 11:case 15:break;case 1:if((n&1024)!==0&&h!==null){n=void 0,r=i,d=h.memoizedProps,h=h.memoizedState,c=r.stateNode;try{var me=xs(r.type,d);n=c.getSnapshotBeforeUpdate(me,h),c.__reactInternalSnapshotBeforeUpdate=n}catch(ve){Ve(r,r.return,ve)}}break;case 3:if((n&1024)!==0){if(n=i.stateNode.containerInfo,r=n.nodeType,r===9)id(n);else if(r===1)switch(n.nodeName){case"HEAD":case"HTML":case"BODY":id(n);break;default:n.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((n&1024)!==0)throw Error(o(163))}if(n=i.sibling,n!==null){n.return=i.return,Rt=n;break}Rt=i.return}}function Qp(n,i,r){var c=r.flags;switch(r.tag){case 0:case 11:case 15:ri(n,r),c&4&&po(5,r);break;case 1:if(ri(n,r),c&4)if(n=r.stateNode,i===null)try{n.componentDidMount()}catch(A){Ve(r,r.return,A)}else{var d=xs(r.type,i.memoizedProps);i=i.memoizedState;try{n.componentDidUpdate(d,i,n.__reactInternalSnapshotBeforeUpdate)}catch(A){Ve(r,r.return,A)}}c&64&&Kp(r),c&512&&ho(r,r.return);break;case 3:if(ri(n,r),c&64&&(n=r.updateQueue,n!==null)){if(i=null,r.child!==null)switch(r.child.tag){case 27:case 5:i=r.child.stateNode;break;case 1:i=r.child.stateNode}try{Pm(n,i)}catch(A){Ve(r,r.return,A)}}break;case 27:i===null&&c&4&&Gp(r);case 26:case 5:ri(n,r),i===null&&c&4&&Wp(r),c&512&&ho(r,r.return);break;case 12:ri(n,r);break;case 31:ri(n,r),c&4&&th(n,r);break;case 13:ri(n,r),c&4&&nh(n,r),c&64&&(n=r.memoizedState,n!==null&&(n=n.dehydrated,n!==null&&(r=QS.bind(null,r),bv(n,r))));break;case 22:if(c=r.memoizedState!==null||ai,!c){i=i!==null&&i.memoizedState!==null||xt,d=ai;var h=xt;ai=c,(xt=i)&&!h?li(n,r,(r.subtreeFlags&8772)!==0):ri(n,r),ai=d,xt=h}break;case 30:break;default:ri(n,r)}}function Zp(n){var i=n.alternate;i!==null&&(n.alternate=null,Zp(i)),n.child=null,n.deletions=null,n.sibling=null,n.tag===5&&(i=n.stateNode,i!==null&&lc(i)),n.stateNode=null,n.return=null,n.dependencies=null,n.memoizedProps=null,n.memoizedState=null,n.pendingProps=null,n.stateNode=null,n.updateQueue=null}var tt=null,en=!1;function oi(n,i,r){for(r=r.child;r!==null;)eh(n,i,r),r=r.sibling}function eh(n,i,r){if(Lt&&typeof Lt.onCommitFiberUnmount=="function")try{Lt.onCommitFiberUnmount(Fn,r)}catch{}switch(r.tag){case 26:xt||qn(r,i),oi(n,i,r),r.memoizedState?r.memoizedState.count--:r.stateNode&&(r=r.stateNode,r.parentNode.removeChild(r));break;case 27:xt||qn(r,i);var c=tt,d=en;Ui(r.type)&&(tt=r.stateNode,en=!1),oi(n,i,r),Eo(r.stateNode),tt=c,en=d;break;case 5:xt||qn(r,i);case 6:if(c=tt,d=en,tt=null,oi(n,i,r),tt=c,en=d,tt!==null)if(en)try{(tt.nodeType===9?tt.body:tt.nodeName==="HTML"?tt.ownerDocument.body:tt).removeChild(r.stateNode)}catch(h){Ve(r,i,h)}else try{tt.removeChild(r.stateNode)}catch(h){Ve(r,i,h)}break;case 18:tt!==null&&(en?(n=tt,Kh(n.nodeType===9?n.body:n.nodeName==="HTML"?n.ownerDocument.body:n,r.stateNode),Ta(n)):Kh(tt,r.stateNode));break;case 4:c=tt,d=en,tt=r.stateNode.containerInfo,en=!0,oi(n,i,r),tt=c,en=d;break;case 0:case 11:case 14:case 15:Ii(2,r,i),xt||Ii(4,r,i),oi(n,i,r);break;case 1:xt||(qn(r,i),c=r.stateNode,typeof c.componentWillUnmount=="function"&&Fp(r,i,c)),oi(n,i,r);break;case 21:oi(n,i,r);break;case 22:xt=(c=xt)||r.memoizedState!==null,oi(n,i,r),xt=c;break;default:oi(n,i,r)}}function th(n,i){if(i.memoizedState===null&&(n=i.alternate,n!==null&&(n=n.memoizedState,n!==null))){n=n.dehydrated;try{Ta(n)}catch(r){Ve(i,i.return,r)}}}function nh(n,i){if(i.memoizedState===null&&(n=i.alternate,n!==null&&(n=n.memoizedState,n!==null&&(n=n.dehydrated,n!==null))))try{Ta(n)}catch(r){Ve(i,i.return,r)}}function VS(n){switch(n.tag){case 31:case 13:case 19:var i=n.stateNode;return i===null&&(i=n.stateNode=new Jp),i;case 22:return n=n.stateNode,i=n._retryCache,i===null&&(i=n._retryCache=new Jp),i;default:throw Error(o(435,n.tag))}}function Dr(n,i){var r=VS(n);i.forEach(function(c){if(!r.has(c)){r.add(c);var d=ZS.bind(null,n,c);c.then(d,d)}})}function tn(n,i){var r=i.deletions;if(r!==null)for(var c=0;c<r.length;c++){var d=r[c],h=n,A=i,C=A;e:for(;C!==null;){switch(C.tag){case 27:if(Ui(C.type)){tt=C.stateNode,en=!1;break e}break;case 5:tt=C.stateNode,en=!1;break e;case 3:case 4:tt=C.stateNode.containerInfo,en=!0;break e}C=C.return}if(tt===null)throw Error(o(160));eh(h,A,d),tt=null,en=!1,h=d.alternate,h!==null&&(h.return=null),d.return=null}if(i.subtreeFlags&13886)for(i=i.child;i!==null;)ih(i,n),i=i.sibling}var Nn=null;function ih(n,i){var r=n.alternate,c=n.flags;switch(n.tag){case 0:case 11:case 14:case 15:tn(i,n),nn(n),c&4&&(Ii(3,n,n.return),po(3,n),Ii(5,n,n.return));break;case 1:tn(i,n),nn(n),c&512&&(xt||r===null||qn(r,r.return)),c&64&&ai&&(n=n.updateQueue,n!==null&&(c=n.callbacks,c!==null&&(r=n.shared.hiddenCallbacks,n.shared.hiddenCallbacks=r===null?c:r.concat(c))));break;case 26:var d=Nn;if(tn(i,n),nn(n),c&512&&(xt||r===null||qn(r,r.return)),c&4){var h=r!==null?r.memoizedState:null;if(c=n.memoizedState,r===null)if(c===null)if(n.stateNode===null){e:{c=n.type,r=n.memoizedProps,d=d.ownerDocument||d;t:switch(c){case"title":h=d.getElementsByTagName("title")[0],(!h||h[$a]||h[Ht]||h.namespaceURI==="http://www.w3.org/2000/svg"||h.hasAttribute("itemprop"))&&(h=d.createElement(c),d.head.insertBefore(h,d.querySelector("head > title"))),$t(h,c,r),h[Ht]=n,Nt(h),c=h;break e;case"link":var A=iy("link","href",d).get(c+(r.href||""));if(A){for(var C=0;C<A.length;C++)if(h=A[C],h.getAttribute("href")===(r.href==null||r.href===""?null:r.href)&&h.getAttribute("rel")===(r.rel==null?null:r.rel)&&h.getAttribute("title")===(r.title==null?null:r.title)&&h.getAttribute("crossorigin")===(r.crossOrigin==null?null:r.crossOrigin)){A.splice(C,1);break t}}h=d.createElement(c),$t(h,c,r),d.head.appendChild(h);break;case"meta":if(A=iy("meta","content",d).get(c+(r.content||""))){for(C=0;C<A.length;C++)if(h=A[C],h.getAttribute("content")===(r.content==null?null:""+r.content)&&h.getAttribute("name")===(r.name==null?null:r.name)&&h.getAttribute("property")===(r.property==null?null:r.property)&&h.getAttribute("http-equiv")===(r.httpEquiv==null?null:r.httpEquiv)&&h.getAttribute("charset")===(r.charSet==null?null:r.charSet)){A.splice(C,1);break t}}h=d.createElement(c),$t(h,c,r),d.head.appendChild(h);break;default:throw Error(o(468,c))}h[Ht]=n,Nt(h),c=h}n.stateNode=c}else sy(d,n.type,n.stateNode);else n.stateNode=ny(d,c,n.memoizedProps);else h!==c?(h===null?r.stateNode!==null&&(r=r.stateNode,r.parentNode.removeChild(r)):h.count--,c===null?sy(d,n.type,n.stateNode):ny(d,c,n.memoizedProps)):c===null&&n.stateNode!==null&&Ou(n,n.memoizedProps,r.memoizedProps)}break;case 27:tn(i,n),nn(n),c&512&&(xt||r===null||qn(r,r.return)),r!==null&&c&4&&Ou(n,n.memoizedProps,r.memoizedProps);break;case 5:if(tn(i,n),nn(n),c&512&&(xt||r===null||qn(r,r.return)),n.flags&32){d=n.stateNode;try{Ks(d,"")}catch(me){Ve(n,n.return,me)}}c&4&&n.stateNode!=null&&(d=n.memoizedProps,Ou(n,d,r!==null?r.memoizedProps:d)),c&1024&&(Ru=!0);break;case 6:if(tn(i,n),nn(n),c&4){if(n.stateNode===null)throw Error(o(162));c=n.memoizedProps,r=n.stateNode;try{r.nodeValue=c}catch(me){Ve(n,n.return,me)}}break;case 3:if(tl=null,d=Nn,Nn=Zr(i.containerInfo),tn(i,n),Nn=d,nn(n),c&4&&r!==null&&r.memoizedState.isDehydrated)try{Ta(i.containerInfo)}catch(me){Ve(n,n.return,me)}Ru&&(Ru=!1,sh(n));break;case 4:c=Nn,Nn=Zr(n.stateNode.containerInfo),tn(i,n),nn(n),Nn=c;break;case 12:tn(i,n),nn(n);break;case 31:tn(i,n),nn(n),c&4&&(c=n.updateQueue,c!==null&&(n.updateQueue=null,Dr(n,c)));break;case 13:tn(i,n),nn(n),n.child.flags&8192&&n.memoizedState!==null!=(r!==null&&r.memoizedState!==null)&&($r=It()),c&4&&(c=n.updateQueue,c!==null&&(n.updateQueue=null,Dr(n,c)));break;case 22:d=n.memoizedState!==null;var L=r!==null&&r.memoizedState!==null,Y=ai,te=xt;if(ai=Y||d,xt=te||L,tn(i,n),xt=te,ai=Y,nn(n),c&8192)e:for(i=n.stateNode,i._visibility=d?i._visibility&-2:i._visibility|1,d&&(r===null||L||ai||xt||Ts(n)),r=null,i=n;;){if(i.tag===5||i.tag===26){if(r===null){L=r=i;try{if(h=L.stateNode,d)A=h.style,typeof A.setProperty=="function"?A.setProperty("display","none","important"):A.display="none";else{C=L.stateNode;var ie=L.memoizedProps.style,K=ie!=null&&ie.hasOwnProperty("display")?ie.display:null;C.style.display=K==null||typeof K=="boolean"?"":(""+K).trim()}}catch(me){Ve(L,L.return,me)}}}else if(i.tag===6){if(r===null){L=i;try{L.stateNode.nodeValue=d?"":L.memoizedProps}catch(me){Ve(L,L.return,me)}}}else if(i.tag===18){if(r===null){L=i;try{var Q=L.stateNode;d?Fh(Q,!0):Fh(L.stateNode,!1)}catch(me){Ve(L,L.return,me)}}}else if((i.tag!==22&&i.tag!==23||i.memoizedState===null||i===n)&&i.child!==null){i.child.return=i,i=i.child;continue}if(i===n)break e;for(;i.sibling===null;){if(i.return===null||i.return===n)break e;r===i&&(r=null),i=i.return}r===i&&(r=null),i.sibling.return=i.return,i=i.sibling}c&4&&(c=n.updateQueue,c!==null&&(r=c.retryQueue,r!==null&&(c.retryQueue=null,Dr(n,r))));break;case 19:tn(i,n),nn(n),c&4&&(c=n.updateQueue,c!==null&&(n.updateQueue=null,Dr(n,c)));break;case 30:break;case 21:break;default:tn(i,n),nn(n)}}function nn(n){var i=n.flags;if(i&2){try{for(var r,c=n.return;c!==null;){if(Xp(c)){r=c;break}c=c.return}if(r==null)throw Error(o(160));switch(r.tag){case 27:var d=r.stateNode,h=ku(n);jr(n,h,d);break;case 5:var A=r.stateNode;r.flags&32&&(Ks(A,""),r.flags&=-33);var C=ku(n);jr(n,C,A);break;case 3:case 4:var L=r.stateNode.containerInfo,Y=ku(n);Nu(n,Y,L);break;default:throw Error(o(161))}}catch(te){Ve(n,n.return,te)}n.flags&=-3}i&4096&&(n.flags&=-4097)}function sh(n){if(n.subtreeFlags&1024)for(n=n.child;n!==null;){var i=n;sh(i),i.tag===5&&i.flags&1024&&i.stateNode.reset(),n=n.sibling}}function ri(n,i){if(i.subtreeFlags&8772)for(i=i.child;i!==null;)Qp(n,i.alternate,i),i=i.sibling}function Ts(n){for(n=n.child;n!==null;){var i=n;switch(i.tag){case 0:case 11:case 14:case 15:Ii(4,i,i.return),Ts(i);break;case 1:qn(i,i.return);var r=i.stateNode;typeof r.componentWillUnmount=="function"&&Fp(i,i.return,r),Ts(i);break;case 27:Eo(i.stateNode);case 26:case 5:qn(i,i.return),Ts(i);break;case 22:i.memoizedState===null&&Ts(i);break;case 30:Ts(i);break;default:Ts(i)}n=n.sibling}}function li(n,i,r){for(r=r&&(i.subtreeFlags&8772)!==0,i=i.child;i!==null;){var c=i.alternate,d=n,h=i,A=h.flags;switch(h.tag){case 0:case 11:case 15:li(d,h,r),po(4,h);break;case 1:if(li(d,h,r),c=h,d=c.stateNode,typeof d.componentDidMount=="function")try{d.componentDidMount()}catch(Y){Ve(c,c.return,Y)}if(c=h,d=c.updateQueue,d!==null){var C=c.stateNode;try{var L=d.shared.hiddenCallbacks;if(L!==null)for(d.shared.hiddenCallbacks=null,d=0;d<L.length;d++)Bm(L[d],C)}catch(Y){Ve(c,c.return,Y)}}r&&A&64&&Kp(h),ho(h,h.return);break;case 27:Gp(h);case 26:case 5:li(d,h,r),r&&c===null&&A&4&&Wp(h),ho(h,h.return);break;case 12:li(d,h,r);break;case 31:li(d,h,r),r&&A&4&&th(d,h);break;case 13:li(d,h,r),r&&A&4&&nh(d,h);break;case 22:h.memoizedState===null&&li(d,h,r),ho(h,h.return);break;case 30:break;default:li(d,h,r)}i=i.sibling}}function Iu(n,i){var r=null;n!==null&&n.memoizedState!==null&&n.memoizedState.cachePool!==null&&(r=n.memoizedState.cachePool.pool),n=null,i.memoizedState!==null&&i.memoizedState.cachePool!==null&&(n=i.memoizedState.cachePool.pool),n!==r&&(n!=null&&n.refCount++,r!=null&&eo(r))}function Lu(n,i){n=null,i.alternate!==null&&(n=i.alternate.memoizedState.cache),i=i.memoizedState.cache,i!==n&&(i.refCount++,n!=null&&eo(n))}function Rn(n,i,r,c){if(i.subtreeFlags&10256)for(i=i.child;i!==null;)ah(n,i,r,c),i=i.sibling}function ah(n,i,r,c){var d=i.flags;switch(i.tag){case 0:case 11:case 15:Rn(n,i,r,c),d&2048&&po(9,i);break;case 1:Rn(n,i,r,c);break;case 3:Rn(n,i,r,c),d&2048&&(n=null,i.alternate!==null&&(n=i.alternate.memoizedState.cache),i=i.memoizedState.cache,i!==n&&(i.refCount++,n!=null&&eo(n)));break;case 12:if(d&2048){Rn(n,i,r,c),n=i.stateNode;try{var h=i.memoizedProps,A=h.id,C=h.onPostCommit;typeof C=="function"&&C(A,i.alternate===null?"mount":"update",n.passiveEffectDuration,-0)}catch(L){Ve(i,i.return,L)}}else Rn(n,i,r,c);break;case 31:Rn(n,i,r,c);break;case 13:Rn(n,i,r,c);break;case 23:break;case 22:h=i.stateNode,A=i.alternate,i.memoizedState!==null?h._visibility&2?Rn(n,i,r,c):yo(n,i):h._visibility&2?Rn(n,i,r,c):(h._visibility|=2,fa(n,i,r,c,(i.subtreeFlags&10256)!==0||!1)),d&2048&&Iu(A,i);break;case 24:Rn(n,i,r,c),d&2048&&Lu(i.alternate,i);break;default:Rn(n,i,r,c)}}function fa(n,i,r,c,d){for(d=d&&((i.subtreeFlags&10256)!==0||!1),i=i.child;i!==null;){var h=n,A=i,C=r,L=c,Y=A.flags;switch(A.tag){case 0:case 11:case 15:fa(h,A,C,L,d),po(8,A);break;case 23:break;case 22:var te=A.stateNode;A.memoizedState!==null?te._visibility&2?fa(h,A,C,L,d):yo(h,A):(te._visibility|=2,fa(h,A,C,L,d)),d&&Y&2048&&Iu(A.alternate,A);break;case 24:fa(h,A,C,L,d),d&&Y&2048&&Lu(A.alternate,A);break;default:fa(h,A,C,L,d)}i=i.sibling}}function yo(n,i){if(i.subtreeFlags&10256)for(i=i.child;i!==null;){var r=n,c=i,d=c.flags;switch(c.tag){case 22:yo(r,c),d&2048&&Iu(c.alternate,c);break;case 24:yo(r,c),d&2048&&Lu(c.alternate,c);break;default:yo(r,c)}i=i.sibling}}var go=8192;function ma(n,i,r){if(n.subtreeFlags&go)for(n=n.child;n!==null;)oh(n,i,r),n=n.sibling}function oh(n,i,r){switch(n.tag){case 26:ma(n,i,r),n.flags&go&&n.memoizedState!==null&&kv(r,Nn,n.memoizedState,n.memoizedProps);break;case 5:ma(n,i,r);break;case 3:case 4:var c=Nn;Nn=Zr(n.stateNode.containerInfo),ma(n,i,r),Nn=c;break;case 22:n.memoizedState===null&&(c=n.alternate,c!==null&&c.memoizedState!==null?(c=go,go=16777216,ma(n,i,r),go=c):ma(n,i,r));break;default:ma(n,i,r)}}function rh(n){var i=n.alternate;if(i!==null&&(n=i.child,n!==null)){i.child=null;do i=n.sibling,n.sibling=null,n=i;while(n!==null)}}function bo(n){var i=n.deletions;if((n.flags&16)!==0){if(i!==null)for(var r=0;r<i.length;r++){var c=i[r];Rt=c,ch(c,n)}rh(n)}if(n.subtreeFlags&10256)for(n=n.child;n!==null;)lh(n),n=n.sibling}function lh(n){switch(n.tag){case 0:case 11:case 15:bo(n),n.flags&2048&&Ii(9,n,n.return);break;case 3:bo(n);break;case 12:bo(n);break;case 22:var i=n.stateNode;n.memoizedState!==null&&i._visibility&2&&(n.return===null||n.return.tag!==13)?(i._visibility&=-3,Ur(n)):bo(n);break;default:bo(n)}}function Ur(n){var i=n.deletions;if((n.flags&16)!==0){if(i!==null)for(var r=0;r<i.length;r++){var c=i[r];Rt=c,ch(c,n)}rh(n)}for(n=n.child;n!==null;){switch(i=n,i.tag){case 0:case 11:case 15:Ii(8,i,i.return),Ur(i);break;case 22:r=i.stateNode,r._visibility&2&&(r._visibility&=-3,Ur(i));break;default:Ur(i)}n=n.sibling}}function ch(n,i){for(;Rt!==null;){var r=Rt;switch(r.tag){case 0:case 11:case 15:Ii(8,r,i);break;case 23:case 22:if(r.memoizedState!==null&&r.memoizedState.cachePool!==null){var c=r.memoizedState.cachePool.pool;c!=null&&c.refCount++}break;case 24:eo(r.memoizedState.cache)}if(c=r.child,c!==null)c.return=r,Rt=c;else e:for(r=n;Rt!==null;){c=Rt;var d=c.sibling,h=c.return;if(Zp(c),c===r){Rt=null;break e}if(d!==null){d.return=h,Rt=d;break e}Rt=h}}}var YS={getCacheForType:function(n){var i=Dt(St),r=i.data.get(n);return r===void 0&&(r=n(),i.data.set(n,r)),r},cacheSignal:function(){return Dt(St).controller.signal}},KS=typeof WeakMap=="function"?WeakMap:Map,De=0,Xe=null,Ne=null,Le=0,ze=0,dn=null,Li=!1,pa=!1,Bu=!1,ci=0,dt=0,Bi=0,Es=0,Pu=0,fn=0,ha=0,So=null,sn=null,Hu=!1,$r=0,uh=0,qr=1/0,zr=null,Pi=null,Ct=0,Hi=null,ya=null,ui=0,ju=0,Du=null,dh=null,vo=0,Uu=null;function mn(){return(De&2)!==0&&Le!==0?Le&-Le:P.T!==null?Ku():Ua()}function fh(){if(fn===0)if((Le&536870912)===0||Pe){var n=rt;rt<<=1,(rt&3932160)===0&&(rt=262144),fn=n}else fn=536870912;return n=cn.current,n!==null&&(n.flags|=32),fn}function an(n,i,r){(n===Xe&&(ze===2||ze===9)||n.cancelPendingCommit!==null)&&(ga(n,0),ji(n,Le,fn,!1)),rs(n,r),((De&2)===0||n!==Xe)&&(n===Xe&&((De&2)===0&&(Es|=r),dt===4&&ji(n,Le,fn,!1)),zn(n))}function mh(n,i,r){if((De&6)!==0)throw Error(o(327));var c=!r&&(i&127)===0&&(i&n.expiredLanes)===0||os(n,i),d=c?XS(n,i):qu(n,i,!0),h=c;do{if(d===0){pa&&!c&&ji(n,i,0,!1);break}else{if(r=n.current.alternate,h&&!FS(r)){d=qu(n,i,!1),h=!1;continue}if(d===2){if(h=i,n.errorRecoveryDisabledLanes&h)var A=0;else A=n.pendingLanes&-536870913,A=A!==0?A:A&536870912?536870912:0;if(A!==0){i=A;e:{var C=n;d=So;var L=C.current.memoizedState.isDehydrated;if(L&&(ga(C,A).flags|=256),A=qu(C,A,!1),A!==2){if(Bu&&!L){C.errorRecoveryDisabledLanes|=h,Es|=h,d=4;break e}h=sn,sn=d,h!==null&&(sn===null?sn=h:sn.push.apply(sn,h))}d=A}if(h=!1,d!==2)continue}}if(d===1){ga(n,0),ji(n,i,0,!0);break}e:{switch(c=n,h=d,h){case 0:case 1:throw Error(o(345));case 4:if((i&4194048)!==i)break;case 6:ji(c,i,fn,!Li);break e;case 2:sn=null;break;case 3:case 5:break;default:throw Error(o(329))}if((i&62914560)===i&&(d=$r+300-It(),10<d)){if(ji(c,i,fn,!Li),Ai(c,0,!0)!==0)break e;ui=i,c.timeoutHandle=Vh(ph.bind(null,c,r,sn,zr,Hu,i,fn,Es,ha,Li,h,"Throttled",-0,0),d);break e}ph(c,r,sn,zr,Hu,i,fn,Es,ha,Li,h,null,-0,0)}}break}while(!0);zn(n)}function ph(n,i,r,c,d,h,A,C,L,Y,te,ie,K,Q){if(n.timeoutHandle=-1,ie=i.subtreeFlags,ie&8192||(ie&16785408)===16785408){ie={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:Xn},oh(i,h,ie);var me=(h&62914560)===h?$r-It():(h&4194048)===h?uh-It():0;if(me=Nv(ie,me),me!==null){ui=h,n.cancelPendingCommit=me(xh.bind(null,n,i,h,r,c,d,A,C,L,te,ie,null,K,Q)),ji(n,h,A,!Y);return}}xh(n,i,h,r,c,d,A,C,L)}function FS(n){for(var i=n;;){var r=i.tag;if((r===0||r===11||r===15)&&i.flags&16384&&(r=i.updateQueue,r!==null&&(r=r.stores,r!==null)))for(var c=0;c<r.length;c++){var d=r[c],h=d.getSnapshot;d=d.value;try{if(!rn(h(),d))return!1}catch{return!1}}if(r=i.child,i.subtreeFlags&16384&&r!==null)r.return=i,i=r;else{if(i===n)break;for(;i.sibling===null;){if(i.return===null||i.return===n)return!0;i=i.return}i.sibling.return=i.return,i=i.sibling}}return!0}function ji(n,i,r,c){i&=~Pu,i&=~Es,n.suspendedLanes|=i,n.pingedLanes&=~i,c&&(n.warmLanes|=i),c=n.expirationTimes;for(var d=i;0<d;){var h=31-pt(d),A=1<<h;c[h]=-1,d&=~A}r!==0&&Pt(n,r,i)}function Vr(){return(De&6)===0?(Ao(0),!1):!0}function $u(){if(Ne!==null){if(ze===0)var n=Ne.return;else n=Ne,Zn=hs=null,iu(n),ra=null,no=0,n=Ne;for(;n!==null;)Yp(n.alternate,n),n=n.return;Ne=null}}function ga(n,i){var r=n.timeoutHandle;r!==-1&&(n.timeoutHandle=-1,mv(r)),r=n.cancelPendingCommit,r!==null&&(n.cancelPendingCommit=null,r()),ui=0,$u(),Xe=n,Ne=r=Jn(n.current,null),Le=i,ze=0,dn=null,Li=!1,pa=os(n,i),Bu=!1,ha=fn=Pu=Es=Bi=dt=0,sn=So=null,Hu=!1,(i&8)!==0&&(i|=i&32);var c=n.entangledLanes;if(c!==0)for(n=n.entanglements,c&=i;0<c;){var d=31-pt(c),h=1<<d;i|=n[d],c&=~h}return ci=i,dr(),r}function hh(n,i){Me=null,P.H=uo,i===oa||i===Sr?(i=Nm(),ze=3):i===Yc?(i=Nm(),ze=4):ze=i===Su?8:i!==null&&typeof i=="object"&&typeof i.then=="function"?6:1,dn=i,Ne===null&&(dt=1,Ir(n,bn(i,n.current)))}function yh(){var n=cn.current;return n===null?!0:(Le&4194048)===Le?xn===null:(Le&62914560)===Le||(Le&536870912)!==0?n===xn:!1}function gh(){var n=P.H;return P.H=uo,n===null?uo:n}function bh(){var n=P.A;return P.A=YS,n}function Yr(){dt=4,Li||(Le&4194048)!==Le&&cn.current!==null||(pa=!0),(Bi&134217727)===0&&(Es&134217727)===0||Xe===null||ji(Xe,Le,fn,!1)}function qu(n,i,r){var c=De;De|=2;var d=gh(),h=bh();(Xe!==n||Le!==i)&&(zr=null,ga(n,i)),i=!1;var A=dt;e:do try{if(ze!==0&&Ne!==null){var C=Ne,L=dn;switch(ze){case 8:$u(),A=6;break e;case 3:case 2:case 9:case 6:cn.current===null&&(i=!0);var Y=ze;if(ze=0,dn=null,ba(n,C,L,Y),r&&pa){A=0;break e}break;default:Y=ze,ze=0,dn=null,ba(n,C,L,Y)}}WS(),A=dt;break}catch(te){hh(n,te)}while(!0);return i&&n.shellSuspendCounter++,Zn=hs=null,De=c,P.H=d,P.A=h,Ne===null&&(Xe=null,Le=0,dr()),A}function WS(){for(;Ne!==null;)Sh(Ne)}function XS(n,i){var r=De;De|=2;var c=gh(),d=bh();Xe!==n||Le!==i?(zr=null,qr=It()+500,ga(n,i)):pa=os(n,i);e:do try{if(ze!==0&&Ne!==null){i=Ne;var h=dn;t:switch(ze){case 1:ze=0,dn=null,ba(n,i,h,1);break;case 2:case 9:if(Om(h)){ze=0,dn=null,vh(i);break}i=function(){ze!==2&&ze!==9||Xe!==n||(ze=7),zn(n)},h.then(i,i);break e;case 3:ze=7;break e;case 4:ze=5;break e;case 7:Om(h)?(ze=0,dn=null,vh(i)):(ze=0,dn=null,ba(n,i,h,7));break;case 5:var A=null;switch(Ne.tag){case 26:A=Ne.memoizedState;case 5:case 27:var C=Ne;if(A?ay(A):C.stateNode.complete){ze=0,dn=null;var L=C.sibling;if(L!==null)Ne=L;else{var Y=C.return;Y!==null?(Ne=Y,Kr(Y)):Ne=null}break t}}ze=0,dn=null,ba(n,i,h,5);break;case 6:ze=0,dn=null,ba(n,i,h,6);break;case 8:$u(),dt=6;break e;default:throw Error(o(462))}}GS();break}catch(te){hh(n,te)}while(!0);return Zn=hs=null,P.H=c,P.A=d,De=r,Ne!==null?0:(Xe=null,Le=0,dr(),dt)}function GS(){for(;Ne!==null&&!Ia();)Sh(Ne)}function Sh(n){var i=zp(n.alternate,n,ci);n.memoizedProps=n.pendingProps,i===null?Kr(n):Ne=i}function vh(n){var i=n,r=i.alternate;switch(i.tag){case 15:case 0:i=Hp(r,i,i.pendingProps,i.type,void 0,Le);break;case 11:i=Hp(r,i,i.pendingProps,i.type.render,i.ref,Le);break;case 5:iu(i);default:Yp(r,i),i=Ne=bm(i,ci),i=zp(r,i,ci)}n.memoizedProps=n.pendingProps,i===null?Kr(n):Ne=i}function ba(n,i,r,c){Zn=hs=null,iu(i),ra=null,no=0;var d=i.return;try{if(jS(n,d,i,r,Le)){dt=1,Ir(n,bn(r,n.current)),Ne=null;return}}catch(h){if(d!==null)throw Ne=d,h;dt=1,Ir(n,bn(r,n.current)),Ne=null;return}i.flags&32768?(Pe||c===1?n=!0:pa||(Le&536870912)!==0?n=!1:(Li=n=!0,(c===2||c===9||c===3||c===6)&&(c=cn.current,c!==null&&c.tag===13&&(c.flags|=16384))),Ah(i,n)):Kr(i)}function Kr(n){var i=n;do{if((i.flags&32768)!==0){Ah(i,Li);return}n=i.return;var r=$S(i.alternate,i,ci);if(r!==null){Ne=r;return}if(i=i.sibling,i!==null){Ne=i;return}Ne=i=n}while(i!==null);dt===0&&(dt=5)}function Ah(n,i){do{var r=qS(n.alternate,n);if(r!==null){r.flags&=32767,Ne=r;return}if(r=n.return,r!==null&&(r.flags|=32768,r.subtreeFlags=0,r.deletions=null),!i&&(n=n.sibling,n!==null)){Ne=n;return}Ne=n=r}while(n!==null);dt=6,Ne=null}function xh(n,i,r,c,d,h,A,C,L){n.cancelPendingCommit=null;do Fr();while(Ct!==0);if((De&6)!==0)throw Error(o(327));if(i!==null){if(i===n.current)throw Error(o(177));if(h=i.lanes|i.childLanes,h|=kc,Jt(n,r,h,A,C,L),n===Xe&&(Ne=Xe=null,Le=0),ya=i,Hi=n,ui=r,ju=h,Du=d,dh=c,(i.subtreeFlags&10256)!==0||(i.flags&10256)!==0?(n.callbackNode=null,n.callbackPriority=0,ev(Kn,function(){return wh(),null})):(n.callbackNode=null,n.callbackPriority=0),c=(i.flags&13878)!==0,(i.subtreeFlags&13878)!==0||c){c=P.T,P.T=null,d=z.p,z.p=2,A=De,De|=4;try{zS(n,i,r)}finally{De=A,z.p=d,P.T=c}}Ct=1,Th(),Eh(),_h()}}function Th(){if(Ct===1){Ct=0;var n=Hi,i=ya,r=(i.flags&13878)!==0;if((i.subtreeFlags&13878)!==0||r){r=P.T,P.T=null;var c=z.p;z.p=2;var d=De;De|=4;try{ih(i,n);var h=ed,A=cm(n.containerInfo),C=h.focusedElem,L=h.selectionRange;if(A!==C&&C&&C.ownerDocument&&lm(C.ownerDocument.documentElement,C)){if(L!==null&&_c(C)){var Y=L.start,te=L.end;if(te===void 0&&(te=Y),"selectionStart"in C)C.selectionStart=Y,C.selectionEnd=Math.min(te,C.value.length);else{var ie=C.ownerDocument||document,K=ie&&ie.defaultView||window;if(K.getSelection){var Q=K.getSelection(),me=C.textContent.length,ve=Math.min(L.start,me),We=L.end===void 0?ve:Math.min(L.end,me);!Q.extend&&ve>We&&(A=We,We=ve,ve=A);var $=rm(C,ve),H=rm(C,We);if($&&H&&(Q.rangeCount!==1||Q.anchorNode!==$.node||Q.anchorOffset!==$.offset||Q.focusNode!==H.node||Q.focusOffset!==H.offset)){var V=ie.createRange();V.setStart($.node,$.offset),Q.removeAllRanges(),ve>We?(Q.addRange(V),Q.extend(H.node,H.offset)):(V.setEnd(H.node,H.offset),Q.addRange(V))}}}}for(ie=[],Q=C;Q=Q.parentNode;)Q.nodeType===1&&ie.push({element:Q,left:Q.scrollLeft,top:Q.scrollTop});for(typeof C.focus=="function"&&C.focus(),C=0;C<ie.length;C++){var ne=ie[C];ne.element.scrollLeft=ne.left,ne.element.scrollTop=ne.top}}al=!!Zu,ed=Zu=null}finally{De=d,z.p=c,P.T=r}}n.current=i,Ct=2}}function Eh(){if(Ct===2){Ct=0;var n=Hi,i=ya,r=(i.flags&8772)!==0;if((i.subtreeFlags&8772)!==0||r){r=P.T,P.T=null;var c=z.p;z.p=2;var d=De;De|=4;try{Qp(n,i.alternate,i)}finally{De=d,z.p=c,P.T=r}}Ct=3}}function _h(){if(Ct===4||Ct===3){Ct=0,Ls();var n=Hi,i=ya,r=ui,c=dh;(i.subtreeFlags&10256)!==0||(i.flags&10256)!==0?Ct=5:(Ct=0,ya=Hi=null,Mh(n,n.pendingLanes));var d=n.pendingLanes;if(d===0&&(Pi=null),Ds(r),i=i.stateNode,Lt&&typeof Lt.onCommitFiberRoot=="function")try{Lt.onCommitFiberRoot(Fn,i,void 0,(i.current.flags&128)===128)}catch{}if(c!==null){i=P.T,d=z.p,z.p=2,P.T=null;try{for(var h=n.onRecoverableError,A=0;A<c.length;A++){var C=c[A];h(C.value,{componentStack:C.stack})}}finally{P.T=i,z.p=d}}(ui&3)!==0&&Fr(),zn(n),d=n.pendingLanes,(r&261930)!==0&&(d&42)!==0?n===Uu?vo++:(vo=0,Uu=n):vo=0,Ao(0)}}function Mh(n,i){(n.pooledCacheLanes&=i)===0&&(i=n.pooledCache,i!=null&&(n.pooledCache=null,eo(i)))}function Fr(){return Th(),Eh(),_h(),wh()}function wh(){if(Ct!==5)return!1;var n=Hi,i=ju;ju=0;var r=Ds(ui),c=P.T,d=z.p;try{z.p=32>r?32:r,P.T=null,r=Du,Du=null;var h=Hi,A=ui;if(Ct=0,ya=Hi=null,ui=0,(De&6)!==0)throw Error(o(331));var C=De;if(De|=4,lh(h.current),ah(h,h.current,A,r),De=C,Ao(0,!1),Lt&&typeof Lt.onPostCommitFiberRoot=="function")try{Lt.onPostCommitFiberRoot(Fn,h)}catch{}return!0}finally{z.p=d,P.T=c,Mh(n,i)}}function Ch(n,i,r){i=bn(r,i),i=bu(n.stateNode,i,2),n=ki(n,i,2),n!==null&&(rs(n,2),zn(n))}function Ve(n,i,r){if(n.tag===3)Ch(n,n,r);else for(;i!==null;){if(i.tag===3){Ch(i,n,r);break}else if(i.tag===1){var c=i.stateNode;if(typeof i.type.getDerivedStateFromError=="function"||typeof c.componentDidCatch=="function"&&(Pi===null||!Pi.has(c))){n=bn(r,n),r=Op(2),c=ki(i,r,2),c!==null&&(kp(r,c,i,n),rs(c,2),zn(c));break}}i=i.return}}function zu(n,i,r){var c=n.pingCache;if(c===null){c=n.pingCache=new KS;var d=new Set;c.set(i,d)}else d=c.get(i),d===void 0&&(d=new Set,c.set(i,d));d.has(r)||(Bu=!0,d.add(r),n=JS.bind(null,n,i,r),i.then(n,n))}function JS(n,i,r){var c=n.pingCache;c!==null&&c.delete(i),n.pingedLanes|=n.suspendedLanes&r,n.warmLanes&=~r,Xe===n&&(Le&r)===r&&(dt===4||dt===3&&(Le&62914560)===Le&&300>It()-$r?(De&2)===0&&ga(n,0):Pu|=r,ha===Le&&(ha=0)),zn(n)}function Oh(n,i){i===0&&(i=ja()),n=fs(n,i),n!==null&&(rs(n,i),zn(n))}function QS(n){var i=n.memoizedState,r=0;i!==null&&(r=i.retryLane),Oh(n,r)}function ZS(n,i){var r=0;switch(n.tag){case 31:case 13:var c=n.stateNode,d=n.memoizedState;d!==null&&(r=d.retryLane);break;case 19:c=n.stateNode;break;case 22:c=n.stateNode._retryCache;break;default:throw Error(o(314))}c!==null&&c.delete(i),Oh(n,r)}function ev(n,i){return Dn(n,i)}var Wr=null,Sa=null,Vu=!1,Xr=!1,Yu=!1,Di=0;function zn(n){n!==Sa&&n.next===null&&(Sa===null?Wr=Sa=n:Sa=Sa.next=n),Xr=!0,Vu||(Vu=!0,nv())}function Ao(n,i){if(!Yu&&Xr){Yu=!0;do for(var r=!1,c=Wr;c!==null;){if(n!==0){var d=c.pendingLanes;if(d===0)var h=0;else{var A=c.suspendedLanes,C=c.pingedLanes;h=(1<<31-pt(42|n)+1)-1,h&=d&~(A&~C),h=h&201326741?h&201326741|1:h?h|2:0}h!==0&&(r=!0,Ih(c,h))}else h=Le,h=Ai(c,c===Xe?h:0,c.cancelPendingCommit!==null||c.timeoutHandle!==-1),(h&3)===0||os(c,h)||(r=!0,Ih(c,h));c=c.next}while(r);Yu=!1}}function tv(){kh()}function kh(){Xr=Vu=!1;var n=0;Di!==0&&fv()&&(n=Di);for(var i=It(),r=null,c=Wr;c!==null;){var d=c.next,h=Nh(c,i);h===0?(c.next=null,r===null?Wr=d:r.next=d,d===null&&(Sa=r)):(r=c,(n!==0||(h&3)!==0)&&(Xr=!0)),c=d}Ct!==0&&Ct!==5||Ao(n),Di!==0&&(Di=0)}function Nh(n,i){for(var r=n.suspendedLanes,c=n.pingedLanes,d=n.expirationTimes,h=n.pendingLanes&-62914561;0<h;){var A=31-pt(h),C=1<<A,L=d[A];L===-1?((C&r)===0||(C&c)!==0)&&(d[A]=oc(C,i)):L<=i&&(n.expiredLanes|=C),h&=~C}if(i=Xe,r=Le,r=Ai(n,n===i?r:0,n.cancelPendingCommit!==null||n.timeoutHandle!==-1),c=n.callbackNode,r===0||n===i&&(ze===2||ze===9)||n.cancelPendingCommit!==null)return c!==null&&c!==null&&is(c),n.callbackNode=null,n.callbackPriority=0;if((r&3)===0||os(n,r)){if(i=r&-r,i===n.callbackPriority)return i;switch(c!==null&&is(c),Ds(r)){case 2:case 8:r=Ps;break;case 32:r=Kn;break;case 268435456:r=as;break;default:r=Kn}return c=Rh.bind(null,n),r=Dn(r,c),n.callbackPriority=i,n.callbackNode=r,i}return c!==null&&c!==null&&is(c),n.callbackPriority=2,n.callbackNode=null,2}function Rh(n,i){if(Ct!==0&&Ct!==5)return n.callbackNode=null,n.callbackPriority=0,null;var r=n.callbackNode;if(Fr()&&n.callbackNode!==r)return null;var c=Le;return c=Ai(n,n===Xe?c:0,n.cancelPendingCommit!==null||n.timeoutHandle!==-1),c===0?null:(mh(n,c,i),Nh(n,It()),n.callbackNode!=null&&n.callbackNode===r?Rh.bind(null,n):null)}function Ih(n,i){if(Fr())return null;mh(n,i,!0)}function nv(){pv(function(){(De&6)!==0?Dn(Bs,tv):kh()})}function Ku(){if(Di===0){var n=sa;n===0&&(n=Bt,Bt<<=1,(Bt&261888)===0&&(Bt=256)),Di=n}return Di}function Lh(n){return n==null||typeof n=="symbol"||typeof n=="boolean"?null:typeof n=="function"?n:ir(""+n)}function Bh(n,i){var r=i.ownerDocument.createElement("input");return r.name=i.name,r.value=i.value,n.id&&r.setAttribute("form",n.id),i.parentNode.insertBefore(r,i),n=new FormData(n),r.parentNode.removeChild(r),n}function iv(n,i,r,c,d){if(i==="submit"&&r&&r.stateNode===d){var h=Lh((d[Qt]||null).action),A=c.submitter;A&&(i=(i=A[Qt]||null)?Lh(i.formAction):A.getAttribute("formAction"),i!==null&&(h=i,A=null));var C=new rr("action","action",null,c,d);n.push({event:C,listeners:[{instance:null,listener:function(){if(c.defaultPrevented){if(Di!==0){var L=A?Bh(d,A):new FormData(d);fu(r,{pending:!0,data:L,method:d.method,action:h},null,L)}}else typeof h=="function"&&(C.preventDefault(),L=A?Bh(d,A):new FormData(d),fu(r,{pending:!0,data:L,method:d.method,action:h},h,L))},currentTarget:d}]})}}for(var Fu=0;Fu<Oc.length;Fu++){var Wu=Oc[Fu],sv=Wu.toLowerCase(),av=Wu[0].toUpperCase()+Wu.slice(1);kn(sv,"on"+av)}kn(fm,"onAnimationEnd"),kn(mm,"onAnimationIteration"),kn(pm,"onAnimationStart"),kn("dblclick","onDoubleClick"),kn("focusin","onFocus"),kn("focusout","onBlur"),kn(AS,"onTransitionRun"),kn(xS,"onTransitionStart"),kn(TS,"onTransitionCancel"),kn(hm,"onTransitionEnd"),Vs("onMouseEnter",["mouseout","mouseover"]),Vs("onMouseLeave",["mouseout","mouseover"]),Vs("onPointerEnter",["pointerout","pointerover"]),Vs("onPointerLeave",["pointerout","pointerover"]),ls("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),ls("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),ls("onBeforeInput",["compositionend","keypress","textInput","paste"]),ls("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),ls("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),ls("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var xo="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),ov=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(xo));function Ph(n,i){i=(i&4)!==0;for(var r=0;r<n.length;r++){var c=n[r],d=c.event;c=c.listeners;e:{var h=void 0;if(i)for(var A=c.length-1;0<=A;A--){var C=c[A],L=C.instance,Y=C.currentTarget;if(C=C.listener,L!==h&&d.isPropagationStopped())break e;h=C,d.currentTarget=Y;try{h(d)}catch(te){ur(te)}d.currentTarget=null,h=L}else for(A=0;A<c.length;A++){if(C=c[A],L=C.instance,Y=C.currentTarget,C=C.listener,L!==h&&d.isPropagationStopped())break e;h=C,d.currentTarget=Y;try{h(d)}catch(te){ur(te)}d.currentTarget=null,h=L}}}}function Re(n,i){var r=i[rc];r===void 0&&(r=i[rc]=new Set);var c=n+"__bubble";r.has(c)||(Hh(i,n,2,!1),r.add(c))}function Xu(n,i,r){var c=0;i&&(c|=4),Hh(r,n,c,i)}var Gr="_reactListening"+Math.random().toString(36).slice(2);function Gu(n){if(!n[Gr]){n[Gr]=!0,kf.forEach(function(r){r!=="selectionchange"&&(ov.has(r)||Xu(r,!1,n),Xu(r,!0,n))});var i=n.nodeType===9?n:n.ownerDocument;i===null||i[Gr]||(i[Gr]=!0,Xu("selectionchange",!1,i))}}function Hh(n,i,r,c){switch(fy(i)){case 2:var d=Lv;break;case 8:d=Bv;break;default:d=dd}r=d.bind(null,i,r,n),d=void 0,!yc||i!=="touchstart"&&i!=="touchmove"&&i!=="wheel"||(d=!0),c?d!==void 0?n.addEventListener(i,r,{capture:!0,passive:d}):n.addEventListener(i,r,!0):d!==void 0?n.addEventListener(i,r,{passive:d}):n.addEventListener(i,r,!1)}function Ju(n,i,r,c,d){var h=c;if((i&1)===0&&(i&2)===0&&c!==null)e:for(;;){if(c===null)return;var A=c.tag;if(A===3||A===4){var C=c.stateNode.containerInfo;if(C===d)break;if(A===4)for(A=c.return;A!==null;){var L=A.tag;if((L===3||L===4)&&A.stateNode.containerInfo===d)return;A=A.return}for(;C!==null;){if(A=$s(C),A===null)return;if(L=A.tag,L===5||L===6||L===26||L===27){c=h=A;continue e}C=C.parentNode}}c=c.return}qf(function(){var Y=h,te=pc(r),ie=[];e:{var K=ym.get(n);if(K!==void 0){var Q=rr,me=n;switch(n){case"keypress":if(ar(r)===0)break e;case"keydown":case"keyup":Q=Zb;break;case"focusin":me="focus",Q=vc;break;case"focusout":me="blur",Q=vc;break;case"beforeblur":case"afterblur":Q=vc;break;case"click":if(r.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":Q=Yf;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":Q=$b;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":Q=nS;break;case fm:case mm:case pm:Q=Vb;break;case hm:Q=sS;break;case"scroll":case"scrollend":Q=Db;break;case"wheel":Q=oS;break;case"copy":case"cut":case"paste":Q=Kb;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":Q=Ff;break;case"toggle":case"beforetoggle":Q=lS}var ve=(i&4)!==0,We=!ve&&(n==="scroll"||n==="scrollend"),$=ve?K!==null?K+"Capture":null:K;ve=[];for(var H=Y,V;H!==null;){var ne=H;if(V=ne.stateNode,ne=ne.tag,ne!==5&&ne!==26&&ne!==27||V===null||$===null||(ne=za(H,$),ne!=null&&ve.push(To(H,ne,V))),We)break;H=H.return}0<ve.length&&(K=new Q(K,me,null,r,te),ie.push({event:K,listeners:ve}))}}if((i&7)===0){e:{if(K=n==="mouseover"||n==="pointerover",Q=n==="mouseout"||n==="pointerout",K&&r!==mc&&(me=r.relatedTarget||r.fromElement)&&($s(me)||me[Us]))break e;if((Q||K)&&(K=te.window===te?te:(K=te.ownerDocument)?K.defaultView||K.parentWindow:window,Q?(me=r.relatedTarget||r.toElement,Q=Y,me=me?$s(me):null,me!==null&&(We=l(me),ve=me.tag,me!==We||ve!==5&&ve!==27&&ve!==6)&&(me=null)):(Q=null,me=Y),Q!==me)){if(ve=Yf,ne="onMouseLeave",$="onMouseEnter",H="mouse",(n==="pointerout"||n==="pointerover")&&(ve=Ff,ne="onPointerLeave",$="onPointerEnter",H="pointer"),We=Q==null?K:qa(Q),V=me==null?K:qa(me),K=new ve(ne,H+"leave",Q,r,te),K.target=We,K.relatedTarget=V,ne=null,$s(te)===Y&&(ve=new ve($,H+"enter",me,r,te),ve.target=V,ve.relatedTarget=We,ne=ve),We=ne,Q&&me)t:{for(ve=rv,$=Q,H=me,V=0,ne=$;ne;ne=ve(ne))V++;ne=0;for(var Se=H;Se;Se=ve(Se))ne++;for(;0<V-ne;)$=ve($),V--;for(;0<ne-V;)H=ve(H),ne--;for(;V--;){if($===H||H!==null&&$===H.alternate){ve=$;break t}$=ve($),H=ve(H)}ve=null}else ve=null;Q!==null&&jh(ie,K,Q,ve,!1),me!==null&&We!==null&&jh(ie,We,me,ve,!0)}}e:{if(K=Y?qa(Y):window,Q=K.nodeName&&K.nodeName.toLowerCase(),Q==="select"||Q==="input"&&K.type==="file")var He=tm;else if(Zf(K))if(nm)He=bS;else{He=yS;var ge=hS}else Q=K.nodeName,!Q||Q.toLowerCase()!=="input"||K.type!=="checkbox"&&K.type!=="radio"?Y&&fc(Y.elementType)&&(He=tm):He=gS;if(He&&(He=He(n,Y))){em(ie,He,r,te);break e}ge&&ge(n,K,Y),n==="focusout"&&Y&&K.type==="number"&&Y.memoizedProps.value!=null&&dc(K,"number",K.value)}switch(ge=Y?qa(Y):window,n){case"focusin":(Zf(ge)||ge.contentEditable==="true")&&(Gs=ge,Mc=Y,Ja=null);break;case"focusout":Ja=Mc=Gs=null;break;case"mousedown":wc=!0;break;case"contextmenu":case"mouseup":case"dragend":wc=!1,um(ie,r,te);break;case"selectionchange":if(vS)break;case"keydown":case"keyup":um(ie,r,te)}var Ce;if(xc)e:{switch(n){case"compositionstart":var Be="onCompositionStart";break e;case"compositionend":Be="onCompositionEnd";break e;case"compositionupdate":Be="onCompositionUpdate";break e}Be=void 0}else Xs?Jf(n,r)&&(Be="onCompositionEnd"):n==="keydown"&&r.keyCode===229&&(Be="onCompositionStart");Be&&(Wf&&r.locale!=="ko"&&(Xs||Be!=="onCompositionStart"?Be==="onCompositionEnd"&&Xs&&(Ce=zf()):(Ti=te,gc="value"in Ti?Ti.value:Ti.textContent,Xs=!0)),ge=Jr(Y,Be),0<ge.length&&(Be=new Kf(Be,n,null,r,te),ie.push({event:Be,listeners:ge}),Ce?Be.data=Ce:(Ce=Qf(r),Ce!==null&&(Be.data=Ce)))),(Ce=uS?dS(n,r):fS(n,r))&&(Be=Jr(Y,"onBeforeInput"),0<Be.length&&(ge=new Kf("onBeforeInput","beforeinput",null,r,te),ie.push({event:ge,listeners:Be}),ge.data=Ce)),iv(ie,n,Y,r,te)}Ph(ie,i)})}function To(n,i,r){return{instance:n,listener:i,currentTarget:r}}function Jr(n,i){for(var r=i+"Capture",c=[];n!==null;){var d=n,h=d.stateNode;if(d=d.tag,d!==5&&d!==26&&d!==27||h===null||(d=za(n,r),d!=null&&c.unshift(To(n,d,h)),d=za(n,i),d!=null&&c.push(To(n,d,h))),n.tag===3)return c;n=n.return}return[]}function rv(n){if(n===null)return null;do n=n.return;while(n&&n.tag!==5&&n.tag!==27);return n||null}function jh(n,i,r,c,d){for(var h=i._reactName,A=[];r!==null&&r!==c;){var C=r,L=C.alternate,Y=C.stateNode;if(C=C.tag,L!==null&&L===c)break;C!==5&&C!==26&&C!==27||Y===null||(L=Y,d?(Y=za(r,h),Y!=null&&A.unshift(To(r,Y,L))):d||(Y=za(r,h),Y!=null&&A.push(To(r,Y,L)))),r=r.return}A.length!==0&&n.push({event:i,listeners:A})}var lv=/\r\n?/g,cv=/\u0000|\uFFFD/g;function Dh(n){return(typeof n=="string"?n:""+n).replace(lv,`
`).replace(cv,"")}function Uh(n,i){return i=Dh(i),Dh(n)===i}function Fe(n,i,r,c,d,h){switch(r){case"children":typeof c=="string"?i==="body"||i==="textarea"&&c===""||Ks(n,c):(typeof c=="number"||typeof c=="bigint")&&i!=="body"&&Ks(n,""+c);break;case"className":tr(n,"class",c);break;case"tabIndex":tr(n,"tabindex",c);break;case"dir":case"role":case"viewBox":case"width":case"height":tr(n,r,c);break;case"style":Uf(n,c,h);break;case"data":if(i!=="object"){tr(n,"data",c);break}case"src":case"href":if(c===""&&(i!=="a"||r!=="href")){n.removeAttribute(r);break}if(c==null||typeof c=="function"||typeof c=="symbol"||typeof c=="boolean"){n.removeAttribute(r);break}c=ir(""+c),n.setAttribute(r,c);break;case"action":case"formAction":if(typeof c=="function"){n.setAttribute(r,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof h=="function"&&(r==="formAction"?(i!=="input"&&Fe(n,i,"name",d.name,d,null),Fe(n,i,"formEncType",d.formEncType,d,null),Fe(n,i,"formMethod",d.formMethod,d,null),Fe(n,i,"formTarget",d.formTarget,d,null)):(Fe(n,i,"encType",d.encType,d,null),Fe(n,i,"method",d.method,d,null),Fe(n,i,"target",d.target,d,null)));if(c==null||typeof c=="symbol"||typeof c=="boolean"){n.removeAttribute(r);break}c=ir(""+c),n.setAttribute(r,c);break;case"onClick":c!=null&&(n.onclick=Xn);break;case"onScroll":c!=null&&Re("scroll",n);break;case"onScrollEnd":c!=null&&Re("scrollend",n);break;case"dangerouslySetInnerHTML":if(c!=null){if(typeof c!="object"||!("__html"in c))throw Error(o(61));if(r=c.__html,r!=null){if(d.children!=null)throw Error(o(60));n.innerHTML=r}}break;case"multiple":n.multiple=c&&typeof c!="function"&&typeof c!="symbol";break;case"muted":n.muted=c&&typeof c!="function"&&typeof c!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(c==null||typeof c=="function"||typeof c=="boolean"||typeof c=="symbol"){n.removeAttribute("xlink:href");break}r=ir(""+c),n.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",r);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":c!=null&&typeof c!="function"&&typeof c!="symbol"?n.setAttribute(r,""+c):n.removeAttribute(r);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":c&&typeof c!="function"&&typeof c!="symbol"?n.setAttribute(r,""):n.removeAttribute(r);break;case"capture":case"download":c===!0?n.setAttribute(r,""):c!==!1&&c!=null&&typeof c!="function"&&typeof c!="symbol"?n.setAttribute(r,c):n.removeAttribute(r);break;case"cols":case"rows":case"size":case"span":c!=null&&typeof c!="function"&&typeof c!="symbol"&&!isNaN(c)&&1<=c?n.setAttribute(r,c):n.removeAttribute(r);break;case"rowSpan":case"start":c==null||typeof c=="function"||typeof c=="symbol"||isNaN(c)?n.removeAttribute(r):n.setAttribute(r,c);break;case"popover":Re("beforetoggle",n),Re("toggle",n),er(n,"popover",c);break;case"xlinkActuate":Wn(n,"http://www.w3.org/1999/xlink","xlink:actuate",c);break;case"xlinkArcrole":Wn(n,"http://www.w3.org/1999/xlink","xlink:arcrole",c);break;case"xlinkRole":Wn(n,"http://www.w3.org/1999/xlink","xlink:role",c);break;case"xlinkShow":Wn(n,"http://www.w3.org/1999/xlink","xlink:show",c);break;case"xlinkTitle":Wn(n,"http://www.w3.org/1999/xlink","xlink:title",c);break;case"xlinkType":Wn(n,"http://www.w3.org/1999/xlink","xlink:type",c);break;case"xmlBase":Wn(n,"http://www.w3.org/XML/1998/namespace","xml:base",c);break;case"xmlLang":Wn(n,"http://www.w3.org/XML/1998/namespace","xml:lang",c);break;case"xmlSpace":Wn(n,"http://www.w3.org/XML/1998/namespace","xml:space",c);break;case"is":er(n,"is",c);break;case"innerText":case"textContent":break;default:(!(2<r.length)||r[0]!=="o"&&r[0]!=="O"||r[1]!=="n"&&r[1]!=="N")&&(r=Hb.get(r)||r,er(n,r,c))}}function Qu(n,i,r,c,d,h){switch(r){case"style":Uf(n,c,h);break;case"dangerouslySetInnerHTML":if(c!=null){if(typeof c!="object"||!("__html"in c))throw Error(o(61));if(r=c.__html,r!=null){if(d.children!=null)throw Error(o(60));n.innerHTML=r}}break;case"children":typeof c=="string"?Ks(n,c):(typeof c=="number"||typeof c=="bigint")&&Ks(n,""+c);break;case"onScroll":c!=null&&Re("scroll",n);break;case"onScrollEnd":c!=null&&Re("scrollend",n);break;case"onClick":c!=null&&(n.onclick=Xn);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!Nf.hasOwnProperty(r))e:{if(r[0]==="o"&&r[1]==="n"&&(d=r.endsWith("Capture"),i=r.slice(2,d?r.length-7:void 0),h=n[Qt]||null,h=h!=null?h[r]:null,typeof h=="function"&&n.removeEventListener(i,h,d),typeof c=="function")){typeof h!="function"&&h!==null&&(r in n?n[r]=null:n.hasAttribute(r)&&n.removeAttribute(r)),n.addEventListener(i,c,d);break e}r in n?n[r]=c:c===!0?n.setAttribute(r,""):er(n,r,c)}}}function $t(n,i,r){switch(i){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":Re("error",n),Re("load",n);var c=!1,d=!1,h;for(h in r)if(r.hasOwnProperty(h)){var A=r[h];if(A!=null)switch(h){case"src":c=!0;break;case"srcSet":d=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(o(137,i));default:Fe(n,i,h,A,r,null)}}d&&Fe(n,i,"srcSet",r.srcSet,r,null),c&&Fe(n,i,"src",r.src,r,null);return;case"input":Re("invalid",n);var C=h=A=d=null,L=null,Y=null;for(c in r)if(r.hasOwnProperty(c)){var te=r[c];if(te!=null)switch(c){case"name":d=te;break;case"type":A=te;break;case"checked":L=te;break;case"defaultChecked":Y=te;break;case"value":h=te;break;case"defaultValue":C=te;break;case"children":case"dangerouslySetInnerHTML":if(te!=null)throw Error(o(137,i));break;default:Fe(n,i,c,te,r,null)}}Pf(n,h,C,L,Y,A,d,!1);return;case"select":Re("invalid",n),c=A=h=null;for(d in r)if(r.hasOwnProperty(d)&&(C=r[d],C!=null))switch(d){case"value":h=C;break;case"defaultValue":A=C;break;case"multiple":c=C;default:Fe(n,i,d,C,r,null)}i=h,r=A,n.multiple=!!c,i!=null?Ys(n,!!c,i,!1):r!=null&&Ys(n,!!c,r,!0);return;case"textarea":Re("invalid",n),h=d=c=null;for(A in r)if(r.hasOwnProperty(A)&&(C=r[A],C!=null))switch(A){case"value":c=C;break;case"defaultValue":d=C;break;case"children":h=C;break;case"dangerouslySetInnerHTML":if(C!=null)throw Error(o(91));break;default:Fe(n,i,A,C,r,null)}jf(n,c,d,h);return;case"option":for(L in r)r.hasOwnProperty(L)&&(c=r[L],c!=null)&&(L==="selected"?n.selected=c&&typeof c!="function"&&typeof c!="symbol":Fe(n,i,L,c,r,null));return;case"dialog":Re("beforetoggle",n),Re("toggle",n),Re("cancel",n),Re("close",n);break;case"iframe":case"object":Re("load",n);break;case"video":case"audio":for(c=0;c<xo.length;c++)Re(xo[c],n);break;case"image":Re("error",n),Re("load",n);break;case"details":Re("toggle",n);break;case"embed":case"source":case"link":Re("error",n),Re("load",n);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(Y in r)if(r.hasOwnProperty(Y)&&(c=r[Y],c!=null))switch(Y){case"children":case"dangerouslySetInnerHTML":throw Error(o(137,i));default:Fe(n,i,Y,c,r,null)}return;default:if(fc(i)){for(te in r)r.hasOwnProperty(te)&&(c=r[te],c!==void 0&&Qu(n,i,te,c,r,void 0));return}}for(C in r)r.hasOwnProperty(C)&&(c=r[C],c!=null&&Fe(n,i,C,c,r,null))}function uv(n,i,r,c){switch(i){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var d=null,h=null,A=null,C=null,L=null,Y=null,te=null;for(Q in r){var ie=r[Q];if(r.hasOwnProperty(Q)&&ie!=null)switch(Q){case"checked":break;case"value":break;case"defaultValue":L=ie;default:c.hasOwnProperty(Q)||Fe(n,i,Q,null,c,ie)}}for(var K in c){var Q=c[K];if(ie=r[K],c.hasOwnProperty(K)&&(Q!=null||ie!=null))switch(K){case"type":h=Q;break;case"name":d=Q;break;case"checked":Y=Q;break;case"defaultChecked":te=Q;break;case"value":A=Q;break;case"defaultValue":C=Q;break;case"children":case"dangerouslySetInnerHTML":if(Q!=null)throw Error(o(137,i));break;default:Q!==ie&&Fe(n,i,K,Q,c,ie)}}uc(n,A,C,L,Y,te,h,d);return;case"select":Q=A=C=K=null;for(h in r)if(L=r[h],r.hasOwnProperty(h)&&L!=null)switch(h){case"value":break;case"multiple":Q=L;default:c.hasOwnProperty(h)||Fe(n,i,h,null,c,L)}for(d in c)if(h=c[d],L=r[d],c.hasOwnProperty(d)&&(h!=null||L!=null))switch(d){case"value":K=h;break;case"defaultValue":C=h;break;case"multiple":A=h;default:h!==L&&Fe(n,i,d,h,c,L)}i=C,r=A,c=Q,K!=null?Ys(n,!!r,K,!1):!!c!=!!r&&(i!=null?Ys(n,!!r,i,!0):Ys(n,!!r,r?[]:"",!1));return;case"textarea":Q=K=null;for(C in r)if(d=r[C],r.hasOwnProperty(C)&&d!=null&&!c.hasOwnProperty(C))switch(C){case"value":break;case"children":break;default:Fe(n,i,C,null,c,d)}for(A in c)if(d=c[A],h=r[A],c.hasOwnProperty(A)&&(d!=null||h!=null))switch(A){case"value":K=d;break;case"defaultValue":Q=d;break;case"children":break;case"dangerouslySetInnerHTML":if(d!=null)throw Error(o(91));break;default:d!==h&&Fe(n,i,A,d,c,h)}Hf(n,K,Q);return;case"option":for(var me in r)K=r[me],r.hasOwnProperty(me)&&K!=null&&!c.hasOwnProperty(me)&&(me==="selected"?n.selected=!1:Fe(n,i,me,null,c,K));for(L in c)K=c[L],Q=r[L],c.hasOwnProperty(L)&&K!==Q&&(K!=null||Q!=null)&&(L==="selected"?n.selected=K&&typeof K!="function"&&typeof K!="symbol":Fe(n,i,L,K,c,Q));return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var ve in r)K=r[ve],r.hasOwnProperty(ve)&&K!=null&&!c.hasOwnProperty(ve)&&Fe(n,i,ve,null,c,K);for(Y in c)if(K=c[Y],Q=r[Y],c.hasOwnProperty(Y)&&K!==Q&&(K!=null||Q!=null))switch(Y){case"children":case"dangerouslySetInnerHTML":if(K!=null)throw Error(o(137,i));break;default:Fe(n,i,Y,K,c,Q)}return;default:if(fc(i)){for(var We in r)K=r[We],r.hasOwnProperty(We)&&K!==void 0&&!c.hasOwnProperty(We)&&Qu(n,i,We,void 0,c,K);for(te in c)K=c[te],Q=r[te],!c.hasOwnProperty(te)||K===Q||K===void 0&&Q===void 0||Qu(n,i,te,K,c,Q);return}}for(var $ in r)K=r[$],r.hasOwnProperty($)&&K!=null&&!c.hasOwnProperty($)&&Fe(n,i,$,null,c,K);for(ie in c)K=c[ie],Q=r[ie],!c.hasOwnProperty(ie)||K===Q||K==null&&Q==null||Fe(n,i,ie,K,c,Q)}function $h(n){switch(n){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}function dv(){if(typeof performance.getEntriesByType=="function"){for(var n=0,i=0,r=performance.getEntriesByType("resource"),c=0;c<r.length;c++){var d=r[c],h=d.transferSize,A=d.initiatorType,C=d.duration;if(h&&C&&$h(A)){for(A=0,C=d.responseEnd,c+=1;c<r.length;c++){var L=r[c],Y=L.startTime;if(Y>C)break;var te=L.transferSize,ie=L.initiatorType;te&&$h(ie)&&(L=L.responseEnd,A+=te*(L<C?1:(C-Y)/(L-Y)))}if(--c,i+=8*(h+A)/(d.duration/1e3),n++,10<n)break}}if(0<n)return i/n/1e6}return navigator.connection&&(n=navigator.connection.downlink,typeof n=="number")?n:5}var Zu=null,ed=null;function Qr(n){return n.nodeType===9?n:n.ownerDocument}function qh(n){switch(n){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function zh(n,i){if(n===0)switch(i){case"svg":return 1;case"math":return 2;default:return 0}return n===1&&i==="foreignObject"?0:n}function td(n,i){return n==="textarea"||n==="noscript"||typeof i.children=="string"||typeof i.children=="number"||typeof i.children=="bigint"||typeof i.dangerouslySetInnerHTML=="object"&&i.dangerouslySetInnerHTML!==null&&i.dangerouslySetInnerHTML.__html!=null}var nd=null;function fv(){var n=window.event;return n&&n.type==="popstate"?n===nd?!1:(nd=n,!0):(nd=null,!1)}var Vh=typeof setTimeout=="function"?setTimeout:void 0,mv=typeof clearTimeout=="function"?clearTimeout:void 0,Yh=typeof Promise=="function"?Promise:void 0,pv=typeof queueMicrotask=="function"?queueMicrotask:typeof Yh<"u"?function(n){return Yh.resolve(null).then(n).catch(hv)}:Vh;function hv(n){setTimeout(function(){throw n})}function Ui(n){return n==="head"}function Kh(n,i){var r=i,c=0;do{var d=r.nextSibling;if(n.removeChild(r),d&&d.nodeType===8)if(r=d.data,r==="/$"||r==="/&"){if(c===0){n.removeChild(d),Ta(i);return}c--}else if(r==="$"||r==="$?"||r==="$~"||r==="$!"||r==="&")c++;else if(r==="html")Eo(n.ownerDocument.documentElement);else if(r==="head"){r=n.ownerDocument.head,Eo(r);for(var h=r.firstChild;h;){var A=h.nextSibling,C=h.nodeName;h[$a]||C==="SCRIPT"||C==="STYLE"||C==="LINK"&&h.rel.toLowerCase()==="stylesheet"||r.removeChild(h),h=A}}else r==="body"&&Eo(n.ownerDocument.body);r=d}while(r);Ta(i)}function Fh(n,i){var r=n;n=0;do{var c=r.nextSibling;if(r.nodeType===1?i?(r._stashedDisplay=r.style.display,r.style.display="none"):(r.style.display=r._stashedDisplay||"",r.getAttribute("style")===""&&r.removeAttribute("style")):r.nodeType===3&&(i?(r._stashedText=r.nodeValue,r.nodeValue=""):r.nodeValue=r._stashedText||""),c&&c.nodeType===8)if(r=c.data,r==="/$"){if(n===0)break;n--}else r!=="$"&&r!=="$?"&&r!=="$~"&&r!=="$!"||n++;r=c}while(r)}function id(n){var i=n.firstChild;for(i&&i.nodeType===10&&(i=i.nextSibling);i;){var r=i;switch(i=i.nextSibling,r.nodeName){case"HTML":case"HEAD":case"BODY":id(r),lc(r);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(r.rel.toLowerCase()==="stylesheet")continue}n.removeChild(r)}}function yv(n,i,r,c){for(;n.nodeType===1;){var d=r;if(n.nodeName.toLowerCase()!==i.toLowerCase()){if(!c&&(n.nodeName!=="INPUT"||n.type!=="hidden"))break}else if(c){if(!n[$a])switch(i){case"meta":if(!n.hasAttribute("itemprop"))break;return n;case"link":if(h=n.getAttribute("rel"),h==="stylesheet"&&n.hasAttribute("data-precedence"))break;if(h!==d.rel||n.getAttribute("href")!==(d.href==null||d.href===""?null:d.href)||n.getAttribute("crossorigin")!==(d.crossOrigin==null?null:d.crossOrigin)||n.getAttribute("title")!==(d.title==null?null:d.title))break;return n;case"style":if(n.hasAttribute("data-precedence"))break;return n;case"script":if(h=n.getAttribute("src"),(h!==(d.src==null?null:d.src)||n.getAttribute("type")!==(d.type==null?null:d.type)||n.getAttribute("crossorigin")!==(d.crossOrigin==null?null:d.crossOrigin))&&h&&n.hasAttribute("async")&&!n.hasAttribute("itemprop"))break;return n;default:return n}}else if(i==="input"&&n.type==="hidden"){var h=d.name==null?null:""+d.name;if(d.type==="hidden"&&n.getAttribute("name")===h)return n}else return n;if(n=Tn(n.nextSibling),n===null)break}return null}function gv(n,i,r){if(i==="")return null;for(;n.nodeType!==3;)if((n.nodeType!==1||n.nodeName!=="INPUT"||n.type!=="hidden")&&!r||(n=Tn(n.nextSibling),n===null))return null;return n}function Wh(n,i){for(;n.nodeType!==8;)if((n.nodeType!==1||n.nodeName!=="INPUT"||n.type!=="hidden")&&!i||(n=Tn(n.nextSibling),n===null))return null;return n}function sd(n){return n.data==="$?"||n.data==="$~"}function ad(n){return n.data==="$!"||n.data==="$?"&&n.ownerDocument.readyState!=="loading"}function bv(n,i){var r=n.ownerDocument;if(n.data==="$~")n._reactRetry=i;else if(n.data!=="$?"||r.readyState!=="loading")i();else{var c=function(){i(),r.removeEventListener("DOMContentLoaded",c)};r.addEventListener("DOMContentLoaded",c),n._reactRetry=c}}function Tn(n){for(;n!=null;n=n.nextSibling){var i=n.nodeType;if(i===1||i===3)break;if(i===8){if(i=n.data,i==="$"||i==="$!"||i==="$?"||i==="$~"||i==="&"||i==="F!"||i==="F")break;if(i==="/$"||i==="/&")return null}}return n}var od=null;function Xh(n){n=n.nextSibling;for(var i=0;n;){if(n.nodeType===8){var r=n.data;if(r==="/$"||r==="/&"){if(i===0)return Tn(n.nextSibling);i--}else r!=="$"&&r!=="$!"&&r!=="$?"&&r!=="$~"&&r!=="&"||i++}n=n.nextSibling}return null}function Gh(n){n=n.previousSibling;for(var i=0;n;){if(n.nodeType===8){var r=n.data;if(r==="$"||r==="$!"||r==="$?"||r==="$~"||r==="&"){if(i===0)return n;i--}else r!=="/$"&&r!=="/&"||i++}n=n.previousSibling}return null}function Jh(n,i,r){switch(i=Qr(r),n){case"html":if(n=i.documentElement,!n)throw Error(o(452));return n;case"head":if(n=i.head,!n)throw Error(o(453));return n;case"body":if(n=i.body,!n)throw Error(o(454));return n;default:throw Error(o(451))}}function Eo(n){for(var i=n.attributes;i.length;)n.removeAttributeNode(i[0]);lc(n)}var En=new Map,Qh=new Set;function Zr(n){return typeof n.getRootNode=="function"?n.getRootNode():n.nodeType===9?n:n.ownerDocument}var di=z.d;z.d={f:Sv,r:vv,D:Av,C:xv,L:Tv,m:Ev,X:Mv,S:_v,M:wv};function Sv(){var n=di.f(),i=Vr();return n||i}function vv(n){var i=qs(n);i!==null&&i.tag===5&&i.type==="form"?hp(i):di.r(n)}var va=typeof document>"u"?null:document;function Zh(n,i,r){var c=va;if(c&&typeof i=="string"&&i){var d=yn(i);d='link[rel="'+n+'"][href="'+d+'"]',typeof r=="string"&&(d+='[crossorigin="'+r+'"]'),Qh.has(d)||(Qh.add(d),n={rel:n,crossOrigin:r,href:i},c.querySelector(d)===null&&(i=c.createElement("link"),$t(i,"link",n),Nt(i),c.head.appendChild(i)))}}function Av(n){di.D(n),Zh("dns-prefetch",n,null)}function xv(n,i){di.C(n,i),Zh("preconnect",n,i)}function Tv(n,i,r){di.L(n,i,r);var c=va;if(c&&n&&i){var d='link[rel="preload"][as="'+yn(i)+'"]';i==="image"&&r&&r.imageSrcSet?(d+='[imagesrcset="'+yn(r.imageSrcSet)+'"]',typeof r.imageSizes=="string"&&(d+='[imagesizes="'+yn(r.imageSizes)+'"]')):d+='[href="'+yn(n)+'"]';var h=d;switch(i){case"style":h=Aa(n);break;case"script":h=xa(n)}En.has(h)||(n=b({rel:"preload",href:i==="image"&&r&&r.imageSrcSet?void 0:n,as:i},r),En.set(h,n),c.querySelector(d)!==null||i==="style"&&c.querySelector(_o(h))||i==="script"&&c.querySelector(Mo(h))||(i=c.createElement("link"),$t(i,"link",n),Nt(i),c.head.appendChild(i)))}}function Ev(n,i){di.m(n,i);var r=va;if(r&&n){var c=i&&typeof i.as=="string"?i.as:"script",d='link[rel="modulepreload"][as="'+yn(c)+'"][href="'+yn(n)+'"]',h=d;switch(c){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":h=xa(n)}if(!En.has(h)&&(n=b({rel:"modulepreload",href:n},i),En.set(h,n),r.querySelector(d)===null)){switch(c){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(r.querySelector(Mo(h)))return}c=r.createElement("link"),$t(c,"link",n),Nt(c),r.head.appendChild(c)}}}function _v(n,i,r){di.S(n,i,r);var c=va;if(c&&n){var d=zs(c).hoistableStyles,h=Aa(n);i=i||"default";var A=d.get(h);if(!A){var C={loading:0,preload:null};if(A=c.querySelector(_o(h)))C.loading=5;else{n=b({rel:"stylesheet",href:n,"data-precedence":i},r),(r=En.get(h))&&rd(n,r);var L=A=c.createElement("link");Nt(L),$t(L,"link",n),L._p=new Promise(function(Y,te){L.onload=Y,L.onerror=te}),L.addEventListener("load",function(){C.loading|=1}),L.addEventListener("error",function(){C.loading|=2}),C.loading|=4,el(A,i,c)}A={type:"stylesheet",instance:A,count:1,state:C},d.set(h,A)}}}function Mv(n,i){di.X(n,i);var r=va;if(r&&n){var c=zs(r).hoistableScripts,d=xa(n),h=c.get(d);h||(h=r.querySelector(Mo(d)),h||(n=b({src:n,async:!0},i),(i=En.get(d))&&ld(n,i),h=r.createElement("script"),Nt(h),$t(h,"link",n),r.head.appendChild(h)),h={type:"script",instance:h,count:1,state:null},c.set(d,h))}}function wv(n,i){di.M(n,i);var r=va;if(r&&n){var c=zs(r).hoistableScripts,d=xa(n),h=c.get(d);h||(h=r.querySelector(Mo(d)),h||(n=b({src:n,async:!0,type:"module"},i),(i=En.get(d))&&ld(n,i),h=r.createElement("script"),Nt(h),$t(h,"link",n),r.head.appendChild(h)),h={type:"script",instance:h,count:1,state:null},c.set(d,h))}}function ey(n,i,r,c){var d=(d=ue.current)?Zr(d):null;if(!d)throw Error(o(446));switch(n){case"meta":case"title":return null;case"style":return typeof r.precedence=="string"&&typeof r.href=="string"?(i=Aa(r.href),r=zs(d).hoistableStyles,c=r.get(i),c||(c={type:"style",instance:null,count:0,state:null},r.set(i,c)),c):{type:"void",instance:null,count:0,state:null};case"link":if(r.rel==="stylesheet"&&typeof r.href=="string"&&typeof r.precedence=="string"){n=Aa(r.href);var h=zs(d).hoistableStyles,A=h.get(n);if(A||(d=d.ownerDocument||d,A={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},h.set(n,A),(h=d.querySelector(_o(n)))&&!h._p&&(A.instance=h,A.state.loading=5),En.has(n)||(r={rel:"preload",as:"style",href:r.href,crossOrigin:r.crossOrigin,integrity:r.integrity,media:r.media,hrefLang:r.hrefLang,referrerPolicy:r.referrerPolicy},En.set(n,r),h||Cv(d,n,r,A.state))),i&&c===null)throw Error(o(528,""));return A}if(i&&c!==null)throw Error(o(529,""));return null;case"script":return i=r.async,r=r.src,typeof r=="string"&&i&&typeof i!="function"&&typeof i!="symbol"?(i=xa(r),r=zs(d).hoistableScripts,c=r.get(i),c||(c={type:"script",instance:null,count:0,state:null},r.set(i,c)),c):{type:"void",instance:null,count:0,state:null};default:throw Error(o(444,n))}}function Aa(n){return'href="'+yn(n)+'"'}function _o(n){return'link[rel="stylesheet"]['+n+"]"}function ty(n){return b({},n,{"data-precedence":n.precedence,precedence:null})}function Cv(n,i,r,c){n.querySelector('link[rel="preload"][as="style"]['+i+"]")?c.loading=1:(i=n.createElement("link"),c.preload=i,i.addEventListener("load",function(){return c.loading|=1}),i.addEventListener("error",function(){return c.loading|=2}),$t(i,"link",r),Nt(i),n.head.appendChild(i))}function xa(n){return'[src="'+yn(n)+'"]'}function Mo(n){return"script[async]"+n}function ny(n,i,r){if(i.count++,i.instance===null)switch(i.type){case"style":var c=n.querySelector('style[data-href~="'+yn(r.href)+'"]');if(c)return i.instance=c,Nt(c),c;var d=b({},r,{"data-href":r.href,"data-precedence":r.precedence,href:null,precedence:null});return c=(n.ownerDocument||n).createElement("style"),Nt(c),$t(c,"style",d),el(c,r.precedence,n),i.instance=c;case"stylesheet":d=Aa(r.href);var h=n.querySelector(_o(d));if(h)return i.state.loading|=4,i.instance=h,Nt(h),h;c=ty(r),(d=En.get(d))&&rd(c,d),h=(n.ownerDocument||n).createElement("link"),Nt(h);var A=h;return A._p=new Promise(function(C,L){A.onload=C,A.onerror=L}),$t(h,"link",c),i.state.loading|=4,el(h,r.precedence,n),i.instance=h;case"script":return h=xa(r.src),(d=n.querySelector(Mo(h)))?(i.instance=d,Nt(d),d):(c=r,(d=En.get(h))&&(c=b({},r),ld(c,d)),n=n.ownerDocument||n,d=n.createElement("script"),Nt(d),$t(d,"link",c),n.head.appendChild(d),i.instance=d);case"void":return null;default:throw Error(o(443,i.type))}else i.type==="stylesheet"&&(i.state.loading&4)===0&&(c=i.instance,i.state.loading|=4,el(c,r.precedence,n));return i.instance}function el(n,i,r){for(var c=r.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),d=c.length?c[c.length-1]:null,h=d,A=0;A<c.length;A++){var C=c[A];if(C.dataset.precedence===i)h=C;else if(h!==d)break}h?h.parentNode.insertBefore(n,h.nextSibling):(i=r.nodeType===9?r.head:r,i.insertBefore(n,i.firstChild))}function rd(n,i){n.crossOrigin==null&&(n.crossOrigin=i.crossOrigin),n.referrerPolicy==null&&(n.referrerPolicy=i.referrerPolicy),n.title==null&&(n.title=i.title)}function ld(n,i){n.crossOrigin==null&&(n.crossOrigin=i.crossOrigin),n.referrerPolicy==null&&(n.referrerPolicy=i.referrerPolicy),n.integrity==null&&(n.integrity=i.integrity)}var tl=null;function iy(n,i,r){if(tl===null){var c=new Map,d=tl=new Map;d.set(r,c)}else d=tl,c=d.get(r),c||(c=new Map,d.set(r,c));if(c.has(n))return c;for(c.set(n,null),r=r.getElementsByTagName(n),d=0;d<r.length;d++){var h=r[d];if(!(h[$a]||h[Ht]||n==="link"&&h.getAttribute("rel")==="stylesheet")&&h.namespaceURI!=="http://www.w3.org/2000/svg"){var A=h.getAttribute(i)||"";A=n+A;var C=c.get(A);C?C.push(h):c.set(A,[h])}}return c}function sy(n,i,r){n=n.ownerDocument||n,n.head.insertBefore(r,i==="title"?n.querySelector("head > title"):null)}function Ov(n,i,r){if(r===1||i.itemProp!=null)return!1;switch(n){case"meta":case"title":return!0;case"style":if(typeof i.precedence!="string"||typeof i.href!="string"||i.href==="")break;return!0;case"link":if(typeof i.rel!="string"||typeof i.href!="string"||i.href===""||i.onLoad||i.onError)break;return i.rel==="stylesheet"?(n=i.disabled,typeof i.precedence=="string"&&n==null):!0;case"script":if(i.async&&typeof i.async!="function"&&typeof i.async!="symbol"&&!i.onLoad&&!i.onError&&i.src&&typeof i.src=="string")return!0}return!1}function ay(n){return!(n.type==="stylesheet"&&(n.state.loading&3)===0)}function kv(n,i,r,c){if(r.type==="stylesheet"&&(typeof c.media!="string"||matchMedia(c.media).matches!==!1)&&(r.state.loading&4)===0){if(r.instance===null){var d=Aa(c.href),h=i.querySelector(_o(d));if(h){i=h._p,i!==null&&typeof i=="object"&&typeof i.then=="function"&&(n.count++,n=nl.bind(n),i.then(n,n)),r.state.loading|=4,r.instance=h,Nt(h);return}h=i.ownerDocument||i,c=ty(c),(d=En.get(d))&&rd(c,d),h=h.createElement("link"),Nt(h);var A=h;A._p=new Promise(function(C,L){A.onload=C,A.onerror=L}),$t(h,"link",c),r.instance=h}n.stylesheets===null&&(n.stylesheets=new Map),n.stylesheets.set(r,i),(i=r.state.preload)&&(r.state.loading&3)===0&&(n.count++,r=nl.bind(n),i.addEventListener("load",r),i.addEventListener("error",r))}}var cd=0;function Nv(n,i){return n.stylesheets&&n.count===0&&sl(n,n.stylesheets),0<n.count||0<n.imgCount?function(r){var c=setTimeout(function(){if(n.stylesheets&&sl(n,n.stylesheets),n.unsuspend){var h=n.unsuspend;n.unsuspend=null,h()}},6e4+i);0<n.imgBytes&&cd===0&&(cd=62500*dv());var d=setTimeout(function(){if(n.waitingForImages=!1,n.count===0&&(n.stylesheets&&sl(n,n.stylesheets),n.unsuspend)){var h=n.unsuspend;n.unsuspend=null,h()}},(n.imgBytes>cd?50:800)+i);return n.unsuspend=r,function(){n.unsuspend=null,clearTimeout(c),clearTimeout(d)}}:null}function nl(){if(this.count--,this.count===0&&(this.imgCount===0||!this.waitingForImages)){if(this.stylesheets)sl(this,this.stylesheets);else if(this.unsuspend){var n=this.unsuspend;this.unsuspend=null,n()}}}var il=null;function sl(n,i){n.stylesheets=null,n.unsuspend!==null&&(n.count++,il=new Map,i.forEach(Rv,n),il=null,nl.call(n))}function Rv(n,i){if(!(i.state.loading&4)){var r=il.get(n);if(r)var c=r.get(null);else{r=new Map,il.set(n,r);for(var d=n.querySelectorAll("link[data-precedence],style[data-precedence]"),h=0;h<d.length;h++){var A=d[h];(A.nodeName==="LINK"||A.getAttribute("media")!=="not all")&&(r.set(A.dataset.precedence,A),c=A)}c&&r.set(null,c)}d=i.instance,A=d.getAttribute("data-precedence"),h=r.get(A)||c,h===c&&r.set(null,d),r.set(A,d),this.count++,c=nl.bind(this),d.addEventListener("load",c),d.addEventListener("error",c),h?h.parentNode.insertBefore(d,h.nextSibling):(n=n.nodeType===9?n.head:n,n.insertBefore(d,n.firstChild)),i.state.loading|=4}}var wo={$$typeof:M,Provider:null,Consumer:null,_currentValue:Z,_currentValue2:Z,_threadCount:0};function Iv(n,i,r,c,d,h,A,C,L){this.tag=1,this.containerInfo=n,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=Hs(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Hs(0),this.hiddenUpdates=Hs(null),this.identifierPrefix=c,this.onUncaughtError=d,this.onCaughtError=h,this.onRecoverableError=A,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=L,this.incompleteTransitions=new Map}function oy(n,i,r,c,d,h,A,C,L,Y,te,ie){return n=new Iv(n,i,r,A,L,Y,te,ie,C),i=1,h===!0&&(i|=24),h=ln(3,null,null,i),n.current=h,h.stateNode=n,i=qc(),i.refCount++,n.pooledCache=i,i.refCount++,h.memoizedState={element:c,isDehydrated:r,cache:i},Kc(h),n}function ry(n){return n?(n=Zs,n):Zs}function ly(n,i,r,c,d,h){d=ry(d),c.context===null?c.context=d:c.pendingContext=d,c=Oi(i),c.payload={element:r},h=h===void 0?null:h,h!==null&&(c.callback=h),r=ki(n,c,i),r!==null&&(an(r,n,i),so(r,n,i))}function cy(n,i){if(n=n.memoizedState,n!==null&&n.dehydrated!==null){var r=n.retryLane;n.retryLane=r!==0&&r<i?r:i}}function ud(n,i){cy(n,i),(n=n.alternate)&&cy(n,i)}function uy(n){if(n.tag===13||n.tag===31){var i=fs(n,67108864);i!==null&&an(i,n,67108864),ud(n,67108864)}}function dy(n){if(n.tag===13||n.tag===31){var i=mn();i=Da(i);var r=fs(n,i);r!==null&&an(r,n,i),ud(n,i)}}var al=!0;function Lv(n,i,r,c){var d=P.T;P.T=null;var h=z.p;try{z.p=2,dd(n,i,r,c)}finally{z.p=h,P.T=d}}function Bv(n,i,r,c){var d=P.T;P.T=null;var h=z.p;try{z.p=8,dd(n,i,r,c)}finally{z.p=h,P.T=d}}function dd(n,i,r,c){if(al){var d=fd(c);if(d===null)Ju(n,i,c,ol,r),my(n,c);else if(Hv(d,n,i,r,c))c.stopPropagation();else if(my(n,c),i&4&&-1<Pv.indexOf(n)){for(;d!==null;){var h=qs(d);if(h!==null)switch(h.tag){case 3:if(h=h.stateNode,h.current.memoizedState.isDehydrated){var A=on(h.pendingLanes);if(A!==0){var C=h;for(C.pendingLanes|=2,C.entangledLanes|=2;A;){var L=1<<31-pt(A);C.entanglements[1]|=L,A&=~L}zn(h),(De&6)===0&&(qr=It()+500,Ao(0))}}break;case 31:case 13:C=fs(h,2),C!==null&&an(C,h,2),Vr(),ud(h,2)}if(h=fd(c),h===null&&Ju(n,i,c,ol,r),h===d)break;d=h}d!==null&&c.stopPropagation()}else Ju(n,i,c,null,r)}}function fd(n){return n=pc(n),md(n)}var ol=null;function md(n){if(ol=null,n=$s(n),n!==null){var i=l(n);if(i===null)n=null;else{var r=i.tag;if(r===13){if(n=u(i),n!==null)return n;n=null}else if(r===31){if(n=f(i),n!==null)return n;n=null}else if(r===3){if(i.stateNode.current.memoizedState.isDehydrated)return i.tag===3?i.stateNode.containerInfo:null;n=null}else i!==n&&(n=null)}}return ol=n,null}function fy(n){switch(n){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(La()){case Bs:return 2;case Ps:return 8;case Kn:case ss:return 32;case as:return 268435456;default:return 32}default:return 32}}var pd=!1,$i=null,qi=null,zi=null,Co=new Map,Oo=new Map,Vi=[],Pv="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function my(n,i){switch(n){case"focusin":case"focusout":$i=null;break;case"dragenter":case"dragleave":qi=null;break;case"mouseover":case"mouseout":zi=null;break;case"pointerover":case"pointerout":Co.delete(i.pointerId);break;case"gotpointercapture":case"lostpointercapture":Oo.delete(i.pointerId)}}function ko(n,i,r,c,d,h){return n===null||n.nativeEvent!==h?(n={blockedOn:i,domEventName:r,eventSystemFlags:c,nativeEvent:h,targetContainers:[d]},i!==null&&(i=qs(i),i!==null&&uy(i)),n):(n.eventSystemFlags|=c,i=n.targetContainers,d!==null&&i.indexOf(d)===-1&&i.push(d),n)}function Hv(n,i,r,c,d){switch(i){case"focusin":return $i=ko($i,n,i,r,c,d),!0;case"dragenter":return qi=ko(qi,n,i,r,c,d),!0;case"mouseover":return zi=ko(zi,n,i,r,c,d),!0;case"pointerover":var h=d.pointerId;return Co.set(h,ko(Co.get(h)||null,n,i,r,c,d)),!0;case"gotpointercapture":return h=d.pointerId,Oo.set(h,ko(Oo.get(h)||null,n,i,r,c,d)),!0}return!1}function py(n){var i=$s(n.target);if(i!==null){var r=l(i);if(r!==null){if(i=r.tag,i===13){if(i=u(r),i!==null){n.blockedOn=i,Cf(n.priority,function(){dy(r)});return}}else if(i===31){if(i=f(r),i!==null){n.blockedOn=i,Cf(n.priority,function(){dy(r)});return}}else if(i===3&&r.stateNode.current.memoizedState.isDehydrated){n.blockedOn=r.tag===3?r.stateNode.containerInfo:null;return}}}n.blockedOn=null}function rl(n){if(n.blockedOn!==null)return!1;for(var i=n.targetContainers;0<i.length;){var r=fd(n.nativeEvent);if(r===null){r=n.nativeEvent;var c=new r.constructor(r.type,r);mc=c,r.target.dispatchEvent(c),mc=null}else return i=qs(r),i!==null&&uy(i),n.blockedOn=r,!1;i.shift()}return!0}function hy(n,i,r){rl(n)&&r.delete(i)}function jv(){pd=!1,$i!==null&&rl($i)&&($i=null),qi!==null&&rl(qi)&&(qi=null),zi!==null&&rl(zi)&&(zi=null),Co.forEach(hy),Oo.forEach(hy)}function ll(n,i){n.blockedOn===i&&(n.blockedOn=null,pd||(pd=!0,e.unstable_scheduleCallback(e.unstable_NormalPriority,jv)))}var cl=null;function yy(n){cl!==n&&(cl=n,e.unstable_scheduleCallback(e.unstable_NormalPriority,function(){cl===n&&(cl=null);for(var i=0;i<n.length;i+=3){var r=n[i],c=n[i+1],d=n[i+2];if(typeof c!="function"){if(md(c||r)===null)continue;break}var h=qs(r);h!==null&&(n.splice(i,3),i-=3,fu(h,{pending:!0,data:d,method:r.method,action:c},c,d))}}))}function Ta(n){function i(L){return ll(L,n)}$i!==null&&ll($i,n),qi!==null&&ll(qi,n),zi!==null&&ll(zi,n),Co.forEach(i),Oo.forEach(i);for(var r=0;r<Vi.length;r++){var c=Vi[r];c.blockedOn===n&&(c.blockedOn=null)}for(;0<Vi.length&&(r=Vi[0],r.blockedOn===null);)py(r),r.blockedOn===null&&Vi.shift();if(r=(n.ownerDocument||n).$$reactFormReplay,r!=null)for(c=0;c<r.length;c+=3){var d=r[c],h=r[c+1],A=d[Qt]||null;if(typeof h=="function")A||yy(r);else if(A){var C=null;if(h&&h.hasAttribute("formAction")){if(d=h,A=h[Qt]||null)C=A.formAction;else if(md(d)!==null)continue}else C=A.action;typeof C=="function"?r[c+1]=C:(r.splice(c,3),c-=3),yy(r)}}}function gy(){function n(h){h.canIntercept&&h.info==="react-transition"&&h.intercept({handler:function(){return new Promise(function(A){return d=A})},focusReset:"manual",scroll:"manual"})}function i(){d!==null&&(d(),d=null),c||setTimeout(r,20)}function r(){if(!c&&!navigation.transition){var h=navigation.currentEntry;h&&h.url!=null&&navigation.navigate(h.url,{state:h.getState(),info:"react-transition",history:"replace"})}}if(typeof navigation=="object"){var c=!1,d=null;return navigation.addEventListener("navigate",n),navigation.addEventListener("navigatesuccess",i),navigation.addEventListener("navigateerror",i),setTimeout(r,100),function(){c=!0,navigation.removeEventListener("navigate",n),navigation.removeEventListener("navigatesuccess",i),navigation.removeEventListener("navigateerror",i),d!==null&&(d(),d=null)}}}function hd(n){this._internalRoot=n}ul.prototype.render=hd.prototype.render=function(n){var i=this._internalRoot;if(i===null)throw Error(o(409));var r=i.current,c=mn();ly(r,c,n,i,null,null)},ul.prototype.unmount=hd.prototype.unmount=function(){var n=this._internalRoot;if(n!==null){this._internalRoot=null;var i=n.containerInfo;ly(n.current,2,null,n,null,null),Vr(),i[Us]=null}};function ul(n){this._internalRoot=n}ul.prototype.unstable_scheduleHydration=function(n){if(n){var i=Ua();n={blockedOn:null,target:n,priority:i};for(var r=0;r<Vi.length&&i!==0&&i<Vi[r].priority;r++);Vi.splice(r,0,n),r===0&&py(n)}};var by=t.version;if(by!=="19.2.3")throw Error(o(527,by,"19.2.3"));z.findDOMNode=function(n){var i=n._reactInternals;if(i===void 0)throw typeof n.render=="function"?Error(o(188)):(n=Object.keys(n).join(","),Error(o(268,n)));return n=m(i),n=n!==null?y(n):null,n=n===null?null:n.stateNode,n};var Dv={bundleType:0,version:"19.2.3",rendererPackageName:"react-dom",currentDispatcherRef:P,reconcilerVersion:"19.2.3"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var dl=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!dl.isDisabled&&dl.supportsFiber)try{Fn=dl.inject(Dv),Lt=dl}catch{}}return Ro.createRoot=function(n,i){if(!a(n))throw Error(o(299));var r=!1,c="",d=_p,h=Mp,A=wp;return i!=null&&(i.unstable_strictMode===!0&&(r=!0),i.identifierPrefix!==void 0&&(c=i.identifierPrefix),i.onUncaughtError!==void 0&&(d=i.onUncaughtError),i.onCaughtError!==void 0&&(h=i.onCaughtError),i.onRecoverableError!==void 0&&(A=i.onRecoverableError)),i=oy(n,1,!1,null,null,r,c,null,d,h,A,gy),n[Us]=i.current,Gu(n),new hd(i)},Ro.hydrateRoot=function(n,i,r){if(!a(n))throw Error(o(299));var c=!1,d="",h=_p,A=Mp,C=wp,L=null;return r!=null&&(r.unstable_strictMode===!0&&(c=!0),r.identifierPrefix!==void 0&&(d=r.identifierPrefix),r.onUncaughtError!==void 0&&(h=r.onUncaughtError),r.onCaughtError!==void 0&&(A=r.onCaughtError),r.onRecoverableError!==void 0&&(C=r.onRecoverableError),r.formState!==void 0&&(L=r.formState)),i=oy(n,1,!0,i,r??null,c,d,L,h,A,C,gy),i.context=ry(null),r=i.current,c=mn(),c=Da(c),d=Oi(c),d.callback=null,ki(r,d,c),r=c,i.current.lanes=r,rs(i,r),zn(i),n[Us]=i.current,Gu(n),new ul(i)},Ro.version="19.2.3",Ro}var Cy;function Gv(){if(Cy)return bd.exports;Cy=1;function e(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(t){console.error(t)}}return e(),bd.exports=Xv(),bd.exports}var Jv=Gv();const Xt=(e,t)=>({q:e,r:t,s:-e-t}),Qv=e=>`${e.q},${e.r}`,ce=Qv,J=(e,t)=>e.q===t.q&&e.r===t.r&&e.s===t.s,Kt=(e,t)=>Xt(e.q+t.q,e.r+t.r),Kd=(e,t)=>Xt(e.q-t.q,e.r-t.r),fe=(e,t)=>(Math.abs(e.q-t.q)+Math.abs(e.r-t.r)+Math.abs(e.s-t.s))/2,Ae=(e,t)=>{const s=t*(1.5*e.q),o=t*Math.sqrt(3)*(e.r+e.q/2);return{x:s,y:o}},Oy=e=>({q:e.q,r:e.r,s:e.s??-e.q-e.r}),Zv=e=>Xt(e.q,e.r),eA=e=>{let t=Math.round(e.q),s=Math.round(e.r),o=Math.round(e.s);const a=Math.abs(t-e.q),l=Math.abs(s-e.r),u=Math.abs(o-e.s);return a>l&&a>u?t=-s-o:l>u?s=-t-o:o=-t-s,{q:t,r:s,s:o}},Ko=[Xt(1,0),Xt(1,-1),Xt(0,-1),Xt(-1,0),Xt(-1,1),Xt(0,1)],Ue=e=>Ko.map(t=>Kt(e,t)),Mt=e=>Ko[(e%6+6)%6],xd=(e,t,s)=>e+(t-e)*s,Ze=(e,t)=>{const s=fe(e,t),o=[],a=Oy(e),l=Oy(t);for(let u=0;u<=s;u++){const f=s===0?0:u/s,p={q:xd(a.q+1e-6,l.q+1e-6,f),r:xd(a.r+1e-6,l.r+1e-6,f),s:xd(a.s+1e-6,l.s+1e-6,f)};o.push(Zv(eA(p)))}return o},Hn=(e,t)=>{const s=fe(e,t);if(s===0)return-1;const o=Kd(t,e),a=o.q/s,l=o.r/s,u=(0-o.q-o.r)/s;return Ko.findIndex(f=>Math.abs(f.q-a)<.01&&Math.abs(f.r-l)<.01&&Math.abs(f.s-u)<.01)};function ff(e,t){const s=Mt(e);return{q:s.q*t,r:s.r*t,s:-(s.q*t)-s.r*t}}const Zl=(e,t,s,o)=>{if(e<0||e>=s||t<0||t>=o)return!1;const a=e+t,l=Math.floor(s/2),u=s-1+(o-1)-l;return a>=l&&a<=u},tA=(e,t)=>{const s=[];for(let o=0;o<e;o++)for(let a=0;a<t;a++)Zl(o,a,e,t)&&s.push(Xt(o,a));return s},Zi=(e,t,s)=>Zl(e.q,e.r,t,s),Bl=7,Pl=9,G=36,ky={speed:1},nA={stunned:{tickWindow:"START_OF_TURN"},poisoned:{tickWindow:"START_OF_TURN"},armored:{tickWindow:"END_OF_TURN"},hidden:{tickWindow:"END_OF_TURN"},time_bomb:{tickWindow:"END_OF_TURN"}},iA=.17,fl={floor:"#6b7b3c",wall:"#374151",shrine:"#f97316",portal:"#ffffff"},sA={1:"inferno",2:"inferno",3:"inferno",4:"inferno",5:"inferno",6:"inferno",7:"inferno",8:"inferno",9:"inferno",10:"inferno"},Oa={GRASS:{id:"GRASS",name:"Grass",description:"Soft grass",defaultTraits:new Set(["WALKABLE","FLAMMABLE"]),visual:{color:"#4a7c59",icon:""}},STONE:{id:"STONE",name:"Stone Floor",description:"Hard stone",defaultTraits:new Set(["WALKABLE"]),visual:{color:"#808080",icon:""}},LAVA:{id:"LAVA",name:"Lava",description:"Molten lava",defaultTraits:new Set(["LIQUID","HAZARDOUS"]),visual:{color:"#ff4400",icon:""}},WALL:{id:"WALL",name:"Wall",description:"Solid wall",defaultTraits:new Set(["BLOCKS_LOS","BLOCKS_MOVEMENT","ANCHOR"]),visual:{color:"#333333",icon:""}},ICE:{id:"ICE",name:"Ice",description:"Slippery ice",defaultTraits:new Set(["WALKABLE","SLIPPERY"]),visual:{color:"#aaddff",icon:""}},VOID:{id:"VOID",name:"Void",description:"The endless void",defaultTraits:new Set(["HAZARDOUS"]),visual:{color:"#000000",icon:""}},STAIRS:{id:"STAIRS",name:"Stairs",description:"Lead to the next floor",defaultTraits:new Set(["WALKABLE"]),visual:{color:"#ffffff",icon:""}},SHRINE:{id:"SHRINE",name:"Shrine",description:"A place of power",defaultTraits:new Set(["WALKABLE","ANCHOR"]),visual:{color:"#ffd700",icon:""}},GATE:{id:"GATE",name:"Gate",description:"A heavy gate",defaultTraits:new Set(["BLOCKS_MOVEMENT","BLOCKS_LOS"]),visual:{color:"#444444",icon:""}},BRIDGE:{id:"BRIDGE",name:"Bridge",description:"Crossing the gap",defaultTraits:new Set(["WALKABLE"]),visual:{color:"#8b4513",icon:""}}},$o={FIRE:{id:"FIRE",name:"Fire",description:"Burning flames",onStay:e=>({effects:e.state.ruleset?.ailments?.acaeEnabled?[{type:"DepositAilmentCounters",target:e.actor.id,ailment:"burn",amount:5,source:"tile"}]:[{type:"Damage",target:e.actor.id,amount:1,reason:"fire_damage"}],messages:[`${e.actor.subtype||e.actor.type} burns!`]}),interactsWith:{WET:e=>({effects:[{type:"Juice",effect:"flash",target:e.tile.position,color:"#aaaaaa"}],messages:["Steam rises!"],modifyTile:{effects:e.tile.effects.filter(t=>t.id!=="FIRE"&&t.id!=="WET"&&t.id!=="STEAM").concat({id:"STEAM",duration:2,potency:1})}})}},WET:{id:"WET",name:"Wet",description:"Soaked with water",onApply:e=>e.tile.effects.some(s=>s.id==="FIRE")?{effects:[],messages:["Water extinguishes the flames!"],modifyTile:{effects:e.tile.effects.filter(s=>s.id!=="FIRE")}}:{effects:[],messages:[]}},MIASMA:{id:"MIASMA",name:"Miasma",description:"Toxic haze lingering over the tile"},OIL:{id:"OIL",name:"Oil",description:"Slippery oil",interactsWith:{FIRE:e=>({effects:[{type:"Damage",target:"area",amount:3,reason:"oil_explosion"},{type:"Juice",effect:"explosion_ring",target:e.tile.position}],messages:["Oil explodes!"],modifyTile:{effects:e.tile.effects.filter(t=>t.id!=="OIL")}})}},STEAM:{id:"STEAM",name:"Steam",description:"Obscuring steam cloud"},BLESSED:{id:"BLESSED",name:"Blessed",description:"Holy ground"},CURSED:{id:"CURSED",name:"Cursed",description:"Unholy ground"},ICE_WALL:{id:"ICE_WALL",name:"Ice Wall",description:"A wall of ice"},SMOKE:{id:"SMOKE",name:"Smoke",description:"Thick smoke"},BOMB_TICK:{id:"BOMB_TICK",name:"Bomb Tick",description:"About to explode"},TRI_TRAP:{id:"TRI_TRAP",name:"Kinetic Trap",description:"Hidden trap that flings non-flying units outward"},SNARE:{id:"SNARE",name:"Snare",description:"Entangling roots that halt movement and root the target.",onPass:e=>e.actor.isFlying?{effects:[],messages:[]}:{effects:[{type:"ApplyStatus",target:e.actor.id,status:"rooted",duration:2}],messages:["Snared! Movement halted."],interrupt:!0,newMomentum:0}}},aA=e=>{let t=2166136261;for(let s=0;s<e.length;s++)t^=e.charCodeAt(s),t=Math.imul(t,16777619)>>>0;return t>>>0},oA=e=>function(){let t=(e+=1831565813)>>>0;return t=Math.imul(t^t>>>15,t|1)>>>0,t^=t+Math.imul(t^t>>>7,t|61)>>>0,((t^t>>>14)>>>0)/4294967296},ec=e=>{const t=typeof e=="number"?e>>>0:aA(String(e)),s=oA(t||1);return{next:()=>s(),id:(o=9)=>{const a="abcdefghijklmnopqrstuvwxyz0123456789";let l="";for(let u=0;u<o;u++){const f=Math.floor(s()*a.length)%a.length;l+=a[f]}return l}}},ka=(e,t,s=9,o="")=>{const a=`${e}:${t}:${o}`,l=ec(a),u="abcdefghijklmnopqrstuvwxyz0123456789";let f="";for(let p=0;p<s;p++){const m=Math.floor(l.next()*u.length)%u.length;f+=u[m]}return f},Ul=(e,t)=>{const s=`${e}:${t}`;return ec(s).next()},_n=e=>{const t=e.rngSeed||"default",s=e.rngCounter||0;return{value:Ul(t,s),nextState:{...e,rngCounter:s+1}}},Zo={footman:{packUnitId:"ENEMY_FOOTMAN_V1",bestiary:{subtype:"footman",name:"Footman",stats:{hp:1,maxHp:1,range:1,damage:1,type:"melee",cost:1,actionCooldown:2,weightClass:"Standard",speed:1},trinity:{body:4,mind:0,instinct:0},skills:{base:["BASIC_MOVE","BASIC_ATTACK"],passive:["AUTO_ATTACK"]}},runtimeSkills:{base:["BASIC_MOVE","BASIC_ATTACK"],passive:[]}},sprinter:{packUnitId:"ENEMY_SPRINTER_V1",bestiary:{subtype:"sprinter",name:"Sprinter",stats:{hp:1,maxHp:1,range:1,damage:1,type:"melee",cost:1,actionCooldown:1,weightClass:"Standard",speed:2},trinity:{body:2,mind:0,instinct:0},skills:{base:["BASIC_MOVE","BASIC_ATTACK"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","BASIC_ATTACK"],passive:[]}},raider:{packUnitId:"ENEMY_RAIDER_V1",bestiary:{subtype:"raider",name:"Raider",stats:{hp:1,maxHp:1,range:4,damage:1,type:"melee",cost:2,actionCooldown:1,weightClass:"Standard",speed:1},trinity:{body:2,mind:0,instinct:1},skills:{base:["BASIC_MOVE","BASIC_ATTACK","DASH"],passive:[]}},runtimeSkills:{base:["DASH"],passive:[]}},pouncer:{packUnitId:"ENEMY_POUNCER_V1",bestiary:{subtype:"pouncer",name:"Pouncer",stats:{hp:1,maxHp:1,range:4,damage:1,type:"melee",cost:2,actionCooldown:1,weightClass:"Standard",speed:1},trinity:{body:2,mind:0,instinct:1},skills:{base:["BASIC_MOVE","BASIC_ATTACK","GRAPPLE_HOOK"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","GRAPPLE_HOOK"],passive:[]}},shieldBearer:{packUnitId:"ENEMY_SHIELDBEARER_V1",bestiary:{subtype:"shieldBearer",name:"Shield Bearer",stats:{hp:2,maxHp:2,range:1,damage:1,type:"melee",cost:2,actionCooldown:2,weightClass:"Heavy",speed:1},trinity:{body:1,mind:0,instinct:.4},skills:{base:["BASIC_MOVE","BASIC_ATTACK","SHIELD_BASH"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","SHIELD_BASH"],passive:[]}},archer:{packUnitId:"ENEMY_ARCHER_V1",bestiary:{subtype:"archer",name:"Archer",stats:{hp:1,maxHp:1,range:4,damage:1,type:"ranged",cost:1,actionCooldown:3,weightClass:"Standard",speed:1},trinity:{body:.2,mind:0,instinct:.2},skills:{base:["BASIC_MOVE","BASIC_ATTACK","ARCHER_SHOT"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","ARCHER_SHOT"],passive:[]}},bomber:{packUnitId:"ENEMY_BOMBER_V1",bestiary:{subtype:"bomber",name:"Bomber",stats:{hp:1,maxHp:1,range:3,damage:1,type:"ranged",cost:1,actionCooldown:2,weightClass:"Standard",speed:1},trinity:{body:.4,mind:.2,instinct:.2},skills:{base:["BASIC_MOVE","BASIC_ATTACK","BOMB_TOSS"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","BOMB_TOSS"],passive:[]}},warlock:{packUnitId:"ENEMY_WARLOCK_V1",bestiary:{subtype:"warlock",name:"Warlock",stats:{hp:1,maxHp:1,range:4,damage:1,type:"ranged",cost:2,actionCooldown:2,weightClass:"Standard",speed:1},trinity:{body:.4,mind:.6,instinct:.2},skills:{base:["BASIC_MOVE","BASIC_ATTACK","SENTINEL_BLAST"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","SENTINEL_BLAST"],passive:[]}},sentinel:{packUnitId:"ENEMY_SENTINEL_V1",bestiary:{subtype:"sentinel",name:"Sentinel",stats:{hp:30,maxHp:30,range:4,damage:2,type:"boss",cost:25,actionCooldown:1,weightClass:"Heavy",speed:1},trinity:{body:4,mind:2,instinct:2},skills:{base:["BASIC_MOVE","BASIC_ATTACK","SENTINEL_BLAST"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","SENTINEL_TELEGRAPH","SENTINEL_BLAST"],passive:[]}}},rA=e=>Zo[e],lA=Object.keys(Zo),S0=e=>{const t=Zo[e];return{subtype:e,...t}},cA=()=>lA.map(S0),$l=e=>{const t=e;if(Object.prototype.hasOwnProperty.call(Zo,t))return S0(t)},Ny=(e,t={})=>{const s=$l(e);if(!s)return[];const o=t.includePassive??!0,l=(t.source??"runtime")==="runtime"?s.runtimeSkills:s.bestiary.skills;return o?[...l.base,...l.passive]:[...l.base]},Fd={0:{budget:0,allowedSubtypes:[]},1:{budget:2,allowedSubtypes:["footman"]},2:{budget:3,allowedSubtypes:["footman","sprinter"]},3:{budget:5,allowedSubtypes:["footman","archer"]},4:{budget:7,allowedSubtypes:["footman","archer","bomber","raider"]},5:{budget:10,allowedSubtypes:["footman","archer","bomber","shieldBearer","raider"]},6:{budget:12,allowedSubtypes:["footman","archer","bomber","shieldBearer","warlock","pouncer"]},7:{budget:15,allowedSubtypes:["footman","archer","bomber","shieldBearer","warlock","sprinter","pouncer"]},8:{budget:18,allowedSubtypes:["footman","archer","bomber","shieldBearer","warlock","sprinter","pouncer"]},9:{budget:22,allowedSubtypes:["footman","archer","bomber","shieldBearer","warlock","sprinter","pouncer"]},10:{budget:0,allowedSubtypes:[]}},Ry=Math.max(...Object.keys(Fd).map(Number)),uA=e=>{const t=Math.max(0,Math.floor(e)),s=Math.min(t,Ry),o=Fd[s]||Fd[Ry];return{floor:s,budget:o.budget,allowedSubtypes:[...o.allowedSubtypes]}},ml=(e,t)=>{const s=e.propensities[t];if(!(!s||s.method!=="fixed"))return s.value},Iy=(e,t)=>e.length===t.length&&e.every((s,o)=>s===t[o]),dA=e=>{const t=[],s=new Map;for(const o of e.units)o.actorType!=="enemy"||!o.subtype||s.set(o.subtype,o);for(const o of cA()){const a=s.get(o.subtype);if(!a){t.push({code:"MISSING_UNIT_FOR_SUBTYPE",subtype:o.subtype,message:`Missing enemy unit definition for subtype "${o.subtype}"`});continue}a.id!==o.packUnitId&&t.push({code:"PACK_UNIT_ID_MISMATCH",subtype:o.subtype,message:`Unit id "${a.id}" does not match content packUnitId "${o.packUnitId}"`}),a.weightClass!==o.bestiary.stats.weightClass&&t.push({code:"WEIGHT_CLASS_MISMATCH",subtype:o.subtype,message:`weightClass "${a.weightClass}" does not match bestiary "${o.bestiary.stats.weightClass}"`});const l=ml(a,"speed");(l===void 0||l!==o.bestiary.stats.speed)&&t.push({code:"SPEED_PROPENSITY_MISMATCH",subtype:o.subtype,message:`speed propensity "${String(l)}" does not match bestiary "${o.bestiary.stats.speed}"`});const u=ml(a,"body"),f=ml(a,"mind"),p=ml(a,"instinct");(u===void 0||f===void 0||p===void 0||u!==o.bestiary.trinity.body||f!==o.bestiary.trinity.mind||p!==o.bestiary.trinity.instinct)&&t.push({code:"TRINITY_PROPENSITY_MISMATCH",subtype:o.subtype,message:`trinity propensities {body:${String(u)}, mind:${String(f)}, instinct:${String(p)}} do not match bestiary {body:${o.bestiary.trinity.body}, mind:${o.bestiary.trinity.mind}, instinct:${o.bestiary.trinity.instinct}}`});const m=o.runtimeSkills.base,y=o.runtimeSkills.passive;Iy(a.skillLoadout.baseSkillIds,m)||t.push({code:"BASE_SKILL_LOADOUT_MISMATCH",subtype:o.subtype,message:`baseSkillIds ${JSON.stringify(a.skillLoadout.baseSkillIds)} do not match runtimeSkills.base ${JSON.stringify(m)}`});const b=a.skillLoadout.passiveSkillIds||[];Iy(b,y)||t.push({code:"PASSIVE_SKILL_LOADOUT_MISMATCH",subtype:o.subtype,message:`passiveSkillIds ${JSON.stringify(b)} do not match runtimeSkills.passive ${JSON.stringify(y)}`})}return t},fA=e=>{const t=dA(e);if(t.length===0)return;const s=t.map(o=>`[${o.code}] ${o.subtype}: ${o.message}`).join(" | ");throw new Error(`Enemy content consistency validation failed: ${s}`)},we={getTileAt(e,t){const s=ce(t);let o;return e.tiles&&(e.tiles instanceof Map?o=e.tiles.get(s):Array.isArray(e.tiles)?o=e.tiles.find(a=>Array.isArray(a)&&a[0]===s||a.position&&J(a.position,t)):o=e.tiles[s]),o||{position:t,baseId:"STONE",traits:new Set(["WALKABLE"]),effects:[]}},getTraitsForTile(e,t){const s=new Set,o=t.position;return Zi(o,e.gridWidth,e.gridHeight)?(t.baseId==="LAVA"&&(s.add("HAZARDOUS"),s.add("LIQUID"),s.add("LAVA")),t.baseId==="WALL"&&(s.add("BLOCKS_MOVEMENT"),s.add("BLOCKS_LOS"),s.add("ANCHOR")),t.traits.forEach(l=>s.add(l)),t.effects.forEach(l=>{l.id==="FIRE"&&(s.add("FIRE"),s.add("HAZARDOUS")),l.id==="ICE_WALL"&&(s.add("BLOCKS_MOVEMENT"),s.add("BLOCKS_LOS"),s.add("ANCHOR")),l.id==="SMOKE"&&s.add("BLOCKS_LOS")}),s):(s.add("BLOCKS_MOVEMENT"),s.add("BLOCKS_LOS"),s.add("ANCHOR"),s)},getTraitsAt(e,t){const s=this.getTileAt(e,t);return this.getTraitsForTile(e,s)},isPassable(e,t){const s=this.getTraitsAt(e,t);return!s.has("BLOCKS_MOVEMENT")&&!s.has("HAZARDOUS")},isWalkable(e,t){return!this.getTraitsAt(e,t).has("BLOCKS_MOVEMENT")},isLosBlocking(e,t){return this.getTraitsAt(e,t).has("BLOCKS_LOS")},isAnchorable(e,t){return this.getTraitsAt(e,t).has("ANCHOR")},hasTrait(e,t,s){return this.getTraitsAt(e,t).has(s)}},mA=(e,t)=>Array(t).fill(0n),Td=(e,t,s)=>{if(!Number.isInteger(t.q)||!Number.isInteger(t.r))return[...e];if(t.r<0||t.r>=e.length||t.q<0)return[...e];const o=[...e];return o[t.r]|=1n<<BigInt(t.q),o},Wd=(e,t)=>t.r<0||t.r>=e.length?!0:(e[t.r]&1n<<BigInt(t.q))!==0n,Ly=(e,t)=>{if(t.playerStart&&J(e,t.playerStart)||t.stairsPosition&&J(e,t.stairsPosition)||t.shrinePosition&&J(e,t.shrinePosition))return!0;if(t.tiles){const s=we.getTraitsAt(t,e);if(s.has("HAZARDOUS")||s.has("BLOCKS_MOVEMENT"))return!0}return!1},Pn=(e,t)=>{if(e)return e.find(s=>s&&s.position&&J(s.position,t))},ye=(e,t)=>J(e.player.position,t)?e.player:Pn(e.enemies,t),pA=(e,t)=>!!e.shrinePosition&&J(t,e.shrinePosition),hA=(e,t)=>!(!J(t,e.stairsPosition)||e.enemies.some(o=>o.subtype==="sentinel"&&o.hp>0)),yA=(e,t,s,o)=>{const a=fe(s,o);if(a===0)return[];const l=(o.q-s.q)/a,u=(o.r-s.r)/a,f=(o.s-s.s)/a,p=[],m=new Set,y=2;for(let b=1;b<=y;b++){const v={q:o.q+Math.round(l*b),r:o.r+Math.round(u*b),s:o.s+Math.round(f*b)};if(Zi(v,e.gridWidth,e.gridHeight)){const T=`${v.q},${v.r}`;m.has(T)||(m.add(T),p.push(v))}}return p},Ed=(e,t,s)=>Math.max(t,Math.min(s,e)),Io=e=>Math.round(e*1e3)/1e3,mf=e=>{const t=Math.max(0,e.body),s=Math.max(0,e.mind),o=Math.max(0,e.instinct);return{bodyDamageMultiplier:Io(1+t/20),bodyMitigation:Io(Ed(t*.01,0,.5)),mindStatusDurationBonus:Math.floor(s/15),mindMagicMultiplier:Io(1+s/20),instinctInitiativeBonus:o*2,instinctCriticalMultiplier:Io(1+Ed(o,0,10)*.02),instinctSparkDiscountMultiplier:Io(1-Ed(o,0,100)/100)}},tc=e=>{const t=Math.max(0,e.body),s=Math.max(0,e.mind),o=Math.max(0,e.instinct),a={base:0,body:5,mind:2,instinct:3},l=Math.floor(t*a.body+s*a.mind+o*a.instinct+a.base);return Math.max(1,l)},Ot={body:0,mind:0,instinct:0},gA=e=>({body:e.body,mind:e.mind,instinct:e.instinct}),Ea=e=>{const t={};for(const[s,o]of Object.entries(e))t[s]=gA(o);return t},bA={neutral:{id:"neutral",default:Ot,archetype:Ea({VANGUARD:Ot,SKIRMISHER:Ot,FIREMAGE:Ot,NECROMANCER:Ot,HUNTER:Ot,ASSASSIN:Ot}),enemySubtype:Ea({footman:Ot,sprinter:Ot,raider:Ot,pouncer:Ot,shieldBearer:Ot,archer:Ot,bomber:Ot,warlock:Ot,sentinel:Ot}),companionSubtype:Ea({falcon:Ot,skeleton:Ot})},live:{id:"live",default:Ot,archetype:Ea({VANGUARD:{body:9,mind:4,instinct:5},SKIRMISHER:{body:12,mind:8,instinct:14},FIREMAGE:{body:2,mind:9,instinct:4},NECROMANCER:{body:5,mind:9,instinct:5},HUNTER:{body:4,mind:4,instinct:9},ASSASSIN:{body:3,mind:4,instinct:10}}),enemySubtype:Ea({footman:{body:0,mind:0,instinct:0},sprinter:{body:0,mind:0,instinct:0},raider:{body:.4,mind:0,instinct:.2},pouncer:{body:.4,mind:0,instinct:.2},shieldBearer:{body:1,mind:0,instinct:.4},archer:{body:.2,mind:0,instinct:.2},bomber:{body:.4,mind:.2,instinct:.2},warlock:{body:.4,mind:.6,instinct:.2},sentinel:{body:4,mind:2,instinct:2}}),companionSubtype:Ea({falcon:{body:2,mind:2,instinct:9},skeleton:{body:15,mind:1,instinct:4}})}},SA=e=>e?.toLowerCase()==="neutral"?"neutral":"live",vA=()=>globalThis?.process?.env?.HOP_TRINITY_PROFILE,AA=e=>bA[SA(vA())];function Xd(e,t){return e?.get(t)}const Bn={outgoingPhysical:1,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},xA={VANGUARD:Bn,SKIRMISHER:Bn,FIREMAGE:Bn,NECROMANCER:Bn,HUNTER:Bn,ASSASSIN:Bn},TA={footman:{outgoingPhysical:3,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},sprinter:{outgoingPhysical:2.8,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},raider:{outgoingPhysical:3.2,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},pouncer:{outgoingPhysical:3.2,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},shieldBearer:{outgoingPhysical:3.5,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},archer:{outgoingPhysical:2.6,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},bomber:{outgoingPhysical:2.8,outgoingMagical:3,incomingPhysical:1,incomingMagical:1},warlock:{outgoingPhysical:1.5,outgoingMagical:3.5,incomingPhysical:1,incomingMagical:1},sentinel:{outgoingPhysical:4,outgoingMagical:4,incomingPhysical:1,incomingMagical:1}},EA={falcon:{outgoingPhysical:1.2,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},skeleton:{outgoingPhysical:1.1,outgoingMagical:1,incomingPhysical:1,incomingMagical:1}},qo=e=>({outgoingPhysical:e.outgoingPhysical,outgoingMagical:e.outgoingMagical,incomingPhysical:e.incomingPhysical,incomingMagical:e.incomingMagical}),v0=e=>e.type==="player"?qo(xA[(e.archetype||"VANGUARD").toUpperCase()]||Bn):e.companionOf&&e.subtype?qo(EA[e.subtype]||Bn):e.subtype?qo(TA[e.subtype]||Bn):qo(Bn),A0=e=>{const t=Xd(e.components,"combat_profile");return t?{outgoingPhysical:Number.isFinite(t.outgoingPhysical)?t.outgoingPhysical:1,outgoingMagical:Number.isFinite(t.outgoingMagical)?t.outgoingMagical:1,incomingPhysical:Number.isFinite(t.incomingPhysical)?t.incomingPhysical:1,incomingMagical:Number.isFinite(t.incomingMagical)?t.incomingMagical:1}:qo(Bn)},_A=(e,t)=>{const s=A0(e);return t==="magical"?s.outgoingMagical:s.outgoingPhysical},MA=(e,t)=>{const s=A0(e);return t==="magical"?s.incomingMagical:s.incomingPhysical},wA=()=>{const e=Object.entries(Zo).map(([t,s])=>[t,s.bestiary]);return Object.fromEntries(e)},CA=wA(),OA=e=>CA[e],kA=(e,t={})=>{const s=OA(e);return s?t.includePassive??!0?[...s.skills.base,...s.skills.passive]:[...s.skills.base]:[]},Lo=e=>({body:e.body,mind:e.mind,instinct:e.instinct}),x0=e=>{if(e.trinity)return Lo(e.trinity);const t=AA(),s=t.default;if(e.type==="player"){const o=(e.archetype||"VANGUARD").toUpperCase();return Lo(t.archetype[o]||s)}if(e.companionOf&&e.subtype){const o=e.subtype;if(t.companionSubtype[o])return Lo(t.companionSubtype[o])}return e.subtype?Lo(t.enemySubtype[e.subtype]||s):Lo(s)},zo=e=>{const t=new Map(e.components||[]),s=t.has("trinity"),o=t.has("combat_profile"),a=t.has("ailment_profile");if(s&&o&&a)return e;const l=x0({id:e.id,type:e.type,subtype:e.subtype,position:e.position,hp:e.hp,maxHp:e.maxHp,speed:e.speed,factionId:e.factionId,archetype:e.archetype,companionOf:e.companionOf}),u=v0({type:e.type,archetype:e.archetype,subtype:e.subtype,companionOf:e.companionOf});return s||t.set("trinity",{type:"trinity",...l}),o||t.set("combat_profile",{type:"combat_profile",...u}),a||t.set("ailment_profile",{type:"ailment_profile",baseResistancePct:{},resistanceGrowthRate:1}),{...e,components:t}};function NA(e){return e.map(t=>({id:t,name:String(t),description:String(t),slot:"utility",cooldown:0,currentCooldown:0,range:0,upgrades:[],activeUpgrades:[]}))}function Qi(e){const t=e.activeSkills?[...e.activeSkills]:NA(e.skills||[]),s=new Map(e.components||[]),o=x0(e),a=e.combatProfile||v0(e);s.has("trinity")||s.set("trinity",{type:"trinity",...o}),s.has("combat_profile")||s.set("combat_profile",{type:"combat_profile",...a}),s.has("ailment_profile")||s.set("ailment_profile",{type:"ailment_profile",baseResistancePct:{},resistanceGrowthRate:1});const l=tc(o),u=Math.max(1,e.maxHp??l),f=Math.min(u,Math.max(0,e.hp??u));return e.weightClass&&s.set("physics",{type:"physics",weightClass:e.weightClass}),e.archetype&&s.set("archetype",{type:"archetype",archetype:e.archetype}),{id:e.id,type:e.type,subtype:e.subtype,position:e.position,hp:f,maxHp:u,speed:e.speed,factionId:e.factionId,initiative:e.initiative,statusEffects:[],temporaryArmor:0,activeSkills:t,weightClass:e.weightClass,archetype:e.archetype,components:s,isFlying:e.isFlying,companionOf:e.companionOf,isVisible:!0}}function RA(e){const t=Qi({id:e.id,type:"enemy",subtype:e.subtype,position:e.position,hp:e.hp,maxHp:e.maxHp,speed:e.speed,factionId:"enemy",skills:e.skills,weightClass:e.weightClass||"Standard",trinity:e.trinity});return t.enemyType=e.enemyType,t}function T0(e){if(e.companionType==="falcon"){const t=Qi({id:e.id||`falcon-${e.ownerId}`,type:"enemy",subtype:"falcon",position:e.position,speed:95,factionId:"player",skills:["BASIC_MOVE","FALCON_PECK","FALCON_APEX_STRIKE","FALCON_HEAL","FALCON_SCOUT","FALCON_AUTO_ROOST"],weightClass:"Light",isFlying:!0,companionOf:e.ownerId,trinity:e.trinity});return t.companionState={mode:"roost",orbitStep:0},t}return e.companionType==="skeleton"?Qi({id:e.id||`${e.companionType}-${e.ownerId}`,type:"enemy",subtype:"skeleton",position:e.position,hp:2,maxHp:2,speed:50,factionId:"player",skills:["BASIC_MOVE","BASIC_ATTACK","AUTO_ATTACK"],companionOf:e.ownerId,weightClass:"Standard",trinity:e.trinity}):Qi({id:e.id||`${e.companionType}-${e.ownerId}`,type:"enemy",subtype:e.companionType,position:e.position,speed:80,factionId:"player",skills:["BASIC_MOVE","BASIC_ATTACK"],companionOf:e.ownerId,weightClass:"Standard",trinity:e.trinity})}function IA(e){return T0({companionType:"falcon",ownerId:e.ownerId,position:e.position})}function LA(e){const t=kA(e);return t.length>0?t:["BASIC_MOVE"]}class By extends Error{issues;constructor(t,s){super(`${t} validation failed:
${s.map(o=>`${o.path}: ${o.message}`).join(`
`)}`),this.name="ContractValidationError",this.issues=s}}const Et=e=>typeof e=="object"&&e!==null&&!Array.isArray(e),pi=e=>typeof e=="number"&&Number.isFinite(e),In=e=>Number.isInteger(e),Ge=e=>typeof e=="string",de=(e,t,s)=>e.push({path:t,message:s}),BA=e=>{if(!Ge(e))return e;try{return JSON.parse(e)}catch(t){throw new Error(`Invalid JSON: ${t.message}`)}},Vo=(e,t,s,o={})=>{if(!Array.isArray(e))return de(t,s,"Expected array");const a=new Set;o.nonEmpty&&e.length===0&&de(t,s,"Must not be empty"),e.forEach((l,u)=>{if(!Ge(l)||l.length===0)return de(t,`${s}[${u}]`,"Expected non-empty string");o.unique&&(a.has(l)&&de(t,`${s}[${u}]`,`Duplicate "${l}"`),a.add(l))})},Py=(e,t,s)=>{if(!Et(e))return de(t,s,"Expected object");pi(e.base)||de(t,`${s}.base`,"Expected number"),e.min!==void 0&&!pi(e.min)&&de(t,`${s}.min`,"Expected number"),e.max!==void 0&&!pi(e.max)&&de(t,`${s}.max`,"Expected number"),pi(e.min)&&pi(e.max)&&e.min>e.max&&de(t,s,"min must be <= max")},PA=(e,t,s)=>Et(e)?((!Ge(e.id)||e.id.length===0)&&de(t,`${s}.id`,"Expected non-empty string"),Vo(e.tags,t,`${s}.tags`,{nonEmpty:!0,unique:!0}),Ge(e.kind)?e.kind==="DEAL_DAMAGE"?(Py(e.amount,t,`${s}.amount`),(!Et(e.target)||!Ge(e.target.selector))&&de(t,`${s}.target`,"Expected selector"),!0):e.kind==="APPLY_STATUS"?((!Ge(e.statusId)||e.statusId.length===0)&&de(t,`${s}.statusId`,"Expected statusId"),(!In(e.duration)||e.duration<0)&&de(t,`${s}.duration`,"Expected integer >= 0"),(!Et(e.target)||!Ge(e.target.selector))&&de(t,`${s}.target`,"Expected selector"),!0):e.kind==="APPLY_FORCE"?Et(e.force)?((!Ge(e.force.mode)||!new Set(["push","pull"]).has(e.force.mode))&&de(t,`${s}.force.mode`,"Expected push|pull"),(!Ge(e.force.direction)||!new Set(["source_to_target","target_to_source"]).has(e.force.direction))&&de(t,`${s}.force.direction`,"Invalid direction"),(!In(e.force.maxDistance)||e.force.maxDistance<0)&&de(t,`${s}.force.maxDistance`,"Expected integer >= 0"),Py(e.force.magnitude,t,`${s}.force.magnitude`),Et(e.force.collision)||de(t,`${s}.force.collision`,"Expected object"),!0):(de(t,`${s}.force`,"Expected object"),!0):e.kind==="MESSAGE"?((!Ge(e.text)||e.text.length===0)&&de(t,`${s}.text`,"Expected non-empty string"),!0):(de(t,`${s}.kind`,"Unknown kind"),!1):(de(t,`${s}.kind`,"Expected kind"),!1)):(de(t,s,"Expected object"),!1),HA=(e,t,s)=>{if(!Et(e))return de(t,s,"Expected object");if(!Ge(e.method))return de(t,`${s}.method`,"Expected method");if(e.method==="fixed"){pi(e.value)||de(t,`${s}.value`,"Expected number");return}if(e.method==="uniform_int"){In(e.min)||de(t,`${s}.min`,"Expected integer"),In(e.max)||de(t,`${s}.max`,"Expected integer"),In(e.min)&&In(e.max)&&e.min>e.max&&de(t,s,"min must be <= max");return}if(e.method==="triangular_int"){In(e.min)||de(t,`${s}.min`,"Expected integer"),In(e.mode)||de(t,`${s}.mode`,"Expected integer"),In(e.max)||de(t,`${s}.max`,"Expected integer");return}if(e.method==="weighted_table"){if(!Array.isArray(e.table)||e.table.length===0)return de(t,`${s}.table`,"Expected non-empty array");e.table.forEach((o,a)=>{if(!Et(o))return de(t,`${s}.table[${a}]`,"Expected object");pi(o.value)||de(t,`${s}.table[${a}].value`,"Expected number"),(!pi(o.weight)||o.weight<=0)&&de(t,`${s}.table[${a}].weight`,"Expected number > 0")});return}de(t,`${s}.method`,"Unknown propensity method")},jA=e=>{const t=[];if(!Et(e))return de(t,"$","Expected object"),t;if((!Ge(e.version)||!/^1\./.test(e.version))&&de(t,"$.version","Expected v1.x"),(!Ge(e.id)||!/^[A-Z0-9_]+$/.test(e.id))&&de(t,"$.id","Expected uppercase id"),(!Ge(e.name)||e.name.length===0)&&de(t,"$.name","Expected non-empty string"),(!Ge(e.actorType)||!new Set(["player","enemy"]).has(e.actorType))&&de(t,"$.actorType","Expected player|enemy"),(!Ge(e.factionId)||e.factionId.length===0)&&de(t,"$.factionId","Expected non-empty string"),(!Et(e.coordSpace)||e.coordSpace.system!=="cube-axial"||e.coordSpace.pointFormat!=="qrs")&&de(t,"$.coordSpace","Expected {system:cube-axial,pointFormat:qrs}"),Et(e.instantiate)?((!Ge(e.instantiate.rngStream)||e.instantiate.rngStream.length===0)&&de(t,"$.instantiate.rngStream","Expected non-empty string"),(!Ge(e.instantiate.counterMode)||!new Set(["consume_global","stateless"]).has(e.instantiate.counterMode))&&de(t,"$.instantiate.counterMode","Expected consume_global|stateless"),Vo(e.instantiate.drawOrder,t,"$.instantiate.drawOrder",{nonEmpty:!0,unique:!0})):de(t,"$.instantiate","Expected object"),!Et(e.propensities))de(t,"$.propensities","Expected object");else{const s=e.propensities;["body","mind","instinct","speed","mass"].forEach(o=>{o in s||de(t,`$.propensities.${o}`,"Missing required propensity")}),Object.entries(s).forEach(([o,a])=>HA(a,t,`$.propensities.${o}`))}return Et(e.skillLoadout)?(Vo(e.skillLoadout.baseSkillIds,t,"$.skillLoadout.baseSkillIds",{nonEmpty:!0,unique:!0}),e.skillLoadout.passiveSkillIds!==void 0&&Vo(e.skillLoadout.passiveSkillIds,t,"$.skillLoadout.passiveSkillIds",{unique:!0})):de(t,"$.skillLoadout","Expected object"),t},DA=e=>{const t=[];return Et(e)?((!Ge(e.version)||!/^1\./.test(e.version))&&de(t,"$.version","Expected v1.x"),(!Ge(e.id)||!/^[A-Z0-9_]+$/.test(e.id))&&de(t,"$.id","Expected uppercase id"),(!Ge(e.name)||e.name.length===0)&&de(t,"$.name","Expected non-empty string"),(!Ge(e.slot)||!new Set(["offensive","defensive","utility","passive"]).has(e.slot))&&de(t,"$.slot","Invalid slot"),Vo(e.keywords,t,"$.keywords",{unique:!0}),Et(e.targeting)?((!Ge(e.targeting.mode)||!new Set(["self","single","line","radius","global"]).has(e.targeting.mode))&&de(t,"$.targeting.mode","Invalid mode"),(!In(e.targeting.range)||e.targeting.range<0)&&de(t,"$.targeting.range","Expected integer >= 0"),typeof e.targeting.requiresLos!="boolean"&&de(t,"$.targeting.requiresLos","Expected boolean"),typeof e.targeting.allowOccupied!="boolean"&&de(t,"$.targeting.allowOccupied","Expected boolean")):de(t,"$.targeting","Expected object"),(!Et(e.stackPolicy)||e.stackPolicy.resolveOrder!=="LIFO")&&de(t,"$.stackPolicy.resolveOrder","MVP requires LIFO"),Et(e.baseAction)?(Et(e.baseAction.costs)?((!pi(e.baseAction.costs.energy)||e.baseAction.costs.energy<0)&&de(t,"$.baseAction.costs.energy","Expected number >= 0"),(!In(e.baseAction.costs.cooldown)||e.baseAction.costs.cooldown<0)&&de(t,"$.baseAction.costs.cooldown","Expected integer >= 0"),typeof e.baseAction.costs.consumesTurn!="boolean"&&de(t,"$.baseAction.costs.consumesTurn","Expected boolean")):de(t,"$.baseAction.costs","Expected object"),!Array.isArray(e.baseAction.effects)||e.baseAction.effects.length===0?de(t,"$.baseAction.effects","Expected non-empty array"):e.baseAction.effects.forEach((s,o)=>PA(s,t,`$.baseAction.effects[${o}]`))):de(t,"$.baseAction","Expected object"),Array.isArray(e.upgrades)?e.upgrades.forEach((s,o)=>{if(!Et(s))return de(t,`$.upgrades[${o}]`,"Expected object");(!Ge(s.id)||!/^[A-Z0-9_]+$/.test(s.id))&&de(t,`$.upgrades[${o}].id`,"Expected uppercase id"),(!Ge(s.name)||s.name.length===0)&&de(t,`$.upgrades[${o}].name`,"Expected non-empty string"),Array.isArray(s.modifiers)||de(t,`$.upgrades[${o}].modifiers`,"Expected array")}):de(t,"$.upgrades","Expected array"),t):(de(t,"$","Expected object"),t)},UA=e=>{const t=BA(e),s=[];if(!Et(t))throw new By("TacticalDataPack",[{path:"$",message:"Expected pack object"}]);if((!Ge(t.version)||!/^1\./.test(t.version))&&s.push({path:"$.version",message:"Expected v1.x string"}),Array.isArray(t.units)?t.units.forEach((o,a)=>{jA(o).forEach(u=>s.push({path:`$.units[${a}]${u.path.slice(1)}`,message:u.message}))}):s.push({path:"$.units",message:"Expected array"}),Array.isArray(t.skills)?t.skills.forEach((o,a)=>{DA(o).forEach(u=>s.push({path:`$.skills[${a}]${u.path.slice(1)}`,message:u.message}))}):s.push({path:"$.skills",message:"Expected array"}),s.length>0)throw new By("TacticalDataPack",s);return t},$A=e=>({definition:e,drawOrder:[...e.instantiate.drawOrder],skillIds:[...e.skillLoadout.baseSkillIds],passiveSkillIds:[...e.skillLoadout.passiveSkillIds||[]]}),qA={Light:3,Standard:5,Heavy:8,Anchored:12,OuterWall:20},zA=e=>({version:"1.0.0",id:e.id,name:e.name,actorType:"enemy",subtype:e.subtype,factionId:"enemy",weightClass:e.weightClass,coordSpace:{system:"cube-axial",pointFormat:"qrs"},instantiate:{rngStream:"enemy.instantiate",seedSalt:e.subtype,counterMode:"consume_global",drawOrder:["body","mind","instinct","speed","mass"],includeRollTrace:!1},propensities:{body:{method:"fixed",value:e.trinity.body},mind:{method:"fixed",value:e.trinity.mind},instinct:{method:"fixed",value:e.trinity.instinct},speed:{method:"fixed",value:e.speed},mass:{method:"fixed",value:qA[e.weightClass]}},derivedStats:{maxHp:{formula:"trinity_hp_v1"}},physics:{collisionPolicy:"crush_damage",crushModel:{baseDamage:0,impulseMultiplier:1,massDivider:1,minDamage:1}},skillLoadout:{baseSkillIds:e.baseSkills,passiveSkillIds:e.passiveSkills||[]},runtimeDefaults:{startingHp:"maxHp",temporaryArmor:0,isVisible:!0}}),fi=e=>{const t=rA(e);if(!t)throw new Error(`Missing MVP enemy content for ${e}`);const s=t.bestiary;return zA({id:t.packUnitId,name:s.name,subtype:s.subtype,weightClass:s.stats.weightClass,speed:s.stats.speed,trinity:s.trinity,baseSkills:t.runtimeSkills.base,passiveSkills:t.runtimeSkills.passive})},VA={version:"1.0.0",id:"SHIELD_BASH_V1",name:"Shield Bash V1",description:"Data-driven migration variant of shield bash.",slot:"offensive",keywords:["Momentum"],intentTags:["damage","control","move"],targeting:{mode:"single",range:1,requiresLos:!0,allowOccupied:!0,deterministicSort:"distance_then_q_then_r"},stackPolicy:{resolveOrder:"LIFO",reactionWindow:"automated",playerPriority:!1,emitTickEvents:!0},baseAction:{costs:{energy:0,cooldown:2,consumesTurn:!0},effects:[{id:"shield_bash_v1_force",kind:"APPLY_FORCE",tags:["movement","momentum"],target:{selector:"targetActor"},force:{mode:"push",direction:"source_to_target",magnitude:{base:2,scaling:[{stat:"body",coefficient:.2}],min:1,round:"floor"},maxDistance:3,collision:{onBlocked:"crush_damage",crushDamage:{base:1,scaling:[{stat:"momentum",coefficient:1}],min:1,round:"floor"}}}},{id:"shield_bash_v1_damage",kind:"DEAL_DAMAGE",tags:["damage","physical"],target:{selector:"targetActor"},amount:{base:2,scaling:[{stat:"body",coefficient:.4}],min:1,round:"floor"},damageClass:"physical",reason:"shield_bash_v1"}]},reactivePassives:[],upgrades:[],inhibit:{filterMode:"exclude_matching_tags",removableTags:["movement","momentum"]},preview:{dryRunEnabled:!0,eventMap:{APPLY_FORCE:"UnitMoved",DEAL_DAMAGE:"DamageTaken"}}},Hy={version:"1.0.0",units:[fi("footman"),fi("sprinter"),fi("raider"),fi("pouncer"),fi("shieldBearer"),fi("archer"),fi("bomber"),fi("warlock"),fi("sentinel")],skills:[VA]},E0={version:"1.0.0",ailments:[{id:"burn",name:"Burn",core:{atk:"mind",def:"resolve",scalingFactor:10,baseDeposit:2,skillMultiplierBase:0},interactions:[{target:"frozen",ratio:1,priority:30,vfx:"SEAR"}],tick:{damage:{base:0,terms:[{variable:"currentCounters",coefficient:.2}],round:"floor",min:0,max:12},decay:{base:1,terms:[{variable:"resiliencePct",coefficient:.03}],round:"floor",min:0,max:6}},thresholds:[{count:20,effectId:"INCINERATED",message:"Incinerated!",bonusDamage:2}],hardening:{tickXpRate:.2,shockXpRate:.8,capPct:85,xpToResistance:1.5}},{id:"wet",name:"Wet",core:{atk:"instinct",def:"body",scalingFactor:12,baseDeposit:2,skillMultiplierBase:0},interactions:[{target:"burn",ratio:1,priority:40,vfx:"STEAM"}],tick:{decay:{base:2,terms:[{variable:"resiliencePct",coefficient:.04}],round:"floor",min:0,max:8}},hardening:{tickXpRate:.08,shockXpRate:.4,capPct:85,xpToResistance:1.8}},{id:"poison",name:"Poison",core:{atk:"int",def:"wis",scalingFactor:8,baseDeposit:1,skillMultiplierBase:0},tick:{damage:{base:0,terms:[{variable:"currentCounters",coefficient:.01},{variable:"maxHp",coefficient:.01}],round:"floor",min:0,max:10},decay:{base:1,terms:[{variable:"resiliencePct",coefficient:.02}],round:"floor",min:0,max:5}},hardening:{tickXpRate:.15,shockXpRate:.25,capPct:85,xpToResistance:1.6}},{id:"frozen",name:"Frozen",core:{atk:"wis",def:"body",scalingFactor:14,baseDeposit:1,skillMultiplierBase:0},tick:{decay:{base:1,terms:[{variable:"resiliencePct",coefficient:.025}],round:"floor",min:0,max:5}},thresholds:[{count:12,effectId:"IMMOBILIZED",message:"Immobilized by frost."}],hardening:{tickXpRate:.12,shockXpRate:.3,capPct:85,xpToResistance:1.7}},{id:"bleed",name:"Bleed",core:{atk:"dex",def:"agi",scalingFactor:10,baseDeposit:1,skillMultiplierBase:0},tick:{damage:{base:0,terms:[{variable:"currentCounters",coefficient:.15}],round:"floor",min:0,max:8},decay:{base:2,terms:[{variable:"resiliencePct",coefficient:.02}],round:"floor",min:0,max:6}},hardening:{tickXpRate:.1,shockXpRate:.35,capPct:85,xpToResistance:1.4}}]},YA=["burn","wet","poison","frozen","bleed"],KA=e=>{const t=[],s=new Map(e.ailments.map(l=>[l.id,l]));return YA.forEach(l=>{s.has(l)||t.push({code:"MISSING_PILOT_AILMENT",message:`Missing pilot ailment definition "${l}"`})}),s.get("burn")?.thresholds?.some(l=>l.effectId==="INCINERATED")||t.push({code:"MISSING_INCINERATED_THRESHOLD",message:"burn thresholds must define INCINERATED entry for pilot behavior."}),$o.MIASMA||t.push({code:"MISSING_MIASMA_TILE_EFFECT",message:"Tile effect registry must include MIASMA for ACAE pilot."}),t},_0=e=>{const t=KA(e);if(t.length!==0)throw new Error(`Ailment content consistency failed: ${t.map(s=>`[${s.code}] ${s.message}`).join(" | ")}`)};class FA extends Error{issues;constructor(t){super(`Ailment catalog validation failed:
${t.map(s=>`${s.path}: ${s.message}`).join(`
`)}`),this.name="AilmentValidationError",this.issues=t}}const mi=e=>typeof e=="object"&&e!==null&&!Array.isArray(e),qt=e=>typeof e=="number"&&Number.isFinite(e),wa=e=>typeof e=="string",jy=e=>["burn","wet","poison","frozen","bleed"].includes(String(e)),Dy=(e,t,s)=>{if(!mi(e)){s.push({path:t,message:"Expected formula object"});return}qt(e.base)||s.push({path:`${t}.base`,message:"Expected number"}),e.terms!==void 0&&(Array.isArray(e.terms)?e.terms.forEach((o,a)=>{if(!mi(o)){s.push({path:`${t}.terms[${a}]`,message:"Expected object"});return}wa(o.variable)||s.push({path:`${t}.terms[${a}].variable`,message:"Expected variable"}),qt(o.coefficient)||s.push({path:`${t}.terms[${a}].coefficient`,message:"Expected number"})}):s.push({path:`${t}.terms`,message:"Expected array"})),e.min!==void 0&&!qt(e.min)&&s.push({path:`${t}.min`,message:"Expected number"}),e.max!==void 0&&!qt(e.max)&&s.push({path:`${t}.max`,message:"Expected number"}),qt(e.min)&&qt(e.max)&&e.min>e.max&&s.push({path:t,message:"min must be <= max"}),e.round!==void 0&&!["none","floor","round","ceil"].includes(String(e.round))&&s.push({path:`${t}.round`,message:"Expected none|floor|round|ceil"})},WA=(e,t,s)=>{const o=`$.ailments[${t}]`;if(!mi(e)){s.push({path:o,message:"Expected object"});return}jy(e.id)||s.push({path:`${o}.id`,message:"Unknown ailment id"}),(!wa(e.name)||e.name.length===0)&&s.push({path:`${o}.name`,message:"Expected non-empty name"}),mi(e.core)?(wa(e.core.atk)||s.push({path:`${o}.core.atk`,message:"Expected stat ref"}),wa(e.core.def)||s.push({path:`${o}.core.def`,message:"Expected stat ref"}),(!qt(e.core.scalingFactor)||e.core.scalingFactor<=0)&&s.push({path:`${o}.core.scalingFactor`,message:"Expected > 0"}),(!qt(e.core.baseDeposit)||e.core.baseDeposit<0)&&s.push({path:`${o}.core.baseDeposit`,message:"Expected >= 0"}),e.core.skillMultiplierBase!==void 0&&!qt(e.core.skillMultiplierBase)&&s.push({path:`${o}.core.skillMultiplierBase`,message:"Expected number"})):s.push({path:`${o}.core`,message:"Expected object"}),e.interactions!==void 0&&(Array.isArray(e.interactions)?e.interactions.forEach((a,l)=>{if(!mi(a)){s.push({path:`${o}.interactions[${l}]`,message:"Expected object"});return}jy(a.target)||s.push({path:`${o}.interactions[${l}].target`,message:"Unknown ailment target"}),(!qt(a.ratio)||a.ratio<=0)&&s.push({path:`${o}.interactions[${l}].ratio`,message:"Expected ratio > 0"}),qt(a.priority)||s.push({path:`${o}.interactions[${l}].priority`,message:"Expected number priority"})}):s.push({path:`${o}.interactions`,message:"Expected array"})),e.tick!==void 0&&(mi(e.tick)?(e.tick.damage!==void 0&&Dy(e.tick.damage,`${o}.tick.damage`,s),e.tick.decay!==void 0&&Dy(e.tick.decay,`${o}.tick.decay`,s)):s.push({path:`${o}.tick`,message:"Expected object"})),e.thresholds!==void 0&&(Array.isArray(e.thresholds)?e.thresholds.forEach((a,l)=>{if(!mi(a)){s.push({path:`${o}.thresholds[${l}]`,message:"Expected object"});return}(!qt(a.count)||a.count<=0)&&s.push({path:`${o}.thresholds[${l}].count`,message:"Expected count > 0"}),(!wa(a.effectId)||a.effectId.length===0)&&s.push({path:`${o}.thresholds[${l}].effectId`,message:"Expected non-empty effectId"}),a.bonusDamage!==void 0&&(!qt(a.bonusDamage)||a.bonusDamage<0)&&s.push({path:`${o}.thresholds[${l}].bonusDamage`,message:"Expected bonusDamage >= 0"})}):s.push({path:`${o}.thresholds`,message:"Expected array"})),mi(e.hardening)?((!qt(e.hardening.tickXpRate)||e.hardening.tickXpRate<0)&&s.push({path:`${o}.hardening.tickXpRate`,message:"Expected >= 0"}),(!qt(e.hardening.shockXpRate)||e.hardening.shockXpRate<0)&&s.push({path:`${o}.hardening.shockXpRate`,message:"Expected >= 0"}),(!qt(e.hardening.capPct)||e.hardening.capPct<0||e.hardening.capPct>100)&&s.push({path:`${o}.hardening.capPct`,message:"Expected 0..100"}),(!qt(e.hardening.xpToResistance)||e.hardening.xpToResistance<=0)&&s.push({path:`${o}.hardening.xpToResistance`,message:"Expected > 0"})):s.push({path:`${o}.hardening`,message:"Expected hardening config"})},XA=(e,t)=>{const s=new Map;e.forEach(u=>{s.set(u.id,(u.interactions||[]).map(f=>f.target))});const o=new Set,a=new Set,l=(u,f)=>{if(a.has(u)){t.push({path:"$.ailments",message:`Annihilation DAG contains cycle: ${[...f,u].join(" -> ")}`});return}if(o.has(u))return;o.add(u),a.add(u),(s.get(u)||[]).forEach(m=>l(m,[...f,u])),a.delete(u)};e.forEach(u=>l(u.id,[]))},GA=e=>{const t=[];if(!mi(e))return[{path:"$",message:"Expected object"}];if((!wa(e.version)||!/^1\./.test(e.version))&&t.push({path:"$.version",message:"Expected v1.x version"}),!Array.isArray(e.ailments)||e.ailments.length===0)return t.push({path:"$.ailments",message:"Expected non-empty ailments array"}),t;if(e.ailments.forEach((a,l)=>WA(a,l,t)),t.length>0)return t;const s=e.ailments,o=new Set;return s.forEach((a,l)=>{o.has(a.id)&&t.push({path:`$.ailments[${l}].id`,message:`Duplicate id "${a.id}"`}),o.add(a.id),(a.interactions||[]).forEach((u,f)=>{!o.has(u.target)&&!s.some(p=>p.id===u.target)&&t.push({path:`$.ailments[${l}].interactions[${f}].target`,message:`Unknown target "${u.target}"`})})}),t.length>0||XA(s,t),t},JA=e=>{const t=GA(e);if(t.length>0)throw new FA(t);return e},QA=e=>{const t={};for(const s of e.ailments)t[s.id]={...s,interactions:[...s.interactions||[]].sort((o,a)=>a.priority-o.priority),thresholds:[...s.thresholds||[]].sort((o,a)=>o.count-a.count),tick:s.tick?{damage:s.tick.damage?{...s.tick.damage,terms:[...s.tick.damage.terms||[]]}:void 0,decay:s.tick.decay?{...s.tick.decay,terms:[...s.tick.decay.terms||[]]}:void 0}:void 0};return{version:e.version,byId:t}},M0=JA(E0);_0(M0);const w0=QA(M0),ql=e=>w0.byId[e],ZA=()=>Object.values(w0.byId),ex=new Map,C0=new Map,tx=e=>(ex.set(e.id,e),e.subtype&&C0.set(e.subtype,e),e),nx=e=>e.map(tx),ix=e=>C0.get(e);function Mn(e,t){const s=e.tiles.get(ce(t));return!!(s?.traits.has("BLOCKS_LOS")||s?.baseId==="WALL")}function Ns(e,t){const s=e.tiles.get(ce(t));return s?.baseId==="LAVA"||s?.traits.has("LIQUID")||!1}function es(e,t,s){const o=ye(e,t);return!!o&&o.id!==s}function bt(e,t,s){const o=fe(e,t);return o>=1&&o<=s}function wn(e,t){const s=Hn(e,t);return{isAxial:s!==-1,directionIndex:s}}function pf(e,t,s={}){const{checkWalls:o=!0,checkActors:a=!0,checkLava:l=!1,excludeActorId:u}=s;for(const f of t){if(o&&Mn(e,f))return{obstacle:"wall",position:f};if(l&&Ns(e,f))return{obstacle:"lava",position:f};if(a){const p=ye(e,f);if(p&&p.id!==u)return{obstacle:"actor",position:f,actor:p}}}return{}}function hf(e,t,s,o={}){const l=Ze(t,s).slice(1),{stopAtWalls:u=!0,stopAtActors:f=!0,stopAtLava:p=!1,excludeActorId:m}=o,y=pf(e,l,{checkWalls:u,checkActors:f,checkLava:p,excludeActorId:m});return y.obstacle&&y.position&&!J(y.position,s)?{isValid:!1,blockedBy:y.obstacle,blockedAt:y.position}:{isValid:!0}}function zl(e,t,s,o,a){const u=Ze(t,s).slice(1),f=pf(e,u,{checkWalls:!0,checkActors:!0,checkLava:!1,excludeActorId:a});return f.obstacle==="actor"&&f.actor?.id===o&&!!f.position&&J(f.position,s)}function sx(e,t){const s=we.getTraitsAt(e,t),o=s.has("HAZARDOUS")||s.has("LAVA")||s.has("FIRE")||s.has("VOID"),a=s.has("LAVA")||s.has("FIRE");return{isHazard:o,isFireHazard:a}}function Si(e,t,s){const{isHazard:o,isFireHazard:a}=sx(e,s);return!!(!o||t.isFlying||(t.activeSkills?.some(u=>u.id==="ABSORB_FIRE")||t.statusEffects?.some(u=>u.type==="fire_immunity"))&&a)}function O0(e,t,s,o){return Si(e,t,s)?!0:new Set(["JUMP","VAULT","GRAPPLE_HOOK","DASH"]).has(o)}const zt=(e,t,s)=>Math.max(t,Math.min(s,e)),Tt=e=>Math.round(e*1e3)/1e3,ax=()=>globalThis?.process?.env?.HOP_COMBAT_INTERACTION_MODEL,ox=e=>e.length===0?1:e.reduce((t,s)=>t*s.multiplier,1),rx=e=>{let t=1;if(e.inDangerPreviewHex&&(t+=.15),typeof e.proximityDistance=="number"){const s=zt(e.proximityDistance,0,6);t+=(6-s)*.02}return t},lx=(e,t,s,o,a,l,u,f)=>{if(!t)return{multiplier:1,pressure:0,rangePressure:0,rangeMultiplier:1};const p=s==="physical"?.85+e.instinct*.015+e.body*.005:.85+e.mind*.015+e.instinct*.005,m=s==="physical"?t.instinct*.012+t.body*.004:t.instinct*.008+t.mind*.008,y=zt(p-m,.1,.99);if(typeof o!="number")return{multiplier:y,pressure:Tt(p-m),rangePressure:0,rangeMultiplier:1};const b={min:zt(a??(s==="physical"?1:2),1,6),max:zt(l??(s==="physical"?2:4),1,6)};if(b.max<b.min){const O=b.min;b.min=b.max,b.max=O}const v={min:zt(u??(s==="physical"?1:2),1,6),max:zt(f??(s==="physical"?3:5),1,6)};if(v.max<v.min){const O=v.min;v.min=v.max,v.max=O}const T=zt(o,1,6),S=Math.max(0,b.min-T),x=Math.max(0,T-b.max),_=S*.06+x*.1,E=e.instinct*.015,w=(T>=v.min&&T<=v.max?.05:0)+t.instinct*.006,M=E-_-w,k=zt(1+M,.55,1.25);return{multiplier:zt(y*k,.05,.99),pressure:Tt(p-m),rangePressure:Tt(M),rangeMultiplier:Tt(k)}},cx=(e,t)=>{if(!e)return{multiplier:1,pressure:0};const s=zt(t==="physical"?e.body*.01+e.instinct*.004:e.mind*.01+e.instinct*.004,0,.75);return{multiplier:1-s,pressure:Tt(s)}},ux=(e,t,s,o)=>{if(!t)return{multiplier:o,critPressure:0,resistancePressure:0};const a=zt(s==="physical"?.05+e.instinct*.01:.05+e.mind*.01,0,.75),l=zt(s==="physical"?t.body*.006+t.instinct*.004:t.mind*.006+t.instinct*.004,0,.7);return{multiplier:1+zt(a-l,0,.75)*(o-1),critPressure:Tt(a),resistancePressure:Tt(l)}},dx=(e,t,s,o,a)=>{const l=e.scaling.filter(b=>b.attribute==="body").reduce((b,v)=>b+(e.trinity.body||0)*v.coefficient,0),u=e.scaling.filter(b=>b.attribute==="mind").reduce((b,v)=>b+(e.trinity.mind||0)*v.coefficient,0),f=e.scaling.filter(b=>b.attribute==="instinct").reduce((b,v)=>b+(e.trinity.instinct||0)*v.coefficient,0),p=e.damageClass==="physical"?Math.max(0,e.basePower*(t.bodyDamageMultiplier-1)):0,m=e.damageClass==="magical"?Math.max(0,e.basePower*(t.mindMagicMultiplier-1)):0,y=Math.max(0,(a-1)*(s+o));return{body:Math.max(0,p+l),mind:Math.max(0,m+u),instinct:Math.max(0,f+y)}},fx=(e,t)=>{if(e<=0)return e;const s=mf(t).mindStatusDurationBonus;return e+s},mx=e=>mf(e).instinctInitiativeBonus,_t=e=>{const t=mf(e.trinity),s=e.damageClass||"physical",o=ax()==="triangle"?"triangle":"legacy",a=e.interactionModel||o,l=s==="magical"?t.mindMagicMultiplier:t.bodyDamageMultiplier,u=e.basePower*l,f=e.scaling.reduce((I,D)=>{const j=e.trinity[D.attribute]||0;return I+j*D.coefficient},0),p=ox(e.statusMultipliers),m=rx(e),y=t.instinctCriticalMultiplier,b=a==="triangle"?lx(e.trinity,e.targetTrinity,s,e.engagementRange,e.optimalRangeMin,e.optimalRangeMax,e.targetOptimalRangeMin,e.targetOptimalRangeMax):{multiplier:1,pressure:0,rangePressure:0,rangeMultiplier:1},v=a==="triangle"?cx(e.targetTrinity,s):{multiplier:1,pressure:0},T=a==="triangle"?ux(e.trinity,e.targetTrinity,s,y):{multiplier:y,critPressure:0,resistancePressure:0},S=(u+f)*p*m*b.multiplier*v.multiplier*T.multiplier*(e.attackPowerMultiplier??1)*(e.targetDamageTakenMultiplier??1),x=Math.max(0,Math.floor(S)),_=dx(e,t,u,f,y),E=Math.max(1e-6,_.body+_.mind+_.instinct),w=Tt(_.body/E),M=Tt(_.mind/E),k=Tt(_.instinct/E),R=Math.max(1,e.theoreticalMaxPower??S),O=zt(x/R,0,1);return{basePower:e.basePower,bodyScaledPower:Tt(u),scalingPower:Tt(f),statusMultiplier:Tt(p),riskMultiplier:Tt(m),criticalMultiplier:Tt(y),hitMultiplier:Tt(b.multiplier),rangeMultiplier:Tt(b.rangeMultiplier),mitigationMultiplier:Tt(v.multiplier),critExpectedMultiplier:Tt(T.multiplier),finalPower:x,bodyContribution:w,mindContribution:M,instinctContribution:k,scoreEvent:{skillId:e.skillId,attackerId:e.attackerId,targetId:e.targetId,finalPower:x,efficiency:Tt(O),riskBonusApplied:!!e.inDangerPreviewHex,damageClass:s,hitPressure:b.pressure,rangePressure:b.rangePressure,mitigationPressure:v.pressure,critPressure:T.critPressure,resistancePressure:T.resistancePressure,bodyContribution:w,mindContribution:M,instinctContribution:k}}},Oe=e=>{const t=Xd(e.components,"trinity");if(t)return{body:t.body,mind:t.mind,instinct:t.instinct};const s=Xd(e.components,"stats"),o=s?.strength??0,a=s?.defense??0,l=s?.evasion??0;return{body:o,mind:a,instinct:l}},px=(e,t)=>e.player.id===t?e.player:e.enemies.find(s=>s.id===t)||e.companions?.find(s=>s.id===t),hx=(e,t,s)=>!!(e.player.id!==s&&J(e.player.position,t)||e.enemies.some(o=>o.id!==s&&o.hp>0&&J(o.position,t))||e.companions?.some(o=>o.id!==s&&o.hp>0&&J(o.position,t))),Uy=(e,t)=>{const s={q:t.q-e.q,r:t.r-e.r,s:t.s-e.s};let o=Ko[0],a=Number.NEGATIVE_INFINITY;for(const l of Ko){const u=l.q*s.q+l.r*s.r+l.s*s.s;u>a&&(a=u,o=l)}return o},yx=(e,t)=>{const s=px(e,t.targetActorId);if(!s)return{effects:[],destination:null,collided:!1};const o=Math.max(0,Math.min(t.maxDistance,Math.floor(t.magnitude)));if(o<=0)return{effects:[],destination:s.position,collided:!1};const a=s.position,l=t.mode==="push"?Uy(t.source,a):Uy(a,t.source),u=[a];let f=a,p=!1;for(let y=0;y<o;y++){const b=Kt(f,l);if(!we.isWalkable(e,b)||hx(e,b,s.id)){p=!0;break}u.push(b),f=b}const m=[];return J(f,a)||m.push({type:"Displacement",target:s.id,destination:f,path:u,simulatePath:!0}),p&&t.collision.onBlocked==="crush_damage"&&m.push({type:"Damage",target:s.id,amount:Math.max(0,Math.floor(t.collision.crushDamage??0)),reason:t.damageReason||"crush"}),{effects:m,destination:f,collided:p}},pl=e=>JSON.parse(JSON.stringify(e)),gx=(e,t)=>t==="floor"?Math.floor(e):t==="round"?Math.round(e):t==="ceil"?Math.ceil(e):e,_d=(e,t)=>{let s=e.base;for(const o of e.scaling||[])s+=(t[o.stat]??0)*o.coefficient;return s=gx(s,e.round),e.min!==void 0&&(s=Math.max(e.min,s)),e.max!==void 0&&(s=Math.min(e.max,s)),s},bx=(e,t,s,o)=>{const a=t.split(".");let l=e;for(let p=0;p<a.length-1;p++){const m=a[p],y=l[m];if(!y||typeof y!="object")return;l=y}const u=a[a.length-1],f=Number(l[u]);Number.isFinite(f)&&(s==="set"&&(l[u]=o),s==="add"&&(l[u]=f+o),s==="multiply"&&(l[u]=f*o))},Sx=(e,t,s)=>{let o=pl(e.baseAction.effects);const a=pl(e.reactivePassives||[]),l=new Set(e.keywords),u={};for(const f of e.upgrades)u[f.id]=f;for(const f of t){const p=u[f];if(p)for(const m of p.modifiers){if(m.op==="add_effect"&&o.push(pl(m.effect)),m.op==="remove_effect_by_tag"&&(o=o.filter(y=>!y.tags.includes(m.tag))),m.op==="modify_number"){const y=o.find(b=>b.id===m.effectId);y&&bx(y,m.field,m.mode,m.value)}m.op==="add_keyword"&&l.add(m.keyword),m.op==="remove_keyword"&&l.delete(m.keyword),m.op==="add_reaction"&&a.push(pl(m.reaction))}}return e.inhibit?.filterMode==="exclude_matching_tags"&&s.size>0&&(o=o.filter(f=>!f.tags.some(p=>s.has(p)))),{effects:o,reactions:a,keywords:l}},vx=(e,t)=>{const s=Oe(e),o=Number(t?.momentum??0),a=Number(t?.mass??1);return{body:s.body,mind:s.mind,instinct:s.instinct,mass:Number.isFinite(a)?a:1,speed:e.speed||1,momentum:Number.isFinite(o)?o:0}},Md=(e,t)=>t?ye(e,t)?.id:void 0,Ax=(e,t,s,o,a)=>{if(o.kind==="MESSAGE")return[{type:"Message",text:o.text}];if(o.kind==="DEAL_DAMAGE"){const p=Math.max(0,Math.floor(_d(o.amount,a))),m=Md(e,s);return[{type:"Damage",target:o.target.selector==="targetActor"?m||"targetActor":o.target.selector==="self"?t.id:s||"targetActor",amount:p,reason:o.reason}]}if(o.kind==="APPLY_STATUS"){const p=Md(e,s);return[{type:"ApplyStatus",target:o.target.selector==="targetActor"?p||"targetActor":o.target.selector==="self"?t.id:s||"targetActor",status:o.statusId,duration:o.duration}]}const l=Md(e,s);if(!l)return[];const u=_d(o.force.magnitude,a),f=o.force.collision.crushDamage?_d(o.force.collision.crushDamage,a):0;return yx(e,{source:t.position,targetActorId:l,mode:o.force.mode,magnitude:u,maxDistance:o.force.maxDistance,collision:{onBlocked:o.force.collision.onBlocked,crushDamage:f}}).effects},xx=(e,t,s,o)=>{const a=[];for(let l=0;l<e.gridWidth;l++)for(let u=0;u<e.gridHeight;u++){const f=Xt(l,u);Zi(f,e.gridWidth,e.gridHeight)&&fe(t,f)<=s&&a.push(f)}return a.sort((l,u)=>{if(o==="q_then_r")return l.q===u.q?l.r-u.r:l.q-u.q;if(o==="r_then_q")return l.r===u.r?l.q-u.q:l.r-u.r;const f=fe(t,l),p=fe(t,u);return f!==p?f-p:l.q===u.q?l.r-u.r:l.q-u.q}),a},Tx=e=>{const t=e.baseAction.effects.find(a=>a.kind==="DEAL_DAMAGE"),s=e.baseAction.effects.find(a=>a.kind==="APPLY_FORCE"),o={};return e.upgrades.forEach(a=>{o[a.id]={id:a.id,name:a.name,description:a.description||a.name}}),{id:e.id,name:e.name,description:e.description||e.name,slot:e.slot,icon:"data-driven",baseVariables:{range:e.targeting.range,cost:e.baseAction.costs.energy,cooldown:e.baseAction.costs.cooldown,damage:t?.amount?.base,momentum:s?.force?.magnitude?.base},execute:(a,l,u,f=[],p={})=>{const m=new Set(p.inhibitTags||[]),y=Sx(e,f,m),b=vx(l,p),T=[...(y.reactions||[]).filter(x=>x.trigger==="ON_DECLARE").flatMap(x=>x.effects),...y.effects],S=[];for(const x of T)S.push(...Ax(a,l,u,x,b));return{effects:S,messages:[],consumesTurn:e.baseAction.costs.consumesTurn}},getValidTargets:(a,l)=>{if(e.targeting.mode==="self")return[l];let u=xx(a,l,e.targeting.range,e.targeting.deterministicSort);return(e.targeting.mode==="single"||e.targeting.mode==="radius"||e.targeting.mode==="line")&&(e.targeting.requiresLos&&(u=u.filter(f=>hf(a,l,f).isValid)),e.targeting.allowOccupied||(u=u.filter(f=>!ye(a,f)))),u},upgrades:o}},Ex=new Map,k0=new Map,_x=e=>{const t=Tx(e);return Ex.set(e.id,e),k0.set(e.id,t),t},Mx=e=>e.map(_x),wx=()=>{const e={};for(const[t,s]of k0.entries())e[t]=s;return e},Ki=(e,t)=>e.includes(t),Cx=e=>{const t=new Set,s=e.id;return((e.baseVariables.damage||0)>0||/(ATTACK|THROW|BLAST|FIREBALL|BASH|PECK|EXPLOSION|SPEAR|SHOOT)/.test(s))&&t.add("damage"),/(MOVE|DASH|JUMP|ROLL|VAULT|STEP|GRAPPLE|WITHDRAWAL|WALK)/.test(s)&&t.add("move"),/(HEAL|ABSORB)/.test(s)&&t.add("heal"),/(SHIELD|PROTECT|BULWARK)/.test(s)&&t.add("protect"),/(STUN|TRAP|SMOKE|TELEGRAPH|ROOT|SWAP|SCOUT)/.test(s)&&t.add("control"),/(RAISE|FALCON|SUMMON)/.test(s)&&t.add("summon"),/(FIRE|LAVA|HAZARD|TRAP)/.test(s)&&t.add("hazard"),e.slot==="offensive"&&t.add("damage"),e.slot==="defensive"&&t.add("protect"),e.slot==="utility"&&t.add("utility"),(e.baseVariables.cooldown>0||e.baseVariables.cost>0)&&t.add("economy"),t.size||t.add("utility"),[...t]},Ox={BASIC_MOVE:{intentTags:["move","objective","utility"],target:{pattern:"single"},estimates:{movement:1}},BASIC_ATTACK:{intentTags:["damage"],target:{pattern:"single"},estimates:{damage:4}},AUTO_ATTACK:{intentTags:["damage","utility"],target:{pattern:"single"},estimates:{damage:2}},DASH:{intentTags:["move","damage","utility"],target:{pattern:"line"},estimates:{movement:2,damage:2},risk:{noProgressCastPenalty:5}},JUMP:{intentTags:["move","utility"],target:{pattern:"single"},estimates:{movement:2},risk:{noProgressCastPenalty:6}},SHIELD_BASH:{intentTags:["damage","control","protect"],target:{pattern:"single"},estimates:{damage:3,control:2},risk:{requireEnemyContact:!0,noContactPenalty:5,noProgressCastPenalty:7}},BULWARK_CHARGE:{intentTags:["move","protect","damage"],target:{pattern:"line"},estimates:{movement:2,damage:4,shielding:2}},VAULT:{intentTags:["move","damage","utility"],target:{pattern:"single"},estimates:{movement:2,control:1,damage:3},risk:{noProgressCastPenalty:10}},GRAPPLE_HOOK:{intentTags:["move","control","damage","utility"],target:{pattern:"line"},estimates:{movement:2,control:1,damage:4},risk:{noProgressCastPenalty:10}},SHIELD_THROW:{intentTags:["damage","control","utility"],target:{pattern:"line"},estimates:{damage:10,control:2},risk:{requireEnemyContact:!0,noContactPenalty:6,noProgressCastPenalty:10}},SPEAR_THROW:{intentTags:["damage"],target:{pattern:"line"},estimates:{damage:5},risk:{requireEnemyContact:!0,noContactPenalty:4,noProgressCastPenalty:5}},ARCHER_SHOT:{intentTags:["damage"],target:{pattern:"line"},estimates:{damage:2},risk:{requireEnemyContact:!0,noContactPenalty:4,noProgressCastPenalty:4}},FIREBALL:{intentTags:["damage","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{damage:5,control:1}},FIREWALL:{intentTags:["hazard","control","damage"],target:{pattern:"radius",aoeRadius:2},estimates:{damage:5,control:3}},FIREWALK:{intentTags:["move","hazard","utility"],target:{pattern:"single"},estimates:{movement:3},risk:{noProgressCastPenalty:8}},ABSORB_FIRE:{intentTags:["heal","hazard","utility"],target:{pattern:"self"},estimates:{healing:6},risk:{noProgressCastPenalty:2}},BOMB_TOSS:{intentTags:["damage","control","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{damage:6,control:2}},TIME_BOMB:{intentTags:["damage","hazard","utility"],target:{pattern:"self"},estimates:{damage:6,control:1}},CORPSE_EXPLOSION:{intentTags:["damage","control","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{damage:6,control:1}},RAISE_DEAD:{intentTags:["summon","control","utility"],target:{pattern:"single"},estimates:{summon:5}},SOUL_SWAP:{intentTags:["move","control","utility"],target:{pattern:"single"},estimates:{movement:2,control:2}},MULTI_SHOOT:{intentTags:["damage"],target:{pattern:"line"},estimates:{damage:5}},SET_TRAP:{intentTags:["control","hazard"],target:{pattern:"single"},estimates:{control:3}},SWIFT_ROLL:{intentTags:["move","utility"],target:{pattern:"single"},estimates:{movement:2}},SNEAK_ATTACK:{intentTags:["damage","move","utility"],target:{pattern:"single"},estimates:{damage:14,movement:1},risk:{requireEnemyContact:!0,noContactPenalty:2,noProgressCastPenalty:3}},SMOKE_SCREEN:{intentTags:["control","protect","utility"],target:{pattern:"radius",aoeRadius:1},estimates:{control:0,shielding:1},risk:{noProgressCastPenalty:100}},SHADOW_STEP:{intentTags:["move","utility"],target:{pattern:"single"},estimates:{movement:0,control:0},risk:{noProgressCastPenalty:100}},FALCON_COMMAND:{intentTags:["summon","control","damage","utility"],target:{pattern:"single"},estimates:{summon:1,control:0,damage:2},risk:{noProgressCastPenalty:30}},FALCON_PECK:{intentTags:["damage"],target:{pattern:"single"},estimates:{damage:3}},FALCON_APEX_STRIKE:{intentTags:["damage","control"],target:{pattern:"single"},estimates:{damage:5,control:1}},FALCON_HEAL:{intentTags:["heal","utility"],target:{pattern:"single"},estimates:{healing:4}},FALCON_SCOUT:{intentTags:["control","utility"],target:{pattern:"self"},estimates:{control:3}},FALCON_AUTO_ROOST:{intentTags:["summon","utility"],target:{pattern:"self"},estimates:{summon:2}},KINETIC_TRI_TRAP:{intentTags:["control","hazard","damage"],target:{pattern:"radius",aoeRadius:1},estimates:{control:2,damage:2},risk:{noProgressCastPenalty:40}},WITHDRAWAL:{intentTags:["move","damage","utility"],target:{pattern:"single"},estimates:{movement:0,control:0,damage:2},risk:{noProgressCastPenalty:40}},SENTINEL_TELEGRAPH:{intentTags:["control","objective"],target:{pattern:"radius",aoeRadius:2},estimates:{control:3}},SENTINEL_BLAST:{intentTags:["damage","hazard"],target:{pattern:"radius",aoeRadius:2},estimates:{damage:7}},THEME_HAZARDS:{intentTags:["hazard","control"],target:{pattern:"global"},estimates:{control:2}}},kx=(e,t)=>t?{...e,...t,target:{...e.target,...t.target||{}},estimates:{...e.estimates,...t.estimates||{}},economy:{...e.economy,...t.economy||{}},risk:{...e.risk,...t.risk||{}}}:e,Nx=e=>{const t=Cx(e),s=(Ki(t,"move"),"single"),o={id:e.id,intentTags:t,target:{range:Math.max(0,e.baseVariables.range||0),pattern:s},estimates:{damage:Math.max(0,e.baseVariables.damage||0),movement:Ki(t,"move")?Math.max(1,Math.min(3,e.baseVariables.range||1)):0,healing:Ki(t,"heal")?2:0,shielding:Ki(t,"protect")?1:0,control:Ki(t,"control")?1:0,summon:Ki(t,"summon")?1:0},economy:{cost:Math.max(0,e.baseVariables.cost||0),cooldown:Math.max(0,e.baseVariables.cooldown||0),consumesTurn:!0},risk:{selfExposure:Ki(t,"move")?.5:0,hazardAffinity:Ki(t,"hazard")?.5:0},complexity:1};return kx(o,Ox[e.id])},Rx=e=>{const t=[];return(!e.intentTags||e.intentTags.length===0)&&t.push("intentTags must not be empty"),(!Number.isFinite(e.target.range)||e.target.range<0)&&t.push("target.range must be >= 0"),e.target.pattern||t.push("target.pattern is required"),(!Number.isFinite(e.economy.cooldown)||e.economy.cooldown<0)&&t.push("economy.cooldown must be >= 0"),(!Number.isFinite(e.economy.cost)||e.economy.cost<0)&&t.push("economy.cost must be >= 0"),(!Number.isFinite(e.complexity)||e.complexity<0)&&t.push("complexity must be >= 0"),t},Ix=e=>{const t=[],s=[];for(const[o,a]of Object.entries(e)){const l=a.intentProfile||Nx(a);a.intentProfile=l;const u=Rx(l);u.length>0&&s.push({skillId:o,errors:u}),l||t.push(o)}return{missing:t,invalid:s}},Lx={id:"ABSORB_FIRE",name:"Absorb Fire",description:"Fire heals you instead of harming you.",slot:"passive",icon:"",baseVariables:{cost:0,cooldown:0,range:0},execute:(e,t,s)=>({effects:[],messages:[]}),getValidTargets:()=>[],upgrades:{}},Bx={id:"grapple_hook",name:"Grapple Hook",description:"Tests for grapple hook mechanics including LoS, lava sinking, and weight-based behavior",scenarios:[{id:"hook_lava_intercept",title:"Lava Interceptor & LoS",description:"Verify LoS blocking and Lava killing targets.",relatedSkills:["GRAPPLE_HOOK"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["lava","line-of-sight","displacement"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},["GRAPPLE_HOOK"]),e.spawnEnemy("footman",{q:4,r:4,s:-8},"target1"),e.spawnEnemy("footman",{q:7,r:3,s:-10},"hidden"),e.setTile({q:6,r:4,s:-10},"wall"),e.setTile({q:4,r:5,s:-9},"lava")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:7,r:3,s:-10}),e.useSkill("GRAPPLE_HOOK",{q:4,r:4,s:-8}),e.wait(),e.wait()},verify:(e,t)=>{const s=e.player,o=e.enemies.find(l=>l.id==="target1"),a={playerInOriginalPosition:s.position.q===4&&s.position.r===6&&s.position.s===-10,target1Dead:!o,losWarning:t.some(l=>l.includes("Line of sight"))};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Failed Details:",a),console.log("Logs:",t)),Object.values(a).every(l=>l===!0)}},{id:"hook_wall_anchor_zip",title:"Heavy Zip to Wall",description:"Verify zipping to a wall and stunning nearby enemies.",relatedSkills:["GRAPPLE_HOOK"],category:"movement",difficulty:"beginner",isTutorial:!0,tags:["wall","displacement","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["GRAPPLE_HOOK"]),e.setTile({q:6,r:3,s:-9},"wall"),e.spawnEnemy("footman",{q:5,r:4,s:-9},"blocker"),e.setTile({q:6,r:6,s:-12},"wall"),e.setTile({q:5,r:6,s:-11},"lava"),e.spawnEnemy("footman",{q:6,r:5,s:-11},"stunMe"),e.spawnEnemy("footman",{q:7,r:5,s:-12},"noStun")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:6,r:3,s:-9}),e.useSkill("GRAPPLE_HOOK",{q:6,r:6,s:-12})},verify:(e,t)=>{const s=e.enemies.find(l=>l.id==="stunMe"),o=e.enemies.find(l=>l.id==="noStun"),a={stunnedEnemy:!!(s&&s.statusEffects.some(l=>l.type==="stunned")),safeEnemy:!!(o&&!o.statusEffects.some(l=>l.type==="stunned")),zipLog:t.some(l=>l.includes("Zipped")),lavaSinkLog:t.some(l=>l.includes("Lava Sink"))};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Failed Details:",a),console.log("Player Pos:",e.player.position),console.log("Victim Status:",s?.statusEffects)),Object.values(a).every(l=>l===!0)}}]},Px={id:"shield_throw",name:"Shield Throw",description:"Tests for shield throw mechanics including push, stun, and collision behavior",scenarios:[{id:"shield_stun_push",title:"Standard Push",description:"Verify 4-tile push in a straight line.",relatedSkills:["SHIELD_THROW"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["push","displacement","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_THROW"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>e.useSkill("SHIELD_THROW",{q:3,r:5,s:-8}),verify:(e,t)=>{const s=e.enemies.find(a=>a.id==="victim"),o={victimAt1:s?.position.r===1,victimStunned:t?.some(a=>a.includes("stunned"))};return Object.values(o).some(a=>a===!1)&&(console.log(" Shield Throw Failed:",o),console.log("Enemy Pos:",s?.position),console.log("Logs:",t)),Object.values(o).every(a=>a===!0)}},{id:"shield_unit_collision",title:"Unit Collision",description:"Verify push stops when hitting another unit.",relatedSkills:["SHIELD_THROW"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["collision","lava","push","environmental-kill"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_THROW"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim"),e.spawnEnemy("shieldbearer",{q:3,r:3,s:-6},"obstacle"),e.setTile({q:3,r:1,s:-4},"lava")},run:e=>e.useSkill("SHIELD_THROW",{q:3,r:5,s:-8}),verify:(e,t)=>{const s=e.enemies.find(l=>l.id==="victim"),o=e.enemies.find(l=>l.id==="obstacle"),a={victimPushed:(s?.position.r??5)===3,obstacleDead:!o};return Object.values(a).some(l=>l===!1)&&(console.log(" Shield Throw Failed:",a),console.log("Victim Pushed:",a.victimPushed),console.log("Victim Pos:",s?.position),console.log("Obstacle Dead:",a.obstacleDead),console.log("Logs:",t)),Object.values(a).every(l=>l===!0)}}]},Hx={id:"auto_attack",name:"Auto Attack",description:"Tests for auto-attack passive skill including turn-start memory and friendly fire logic",scenarios:[{id:"auto_attack_persistence_stress_test",title:"Persistence: Three-Point Validation",description:"Verifies that Auto-Attack only hits units that were adjacent at BOTH start and end.",relatedSkills:["AUTO_ATTACK","BASIC_MOVE"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["passive","spatial-memory","edge-case"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["AUTO_ATTACK","BASIC_MOVE"]),e.spawnEnemy("footman",{q:5,r:5,s:-10},"persistent_foe"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"new_neighbor"),e.spawnEnemy("footman",{q:5,r:4,s:-9},"former_neighbor"),e.state.player.previousPosition={q:4,r:5,s:-9}},run:e=>{e.move({q:4,r:6,s:-10})},verify:(e,t)=>{const s=e.enemies.find(u=>u.id==="persistent_foe"),o=e.enemies.find(u=>u.id==="new_neighbor"),a=e.enemies.find(u=>u.id==="former_neighbor"),l={persistentDead:!s||s.hp<s.maxHp,ignoredNew:o&&o.hp===o.maxHp,ignoredFormer:a&&a.hp===a.maxHp,logFound:t.some(u=>u.includes("attacked footman"))};return Object.values(l).some(u=>u===!1)&&(console.log(" Scenario Failed Details:",l),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",t)),Object.values(l).every(u=>u===!0)}},{id:"enemy_auto_attack_no_friendly_fire",title:"Enemy Auto-Attack: Team Alignment",description:"Ensures enemy passives only target the player and not their own allies.",relatedSkills:["AUTO_ATTACK"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["passive","alignment","friendly-fire"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},[]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"enemy_attacker");const t=e.state.enemies.find(s=>s.id==="enemy_attacker");t&&(t.activeSkills=[{id:"AUTO_ATTACK",range:1}],t.previousPosition={q:3,r:5,s:-8}),e.spawnEnemy("shieldBearer",{q:2,r:6,s:-8},"enemy_ally"),t.previousPosition={q:3,r:5,s:-8},e.state.player.previousPosition={q:3,r:6,s:-9}},run:e=>{e.wait()},verify:(e,t)=>{const s=e.player,o=e.enemies.find(l=>l.id==="enemy_ally"),a={playerHit:s.hp<s.maxHp,allySafe:o&&o.hp===o.maxHp,hitPlayerLog:t.some(l=>l.includes("attacked you")),hitAllyLog:!t.some(l=>l.includes("attacked enemy_ally"))};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Failed Details:",a),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",t)),Object.values(a).every(l=>l===!0)}}]},jx={id:"integration",name:"Integration Tests",description:"Multi-skill integration scenarios testing complex interactions",scenarios:[{id:"environmental_chain_reaction",title:"Environmental Chain Reaction",description:"Test complex environmental interactions with multiple hazards",relatedSkills:["GRAPPLE_HOOK","SHIELD_THROW"],category:"hazards",difficulty:"advanced",isTutorial:!1,tags:["lava","wall","environmental-kill","chain-reaction"],setup:e=>{e.setPlayer({q:5,r:4,s:-9},["GRAPPLE_HOOK","SHIELD_THROW"]),e.spawnEnemy("shieldbearer",{q:5,r:2,s:-7},"victim1"),e.spawnEnemy("footman",{q:5,r:6,s:-11},"victim2"),e.spawnEnemy("footman",{q:5,r:7,s:-12},"victim3"),e.setTile({q:5,r:8,s:-13},"lava")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:5,r:2,s:-7}),e.useSkill("SHIELD_THROW",{q:5,r:5,s:-10})},verify:(e,t)=>{const s=e.player.position.q===5&&e.player.position.r===3,o=!e.enemies.find(m=>m.id==="victim3")||!!e.dyingEntities?.find(m=>m.id==="victim3"),a=!e.enemies.find(m=>m.id==="victim2")||!!e.dyingEntities?.find(m=>m.id==="victim2"),l=e.enemies.find(m=>m.id==="victim1"),u=l&&t.some(m=>m.includes("stunned")),f=l&&l.position.q===5&&l.position.r===6,p=[s,o,a,u,f];return Object.values(p).some(m=>m===!1)&&(console.log(" Environmental Chain Reaction Failed:",p),console.log("Player at 5,3:",s),console.log("Player Pos:",e.player.position),console.log("Logs found:",t),console.log("Victim1 at 5,6:",f),console.log("Victim1 Pos:",l?.position),console.log("Victim1 Stunned:",u),console.log("Victim2 Dead:",a),console.log("Victim3 Dead:",o)),Object.values(p).every(m=>m===!0)}},{id:"auto_attack_after_grapple",title:"Auto-Attack After Grapple",description:"Verify auto-attack triggers correctly after grapple displacement",relatedSkills:["GRAPPLE_HOOK","AUTO_ATTACK"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["passive","displacement","integration"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["GRAPPLE_HOOK","AUTO_ATTACK"]),e.state.player.previousPosition={q:4,r:6,s:-10},e.spawnEnemy("footman",{q:7,r:6,s:-13},"grappleHookTarget"),e.spawnEnemy("footman",{q:3,r:5,s:-8},"safe"),e.spawnEnemy("footman",{q:4,r:5,s:-9},"auto-attacked"),e.spawnEnemy("footman",{q:5,r:5,s:-10},"safe2")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:7,r:6,s:-13})},verify:(e,t)=>{const s=e.enemies.find(f=>f.id==="grappleHookTarget"),o=e.enemies.find(f=>f.id==="auto-attacked"),a=e.enemies.find(f=>f.id==="safe"),l=e.enemies.find(f=>f.id==="safe2"),u={targetPulled:!!(s&&s.position.q<7),targetNotHit:!!(s&&s.hp===s.maxHp),safeNotHit:!!(a&&a.hp===a.maxHp),safe2NotHit:!!(l&&l.hp===l.maxHp),autoattackedDead:!o||o.hp<=0};return Object.values(u).some(f=>f===!1)&&(console.log(" Scenario Failed Details:",u),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",t),console.log("target Pos:",s?.position.q),console.log("target Pulled:",u.targetPulled),console.log("target Not Hit:",u.targetNotHit),console.log("safe Not Hit:",u.safeNotHit),console.log("safe2 Not Hit:",u.safe2NotHit),console.log("autoattacked Dead:",u.autoattackedDead)),Object.values(u).every(f=>f===!0)}}]},Dx="modulepreload",Ux=function(e){return"/Hop/"+e},$y={},$x=function(t,s,o){let a=Promise.resolve();if(s&&s.length>0){let m=function(y){return Promise.all(y.map(b=>Promise.resolve(b).then(v=>({status:"fulfilled",value:v}),v=>({status:"rejected",reason:v}))))};var u=m;document.getElementsByTagName("link");const f=document.querySelector("meta[property=csp-nonce]"),p=f?.nonce||f?.getAttribute("nonce");a=m(s.map(y=>{if(y=Ux(y),y in $y)return;$y[y]=!0;const b=y.endsWith(".css"),v=b?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${y}"]${v}`))return;const T=document.createElement("link");if(T.rel=b?"stylesheet":Dx,b||(T.as="script"),T.crossOrigin="",T.href=y,p&&T.setAttribute("nonce",p),document.head.appendChild(T),b)return new Promise((S,x)=>{T.addEventListener("load",S),T.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${y}`)))})}))}function l(f){const p=new Event("vite:preloadError",{cancelable:!0});if(p.payload=f,window.dispatchEvent(p),!p.defaultPrevented)throw f}return a.then(f=>{for(const p of f||[])p.status==="rejected"&&l(p.reason);return t().catch(l)})},qx=async(e,t)=>{if(typeof window>"u")try{(await $x(()=>import("./__vite-browser-external-BIHI7g3E.js"),[])).appendFileSync(e,t)}catch(s){console.warn(`Failed to persist log to ${e}:`,s)}},zx={id:"basic_attack",name:"Basic Attack",description:"Tests for basic melee attack mechanics including range and move-to-attack logic",scenarios:[{id:"basic_attack_player_mechanics",title:"Player Basic Attack: Range & Bump",description:"Validates range enforcement, turn accounting, and bump-attack redirection.",relatedSkills:["BASIC_ATTACK"],category:"combat",tags:["melee","targeting","bump-attack"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BASIC_ATTACK"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"adj_victim"),e.spawnEnemy("footman",{q:3,r:4,s:-7},"far_victim")},run:e=>{e.useSkill("BASIC_ATTACK",{q:3,r:4,s:-7}),e.move({q:3,r:5,s:-8})},verify:(e,t)=>{const s=e.enemies.find(l=>l.id==="adj_victim"),o=e.enemies.find(l=>l.id==="far_victim"),a={farStaysAlive:o&&o.hp===o.maxHp,rangeError:t.some(l=>l.includes("out of range")),adjTookDamage:!s||s.hp<=s.maxHp,playerPositionHeld:J(e.player.position,{q:3,r:6,s:-9}),oneTurnConsumed:e.turnsSpent===1};if(Object.values(a).some(l=>l===!1)){const l=` Basic Attack Failed: ${JSON.stringify(a)}
Current Player Pos: ${JSON.stringify(e.player.position)}
Logs: ${JSON.stringify(t)}
`;console.log(l),qx("integration_debug.txt",l)}return Object.values(a).every(l=>l===!0)}}]},Vx={id:"spear_throw",name:"Spear Throw",description:"Tests for spear throw mechanics including range, LoS, and spear retrieval",scenarios:[{id:"spear_kill",title:"Spear Kill",description:"Throw spear to kill an enemy and verify item spawn.",relatedSkills:["SPEAR_THROW"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["projectile","combat","item-spawn"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SPEAR_THROW"]),e.spawnEnemy("footman",{q:3,r:4,s:-7},"target"),e.state.hasSpear=!0},run:e=>{e.useSkill("SPEAR_THROW",{q:3,r:4,s:-7})},verify:(e,t)=>{const s=!e.enemies.find(l=>l.id==="target"),o=!!e.spearPosition&&e.spearPosition.q===3&&e.spearPosition.r===4,a=t.some(l=>l.includes("Spear killed"));return s&&o&&a}},{id:"spear_miss_spawn",title:"Spear Rejects Empty Tile",description:"Enemy-only contract: empty tiles are invalid targets and do not spawn spear.",relatedSkills:["SPEAR_THROW"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["projectile","item-spawn"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SPEAR_THROW"]),e.state.hasSpear=!0},run:e=>{e.useSkill("SPEAR_THROW",{q:3,r:4,s:-7})},verify:(e,t)=>{const s=t.some(a=>a.includes("No enemy at target.")),o=e.hasSpear===!0&&!e.spearPosition;return s&&o}},{id:"spear_wall_block",title:"Spear Wall Block",description:"Spear throw is blocked by walls.",relatedSkills:["SPEAR_THROW"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["projectile","wall","boundary"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["SPEAR_THROW"]),e.spawnEnemy("footman",{q:4,r:3,s:-7},"target"),e.setTile({q:4,r:4,s:-8},"wall"),e.state.hasSpear=!0},run:e=>{e.useSkill("SPEAR_THROW",{q:4,r:3,s:-7})},verify:(e,t)=>{const s=t.some(l=>l.includes("No clear line of sight to enemy.")),o=!!e.enemies.find(l=>l.id==="target"),a=e.hasSpear===!0&&!e.spearPosition;return s&&o&&a}}]},Yx={id:"dash",name:"Dash",description:"Tests for dash mechanics including path validation and shield-based enemy shunting",scenarios:[{id:"dash_shunt_lava",title:"Shunt into Lava",description:"Shunt an enemy into lava for an environmental kill.",relatedSkills:["DASH"],category:"hazards",difficulty:"intermediate",isTutorial:!1,tags:["lava","push","environmental-kill"],setup:e=>{e.setPlayer({q:3,r:5,s:-8},["DASH"]),e.spawnEnemy("footman",{q:5,r:5,s:-10},"victim"),e.setTile({q:7,r:5,s:-12},"lava"),e.state.hasShield=!0},run:e=>{e.useSkill("DASH",{q:5,r:5,s:-10})},verify:(e,t)=>{const s=e.enemies.find(a=>a.id==="victim"),o={playerPosition:e.player.position.q===5&&e.player.position.r===5,victimDead:!s};return Object.values(o).some(a=>a===!1)&&(console.log(" Dash Shunt Lava Failed:",o),console.log("Final State:",e.player.position),console.log("Victim Pos:",s?.position),console.log("Logs:",t)),Object.values(o).every(a=>a===!0)}},{id:"dash_comprehensive_validation",title:"Dash: Constraints & Shunt Physics",description:"Validates range limits, wall blocking, and Shield Shunt displacement in one sequence.",relatedSkills:["DASH"],category:"movement",difficulty:"advanced",isTutorial:!1,tags:["stress-test","collision","range"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["DASH"]),e.state.hasShield=!0,e.setTile({q:4,r:4,s:-8},"wall"),e.setTile({q:6,r:5,s:-11},"wall"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"victim")},run:e=>{e.useSkill("DASH",{q:4,r:7,s:-11}),e.useSkill("DASH",{q:7,r:4,s:-11}),e.useSkill("DASH",{q:6,r:6,s:-12}),e.useSkill("DASH",{q:4,r:5,s:-9})},verify:(e,t)=>{const s=e.enemies.find(a=>a.id==="victim"),o={finalPositionCorrect:e.player.position.q===4&&e.player.position.r===6,victimPushed:!!(s&&s.position.q===4&&s.position.r===5),wallErrorFound:t.some(a=>a.includes("wall blocks")),axialRangeErrorFound:t.some(a=>a.includes("Axial only!")),shuntSuccess:t.some(a=>a.includes("Shield Shunt")),twoTurnSpent:e.turnsSpent===2};return Object.values(o).some(a=>a===!1)&&(console.log(" Dash Stress Test Failed:",o),console.log("Final State:",e.player.position),console.log("Victim Pos:",s?.position),console.log("Logs:",t)),Object.values(o).every(a=>a===!0)}}]},Kx={id:"jump",name:"Jump",description:"Tests for jump mechanics including range validation and stunning landing",scenarios:[{id:"jump_basic",title:"Basic Jump",description:"Jump to a tile.",relatedSkills:["JUMP"],category:"movement",difficulty:"beginner",isTutorial:!0,tags:["movement","leap"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["JUMP"]),e.setTile({q:3,r:5,s:-8},"lava")},run:e=>{e.useSkill("JUMP",{q:3,r:4,s:-7})},verify:(e,t)=>{const s=J(e.player.position,{q:3,r:4,s:-7}),o=Wd(e.occupancyMask,{q:3,r:4}),a=!Wd(e.occupancyMask,{q:3,r:6}),l={playerInPosition:s,spatialMaskRefreshed:o&&a,noLavaDamage:e.player.hp===e.player.maxHp,jumpedSuccessfully:t.some(u=>u.includes("Jumped"))};return Object.values(l).some(u=>u===!1)&&(console.error(" Jump Basic Failed:",l),console.error("Final State:",e.player.position),console.error("Logs:",t)),Object.values(l).every(u=>u===!0)}},{id:"jump_stunning_landing",title:"Stunning Landing",description:"Jump into a group of enemies and ensure neighbors are stunned.",relatedSkills:["JUMP"],category:"movement",difficulty:"intermediate",isTutorial:!0,tags:["movement","stun","aoe"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["JUMP"]),e.addUpgrade("JUMP","STUNNING_LANDING"),e.spawnEnemy("footman",{q:3,r:7,s:-10},"neighbor_1"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"neighbor_2"),e.spawnEnemy("footman",{q:3,r:5,s:-8},"distant_enemy")},run:e=>{e.useSkill("JUMP",{q:3,r:8,s:-11})},verify:(e,t,s=[])=>{const o={n1StunnedMessage:t.some(a=>a.includes("stunned by landing impact")),hasShakeJuice:s.some(a=>a.type==="shake"),hasStunBurstVFX:s.some(a=>a.type==="vfx"&&a.payload.type==="stunBurst"),hasStunnedCombatText:s.some(a=>a.type==="combat_text"&&a.payload.text==="STUNNED"),playerAtTarget:J(e.player.position,{q:3,r:8,s:-11}),oneTurnSpent:e.turnsSpent===1};return Object.values(o).some(a=>a===!1)&&(console.error(" Jump Stunning Landing Failed:",o),console.error("Final State:",e.player.position),console.error("turnsSpent:",e.turnsSpent),console.error("Logs:",t)),Object.values(o).every(a=>a===!0)}}]},Fx={id:"shield_bash",name:"Shield Bash",description:"Tests for shield bash mechanics including push, stun, and collision behavior",scenarios:[{id:"bash_push",title:"Shield Push",description:"Push an enemy into lava.",relatedSkills:["SHIELD_BASH"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["push","displacement","lava"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_BASH"]),e.setTile({q:3,r:4,s:-7},"lava"),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>{e.useSkill("SHIELD_BASH",{q:3,r:5,s:-8})},verify:(e,t)=>{const s={enemyGone:e.enemies.length===0,messageOk:t.some(o=>o.includes("Lava"))};return Object.values(s).some(o=>o===!1)&&(console.log(" Scenario Failed Details:",s),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",t)),Object.values(s).every(o=>o===!0)}},{id:"bash_wall_stun",title:"Wall Slam Stun",description:"Bash enemy into wall to cause a stun.",relatedSkills:["SHIELD_BASH"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["collision","wall","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_BASH"]),e.spawnEnemy("shieldBearer",{q:3,r:5,s:-8},"victim"),e.setTile({q:3,r:4,s:-7},"wall")},run:e=>{e.useSkill("SHIELD_BASH",{q:3,r:5,s:-8})},verify:(e,t)=>{const s=e.enemies.find(l=>l.id==="victim");if(!s)return!1;const o=J(s.position,{q:3,r:5,s:-8}),a=t.some(l=>l.includes("into obstacle"));return o&&a}}]},Wx={id:"bulwark_charge",name:"Bulwark Charge",description:"Tests for bulwark charge mechanics including chain pushing and wall slamming",scenarios:[{id:"chain_stun",title:"The Chain-Stun",description:"Wall prevents chain movement, causing all members to be stunned.",relatedSkills:["BULWARK_CHARGE"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["chain","wall","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BULWARK_CHARGE"]),e.spawnEnemy("shieldBearer",{q:3,r:5,s:-8},"A"),e.spawnEnemy("shieldBearer",{q:3,r:4,s:-7},"B"),e.setTile({q:3,r:3,s:-6},"wall"),e.state.hasShield=!0},run:e=>{e.useSkill("BULWARK_CHARGE",{q:3,r:5,s:-8})},verify:(e,t)=>!0},{id:"bulwark_chain_push",title:"Bulwark Chain Push",description:"Push a chain of enemies successfully.",relatedSkills:["BULWARK_CHARGE"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["chain","push","displacement"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BULWARK_CHARGE"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"A"),e.spawnEnemy("footman",{q:3,r:4,s:-7},"B"),e.state.hasShield=!0},run:e=>{e.useSkill("BULWARK_CHARGE",{q:3,r:5,s:-8})},verify:(e,t)=>!0}]},Xx={id:"vault",name:"Vault",description:"Tests for vault mechanics including state-shifting behavior between odd and even turns",scenarios:[{id:"vault_shift_stun",title:"Vault Stun (Odd Turn)",description:"Verify vault stuns neighbors on Turn 1.",relatedSkills:["VAULT"],category:"movement",difficulty:"intermediate",isTutorial:!0,tags:["state-shift","stun","movement"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.setTile({q:3,r:5,s:-8},"lava"),e.spawnEnemy("footman",{q:4,r:4,s:-8},"victim")},run:e=>{e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,t)=>{const s={stunned:t.some(o=>o.includes("Stun Vault executed!"))};return Object.values(s).some(o=>o===!1)&&(console.log(" Vault Stun Failed:",s),console.log("Logs:",t)),Object.values(s).every(o=>o===!0)}},{id:"vault_shift_normal",title:"Vault Normal (Even Turn)",description:"Verify vault is normal on Turn 2.",relatedSkills:["VAULT"],category:"movement",difficulty:"intermediate",isTutorial:!0,tags:["state-shift","movement"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.setTile({q:3,r:5,s:-8},"lava"),e.spawnEnemy("footman",{q:4,r:3,s:-7},"victim")},run:e=>{e.wait(),e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,t)=>{const s={vaulted:t.some(o=>o.includes("Vaulted!"))};return Object.values(s).some(o=>o===!1)&&(console.log(" Vault Normal Failed:",s),console.log("Logs:",t)),Object.values(s).every(o=>o===!0)}}]},Gx={id:"basic_move",name:"Basic Move",description:"Fundamental movement mechanics",scenarios:[{id:"walk_to_tile",title:"Movement 101",description:"Move your character from the center to an adjacent tile.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"beginner",isTutorial:!0,tags:["movement","basics"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"]),e.setTile({q:4,r:6,s:-10},"wall")},run:e=>{e.move({q:4,r:6,s:-10}),e.move({q:4,r:4,s:-8})},verify:(e,t)=>{const s={positionCorrect:J(e.player.position,{q:4,r:4,s:-8}),logFound:t.some(o=>o.includes("blocked")),oneTurnSpent:e.turnsSpent===1};return Object.values(s).some(o=>o===!1)&&(console.log(" Scenario Failed Details:",s),console.log("Final Position:",e.player.position),console.log("Logs found:",t)),Object.values(s).every(o=>o===!0)}},{id:"free_move_out_of_combat",title:"Exploration Mode",description:"Verify that movement range expands only when no enemies are present.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"beginner",isTutorial:!1,tags:["movement","exploration","free-move"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE","BASIC_ATTACK"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"adj_victim")},run:e=>{e.move({q:7,r:1,s:-8}),e.useSkill("BASIC_ATTACK",{q:3,r:5,s:-8}),e.move({q:7,r:1,s:-8})},verify:(e,t)=>{const s=t.filter(l=>l.toLowerCase().includes("out of reach")).length,o=t.some(l=>l.toLowerCase().includes("you attacked")),a={wasBlockedInitially:s===1,attackLogs:o,reachedDistantHex:J(e.player.position,{q:7,r:1,s:-8})};return Object.values(a).some(l=>l===!1)&&(console.log(" Free Move Scenario Failed:",a),console.log("Final Position:",e.player.position),console.log("Logs found:",t)),Object.values(a).every(l=>l===!0)}},{id:"invalid_enemy_move_intent_is_rejected_pre_execution",title:"Move Intent Rejected Before Execution",description:"Enemy AI may decide to move, but execution must not run a skill the actor does not own.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["movement","validation","intent"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:7,r:5,s:-12},"attacker_without_move");const t=e.getEnemy("attacker_without_move");t&&(t.activeSkills=(t.activeSkills||[]).filter(s=>s.id!=="BASIC_MOVE"))},run:e=>{e.wait()},verify:(e,t)=>{const s=e.enemies.find(a=>a.id==="attacker_without_move"),o={enemyDidNotMove:!!s&&J(s.position,{q:7,r:5,s:-12}),noMissingSkillRuntimeError:!t.some(a=>a.includes("does not have skill BASIC_MOVE"))};return Object.values(o).some(a=>a===!1)&&(console.log("Invalid Enemy Move Intent Rejection Failed:",o),console.log("Enemy:",s),console.log("Logs:",t)),Object.values(o).every(a=>a===!0)}},{id:"single_enemy_single_action_per_turn",title:"Single Action Per Actor Turn",description:"Each actor resolves exactly one action per turn in normal flow.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["turn-loop","movement","integrity"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:7,r:5,s:-12},"single_actor")},run:e=>{e.wait()},verify:(e,t)=>{const s={q:7,r:5,s:-12},o=e.enemies.find(u=>u.id==="single_actor"),a=o?fe(s,o.position):-1,l={enemyExists:!!o,movedExactlyOneTile:a===1,noZeroEffectMoveWarning:!t.some(u=>u.includes("produced ZERO effects"))};return Object.values(l).some(u=>u===!1)&&(console.log("Single Action Per Actor Turn Failed:",l),console.log("Enemy:",o),console.log("Logs:",t)),Object.values(l).every(u=>u===!0)}}]},Fi=e=>{const s={BASIC_MOVE:{slot:"passive",range:1,cooldown:0,name:"Walk",description:"Move to adjacent tile."},BASIC_ATTACK:{slot:"passive",range:1,cooldown:0,name:"Basic Attack",description:"Strike adjacent target."},SENTINEL_TELEGRAPH:{slot:"offensive",range:3,cooldown:0,name:"Sentinel Telegraph",description:"Marks blast zone."},SENTINEL_BLAST:{slot:"offensive",range:3,cooldown:0,name:"Sentinel Blast",description:"Massive area blast."}}[e]||{slot:"offensive",range:1,cooldown:0,name:e,description:e};return{id:e,name:s.name,description:s.description,slot:s.slot,cooldown:s.cooldown,currentCooldown:0,range:s.range,upgrades:[],activeUpgrades:[]}},Jx={id:"sentinel_blast",name:"Sentinel Blast",description:"Sentinel unique area-of-effect attack",scenarios:[{id:"blast_aoe",title:"Blast Away",description:"Use Sentinel Blast to hit multiple enemies.",relatedSkills:["SENTINEL_BLAST"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["aoe","damage","sentinel"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SENTINEL_BLAST"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"center"),e.spawnEnemy("footman",{q:4,r:4,s:-8},"side")},run:e=>{e.useSkill("SENTINEL_BLAST",{q:3,r:5,s:-8})},verify:(e,t)=>t.some(s=>s.includes("massive blast"))},{id:"sentinel_playlist_two_turn_timing",title:"Playlist: Telegraph then Execute",description:"Boss uses a 2-turn skill playlist: telegraph first, blast on next turn.",relatedSkills:["SENTINEL_TELEGRAPH","SENTINEL_BLAST"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["boss","playlist","telegraph"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("sentinel",{q:4,r:2,s:-6},"boss");const t=e.getEnemy("boss");t&&(t.activeSkills=[Fi("BASIC_MOVE"),Fi("BASIC_ATTACK"),Fi("SENTINEL_TELEGRAPH"),Fi("SENTINEL_BLAST")])},run:e=>{e.wait(),e.logs.push(`HP_AFTER_TELEGRAPH=${e.state.player.hp}`),e.wait()},verify:(e,t)=>{const s=t.find(l=>l.startsWith("HP_AFTER_TELEGRAPH=")),o=s?Number(s.split("=")[1]):-1,a={telegraphEmitted:t.some(l=>l.includes("marks the impact zone")),executeEmitted:t.some(l=>l.includes("massive blast")),noDamageOnTelegraphTurn:o===e.player.maxHp,damageOnExecuteTurn:e.player.hp<e.player.maxHp};return Object.values(a).some(l=>l===!1)&&(console.log("Sentinel Playlist Timing Failed:",a),console.log("Logs:",t),console.log("Player HP:",e.player.hp,"/",e.player.maxHp)),Object.values(a).every(l=>l===!0)}},{id:"sentinel_playlist_interruption_by_stun",title:"Playlist: Interruption Cancels Execute",description:"Stunning the boss during telegraph cancels the follow-up execute turn.",relatedSkills:["SENTINEL_TELEGRAPH","SENTINEL_BLAST"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["boss","playlist","interruption","stun"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("sentinel",{q:4,r:2,s:-6},"boss");const t=e.getEnemy("boss");t&&(t.activeSkills=[Fi("BASIC_MOVE"),Fi("BASIC_ATTACK"),Fi("SENTINEL_TELEGRAPH"),Fi("SENTINEL_BLAST")])},run:e=>{e.wait(),e.applyStatus("boss","stunned",1),e.wait()},verify:(e,t)=>{const s=e.enemies.find(a=>a.id==="boss"),o={telegraphEmitted:t.some(a=>a.includes("marks the impact zone")),executeCancelled:!t.some(a=>a.includes("massive blast")),playerUnharmed:e.player.hp===e.player.maxHp,bossStillExists:!!s};return Object.values(o).some(a=>a===!1)&&(console.log("Sentinel Playlist Interruption Failed:",o),console.log("Logs:",t),console.log("Player HP:",e.player.hp,"/",e.player.maxHp),console.log("Boss:",s)),Object.values(o).every(a=>a===!0)}}]},Qx={id:"fireball",name:"Fireball",description:"Validates axial targeting, AoE damage, and environmental fire placement.",scenarios:[{id:"fireball_axial_aoe",title:"Axial Alignment & AoE Spread",description:"Verify the skill only fires axially and damages all neighbors at the impact site.",relatedSkills:["FIREBALL"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["aoe","axial","fire"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["FIREBALL"]),e.spawnEnemy("footman",{q:5,r:4,s:-9},"primary_target"),e.spawnEnemy("footman",{q:6,r:4,s:-10},"neighbor_target"),e.spawnEnemy("footman",{q:6,r:5,s:-11},"diagonal_enemy"),e.setTile({q:6,r:3,s:-9},"wall"),e.setTile({q:6,r:6,s:-12},"wall"),e.setTile({q:5,r:6,s:-11},"lava")},run:e=>{e.useSkill("FIREBALL",{q:7,r:5,s:-12}),e.useSkill("FIREBALL",{q:5,r:4,s:-9})},verify:()=>!0},{id:"fireball_max_range_edge",title:"Max Range & Fire Duration",description:"Verify fireball at exactly range 3 and check fire duration persistence.",relatedSkills:["FIREBALL"],category:"balancing",difficulty:"intermediate",isTutorial:!1,tags:["range","persistence"],setup:e=>{e.setPlayer({q:0,r:0,s:0},["FIREBALL"]),e.setTile({q:0,r:3,s:-3},"grass")},run:e=>{e.useSkill("FIREBALL",{q:0,r:3,s:-3}),e.wait(),e.wait()},verify:()=>!0}]},Zx={id:"hazards_v1",name:"Hazard Consolidation",description:"Verifies centralized hazard logic and flight immunity",scenarios:[{id:"Jump Over Lava",title:"Jump Over Lava",description:"Jumping over lava should not result in damage.",relatedSkills:["JUMP"],category:"hazards",tags:["lava","jump"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["JUMP"]),e.state.tiles.set("4,8",{baseId:"LAVA",position:{q:4,r:8,s:-12},traits:new Set(["HAZARDOUS","LAVA","LIQUID"]),effects:[]})},run:e=>{e.useSkill("JUMP",{q:4,r:7,s:-11})},verify:e=>{const t=e.player,s={playerPos:J(t.position,{q:4,r:7,s:-11}),isAlive:t.hp===t.maxHp};return Object.values(s).every(o=>o===!0)}},{id:"Walk Into Lava",title:"Walk Into Lava",description:"Walking into lava should be invalid unless the mover is hazard-safe.",relatedSkills:["BASIC_MOVE"],category:"hazards",tags:["lava","walk"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["BASIC_MOVE"]),e.state.tiles.set("4,8",{baseId:"LAVA",position:{q:4,r:8,s:-12},traits:new Set(["HAZARDOUS","LAVA","LIQUID"]),effects:[]})},run:e=>{e.useSkill("BASIC_MOVE",{q:4,r:8,s:-12})},verify:e=>{const t=e.player,s={playerPos:J(t.position,{q:4,r:9,s:-13}),hpUnchanged:t.hp===t.maxHp};return Object.values(s).every(o=>o===!0)}},{id:"Falcon Flying Over Lava",title:"Falcon Flying Over Lava",description:"Flying units (Falcon) should ignore lava during transit and stay.",relatedSkills:["FALCON_COMMAND"],category:"hazards",tags:["lava","falcon","flight"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.spawnFalcon({q:4,r:8,s:-12},"my-falcon"),e.state.tiles.set("4,8",{baseId:"LAVA",position:{q:4,r:8,s:-12},traits:new Set(["HAZARDOUS","LAVA","LIQUID"]),effects:[]})},run:e=>{e.wait()},verify:e=>{const t=e.enemies.find(o=>o.id==="my-falcon"),s={falconExists:!!t,falconAlive:(t?.hp||0)>0,falconPos:J(t?.position,{q:4,r:8,s:-12})};return Object.values(s).every(o=>o===!0)}}]},eT={id:"falcon_command_v2",name:"Falcon's Command",description:"Validates Predator/Scout mode transitions and spatial orbit logic.",scenarios:[{id:"falcon_predator_strike_path",title:"Predator Mode: Apex Strike Geometry",description:`
                Tests the Falcon's flight path from its current position to the Target.
                Layout:
                   (F)  <- Falcon Start (6, 5, -11)
                      .
                         (T) <- Target/Prey (8, 5, -13)
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"beginner",isTutorial:!0,tags:["falcon","summon","companion"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.spawnFalcon({q:3,r:9,s:-12},"my-falcon"),e.spawnEnemy("footman",{q:4,r:2,s:-6},"prey")},run:e=>{e.useSkill("FALCON_COMMAND",{q:4,r:2,s:-6}),e.wait()},verify:(e,t)=>{const s=e.companions?.find(l=>l.id==="my-falcon"),o=e.enemies.find(l=>l.id==="prey"),a={modeSet:s?.companionState?.mode==="predator",targetLocked:s?.companionState?.markTarget==="prey",movedCloser:s&&fe(s.position,{q:4,r:2,s:-6})<7,preyHealthy:o?.hp===o?.maxHp,turnSpent:e.turnsSpent===2};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Falcon Predator Strike Failed:",a),console.log("Falcon:",s)),Object.values(a).every(l=>l===!0)}},{id:"falcon_scout_orbit",title:"Scout Mode: Hex Ring Orbit",description:`
                Ensures that in Scout mode, the Falcon rotates around the mark 
                on the flat-top hex ring.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"beginner",isTutorial:!0,tags:["falcon","summon","companion"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.spawnFalcon({q:3,r:9,s:-12},"my-falcon")},run:e=>{e.useSkill("FALCON_COMMAND",{q:3,r:6,s:-9}),e.wait(),e.wait()},verify:(e,t)=>{const s=e.companions?.find(l=>l.id==="my-falcon"),o={q:3,r:6,s:-9},a={isScout:s?.companionState?.mode==="scout",onOrbitRing:s&&fe(s.position,o)===1,hasRotated:s&&!!s.previousPosition&&!J(s.position,s.previousPosition),turnSpent:e.turnsSpent===3};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Falcon Scout Orbit Failed:",a),console.log("Falcon:",s)),Object.values(a).every(l=>l===!0)}},{id:"falcon_roost_mode",title:"Roost Mode: Return and Heal",description:`
                Ensures that when targeting self, the Falcon returns to the Hunter
                and provides a heal on arrival.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"beginner",isTutorial:!0,tags:["falcon","roost","heal"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.state.player.hp=2,e.spawnFalcon({q:3,r:6,s:-9},"my-falcon")},run:e=>{e.useSkill("FALCON_COMMAND",{q:4,r:9,s:-13}),e.wait(),e.wait()},verify:(e,t)=>{const s=e.companions?.find(l=>l.id==="my-falcon"),o=e.player,a={modeRoost:s?.companionState?.mode==="roost",healed:o.hp>2,closeToHunter:s&&fe(s.position,o.position)<=1};return Object.values(a).some(l=>l===!1)&&console.log(" Scenario Falcon Roost Heal Failed:",a),Object.values(a).every(l=>l===!0)}},{id:"falcon_predator_auto_return",title:"Predator Mode: Auto-Roost on Kill",description:`
                Ensures that if a marked predator target dies, the Falcon
                automatically reverts to Roost mode.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"intermediate",isTutorial:!0,tags:["falcon","predator","cleanup"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.state.player.hp=1,e.spawnFalcon({q:4,r:8,s:-12},"my-falcon"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"prey")},run:e=>{e.useSkill("FALCON_COMMAND",{q:4,r:7,s:-11}),e.wait(),e.wait(),e.wait()},verify:(e,t)=>{const s=e.companions?.find(u=>u.id==="my-falcon"),o=e.enemies.find(u=>u.id==="prey"),a=e.player,l={preyDead:!o,autoRoost:s?.companionState?.mode==="roost",healed:a.hp>1};return Object.values(l).some(u=>u===!1),Object.values(l).every(u=>u===!0)}},{id:"falcon_command_metadata_null_safety",title:"Command Metadata Null-Safety",description:`
                Ensures FALCON_COMMAND name/description resolution is safe
                when player context is remapped in harness-like states.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"intermediate",isTutorial:!1,tags:["falcon","null-safety","metadata"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.state.player.id="hunter_remapped"},run:e=>{e.wait()},verify:(e,t)=>{const s={playerIdRemapped:e.player.id==="hunter_remapped",noRuntimeReferenceError:!t.some(o=>o.toLowerCase().includes("cannot read properties"))};return Object.values(s).some(o=>o===!1)&&console.log("Falcon Command Metadata Null-Safety Failed:",s),Object.values(s).every(o=>o===!0)}}]},tT={id:"kinetic_tri_trap",name:"Kinetic Tri-Trap",description:"Tests for trap deployment and fling mechanics",scenarios:[{id:"tri_trap_basic_deployment",title:"Trap Deployment",description:"Deploy 3 traps on axial tiles at range 2.",relatedSkills:["KINETIC_TRI_TRAP"],category:"deployment",difficulty:"beginner",isTutorial:!0,tags:["trap","deployment"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["KINETIC_TRI_TRAP"]),e.state.player.archetype="HUNTER"},run:e=>{e.useSkill("KINETIC_TRI_TRAP",{q:5,r:5,s:-10})},verify:(e,t)=>{const s=e.player.position,o=e.traps||[],a={countIsThree:o.length===3,isAtRangeTwo:o.every(l=>fe(l.position,s)===2),isAxialToPlayer:o.every(l=>l.position.q===s.q||l.position.r===s.r||l.position.s===s.s),trapsHidden:o.every(l=>!l.isRevealed)};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Tri-Trap Deployment Failed:",a),console.log("Traps:",e.traps),console.log("Logs:",t)),Object.values(a).every(l=>l===!0)}},{id:"tri_trap_state_tracking",title:"Trap State Tracking",description:"Traps are tracked with correct owner and hidden state.",relatedSkills:["KINETIC_TRI_TRAP"],category:"state",difficulty:"intermediate",isTutorial:!1,tags:["trap","state"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["KINETIC_TRI_TRAP"]),e.state.player.archetype="HUNTER"},run:e=>{e.useSkill("KINETIC_TRI_TRAP",{q:5,r:5,s:-10}),e.useSkill("KINETIC_TRI_TRAP",{q:5,r:5,s:-10})},verify:(e,t)=>{const s=e.traps,o={trapsExist:s&&s.length>0,allHidden:s?.every(a=>!a.isRevealed)??!1,allZeroCooldown:s?.every(a=>a.cooldown===0)??!1,deployMessage:t.some(a=>a.includes("trap")||a.includes("Trap")),trapsCount:s?.length===3};return Object.values(o).some(a=>a===!1)&&(console.log(" Trap State Failed:",o),console.log("Traps:",e.traps)),Object.values(o).every(a=>a===!0)}}]},nT={id:"withdrawal",name:"Withdrawal",description:"Tests for shot + backroll mechanics and passive reaction",scenarios:[{id:"withdrawal_basic",title:"Shot and Backroll",description:"Shoot adjacent enemy and backroll to safety.",relatedSkills:["WITHDRAWAL"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["shot","backroll","displacement"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["WITHDRAWAL"]),e.state.player.archetype="HUNTER",e.spawnEnemy("footman",{q:6,r:5,s:-11},"target")},run:e=>{e.useSkill("WITHDRAWAL",{q:6,r:5,s:-11})},verify:(e,t)=>{const s=e.enemies.find(a=>a.id==="target"),o={enemyDamagedOrDead:!s||s.hp<s.maxHp,playerMoved:e.player.position.q!==5||e.player.position.r!==5,playerBackrolled:e.player.position.q<5,shotFired:t.some(a=>a.includes("Withdrawal")||a.includes("shot"))};return Object.values(o).some(a=>a===!1)&&(console.log(" Withdrawal Failed:",o),console.log("Player:",e.player.position),console.log("Target HP:",s?.hp)),Object.values(o).every(a=>a===!0)}},{id:"withdrawal_wall_block",title:"Backroll Blocked by Wall",description:"Backroll finds alternate safe spot when wall blocks retreat.",relatedSkills:["WITHDRAWAL"],category:"collision",difficulty:"intermediate",isTutorial:!1,tags:["backroll","wall","pathfinding"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["WITHDRAWAL"]),e.state.player.archetype="HUNTER",e.setTile({q:4,r:5,s:-9},"wall"),e.setTile({q:3,r:5,s:-8},"wall"),e.spawnEnemy("footman",{q:6,r:5,s:-11},"target")},run:e=>{e.useSkill("WITHDRAWAL",{q:6,r:5,s:-11})},verify:(e,t)=>{const s={playerNotOnWall:!J(e.player.position,{q:4,r:5,s:-9}),playerMoved:e.player.position.q!==5||e.player.position.r!==5};return Object.values(s).some(o=>o===!1)&&(console.log(" Wall Block Failed:",s),console.log("Player:",e.player.position)),Object.values(s).every(o=>o===!0)}}]},iT={id:"absorb_fire",name:"Absorb Fire Passive",description:"Verifies that fire damage is converted to healing.",scenarios:[{id:"Absorb Fire Damage",title:"Stand on Fire",description:"Player with Absorb Fire should be healed when standing on fire.",relatedSkills:["ABSORB_FIRE"],category:"passive",tags:["fire","healing"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["ABSORB_FIRE"]),e.state.player.hp=1,e.setTile({q:4,r:5,s:-9},"stone");const t={q:4,r:5,s:-9},s=e.getTileAt(t);s&&s.effects.push({id:"FIRE",duration:3,potency:1})},run:e=>{e.wait()},verify:e=>{const t=e.player;return t.hp<=1&&console.log("Stand on Fire Failed: HP did not increase",t.hp),t.hp>1}},{id:"Absorb Lava Damage",title:"Walk into Lava",description:"Player with Absorb Fire should be healed when walking into lava.",relatedSkills:["ABSORB_FIRE","BASIC_MOVE"],category:"passive",tags:["lava","healing"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["ABSORB_FIRE","BASIC_MOVE"]),e.state.player.hp=1,e.setTile({q:4,r:6,s:-10},"lava")},run:e=>{e.useSkill("BASIC_MOVE",{q:4,r:6,s:-10})},verify:e=>{const t=e.player,s={alive:t.hp>0,healed:t.hp===t.maxHp,onLava:J(t.position,{q:4,r:6,s:-10})};return(!s.alive||!s.healed||!s.onLava)&&(console.log("Walk into Lava Failed:",s,"HP:",t.hp,"MaxHP:",t.maxHp),console.log("Player Pos:",t.position)),Object.values(s).every(o=>o===!0)}}]},sT={id:"tile_interactions",name:"Tile Interactions",description:"Verifies interactions with special tiles like Shrines and Stairs.",scenarios:[{id:"shrine_interaction",title:"Shrine Interaction",description:"Moving onto a shrine should trigger an upgrade choice.",relatedSkills:["BASIC_MOVE"],category:"progression",tags:["shrine","upgrade"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"]),e.state.shrinePosition={q:4,r:6,s:-10},e.state.tiles.set("4,6",{baseId:"SHRINE",position:{q:4,r:6,s:-10},traits:new Set(["INTERACTABLE","SHRINE"]),effects:[]})},run:e=>{e.move({q:4,r:6,s:-10})},verify:e=>{const t={playerOnShrine:J(e.player.position,{q:4,r:6,s:-10}),isChoosingUpgrade:e.pendingStatus?.status==="choosing_upgrade",hasOptions:e.pendingStatus?.shrineOptions?.length>0};return Object.values(t).every(s=>s===!0)}},{id:"stairs_interaction",title:"Stairs Interaction",description:"Moving onto stairs should trigger level transition.",relatedSkills:["BASIC_MOVE"],category:"progression",tags:["stairs","portal"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"]),e.state.stairsPosition={q:4,r:6,s:-10},e.state.tiles.set("4,6",{baseId:"STAIRS",position:{q:4,r:6,s:-10},traits:new Set(["INTERACTABLE","STAIRS"]),effects:[]})},run:e=>{e.move({q:4,r:6,s:-10})},verify:e=>{const t={playerOnStairs:J(e.player.position,{q:4,r:6,s:-10}),isTransitioning:e.pendingStatus?.status==="playing"||e.pendingStatus?.status==="won",messageFound:e.message.some(s=>s.includes("Descending")||s.includes("Cleared"))};return Object.values(t).every(s=>s===!0)}}]},aT={id:"telegraph_projection",name:"Telegraph Projection",description:"Deterministic intent previews for next-turn danger tiles.",scenarios:[{id:"telegraph_projection_is_deterministic",title:"Projection Determinism",description:"Same state should always produce the same danger projection.",relatedSkills:["BASIC_ATTACK"],category:"telegraph",difficulty:"intermediate",isTutorial:!1,tags:["projection","determinism"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:7,r:5,s:-12},"threat")},run:e=>{e.wait()},verify:e=>{const t=e.intentPreview,s=t?.dangerTiles||[],o=t?.projections||[],a=s.map(y=>`${y.q},${y.r},${y.s}`),l=new Set(a),u=a.every((y,b)=>b===0||a[b-1].localeCompare(y)<=0),f=o.map(y=>`${y.actorId}|${y.skillId}|${y.targetHex?`${y.targetHex.q},${y.targetHex.r},${y.targetHex.s}`:"none"}`),p=f.every((y,b)=>b===0||f[b-1].localeCompare(y)<=0),m={hasEnginePreview:!!t,noDuplicateTiles:l.size===a.length,tilesAreSorted:u,projectionsAreSorted:p};return Object.values(m).some(y=>y===!1)&&(console.log("Telegraph Projection Determinism Failed:",m),console.log("Engine Preview:",t)),Object.values(m).every(y=>y===!0)}},{id:"telegraph_projection_matches_execute_footprint",title:"Projection Matches Execute Footprint",description:"Projected danger tiles should include the tile actually damaged on execution.",relatedSkills:["BASIC_ATTACK"],category:"telegraph",difficulty:"intermediate",isTutorial:!1,tags:["projection","parity","combat"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:4,r:2,s:-6},"threat")},run:e=>{e.wait();const o=e.state.intentPreview?.projections?.find(a=>a.actorId==="threat")?.dangerTiles?.[0];o?e.logs.push(`PREVIEW_TILE=${o.q},${o.r},${o.s}`):e.logs.push("PREVIEW_TILE=none"),e.wait()},verify:(e,t)=>{const s=e.enemies.find(f=>f.id==="threat"),a=t.find(f=>f.startsWith("PREVIEW_TILE="))?.split("=")[1]||"none",l=a==="none"?void 0:(()=>{const[f,p,m]=a.split(",").map(y=>Number(y));return{q:f,r:p,s:m}})(),u={previewProducedTile:!!l,projectedTileMatchesExecute:!!l&&!!s&&J(s.position,l)};return Object.values(u).some(f=>f===!1)&&(console.log("Telegraph Projection Parity Failed:",u),console.log("Logs:",t),console.log("Player HP:",e.player.hp,"/",e.player.maxHp)),Object.values(u).every(f=>f===!0)}}]},wd=e=>{const s={BASIC_MOVE:{slot:"passive",range:1,cooldown:0,name:"Walk",description:"Move to adjacent tile."},BASIC_ATTACK:{slot:"passive",range:1,cooldown:0,name:"Basic Attack",description:"Strike adjacent target."},DASH:{slot:"passive",range:4,cooldown:0,name:"Kinetic Dash",description:"Dash in a straight line."}}[e]||{slot:"offensive",range:1,cooldown:0,name:e,description:e};return{id:e,name:s.name,description:s.description,slot:s.slot,cooldown:s.cooldown,currentCooldown:0,range:s.range,upgrades:[],activeUpgrades:[]}},oT={id:"raider_dash",name:"Raider Dash",description:"Parity checks for enemy Raider reusing the player DASH contract.",scenarios:[{id:"player_dash_stops_before_adjacent_enemy",title:"Parity Baseline: Player Dash Stops Before Blocker",description:"Player DASH should stop on the tile before an occupied target.",relatedSkills:["DASH"],category:"movement",difficulty:"beginner",isTutorial:!1,tags:["parity","dash","reuse"],setup:e=>{e.setPlayer({q:4,r:2,s:-6},["DASH"]),e.spawnEnemy("footman",{q:4,r:6,s:-10},"blocker"),e.state.hasShield=!1},run:e=>{e.useSkill("DASH",{q:4,r:6,s:-10})},verify:(e,t)=>{const s={playerStoppedBeforeBlocker:e.player.position.q===4&&e.player.position.r===5,dashResolved:t.some(o=>o.includes("Stopped by an obstacle")||o.includes("Dashed!")||o.includes("Shield Shunt"))};return Object.values(s).every(o=>o===!0)}},{id:"raider_ai_uses_dash_with_player_contract",title:"Parity: Raider Uses Same Dash Stop Rule",description:"Raider AI selects DASH and lands on the same stop tile as player-owned DASH in mirrored geometry.",relatedSkills:["DASH"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["parity","enemy-ai","dash"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},[]),e.spawnEnemy("raider",{q:4,r:2,s:-6},"raider"),e.state.hasShield=!1;const t=e.getEnemy("raider");t&&(t.activeSkills=[wd("BASIC_MOVE"),wd("BASIC_ATTACK"),wd("DASH")])},run:e=>{e.wait()},verify:(e,t)=>{const s=e.enemies.find(a=>a.id==="raider"),o={raiderStillAlive:!!s,raiderStoppedBeforePlayer:!!s&&s.position.q===4&&s.position.r===5,playerUnharmed:e.player.hp===e.player.maxHp,dashResolved:t.some(a=>a.includes("Stopped by an obstacle")||a.includes("Dashed!")||a.includes("Shield Shunt"))};return Object.values(o).every(a=>a===!0)}}]},Cd=e=>{const s={BASIC_MOVE:{slot:"passive",range:1,cooldown:0,name:"Walk",description:"Move to adjacent tile."},BASIC_ATTACK:{slot:"passive",range:1,cooldown:0,name:"Basic Attack",description:"Strike adjacent target."},GRAPPLE_HOOK:{slot:"offensive",range:4,cooldown:0,name:"Grapple Hook",description:"Pull and swap with target."}}[e]||{slot:"offensive",range:1,cooldown:0,name:e,description:e};return{id:e,name:s.name,description:s.description,slot:s.slot,cooldown:s.cooldown,currentCooldown:0,range:s.range,upgrades:[],activeUpgrades:[]}},rT={id:"pouncer_hook",name:"Pouncer Hook",description:"Second archetype reuse: enemy uses player GRAPPLE_HOOK via normal skill execution.",scenarios:[{id:"pouncer_uses_grapple_hook_deterministically",title:"Pouncer Uses Grapple Hook Through Skill Pipeline",description:"Pouncer selects GRAPPLE_HOOK from AI and resolves via standard USE_SKILL execution.",relatedSkills:["GRAPPLE_HOOK"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["parity","enemy-ai","determinism"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},[]),e.spawnEnemy("pouncer",{q:4,r:2,s:-6},"pouncer");const t=e.getEnemy("pouncer");t&&(t.activeSkills=[Cd("BASIC_MOVE"),Cd("BASIC_ATTACK"),Cd("GRAPPLE_HOOK")])},run:e=>{e.wait()},verify:(e,t)=>{const o={pouncerStillAlive:!!e.enemies.find(a=>a.id==="pouncer"),grappleExecuted:t.filter(a=>a.includes("Vaulted and Flung!")).length>=1,deterministicStatus:t.filter(a=>a.includes("You are stunned!")).length===1,noZeroEffectWarning:!t.some(a=>a.includes("produced ZERO effects"))};return Object.values(o).every(a=>a===!0)}}]},lT={id:"ice",name:"Ice Terrain",description:"ICE/SLIPPERY terrain behavior for pass-through momentum and landing slide.",scenarios:[{id:"ice_pass_preserves_dash_momentum",title:"Ice Pass: Dash Carries Momentum",description:"Passing through ICE during DASH should preserve momentum and carry movement beyond nominal target.",relatedSkills:["DASH"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["terrain","ice","momentum","pass"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["DASH"]),e.state.hasShield=!1,e.setTile({q:5,r:4,s:-9},"slippery"),e.setTile({q:6,r:4,s:-10},"floor"),e.setTile({q:7,r:4,s:-11},"floor")},run:e=>{e.useSkill("DASH",{q:6,r:4,s:-10})},verify:e=>e.player.position.q>6},{id:"ice_land_slides_after_basic_move",title:"Ice Land: Basic Move Slides Forward",description:"Landing on ICE with BASIC_MOVE should slide one hex in the move direction when the next tile is walkable.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"beginner",isTutorial:!1,tags:["terrain","ice","slide","land"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["BASIC_MOVE"]),e.setTile({q:5,r:4,s:-9},"slippery"),e.setTile({q:6,r:4,s:-10},"floor")},run:e=>{e.move({q:5,r:4,s:-9})},verify:e=>e.player.position.q===6&&e.player.position.r===4}]},cT={id:"snare",name:"Snare Terrain",description:"Snare tile effect movement restriction and status interaction.",scenarios:[{id:"snare_interrupts_dash_and_roots_actor",title:"Snare Interrupts Dash",description:"DASH into a snare tile should halt movement at snare and apply rooted status.",relatedSkills:["DASH"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["terrain","snare","movement-restriction"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["DASH"]),e.state.hasShield=!1,e.state.tiles.set("5,4",{baseId:"STONE",position:{q:5,r:4,s:-9},traits:new Set(["WALKABLE"]),effects:[{id:"SNARE",duration:-1,potency:1}]}),e.setTile({q:6,r:4,s:-10},"floor"),e.setTile({q:7,r:4,s:-11},"floor")},run:e=>{e.useSkill("DASH",{q:7,r:4,s:-11})},verify:(e,t)=>{const s=e.player.statusEffects.some(a=>a.type==="rooted"),o={stoppedAtSnare:e.player.position.q===5&&e.player.position.r===4,rootedApplied:s,snareMessageLogged:t.some(a=>a.includes("Snared! Movement halted."))};return Object.values(o).every(a=>a===!0)}}]},uT={id:"relics",name:"Relics",description:"Passive relic behaviors using existing engine hooks only.",scenarios:[{id:"relic_ember_ward_reduces_fire_damage",title:"Relic: Ember Ward",description:"Equipping Ember Ward reduces incoming fire damage by 1.",relatedSkills:["BASIC_MOVE"],category:"passive",difficulty:"beginner",isTutorial:!1,tags:["relic","fire","passive"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.upgrades=[...e.state.upgrades||[],"RELIC_EMBER_WARD"],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:(e,t)=>{const s={hpUnchanged:e.player.hp===e.player.maxHp,relicMessageSeen:t.some(o=>o.includes("Ember Ward dampens the flames."))};return Object.values(s).every(o=>o===!0)}},{id:"relic_cinder_orb_stacks_with_absorb_fire",title:"Relic: Cinder Orb Stacking",description:"Cinder Orb adds bonus healing when fire damage is converted by Absorb Fire.",relatedSkills:["ABSORB_FIRE"],category:"passive",difficulty:"advanced",isTutorial:!1,tags:["relic","stacking","absorb-fire"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["ABSORB_FIRE"]),e.state.player={...e.state.player,hp:1,maxHp:3},e.state.upgrades=[...e.state.upgrades||[],"RELIC_CINDER_ORB"],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:(e,t)=>{const s={healedByStacking:e.player.hp===3,stackingMessageSeen:t.some(o=>o.includes("Cinder Orb amplifies the absorption."))};return Object.values(s).every(o=>o===!0)}},{id:"relic_steady_plates_end_to_end",title:"Relic: Steady Plates",description:"Steady Plates grants turn-start armor that resolves against incoming damage in the same round.",relatedSkills:["BASIC_MOVE"],category:"passive",difficulty:"intermediate",isTutorial:!1,tags:["relic","armor","turn-start"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.upgrades=[...e.state.upgrades||[],"RELIC_STEADY_PLATES"],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:(e,t)=>{const s={playerHpProtected:e.player.hp===e.player.maxHp,damageEventOccurred:t.some(o=>o.includes("player burns!")),armorPresentAfterCycle:e.player.temporaryArmor>=0&&e.player.temporaryArmor<=2,relicTriggerMessageSeen:t.some(o=>o.includes("Steady Plates harden your stance."))};return Object.values(s).every(o=>o===!0)}}]},dT=250,fT=700,mT=100,pT=8,hT=220,yT=260,gT=40,N0=(e,t)=>{const s=e.floor||0,o=e.player?.hp||0,a=e.turnsSpent??e.turnNumber??0,l=e.kills||0,u=e.environmentalKills||0,f=e.hazardBreaches||0,p=(t||[]).filter(m=>m.success).length*dT;return s*fT+o*mT+l*hT+u*yT-a*pT-f*gT+p},bT=e=>{if(typeof e=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=e instanceof Date?e:new Date,s=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${s}-${o}-${a}`},ST=e=>`daily:${e}`,vT=e=>{const t=18+Math.floor(Ul(e,0)*8);return[{id:"TURN_LIMIT",label:`Finish within ${t} turns`,target:t},{id:"HAZARD_CONSTRAINT",label:"Take no hazard damage",target:0}]},Hl=e=>(e.runObjectives||[]).map(s=>{if(s.id==="TURN_LIMIT"){const a=e.turnsSpent||0;return{...s,value:a,success:a<=s.target}}const o=e.hazardBreaches||0;return{...s,value:o,success:o<=s.target}}),Fo=e=>{const t=e.initialSeed??e.rngSeed??"0",s=Hl(e),o=e.combatScoreEvents||[],a=o.length?Number((o.reduce((u,f)=>u+f.efficiency,0)/o.length).toFixed(4)):0,l=o.filter(u=>u.riskBonusApplied).length;return{seed:t,actionLog:e.actionLog,score:N0(e,s),floor:e.floor,objectives:s,combatTelemetry:{events:o.length,avgEfficiency:a,riskBonusEvents:l}}},AT={id:"objectives",name:"Objectives",description:"Daily objective validation for turn-limit and hazard constraints.",scenarios:[{id:"objective_turn_limit_boundary",title:"Objective: Turn Limit Boundary",description:"Turn-limit objective passes at boundary and fails above boundary.",relatedSkills:["BASIC_MOVE"],category:"progression",difficulty:"intermediate",isTutorial:!1,tags:["objective","turn-limit"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.runObjectives=[{id:"TURN_LIMIT",label:"Finish within 1 turns",target:1}]},run:e=>{e.wait()},verify:e=>{const s=Hl(e)[0]?.success===!0,o=Fo(e).score,a=Hl({...e,turnsSpent:(e.turnsSpent||0)+1}),l={...e,turnsSpent:(e.turnsSpent||0)+1},u=Fo(l).score,f=a[0]?.success===!1,p=u<o;return s&&f&&p}},{id:"objective_hazard_constraint_fail_on_hazard",title:"Objective: Hazard Constraint",description:"Hazard objective fails after prohibited hazard interaction.",relatedSkills:["BASIC_MOVE"],category:"hazards",difficulty:"intermediate",isTutorial:!1,tags:["objective","hazard"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.runObjectives=[{id:"HAZARD_CONSTRAINT",label:"Take no hazard damage",target:0}],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:e=>{const t=Hl(e)[0];return(e.hazardBreaches||0)>0&&!!t&&t.success===!1}}]},xT={id:"necromancer",name:"Necromancer",description:"Corpse persistence and summon migration contracts.",scenarios:[{id:"necromancer_corpse_persistence",title:"Corpse Persists Until Consumed",description:"Kill an enemy, wait 5 turns, then Raise Dead succeeds from corpse tile trait.",relatedSkills:["BASIC_ATTACK","RAISE_DEAD"],category:"summon",difficulty:"intermediate",isTutorial:!1,tags:["necromancer","corpse","persistence"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["BASIC_ATTACK","RAISE_DEAD"],"VANGUARD"),e.spawnEnemy("footman",{q:5,r:4,s:-9},"dummy");const t=e.getEnemy("dummy");t&&(t.hp=1,t.maxHp=1)},run:e=>{const t={q:5,r:4,s:-9};e.useSkill("BASIC_ATTACK",t);for(let s=0;s<5;s++)e.wait();e.useSkill("RAISE_DEAD",t)},verify:e=>{const t=ce({q:5,r:4}),s=e.tiles.get(t),o=e.enemies.find(f=>f.subtype==="skeleton"&&f.factionId==="player"),a=e.companions?.find(f=>f.id===o?.id),l=new Set((o?.activeSkills||[]).map(f=>f.id)),u={corpseConsumed:!s?.traits?.has("CORPSE"),skeletonRaised:!!o,skeletonOnCorpseTile:!!o&&o.position.q===5&&o.position.r===4,companionRegistered:!!a,hasBasicLoadout:l.has("BASIC_MOVE")&&l.has("BASIC_ATTACK")};return Object.values(u).every(Boolean)}},{id:"summon_floor_transition",title:"Summon Persists Across Floor Transition",description:"Raised skeleton migrates with player to floor 2.",relatedSkills:["RAISE_DEAD"],category:"summon",difficulty:"advanced",isTutorial:!1,tags:["necromancer","summon","floor-transition"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["RAISE_DEAD"],"VANGUARD");const t={q:5,r:4,s:-9},s=ce(t),o=e.getTileAt(t);e.state.tiles.set(s,{...o,position:t,traits:new Set([...o?.traits||[],"CORPSE"])})},run:e=>{const t={q:5,r:4,s:-9};e.useSkill("RAISE_DEAD",t),e.state.player={...e.state.player,position:{...e.state.stairsPosition}},e.wait(),e.dispatchSync({type:"RESOLVE_PENDING"})},verify:e=>{const t=e.enemies.find(o=>o.subtype==="skeleton"&&o.factionId==="player"&&o.companionOf===e.player.id),s={floorAdvanced:e.floor===2,summonStillPresent:!!t,summonTracksOwner:!!t&&t.companionOf===e.player.id};return Object.values(s).every(Boolean)}},{id:"companion_does_not_block_free_move",title:"Companion Does Not Block Exploration Free Move",description:"Friendly skeleton companion should not count as hostile for BASIC_MOVE exploration range.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["necromancer","companion","movement"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"],"VANGUARD"),e.spawnEnemy("footman",{q:5,r:5,s:-10},"friendly_skeleton");const t=e.getEnemy("friendly_skeleton");t&&(t.subtype="skeleton",t.factionId="player",t.companionOf=e.state.player.id,t.activeSkills=t.activeSkills||[],e.state.companions=[...e.state.companions||[],t])},run:e=>{e.move({q:7,r:1,s:-8})},verify:e=>{const t={movedFar:e.player.position.q===7&&e.player.position.r===1,turnsAdvanced:e.turnsSpent>=1};return Object.values(t).every(Boolean)}},{id:"raise_dead_pushes_ally_from_target_hex",title:"Raise Dead Pushes Ally Occupant",description:"If corpse tile is occupied by an ally, ally is displaced and summon succeeds without overlap.",relatedSkills:["RAISE_DEAD"],category:"summon",difficulty:"advanced",isTutorial:!1,tags:["necromancer","occupancy","push"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["RAISE_DEAD"],"VANGUARD");const t={q:5,r:5,s:-10},s=ce(t),o=e.getTileAt(t);e.state.tiles.set(s,{...o,position:t,traits:new Set([...o?.traits||[],"CORPSE"])}),e.spawnEnemy("footman",t,"ally_blocker");const a=e.getEnemy("ally_blocker");a&&(a.subtype="skeleton",a.factionId="player",a.companionOf=e.state.player.id,e.state.companions=[...e.state.companions||[],a])},run:e=>{e.useSkill("RAISE_DEAD",{q:5,r:5,s:-10})},verify:e=>{const t=e.enemies.filter(f=>f.subtype==="skeleton"&&f.factionId==="player"),s=new Set;let o=!1;t.forEach(f=>{const p=ce(f.position);s.has(p)&&(o=!0),s.add(p)});const a=t.some(f=>f.position.q===5&&f.position.r===5),l=t.some(f=>f.id==="ally_blocker"&&!(f.position.q===5&&f.position.r===5));return Object.values({raisedAtCorpse:a,pushedExists:l,noOverlap:!o}).every(Boolean)}}]},TT={id:"archer_shot",name:"Archer Shot",description:"Tests for dedicated archer ranged line-shot targeting, LoS, and axial validation.",scenarios:[{id:"archer_shot_clear_lane_hit",title:"Archer Shot: Clear Lane Hit",description:"A valid axial target in clear line of sight is damaged.",relatedSkills:["ARCHER_SHOT"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["projectile","line-of-sight","axial"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["ARCHER_SHOT"]),e.spawnEnemy("footman",{q:3,r:4,s:-7},"target")},run:e=>{e.useSkill("ARCHER_SHOT",{q:3,r:4,s:-7})},verify:(e,t)=>{const s=e.enemies.find(l=>l.id==="target"),o=!s||s.hp<s.maxHp,a=t.some(l=>l.includes("Archer shot!"));return o&&a}},{id:"archer_shot_wall_blocked",title:"Archer Shot: Wall Blocks Line of Sight",description:"Archer Shot fails when a wall blocks the line to the target actor.",relatedSkills:["ARCHER_SHOT"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["projectile","line-of-sight","wall"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},["ARCHER_SHOT"]),e.spawnEnemy("footman",{q:4,r:3,s:-7},"target"),e.setTile({q:4,r:4,s:-8},"wall")},run:e=>{e.useSkill("ARCHER_SHOT",{q:4,r:3,s:-7})},verify:(e,t)=>{const s=e.enemies.find(l=>l.id==="target"),o=!!s&&s.hp===s.maxHp,a=t.some(l=>l.includes("No clear line of sight"));return o&&a}},{id:"archer_shot_rejects_non_axial",title:"Archer Shot: Non-Axial Target Rejected",description:"Archer Shot enforces axial targeting and rejects diagonal targets.",relatedSkills:["ARCHER_SHOT"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["projectile","axial","targeting"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["ARCHER_SHOT"]),e.spawnEnemy("footman",{q:4,r:4,s:-8},"target")},run:e=>{e.useSkill("ARCHER_SHOT",{q:4,r:4,s:-8})},verify:(e,t)=>{const s=e.enemies.find(l=>l.id==="target"),o=!!s&&s.hp===s.maxHp,a=t.some(l=>l.includes("Target must be axial"));return o&&a}}]},hi=(e,t)=>{let s=t,o=e.temporaryArmor||0,a=e.hp;if(o>0){const l=Math.min(o,s);o-=l,s-=l}return a=Math.max(0,a-s),{...e,hp:a,temporaryArmor:o}},Gd=(e,t,s,o)=>{const l=nA[t]?.tickWindow||"END_OF_TURN",u=t.toUpperCase();if(e.statusEffects.find(m=>m.id===u))return{...e,statusEffects:e.statusEffects.map(m=>m.id===u?{...m,duration:Math.max(m.duration,s),tickWindow:l,stacks:o||m.stacks}:m)};const p={id:u,type:t,duration:s,tickWindow:l,stacks:o||1};return{...e,statusEffects:[...e.statusEffects,p]}},ET=(e,t)=>({...e,hp:Math.min(e.maxHp,e.hp+t)}),_T=(e,t,s=!0)=>{const o=e.maxHp+t,a=s?Math.min(o,e.hp+t):e.hp;return{...e,maxHp:o,hp:a}},MT=e=>{const t=[];return e.player.hp<=0&&e.gameStatus==="playing"&&t.push({type:"GameOver",reason:"PLAYER_DIED"}),t},qy=e=>e.activeSkills?{...e,activeSkills:e.activeSkills.map(t=>({...t,currentCooldown:Math.max(0,t.currentCooldown-1)}))}:e,wT=(e,t,s)=>e.activeSkills?{...e,activeSkills:e.activeSkills.map(o=>o.id===t&&!o.activeUpgrades.includes(s)?{...o,activeUpgrades:[...o.activeUpgrades,s]}:o)}:e,zy=(e,t,s)=>{const o=s.preserveInputOrder===!1?[...t]:[...t].reverse(),a=s.describe||(()=>"UNKNOWN");let l=e;const u=[];let f=s.startTick||1;for(;o.length>0;){const p=o.length,m=o.pop();l=s.apply(l,m);const y=s.getReactions?.(l,m)||[];if(y.length>0)for(let b=y.length-1;b>=0;b--)o.push(y[b]);u.push({tick:f++,effectType:a(m),depthBefore:p,depthAfter:o.length,reactionsQueued:y.length})}return{state:l,trace:u,resolvedCount:u.length}},CT={ModifyCooldown:(e,t,s)=>{const o=l=>({...l,activeSkills:l.activeSkills?.map(u=>u.id!==t.skillId?u:{...u,currentCooldown:t.setExact?t.amount:Math.max(0,u.currentCooldown+t.amount)})}),a=s.sourceId||e.player.id;return a===e.player.id?{...e,player:o(e.player)}:{...e,enemies:e.enemies.map(l=>l.id===a?o(l):l),companions:e.companions?.map(l=>l.id===a?o(l):l)}},SetStealth:(e,t)=>{const s=o=>({...o,stealthCounter:(o.stealthCounter||0)+t.amount});return t.target==="self"?{...e,player:s(e.player)}:{...e,enemies:e.enemies.map(o=>o.id===t.target?s(o):o),companions:e.companions?.map(o=>o.id===t.target?s(o):o)}},UpdateCompanionState:(e,t,s)=>{const o=t.target==="self"?s.sourceId||e.player.id:t.target,a=l=>l.id!==o?l:{...l,companionState:{...l.companionState,mode:t.mode||l.companionState?.mode,markTarget:t.markTarget!==void 0?t.markTarget:l.companionState?.markTarget,orbitStep:t.mode==="scout"?0:l.companionState?.orbitStep,apexStrikeCooldown:t.apexStrikeCooldown!==void 0?t.apexStrikeCooldown:l.companionState?.apexStrikeCooldown,healCooldown:t.healCooldown!==void 0?t.healCooldown:l.companionState?.healCooldown}};return{...e,enemies:e.enemies.map(a),companions:e.companions?.map(a)}}},OT=e=>{switch(e){case"body":case"vit":return"body";case"mind":case"int":case"wis":case"resolve":return"mind";case"instinct":case"dex":case"agi":return"instinct";default:return"mind"}},Vy=(e,t)=>{const s=Oe(e),o=OT(t);return o==="body"?s.body:o==="mind"?s.mind:s.instinct},kT=(e,t,s)=>Math.max(t,Math.min(s,e)),NT=(e,t,s)=>{const o=Vy(e.source,e.ailment.core.atk),a=Vy(e.target,e.ailment.core.def),l=o-a+e.skillMultiplier-(t+s);return kT(l,0,100)},RT=(e,t)=>{const{value:s,nextState:o}=_n(e),a=Math.floor(s*100)+1;return{nextState:o,roll:a,applied:a<=t}},IT=(e,t,s)=>t<=0?Math.max(0,Math.floor(s)):Math.max(0,Math.floor(s+Math.floor(e/t))),LT=(e,t,s,o)=>{const a=NT(t,s,o),l=RT(e,a),u=l.applied?IT(a,t.ailment.core.scalingFactor,t.baseDeposit):0;return{nextState:l.nextState,result:{triggerValue:a,roll:l.roll,applied:l.applied,depositAmount:u}}},Yy=(e,t)=>Math.max(0,Math.floor(e[t]||0)),Ky=(e,t,s)=>{const o={...e};return s<=0?(delete o[t],o):(o[t]=Math.floor(s),o)},BT=(e,t,s)=>{let o=Math.max(0,Math.floor(s)),a={...t};const l=[],u=[...e.interactions||[]].sort((f,p)=>p.priority-f.priority||f.target.localeCompare(p.target));for(const f of u){if(o<=0)break;const p=Yy(a,f.target);if(p<=0)continue;const m=Math.max(1e-4,f.ratio),y=p*m,b=Math.min(o,y);if(b<=0)continue;const v=Math.min(p,Math.ceil(b/m)),T=Math.max(0,p-v);a=Ky(a,f.target,T),o=Math.max(0,o-b),l.push({incoming:e.id,against:f.target,incomingNeutralized:Math.floor(b),opposingConsumed:v,ratio:m})}return a=Ky(a,e.id,Yy(a,e.id)+o),{counters:a,deposited:o,deltas:l}},PT=e=>new Map(e.components||[]),R0=e=>{const t=e.components?.get("ailment_profile");return t||{type:"ailment_profile",baseResistancePct:{},resistanceGrowthRate:1}},I0=e=>{const t=e.components?.get("ailment_resilience");return t||{type:"ailment_resilience",xp:{},resistancePct:{}}},HT=(e,t)=>{const s=e/t.xpToResistance;return Math.max(0,Math.min(t.capPct,s))},jT=(e,t)=>{const s=R0(e);return Math.max(0,Math.min(100,Number(s.baseResistancePct?.[t]||0)))},L0=(e,t)=>{const s=I0(e);return Math.max(0,Math.min(100,Number(s.resistancePct?.[t]||0)))},DT=(e,t,s,o)=>{const a=R0(e),l=I0(e),u=Math.max(0,Number(a.resistanceGrowthRate||1)),f=Math.max(0,s*u),p=Math.max(0,Number(l.xp?.[t]||0)),m=Math.max(0,Number(l.resistancePct?.[t]||0)),y=p+f,b=HT(y,o.hardening),v={...l,xp:{...l.xp||{},[t]:y},resistancePct:{...l.resistancePct||{},[t]:b}},T=PT(e);return T.set("ailment_profile",a),T.set("ailment_resilience",v),{actor:{...e,components:T},previousPct:m,nextPct:b,gainedPct:Math.max(0,b-m),previousXp:p,nextXp:y}},UT=(e,t)=>t==="floor"?Math.floor(e):t==="ceil"?Math.ceil(e):t==="round"?Math.round(e):e,$T=(e,t,s)=>{let o=e;return typeof t=="number"&&(o=Math.max(t,o)),typeof s=="number"&&(o=Math.min(s,o)),o},qT=(e,t)=>{switch(t){case"currentCounters":return e.currentCounters;case"resiliencePct":return e.resiliencePct;case"maxHp":return e.maxHp;case"body":return e.body;case"mind":return e.mind;case"instinct":return e.instinct;default:return 0}},Fy=(e,t)=>{if(!e)return 0;const s=(e.terms||[]).reduce((u,f)=>u+qT(t,f.variable)*f.coefficient,0),o=e.base+s,a=UT(o,e.round),l=$T(a,e.min,e.max);return Number.isFinite(l)?l:0},zT=e=>Math.max(0,Math.floor(e)),VT=e=>{const t=Math.max(0,Math.floor(Fy(e.definition.tick?.damage,e.formulaContext))),s=Math.max(0,Math.floor(Fy(e.definition.tick?.decay,e.formulaContext))),o=zT(e.counters-s),a=(e.definition.thresholds||[]).filter(l=>o>=l.count).map(l=>l.effectId);return{nextCounters:o,damage:t,decay:s,thresholdEffects:a}};var YT={};const KT="acae-v1",FT=e=>({q:e.q,r:e.r,s:e.s}),Wy=e=>Math.max(0,Math.min(100,e)),WT=(e,t)=>{const s=(e.simulationEvents||[]).length;return`sim:${e.turnNumber||0}:${s}:${t}`},XT=(e,t,s)=>{const o=(e.timelineEvents||[]).length,a=e.turnNumber||0,l=s.sourceId||s.targetId||"system";return`${s.stepId||`${a}:${l}`}:${o}:${t}`},ts=(e,t)=>{const s={...t,id:WT(e,t.type),turn:e.turnNumber||0};return{...e,simulationEvents:[...e.simulationEvents||[],s]}},yf=(e,t,s,o,a)=>{const l=a.sourceId||a.targetId,u=e.turnNumber||0,f=a.stepId||`${u}:${l||"system"}`,p={id:XT(e,t,a),turn:u,actorId:l,groupId:f,stepId:a.stepId||f,phase:t,type:s,payload:o,blocking:!1,suggestedDurationMs:0};return{...e,timelineEvents:[...e.timelineEvents||[],p]}},GT=e=>typeof e=="object"&&e!==null&&e.type==="ailments",JT=e=>typeof e=="object"&&e!==null&&e.type==="ailment_resilience",QT=e=>typeof e=="object"&&e!==null&&e.type==="ailment_profile",B0=e=>{const t=e.components?.get("ailments");return GT(t)?t:{type:"ailments",counters:{}}},ZT=e=>{const t=e.components?.get("ailment_resilience");return JT(t)?t:{type:"ailment_resilience",xp:{},resistancePct:{}}},eE=e=>{const t=e.components?.get("ailment_profile");return QT(t)?t:{type:"ailment_profile",baseResistancePct:{},resistanceGrowthRate:1}},P0=(e,t,s,o)=>{const a=new Map(e.components||[]),l={};return Object.keys(t).forEach(u=>{const f=Math.max(0,Math.floor(t[u]||0));f>0&&(l[u]=f)}),a.set("ailments",{type:"ailments",counters:l}),a.set("ailment_resilience",ZT(e)),a.set("ailment_profile",eE(e)),{...e,components:a}},gi=(e,t)=>e.player.id===t?e.player:e.enemies.find(s=>s.id===t)||e.companions?.find(s=>s.id===t),tE=(e,t)=>J(e.player.position,t)?e.player:e.enemies.find(s=>J(s.position,t))||e.companions?.find(s=>J(s.position,t)),nc=(e,t,s)=>{const o=e.player.id===t?s:e.player,a=e.enemies.map(u=>u.id===t?s:u),l=e.companions?.map(u=>u.id===t?s:u);return{...e,player:o,enemies:a,companions:l}},nE=(e,t)=>e.player.id===t?e:{...e,enemies:e.enemies.filter(s=>s.id!==t),companions:e.companions?.filter(s=>s.id!==t)},gf=(e,t,s)=>{if(typeof t=="string"){if(t==="targetActor"){if(!s.targetId)return;const l=gi(e,s.targetId);return l?{actorId:l.id,actor:l}:void 0}const a=gi(e,t);return a?{actorId:a.id,actor:a}:void 0}const o=tE(e,t);return o?{actorId:o.id,actor:o}:void 0},Jd=(e,t)=>Math.max(0,Math.floor(B0(e).counters[t]||0)),H0=e=>({...B0(e).counters}),iE=(e,t,s,o,a)=>{let l=e;for(const u of s.thresholds||[])o<u.count&&a>=u.count&&(l=ts(l,{type:"AilmentThresholdTriggered",actorId:t,targetId:t,payload:{ailment:s.id,threshold:u.count,effectId:u.effectId,message:u.message,bonusDamage:u.bonusDamage||0}}));return l},Qd=(e,t,s,o,a)=>{if(o<=0)return e;const l=ql(s);if(!l)return e;const u=gi(e,t);if(!u)return e;const f=DT(u,s,o,l);let p=nc(e,t,f.actor);return f.gainedPct>0&&(p=ts(p,{type:"AilmentResilienceGained",actorId:t,targetId:t,payload:{ailment:s,previousPct:f.previousPct,nextPct:f.nextPct,gainedPct:f.gainedPct,source:a}})),p},bi=e=>e.ruleset?.ailments?.acaeEnabled===!0,bf=e=>{const t=typeof process<"u"&&YT?.HOP_ACAE_ENABLED==="1";return{...e.ruleset||{},ailments:{acaeEnabled:e.ruleset?.ailments?.acaeEnabled??t,version:KT}}},sE=(e,t,s,o,a,l={},u="skill")=>{if(!bi(e))return e;const f=gf(e,t,l);if(!f)return e;const p=ql(s);if(!p)return e;const y=(l.sourceId?gi(e,l.sourceId):void 0)||f.actor,b=f.actor,v=Wy(jT(b,s)),T=Wy(L0(b,s)),S=LT(e,{ailment:p,source:y,target:b,skillMultiplier:o+(p.core.skillMultiplierBase||0),baseDeposit:Math.max(0,a??p.core.baseDeposit)},v,T);let x=yf(S.nextState,"AILMENT_APPLY","ApplyAilment",{ailment:s,triggerValue:S.result.triggerValue,roll:S.result.roll,target:f.actorId,source:u},l);return!S.result.applied||S.result.depositAmount<=0?ts(x,{type:"AilmentChanged",actorId:l.sourceId,targetId:f.actorId,payload:{ailment:s,applied:!1,triggerValue:S.result.triggerValue,roll:S.result.roll,deposited:0,source:u}}):(x=j0(x,f.actorId,s,S.result.depositAmount,l,u),ts(x,{type:"AilmentChanged",actorId:l.sourceId,targetId:f.actorId,payload:{ailment:s,applied:!0,triggerValue:S.result.triggerValue,roll:S.result.roll,deposited:S.result.depositAmount,source:u}}))},j0=(e,t,s,o,a={},l="system")=>{if(!bi(e))return e;const u=gf(e,t,a);if(!u)return e;const f=ql(s);if(!f)return e;const p=Math.max(0,Math.floor(o));if(p<=0)return e;const m=H0(u.actor),y=Math.max(0,Math.floor(m[s]||0)),b=BT(f,m,p),v=Math.max(0,Math.floor(b.counters[s]||0));let T=P0(u.actor,b.counters),S=nc(e,u.actorId,T);S=yf(S,"AILMENT_ANNIHILATE","DepositAilmentCounters",{ailment:s,amount:p,deposited:b.deposited,source:l,target:u.actorId},a),S=ts(S,{type:"AilmentChanged",actorId:a.sourceId,targetId:u.actorId,payload:{ailment:s,before:y,after:v,delta:v-y,source:l}});for(const _ of b.deltas)if(S=ts(S,{type:"AilmentAnnihilated",actorId:a.sourceId,targetId:u.actorId,payload:{incoming:_.incoming,against:_.against,incomingNeutralized:_.incomingNeutralized,opposingConsumed:_.opposingConsumed,ratio:_.ratio}}),_.incomingNeutralized>0&&(S=Qd(S,u.actorId,_.incoming,_.incomingNeutralized*f.hardening.shockXpRate,"shock")),_.opposingConsumed>0){const E=ql(_.against);E&&(S=Qd(S,u.actorId,_.against,_.opposingConsumed*E.hardening.shockXpRate,"shock"))}const x=gi(S,u.actorId);if(x){const _=Jd(x,s);S=iE(S,u.actorId,f,y,_)}return S},D0=(e,t,s,o,a,l={})=>{if(!bi(e))return e;const u=gf(e,t,l);if(!u)return e;const f=H0(u.actor),p={...f},m=[];if(!s)Object.keys(p).forEach(v=>{(p[v]||0)>0&&(m.push(v),delete p[v])});else{const v=Math.max(0,Math.floor(p[s]||0)),T=o===void 0?v:Math.max(0,Math.floor(o)),S=Math.max(0,v-T);S!==v&&m.push(s),S>0?p[s]=S:delete p[s]}if(m.length===0)return e;const y=P0(u.actor,p);let b=nc(e,u.actorId,y);for(const v of m){const T=Math.max(0,Math.floor(f[v]||0)),S=Math.max(0,Math.floor(p[v]||0));b=ts(b,{type:"AilmentChanged",actorId:l.sourceId,targetId:u.actorId,payload:{ailment:v,before:T,after:S,delta:S-T,reason:a||"clear"}})}return b},aE=(e,t,s,o,a)=>{if(o<=0)return e;const l=gi(e,t);if(!l)return e;const u=hi(l,o);let f=nc(e,t,u);return f=ts(f,{type:"DamageTaken",actorId:a.sourceId,targetId:t,position:FT(u.position),payload:{amount:o,reason:`acae_${s}_tick`,sourceId:a.sourceId}}),u.hp<=0&&t!==f.player.id&&(f=nE(f,t)),f},U0=(e,t,s,o)=>{if(!bi(e))return{state:e,messages:[]};if(!gi(e,t))return{state:e,messages:[]};let l=e;const u=[],f={sourceId:t,targetId:t,stepId:o},p=ZA();for(const m of p){const y=gi(l,t);if(!y)break;const b=Jd(y,m.id);if(b<=0)continue;const v=Oe(y),T=L0(y,m.id),S=VT({definition:m,counters:b,formulaContext:{currentCounters:b,resiliencePct:T,maxHp:y.maxHp,body:v.body,mind:v.mind,instinct:v.instinct}});l=yf(l,"AILMENT_TICK","AilmentTick",{ailment:m.id,actorId:t,window:s,counters:b,damage:S.damage,decay:S.decay},f),l=aE(l,t,m.id,S.damage,f),l=D0(l,t,m.id,S.decay,"tick_decay",f);const x=gi(l,t);if(!x)break;const _=b*Math.max(0,m.hardening.tickXpRate);l=Qd(l,t,m.id,_,"tick");const E=(m.thresholds||[]).filter(w=>Jd(x,m.id)>=w.count).sort((w,M)=>M.count-w.count)[0];E?.message&&u.push(E.message)}return{state:l,messages:u}},oE=e=>{const t=new Map;for(const s of e){if(s.type!=="AilmentChanged")continue;const o=s.payload?.ailment,a=Number(s.payload?.delta||0);!o||!Number.isFinite(a)||a===0||t.set(o,(t.get(o)||0)+a)}return Array.from(t.entries()).sort((s,o)=>s[0].localeCompare(o[0])).map(([s,o])=>`${o>0?"+":""}${o} ${s.charAt(0).toUpperCase()}${s.slice(1)}`)},rE=(e,t,s,o,a)=>bi(e)?o<=0?[]:[{type:"DepositAilmentCounters",target:t,ailment:s,amount:Math.max(0,Math.floor(o)),source:a}]:[],lE=(e,t,s,o)=>{if(!bi(e))return[];const a={lava:{pass:8,enter:14,stay:10},fire:{pass:4,enter:6,stay:5},wet:{pass:3,enter:5,stay:4},miasma:{pass:4,enter:7,stay:6},ice:{pass:2,enter:4,stay:3}},l={lava:"burn",fire:"burn",wet:"wet",miasma:"poison",ice:"frozen"};return rE(e,t.id,l[s],a[s][o],"tile")},cE={ApplyAilment:(e,t,s)=>sE(e,t.target,t.ailment,t.skillMultiplier||0,t.baseDeposit,s,"skill"),DepositAilmentCounters:(e,t,s)=>j0(e,t.target,t.ailment,t.amount,s,t.source||"system"),ClearAilmentCounters:(e,t,s)=>D0(e,t.target,t.ailment,t.amount,t.reason,s)},uE={SpawnCorpse:(e,t,s,o)=>o.addCorpseTraitAt(e,t.position),RemoveCorpse:(e,t,s,o)=>{const a=o.removeCorpseTraitAt(e,t.position);return{...a,dyingEntities:(a.dyingEntities||[]).filter(l=>!J(l.position,t.position))}}},dE=/^\[(INFO|VERBOSE|DEBUG|CRITICAL)\|([A-Z_]+)\]\s*/i,fE=e=>dE.test(e),Sf=(e,t="INFO",s="SYSTEM")=>e?fE(e)?e:`[${t}|${s}] ${e}`:"",mE=(e,t="INFO",s="SYSTEM")=>e.map(o=>Sf(o,t,s)).filter(Boolean),it=(e,t,s,o,a=50)=>{const l=Sf(t,s,o),u=[...e||[]];return l&&u[u.length-1]===l?u.slice(-a):[...u,l].slice(-a)},Vn=(e,t,s,o,a=50)=>{const l=[...e||[]];let u;for(const f of mE(t,s,o))f&&u===f||(l.push(f),u=f);return l.slice(-a)},pE=["lava_sink","void_sink","hazard_intercept","lava_tick","fire_damage"],hE=["fire_damage","lava_sink","burning","hazard_intercept","lava_tick","oil_explosion","void_sink"],Xy=(e,t)=>!!e&&t.includes(e),Bo=e=>e?.statusEffects?.some(t=>t.type==="marked_predator")?1:0,yE={Damage:(e,t,s,o)=>{let a={...e};Xy(t.reason,pE)&&(a=o.appendTimelineEvent(a,"HAZARD_CHECK","Damage",{reason:t.reason,amount:t.amount,target:t.target},s,!0,200)),a=o.appendTimelineEvent(a,"DAMAGE_APPLY","Damage",{reason:t.reason,amount:t.amount,target:t.target,scoreEvent:t.scoreEvent},s,!0,180);let u="",f=null,p,m,y=t.amount;typeof t.target=="string"?t.target==="targetActor"?u=s.targetId||"":t.target!=="area"&&(u=t.target):f=t.target;const b=Xy(t.reason,hE),v=a.upgrades?.includes("RELIC_EMBER_WARD"),T=a.upgrades?.includes("RELIC_CINDER_ORB");if(b&&u){const x=(u===a.player.id?a.player:a.enemies.find(E=>E.id===u))?.activeSkills?.some(E=>E.id==="ABSORB_FIRE");let _=t.amount;if(u===a.player.id&&v&&(_=Math.max(0,_-1),a.message=it(a.message,"Ember Ward dampens the flames.","INFO","COMBAT")),x){const E=_+(u===a.player.id&&T?1:0);return u===a.player.id&&T&&(a.message=it(a.message,"Cinder Orb amplifies the absorption.","INFO","COMBAT")),o.applyAtomicEffect(a,{type:"Heal",target:u,amount:E})}}if(u)if(u===a.player.id){const S=a.player,x=t.scoreEvent?.damageClass||"physical",_=o.scaleCombatProfileDamage(a,t.amount,s.sourceId,S,x,t.reason);let E=_.amount;E+=Bo(S),b&&v&&(E=Math.max(0,E-1)),t.scoreEvent&&(a.combatScoreEvents=[...a.combatScoreEvents||[],{...t.scoreEvent,finalPower:E,traitOutgoingMultiplier:_.outgoing,traitIncomingMultiplier:_.incoming,traitTotalMultiplier:_.total}].slice(-500)),a.player=hi(a.player,E),p=a.player.id,m=a.player.position,y=E,b&&(a.hazardBreaches=(a.hazardBreaches||0)+1),b&&T&&(a.player=ET(a.player,1),a.message=it(a.message,"Cinder Orb restores 1 HP.","INFO","COMBAT"))}else{const S=a.enemies.find(R=>R.id===u),x=u===a.player.id?a.player.position:S?.position,_=[],E=t.scoreEvent?.damageClass||"physical",w=o.scaleCombatProfileDamage(a,t.amount,s.sourceId,S,E,t.reason),M=w.amount+Bo(S);p=u||S?.id,m=x||S?.position,y=M;const k=R=>{if(R.id===u){const O=hi(R,M);return O.hp<=0&&(a.dyingEntities=[...a.dyingEntities||[],R],_.push(R.position)),O}return R};if(t.scoreEvent&&(a.combatScoreEvents=[...a.combatScoreEvents||[],{...t.scoreEvent,finalPower:M,traitOutgoingMultiplier:w.outgoing,traitIncomingMultiplier:w.incoming,traitTotalMultiplier:w.total}].slice(-500)),a.enemies=a.enemies.map(k).filter(R=>R.hp>0),a.companions&&(a.companions=a.companions.map(k).filter(R=>R.hp>0)),_.length>0&&(a=o.appendTimelineEvent(a,"DEATH_RESOLVE","Damage",{targetActorId:u,reason:t.reason||"damage"},{...s,targetId:u},!0,260)),_.forEach(R=>{a=o.addCorpseTraitAt(a,R)}),x&&(a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"impact",position:x}}]),u===a.player.id&&(a.player.stealthCounter||0)>0)a.player={...a.player,stealthCounter:Math.max(0,(a.player.stealthCounter||0)-1)};else if(u!==a.player.id){const R=O=>O.id===u?{...O,stealthCounter:Math.max(0,(O.stealthCounter||0)-1)}:O;a.enemies=a.enemies.map(R),a.companions&&(a.companions=a.companions.map(R))}u===a.player.id&&a.player.archetype==="HUNTER"&&t.source&&Hn(t.source,a.player.position)!==-1&&(a.message=it(a.message,"You roll away!","INFO","COMBAT")),S&&S.archetype==="HUNTER"&&t.source&&Hn(t.source,S.position)!==-1&&(a.message=it(a.message,`${S.subtype||S.id} rolls away!`,"INFO","COMBAT"))}else if(f){const S=o.resolveActorAt(a,f),x=t.scoreEvent?.damageClass||"physical",_=o.scaleCombatProfileDamage(a,t.amount,s.sourceId,S,x,t.reason),E=_.amount;p=S?.id,m=f,y=E+Bo(S||void 0),a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"impact",position:f}}],t.scoreEvent&&S&&(a.combatScoreEvents=[...a.combatScoreEvents||[],{...t.scoreEvent,targetId:S.id,finalPower:E,traitOutgoingMultiplier:_.outgoing,traitIncomingMultiplier:_.incoming,traitTotalMultiplier:_.total}].slice(-500)),J(a.player.position,f)&&(a.player=hi(a.player,E+Bo(a.player)),b&&(a.hazardBreaches=(a.hazardBreaches||0)+1));const w=R=>{if(J(R.position,f)){const O=hi(R,E+Bo(R));return O.hp<=0&&(a.dyingEntities=[...a.dyingEntities||[],R],k.push(R.id),M.push(R.position)),O}return R},M=[],k=[];a.enemies=a.enemies.map(w).filter(R=>R.hp>0),a.companions&&(a.companions=a.companions.map(w).filter(R=>R.hp>0)),k.forEach(R=>{a=o.appendTimelineEvent(a,"DEATH_RESOLVE","Damage",{targetActorId:R,reason:t.reason||"area_damage"},{...s,targetId:R},!0,260)}),M.forEach(R=>{a=o.addCorpseTraitAt(a,R)})}return y>0&&(a=o.appendSimulationEvent(a,{type:"DamageTaken",targetId:p||u||void 0,position:m,payload:{amount:y,reason:t.reason,sourceId:s.sourceId}})),a}},Ie={getNeighbors(e){return Ue(e)},isTileBlocked(e,t){return!e.occupancyMask||e.occupancyMask.length===0?!1:Wd(e.occupancyMask,t)},refreshOccupancyMask(e){let t=mA(e.gridWidth,e.gridHeight);return e.tiles?.forEach(s=>{(s.baseId==="WALL"||s.traits?.has("BLOCKS_MOVEMENT"))&&(t=Td(t,s.position))}),e.player&&(t=Td(t,e.player.position)),e.enemies?.forEach(s=>{t=Td(t,s.position)}),t},getMovementRange(e,t,s){const o=new Map,a=[],l=p=>`${p.q},${p.r}`,u=ye(e,t),f=[{p:t,cost:0}];for(o.set(l(t),0);f.length;){const p=f.shift();if(!(p.cost>=s))for(const m of this.getNeighbors(p.p)){if(!this.isWithinBounds(e,m)||!we.isWalkable(e,m))continue;const y=ye(e,m),b=y&&!J(m,t),v=b&&u&&y.factionId===u.factionId;if(b&&!v)continue;const T=l(m),S=p.cost+1;(!o.has(T)||o.get(T)>S)&&(o.set(T,S),v||a.push(m),f.push({p:m,cost:S}))}}return a},getAxialTargets(e,t,s,o={}){const{includeWalls:a=!1,includeActors:l=!0,stopAtObstacles:u=!0}=o,f=[];for(let p=0;p<6;p++)for(let m=1;m<=s;m++){const y=Kt(t,ff(p,m));if(!this.isWithinBounds(e,y))break;const v=we.getTileAt(e,y)?.baseId==="WALL",T=ye(e,y);if(v){if(a&&f.push(y),u)break}else if(T){if(l&&f.push(y),u)break}else f.push(y)}return f},getAreaTargets(e,t,s){const o=[];for(let a=-s;a<=s;a++)for(let l=Math.max(-s,-a-s);l<=Math.min(s,-a+s);l++){const u=Kt(t,Xt(a,l));this.isWithinBounds(e,u)&&o.push(u)}return o},isWithinBounds(e,t){return Zi(t,e.gridWidth,e.gridHeight)},getAxialTargetsWithOptions(e,t,s,o){return this.getAxialTargets(e,t,s,o)}};class Cs{static hasFireProtection(t){return t.statusEffects.some(s=>s.type==="fire_immunity")||t.activeSkills?.some(s=>s.id==="ABSORB_FIRE")||!1}static isFireHazard(t,s){return t.baseId==="LAVA"||s.has("LAVA")||s.has("FIRE")}static appendAcaeTileInjection(t,s,o,a,l,u){const f=lE(s,o,a,l);f.length!==0&&this.mergeResults(t,{effects:f,messages:u?[u]:[]})}static mergeResults(t,s){t.effects.push(...s.effects),t.messages.push(...s.messages),s.newMomentum!==void 0&&(t.newMomentum=s.newMomentum),s.interrupt&&(t.interrupt=!0),s.modifyTile&&(t.modifyTile={...t.modifyTile,...s.modifyTile})}static processEntry(t,s,o){const a={effects:[],messages:[],interrupt:!1},l={tile:s,actor:t,state:o,isFinalDestination:!0,source:t.previousPosition},u=we.getTraitsForTile(o,s),f=bi(o);let p=!1;if(u.has("HAZARDOUS")&&!t.isFlying){const m=this.isFireHazard(s,u)&&this.hasFireProtection(t);f&&this.isFireHazard(s,u)&&!m?(this.appendAcaeTileInjection(a,o,t,s.baseId==="LAVA"||u.has("LAVA")?"lava":"fire","enter",s.baseId==="LAVA"||u.has("LAVA")?"Lava scorches you.":"Flames lick at your armor."),p=!0):m||(s.baseId==="LAVA"||u.has("LAVA")?this.mergeResults(a,{effects:[{type:"Damage",target:t.id,amount:99,reason:"lava_sink"},{type:"Juice",effect:"lavaSink",target:t.position}],messages:["Lava Sink! You were engulfed by lava!"],interrupt:!0}):(s.baseId==="VOID"||u.has("VOID"))&&this.mergeResults(a,{effects:[{type:"Damage",target:t.id,amount:99,reason:"void_sink"},{type:"Juice",effect:"lavaSink",target:t.position}],messages:["Void consumes your soul!"],interrupt:!0}))}if(f&&!t.isFlying){s.baseId==="ICE"&&this.appendAcaeTileInjection(a,o,t,"ice","enter");for(const m of s.effects)m.id==="WET"?this.appendAcaeTileInjection(a,o,t,"wet","enter"):m.id==="MIASMA"?this.appendAcaeTileInjection(a,o,t,"miasma","enter"):m.id==="FIRE"&&!p&&(this.appendAcaeTileInjection(a,o,t,"fire","enter"),p=!0)}for(const m of s.effects){const y=$o[m.id];if(!y?.onEnter)continue;const b=y.onEnter(l);if(this.mergeResults(a,b),a.interrupt)break}return a.messages.length===0&&a.effects.some(m=>m.type==="LavaSink")&&a.messages.push("Lava Sink! You were engulfed by lava!"),a}static processTransition(t,s,o,a,l={}){const{ignoreActors:u=!1,ignoreGroundHazards:f=!1}=l,p={effects:[],messages:[],newMomentum:a!==void 0?Math.max(0,a-1):void 0,interrupt:!1},m=we.getTraitsForTile(o,s),y=bi(o);let b=!1;if(m.has("BLOCKS_MOVEMENT")||!u&&(o.enemies.find(S=>S.id!==t.id&&S.hp>0&&J(S.position,s.position))||(t.id!==o.player.id&&J(o.player.position,s.position)?o.player:void 0)))return p.interrupt=!0,p.newMomentum=0,p;const v={tile:s,actor:t,state:o,momentum:a,isFinalDestination:!1,source:t.previousPosition};if(m.has("HAZARDOUS")&&!t.isFlying&&!f){const T=this.isFireHazard(s,m)&&this.hasFireProtection(t);y&&this.isFireHazard(s,m)&&!T?(this.appendAcaeTileInjection(p,o,t,s.baseId==="LAVA"||m.has("LAVA")?"lava":"fire","pass"),b=!0):T?this.mergeResults(p,{effects:[{type:"Damage",target:t.id,amount:99,reason:"hazard_intercept"}],messages:["Flames surge through you."],interrupt:!1}):this.mergeResults(p,{effects:[{type:"Damage",target:t.id,amount:99,reason:"hazard_intercept"},{type:"Juice",effect:"lavaSink",target:s.position}],messages:[s.baseId==="LAVA"||m.has("LAVA")?"Sunk in Lava!":"Consumed by Void!"],interrupt:!0})}else m.has("SLIPPERY")?p.newMomentum=Math.max(1,a||0):m.has("LIQUID")&&a!==void 0&&a>0&&(p.newMomentum=Math.max(0,a-1));for(const T of s.effects){const S=$o[T.id];if(!S?.onPass)continue;const x=S.onPass(v);if(this.mergeResults(p,x),p.interrupt)break}if(!p.interrupt&&!t.isFlying&&!f&&o.traps){const T=o.traps.find(S=>J(S.position,s.position)&&S.cooldown===0&&S.ownerId!==t.id);if(T){const S=s.position.q-T.position.q||1,x=s.position.r-T.position.r||0;let _=0;S>0&&x===0?_=0:S>0&&x<0?_=1:S===0&&x<0?_=2:S<0&&x===0?_=3:S<0&&x>0?_=4:_=5;const E=3;let w=s.position;const k=(R=>[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0},{q:0,r:1,s:-1}][R%6])(_);for(let R=0;R<E;R++){const O={q:w.q+k.q,r:w.r+k.r,s:w.s+k.s};if(!we.isWalkable(o,O))break;w=O}if(this.mergeResults(p,{effects:[{type:"SetTrapCooldown",position:T.position,ownerId:T.ownerId,cooldown:T.resetCooldown??2},{type:"Displacement",target:t.id,destination:w,source:s.position,isFling:!0},{type:"Juice",effect:"kineticWave",target:s.position,intensity:"high"},{type:"Juice",effect:"combat_text",target:s.position,text:"TRAP!"}],messages:[`${t.subtype||"Unit"} triggered a kinetic trap!`],interrupt:!0}),T.volatileCore&&this.mergeResults(p,{effects:[{type:"Damage",target:t.id,amount:1,reason:"trap_volatile_core"}],messages:["Volatile core detonates!"]}),T.chainReaction&&o.traps){const R=o.traps.filter(O=>O.ownerId===T.ownerId&&O.cooldown===0&&!J(O.position,T.position)&&Ue(T.position).some(I=>J(I,O.position)));for(const O of R)this.mergeResults(p,{effects:[{type:"SetTrapCooldown",position:O.position,ownerId:O.ownerId,cooldown:O.resetCooldown??2}],messages:["Chain reaction sparks nearby traps!"]}),O.volatileCore&&this.mergeResults(p,{effects:[{type:"Damage",target:t.id,amount:1,reason:"trap_chain_volatile"}],messages:["Chain blast!"]})}}}if(y&&!t.isFlying&&!f){s.baseId==="ICE"&&this.appendAcaeTileInjection(p,o,t,"ice","pass");for(const T of s.effects)T.id==="WET"?this.appendAcaeTileInjection(p,o,t,"wet","pass"):T.id==="MIASMA"?this.appendAcaeTileInjection(p,o,t,"miasma","pass"):T.id==="FIRE"&&!b&&(this.appendAcaeTileInjection(p,o,t,"fire","pass"),b=!0)}return p}static processStay(t,s,o){const a={effects:[],messages:[]},l={tile:s,actor:t,state:o,isFinalDestination:!1},u=we.getTraitsForTile(o,s),f=bi(o);if((s.baseId==="LAVA"||u.has("LAVA"))&&!t.isFlying&&!t.statusEffects.some(p=>p.type==="fire_immunity"))if(f)this.appendAcaeTileInjection(a,o,t,"lava","stay","Molten heat builds up.");else{const p=t.id==="player";this.mergeResults(a,{effects:[{type:"Damage",target:t.id,amount:p?1:99,reason:"lava_tick"}],messages:["Lava Sink! You were engulfed by lava!"]})}if(f&&!t.isFlying){s.baseId==="ICE"&&this.appendAcaeTileInjection(a,o,t,"ice","stay");for(const p of s.effects)p.id==="WET"?this.appendAcaeTileInjection(a,o,t,"wet","stay"):p.id==="MIASMA"&&this.appendAcaeTileInjection(a,o,t,"miasma","stay")}for(const p of s.effects){const m=$o[p.id];if(!m?.onStay)continue;const y=m.onStay(l);this.mergeResults(a,y)}return a}static applyEffect(t,s,o,a,l,u){const f=$o[s];if(!f)return{effects:[],messages:[]};const p={effects:[],messages:[]};for(const m of t.effects){const y=f.interactsWith?.[m.id];if(y){const b=y({tile:t,state:l,potency:a,sourceId:u});return this.mergeResults(p,b),p}}if(f.onApply){const m=f.onApply({tile:t,state:l,potency:a,sourceId:u});this.mergeResults(p,m)}return p.modifyTile?.effects?p.modifyTile&&(t.effects=p.modifyTile.effects):t.effects.push({id:s,duration:o,potency:a,sourceId:u}),p}static processPath(t,s,o,a,l={}){let u=t.position,f=a,p={effects:[],messages:[],newMomentum:a,interrupt:!1};for(const m of s){const y=we.getTileAt(o,m),b=we.getTraitsForTile(o,y),v=this.processTransition(t,y,o,f,l);if(v.interrupt&&b.has("BLOCKS_MOVEMENT")){p.interrupt=!0;break}if(u=m,this.mergeResults(p,v),p.interrupt){p.interrupt=!0;break}if(f=p.newMomentum,f!==void 0&&f<=0)break}return{lastValidPos:u,result:p,interrupt:!!p.interrupt}}static getMovementCost(t,s){const o=we.getTraitsForTile(t,s);let a=1;return o.has("HAZARDOUS")&&(a+=5),o.has("LIQUID")&&(a+=1),o.has("FIRE")&&(a+=2),a}}const gE={Displacement:(e,t,s,o)=>{let a={...e},l="";if(t.target==="self"?l=s.sourceId||a.player.id:t.target==="targetActor"?l=s.targetId||"":l=t.target,!l)return a;const u=(O,I)=>I===O.player.id?O.player:O.enemies.find(D=>D.id===I),f=u(a,l);if(!f)return a;const p=t.source||f.position,m=Math.min(3200,Math.max(0,o.getBlockingTimelineDurationMs(a.timelineEvents)));let y=!1;const b=!(t.simulatePath||t.path||t.isFling);if(p&&(a=o.appendTimelineEvent(a,"MOVE_START","Displacement",{origin:p,destination:t.destination,targetActorId:l},{...s,targetId:l},!0,220)),!p)return a;const v=t.path||Ze(p,t.destination),T=t.simulatePath||t.isFling||!!t.path;let S=t.destination;if(T&&v){const O=u(a,l);if(!O)return a;const I=Cs.processPath(O,v.slice(1),a,v.length-1,{ignoreActors:t.ignoreCollision,ignoreGroundHazards:t.ignoreGroundHazards});S=I.lastValidPos,l===a.player.id?a.player={...a.player,position:S}:a.enemies=a.enemies.map(j=>j.id===l?{...j,position:S}:j),y||(a=o.appendTimelineEvent(a,"MOVE_END","Displacement",{destination:S,targetActorId:l},{...s,targetId:l},!0,260),y=!0),I.result.effects.length>0&&(a=o.appendTimelineEvent(a,"ON_PASS","TilePath",{path:v.slice(1),targetActorId:l},{...s,targetId:l},!1,80),a=o.applyEffects(a,I.result.effects,{targetId:l})),I.result.messages.length>0&&(a.message=Vn(a.message,I.result.messages,"INFO","HAZARD"));const D=l===a.player.id||a.enemies.some(j=>j.id===l);if(!I.interrupt&&D){const j=we.getTileAt(a,S);a=o.appendTimelineEvent(a,"ON_ENTER","TileEnter",{position:S,targetActorId:l,tileBaseId:j?.baseId},{...s,targetId:l},!1,80);const U=u(a,l);if(!U)return a;const q=Cs.processEntry(U,j,a);q.effects.length>0&&(a=o.applyEffects(a,q.effects,{targetId:l})),q.messages.length>0&&(a.message=Vn(a.message,q.messages,"INFO","HAZARD"))}if(I.result.newMomentum&&I.result.newMomentum>0){const j=I.lastValidPos,U=v.length>1?v[v.length-2]:p,q=Hn(U,j);if(q!==-1){const se=Mt(q);let ee=j,oe=5;for(;oe>0;){const F=Kt(ee,se);if(!we.isWalkable(a,F)||(l===a.player.id?a.enemies.find(Z=>Z.hp>0&&J(Z.position,F)):J(a.player.position,F)?a.player:a.enemies.find(Z=>Z.id!==l&&Z.hp>0&&J(Z.position,F))))break;const z=we.getTileAt(a,F);if(z){const Z=Cs.processTransition(f,z,a,1);if(ee=F,Z.effects.length>0&&(a=o.applyEffects(a,Z.effects,{targetId:l})),Z.messages.length>0&&(a.message=Vn(a.message,Z.messages,"INFO","HAZARD")),Z.newMomentum===0||Z.interrupt)break}else{ee=F;break}oe--}S=ee}}}const x=[...a.visualEvents||[]],_=!!(t.ignoreCollision||t.isFling),E=_?x.reduce((O,I)=>{if(I.type!=="kinetic_trace")return O;const D=I.payload;return D&&(D.movementType??"slide")==="slide"?O+1:O},0):0,w=b?0:_?Math.min(640,E*90):0,M=Math.max(m,w),k={actorId:l,origin:p,path:t.path||(b?[p,S]:Ze(p,S)),destination:S,movementType:b?"teleport":"slide",durationMs:t.animationDuration??(b?180:Math.max(120,(t.path?.length||Ze(p,S).length)*110)),startDelayMs:M,wasLethal:a.tiles.get(ce(S))?.traits.has("HAZARDOUS")||!1},R=x;if(b)R.push({type:"kinetic_trace",payload:k});else{let O=!1;for(let I=R.length-1;I>=0;I--){const D=R[I];if(D.type!=="kinetic_trace")continue;const j=D.payload;if(!(!j||j.actorId!==l)){if((j.movementType??"slide")==="slide"&&J(j.destination,k.origin)){const U=j.path&&j.path.length>0?j.path:[j.origin,j.destination],q=k.path&&k.path.length>0?k.path:[k.origin,k.destination],se=[...U,...q.slice(1)];R[I]={type:"kinetic_trace",payload:{...k,origin:j.origin,path:se,durationMs:(j.durationMs||0)+(k.durationMs||0),startDelayMs:Math.min(j.startDelayMs??M,M),movementType:"slide",wasLethal:!!(j.wasLethal||k.wasLethal)}},O=!0}break}}O||R.push({type:"kinetic_trace",payload:k})}if(a.visualEvents=R,l===a.player.id)a.player={...a.player,position:S,previousPosition:b?S:a.player.position};else{const O=I=>I.id===l?{...I,position:S,previousPosition:b?S:I.position}:I;a.enemies=a.enemies.map(O),a.companions&&(a.companions=a.companions.map(O))}return a.occupancyMask=Ie.refreshOccupancyMask(a),y||(a=o.appendTimelineEvent(a,"MOVE_END","Displacement",{destination:S,targetActorId:l},{...s,targetId:l},!0,260)),a=o.appendSimulationEvent(a,{type:"UnitMoved",actorId:l,position:S,payload:{origin:p,destination:S,movementType:k.movementType}}),a}},hl=Math.sqrt(3),Gy=(e,t)=>{if(t)return e.player.id===t?e.player:e.enemies.find(s=>s.id===t)||e.companions?.find(s=>s.id===t)},Jy=e=>{if(e)return{actorId:e.id,hex:e.position}},$0=(e,t,s=G)=>{if(!e||!t||fe(e,t)!==1)return;const o=Hn(e,t);if(o<0)return;const a=Ae(e,s),u=[{x:s,y:0},{x:s/2,y:-(hl*s)/2},{x:-s/2,y:-(hl*s)/2},{x:-s,y:0},{x:-s/2,y:hl*s/2},{x:s/2,y:hl*s/2}][o];return u?{x:a.x+u.x,y:a.y+u.y}:void 0},Od=(e,t,s)=>{if(s)switch(s.kind){case"source_actor":return Jy(Gy(e,t.sourceId));case"target_actor":return Jy(Gy(e,t.targetId));case"source_hex":return t.sourceHex?{hex:t.sourceHex}:void 0;case"target_hex":return t.targetHex?{hex:t.targetHex}:void 0;case"contact_hex":return t.contactHex?{hex:t.contactHex}:void 0;case"contact_world":return!t.contactWorld&&!t.contactHex?void 0:{world:t.contactWorld,hex:t.contactHex};case"custom_hex":return{hex:s.hex};case"custom_world":return{world:s.world};default:return}},q0=(e,t)=>{const s=e.turnNumber||0,o=e.stackTrace?.length||0,a=t.sourceId||"env",l=t.skillId||"none",u=t.phase||"instant",f=t.salt?`.${t.salt}`:"";return`t${s}.k${o}.${a}.${l}.${u}${f}`},bE=e=>{const t=String(e).toLowerCase();return t.includes("fire")||t.includes("lava")||t.includes("explosion")?"fire":t.includes("kinetic")||t.includes("momentum")||t.includes("wallcrack")?"kinetic":t.includes("void")?"void":t.includes("arcane")?"arcane":t.includes("hidden")||t.includes("shadow")?"shadow":"neutral"},SE=(e,t={})=>{const s=bE(e),o={signature:`UI.SPAWN.${s.toUpperCase()}.${String(e).toUpperCase()}`,family:"ui",primitive:"spawn",phase:"instant",element:s,variant:e,intensity:"medium"};switch(e){case"impact":return{...o,signature:"ATK.STRIKE.PHYSICAL.IMPACT",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"impact",targetRef:{kind:"target_hex"},contactRef:{kind:"contact_world"}};case"flash":return{...o,signature:`ATK.BLAST.${t.color?"ARCANE":"NEUTRAL"}.FLASH`,family:"attack",primitive:"blast",phase:"impact",element:t.color?"arcane":"neutral",variant:"flash",targetRef:{kind:"target_hex"}};case"spearTrail":return{...o,signature:"ATK.SHOOT.PHYSICAL.SPEAR_TRAIL",family:"attack",primitive:"shoot",phase:"travel",element:"physical",variant:"spear",sourceRef:{kind:"source_hex"},targetRef:{kind:"target_hex"}};case"explosion_ring":return{...o,signature:"ATK.BLAST.FIRE.EXPLOSION_RING",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"explosion_ring",targetRef:{kind:"target_hex"},intensity:"high"};case"lavaRipple":return{...o,signature:"ENV.HAZARD.FIRE.LAVA_RIPPLE",family:"environment",primitive:"hazard_burst",phase:"impact",element:"fire",variant:"lava_ripple",targetRef:{kind:"target_hex"}};case"lavaSink":return{...o,signature:"ENV.HAZARD.FIRE.SINK",family:"environment",primitive:"hazard_burst",phase:"impact",element:"fire",variant:"lava_sink",targetRef:{kind:"target_hex"},intensity:"high"};case"wallCrack":return{...o,signature:"ENV.COLLISION.KINETIC.WALL_CRACK",family:"environment",primitive:"collision",phase:"impact",element:"kinetic",variant:"wall_crack",contactRef:{kind:"contact_world"},targetRef:{kind:"target_hex"},intensity:"high"};case"kineticWave":return{...o,signature:"ATK.PULSE.KINETIC.WAVE",family:"attack",primitive:"pulse",phase:"impact",element:"kinetic",variant:"kinetic_wave",targetRef:{kind:"target_hex"}};case"dashBlur":return{...o,signature:"MOVE.DASH.NEUTRAL.BLUR",family:"movement",primitive:"dash",phase:"travel",element:"neutral",variant:"dash_blur",sourceRef:{kind:"source_hex"},targetRef:{kind:"target_hex"}};case"hiddenFade":return{...o,signature:"STATE.FADE.SHADOW.HIDDEN",family:"status",primitive:"state_fade",phase:"instant",element:"shadow",variant:"hidden_fade",targetRef:{kind:"target_hex"}};case"combat_text":return{...o,signature:"UI.TEXT.NEUTRAL.POPUP",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"combat_text",targetRef:{kind:"target_hex"}};case"shake":return{...o,signature:"UI.SHAKE.NEUTRAL.CAMERA",family:"ui",primitive:"shake",phase:"instant",element:"neutral",variant:"camera_shake"};case"freeze":return{...o,signature:"UI.FREEZE.NEUTRAL.HITSTOP",family:"ui",primitive:"freeze",phase:"instant",element:"neutral",variant:"freeze"};case"stunBurst":return{...o,signature:"STATE.APPLY.NEUTRAL.STUN_BURST",family:"status",primitive:"status_apply",phase:"impact",element:"neutral",variant:"stun_burst",targetRef:{kind:"target_hex"}};default:return{...o,signature:`UI.SPAWN.${s.toUpperCase()}.${String(e).toUpperCase()}`,variant:String(e).toLowerCase()}}},vE=(e,t)=>{const s=t.template,o=t.phase||s.phase||"instant",a=t.sequenceId||q0(e,{sourceId:t.sourceId,skillId:t.skillId,phase:o}),l=Od(e,t,s.sourceRef),u=Od(e,t,s.targetRef),f=Od(e,t,s.contactRef),p={protocol:"juice-signature/v1",signature:t.signature||s.signature,family:s.family,primitive:s.primitive,phase:o,element:t.element||s.element,variant:t.variant||s.variant,intensity:t.intensity||s.intensity,source:l,target:u,contact:f,area:t.area||s.area,direction:t.direction||s.direction,path:t.path||s.path,text:t.text||s.text,camera:t.camera||s.camera,timing:t.timing||s.timing,flags:{...s.flags||{},...t.flags||{}},meta:{turnNumber:e.turnNumber||0,stackTick:e.stackTrace?.length||0,sequenceId:a,sourceId:t.sourceId,targetId:t.targetId,skillId:t.skillId,reason:t.reason,...t.meta||{}}};return p.flags&&Object.keys(p.flags).length===0&&delete p.flags,p.meta&&Object.keys(p.meta).length===0&&delete p.meta,{type:"juice_signature",payload:p}},z0=(e,t)=>{const s=vE(e,t);return{...e,visualEvents:[...e.visualEvents||[],s]}},AE={Impact:(e,t,s,o)=>{let a={...e};const l=t.target,u=l===a.player.id?a.player:a.enemies.find(y=>y.id===l);if(!u)return a;const f=t.direction,p=f?{q:u.position.q+f.q,r:u.position.r+f.r,s:u.position.s+f.s}:void 0,m=p?$0(u.position,p):void 0;if(a=z0(a,{template:{signature:f?"ENV.COLLISION.KINETIC.IMPACT":"ATK.STRIKE.PHYSICAL.IMPACT",family:f?"environment":"attack",primitive:f?"collision":"strike",phase:"impact",element:f?"kinetic":"physical",variant:"impact",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},contactRef:{kind:"contact_world"}},sourceId:s.sourceId,targetId:l,sourceHex:o.resolveActorById(a,s.sourceId)?.position,targetHex:u.position,contactHex:p,contactWorld:m,direction:t.direction,intensity:t.damage>1?"high":"medium",flags:{blocked:!!f},meta:{legacyJuiceId:"impact",legacyMirrored:!0,reason:"impact"}}),t.damage>0)if(l===a.player.id)a.player=hi(a.player,t.damage);else{const y=b=>b.id===l?hi(b,t.damage):b;a.enemies=a.enemies.map(y).filter(b=>b.hp>0),a.companions&&(a.companions=a.companions.map(y).filter(b=>b.hp>0))}return a}},xE={PickupShield:(e,t)=>{let s={...e};const o=t.position||s.shieldPosition;if(o&&s.shieldPosition&&J(s.shieldPosition,o)){s.hasShield=!0,s.shieldPosition=void 0;const a={id:"BULWARK_CHARGE",name:"Bulwark Charge",description:"Shield Bash.",slot:"utility",cooldown:3,currentCooldown:0,range:1,upgrades:[],activeUpgrades:[]};s.player.activeSkills.some(l=>l.id==="BULWARK_CHARGE")||(s.player={...s.player,activeSkills:[...s.player.activeSkills,a]})}return s},PickupSpear:(e,t)=>{let s={...e};const o=t.position||s.spearPosition;return o&&s.spearPosition&&J(s.spearPosition,o)&&(s.hasSpear=!0,s.spearPosition=void 0),s},SpawnItem:(e,t,s)=>{let o={...e};if(t.itemType==="spear")return o.spearPosition=t.position,s.sourceId===o.player.id&&(o.hasSpear=!1),o;if(t.itemType==="bomb"){const a=o.initialSeed??o.rngSeed??"0",l=(o.turnNumber<<16)+(o.actionLog?.length??0)+o.enemies.length,u=`bomb-${ka(a,l,8,"bomb")}`,f=Qi({id:u,type:"enemy",subtype:"bomb",factionId:"enemy",position:t.position,speed:10,skills:["TIME_BOMB"],weightClass:"Standard"});return f.statusEffects=[{id:"TIME_BOMB",type:"time_bomb",duration:2,tickWindow:"END_OF_TURN"}],o.enemies=[...o.enemies,f],o}return t.itemType==="shield"&&(o.shieldPosition=t.position,o.hasShield=!1),o},LavaSink:(e,t,s,o)=>{let a={...e};a=o.appendTimelineEvent(a,"HAZARD_CHECK","LavaSink",{target:t.target},s,!0,240);const l=t.target,u=l===a.player.id?a.player:a.enemies.find(f=>f.id===l);return u&&(a=o.appendTimelineEvent(a,"DEATH_RESOLVE","LavaSink",{targetId:l},{...s,targetId:l},!0,280),l===a.player.id?a.player=hi(a.player,99):(a.enemies=a.enemies.filter(f=>f.id!==l),a.dyingEntities=[...a.dyingEntities||[],u],a=o.addCorpseTraitAt(a,u.position)),a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"vaporize",position:u.position}}]),a}},TE={Juice:(e,t,s,o)=>{let a={...e};const l=t.metadata||{},u=typeof l.phase=="string"?l.phase:void 0,p={...SE(t.effect,{color:t.color,text:t.text}),...typeof l.signature=="string"?{signature:l.signature}:{},...typeof l.family=="string"?{family:l.family}:{},...typeof l.primitive=="string"?{primitive:l.primitive}:{},...typeof l.element=="string"?{element:l.element}:{},...typeof l.variant=="string"?{variant:l.variant}:{},...typeof l.sourceRef=="object"&&l.sourceRef?{sourceRef:l.sourceRef}:{},...typeof l.targetRef=="object"&&l.targetRef?{targetRef:l.targetRef}:{},...typeof l.contactRef=="object"&&l.contactRef?{contactRef:l.contactRef}:{}},m=o.resolveActorById(a,s.sourceId);let y,b;typeof t.target=="string"?(y=t.target==="targetActor"?s.targetId||void 0:t.target,b=o.resolveActorById(a,y)?.position):t.target?(b=t.target,y=o.resolveActorAt(a,t.target)?.id):s.targetId&&(y=s.targetId,b=o.resolveActorById(a,s.targetId)?.position);const v=l.contactHex&&typeof l.contactHex.q=="number"?l.contactHex:void 0;let T=l.contactWorld&&typeof l.contactWorld.x=="number"?l.contactWorld:void 0;if(!T){const S=l.contactFromHex&&typeof l.contactFromHex.q=="number"?l.contactFromHex:void 0,x=l.contactToHex&&typeof l.contactToHex.q=="number"?l.contactToHex:void 0;T=$0(S,x)}if(a=z0(a,{template:p,sourceId:s.sourceId,targetId:y,skillId:typeof l.skillId=="string"?l.skillId:void 0,reason:typeof l.reason=="string"?l.reason:void 0,sourceHex:m?.position,targetHex:b,contactHex:v,contactWorld:T,path:t.path,direction:t.direction,phase:u,sequenceId:typeof l.sequenceId=="string"?l.sequenceId:q0(a,{sourceId:s.sourceId,skillId:typeof l.skillId=="string"?l.skillId:void 0,phase:u||p.phase,salt:t.effect}),intensity:t.intensity,text:t.text?{value:t.text,tone:typeof l.textTone=="string"?l.textTone:"system",color:t.color}:void 0,timing:typeof l.timing=="object"&&l.timing?l.timing:t.duration?{durationMs:t.duration,ttlMs:t.duration}:void 0,camera:typeof l.camera=="object"&&l.camera?l.camera:t.effect==="shake"?{shake:t.intensity||"medium"}:t.effect==="freeze"?{freezeMs:Math.max(0,Number(t.duration||80))}:void 0,area:typeof l.area=="object"&&l.area?l.area:void 0,flags:typeof l.flags=="object"&&l.flags?l.flags:void 0,meta:{legacyJuiceId:t.effect,legacyMirrored:o.legacyMirroredJuiceIds.has(t.effect),...typeof l.statusId=="string"?{statusId:l.statusId}:{}}}),t.effect==="combat_text"&&t.text&&(a.message=it(a.message,t.text,"VERBOSE","SYSTEM")),t.effect==="shake"&&(a.visualEvents=[...a.visualEvents||[],{type:"shake",payload:{intensity:t.intensity||"medium",direction:t.direction}}]),t.effect==="freeze"&&(a.visualEvents=[...a.visualEvents||[],{type:"freeze",payload:{durationMs:Math.max(0,Number(t.duration||80))}}]),t.effect==="impact"&&t.target){const S=typeof t.target=="string"?t.target===a.player.id?a.player.position:a.enemies.find(x=>x.id===t.target)?.position:t.target;S&&(a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"impact",position:S}}])}if(t.effect==="flash"&&t.target){const S=typeof t.target=="string"?t.target===a.player.id?a.player.position:a.enemies.find(x=>x.id===t.target)?.position:t.target;S&&(a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"flash",position:S}}])}if(t.effect==="spearTrail"&&t.path&&(a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"spear_trail",path:t.path}}]),t.effect==="lavaSink"&&t.target){const S=typeof t.target=="string"?t.target===a.player.id?a.player.position:a.enemies.find(x=>x.id===t.target)?.position:t.target;if(S){const x=a.enemies.find(_=>J(_.position,S));x&&(a.dyingEntities=[...a.dyingEntities||[],x],a.enemies=a.enemies.filter(_=>!J(_.position,S)),a.companions&&(a.companions=a.companions.filter(_=>!J(_.position,S))),a=o.addCorpseTraitAt(a,S),a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"vaporize",position:S}}])}}return a}},EE={Message:(e,t,s,o)=>{let a=e;return a.message=[...a.message,Sf(t.text,"INFO","SYSTEM")].slice(-50),a=o.appendSimulationEvent(a,{type:"MessageLogged",payload:{text:t.text}}),a},GameOver:e=>({...e,gameStatus:"lost"})},_E={Heal:(e,t,s,o)=>{let a={...e};const l=m=>({...m,hp:Math.min(m.maxHp,m.hp+t.amount)}),u=t.target==="targetActor"?s.targetId:t.target;let f,p;if(u){const m=u===a.player.id?a.player:a.enemies.find(y=>y.id===u)||a.companions?.find(y=>y.id===u);if(m){const y=u===a.player.id?"You":m.subtype||m.id;if(a.message=it(a.message,`${y} recover ${t.amount} HP.`,"INFO","COMBAT"),u===a.player.id)a.player=l(a.player),f=a.player.id,p=a.player.position;else{const b=v=>v.id===u?l(v):v;a.enemies=a.enemies.map(b),a.companions&&(a.companions=a.companions.map(b)),f=m.id,p=m.position}}}return f&&(a=o.appendSimulationEvent(a,{type:"Healed",targetId:f,position:p,payload:{amount:t.amount,sourceId:s.sourceId}})),a},ApplyStatus:(e,t,s,o)=>{let a={...e};a=o.appendTimelineEvent(a,"STATUS_APPLY","ApplyStatus",{status:t.status,duration:t.duration,target:t.target},s,!0,160);let l="",u=null;typeof t.target=="string"?t.target==="targetActor"?l=s.targetId||"":l=t.target:u=t.target;let f=u;const p=s.sourceId?o.resolveActorById(a,s.sourceId):void 0,m=p?fx(t.duration,Oe(p)):t.duration;if(l){const b=l===a.player.id?a.player:a.enemies.find(v=>v.id===l)||a.companions?.find(v=>v.id===l);if(b){f=b.position;const v=l===a.player.id?"You":`${b.subtype||"enemy"}#${b.id}`,T=l===a.player.id?"are":"is";if(a.message=it(a.message,`${v} ${T} ${t.status}!`,"INFO","COMBAT"),l===a.player.id)a.player=Gd(a.player,t.status,m);else{const S=x=>x.id===l?Gd(x,t.status,m):x;a.enemies=a.enemies.map(S),a.companions&&(a.companions=a.companions.map(S))}}}t.status==="stunned"&&f&&(a.visualEvents=[...a.visualEvents||[],{type:"shake",payload:{intensity:"low"}},{type:"vfx",payload:{type:"stunBurst",position:f}},{type:"combat_text",payload:{text:"STUNNED",position:f}}]);const y=l||(f?o.resolveActorAt(a,f)?.id:void 0);return a=o.appendSimulationEvent(a,{type:"StatusApplied",targetId:y,position:f||void 0,payload:{status:t.status,duration:m,sourceId:s.sourceId}}),a}},Qy={player:100,footman:50,archer:60,shieldBearer:40,bomber:30,warlock:55,bomb:10},Zd=e=>{let t=e.speed;if(t===void 0){const o=e.subtype;t=e.type==="player"?Qy.player:Qy[o]??50}return e.statusEffects?.some(o=>o.type==="stunned")&&(t-=100),t+=mx(Oe(e)),t},Rs=e=>{const t=[];t.push({actorId:e.player.id,initiative:Zd(e.player),hasActed:!1,turnStartPosition:void 0});for(const s of e.enemies)t.push({actorId:s.id,initiative:Zd(s),hasActed:!1,turnStartPosition:void 0});return t.sort((s,o)=>o.initiative!==s.initiative?o.initiative-s.initiative:s.actorId==="player"?-1:o.actorId==="player"?1:s.actorId.localeCompare(o.actorId)),{entries:t,currentIndex:-1,round:1}},ME=e=>e.currentIndex<0||e.currentIndex>=e.entries.length?null:e.entries[e.currentIndex],wE=e=>{let t=e.initiativeQueue;t||(t=Rs(e));let s=t.currentIndex+1;for(;s<t.entries.length&&t.entries[s].hasActed;)s++;return s>=t.entries.length?(t=Rs(e),t.round=(e.initiativeQueue?.round??0)+1,s=0,{queue:{...t,currentIndex:s},actorId:t.entries[s]?.actorId??null,newRound:!0}):{queue:{...t,currentIndex:s},actorId:t.entries[s]?.actorId??null,newRound:!1}},CE=(e,t)=>{const s=e.initiativeQueue;if(!s)return Rs(e);const o=s.entries.map(a=>{if(a.actorId===t.id){if(a.turnStartPosition)return a;const u=Ue(t.position).map(f=>ye(e,f)?.id).filter(Boolean);return{...a,turnStartPosition:{...t.position},turnStartNeighborIds:u}}return a});return{...s,entries:o}},OE=(e,t)=>{const s=e.initiativeQueue;if(!s)return Rs(e);const o=s.entries.map(a=>a.actorId===t?{...a,hasActed:!0}:a);return{...s,entries:o}},kE=(e,t)=>{const s=e.initiativeQueue;return s?s.entries.find(a=>a.actorId===t)?.turnStartPosition??null:null},NE=(e,t)=>{const s=e.initiativeQueue;return s?s.entries.find(a=>a.actorId===t)?.turnStartNeighborIds??null:null},Wo=e=>{const t=e.initiativeQueue;if(!t)return!0;if(t.currentIndex<0||t.currentIndex>=t.entries.length)return!1;const s=t.entries[t.currentIndex];return s.actorId===e.player.id&&!s.hasActed},kd=(e,t)=>{const s=e.entries.filter(l=>l.actorId!==t);let o=e.currentIndex;const a=e.entries.findIndex(l=>l.actorId===t);return a>=0&&a<=e.currentIndex&&o--,{...e,entries:s,currentIndex:Math.min(o,s.length-1)}},RE=(e,t)=>{const s={actorId:t.id,initiative:Zd(t),hasActed:!0,turnStartPosition:void 0};return{...e,entries:[...e.entries,s]}},IE={UpdateComponent:(e,t,s)=>{let o={...e};const a=(l,u,f)=>{const p=new Map(l.components||[]);return p.set(u,f),{...l,components:p}};if(t.target==="self")return o.player=a(o.player,t.key,t.value),o;if(t.target==="targetActor"&&s.targetId){if(s.targetId===o.player.id)return o.player=a(o.player,t.key,t.value),o;const l=u=>u.id===s.targetId?a(u,t.key,t.value):u;o.enemies=o.enemies.map(l),o.companions&&(o.companions=o.companions.map(l))}return o},SpawnActor:(e,t)=>{let s={...e};const o=zo(t.actor);return s.enemies=[...s.enemies,o],o.companionOf&&(s.companions=[...s.companions||[],o]),s.initiativeQueue&&(s.initiativeQueue=RE(s.initiativeQueue,o)),s},PlaceFire:(e,t,s)=>{let o={...e,tiles:new Map(e.tiles)};const a=ce(t.position);let l=o.tiles.get(a);l?l={...l,traits:new Set(l.traits),effects:[...l.effects]}:l={baseId:"STONE",position:t.position,traits:new Set(Oa.STONE.defaultTraits),effects:[]},o.tiles.set(a,l);const u=Cs.applyEffect(l,"FIRE",t.duration,1,o,s.sourceId);return u.messages.length>0&&(o.message=Vn(o.message,u.messages,"INFO","HAZARD")),o}},LE={PlaceTrap:(e,t)=>{const s=e.traps||[];return{...e,traps:[...s,{position:t.position,ownerId:t.ownerId,isRevealed:!1,cooldown:0,volatileCore:t.volatileCore,chainReaction:t.chainReaction,resetCooldown:t.resetCooldown}]}},RemoveTrap:(e,t)=>e.traps?{...e,traps:t.ownerId?e.traps.filter(s=>s.ownerId!==t.ownerId):e.traps.filter(s=>!J(s.position,t.position))}:e,SetTrapCooldown:(e,t)=>e.traps?{...e,traps:e.traps.map(s=>t.ownerId&&s.ownerId!==t.ownerId||!J(s.position,t.position)?s:{...s,cooldown:Math.max(0,t.cooldown)})}:e},BE={...EE,...uE,...yE,...gE,...xE,...LE,...CT,...cE,..._E,...AE,...TE,...IE},PE=(e,t,s,o)=>{const a=BE[t.type];return typeof a!="function"?null:a(e,t,s,o)};var Zy={};const HE=(e,t)=>{const s=ce(t);let o=e;o.tiles===e.tiles&&(o={...o,tiles:new Map(o.tiles)});let a=o.tiles.get(s);return a?a={...a,traits:new Set(a.traits),effects:[...a.effects]}:a={baseId:"STONE",position:t,traits:new Set(Oa.STONE.defaultTraits),effects:[]},a.traits.add("CORPSE"),o.tiles.set(s,a),o},jE=(e,t)=>{const s=ce(t),o=e.tiles.get(s);if(!o||!o.traits.has("CORPSE"))return e;let a=e;a.tiles===e.tiles&&(a={...a,tiles:new Map(a.tiles)});const l={...o,traits:new Set(o.traits),effects:[...o.effects]};return l.traits.delete("CORPSE"),a.tiles.set(s,l),a},DE=typeof process<"u"&&(Zy?.HOP_ENGINE_WARN==="1"||Zy?.HOP_ENGINE_DEBUG==="1"),eg={INTENT_START:1,MOVE_START:2,MOVE_END:3,ON_PASS:4,ON_ENTER:5,HAZARD_CHECK:6,STATUS_APPLY:7,AILMENT_APPLY:8,AILMENT_ANNIHILATE:9,AILMENT_TICK:10,DAMAGE_APPLY:11,DEATH_RESOLVE:12,INTENT_END:13},UE=e=>{const t=e||[];let s=0;for(const o of t)o.blocking&&(s+=Number(o.suggestedDurationMs||0));return s},$E=(e,t,s,o,a,l,u)=>{const f=e.timelineEvents||[],p=f.length,m=e.turnNumber||0,y=a.sourceId||a.targetId,b=a.stepId||`${m}:${y||"system"}`,v=a.stepId||b,T=v?[...f].reverse().find(x=>(x.stepId||x.groupId)===v):void 0;if(T){const x=eg[T.phase]||0,_=eg[t]||0;x>_&&DE&&console.warn("[TURN_STACK] Non-monotonic timeline phase order detected.",{stepId:v,previous:T.phase,next:t})}const S=`${v}:${p}:${t}`;return{...e,timelineEvents:[...f,{id:S,turn:m,actorId:y,stepId:v,phase:t,type:s,payload:o,blocking:l,groupId:b,suggestedDurationMs:u}]}},qE=(e,t)=>{const s=e.simulationEvents||[],o=`sim:${e.turnNumber||0}:${s.length}:${t.type}`;return{...e,simulationEvents:[...s,{...t,id:o,turn:e.turnNumber||0}]}},V0=(e,t)=>{if(t)return e.player.id===t?e.player:e.enemies.find(s=>s.id===t)||e.companions?.find(s=>s.id===t)},zE=(e,t)=>{if(t)return J(e.player.position,t)?e.player:e.enemies.find(s=>J(s.position,t))||e.companions?.find(s=>J(s.position,t))},VE=new Set(["lava_sink","void_sink","hazard_intercept","lava_tick","fire_damage","burning","oil_explosion"]),YE=new Set(["impact","flash","spearTrail","shake"]),KE=(e,t,s,o,a,l)=>{if(!o)return{amount:t,outgoing:1,incoming:1,total:1};if(l&&VE.has(l))return{amount:t,outgoing:1,incoming:1,total:1};const u=V0(e,s);if(!u)return{amount:t,outgoing:1,incoming:1,total:1};const f=_A(u,a),p=MA(o,a),m=f*p;return{amount:Math.max(0,Math.floor(t*m)),outgoing:f,incoming:p,total:m}},ef=(e,t,s={})=>{const o={...e},a=PE(o,t,s,{applyAtomicEffect:ef,applyEffects:Yt,addCorpseTraitAt:HE,removeCorpseTraitAt:jE,scaleCombatProfileDamage:KE,appendSimulationEvent:qE,appendTimelineEvent:$E,getBlockingTimelineDurationMs:UE,legacyMirroredJuiceIds:YE,resolveActorAt:zE,resolveActorById:V0});return a||o},Yt=(e,t,s={})=>{const o=e.stackTrace?.length||0,a=zy(e,t,{apply:(p,m)=>ef(p,m,s),describe:p=>p.type,preserveInputOrder:!0,startTick:o+1});let l=a.state,u=[...e.stackTrace||[],...a.trace];const f=MT(l);if(f.length>0){const p=zy(l,f,{apply:(m,y)=>ef(m,y,{}),describe:m=>m.type,preserveInputOrder:!0,startTick:u.length+1});l=p.state,u=[...u,...p.trace]}return{...l,stackTrace:u}},_a=e=>{e.state.ruleset={...e.state.ruleset||{},ailments:{acaeEnabled:!0,version:"acae-v1"}}},Nd=e=>e.player.components?.get("ailments")?.counters||{},FE={id:"acae",name:"ACAE Pilot",description:"Ailment Counter & Annihilation Engine pilot behavior checks",scenarios:[{id:"acae_lava_wet_annihilation",title:"ACAE: Lava + Wet annihilation",description:"Wet counters annihilate incoming heat counters deterministically.",relatedSkills:["BASIC_MOVE"],category:"hazards",tags:["acae","annihilation"],setup:e=>{_a(e)},run:e=>{e.state=Yt(e.state,[{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"burn",amount:10,source:"tile"},{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"wet",amount:5,source:"tile"}],{sourceId:e.state.player.id,targetId:e.state.player.id})},verify:e=>{const t=Nd(e);return(t.burn||0)===5&&(t.wet||0)===0}},{id:"acae_miasma_poison_stack",title:"ACAE: Miasma poison stack",description:"Poison counters stack from repeated deposits.",relatedSkills:["WAIT"],category:"hazards",tags:["acae","poison"],setup:e=>{_a(e)},run:e=>{e.state=Yt(e.state,[{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"poison",amount:4,source:"tile"},{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"poison",amount:7,source:"tile"}],{sourceId:e.state.player.id,targetId:e.state.player.id})},verify:e=>(Nd(e).poison||0)===11},{id:"acae_bleed_spear_application",title:"ACAE: Spear-family bleed application",description:"Spear-family basic attack applies bleed counters under ACAE.",relatedSkills:["BASIC_ATTACK","SPEAR_THROW"],category:"combat",tags:["acae","bleed","spear"],setup:e=>{_a(e),e.setPlayer({q:3,r:6,s:-9},["BASIC_ATTACK","SPEAR_THROW"]),e.spawnEnemy("footman",{q:4,r:6,s:-10},"bleed_target",{hp:30,maxHp:30})},run:e=>{e.useSkill("BASIC_ATTACK",{q:4,r:6,s:-10})},verify:e=>{const t=e.enemies.find(o=>o.id==="bleed_target");if(!t)return!1;const s=t.components?.get("ailments");return Math.max(0,Number(s?.counters?.bleed||0))>0}},{id:"acae_incinerated_threshold",title:"ACAE: Incinerated threshold trigger",description:"Burn threshold emits INCINERATED threshold event.",relatedSkills:["WAIT"],category:"hazards",tags:["acae","threshold"],setup:e=>{_a(e)},run:e=>{e.state=Yt(e.state,[{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"burn",amount:24,source:"tile"}],{sourceId:e.state.player.id,targetId:e.state.player.id})},verify:e=>(e.simulationEvents||[]).some(t=>t.type==="AilmentThresholdTriggered"&&t.payload?.effectId==="INCINERATED")},{id:"acae_hardening_tick_and_shock",title:"ACAE: Hardening gain from tick and shock",description:"Hardening progresses from both active tick and annihilation shock.",relatedSkills:["WAIT"],category:"hazards",tags:["acae","hardening"],setup:e=>{_a(e)},run:e=>{e.state=Yt(e.state,[{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"burn",amount:9,source:"tile"},{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"wet",amount:2,source:"tile"}],{sourceId:e.state.player.id,targetId:e.state.player.id});const t=U0(e.state,e.state.player.id,"END_OF_TURN","acae-hardening");e.state=t.state},verify:e=>{const t=e.player.components?.get("ailment_resilience");return Number(t?.resistancePct?.burn||0)>0}},{id:"acae_compound_ordering",title:"ACAE: Compound ordering is deterministic",description:"Applying burn+wet+frozen resolves with stable ordering.",relatedSkills:["WAIT"],category:"hazards",tags:["acae","ordering"],setup:e=>{_a(e)},run:e=>{e.state=Yt(e.state,[{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"burn",amount:14,source:"tile"},{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"wet",amount:4,source:"tile"},{type:"DepositAilmentCounters",target:e.state.player.id,ailment:"frozen",amount:3,source:"tile"}],{sourceId:e.state.player.id,targetId:e.state.player.id})},verify:e=>{const t=Nd(e);return(t.burn||0)===10&&(t.wet||0)===0&&(t.frozen||0)===3}}]};function WE(e){return{id:e.id,title:e.title,description:e.description,rationale:e.rationale,setup:e.setup,run:e.run,verify:e.verify}}const XE=[Bx,Px,Hx,jx,zx,Vx,Yx,Kx,Fx,Wx,Xx,Zx,Gx,Jx,Qx,eT,tT,nT,iT,sT,aT,oT,rT,lT,cT,uT,AT,xT,TT,FE],GE=XE.flatMap(e=>e.scenarios);function JE(e){return GE.filter(t=>t.relatedSkills.includes(e))}function Ye(e){return JE(e).map(WE)}const QE={id:"ARCHER_SHOT",name:"Archer Shot",description:"Fire an arrow in a straight line at a hostile target.",slot:"offensive",icon:"",baseVariables:{range:4,cost:0,cooldown:0,damage:1},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!bt(t.position,s,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const l=wn(t.position,s);if(!l.isAxial)return{effects:o,messages:["Target must be axial."],consumesTurn:!1};const u=ye(e,s);if(!u||u.id===t.id)return{effects:o,messages:["No target at location."],consumesTurn:!1};if(u.factionId===t.factionId)return{effects:o,messages:["Cannot target ally."],consumesTurn:!1};if(!zl(e,t.position,s,u.id,t.id))return{effects:o,messages:["No clear line of sight."],consumesTurn:!1};const f=Oe(t),p=_t({attackerId:t.id,targetId:u.id,skillId:"ARCHER_SHOT",basePower:1,trinity:f,targetTrinity:Oe(u),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.2}],statusMultipliers:[]}),m=Ze(t.position,s),y=p.finalPower>=4?"high":p.finalPower>=2?"medium":"low",b=l.directionIndex>=0?Mt(l.directionIndex):void 0;return o.push({type:"Juice",effect:"aimingLaser",target:s,intensity:"low",metadata:{signature:"ATK.SHOOT.PHYSICAL.ARROW",family:"attack",primitive:"shoot",phase:"anticipation",element:"physical",variant:"arrow",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},path:m,skillId:"ARCHER_SHOT",timing:{durationMs:70,ttlMs:90}}}),o.push({type:"Juice",effect:"spearTrail",path:m,target:s,intensity:y,metadata:{signature:"ATK.SHOOT.PHYSICAL.ARROW",family:"attack",primitive:"shoot",phase:"travel",element:"physical",variant:"arrow",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"ARCHER_SHOT",timing:{delayMs:50,durationMs:80,ttlMs:110}}}),o.push({type:"Juice",effect:"lightImpact",target:u.id,intensity:y,direction:b,metadata:{signature:"ATK.SHOOT.PHYSICAL.ARROW",family:"attack",primitive:"shoot",phase:"impact",element:"physical",variant:"arrow",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},contactRef:{kind:"contact_world"},contactHex:u.position,contactFromHex:t.position,contactToHex:u.position,skillId:"ARCHER_SHOT",timing:{delayMs:95,durationMs:60,ttlMs:110}}}),o.push({type:"Damage",target:u.id,amount:p.finalPower,reason:"archer_shot",scoreEvent:p.scoreEvent}),a.push("Archer shot!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>{const s=ye(e,t);return s?[e.player,...e.enemies,...e.companions||[]].filter(a=>!!a&&a.hp>0).filter(a=>a.id!==s.id&&a.factionId!==s.factionId&&bt(t,a.position,4)&&wn(t,a.position).isAxial&&zl(e,t,a.position,a.id,s.id)).map(a=>a.position).filter((a,l,u)=>u.findIndex(f=>J(f,a))===l):[]},upgrades:{},scenarios:Ye("ARCHER_SHOT")};function ns(e){return e.statusEffects?.some(t=>t.type==="stunned")??!1}function ZE(e){return e.statusEffects?.some(t=>t.type==="rooted")??!1}function tg(e,t=1){if(!e.statusEffects||e.statusEffects.length===0)return e;const s=e.statusEffects.map(o=>({...o,duration:o.duration-t})).filter(o=>o.duration>0);return{...e,statusEffects:s}}const Y0={id:"AUTO_ATTACK",name:"Auto Attack",description:"Automatically strike adjacent enemies that started the turn adjacent to you.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0,damage:1},execute:(e,t,s,o=[],a)=>{const l=[],u=[];let f=0;const p=(e.timelineEvents||[]).some(x=>x.phase==="STATUS_APPLY"&&x.type==="ApplyStatus"&&x.payload?.status==="stunned"&&(x.payload?.target===t.id||typeof x.payload?.target=="object"&&x.payload?.target&&J(x.payload.target,t.position)));if(ns(t)||p)return{effects:l,messages:u,kills:0};const m=Ue(t.position);let y=1;o.includes("HEAVY_HANDS")&&(y+=1);let b=0;const v=(x,_,E)=>{const w=Hn(t.position,_),M=w>=0?Mt(w):void 0,k=Math.max(0,E-(x.temporaryArmor||0)),R=x.hp-k<=0,O=R?"extreme":E>=4?"high":E>=2?"medium":"low",I=b*80;b+=1,l.push({type:"Juice",effect:"lightImpact",target:x.id,intensity:"low",metadata:{signature:"ATK.STRIKE.PHYSICAL.AUTO_ATTACK",family:"attack",primitive:"strike",phase:"anticipation",element:"physical",variant:"auto_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"AUTO_ATTACK",timing:{delayMs:I,durationMs:70,ttlMs:90}}}),l.push({type:"Juice",effect:"dashBlur",target:x.id,path:[t.position,_],intensity:O==="extreme"?"high":"medium",metadata:{signature:"ATK.STRIKE.PHYSICAL.AUTO_ATTACK",family:"attack",primitive:"strike",phase:"travel",element:"physical",variant:"auto_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"AUTO_ATTACK",timing:{delayMs:I+70,durationMs:50,ttlMs:80}}}),l.push({type:"Juice",effect:"heavyImpact",target:x.id,intensity:O,direction:M,metadata:{signature:"ATK.STRIKE.PHYSICAL.AUTO_ATTACK",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"auto_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},...M?{contactRef:{kind:"contact_world"},contactHex:_,contactToHex:_,contactFromHex:t.position}:{},skillId:"AUTO_ATTACK",camera:{kick:O==="extreme"?"medium":"light",freezeMs:O==="extreme"?50:35},timing:{delayMs:I+120,durationMs:60,ttlMs:120},flags:{lethal:R}}}),l.push({type:"Juice",effect:"lightImpact",target:x.id,intensity:"low",metadata:{signature:"ATK.STRIKE.PHYSICAL.AUTO_ATTACK",family:"attack",primitive:"strike",phase:"aftermath",element:"physical",variant:"auto_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"AUTO_ATTACK",timing:{delayMs:I+180,durationMs:80,ttlMs:110}}})},T=a?.persistentTargetIds||[],S=a?.previousNeighbors||[];if(T.length===0&&S.length===0)return{effects:l,messages:u,kills:0};for(const x of m){const _=ye(e,x);if(!_||_.hp<=0||_.id===t.id||t.factionId===_.factionId)continue;if(T.length>0?T.includes(_.id):S.some(w=>J(w,x))){const w=_t({attackerId:t.id,targetId:_.id,skillId:"AUTO_ATTACK",basePower:y,trinity:Oe(t),targetTrinity:Oe(_),damageClass:"physical",scaling:[{attribute:"body",coefficient:.4}],statusMultipliers:[]});v(_,x,w.finalPower),l.push({type:"Damage",target:x,amount:w.finalPower,reason:"auto_attack",scoreEvent:w.scoreEvent});const M=t.factionId==="player"?"You":`${t.subtype||"enemy"}#${t.id}`,k=_.factionId==="player"?"you":`${_.subtype||"enemy"}#${_.id}`;u.push(`${M} attacked ${k}!`),_.hp<=y&&f++}}if(o.includes("CLEAVE")&&l.length>0)for(const x of m){if(l.some(O=>O.type==="Damage"&&typeof O.target=="object"&&"q"in O.target&&J(O.target,x)))continue;const E=ye(e,x);if(!E||E.id===t.id||!(t.factionId!==E.factionId))continue;const M=_t({attackerId:t.id,targetId:E.id,skillId:"AUTO_ATTACK",basePower:y,trinity:Oe(t),targetTrinity:Oe(E),damageClass:"physical",scaling:[{attribute:"body",coefficient:.4}],statusMultipliers:[]});v(E,x,M.finalPower),l.push({type:"Damage",target:x,amount:M.finalPower,reason:"auto_attack",scoreEvent:M.scoreEvent});const k=t.factionId==="player"?"You":`${t.subtype||"enemy"}#${t.id}`,R=E.factionId==="player"?"you":`${E.subtype||"enemy"}#${E.id}`;u.push(`${k} cleaved ${R}!`),E.hp<=y&&f++}return{effects:l,messages:u,kills:f}},upgrades:{HEAVY_HANDS:{id:"HEAVY_HANDS",name:"Heavy Hands",description:"Auto-attack damage +1"},CLEAVE:{id:"CLEAVE",name:"Cleave",description:"When auto-attack triggers, hit ALL adjacent enemies"}},scenarios:Ye("AUTO_ATTACK")},e1=(e,t,s,o,a,l)=>{if(!t.activeSkills?.some(v=>v.id==="AUTO_ATTACK"))return{state:e,kills:0,messages:[]};const p=t.activeSkills?.find(v=>v.id==="AUTO_ATTACK")?.activeUpgrades||[],m=new Map;if(e.initiativeQueue)for(const v of e.initiativeQueue.entries)v.turnStartPosition&&m.set(v.actorId,v.turnStartPosition);const y=Y0.execute(e,t,void 0,p,{previousNeighbors:s,attackerTurnStartPosition:o,allActorsTurnStartPositions:m,persistentTargetIds:a});return{state:Yt(e,y.effects,{sourceId:t.id,targetId:void 0,stepId:l}),kills:y.kills||0,messages:y.messages}},t1={id:"BASIC_ATTACK",name:"Basic Attack",description:"Strike an adjacent enemy for 1 damage.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0,damage:1},execute:(e,t,s,o=[])=>{const a=[],l=[],u=e.ruleset?.ailments?.acaeEnabled===!0,f=(e.timelineEvents||[]).some(O=>O.phase==="STATUS_APPLY"&&O.type==="ApplyStatus"&&O.payload?.status==="stunned"&&(O.payload?.target===t.id||typeof O.payload?.target=="object"&&O.payload?.target&&J(O.payload.target,t.position)));if(ns(t)||f)return l.push("Cannot attack while stunned!"),{effects:a,messages:l,consumesTurn:!0};if(!s)return l.push("Select a target!"),{effects:a,messages:l,consumesTurn:!1};if(!bt(t.position,s,1))return l.push("Target out of range!"),{effects:a,messages:l,consumesTurn:!1};const m=ye(e,s);if(!m||m.id===t.id)return l.push("No enemy at target!"),{effects:a,messages:l,consumesTurn:!1};if(m.factionId===t.factionId)return l.push("Cannot attack friendlies!"),{effects:a,messages:l,consumesTurn:!1};if(m.subtype==="bomb")return l.push("Cannot attack a bomb!"),{effects:a,messages:l,consumesTurn:!1};let y=1;o.includes("POWER_STRIKE")&&(y+=2);const b=J(t.previousPosition||t.position,t.position);o.includes("EXTENDED_REACH")&&b&&(y+=1);const v=_t({attackerId:t.id,targetId:m.id,skillId:"BASIC_ATTACK",basePower:y,trinity:Oe(t),targetTrinity:Oe(m),damageClass:"physical",scaling:[{attribute:"body",coefficient:.5}],statusMultipliers:[],inDangerPreviewHex:!!e.intentPreview?.dangerTiles?.some(O=>J(O,t.position)),theoreticalMaxPower:y}),T=v.finalPower,S=Math.max(0,T-(m.temporaryArmor||0)),x=m.hp-S<=0,_=Hn(t.position,m.position),E=_>=0?Mt(_):void 0,w=x?"extreme":T>=4?"high":T>=2?"medium":"low",M=!!t.activeSkills?.some(O=>O.id==="SPEAR_THROW")&&(t.id!==e.player.id||e.hasSpear);a.push({type:"Juice",effect:"lightImpact",target:"targetActor",intensity:"low",metadata:{signature:"ATK.STRIKE.PHYSICAL.BASIC_ATTACK",family:"attack",primitive:"strike",phase:"anticipation",element:"physical",variant:"basic_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"BASIC_ATTACK",timing:{delayMs:0,durationMs:110,ttlMs:140}}}),a.push({type:"Juice",effect:"dashBlur",target:m.id,path:[t.position,m.position],intensity:w==="extreme"?"high":"medium",metadata:{signature:"ATK.STRIKE.PHYSICAL.BASIC_ATTACK",family:"attack",primitive:"strike",phase:"travel",element:"physical",variant:"basic_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"BASIC_ATTACK",timing:{delayMs:110,durationMs:70,ttlMs:100}}}),a.push({type:"Juice",effect:"heavyImpact",target:m.id,intensity:w,direction:E,metadata:{signature:"ATK.STRIKE.PHYSICAL.BASIC_ATTACK",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"basic_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},...E?{contactRef:{kind:"contact_world"},contactHex:m.position,contactToHex:m.position,contactFromHex:t.position}:{},skillId:"BASIC_ATTACK",camera:{kick:w==="extreme"?"heavy":w==="high"?"medium":"light",freezeMs:w==="extreme"?80:55},timing:{delayMs:180,durationMs:90,ttlMs:150},flags:{lethal:x,...w==="extreme"?{crit:!0}:{}}}}),a.push({type:"Damage",target:"targetActor",amount:T,reason:"basic_attack",scoreEvent:v.scoreEvent}),u&&M&&a.push({type:"ApplyAilment",target:"targetActor",ailment:"bleed",skillMultiplier:100,baseDeposit:1}),a.push({type:"Juice",effect:"lightImpact",target:m.id,intensity:"low",metadata:{signature:"ATK.STRIKE.PHYSICAL.BASIC_ATTACK",family:"attack",primitive:"strike",phase:"aftermath",element:"physical",variant:"basic_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"BASIC_ATTACK",timing:{delayMs:280,durationMs:130,ttlMs:170}}});const k=t.type==="player"?"You":`${t.subtype||"enemy"}#${t.id}`,R=m.type==="player"?"you":`${m.subtype||"enemy"}#${m.id}`;return l.push(`${k} attacked ${R}!`),o.includes("VAMPIRIC")&&m.hp-S<=0&&(a.push({type:"Heal",target:t.id,amount:1}),l.push("Vampiric heal!")),{effects:a,messages:l,consumesTurn:!0}},getValidTargets:(e,t)=>{const s=ye(e,t);return s?Ue(t).filter(a=>{const l=ye(e,a);return!!l&&l.subtype!=="bomb"&&l.id!==s.id&&l.factionId!==s.factionId}):[]},upgrades:{EXTENDED_REACH:{id:"EXTENDED_REACH",name:"Disciplined Stance",description:"+1 damage when attacking without moving first."},POWER_STRIKE:{id:"POWER_STRIKE",name:"Power Strike",description:"Damage +2"},VAMPIRIC:{id:"VAMPIRIC",name:"Vampiric",description:"Heal 1 HP on kill"}},scenarios:Ye("BASIC_ATTACK")},n1=e=>{if(!e||e.length===0)return e;let t=!1;const s=e.map(o=>(o.currentCooldown||0)<=0?o:(t=!0,{...o,currentCooldown:0}));return t?s:e},ng=e=>{const t=n1(e.activeSkills),s=(e.actionCooldown||0)>0?0:e.actionCooldown;return t===e.activeSkills&&s===e.actionCooldown?e:{...e,activeSkills:t||e.activeSkills,actionCooldown:s}},vf=e=>e.enemies.filter(s=>s.hp>0&&s.factionId==="enemy").length===0,i1=e=>{if(!vf(e))return e;const t=ng(e.player),s=e.companions?.map(ng),o=e.traps?.map(u=>u.cooldown>0?{...u,cooldown:0}:u),a=!!e.companions&&s?.some((u,f)=>u!==e.companions?.[f]),l=!!e.traps&&o?.some((u,f)=>u!==e.traps?.[f]);return t===e.player&&!a&&!l?e:{...e,player:t,...a?{companions:s}:{},...l?{traps:o}:{}}},ig=(e,t)=>vf(e)?20:Math.max(t.speed||1,1),K0=(e,t)=>Ie.isWithinBounds(e,t)?we.getTraitsAt(e,t).has("BLOCKS_MOVEMENT"):!0,sg=(e,t,s,o)=>{const a=new Map,l=[],u=p=>`${p.q},${p.r}`,f=[{p:s,cost:0}];for(a.set(u(s),0);f.length>0;){const p=f.shift();if(!(p.cost>=o))for(const m of Ue(p.p)){if(!Ie.isWithinBounds(e,m)||!we.isWalkable(e,m)||!O0(e,t,m,"BASIC_MOVE"))continue;const y=ye(e,m),b=!!y&&y.id!==t.id,v=b&&y.factionId===t.factionId;if(b&&!v)continue;const T=u(m),S=p.cost+1;a.has(T)&&a.get(T)<=S||(a.set(T,S),!v&&Si(e,t,m)&&!K0(e,m)&&l.push(m),f.push({p:m,cost:S}))}}return l},s1=(e,t,s,o,a)=>{const l=T=>`${T.q},${T.r}`,u=T=>{const[S,x]=T.split(",").map(Number);return{q:S,r:x,s:-S-x}},f=[s],p=new Map([[l(s),0]]),m=new Map([[l(s),null]]);for(;f.length>0;){const T=f.shift(),S=l(T),x=p.get(S);if(!(x>=a))for(const _ of Ue(T)){if(!Ie.isWithinBounds(e,_)||!we.isWalkable(e,_)||!O0(e,t,_,"BASIC_MOVE"))continue;const E=ye(e,_),w=!!E&&E.id!==t.id,M=w&&E.factionId===t.factionId;if(w&&!M)continue;const k=l(_),R=x+1;p.has(k)&&p.get(k)<=R||(p.set(k,R),m.set(k,S),f.push(_))}}const y=l(o);if(!m.has(y)||K0(e,o)||!Si(e,t,o))return null;const b=[];let v=y;for(;v;)b.push(u(v)),v=m.get(v)||null;return b.reverse(),b},a1={id:"BASIC_MOVE",name:"Walk",description:"Move to an adjacent or nearby tile within your speed range.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const l=ig(e,t),f=sg(e,t,t.position,l).some(y=>J(y,s)),p=s1(e,t,t.position,s,l);if(!f||!p||p.length<2)return a.push("Target out of reach or blocked!"),{effects:o,messages:a,consumesTurn:!1};o.push({type:"Displacement",target:"self",destination:s,source:t.position,path:p,simulatePath:!0,ignoreCollision:!0});const m=t.id===e.player.id?"You":`${t.subtype||"enemy"}#${t.id}`;return a.push(`${m} moved to (${s.q}, ${s.r}). [Range ${l}]`),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>{const s=ye(e,t);if(!s)return[];const o=ig(e,s);return sg(e,s,t,o).filter(l=>!es(e,l,s.id))},upgrades:{},scenarios:Ye("BASIC_MOVE")},o1={id:"BOMB_TOSS",name:"Bomb Toss",description:"Throw a bomb to a nearby tile.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:2},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!bt(t.position,s,3))return a.push("Out of range!"),{effects:o,messages:a,consumesTurn:!1};if(!we.isWalkable(e,s))return a.push("Target blocked!"),{effects:o,messages:a,consumesTurn:!1};if(ye(e,s))return a.push("Target occupied!"),{effects:o,messages:a,consumesTurn:!1};const u=`bomb-${t.id}-${e.turnNumber}-${e.actionLog?.length??0}-${s.q}_${s.r}_${s.s}`,f=Qi({id:u,type:"enemy",subtype:"bomb",factionId:t.factionId,position:s,speed:10,skills:["TIME_BOMB"],weightClass:"Standard"});return f.statusEffects=[{id:"TIME_BOMB",type:"time_bomb",duration:2,tickWindow:"END_OF_TURN"}],o.push({type:"SpawnActor",actor:f}),a.push("Bomb tossed!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>{const o=[];for(let a=-3;a<=3;a++)for(let l=Math.max(-3,-a-3);l<=Math.min(3,-a+3);l++){const u={q:t.q+a,r:t.r+l,s:t.s-a-l};bt(t,u,3)&&we.isWalkable(e,u)&&(ye(e,u)||o.push(u))}return o},upgrades:{}},r1={id:"BULWARK_CHARGE",name:"Bulwark Charge",description:"Charge into an adjacent enemy, pushing a chain. Wall hard-stop stuns the chain.",slot:"offensive",icon:"",baseVariables:{range:1,cost:0,cooldown:3},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(fe(t.position,s)!==1)return a.push("Target not adjacent!"),{effects:o,messages:a,consumesTurn:!1};const u=Pn(e.enemies,s);if(!u)return a.push("No target!"),{effects:o,messages:a,consumesTurn:!1};const{isAxial:f,directionIndex:p}=wn(t.position,s);if(!f)return{effects:o,messages:a,consumesTurn:!1};const m=Mt(p),y=[u];let b={q:u.position.q+m.q,r:u.position.r+m.r,s:u.position.s+m.s};for(;;){const S=Pn(e.enemies,b);if(S){if(y.push(S),b={q:b.q+m.q,r:b.r+m.r,s:b.s+m.s},y.length>6)break;continue}break}const v=[];for(let S=0;S<y.length;S++){const x=y[S],_=S===0?2:1,E={q:x.position.q+m.q*_,r:x.position.r+m.r*_,s:x.position.s+m.s*_};v.push({actor:x,dest:E})}let T=!1;for(const S of v){const x=e.tiles.get(ce(S.dest));if(x?.baseId==="WALL"||x?.traits.has("BLOCKS_MOVEMENT")){T=!0;break}if(e.enemies.find(E=>J(E.position,S.dest)&&!y.some(w=>w.id===E.id))){T=!0;break}}if(T){for(const S of y)o.push({type:"ApplyStatus",target:S.position,status:"stunned",duration:1}),a.push("Chain blocked! Stunned.");return{effects:o,messages:a}}for(const S of v)o.push({type:"Displacement",target:S.actor.id,destination:S.dest});return o.push({type:"Displacement",target:"self",destination:u.position}),a.push("Bulwark Charge!"),{effects:o,messages:a}},getValidTargets:(e,t)=>[{q:t.q+1,r:t.r,s:t.s-1},{q:t.q+1,r:t.r-1,s:t.s},{q:t.q,r:t.r-1,s:t.s+1},{q:t.q-1,r:t.r,s:t.s+1},{q:t.q-1,r:t.r+1,s:t.s},{q:t.q,r:t.r+1,s:t.s-1}].filter(o=>!!Pn(e.enemies,o)),upgrades:{},scenarios:[{id:"chain_stun",title:"Chain-Stun",description:"Wall prevents chain, chain gets stunned",setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BULWARK_CHARGE"]),e.spawnEnemy("shieldBearer",{q:3,r:5,s:-8},"A"),e.spawnEnemy("shieldBearer",{q:3,r:4,s:-7},"B"),e.setTile({q:3,r:3,s:-6},"wall"),e.state.hasShield=!0},run:e=>{e.useSkill("BULWARK_CHARGE",{q:3,r:5,s:-8})},verify:(e,t)=>!0}]},l1=(e,t)=>!!e.tiles.get(ce(t))?.traits?.has("CORPSE"),c1=(e,t,s)=>{const o=[];return e.tiles.forEach(a=>{a.traits.has("CORPSE")&&fe(t,a.position)<=s&&o.push(a.position)}),o},u1={id:"CORPSE_EXPLOSION",name:"Corpse Explosion",description:"Detonate a target corpse, dealing damage in a 1-tile radius.",slot:"offensive",icon:"",baseVariables:{range:4,cost:1,cooldown:2},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!l1(e,s))return{effects:o,messages:["A corpse is required!"],consumesTurn:!1};if(!bt(t.position,s,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};o.push({type:"RemoveCorpse",position:s});const u=[s,...Ue(s)],f=Oe(t),p=!!e.intentPreview?.dangerTiles?.some(m=>J(m,t.position));for(const m of u){const y=ye(e,m),b=_t({attackerId:t.id,targetId:y?.id||ce(m),skillId:"CORPSE_EXPLOSION",basePower:2,trinity:f,targetTrinity:y?Oe(y):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.25}],statusMultipliers:[],inDangerPreviewHex:p,theoreticalMaxPower:2});o.push({type:"Damage",target:m,amount:b.finalPower,reason:"corpse_explosion",scoreEvent:b.scoreEvent})}return o.push({type:"Juice",effect:"explosion_ring",target:s,metadata:{signature:"ATK.BLAST.VOID.CORPSE_EXPLOSION",family:"attack",primitive:"blast",phase:"impact",element:"void",variant:"corpse_explosion",targetRef:{kind:"target_hex"},skillId:"CORPSE_EXPLOSION"}}),o.push({type:"Juice",effect:"shake",intensity:"high",metadata:{signature:"UI.SHAKE.VOID.CORPSE_EXPLOSION",family:"ui",primitive:"shake",phase:"impact",element:"void",variant:"corpse_explosion_shake",skillId:"CORPSE_EXPLOSION",camera:{shake:"high"}}}),o.push({type:"Juice",effect:"combat_text",target:s,text:"BOOM!",metadata:{signature:"UI.TEXT.VOID.CORPSE_EXPLOSION",family:"ui",primitive:"text",phase:"impact",element:"void",variant:"corpse_explosion_text",targetRef:{kind:"target_hex"},skillId:"CORPSE_EXPLOSION",textTone:"damage"}}),a.push("Corpse exploded!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>c1(e,t,4),upgrades:{},scenarios:Ye("CORPSE_EXPLOSION")},vi=(e,t)=>e.type!=="Juice"?e:{...e,metadata:{...e.metadata||{},...t}},F0=e=>!!e&&typeof e.q=="number"&&typeof e.r=="number"&&typeof e.s=="number",W0=e=>F0(e)?Math.abs(e.q)+Math.abs(e.r)+Math.abs(e.s)===2:!1,X0=(e,t)=>({q:e.q-t.q,r:e.r-t.r,s:e.s-t.s}),he={shake:(e,t)=>({type:"Juice",effect:"shake",intensity:e,direction:t,metadata:{signature:"UI.SHAKE.NEUTRAL.CAMERA",family:"ui",primitive:"shake",phase:"instant",element:"neutral",variant:"camera_shake",camera:{shake:e,...t?{kick:e==="extreme"?"heavy":e==="high"?"medium":"light"}:{}}}}),flash:e=>({type:"Juice",effect:"flash",intensity:"high",color:e,metadata:{signature:"ATK.BLAST.NEUTRAL.FLASH",family:"attack",primitive:"blast",phase:"impact",element:"neutral",variant:"flash"}}),freeze:(e=80)=>({type:"Juice",effect:"freeze",duration:e,metadata:{signature:"UI.FREEZE.NEUTRAL.HITSTOP",family:"ui",primitive:"freeze",phase:"instant",element:"neutral",variant:"hitstop",camera:{freezeMs:e},timing:{durationMs:e,ttlMs:e}}}),combatText:(e,t,s)=>({type:"Juice",effect:"combat_text",text:e,target:t,color:s}),momentumTrail:(e,t)=>({type:"Juice",effect:"momentumTrail",path:e,intensity:t}),heavyImpact:(e,t)=>({type:"Juice",effect:"heavyImpact",target:e,direction:t,intensity:"extreme"}),lightImpact:e=>({type:"Juice",effect:"lightImpact",target:e,intensity:"low"}),kineticWave:(e,t,s)=>({type:"Juice",effect:"kineticWave",target:e,direction:t,intensity:s}),stunBurst:e=>({type:"Juice",effect:"stunBurst",target:e,intensity:"medium"}),lavaRipple:e=>({type:"Juice",effect:"lavaRipple",target:e,intensity:"medium"}),wallCrack:(e,t)=>({type:"Juice",effect:"wallCrack",target:e,direction:t,intensity:"high"}),explosionRing:e=>({type:"Juice",effect:"explosion_ring",target:e})};he.combatText=(e=>(t,s,o)=>vi(e(t,s,o),{signature:"UI.TEXT.NEUTRAL.POPUP",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"combat_text",targetRef:typeof s=="string"?{kind:"target_actor"}:{kind:"target_hex"},textTone:/^[-]/.test(t)?"damage":/^\+/.test(t)?"heal":"system"}))(he.combatText);he.momentumTrail=(e=>(t,s)=>vi(e(t,s),{signature:"MOVE.DASH.KINETIC.MOMENTUM_TRAIL",family:"movement",primitive:"dash",phase:"travel",element:"kinetic",variant:"momentum_trail"}))(he.momentumTrail);he.heavyImpact=(e=>(t,s)=>{const o={signature:"ATK.STRIKE.PHYSICAL.HEAVY",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"heavy_impact",sourceRef:{kind:"source_actor"}};return F0(t)?(o.targetRef={kind:"target_hex"},s&&W0(s)&&(o.contactHex=t,o.contactToHex=t,o.contactFromHex=X0(t,s),o.contactRef={kind:"contact_world"})):o.targetRef={kind:"target_actor"},vi(e(t,s),o)})(he.heavyImpact);he.lightImpact=(e=>t=>vi(e(t),{signature:"ATK.STRIKE.PHYSICAL.LIGHT",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"light_impact",sourceRef:{kind:"source_actor"},targetRef:typeof t=="string"?{kind:"target_actor"}:{kind:"target_hex"}}))(he.lightImpact);he.kineticWave=(e=>(t,s,o)=>vi(e(t,s,o),{signature:"ATK.PULSE.KINETIC.WAVE",family:"attack",primitive:"pulse",phase:"impact",element:"kinetic",variant:"kinetic_wave",targetRef:{kind:"target_hex"},sourceRef:{kind:"source_hex"}}))(he.kineticWave);he.stunBurst=(e=>t=>vi(e(t),{signature:"STATE.APPLY.NEUTRAL.STUN_BURST",family:"status",primitive:"status_apply",phase:"impact",element:"neutral",variant:"stun_burst",targetRef:typeof t=="string"?{kind:"target_actor"}:{kind:"target_hex"}}))(he.stunBurst);he.lavaRipple=(e=>t=>vi(e(t),{signature:"ENV.HAZARD.FIRE.LAVA_RIPPLE",family:"environment",primitive:"hazard_burst",phase:"impact",element:"fire",variant:"lava_ripple",targetRef:{kind:"target_hex"}}))(he.lavaRipple);he.wallCrack=(e=>(t,s)=>{const o={signature:"ENV.COLLISION.KINETIC.WALL_CRACK",family:"environment",primitive:"collision",phase:"impact",element:"kinetic",variant:"wall_crack",targetRef:{kind:"target_hex"}};return W0(s)&&(o.contactHex=t,o.contactToHex=t,o.contactFromHex=X0(t,s),o.contactRef={kind:"contact_world"}),vi(e(t,s),o)})(he.wallCrack);he.explosionRing=(e=>t=>vi(e(t),{signature:"ATK.BLAST.FIRE.EXPLOSION_RING",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"explosion_ring",targetRef:{kind:"target_hex"}}))(he.explosionRing);const ft={GRAPPLE_HOOK:{anticipation:(e,t)=>[{type:"Juice",effect:"aimingLaser",target:e,path:[e,t],intensity:"low",color:"#00ff88"}],execution:e=>[{type:"Juice",effect:"hookCable",path:e,intensity:"medium",duration:200,color:"#00ff88"},he.shake("low")],impact:(e,t)=>[{type:"Juice",effect:"grappleHookWinch",target:e,direction:t,intensity:"high",duration:150},he.shake("medium",t)],resolution:(e,t)=>[he.momentumTrail(e,t>6?"high":"medium"),he.kineticWave(e[0],e[e.length-1],"high")]},SHIELD_THROW:{anticipation:(e,t)=>[{type:"Juice",effect:"trajectory",target:e,path:[e,t],intensity:"medium",color:"#4169e1"}],execution:e=>[{type:"Juice",effect:"shieldArc",path:e,intensity:"high",duration:300,metadata:{rotation:720}},{type:"Juice",effect:"shieldSpin",path:e,intensity:"medium"}],impact:(e,t)=>[he.heavyImpact(e,t),he.shake("high",t),he.freeze(120),he.combatText("IMPACT!",e,"#ff4444")],resolution:e=>[he.kineticWave(e[0],e[e.length-1],"high"),he.momentumTrail(e,"high")]},DASH:{anticipation:(e,t)=>[{type:"Juice",effect:"chargeUp",target:e,direction:t,intensity:"medium",duration:100}],execution:e=>[{type:"Juice",effect:"dashBlur",path:e,intensity:"high",duration:150},he.momentumTrail(e,"medium")],impact:(e,t,s)=>s?[he.heavyImpact(e,t),he.shake("extreme",t),he.freeze(100),he.combatText("SHUNT!",e,"#ffaa00")]:[he.lightImpact(e)],resolution:e=>e?[he.kineticWave(e[0],e[e.length-1],"high"),he.momentumTrail(e,"high")]:[]},SPEAR_THROW:{anticipation:(e,t)=>[{type:"Juice",effect:"aimingLaser",target:e,path:[e,t],intensity:"low",color:"#ff6b6b"}],execution:e=>[{type:"Juice",effect:"spearTrail",path:e,intensity:"high",duration:150},{type:"Juice",effect:"spearWhistle",path:e,intensity:"medium",metadata:{pitch:"rising"}}],impact:(e,t)=>t?[he.heavyImpact(e),he.shake("medium"),he.freeze(60),he.combatText("LETHAL",e,"#ff0000")]:[he.lightImpact(e),he.combatText("MISS",e,"#888888")],resolution:()=>[]},VAULT:{anticipation:(e,t)=>[{type:"Juice",effect:"trajectory",target:e,path:[e,t],intensity:"low",color:"#00ddff",metadata:{arc:"high"}}],execution:e=>[{type:"Juice",effect:"vaultLeap",path:e,intensity:"medium",duration:250,metadata:{arc:"parabolic"}}],impact:(e,t)=>t?[he.heavyImpact(e),he.shake("medium"),he.stunBurst(e),he.combatText("STUN!",e,"#ffff00")]:[he.lightImpact(e)],resolution:()=>[]}},Rd={lavaSink:e=>[{type:"Juice",effect:"lavaSink",target:e,intensity:"extreme",duration:500,metadata:{particleCount:50}},he.lavaRipple(e),he.shake("high"),he.combatText("CONSUMED",e,"#ff4400")],wallImpact:(e,t,s)=>{const o=[he.wallCrack(e,t),he.shake("high",t)];return s&&(o.push(he.stunBurst(e)),o.push(he.combatText("STUNNED",e,"#ffaa00"))),o},voidConsume:e=>[{type:"Juice",effect:"voidConsume",target:e,intensity:"extreme",duration:800,color:"#000000"},he.freeze(150),he.combatText("VOID",e,"#8800ff")]};function ic(e,t){const{origin:s,direction:o,momentum:a}=t,l=[];l.push(he.kineticWave(s,o,a>6?"high":"medium"));const u=Kt(s,{q:o.q*(a+10),r:o.r*(a+10),s:o.s*(a+10)}),f=Ze(s,u);let p=a,m=d1(e,f);for(;p>0&&m.length>0;){const y=f1(m);if(y.length===0)break;const b=y.length;if(p<b){const w=y[y.length-1],M=p;p=0;const k=[f[w.pos1D]];for(let R=0;R<M;R++){const O=w.pos1D+1,I=f[O];if(!I||!Zi(I,e.gridWidth,e.gridHeight)||ag(e,I)){l.push({type:"Impact",target:w.id,damage:M-R,direction:o});break}if(w.pos1D=O,k.push(I),og(e,I)){l.push({type:"LavaSink",target:w.id}),l.push(...Rd.lavaSink(I));break}}k.length>1&&(l.push({type:"Displacement",target:w.id,destination:k[k.length-1],path:k,animationDuration:k.length*80}),l.push(he.momentumTrail(k,"medium")));break}const v=y[y.length-1],T=v.pos1D+1,S=f[T];if(!S||!Zi(S,e.gridWidth,e.gridHeight)||ag(e,S)){l.push({type:"ApplyStatus",target:v.id,status:"stunned",duration:1}),S&&l.push(...Rd.wallImpact(S,o,!0));break}const x=new Map;for(const w of y){const M=f[w.pos1D];w.pos1D+=1;const k=f[w.pos1D];x.set(w.id,[M,k])}const _=[...y].reverse();for(const w of _){const M=x.get(w.id);M&&l.push({type:"Displacement",target:w.id,destination:M[M.length-1],path:M,ignoreCollision:!0,animationDuration:150})}const E=Array.from(x.values()).flat();E.length>0&&l.push(he.momentumTrail(E,b>2?"high":"medium")),p-=b;for(let w=m.length-1;w>=0;w--){const M=m[w],k=f[M.pos1D];og(e,k)&&(l.push({type:"LavaSink",target:M.id}),l.push(...Rd.lavaSink(k)),m.splice(w,1))}if(p>0){const w=y[y.length-1];m=m.filter(k=>k.pos1D>=w.pos1D);const M=m.filter(k=>k.pos1D>w.pos1D);m=[w,...M]}}return l}function d1(e,t){const s=[],o=[e.player,...e.enemies];for(const a of o){const l=t.findIndex(u=>J(u,a.position));l!==-1&&s.push({id:a.id,pos1D:l})}return s.sort((a,l)=>a.pos1D-l.pos1D)}function f1(e){if(e.length===0)return[];const t=[];let s=e[0];t.push(s);for(let o=1;o<e.length;o++){const a=e[o];if(a.pos1D===s.pos1D||a.pos1D===s.pos1D+1)t.push(a),s=a;else break}return t}function ag(e,t){const s=we.getTraitsAt(e,t);return s.has("BLOCKS_MOVEMENT")||s.has("BLOCKS_LOS")}function og(e,t){const s=we.getTraitsAt(e,t);return s.has("HAZARDOUS")||s.has("LIQUID")}const m1={id:"DASH",name:"Kinetic Dash",description:"Dash in a straight line. With a shield, slam into enemies and send them flying!",slot:"passive",icon:"",baseVariables:{range:4,cost:0,cooldown:0},execute:(e,t,s,o=[])=>{const a=[],l=[],u=o.includes("MOMENTUM_SURGE"),f=o.includes("DASH_CHAIN_REACTION")||o.includes("CHAIN_REACTION");if(!s)return{effects:a,messages:l,consumesTurn:!1};const{isAxial:p,directionIndex:m}=wn(t.position,s),b=e.enemies.filter(E=>E.hp>0).length===0?20:4;if(!bt(t.position,s,b))return{effects:a,messages:["Out of range!"],consumesTurn:!1};if(!p)return{effects:a,messages:["Axial only! Dash must be in a straight line."],consumesTurn:!1};a.push(...ft.DASH.anticipation(t.position,s));const v=Mt(m),T=Ze(t.position,s),S=pf(e,T.slice(1),{checkWalls:!0,checkActors:!0,checkLava:!1,excludeActorId:t.id});let x=s;if(S.obstacle){if(S.obstacle==="wall")return{effects:a,messages:["A wall blocks the way!"],consumesTurn:!1};if(S.obstacle==="lava")return{effects:a,messages:["Lava blocks the way!"],consumesTurn:!1};const E=T.findIndex(w=>J(w,S.position));x=T[E-1]||t.position}if(S.obstacle==="actor"?S.actor:null){const E=Ze(t.position,x);a.push(...ft.DASH.execution(E));const w=[{type:"Displacement",target:"self",destination:x,path:E,simulatePath:!0,ignoreGroundHazards:!0,animationDuration:E.length*60}],M=Yt(e,w,{sourceId:t.id});if(e.hasShield){a.push(...ft.DASH.impact(x,v,!0));const k=5+(e.hasShield&&u?2:0)+(f?1:0),R=ic(M,{origin:x,direction:v,momentum:k});return{effects:[...a,...w,...R],messages:[...l,"Shield Shunt!"],consumesTurn:!0}}else return a.push(...ft.DASH.impact(x,v,!1)),{effects:[...a,...w],messages:[...l,"Stopped by an obstacle (Need shield to shunt)."],consumesTurn:!J(t.position,x)}}else{const E=Ze(t.position,x);a.push(...ft.DASH.execution(E));const w={type:"Displacement",target:"self",destination:x,path:E,simulatePath:!0,ignoreGroundHazards:!0,animationDuration:E.length*60};return{effects:[...a,w],messages:[...l,"Dashed!"],consumesTurn:!J(t.position,x)}}},getValidTargets:(e,t)=>{const o=e.enemies.filter(l=>l.hp>0).length===0?20:4,a=ye(e,t);return a?Ie.getAxialTargets(e,t,o,{stopAtObstacles:!0,includeActors:!0,includeWalls:!1}).filter(l=>Si(e,a,l)):[]},upgrades:{MOMENTUM_SURGE:{id:"MOMENTUM_SURGE",name:"Momentum Surge",description:"+2 Momentum when dashing with shield"},DASH_CHAIN_REACTION:{id:"DASH_CHAIN_REACTION",name:"Chain Reaction",description:"Enemies pushed into other enemies transfer momentum"}},scenarios:Ye("DASH")},p1={id:"FALCON_APEX_STRIKE",name:"Apex Strike",description:"The falcon dives into a target for lethal damage.",slot:"passive",icon:"",baseVariables:{range:4,cost:0,cooldown:2,damage:40},execute:(e,t,s,o=[])=>{const a=[],l=[],u=t.companionOf,p=(u?u===e.player.id?e.player:e.enemies.find(v=>v.id===u):void 0)?.activeSkills?.find(v=>v.id==="FALCON_COMMAND")?.activeUpgrades||[],m=o.includes("APEX_PREDATOR")||p.includes("APEX_PREDATOR");if(!s)return{effects:a,messages:l,consumesTurn:!1};const y=ye(e,s);if(!y)return{effects:a,messages:l,consumesTurn:!1};if(t.companionState?.apexStrikeCooldown&&t.companionState.apexStrikeCooldown>0)return{effects:a,messages:l,consumesTurn:!1};const b=_t({attackerId:t.id,targetId:y.id,skillId:"FALCON_APEX_STRIKE",basePower:40,trinity:Oe(t),targetTrinity:Oe(y),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});return a.push({type:"Damage",target:y.id,amount:b.finalPower,reason:"apex_strike",scoreEvent:b.scoreEvent}),a.push({type:"Juice",effect:"impact",target:s,intensity:"high",metadata:{signature:"ATK.STRIKE.PHYSICAL.FALCON_APEX_STRIKE",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"falcon_apex_strike",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_hex"},skillId:"FALCON_APEX_STRIKE",camera:{kick:"medium"}}}),a.push({type:"UpdateCompanionState",target:t.id,apexStrikeCooldown:m?1:2}),l.push(`Falcon executes APEX STRIKE on ${y.subtype||"enemy"}!`),{effects:a,messages:l,consumesTurn:!0}},upgrades:{},getValidTargets:(e,t)=>{const s=[];return e.enemies.forEach(o=>{fe(t,o.position)<=4&&s.push(o.position)}),s}},h1={id:"FALCON_AUTO_ROOST",name:"Auto Roost",description:"Automatically returns the falcon to roost mode when mark is lost.",slot:"passive",icon:"R",baseVariables:{range:0,cost:0,cooldown:0},execute:(e,t,s)=>({effects:[{type:"UpdateCompanionState",target:t.id,mode:"roost",markTarget:void 0}],messages:["Falcon loses prey and returns to roost mode."],consumesTurn:!0}),getValidTargets:(e,t)=>[t],upgrades:{}};function Id(e,t){return e.enemies.find(s=>s.companionOf===t&&s.subtype==="falcon")}const y1={id:"FALCON_COMMAND",name:e=>{const t=e?.player?.id;if(!t)return"Summon Falcon";const s=Id(e,t);if(!s)return"Summon Falcon";const o=s.companionState?.mode||"roost";return o==="scout"?"Falcon: Scout":o==="predator"?"Falcon: Hunt":"Falcon: Roost"},description:e=>{const t=e?.player?.id;if(!t)return"Call your Falcon companion.";const s=Id(e,t);if(!s)return"Call your Falcon companion.";const o=s.companionState?.mode||"roost";return o==="scout"?"Click tile to set patrol zone. Falcon orbits and attacks nearby enemies.":o==="predator"?"Click enemy to mark as prey. Falcon pursues and uses Apex Strike.":"Falcon returns to you. Heals and cleanses 1 debuff on arrival."},slot:"offensive",icon:"",baseVariables:{range:6,cost:0,cooldown:0},execute:(e,t,s)=>{const o=[],a=[];let l=Id(e,t.id);if(!l){const p=IA({ownerId:t.id,position:Ue(t.position)[0]});return o.push({type:"SpawnActor",actor:p}),o.push({type:"Message",text:"Your Falcon companion awakens!"}),a.push("Falcon summoned!"),{effects:o,messages:a,consumesTurn:!0}}const u=s?ye(e,s):void 0;return!s||J(s,t.position)||!!(u&&u.id===t.id)?(a.push("Falcon returns to roost."),o.push({type:"Juice",effect:"combat_text",target:t.position,text:"Roost",metadata:{signature:"UI.TEXT.NEUTRAL.FALCON_ROOST",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"falcon_roost",targetRef:{kind:"target_hex"},skillId:"FALCON_COMMAND",textTone:"system"}}),o.push({type:"UpdateCompanionState",target:l.id,mode:"roost"}),{effects:o,messages:a,consumesTurn:!0}):u&&u.factionId==="enemy"?(a.push(`Falcon marks ${u.subtype||"enemy"} as prey!`),o.push({type:"Juice",effect:"combat_text",target:s,text:" Marked",metadata:{signature:"UI.TEXT.NEUTRAL.FALCON_MARK",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"falcon_mark",targetRef:{kind:"target_hex"},skillId:"FALCON_COMMAND",textTone:"status"}}),o.push({type:"ApplyStatus",target:u.id,status:"marked_predator",duration:-1}),o.push({type:"UpdateCompanionState",target:l.id,mode:"predator",markTarget:u.id}),{effects:o,messages:a,consumesTurn:!0}):(a.push("Falcon set to patrol zone."),o.push({type:"Juice",effect:"combat_text",target:s,text:" Patrol",metadata:{signature:"UI.TEXT.NEUTRAL.FALCON_PATROL",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"falcon_patrol",targetRef:{kind:"target_hex"},skillId:"FALCON_COMMAND",textTone:"system"}}),o.push({type:"UpdateCompanionState",target:l.id,mode:"scout",markTarget:s}),{effects:o,messages:a,consumesTurn:!0})},getValidTargets:(e,t)=>Ie.getAreaTargets(e,t,6).filter(o=>(J(o,t),!0)),upgrades:{KEEN_SIGHT:{id:"KEEN_SIGHT",name:"Keen Sight",description:"Falcon reveals hidden enemies within 3 tiles of its position."},FALCON_TWIN_TALONS:{id:"FALCON_TWIN_TALONS",name:"Twin Talons",description:"Basic Peck hits 2 targets instead of 1."},APEX_PREDATOR:{id:"APEX_PREDATOR",name:"Apex Predator",description:"Apex Strike cooldown reduced by 1. Marked enemies take +1 damage from all sources."}},scenarios:Ye("FALCON_COMMAND")},g1={id:"FALCON_HEAL",name:"Roost Heal",description:"The falcon roosts and restores health to its companion.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:1},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const l=ye(e,s);return l?t.companionState?.healCooldown&&t.companionState.healCooldown>0?{effects:o,messages:a,consumesTurn:!1}:(o.push({type:"Heal",target:l.id,amount:1}),o.push({type:"Juice",effect:"flash",target:l.position,color:"#00ff88",metadata:{signature:"STATE.APPLY.HOLY.FALCON_HEAL",family:"status",primitive:"status_apply",phase:"impact",element:"holy",variant:"falcon_heal",targetRef:{kind:"target_hex"},skillId:"FALCON_HEAL"}}),o.push({type:"UpdateCompanionState",target:t.id,healCooldown:1}),a.push("Falcon roosts. You feel restored."),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:a,consumesTurn:!1}},upgrades:{},getValidTargets:(e,t)=>{const s=[],o=e.player;return fe(t,o.position)<=1&&s.push(o.position),s}},b1={id:"FALCON_PECK",name:"Peck",description:"The falcon pecks an adjacent enemy for 1 damage.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0,damage:1},execute:(e,t,s,o=[])=>{const a=[],l=[],u=t.companionOf,p=(u?u===e.player.id?e.player:e.enemies.find(v=>v.id===u):void 0)?.activeSkills?.find(v=>v.id==="FALCON_COMMAND")?.activeUpgrades||[],m=o.includes("TWIN_TALONS")||p.includes("TWIN_TALONS")||p.includes("FALCON_TWIN_TALONS");if(!s)return{effects:a,messages:l,consumesTurn:!1};const y=ye(e,s);if(!y||y.factionId==="player")return{effects:a,messages:l,consumesTurn:!1};if(fe(t.position,s)>1)return{effects:a,messages:l,consumesTurn:!1};const b=[y];if(m){const v=Ue(t.position).map(T=>ye(e,T)).filter(T=>!!T&&T.id!==y.id&&T.factionId==="enemy")[0];v&&b.push(v)}for(const v of b){const T=_t({attackerId:t.id,targetId:v.id,skillId:"FALCON_PECK",basePower:1,trinity:Oe(t),targetTrinity:Oe(v),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.15}],statusMultipliers:[]});a.push({type:"Damage",target:v.id,amount:T.finalPower,reason:"falcon_peck",scoreEvent:T.scoreEvent})}return a.push({type:"Juice",effect:"combat_text",target:s,text:"Peck!",intensity:"low",metadata:{signature:"UI.TEXT.PHYSICAL.FALCON_PECK",family:"ui",primitive:"text",phase:"instant",element:"physical",variant:"falcon_peck",targetRef:{kind:"target_hex"},skillId:"FALCON_PECK",textTone:"damage"}}),l.push(m&&b.length>1?`Falcon pecked ${b.length} enemies!`:`Falcon pecked ${y.subtype||"enemy"}!`),{effects:a,messages:l,consumesTurn:!0}},getValidTargets:(e,t)=>Ue(t).filter(s=>{const o=ye(e,s);return o&&o.factionId==="enemy"}),upgrades:{TWIN_TALONS:{id:"TWIN_TALONS",name:"Twin Talons",description:"Peck hits 2 adjacent targets instead of 1."}},scenarios:Ye("FALCON_PECK")},S1={id:"FALCON_SCOUT",name:"Scout Orbit",description:"The actor orbits a target point in a hexagonal ring.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0},execute:(e,t,s)=>{const o=[],a=[],l=t.companionState?.markTarget;if(!l||typeof l!="object")return{effects:o,messages:a,consumesTurn:!1};const u=l,f=Ue(u);let p;if(fe(t.position,u)!==1)p=f.sort((m,y)=>fe(t.position,m)-fe(t.position,y))[0];else{const y=(f.findIndex(b=>J(b,t.position))+1)%6;p=f[y]}return Ie.isWithinBounds(e,p)&&we.isWalkable(e,p)&&!ye(e,p)?(o.push({type:"Displacement",target:t.id,destination:p,source:t.position,simulatePath:!0}),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:a,consumesTurn:!1}},upgrades:{},getValidTargets:(e,t)=>[]},v1=new Set(["FIREBALL","FIREWALL","FIREWALK","ABSORB_FIRE"]),G0=(e,t)=>{const s=we.getTileAt(e,t),o=we.getTraitsForTile(e,s),a=l=>s.effects.some(u=>u.id===l);return s.baseId==="VOID"||o.has("VOID")||o.has("PIT")?"VOID_TOUCHED":s.baseId==="ICE"||a("ICE_WALL")?"FROZEN":s.baseId==="LAVA"||o.has("LAVA")||o.has("FIRE")||a("FIRE")?"MELTED":a("WET")||a("STEAM")?"SOAKED":"STABLE"},J0=(e,t)=>v1.has(e)&&t==="MELTED"?1.15:1,A1={id:"FIREBALL",name:"Fireball",description:"Launch a sphere of flame. Range 3, Axial. Deals damage and leaves fire.",slot:"offensive",icon:"",baseVariables:{range:3,cost:1,cooldown:2},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const{isAxial:l}=wn(t.position,s);if(!bt(t.position,s,3)||!l)return{effects:o,messages:["Invalid target! Range 3, Axial only."],consumesTurn:!1};const u=[s,...Ue(s)],f=Oe(t),p=!!e.intentPreview?.dangerTiles?.some(m=>J(m,t.position));for(const m of u){const y=ye(e,m),b=G0(e,m),v=J0("FIREBALL",b),T=_t({attackerId:t.id,targetId:y?.id||ce(m),skillId:"FIREBALL",basePower:1,trinity:f,targetTrinity:y?Oe(y):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.2}],statusMultipliers:v===1?[]:[{id:`surface_${b}`,multiplier:v}],inDangerPreviewHex:p,theoreticalMaxPower:1});o.push({type:"Damage",target:m,amount:T.finalPower,reason:"fireball",scoreEvent:T.scoreEvent}),o.push({type:"PlaceFire",position:m,duration:3})}return o.push({type:"Juice",effect:"flash",target:s,color:"#ff4400",metadata:{signature:"ATK.BLAST.FIRE.FIREBALL_IMPACT",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"fireball",targetRef:{kind:"target_hex"},skillId:"FIREBALL"}}),o.push({type:"Juice",effect:"shake",intensity:"medium",metadata:{signature:"UI.SHAKE.FIRE.FIREBALL",family:"ui",primitive:"shake",phase:"impact",element:"fire",variant:"fireball_shake",skillId:"FIREBALL",camera:{shake:"medium"}}}),a.push("Fireball!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>Ie.getAxialTargets(e,t,3),upgrades:{},scenarios:Ye("FIREBALL")},x1={id:"FIREWALK",name:"Firewalk",description:"Teleport to a fire or lava tile. Grants 2 turns of Fire Immunity.",slot:"utility",icon:"",baseVariables:{range:4,cost:1,cooldown:3},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!bt(t.position,s,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const l=e.tiles.get(ce(s)),u=l?.effects.some(p=>p.id==="FIRE"),f=l?.baseId==="LAVA"||l?.traits.has("LIQUID");return!u&&!f?{effects:o,messages:["Can only teleport to Fire or Lava!"],consumesTurn:!1}:es(e,s,t.id)?{effects:o,messages:["Target position occupied!"],consumesTurn:!1}:(o.push({type:"Displacement",target:"self",destination:s,source:t.position,simulatePath:!1}),o.push({type:"ApplyStatus",target:"self",status:"fire_immunity",duration:2}),o.push({type:"Juice",effect:"flash",target:s,color:"#ff8800",metadata:{signature:"MOVE.BLINK.FIRE.FIREWALK",family:"movement",primitive:"blink",phase:"impact",element:"fire",variant:"firewalk",targetRef:{kind:"target_hex"},skillId:"FIREWALK"}}),a.push("Firewalk!"),{effects:o,messages:a,consumesTurn:!0})},getValidTargets:(e,t)=>{const s=[];return e.tiles.forEach(o=>{const a=fe(t,o.position);if(a>0&&a<=4){const l=o.effects.some(f=>f.id==="FIRE"),u=o.baseId==="LAVA"||o.traits.has("LIQUID");(l||u)&&s.push(o.position)}}),s},upgrades:{},scenarios:Ye("FIREWALK")},T1={id:"FIREWALL",name:"Firewall",description:"Create a wall of flames 5 tiles wide. Area denial.",slot:"utility",icon:"",baseVariables:{range:4,cost:1,cooldown:4},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const{isAxial:l,directionIndex:u}=wn(t.position,s);if(!l)return{effects:o,messages:["Axial targeting only!"],consumesTurn:!1};const f=(u+2)%6,p=(u+5)%6,m=[s];let y=s;for(let v=0;v<2;v++)y=Kt(y,Mt(f)),Ie.isWithinBounds(e,y)&&m.push(y);let b=s;for(let v=0;v<2;v++)b=Kt(b,Mt(p)),Ie.isWithinBounds(e,b)&&m.push(b);for(const v of m)if(!Mn(e,v)){o.push({type:"PlaceFire",position:v,duration:3});const T=ye(e,v);if(T){const S=G0(e,v),x=J0("FIREWALL",S),_=_t({attackerId:t.id,targetId:T.id,skillId:"FIREWALL",basePower:1,trinity:Oe(t),targetTrinity:Oe(T),damageClass:"magical",scaling:[{attribute:"mind",coefficient:.15}],statusMultipliers:x===1?[]:[{id:`surface_${S}`,multiplier:x}]});o.push({type:"Damage",target:T.id,amount:_.finalPower,reason:"firewall_impact",scoreEvent:_.scoreEvent})}}return o.push({type:"Juice",effect:"flash",target:s,color:"#ffaa00",metadata:{signature:"ATK.BLAST.FIRE.FIREWALL",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"firewall",targetRef:{kind:"target_hex"},skillId:"FIREWALL"}}),a.push("Firewall raised!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>Ie.getAxialTargets(e,t,4),upgrades:{},scenarios:Ye("FIREWALL")};function E1(e,t,s,o){const a=fe(t.position,s);if(a<=1)return[];const l=Hn(s,t.position),u=Mt(l);return ic(e,{origin:s,direction:u,momentum:Math.min(o,a-1)})}function _1(e,t){return[{type:"Displacement",target:e.id,destination:t.position},{type:"Displacement",target:t.id,destination:e.position}]}function M1(e,t,s,o){return ic(e,{origin:t,direction:s,momentum:o})}const w1={id:"GRAPPLE_HOOK",name:"Grapple Hook",description:"Pull/Zip mechanism with multi-phase kinetic resolution.",slot:"offensive",icon:"",baseVariables:{range:4,cost:0,cooldown:2,momentum:4},execute:(e,t,s,o=[])=>{let a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};const{directionIndex:f}=wn(t.position,s),p=Mt(f);a.push(...ft.GRAPPLE_HOOK.anticipation(t.position,s));const{isValid:m,blockedBy:y}=hf(e,t.position,s,{stopAtWalls:!0,stopAtActors:!0,excludeActorId:t.id});if(!m)return l.push(`Line of sight blocked by ${y}!`),{effects:a,messages:l,consumesTurn:!1};const b=s,v=ye(e,b),T=we.getTraitsAt(e,b),x=T.has("BLOCKS_MOVEMENT")||T.has("ANCHOR")?"Heavy":v?.weightClass||"Standard";if(x==="Heavy"||x==="Anchored"){const _=Kd(b,p);a.push(...ft.GRAPPLE_HOOK.execution(Ze(t.position,_))),a.push({type:"Displacement",target:t.id,destination:_,ignoreGroundHazards:!0});const E=we.getTileAt(e,_);if(E){const M=Cs.processEntry(t,E,e);a.push(...M.effects),l.push(...M.messages)}const w=Ue(_);for(const M of w){const k=ye(e,M);k&&k.id!==t.id&&(a.push({type:"Impact",target:k.id,damage:0,direction:p}),a.push({type:"ApplyStatus",target:k.id,status:"stunned",duration:2}),a.push(he.stunBurst(M)))}return a.push(he.heavyImpact(_,p)),a.push(he.shake("high",p)),l.push("Zipped to anchor!"),{effects:a,messages:l,consumesTurn:!0}}else if(v){const _=fe(t.position,b),E=Mt((f+3)%6),w=t.position;a.push(...ft.GRAPPLE_HOOK.execution(Ze(t.position,s)));const M=E1(e,t,b,_-1),k=Yt(e,M,{sourceId:t.id,targetId:v.id}),R=k.enemies.find(q=>q.id===v.id)||(k.player.id===v.id?k.player:null);if(!R)return l.push(`${v.subtype||"Enemy"} neutralized during pull.`),{effects:[...a,...M],messages:l,consumesTurn:!0};const O=_1(t,R),I=R.position;a.push(...ft.GRAPPLE_HOOK.impact(I,p));const D=Yt(k,O,{sourceId:t.id,targetId:v.id}),j=M1(D,w,E,4),U=Ze(w,Kt(w,ff(f,6)));return a.push(...ft.GRAPPLE_HOOK.resolution(U,4)),{effects:[...a,...M,...O,...j],messages:["Vaulted and Flung!"],consumesTurn:!0}}else return l.push("Hook missed."),{effects:a,messages:l,consumesTurn:!1}},getValidTargets:(e,t)=>{const s=ye(e,t);return s?Ie.getAxialTargets(e,t,4,{includeWalls:!0,includeActors:!0,stopAtObstacles:!0}).filter(o=>{const{directionIndex:a}=wn(t,o),l=Mt(a),u=ye(e,o),f=we.getTraitsAt(e,o),m=f.has("BLOCKS_MOVEMENT")||f.has("ANCHOR")?Kd(o,l):u?o:void 0;return m?Si(e,s,m):!1}):[]},upgrades:{},scenarios:Ye("GRAPPLE_HOOK")},C1={id:"JUMP",name:"Jump",description:"Leap to an empty tile within range. Can cross lava but not walls.",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:2},execute:(e,t,s,o=[])=>{const a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};if(!t||!t.position)return{effects:a,messages:l,consumesTurn:!1};const u=o.includes("JUMP_RANGE"),f=o.includes("STUNNING_LANDING"),p=o.includes("METEOR_IMPACT"),m=o.includes("FREE_JUMP"),y=2+(u?1:0);if(!bt(t.position,s,y))return l.push("Target out of range!"),{effects:a,messages:l,consumesTurn:!1};const b=ye(e,s),v=Mn(e,s),T=Si(e,t,s);if(v)return l.push("Cannot jump into a wall!"),{effects:a,messages:l,consumesTurn:!1};if(!T)return l.push("Cannot land on hazard!"),{effects:a,messages:l,consumesTurn:!1};if(b&&!p)return l.push("Target hex is blocked!"),{effects:a,messages:l,consumesTurn:!1};if(b&&p){const S=_t({attackerId:t.id,targetId:b.id,skillId:"JUMP",basePower:99,trinity:Oe(t),targetTrinity:Oe(b),damageClass:"physical",scaling:[{attribute:"body",coefficient:.15}],statusMultipliers:[]});a.push({type:"Damage",target:b.id,amount:S.finalPower,scoreEvent:S.scoreEvent}),l.push(`Meteor Impact killed ${b.subtype||"enemy"}!`)}if(a.push({type:"Message",text:"Jumped!"}),a.push({type:"Displacement",target:"self",destination:s,ignoreCollision:!0,ignoreGroundHazards:!0,simulatePath:!0}),f){const S=Ue(s);let x=!1;for(const _ of S){const E=ye(e,_);E&&E.id!==t.id&&(a.push({type:"ApplyStatus",target:E.id,status:"stunned",duration:1}),x=!0)}x&&l.push("Enemies stunned by landing impact!")}return a.push({type:"Juice",effect:"shake",target:s,intensity:"medium",metadata:{signature:"MOVE.LEAP.NEUTRAL.JUMP_LAND",family:"movement",primitive:"leap",phase:"impact",element:"neutral",variant:"jump_landing",targetRef:{kind:"target_hex"},skillId:"JUMP",camera:{shake:"medium",kick:"light"}}}),{effects:a,messages:l,consumesTurn:!m}},getValidTargets:(e,t)=>{const s=ye(e,t);if(!s)return[];const o=s.activeSkills?.find(f=>f.id==="JUMP"),a=new Set(o?.activeUpgrades||[]),l=2+(a.has("JUMP_RANGE")?1:0),u=a.has("METEOR_IMPACT");return Ie.getAreaTargets(e,t,l).filter(f=>{if(J(f,t)||Mn(e,f)||!Si(e,s,f))return!1;const p=ye(e,f);return!(p&&p.id!==s.id&&!u)})},upgrades:{JUMP_RANGE:{id:"JUMP_RANGE",name:"Extended Jump",description:"Jump range +1"},JUMP_COOLDOWN:{id:"JUMP_COOLDOWN",name:"Nimble",description:"Jump cooldown -1",modifyCooldown:-1},STUNNING_LANDING:{id:"STUNNING_LANDING",name:"Stunning Landing",description:"All enemies within 1 hex of landing are stunned"},METEOR_IMPACT:{id:"METEOR_IMPACT",name:"Meteor Impact",description:"Can land on enemies to kill them"},FREE_JUMP:{id:"FREE_JUMP",name:"Free Jump",description:"Can move after jumping"}},scenarios:Ye("JUMP")},rg=2,O1=3,k1=3,N1=2;function R1(e,t){const s=[];for(let o=0;o<6;o++){let a=e;for(let l=0;l<t;l++)a=Kt(a,Mt(o));s.push(a)}return s}function I1(e,t,s){return R1(t,s).filter(a=>!(!Ie.isWithinBounds(e,a)||!we.isWalkable(e,a)||ye(e,a)))}const L1={id:"KINETIC_TRI_TRAP",name:"Kinetic Tri-Trap",description:"Deploy 3 hidden traps on axial tiles. Triggered enemies are flung away.",slot:"defensive",icon:"",baseVariables:{range:rg,cost:0,cooldown:k1},execute:(e,t,s,o=[])=>{const a=[],l=[];let u=e;const f=o.includes("VOLATILE_CORE"),p=o.includes("TRAP_CHAIN_REACTION")||o.includes("CHAIN_REACTION"),m=o.includes("QUICK_RELOAD"),y=I1(e,t.position,rg);if(y.length===0)return{effects:a,messages:["No valid trap positions!"],consumesTurn:!1};const b=Math.min(O1,y.length),v=[];a.push({type:"RemoveTrap",position:{q:0,r:0,s:0},ownerId:t.id});const T=[...y];for(let S=0;S<b&&T.length!==0;S++){const{value:x,nextState:_}=_n(u);u=_;const E=Math.floor(x*T.length)%T.length;v.push(T[E]),T.splice(E,1)}for(const S of v)a.push({type:"PlaceTrap",position:S,ownerId:t.id,volatileCore:f,chainReaction:p,resetCooldown:m?1:N1}),a.push({type:"Juice",effect:"flash",target:S,intensity:"low",color:"#ffaa00",metadata:{signature:"ENV.TRAP.KINETIC.DEPLOY",family:"environment",primitive:"spawn",phase:"impact",element:"kinetic",variant:"kinetic_tri_trap_deploy",targetRef:{kind:"target_hex"},skillId:"KINETIC_TRI_TRAP"}});return l.push(`${v.length} traps deployed.`),{effects:a,messages:l,consumesTurn:!0}},getValidTargets:(e,t)=>[t],upgrades:{VOLATILE_CORE:{id:"VOLATILE_CORE",name:"Volatile Core",description:"Traps deal 1 damage when triggered."},TRAP_CHAIN_REACTION:{id:"TRAP_CHAIN_REACTION",name:"Chain Reaction",description:"When a trap triggers, adjacent traps also activate."},QUICK_RELOAD:{id:"QUICK_RELOAD",name:"Quick Reload",description:"Individual trap reset cooldown reduced to 1."}},scenarios:Ye("KINETIC_TRI_TRAP")},B1={id:"MULTI_SHOOT",name:"Multi-Shoot",description:"A spread of arrows. Axial range 4. Deals damage to target and neighbors.",slot:"offensive",icon:"",baseVariables:{range:4,cost:1,cooldown:1},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const{isAxial:l}=wn(t.position,s);if(!bt(t.position,s,4)||!l)return{effects:o,messages:["Invalid target! Axial range 4 only."],consumesTurn:!1};const u=[s,...Ue(s)],f=Oe(t);for(const p of u){const m=ye(e,p),y=_t({attackerId:t.id,targetId:m?.id||ce(p),skillId:"MULTI_SHOOT",basePower:1,trinity:f,targetTrinity:m?Oe(m):void 0,damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.1},{attribute:"mind",coefficient:.1}],statusMultipliers:[]});o.push({type:"Damage",target:p,amount:y.finalPower,reason:"multi_shoot",scoreEvent:y.scoreEvent})}return o.push({type:"Juice",effect:"flash",target:s,color:"#ffff00",metadata:{signature:"ATK.SHOOT.PHYSICAL.MULTI_SHOOT",family:"attack",primitive:"shoot",phase:"impact",element:"physical",variant:"multi_shoot",targetRef:{kind:"target_hex"},skillId:"MULTI_SHOOT"}}),a.push("Multi-Shoot!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>Ie.getAxialTargets(e,t,4),upgrades:{},scenarios:Ye("MULTI_SHOOT")},P1=(e,t)=>t.q>=0&&t.q<e.gridWidth&&t.r>=0&&t.r<e.gridHeight,H1=(e,t,s)=>Ue(s).filter(a=>P1(e,a)).filter(a=>we.isWalkable(e,a)).filter(a=>!ye(e,a)).sort((a,l)=>{const u=fe(a,t.position),f=fe(l,t.position);return u!==f?u-f:a.q!==l.q?a.q-l.q:a.r-l.r})[0]||null,j1=(e,t)=>t.id!==e.id&&t.factionId===e.factionId;function lg(e,t,s,o="fail"){const a=ye(e,s);if(!a)return{ok:!0,spawnPosition:s,effects:[],messages:[]};if(o==="push_friendly"){if(!j1(t,a))return{ok:!1,effects:[],messages:[],failureMessage:"Target tile occupied."};const l=H1(e,t,s);return l?{ok:!0,spawnPosition:s,effects:[{type:"Displacement",target:a.id,destination:l,source:a.position,simulatePath:!0}],messages:["Ally repositions to make room."]}:{ok:!1,effects:[],messages:[],failureMessage:"No space to reposition ally."}}return{ok:!1,effects:[],messages:[],failureMessage:"Target tile occupied."}}const D1=(e,t)=>!!e.tiles.get(ce(t))?.traits?.has("CORPSE"),U1=(e,t,s)=>{const o=[];return e.tiles.forEach(a=>{a.traits.has("CORPSE")&&fe(t,a.position)<=s&&o.push(a.position)}),o},$1=e=>{const t=e.initialSeed??e.rngSeed??"0",s=new Set([...e.enemies.map(l=>l.id),...(e.companions||[]).map(l=>l.id)]);let o=(e.floor<<20)+(e.turnNumber<<12)+(e.actionLog?.length??0)+(e.rngCounter??0),a=`skeleton_${ka(t,o,8,"skeleton")}`;for(;s.has(a);)o+=1,a=`skeleton_${ka(t,o,8,"skeleton")}`;return a},q1={id:"RAISE_DEAD",name:"Raise Dead",description:"Reanimate a target corpse into a Skeleton minion (Faction: Player).",slot:"utility",icon:"",baseVariables:{range:4,cost:1,cooldown:3},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!D1(e,s))return{effects:o,messages:["A corpse is required!"],consumesTurn:!1};if(!bt(t.position,s,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const u=lg(e,t,s,"push_friendly");if(!u.ok)return{effects:o,messages:[u.failureMessage||"Target tile occupied."],consumesTurn:!1};o.push(...u.effects),a.push(...u.messages),o.push({type:"RemoveCorpse",position:s});const f=T0({companionType:"skeleton",ownerId:t.id,id:$1(e),position:s});return o.push({type:"SpawnActor",actor:f}),o.push({type:"Juice",effect:"flash",target:s,color:"#aaaaaa",metadata:{signature:"STATE.SPAWN.VOID.RAISE_DEAD",family:"status",primitive:"spawn",phase:"impact",element:"void",variant:"raise_dead",targetRef:{kind:"target_hex"},skillId:"RAISE_DEAD"}}),a.push("Skeleton raised!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>{const s=ye(e,t);return s?U1(e,t,4).filter(o=>lg(e,s,o,"push_friendly").ok):[]},upgrades:{},scenarios:Ye("RAISE_DEAD")},z1={id:"SENTINEL_BLAST",name:"Sentinel Blast",description:"A massive energy surge from the Sentinel.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:0,damage:2},execute:(e,t,s)=>{if(!s)return{effects:[],messages:[]};const o=Oe(t),a=ye(e,s),l=_t({attackerId:t.id,targetId:a?.id||ce(s),skillId:"SENTINEL_BLAST",basePower:2,trinity:o,targetTrinity:a?Oe(a):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.2}],statusMultipliers:[]}),u=[{type:"Damage",target:s,amount:l.finalPower,scoreEvent:l.scoreEvent},{type:"Juice",effect:"shake",intensity:"high",metadata:{signature:"ATK.BLAST.ARCANE.SENTINEL_BLAST",family:"attack",primitive:"blast",phase:"impact",element:"arcane",variant:"sentinel_blast",targetRef:{kind:"target_hex"},skillId:"SENTINEL_BLAST",camera:{shake:"high"}}}];return Ue(s).forEach(p=>{const m=ye(e,p),y=_t({attackerId:t.id,targetId:m?.id||ce(p),skillId:"SENTINEL_BLAST",basePower:1,trinity:o,targetTrinity:m?Oe(m):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.1}],statusMultipliers:[]});u.push({type:"Damage",target:p,amount:y.finalPower,scoreEvent:y.scoreEvent})}),{effects:u,messages:["The Sentinel unleashed a massive blast!"],consumesTurn:!0}},getValidTargets:(e,t)=>Ie.getAreaTargets(e,t,3),upgrades:{},scenarios:Ye("SENTINEL_BLAST")},V1={id:"SENTINEL_TELEGRAPH",name:"Sentinel Telegraph",description:"The Sentinel marks an impact zone for a delayed blast.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:0},execute:(e,t,s)=>s?{effects:[{type:"Juice",effect:"combat_text",target:s,text:"TELEGRAPH",metadata:{signature:"UI.TEXT.ARCANE.SENTINEL_TELEGRAPH",family:"ui",primitive:"text",phase:"telegraph",element:"arcane",variant:"sentinel_telegraph",targetRef:{kind:"target_hex"},skillId:"SENTINEL_TELEGRAPH",textTone:"system"}}],messages:["The Sentinel marks the impact zone."],consumesTurn:!0}:{effects:[],messages:[],consumesTurn:!0},getValidTargets:(e,t)=>Ie.getAreaTargets(e,t,3),upgrades:{},scenarios:Ye("SENTINEL_TELEGRAPH")},Y1={id:"SET_TRAP",name:"Set Trap",description:"Place a hidden trap. Roots units for 3 turns.",slot:"utility",icon:"",baseVariables:{range:1,cost:1,cooldown:2},execute:(e,t,s)=>{const o=[],a=[];return s?Mn(e,s)||Ns(e,s)?{effects:o,messages:["Cannot place trap here!"],consumesTurn:!1}:(o.push({type:"PlaceTrap",position:s,ownerId:t.id}),o.push({type:"Juice",effect:"combat_text",target:s,text:"Trapped",metadata:{signature:"UI.TEXT.NEUTRAL.SET_TRAP",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"set_trap",targetRef:{kind:"target_hex"},skillId:"SET_TRAP",textTone:"status"}}),a.push("Trap set."),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:a,consumesTurn:!1}},getValidTargets:(e,t)=>Ue(t).filter(s=>!Mn(e,s)&&!Ns(e,s)),upgrades:{},scenarios:Ye("SET_TRAP")},K1={id:"SHADOW_STEP",name:"Shadow Step",description:"Teleport through the shadows. Only works while invisible. Extends stealth.",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:2},execute:(e,t,s)=>{const o=[],a=[];return s?(t.stealthCounter||0)>0?bt(t.position,s,2)?Mn(e,s)||Ns(e,s)||es(e,s,t.id)?{effects:o,messages:["Cannot step there!"],consumesTurn:!1}:(o.push({type:"Displacement",target:"self",destination:s}),o.push({type:"SetStealth",target:"self",amount:2}),o.push({type:"Juice",effect:"hiddenFade",target:s,metadata:{signature:"MOVE.BLINK.SHADOW.SHADOW_STEP",family:"movement",primitive:"blink",phase:"instant",element:"shadow",variant:"shadow_step_arrival",targetRef:{kind:"target_hex"},skillId:"SHADOW_STEP"}}),a.push("Shadow stepped!"),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:["Too far!"],consumesTurn:!1}:{effects:o,messages:["Must be invisible to Shadow Step!"],consumesTurn:!1}:{effects:o,messages:a,consumesTurn:!1}},getValidTargets:(e,t)=>(e.player.stealthCounter||0)>0?Ie.getAreaTargets(e,t,2).filter(a=>J(a,t)?!1:!Mn(e,a)&&!Ns(e,a)&&!es(e,a)):[],upgrades:{},scenarios:Ye("SHADOW_STEP")},F1={id:"SHIELD_BASH",name:"Shield Bash",description:"Push an enemy 1 tile. If they hit a wall or another enemy, they are stunned.",slot:"defensive",icon:"",baseVariables:{range:1,cost:0,cooldown:2},execute:(e,t,s,o=[])=>{const a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};if(!t||!t.position)return{effects:a,messages:l,consumesTurn:!1};const u=o.includes("SHIELD_RANGE"),f=o.includes("ARC_BASH"),p=o.includes("BASH_360"),m=o.includes("WALL_SLAM"),y=1+(u?1:0);if(!bt(t.position,s,y))return l.push("Target out of range!"),{effects:a,messages:l,consumesTurn:!1};let b=[];if(p)b=Ue(t.position);else if(f){b=[s];const x=Ue(s);for(const _ of x)fe(_,t.position)===1&&b.length<3&&b.push(_)}else b=[s];const v=new Map;e.enemies.forEach(x=>v.set(x.id,x.position)),e.player&&v.set(e.player.id,e.player.position);const T=x=>{for(const[_,E]of Array.from(v.entries()))if(J(E,x))return _===e.player.id?e.player:e.enemies.find(w=>w.id===_)},S=(x,_)=>{const E=T(_);if(!E||E.id===t.id)return;const w=Hn(x,_),M=Mt(w),k=Kt(_,M),R=e.tiles.get(ce(k)),O=R?.baseId==="WALL"||R?.traits.has("BLOCKS_MOVEMENT"),I=!Ie.isWithinBounds(e,k),D=T(k);O||I||D&&D.id!==E.id?(a.push({type:"ApplyStatus",target:E.id,status:"stunned",duration:1}),l.push(`Bashed ${E.subtype||"enemy"} into obstacle!`),a.push({type:"Juice",effect:"shake",target:_,direction:M,intensity:"medium",metadata:{signature:"ENV.COLLISION.KINETIC.SHIELD_BASH",family:"environment",primitive:"collision",phase:"impact",element:"kinetic",variant:"shield_bash_collision",targetRef:{kind:"target_hex"},skillId:"SHIELD_BASH",camera:{shake:"medium",kick:"medium"}}}),D&&m&&S(_,k)):(a.push({type:"Displacement",target:E.id,destination:k,simulatePath:!0}),v.set(E.id,k),l.push(`Pushed ${E.subtype||"enemy"}!`))};for(const x of b)S(t.position,x);return{effects:a,messages:l}},getValidTargets:(e,t)=>{const s=ye(e,t);if(!s)return[];const a=1+(s.activeSkills?.find(l=>l.id==="SHIELD_BASH")?.activeUpgrades?.includes("SHIELD_RANGE")?1:0);return Ie.getAreaTargets(e,t,a).filter(l=>{const u=ye(e,l);return!!u&&u.id!==s.id&&u.factionId!==s.factionId})},upgrades:{SHIELD_RANGE:{id:"SHIELD_RANGE",name:"Extended Bash",description:"Range +1"},SHIELD_COOLDOWN:{id:"SHIELD_COOLDOWN",name:"Quick Recovery",description:"Cooldown -1",modifyCooldown:-1},ARC_BASH:{id:"ARC_BASH",name:"Arc Bash",description:"Bash hits 3-hex frontal arc (+1 cooldown)",modifyCooldown:1},BASH_360:{id:"BASH_360",name:"360 Bash",description:"Bash hits all neighbors (+1 cooldown)",modifyCooldown:1},PASSIVE_PROTECTION:{id:"PASSIVE_PROTECTION",name:"Passive Protection",description:"+1 temp armor when shield not on cooldown"},WALL_SLAM:{id:"WALL_SLAM",name:"Wall Slam",description:"Enemies bashed into obstacles trigger a cascade and stun"}},scenarios:Ye("SHIELD_BASH")},W1={id:"SHIELD_THROW",name:"Shield Throw",description:"Throw your shield to strike and push enemies. Triggers a kinetic pulse on impact.",slot:"defensive",icon:"",baseVariables:{range:5,cost:0,cooldown:2},execute:(e,t,s,o=[])=>{const a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};if(!e.hasShield)return l.push("Shield not in hand!"),{effects:a,messages:l,consumesTurn:!1};a.push(...ft.SHIELD_THROW.anticipation(t.position,s));const{isValid:u,blockedBy:f,blockedAt:p}=hf(e,t.position,s,{stopAtWalls:!0,stopAtActors:!0,excludeActorId:t.id});if(!u&&f==="wall")return l.push("Shield hit a wall mid-flight!"),a.push({type:"SpawnItem",itemType:"shield",position:p}),{effects:a,messages:l,consumesTurn:!0};const m=ye(e,s);if(!m)return l.push("Shield missed: No target at location."),a.push({type:"SpawnItem",itemType:"shield",position:s}),{effects:a,messages:l,consumesTurn:!0};const y=Ze(t.position,s);a.push(...ft.SHIELD_THROW.execution(y));const b=4,{directionIndex:v}=wn(t.position,s),T=Mt(v);a.push({type:"ApplyStatus",target:m.id,status:"stunned",duration:1}),a.push(...ft.SHIELD_THROW.impact(s,T));const S=ic(e,{origin:s,direction:T,momentum:b}),x=S.filter(M=>M.type==="Displacement"&&M.target===m.id),_=x[x.length-1],E=_&&"destination"in _?_.destination:s,w=Ze(s,E);return w.length>1&&a.push(...ft.SHIELD_THROW.resolution(w)),a.push({type:"SpawnItem",itemType:"shield",position:E}),l.push("Direct hit! Shield triggered kinetic pulse."),{effects:[...a,...S],messages:l,consumesTurn:!0}},getValidTargets:(e,t)=>Ie.getAxialTargets(e,t,4),upgrades:{},scenarios:Ye("SHIELD_THROW")},X1={id:"SMOKE_SCREEN",name:"Smoke Screen",description:"Vanish into a cloud of smoke. Adds +2 to stealth counter.",slot:"utility",icon:"",baseVariables:{range:0,cost:0,cooldown:2},execute:(e,t,s)=>{const o=[],a=[];return o.push({type:"SetStealth",target:"self",amount:2}),o.push({type:"Juice",effect:"hiddenFade",target:t.position,metadata:{signature:"STATE.FADE.SHADOW.SMOKE_SCREEN",family:"status",primitive:"state_fade",phase:"instant",element:"shadow",variant:"smoke_screen",targetRef:{kind:"target_hex"},skillId:"SMOKE_SCREEN"}}),a.push("Smoke Screen!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>[t],upgrades:{},scenarios:Ye("SMOKE_SCREEN")},G1={id:"SNEAK_ATTACK",name:"Sneak Attack",description:"Attack an adjacent enemy. Deals massive damage if executed from stealth.",slot:"offensive",icon:"",baseVariables:{range:1,cost:0,cooldown:0},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const l=Pn(e.enemies,s);if(!l)return{effects:o,messages:["No target!"],consumesTurn:!1};if(!bt(t.position,s,1))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const u=(t.stealthCounter||0)>0,f=u?5:3,p=_t({attackerId:t.id,targetId:l.id,skillId:"SNEAK_ATTACK",basePower:f,trinity:Oe(t),targetTrinity:Oe(l),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.25}],statusMultipliers:[]});return o.push({type:"Damage",target:l.id,amount:p.finalPower,reason:"sneak_attack",source:t.position,scoreEvent:p.scoreEvent}),u?(o.push({type:"Juice",effect:"flash",target:s,color:"#ff0000",metadata:{signature:"ATK.STRIKE.SHADOW.SNEAK_ATTACK",family:"attack",primitive:"strike",phase:"impact",element:"shadow",variant:"sneak_attack",targetRef:{kind:"target_hex"},skillId:"SNEAK_ATTACK",flags:{crit:!0}}}),a.push("SNEAK ATTACK!")):a.push("Sneak attack (No stealth bonus)."),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,t)=>Ue(t).filter(s=>!!Pn(e.enemies,s)),upgrades:{},scenarios:Ye("SNEAK_ATTACK")},J1={id:"SOUL_SWAP",name:"Soul Swap",description:"Instantly swap positions with a player-aligned minion.",slot:"utility",icon:"",baseVariables:{range:6,cost:0,cooldown:3},execute:(e,t,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!bt(t.position,s,6))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const l=ye(e,s);return!l||l.factionId!=="player"||l.id===t.id?{effects:o,messages:["Target must be a minion!"],consumesTurn:!1}:(o.push({type:"Displacement",target:t.id,destination:s}),o.push({type:"Displacement",target:l.id,destination:t.position}),o.push({type:"Juice",effect:"flash",target:s,color:"#330066",metadata:{signature:"MOVE.BLINK.ARCANE.SOUL_SWAP_ARRIVE",family:"movement",primitive:"blink",phase:"instant",element:"arcane",variant:"soul_swap_arrival",targetRef:{kind:"target_hex"},skillId:"SOUL_SWAP"}}),o.push({type:"Juice",effect:"flash",target:t.position,color:"#330066",metadata:{signature:"MOVE.BLINK.ARCANE.SOUL_SWAP_DEPART",family:"movement",primitive:"blink",phase:"instant",element:"arcane",variant:"soul_swap_departure",targetRef:{kind:"target_hex"},skillId:"SOUL_SWAP"}}),a.push("Soul Swapped!"),{effects:o,messages:a,consumesTurn:!0})},getValidTargets:(e,t)=>e.enemies.filter(s=>s.factionId==="player"&&bt(t,s.position,6)).map(s=>s.position),upgrades:{},scenarios:Ye("SOUL_SWAP")},Q1={id:"SPEAR_THROW",name:e=>e.hasSpear?"Spear Throw":"Recall Spear",description:e=>e.hasSpear?"Throw your spear to instantly kill an enemy.":"Recall your spear, damaging enemies in its path.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:0,damage:1},execute:(e,t,s,o=[])=>{const a=[],l=[],u=Oe(t),f=e.ruleset?.ailments?.acaeEnabled===!0,p=o.includes("SPEAR_RANGE"),m=o.includes("RECALL"),y=o.includes("RECALL_DAMAGE"),b=o.includes("LUNGE"),v=o.includes("LUNGE_ARC"),T=o.includes("DEEP_BREATH"),S=o.includes("SPEAR_CLEAVE")||o.includes("CLEAVE"),x=3+(p?1:0);if(e.hasSpear){if(!s)return{effects:a,messages:l,consumesTurn:!1};if(b&&fe(t.position,s)===2){const R=ye(e,s);if(R&&R.id!==t.id){const O=_t({attackerId:t.id,targetId:R.id,skillId:"SPEAR_THROW",basePower:99,trinity:u,targetTrinity:Oe(R),damageClass:"physical",scaling:[{attribute:"body",coefficient:.1},{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});return a.push({type:"Displacement",target:"self",destination:s,simulatePath:!0}),a.push({type:"Damage",target:R.id,amount:O.finalPower,scoreEvent:O.scoreEvent}),f&&a.push({type:"ApplyAilment",target:R.id,ailment:"bleed",skillMultiplier:12,baseDeposit:1}),l.push(`Lunged and killed ${R.subtype||"enemy"} !`),v&&Ue(s).forEach(I=>{const D=ye(e,I);if(D&&D.id!==t.id&&D.id!==R.id){const j=_t({attackerId:t.id,targetId:D.id,skillId:"SPEAR_THROW",basePower:1,trinity:u,targetTrinity:Oe(D),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.15}],statusMultipliers:[]});a.push({type:"Damage",target:D.id,amount:j.finalPower,scoreEvent:j.scoreEvent}),f&&a.push({type:"ApplyAilment",target:D.id,ailment:"bleed",skillMultiplier:8,baseDeposit:1})}}),T&&a.push({type:"ModifyCooldown",skillId:"JUMP",amount:0,setExact:!0}),{effects:a,messages:l}}}if(!bt(t.position,s,x))return l.push("Out of range!"),{effects:a,messages:l,consumesTurn:!1};const _=Pn(e.enemies,s);if(!_)return l.push("No enemy at target."),{effects:a,messages:l,consumesTurn:!1};if(!wn(t.position,s).isAxial)return l.push("Target must be axial."),{effects:a,messages:l,consumesTurn:!1};if(!zl(e,t.position,s,_.id,t.id))return l.push("No clear line of sight to enemy."),{effects:a,messages:l,consumesTurn:!1};a.push(...ft.SPEAR_THROW.anticipation(t.position,s));const M=s,k=_;if(a.push(...ft.SPEAR_THROW.execution(Ze(t.position,M))),k){const R=_t({attackerId:t.id,targetId:k.id,skillId:"SPEAR_THROW",basePower:99,trinity:u,targetTrinity:Oe(k),damageClass:"physical",scaling:[{attribute:"body",coefficient:.1},{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});a.push(...ft.SPEAR_THROW.impact(M,!0)),a.push({type:"Damage",target:k.id,amount:R.finalPower,scoreEvent:R.scoreEvent}),f&&a.push({type:"ApplyAilment",target:k.id,ailment:"bleed",skillMultiplier:14,baseDeposit:2}),l.push(`Spear killed ${k.subtype||"enemy"} !`),T&&a.push({type:"ModifyCooldown",skillId:"JUMP",amount:0,setExact:!0})}else a.push(...ft.SPEAR_THROW.impact(M,!1)),l.push("Spear thrown.");a.push({type:"SpawnItem",itemType:"spear",position:M}),m&&(a.push({type:"PickupSpear",position:M}),l.push("Spear auto-retrieved."))}else{const _=e.spearPosition;if(!_)return l.push("Spear is lost!"),{effects:a,messages:l,consumesTurn:!1};const E=Ze(_,t.position);if(y&&E.forEach(w=>{const M=Pn(e.enemies,w);if(M){const k=_t({attackerId:t.id,targetId:M.id,skillId:"SPEAR_THROW",basePower:1,trinity:u,targetTrinity:Oe(M),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.15}],statusMultipliers:[]});a.push({type:"Damage",target:M.id,amount:k.finalPower,scoreEvent:k.scoreEvent}),f&&a.push({type:"ApplyAilment",target:M.id,ailment:"bleed",skillMultiplier:8,baseDeposit:1}),l.push(`Spear recall hit ${M.subtype||"enemy"} !`)}}),a.push({type:"PickupSpear",position:_}),l.push("Spear recalled."),S){for(const w of Ue(_)){const M=Pn(e.enemies,w);if(!M)continue;const k=_t({attackerId:t.id,targetId:M.id,skillId:"SPEAR_THROW",basePower:1,trinity:u,targetTrinity:Oe(M),damageClass:"physical",scaling:[{attribute:"body",coefficient:.1}],statusMultipliers:[]});a.push({type:"Damage",target:M.id,amount:k.finalPower,scoreEvent:k.scoreEvent}),f&&a.push({type:"ApplyAilment",target:M.id,ailment:"bleed",skillMultiplier:6,baseDeposit:1})}l.push("Cleave triggered on pickup.")}a.push({type:"Juice",effect:"spearTrail",path:E,intensity:"medium",metadata:{signature:"ATK.SHOOT.PHYSICAL.SPEAR_RETURN",family:"attack",primitive:"shoot",phase:"travel",element:"physical",variant:"spear_return",sourceRef:{kind:"source_hex"},targetRef:{kind:"target_hex"},skillId:"SPEAR_THROW"}})}return{effects:a,messages:l}},getValidTargets:(e,t)=>{if(!e.hasSpear)return[];const s=ye(e,t);if(!s)return[];const l=3+(s.activeSkills?.find(f=>f.id==="SPEAR_THROW")?.activeUpgrades?.includes("SPEAR_RANGE")?1:0);return e.enemies.filter(f=>f.hp>0).filter(f=>{const p=f.position;return!wn(t,p).isAxial||!bt(t,p,l)?!1:zl(e,t,p,f.id,s.id)}).map(f=>f.position)},upgrades:{SPEAR_RANGE:{id:"SPEAR_RANGE",name:"Extended Reach",description:"Range +1"},RECALL:{id:"RECALL",name:"Recall",description:"Spear automatically returns (handled internally if active, or via manual recall)"},RECALL_DAMAGE:{id:"RECALL_DAMAGE",name:"Returning Edge",description:"Damage enemies in path when recalling spear"},LUNGE:{id:"LUNGE",name:"Lunge",description:"If an enemy is exactly 2 hexes away, move to them and kill"},LUNGE_ARC:{id:"LUNGE_ARC",name:"Lunge Sweeping",description:"Lunge hits neighbors of the target"},DEEP_BREATH:{id:"DEEP_BREATH",name:"Deep Breath",description:"Reset Jump cooldown on spear kill"},SPEAR_CLEAVE:{id:"SPEAR_CLEAVE",name:"Cleave",description:"Damage all neighbors when picking up spear"}},scenarios:Ye("SPEAR_THROW")},Z1={id:"SWIFT_ROLL",name:"Swift Roll",description:"Quickly dodge 2 tiles. Passive: Automatically roll away from attackers when hit.",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:2},execute:(e,t,s)=>{const o=[],a=[];return s?bt(t.position,s,2)?Mn(e,s)||Ns(e,s)||es(e,s,t.id)?{effects:o,messages:["Cannot roll there!"],consumesTurn:!1}:(o.push({type:"Displacement",target:"self",destination:s}),o.push({type:"Juice",effect:"dashBlur",target:s,path:[t.position,s],metadata:{signature:"MOVE.DASH.NEUTRAL.SWIFT_ROLL",family:"movement",primitive:"dash",phase:"travel",element:"neutral",variant:"swift_roll",sourceRef:{kind:"source_hex"},targetRef:{kind:"target_hex"},skillId:"SWIFT_ROLL"}}),a.push("Swift roll!"),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:["Too far!"],consumesTurn:!1}:{effects:o,messages:a,consumesTurn:!1}},getValidTargets:(e,t)=>Ie.getAreaTargets(e,t,2).filter(o=>J(o,t)?!1:!Mn(e,o)&&!Ns(e,o)&&!es(e,o)),upgrades:{},scenarios:Ye("SWIFT_ROLL")},e_={id:"THEME_HAZARDS",name:"Theme Hazards",description:"Internal skill for testing floor themes.",slot:"passive",icon:"",baseVariables:{range:0,cost:0,cooldown:0},execute:e=>({effects:[],messages:[]}),upgrades:{},scenarios:Ye("THEME_HAZARDS")},t_={id:"TIME_BOMB",name:"Time Bomb",description:"Detonates when the fuse reaches zero.",slot:"passive",icon:"",baseVariables:{range:0,cost:0,cooldown:0,damage:1},execute:(e,t,s)=>{const o=t.statusEffects.find(f=>f.type==="time_bomb");if(o&&o.duration>1)return{effects:[],messages:[],consumesTurn:!0};const a=t.position,u=[a,...Ue(a)].map(f=>({type:"Damage",target:f,amount:1,reason:"bomb_explosion"}));return u.push({type:"Damage",target:t.id,amount:999,reason:"bomb_explosion"}),u.push({type:"Juice",effect:"explosion_ring",target:a,intensity:"high",metadata:{signature:"ATK.BLAST.FIRE.TIME_BOMB",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"time_bomb",targetRef:{kind:"target_hex"},skillId:"TIME_BOMB"}}),{effects:u,messages:["A bomb exploded!"],consumesTurn:!0}},getValidTargets:(e,t)=>[t],upgrades:{}},n_={id:"VAULT",name:e=>e.turnNumber%2!==0?"Stun Vault":"Vault",description:e=>e.turnNumber%2!==0?"Leap to an empty tile and stun neighbors. (Odd Turn)":"Leap to an empty tile. (Even Turn)",slot:"utility",icon:"",baseVariables:{range:3,cost:0,cooldown:0},execute:(e,t,s,o=[])=>{const a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};if(!bt(t.position,s,3))return l.push("Out of range!"),{effects:a,messages:l,consumesTurn:!1};if(Mn(e,s)||es(e,s))return l.push("Blocked!"),{effects:a,messages:l,consumesTurn:!1};if(!Si(e,t,s))return l.push("Blocked!"),{effects:a,messages:l,consumesTurn:!1};const u=e.turnNumber%2!==0;a.push(...ft.VAULT.anticipation(t.position,s));const f=Ze(t.position,s);if(a.push(...ft.VAULT.execution(f)),a.push({type:"Displacement",target:"self",destination:s,path:f,ignoreGroundHazards:!0,animationDuration:250}),u){l.push("Stun Vault executed!");const p=Ue(s);for(const m of p)Pn(e.enemies,m)&&a.push({type:"ApplyStatus",target:m,status:"stunned",duration:1});a.push(...ft.VAULT.impact(s,!0)),l.push("Slam landing! Neighbors stunned.")}else a.push(...ft.VAULT.impact(s,!1)),l.push("Vaulted!");return{effects:a,messages:l}},getValidTargets:(e,t)=>{const o=ye(e,t);return o?Ie.getAreaTargets(e,t,3).filter(a=>J(a,t)?!1:!Mn(e,a)&&!es(e,a)&&Si(e,o,a)):[]},upgrades:{},scenarios:[{id:"vault_shift_stun",title:"Vault State-Shifting: Stun (Turn 1)",description:"Verify vault stuns on Turn 1 (Odd).",setup:e=>{e.setTurn(1),e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>{e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,t)=>t.some(s=>s.includes("Stun Vault executed!"))},{id:"vault_shift_normal",title:"Vault State-Shifting: Normal (Turn 2)",description:"Verify vault is normal on Turn 2 (Even).",setup:e=>{e.setTurn(2),e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>{e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,t)=>t.some(s=>s.includes("Vaulted!"))&&!t.some(s=>s.includes("Slam landing!"))}]},cg=1,ug=4,i_=1,Q0=1,s_=2;function a_(e,t,s,o=Q0){const a=Hn(s,t);if(a===-1)return null;const l=Mt(a);for(let f=o;f>=i_;f--){let p=t,m=!0;for(let y=0;y<f;y++){if(p=Kt(p,l),!Ie.isWithinBounds(e,p)){m=!1;break}if(!we.isWalkable(e,p)){m=!1;break}}if(m&&!ye(e,p))return p}const u=[(a+1)%6,(a+5)%6];for(const f of u){const p=Mt(f);let m=Kt(t,p);if(Ie.isWithinBounds(e,m)&&we.isWalkable(e,m)&&!ye(e,m))return m}return null}const o_={id:"WITHDRAWAL",name:"Withdrawal",description:"Quick shot + tactical backroll. Auto-triggers when enemies close in.",slot:"utility",icon:"",baseVariables:{range:cg,cost:0,cooldown:s_,damage:ug},execute:(e,t,s,o=[])=>{const a=[],l=[],u=o.includes("PARTING_SHOT"),f=o.includes("NIMBLE_FEET");if(!s)return{effects:a,messages:["No target!"],consumesTurn:!1};if(fe(t.position,s)>cg)return{effects:a,messages:["Target out of range!"],consumesTurn:!1};const m=ye(e,s);if(!m)return{effects:a,messages:["No enemy at target!"],consumesTurn:!1};if(m.factionId===t.factionId)return{effects:a,messages:["Cannot target allies!"],consumesTurn:!1};const y=_t({attackerId:t.id,targetId:m.id,skillId:"WITHDRAWAL",basePower:ug+(u?1:0),trinity:Oe(t),targetTrinity:Oe(m),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});a.push({type:"Damage",target:m.id,amount:y.finalPower,scoreEvent:y.scoreEvent}),a.push({type:"Juice",effect:"impact",target:s,metadata:{signature:"ATK.SHOOT.PHYSICAL.WITHDRAWAL",family:"attack",primitive:"shoot",phase:"impact",element:"physical",variant:"withdrawal_shot",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_hex"},skillId:"WITHDRAWAL"}}),l.push(`Withdrawal shot hits ${m.subtype||"enemy"}!`);const b=f?3:Q0,v=a_(e,t.position,s,b);return v?(a.push({type:"Displacement",target:"self",destination:v,source:t.position}),a.push({type:"Juice",effect:"dashBlur",target:v,path:[t.position,v],metadata:{signature:"MOVE.DASH.NEUTRAL.WITHDRAWAL_BACKROLL",family:"movement",primitive:"dash",phase:"travel",element:"neutral",variant:"withdrawal_backroll",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_hex"},skillId:"WITHDRAWAL"}}),l.push("Backroll!")):l.push("No safe retreat available!"),{effects:a,messages:l,consumesTurn:!0}},getValidTargets:(e,t)=>Ue(t).filter(s=>{const o=ye(e,s);return o&&o.factionId==="enemy"}),upgrades:{PARTING_SHOT:{id:"PARTING_SHOT",name:"Parting Shot",description:"Withdrawal deals +1 damage."},NIMBLE_FEET:{id:"NIMBLE_FEET",name:"Nimble Feet",description:"Backroll distance increased to 3 hexes."},HAIR_TRIGGER:{id:"HAIR_TRIGGER",name:"Hair Trigger",description:"Passive reaction does not consume cooldown."}},scenarios:Ye("WITHDRAWAL")},r_={ABSORB_FIRE:Lx,ARCHER_SHOT:QE,AUTO_ATTACK:Y0,BASIC_ATTACK:t1,BASIC_MOVE:a1,BOMB_TOSS:o1,BULWARK_CHARGE:r1,CORPSE_EXPLOSION:u1,DASH:m1,FALCON_APEX_STRIKE:p1,FALCON_AUTO_ROOST:h1,FALCON_COMMAND:y1,FALCON_HEAL:g1,FALCON_PECK:b1,FALCON_SCOUT:S1,FIREBALL:A1,FIREWALK:x1,FIREWALL:T1,GRAPPLE_HOOK:w1,JUMP:C1,KINETIC_TRI_TRAP:L1,MULTI_SHOOT:B1,RAISE_DEAD:q1,SENTINEL_BLAST:z1,SENTINEL_TELEGRAPH:V1,SET_TRAP:Y1,SHADOW_STEP:K1,SHIELD_BASH:F1,SHIELD_THROW:W1,SMOKE_SCREEN:X1,SNEAK_ATTACK:G1,SOUL_SWAP:J1,SPEAR_THROW:Q1,SWIFT_ROLL:Z1,THEME_HAZARDS:e_,TIME_BOMB:t_,VAULT:n_,WITHDRAWAL:o_},sc=r_,yl=Ix(sc);if(yl.missing.length>0||yl.invalid.length>0){const e=yl.missing.join(", "),t=yl.invalid.map(s=>`${s.skillId}: ${s.errors.join("; ")}`).join(" | ");throw new Error(`Skill intent profile validation failed. missing=[${e}] invalid=[${t}]`)}const Ma=()=>({...sc,...wx()});function Wi(e){const s=Ma()[e];return s?{id:e,name:s.name,description:typeof s.description=="function"?s.description({}):s.description,slot:s.slot,cooldown:s.baseVariables.cooldown||0,currentCooldown:0,range:s.baseVariables.range||0,upgrades:Object.keys(s.upgrades||{}),activeUpgrades:[]}:null}function l_(){return[Wi("BASIC_MOVE"),Wi("BASIC_ATTACK"),Wi("AUTO_ATTACK"),Wi("SPEAR_THROW"),Wi("SHIELD_BASH"),Wi("JUMP")].filter(Boolean)}const c_={...sc,get:e=>Ma()[e],getAllUpgrades:()=>{const e=Ma();return Object.values(e).flatMap(t=>Object.values(t.upgrades||{}).map(s=>({...s,skillId:t.id})))},getUpgrade:e=>{const t=Ma();for(const s of Object.values(t))if(s.upgrades?.[e])return s.upgrades[e]},getSkillForUpgrade:e=>{const t=Ma();for(const[s,o]of Object.entries(t))if(o.upgrades?.[e])return s},getSkillRange:(e,t)=>{const s=(e.activeSkills||[]).find(l=>l.id===t),o=Ma()[t];if(!o)return s?.range||0;let a=o.baseVariables.range;return s?.activeUpgrades&&s.activeUpgrades.forEach(l=>{const u=o.upgrades[l];u?.modifyRange&&(a+=u.modifyRange)}),a}},st=c_,u_=st.getSkillRange,d_=e=>st.get(e),f_={VANGUARD:{id:"VANGUARD",name:"Vanguard",description:"Direct damage, brawling, and area denial.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","AUTO_ATTACK","SPEAR_THROW","SHIELD_BASH","JUMP"]},SKIRMISHER:{id:"SKIRMISHER",name:"Skirmisher",description:"Zero direct damage. Kinetic momentum and environmental lethality.",startingUpgrades:[],startingSkills:["DASH","GRAPPLE_HOOK","SHIELD_THROW","VAULT"]},FIREMAGE:{id:"FIREMAGE",name:"Fire Mage",description:"Area control with fire and high-damage spells.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","ABSORB_FIRE","FIREBALL","FIREWALL","FIREWALK"]},NECROMANCER:{id:"NECROMANCER",name:"Necromancer",description:"Utilize death and reanimation.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","CORPSE_EXPLOSION","RAISE_DEAD","SOUL_SWAP"]},HUNTER:{id:"HUNTER",name:"Hunter",description:"Ranged precision and traps.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","FALCON_COMMAND","KINETIC_TRI_TRAP","WITHDRAWAL"]},ASSASSIN:{id:"ASSASSIN",name:"Assassin",description:"Stealth and high burst damage.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","SNEAK_ATTACK","SMOKE_SCREEN","SHADOW_STEP"]}};class m_ extends Error{issues;constructor(t){super(`Loadout validation failed:
${t.map(s=>`${s.path}: ${s.message}`).join(`
`)}`),this.name="LoadoutValidationError",this.issues=t}}const tf=e=>typeof e=="object"&&e!==null&&!Array.isArray(e),Yo=e=>typeof e=="string",yi=(e,t,s)=>e.push({path:t,message:s}),dg=(e,t,s,o={})=>{if(!Array.isArray(e)){yi(t,s,"Expected array");return}const a=new Set;e.forEach((l,u)=>{if(!Yo(l)||l.length===0){yi(t,`${s}[${u}]`,"Expected non-empty string");return}o.unique&&(a.has(l)&&yi(t,`${s}[${u}]`,`Duplicate "${l}"`),a.add(l))})},p_=(e,t="$")=>{const s=[];return tf(e)?((!Yo(e.id)||e.id.length===0)&&yi(s,`${t}.id`,"Expected non-empty string"),(!Yo(e.name)||e.name.length===0)&&yi(s,`${t}.name`,"Expected non-empty string"),Yo(e.description)||yi(s,`${t}.description`,"Expected string"),dg(e.startingUpgrades,s,`${t}.startingUpgrades`,{unique:!0}),dg(e.startingSkills,s,`${t}.startingSkills`,{unique:!0}),s):(yi(s,t,"Expected object"),s)},h_=e=>{const t=[];if(!tf(e))return yi(t,"$","Expected loadout catalog object"),t;for(const[s,o]of Object.entries(e)){const a=p_(o,`$.${s}`);t.push(...a),tf(o)&&Yo(o.id)&&o.id!==s&&yi(t,`$.${s}.id`,`Must match catalog key "${s}"`)}return t},y_=e=>{const t=h_(e);if(t.length>0)throw new m_(t);return e},g_=e=>Object.fromEntries(Object.entries(e).map(([t,s])=>[t,{...s,startingUpgrades:[...s.startingUpgrades],startingSkills:[...s.startingSkills]}])),b_=y_(f_),Yn=g_(b_);let fg=!1;const S_=(e=Yn)=>{const t=[];for(const[s,o]of Object.entries(e)){for(const a of o.startingSkills)st.get(a)||t.push({loadoutId:s,field:"startingSkills",value:a,message:`Unknown skill "${a}"`});for(const a of o.startingUpgrades)st.getUpgrade(a)||t.push({loadoutId:s,field:"startingUpgrades",value:a,message:`Unknown upgrade "${a}"`})}return t},Z0=()=>{if(fg)return Object.keys(Yn).length;const e=S_(Yn);if(e.length>0){const t=e.map(s=>`${s.loadoutId}.${s.field}: ${s.message}`).join(" | ");throw new Error(`Default loadout validation failed: ${t}`)}return fg=!0,Object.keys(Yn).length};Z0();const eb=e=>{const t=e.startingSkills.map(o=>Wi(o)).filter(Boolean),s=e.id;return{upgrades:[...e.startingUpgrades],activeSkills:t,archetype:s}},v_=e=>e.some(t=>t.id==="BASIC_MOVE"||t.id==="DASH"),tb=(e=[])=>{if(v_(e))return e;const t=Wi("BASIC_MOVE");return t?[t,...e]:e},Af=e=>{const t=e.activeSkills||[],s=tb(t);return s===t?e:{...e,activeSkills:s}};let nb=!1;const A_=(e=Hy)=>{const t=UA(e);e===Hy&&(fA(t),_0(E0));const s=Z0();return nx(t.units),Mx(t.skills),nb=!0,{unitsRegistered:t.units.length,skillsRegistered:t.skills.length,loadoutsValidated:s}},ib=()=>nb?{unitsRegistered:0,skillsRegistered:0,loadoutsValidated:0}:A_(),sb=(e,t="none")=>t==="floor"?Math.floor(e):t==="round"?Math.round(e):t==="ceil"?Math.ceil(e):e,ab=(e,t)=>t?Math.max(t.min,Math.min(t.max,e)):e,gl=(e,t)=>ab(sb(e,t.round),t.clamp),x_=(e,t)=>{if(e.method==="fixed")return{value:gl(e.value,e),before:-1,after:-1,usedRng:!1};if(e.method==="uniform_int"){const u=t(),f=e.max-e.min+1,p=e.min+Math.floor(u.value*f)%Math.max(1,f);return{value:gl(p,e),before:u.before,after:u.after,usedRng:!0}}if(e.method==="triangular_int"){const u=t(),f=e.min,p=e.mode,m=e.max,y=(p-f)/Math.max(1e-9,m-f),b=u.value<y?f+Math.sqrt(u.value*(m-f)*(p-f)):m-Math.sqrt((1-u.value)*(m-f)*(m-p));return{value:gl(b,e),before:u.before,after:u.after,usedRng:!0}}const s=t(),o=e.table.reduce((u,f)=>u+f.weight,0);let a=s.value*Math.max(1e-9,o),l=e.table[e.table.length-1].value;for(const u of e.table)if(a-=u.weight,a<=0){l=u.value;break}return{value:gl(l,e),before:s.before,after:s.after,usedRng:!0}},mg=(e,t,s)=>{if(e.formula==="trinity_hp_v1")return tc(s);const o=e.base??0,l=(e.terms||[]).reduce((f,p)=>f+(t[p.stat]??0)*p.coefficient,o),u=sb(l,e.round);return ab(u,e.clamp)},T_=(e,t)=>!t||Object.keys(t).length===0?e:{...e,activeSkills:(e.activeSkills||[]).map(s=>{const o=t[s.id];return o===void 0?s:{...s,currentCooldown:Math.max(0,o)}})},E_=e=>e.id.toLowerCase(),__=(e,t,s)=>{const o=t.definition,a=[];let l={rngSeed:e.rngSeed||"default",rngCounter:Math.max(0,e.rngCounter||0)},u=0;const f=`${l.rngSeed}:${o.instantiate.rngStream}:${o.instantiate.seedSalt||o.id}`,p=()=>{if(o.instantiate.counterMode==="consume_global"){const k=l.rngCounter,R=Ul(l.rngSeed,k);return l={...l,rngCounter:k+1},{value:R,before:k,after:l.rngCounter}}const w=u;return{value:Ul(f,u++),before:w,after:u}},m={};for(const w of t.drawOrder){const M=o.propensities[w];if(!M)continue;const k=x_(M,p);m[w]=k.value,k.usedRng&&a.push({key:w,method:M.method,value:k.value,counterBefore:k.before,counterAfter:k.after})}const y={body:m.body??0,mind:m.mind??0,instinct:m.instinct??0},b=o.derivedStats||{},v=b.maxHp?mg(b.maxHp,m,y):tc(y),T=m.speed??1,S=m.mass??1,x=o.runtimeDefaults?.startingHp==="explicit"?Math.max(0,o.runtimeDefaults.explicitHp??v):v,_=Qi({id:s.actorId||E_(o),type:o.actorType,subtype:s.subtype||o.subtype,position:s.position,hp:x,maxHp:v,speed:T,factionId:s.factionId||o.factionId,weightClass:o.weightClass,skills:[...t.skillIds,...t.passiveSkillIds],trinity:y});let E=T_(_,o.skillLoadout.startCooldowns);o.runtimeDefaults?.temporaryArmor!==void 0&&(E={...E,temporaryArmor:Math.max(0,o.runtimeDefaults.temporaryArmor)}),o.runtimeDefaults?.isVisible!==void 0&&(E={...E,isVisible:o.runtimeDefaults.isVisible}),m.maxHp=v,m.speed=T,m.mass=S;for(const[w,M]of Object.entries(b))w!=="maxHp"&&(m[w]=mg(M,m,y));return{actor:E,stats:m,trinity:y,speed:T,mass:S,nextCursor:l,rollTrace:a}},M_=(e,t,s)=>__(e,$A(t),s),w_=(e,t)=>{const s=ec(t),o=tA(Bl,Pl),a=[],l=o,u=Math.floor(Bl/2),f=Xt(u,Pl-1),p=Xt(u,0);let m;if(e%1===0){const M=l.filter(k=>!J(k,f)&&!J(k,p)&&fe(k,f)>=3);M.length>0&&(m=M[Math.floor(s.next()*M.length)])}const b=Math.floor(l.length*iA),v=[],T={playerStart:f,stairsPosition:p,shrinePosition:m},x=[...l.filter(M=>!Ly(M,T))].sort(()=>s.next()-.5);for(let M=0;M<b;M++)M<x.length&&v.push(x[M]);const _=l.filter(M=>!Ly(M,{playerStart:f,stairsPosition:p,shrinePosition:m})&&!a.some(k=>J(k,M))&&!v.some(k=>J(k,M))&&fe(M,f)>=3),E={id:"arena",type:"combat",center:Xt(Math.floor(Bl/2),Math.floor(Pl/2)),hexes:o,connections:[]},w=new Map;for(const M of o)w.set(`${M.q},${M.r}`,{baseId:"STONE",position:M,traits:new Set(Oa.STONE.defaultTraits),effects:[]});for(const M of a)w.set(`${M.q},${M.r}`,{baseId:"WALL",position:M,traits:new Set(Oa.WALL.defaultTraits),effects:[]});for(const M of v)w.set(`${M.q},${M.r}`,{baseId:"LAVA",position:M,traits:new Set(Oa.LAVA.defaultTraits),effects:[]});return{rooms:[E],allHexes:o,stairsPosition:p,shrinePosition:m,spawnPositions:_,playerSpawn:f,tiles:w}},C_=(e,t,s)=>{ib();const o=ec(s+":enemies"),a=uA(e),l=a.budget,u=a.allowedSubtypes;let f={rngSeed:`${s}:enemy-propensity`,rngCounter:0};const p=[];let m=l;const y=[];for(;m>0&&y.length<t.length;){const b=u.filter(U=>{const q=$l(U);return!!q&&q.bestiary.stats.cost<=m});if(b.length===0)break;const v=Math.floor(o.next()*b.length),T=b[v],S=$l(T);if(!S)break;const x=S.bestiary.stats,_=t.filter(U=>!y.some(q=>J(q,U)));if(_.length===0)break;const E=Math.floor(o.next()*_.length),w=_[E];y.push(w);const M=Math.floor(e/5),k=x.weightClass||"Standard",R=(f.rngCounter<<8)+p.length,O=`enemy_${p.length}_${ka(s,R,6,T)}`,I=ix(T);let D;if(I){const U=M_(f,I,{actorId:O,position:w,subtype:T,factionId:"enemy"});f=U.nextCursor,D=U.actor}else D=RA({id:O,subtype:T,position:w,speed:x.speed||1,skills:Ny(T,{source:"runtime",includePassive:!0}).length>0?Ny(T,{source:"runtime",includePassive:!0}):LA(T),weightClass:k,enemyType:x.type});const j=M>0?{...D,hp:D.hp+M,maxHp:D.maxHp+M}:D;p.push({...j,subtype:T,enemyType:x.type,actionCooldown:x.actionCooldown??j.actionCooldown,isVisible:!0}),m-=x.cost}return p},O_=e=>sA[e]||"inferno",k_=(e,t)=>{const s=t.initialSeed??t.rngSeed??"0",o=t.commandLog?.length??0;return{id:ka(s,o,9,"cmd"),timestamp:t.turnNumber,action:e}},N_=(e,t,s)=>{const o=s.initialSeed??s.rngSeed??"0",a=s.undoStack?.length??0;return{id:ka(o,a,9,"delta"),undoData:{player:{...e.player},enemies:[...e.enemies],turnNumber:e.turnNumber,gameStatus:e.gameStatus}}},R_=(e,t,s,o)=>{const a=(e.pendingFrames?.length??0)+1;return{id:`${e.turnNumber}:${s}:${t}:${a}`,type:t,status:s,createdTurn:e.turnNumber,blocking:!0,payload:o}},I_=(e,t,s,o)=>{const a=R_(e,s,t.status,o);return{...e,pendingStatus:t,pendingFrames:[...e.pendingFrames||[],a]}};function L_(e){let t=e;const s=[],o=[],a=new Map(t.tiles);for(const[l,u]of a.entries()){const f=[];let p=!1;for(const b of u.effects){if(b.duration===-1){f.push(b);continue}const v=b.duration-1;v>0?(f.push({...b,duration:v}),p=!0):(s.push(`The ${b.id.toLowerCase()} died down.`),p=!0)}p&&a.set(l,{...u,effects:f});const m=[t.player,...t.enemies],y=b=>`${b.q},${b.r}`;for(const b of m)if(y(b.position)===l){const v=Cs.processStay(b,u,t);o.push(...v.effects),s.push(...v.messages)}}return t={...t,tiles:a},o.length>0&&(t=Yt(t,o)),{state:t,messages:s}}const B_=e=>(Array.isArray(e.tiles)&&(e.tiles=new Map(e.tiles.map(([t,s])=>[t,{...s,traits:new Set(s.traits)}]))),e.player=Af(zo(e.player)),e.enemies=(e.enemies||[]).map(zo),e.companions&&(e.companions=e.companions.map(zo)),e.ruleset=bf(e),e),P_=(e,t)=>{if(!(e.pendingStatus?.shrineOptions||e.shrineOptions||[]).includes(t))return{...e,message:it(e.message,`Upgrade ${t} was not offered.`,"CRITICAL","SYSTEM")};let o=e.player,a=!1;const l=st.getUpgrade(t);if(l){const u=st.getSkillForUpgrade(t),f=!!u&&o.activeSkills.some(p=>p.id===u);if(u&&f){const p=JSON.stringify(o.activeSkills);o=wT(o,u,t),a=JSON.stringify(o.activeSkills)!==p}}else t==="EXTRA_HP"&&(o=_T(o,1,!0),a=!0);return!a&&t!=="EXTRA_HP"?{...e,message:it(e.message,`Upgrade ${t} could not be applied.`,"CRITICAL","SYSTEM")}:{...e,player:o,upgrades:e.upgrades.includes(t)?e.upgrades:[...e.upgrades,t],gameStatus:"playing",shrinePosition:void 0,shrineOptions:void 0,pendingStatus:void 0,pendingFrames:void 0,message:it(e.message,`Gained ${l?.name||t}!`,"INFO","OBJECTIVE")}},H_=(e,t)=>{const s=e.pendingFrames||[];if(s.length>1)return{...e,pendingFrames:s.slice(1)};if(!e.pendingStatus)return s.length===1?{...e,pendingFrames:[]}:e;const{status:o,shrineOptions:a,completedRun:l}=e.pendingStatus;if(o==="playing"&&e.gameStatus==="playing"){const u=e.initialSeed??e.rngSeed??"0",f=`${u}:${e.floor+1}`,p=e.enemies.filter(y=>y.hp>0&&y.factionId==="player"&&y.companionOf===e.player.id).sort((y,b)=>y.id.localeCompare(b.id)),m=t.generateInitialState(e.floor+1,f,u,{...e.player,hp:Math.min(e.player.maxHp,e.player.hp+1),upgrades:e.upgrades});if(m.ruleset=bf({...m,ruleset:e.ruleset||m.ruleset}),p.length>0){const y=[m.player.position,...Ue(m.player.position)],b=[m.player,...m.enemies],v=[];for(let T=0;T<p.length;T++){const S=p[T],x=y[y.length-1]||m.player.position,_=y.find(w=>!b.some(k=>J(k.position,w))&&we.isWalkable(m,w))||x,E={...S,position:_,previousPosition:_};b.push(E),v.push(E)}m.enemies=[...m.enemies,...v],m.companions=[...m.companions||[],...v.filter(T=>T.companionOf===e.player.id)],m.initiativeQueue=Rs(m),m.occupancyMask=Ie.refreshOccupancyMask(m)}return{...m,actionLog:[...e.actionLog||[]],dailyRunDate:e.dailyRunDate,runObjectives:e.runObjectives,hazardBreaches:e.hazardBreaches||0,pendingFrames:void 0}}return{...e,gameStatus:o,shrineOptions:a||e.shrineOptions,completedRun:l||e.completedRun,pendingStatus:void 0,pendingFrames:void 0}},j_=(e,t,s)=>{let o=e;const a=[],l=o.player.position;if(o.spearPosition&&J(l,o.spearPosition)){if(!!o.player.activeSkills?.find(m=>m.id==="SPEAR_THROW")?.activeUpgrades?.some(m=>m==="SPEAR_CLEAVE"||m==="CLEAVE")){const m=Ue(l).map(y=>o.enemies.find(b=>b.hp>0&&J(b.position,y))).filter(y=>!!y&&y.factionId!==o.player.factionId);if(m.length>0){const y=m.map(b=>({type:"Damage",target:b.id,amount:1,reason:"spear_cleave_pickup"}));o=Yt(o,y,{sourceId:o.player.id,stepId:t}),a.push(`Spear cleave hit ${m.length} target(s).`)}}o={...o,hasSpear:!0,spearPosition:void 0,message:it(o.message,"Picked up your spear.","INFO","OBJECTIVE")}}const u=L_(o);if(o=u.state,a.push(...u.messages),o={...o,turnNumber:o.turnNumber+1,turnsSpent:(o.turnsSpent||0)+1},o.traps&&o.traps.length>0&&(o={...o,traps:o.traps.map(f=>({...f,cooldown:Math.max(0,f.cooldown-1)}))}),o=i1(o),pA(o,o.player.position)){const f=o.player.activeSkills||[],p=new Set(f.map(S=>S.id)),m=new Map;for(const S of f)m.set(S.id,new Set(S.activeUpgrades||[]));const y=st.getAllUpgrades().filter(S=>p.has(S.skillId)).filter(S=>{if(o.upgrades.includes(S.id))return!1;const x=m.get(S.skillId);return!x||!x.has(S.id)}).map(S=>S.id).filter((S,x,_)=>_.indexOf(S)===x),b=[];let v={...o};for(let S=0;S<3&&y.length>0;S++){const x=_n(v);v=x.nextState;const _=Math.floor(x.value*y.length);b.push(y[_]),y.splice(_,1)}const T=b.length>0?b:["EXTRA_HP"];return{state:s.withPendingFrame({...o,rngCounter:v.rngCounter,message:it(o.message,"A holy shrine! Choose an upgrade.","INFO","OBJECTIVE")},{status:"choosing_upgrade",shrineOptions:T},"SHRINE_CHOICE",{shrineOptions:T}),messages:a,haltTurnLoop:!0}}if(hA(o,o.player.position)){if(o.floor>=10){const p=Fo(o);return{state:s.withPendingFrame({...o,message:it(o.message,`Arcade Cleared! Final Score: ${p.score}`,"INFO","OBJECTIVE")},{status:"won",completedRun:p},"RUN_WON",{score:p.score??0}),messages:a,haltTurnLoop:!0}}return{state:s.withPendingFrame({...o,message:it(o.message,"Descending to the next level...","INFO","OBJECTIVE")},{status:"playing"},"STAIRS_TRANSITION",{nextFloor:o.floor+1}),messages:a,haltTurnLoop:!0}}return{state:o,messages:a,haltTurnLoop:!1}},nf=(e,t)=>{const s={},o={},a={},l=Array.from(new Set([...Object.keys(e),...Object.keys(t)])).sort();let u=0;for(const f of l){const p=Number(e[f]||0),m=Number(t[f]||0),y=p*m;s[f]=p,o[f]=m,a[f]=y,u+=y}return{total:u,features:s,weights:o,contributions:a}};var ob={};const pg=4.5,D_="HOP_ENEMY_AI_DYNAMIC_INTENT_BIAS_STRENGTH",Ld={offense:0,positioning:0,control:0,defense:0},jl=(e,t,s)=>Math.max(t,Math.min(s,e)),Po=(e,t,s=1)=>{e.offense+=(t.offense||0)*s,e.positioning+=(t.positioning||0)*s,e.control+=(t.control||0)*s,e.defense+=(t.defense||0)*s},U_={damage:{offense:.22,control:.02},move:{positioning:.24,offense:.04},heal:{defense:.24,control:.04},protect:{defense:.2,control:.06},control:{control:.25,positioning:.06},summon:{control:.14,defense:.08},hazard:{control:.14,offense:.1},objective:{positioning:.08,control:.12},economy:{defense:.08,control:.08},utility:{positioning:.08,control:.1}},$_=e=>{const t=String(e||"").toUpperCase(),s=new Set;return/(ATTACK|THROW|BLAST|FIREBALL|BASH|PECK|EXPLOSION|SPEAR|SHOOT|DASH)/.test(t)&&s.add("damage"),/(MOVE|DASH|JUMP|ROLL|VAULT|STEP|GRAPPLE|WITHDRAWAL|WALK|TELEPORT)/.test(t)&&s.add("move"),/(HEAL|ABSORB)/.test(t)&&s.add("heal"),/(SHIELD|PROTECT|BULWARK)/.test(t)&&s.add("protect"),/(STUN|TRAP|SMOKE|TELEGRAPH|ROOT|SWAP|SCOUT)/.test(t)&&s.add("control"),/(RAISE|SUMMON|FALCON)/.test(t)&&s.add("summon"),/(FIRE|LAVA|HAZARD|BOMB|EXPLOSION)/.test(t)&&s.add("hazard"),s.size===0&&s.add("utility"),[...s]},q_=e=>{const s=st.get(e)?.intentProfile;return s?.intentTags&&s.intentTags.length>0?s.intentTags:$_(e)},hg=(e,t)=>{const s={offense:Math.max(0,e.offense),positioning:Math.max(0,e.positioning),control:Math.max(0,e.control),defense:Math.max(0,e.defense)},o=s.offense+s.positioning+s.control+s.defense;if(o<=t||o<=0)return s;const a=t/o;return{offense:s.offense*a,positioning:s.positioning*a,control:s.control*a,defense:s.defense*a}},Vl=()=>{if(typeof process>"u")return!1;const e=ob?.HOP_ENEMY_AI_DYNAMIC_INTENT_BIAS;return e==="1"||e==="true"},xf=()=>{if(typeof process>"u")return 1;const e=ob?.[D_];if(!e)return 1;const t=Number(e);return Number.isFinite(t)?jl(t,0,8):1},rb=(e,t)=>{if(!Vl())return{...Ld};const s=xf();if(s<=0)return{...Ld};const o={...Ld},a=Oe(e.enemy),l=jl(Number(a.body||0),0,24),u=jl(Number(a.mind||0),0,24),f=jl(Number(a.instinct||0),0,24);Po(o,{offense:l*.06+f*.015,defense:l*.018+u*.028,control:u*.06,positioning:f*.055+Math.max(0,Number(e.enemy.speed||1)-1)*.06});for(const y of e.enemy.activeSkills||[]){const b=String(y.id),v=q_(b);for(const _ of v)Po(o,U_[_]||{});const T=st.get(y.id),S=Number(T?.intentProfile?.target?.range??y.range??0);S>=3?Po(o,{positioning:.08,control:.04}):S<=1&&Po(o,{offense:.05});const x=Number(T?.intentProfile?.economy?.cooldown??y.cooldown??0);x>0&&Po(o,{defense:.02,control:.015},Math.min(3,x))}const p=hg(o,pg);if(s===1)return p;const m={offense:p.offense*s,positioning:p.positioning*s,control:p.control*s,defense:p.defense*s};return hg(m,pg*Math.max(1,s))},yg=["offense","control","positioning","defense"],z_=e=>{const t=fe(e.enemy.position,e.playerPos);return{dist_to_player:t,adjacent_to_player:t===1?1:0,hostile_hidden:(e.state.player.stealthCounter||0)>0?1:0,enemy_hp:Number(e.enemy.hp||0),enemy_action_cooldown:Number(e.enemy.actionCooldown||0)}},lb=(e,t)=>{if(t===void 0)return 0;if(typeof t=="number")return e===t?1:0;const[s,o]=t;return e>=s&&e<=o?1:0},cb=(e,t)=>{if(t===void 0)return 0;if(typeof t=="number")return Math.abs(e-t);const[s,o]=t;return e<s?s-e:e>o?e-o:0},V_=(e,t)=>{const s=t.action.type,o=String(t.action.skillId||"").toUpperCase(),a=String(e.planned.entity.intent||"").toUpperCase();return a==="SEARCHING"||a==="PREPARING"||a==="SENTINEL_TELEGRAPH"||o==="SENTINEL_TELEGRAPH"?"control":s==="MOVE"||a==="MOVING"||a==="ADVANCING"||a==="REPOSITIONING"||a==="LUMBERING"?"positioning":s==="WAIT"||a==="WAITING"||a==="IDLE"?"defense":"offense"},Y_=(e,t)=>{const s=fe(e.enemy.position,e.playerPos),o=t.subtype||e.enemy.subtype||"default",a=o==="archer"||o==="warlock"||o==="bomber",l=lb(s,t.preferredRange)===1,u=cb(s,t.preferredRange),f=Number(e.enemy.actionCooldown||0),p=(e.state.player.stealthCounter||0)>0,m=e.enemy.position.q===e.playerPos.q||e.enemy.position.r===e.playerPos.r||e.enemy.position.s===e.playerPos.s;let y=0,b=0,v=0,T=0;a?(y+=l?1.25:.55,b+=l?.35:1.15):(y+=s<=1?1.5:.6,b+=s>1?1.2:.2),b+=Math.min(3,u)*.35,f>0&&(T+=.8,v+=.3,y-=.15),p&&(v+=1.4,T+=.3,y-=.4),o==="sentinel"&&(v+=1.3,s<=3&&(y+=.6)),(o==="warlock"||o==="bomber")&&(b+=.5),(o==="raider"||o==="pouncer")&&m&&s>=2&&s<=4&&(v+=.45,y+=.45);const S=rb(e);return y+=S.offense,b+=S.positioning,v+=S.control,T+=S.defense,{offense:Math.max(0,y),positioning:Math.max(0,b),control:Math.max(0,v),defense:Math.max(0,T)}},K_=e=>{let t=yg[0];for(const s of yg)e[s]>e[t]&&(t=s);return t},F_=(e,t,s,o)=>{const a=z_(e),l=fe(e.enemy.position,e.playerPos),u=fe(t.planned.entity.position,e.playerPos),f=J(t.planned.entity.position,e.enemy.position)?0:1,p=s.action.type,m=s.action.skillId||"",y=Number(t.planned.entity.actionCooldown||0)-Number(e.enemy.actionCooldown||0),b=o.subtype==="sentinel",v=b&&l<=3,T=b&&e.state.turnNumber%2===0,S=b&&!T,x=m==="SENTINEL_TELEGRAPH",_=m==="SENTINEL_BLAST",E=e.enemy.position.q===e.playerPos.q||e.enemy.position.r===e.playerPos.r||e.enemy.position.s===e.playerPos.s,w=m==="DASH",M=m==="GRAPPLE_HOOK",k=m==="ARCHER_SHOT"||m==="SPEAR_THROW",R=m==="BOMB_TOSS",O=s.action.targetHex,I=O&&fe(O,e.playerPos)===1?1:0,D=O&&J(O,e.playerPos)?1:0,j=o.subtype;return{...a,candidate_pre_score:Number(t.preScore||0),is_wait_action:p==="WAIT"?1:0,is_move_action:p==="MOVE"?1:0,is_attack_action:p==="ATTACK"?1:0,is_skill_action:p==="USE_SKILL"?1:0,moved:f,dist_before:l,dist_after:u,dist_delta_toward_player:l-u,preferred_range_match:lb(u,o.preferredRange),has_target_hex:s.action.targetHex?1:0,target_adjacent_to_player:I,target_is_player_tile:D,uses_signature_skill:o.subtype==="sentinel"&&(m==="SENTINEL_BLAST"||m==="SENTINEL_TELEGRAPH")?1:0,raider_dash_window_match:j==="raider"&&E&&l>=2&&l<=4&&w?1:0,pouncer_hook_window_match:j==="pouncer"&&E&&l>=2&&l<=4&&M?1:0,archer_ranged_window_match:j==="archer"&&l>1&&k?1:0,archer_melee_window_match:j==="archer"&&l===1&&m==="BASIC_ATTACK"?1:0,bomber_bomb_window_match:j==="bomber"&&(e.enemy.actionCooldown??0)===0&&l>=2&&l<=3&&R?1:0,bomber_bomb_target_valid_shape:j==="bomber"&&R&&I===1&&D===0?1:0,bomber_reposition_candidate:j==="bomber"&&t.id==="bomber-reposition"?1:0,sentinel_phase_telegraph_match:v&&T&&x?1:0,sentinel_phase_execute_match:v&&S&&_?1:0,sentinel_phase_mismatch:v&&(T&&_||S&&x)?1:0,cooldown_delta_positive:y>0?1:0,rng_consumption:Number(s.rngConsumption||0),message_present:t.planned.message?1:0}},W_=(e,t,s,o)=>{const a=Y_(e,o),l=V_(t,s),u=K_(a),f=fe(e.enemy.position,e.playerPos),p=cb(f,o.preferredRange),m=(e.state.player.stealthCounter||0)>0;return{intent_is_offense:l==="offense"?1:0,intent_is_positioning:l==="positioning"?1:0,intent_is_control:l==="control"?1:0,intent_is_defense:l==="defense"?1:0,intent_desire_offense:a.offense,intent_desire_positioning:a.positioning,intent_desire_control:a.control,intent_desire_defense:a.defense,intent_selected_desire:a[l],intent_dominant_match:l===u?1:0,intent_preferred_range_gap:p,intent_player_hidden:m?1:0}},gg={id:"enemy-default-policy-v1",tags:["policy-v1"]},X_={sprinter:{id:"enemy-sprinter-policy-v1",subtype:"sprinter",preferredRange:1,tags:["policy-v1","melee"]},shieldBearer:{id:"enemy-shieldBearer-policy-v1",subtype:"shieldBearer",preferredRange:1,tags:["policy-v1","melee"]},warlock:{id:"enemy-warlock-policy-v1",subtype:"warlock",preferredRange:[2,4],tags:["policy-v1","ranged","teleport"]},sentinel:{id:"enemy-sentinel-policy-v1",subtype:"sentinel",preferredRange:3,tags:["policy-v1","playlist"]},raider:{id:"enemy-raider-policy-v1",subtype:"raider",preferredRange:[1,4],tags:["policy-v1","dash"]},pouncer:{id:"enemy-pouncer-policy-v1",subtype:"pouncer",preferredRange:[1,4],tags:["policy-v1","grapple"]},archer:{id:"enemy-archer-policy-v1",subtype:"archer",preferredRange:[2,4],tags:["policy-v1","ranged"]},bomber:{id:"enemy-bomber-policy-v1",subtype:"bomber",preferredRange:[2,3],tags:["policy-v1","ranged","aoe"]},assassin:{id:"enemy-assassin-policy-v1",subtype:"assassin",preferredRange:1,tags:["policy-v1","stealth"]},golem:{id:"enemy-golem-policy-v1",subtype:"golem",preferredRange:[1,3],tags:["policy-v1","heavy"]}},G_=e=>e?X_[e]||{...gg,id:`enemy-${e}-policy-v1`,subtype:e}:gg,Yl=(e,t)=>{const s=t.q-e.q,o=t.r-e.r;return s>0&&o===0?0:s>0&&o<0?1:s===0&&o<0?2:s<0&&o===0?3:s<0&&o>0?4:5},ct=(e,t,s,o=[],a)=>{if(ZE(e))return{position:e.position,state:s};const l=Ie.getNeighbors(e.position);let u=[],f=a!==void 0?Math.abs(fe(e.position,t)-a):fe(e.position,t);for(const b of l){if(!Ie.isWithinBounds(s,b))continue;const v=s.tiles.get(ce(b)),T=v?.traits.has("BLOCKS_LOS")||v?.baseId==="WALL",S=o.some(w=>J(w,b))||s.enemies.some(w=>w.id!==e.id&&J(w.position,b))||J(b,t);if(T||S)continue;const x=v?Cs.getMovementCost(s,v):1,E=(a!==void 0?Math.abs(fe(b,t)-a):fe(b,t))+(x-1);E<f?(f=E,u=[b]):E===f&&u.push(b)}if(u.length===0)return{position:e.position,state:s};if(u.length===1)return{position:u[0],state:s};const{value:p,nextState:m}=_n(s),y=Math.floor(p*u.length)%u.length;return{position:u[y],state:m}},J_=(e,t,s)=>{if(fe(e.position,t)===1)return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...t}},nextState:s};let a=e.position,l=s;for(let f=0;f<2&&!(fe(a,t)<=1);f++){const p={...e,position:a},{position:m,state:y}=ct(p,t,l,s.occupiedCurrentTurn);a=m,l=y}const u=!J(a,e.position);return{entity:{...e,position:a,intent:u?"Moving":"BASIC_ATTACK",intentPosition:u?void 0:{...t}},nextState:l,message:u?`${e.subtype} moves to (${a.q}, ${a.r})`:void 0}},Q_=(e,t,s)=>{const o=fe(e.position,t),a=Yl(e.position,t);if(o===1)return{entity:{...e,facing:a,intent:"BASIC_ATTACK",intentPosition:{...t}},nextState:s};const{position:l,state:u}=ct(e,t,s,s.occupiedCurrentTurn),f=!J(l,e.position);return{entity:{...e,position:l,facing:f?Yl(e.position,l):a,intent:f?"Advancing":"BASIC_ATTACK",intentPosition:f?void 0:{...t}},nextState:u,message:f?`${e.subtype} advances to (${l.q}, ${l.r})`:void 0}},Z_=(e,t,s)=>{const o=fe(e.position,t);let a=s;const{value:l,nextState:u}=_n(a);a=u;let f=e.position;if(o<=2||l<.3){const{value:b,nextState:v}=_n(a);a=v;const{value:T,nextState:S}=_n(a);a=S;const x=Math.floor(b*6),_=3+Math.floor(T*3);let E=e.position;for(let M=0;M<_;M++)E=Kt(E,Mt(x));!Ie.isWithinBounds(s,E)||!we.isWalkable(s,E)||s.occupiedCurrentTurn?.some(M=>J(M,E))||s.enemies.some(M=>M.id!==e.id&&J(M.position,E))||J(E,t)||(f=E)}const p=!J(f,e.position),m=fe(f,t),y=!p&&m>=2&&m<=4;return{entity:{...e,position:f,intent:p?"Repositioning":y?"Casting":"Preparing",intentPosition:y?{...t}:void 0},nextState:a,message:p?`${e.subtype} teleports to (${f.q}, ${f.r})`:void 0}},eM=(e,t,s)=>{const o=fe(e.position,t);if(o===1)return{entity:{...e,isVisible:!0,intent:"BASIC_ATTACK",intentPosition:{...t}},nextState:s};const{position:a,state:l}=ct(e,t,s,s.occupiedCurrentTurn),u=!J(a,e.position);return{entity:{...e,position:a,isVisible:u?!1:o<=1,intent:u?"Moving":"BASIC_ATTACK",intentPosition:u?void 0:{...t}},nextState:l,message:u?"You hear footsteps nearby...":void 0}},tM={sentinel:{telegraphSkillId:"SENTINEL_TELEGRAPH",executeSkillId:"SENTINEL_BLAST",triggerRange:3,telegraphMessage:"The Sentinel marks the blast zone..."}},nM=(e,t,s,o)=>{const l=fe(e.position,t)<=o.triggerRange,u=s.turnNumber%2===0,f=!u;if(l&&f&&ns(e))return{entity:{...e,intent:"Preparing",intentPosition:void 0},nextState:s,message:`${e.subtype} loses focus!`};if(l&&u)return{entity:{...e,intent:o.telegraphSkillId,intentPosition:{...t}},nextState:s,message:o.telegraphMessage};if(l&&f)return{entity:{...e,intent:o.executeSkillId,intentPosition:{...t}},nextState:s};const{position:p,state:m}=ct(e,t,s,s.occupiedCurrentTurn);return{entity:{...e,position:p,intent:"Moving",intentPosition:void 0},nextState:m}},iM=(e,t,s)=>{const o=e.actionCooldown??0;if(o>0)return{entity:{...e,actionCooldown:o-1,intent:"Charging Power"},nextState:s};const a=fe(e.position,t);if(a>=1&&a<=3)return{entity:{...e,actionCooldown:2,intent:"BASIC_ATTACK",intentPosition:{...t}},nextState:s};const{position:l,state:u}=ct(e,t,s,s.occupiedCurrentTurn),f=!J(l,e.position);return{entity:{...e,position:l,intent:f?"Lumbering":"Waiting",actionCooldown:0},nextState:u,message:f?`${e.subtype} lumbers to (${l.q}, ${l.r})`:void 0}},sM=(e,t,s)=>{const o=fe(e.position,t);if(o>4){const{position:y,state:b}=ct(e,t,s,s.occupiedCurrentTurn),v=!J(y,e.position);return{entity:{...e,position:y,intent:v?"Following":"Waiting"},nextState:b,message:v?`${e.subtype} follows you.`:void 0}}const a=s.enemies.filter(y=>y.factionId==="enemy").sort((y,b)=>fe(e.position,y.position)-fe(e.position,b.position))[0];if(!a){if(o>1){const{position:y,state:b}=ct(e,t,s,s.occupiedCurrentTurn);return{entity:{...e,position:y,intent:"Idle"},nextState:b}}return{entity:{...e,intent:"Idle"},nextState:s}}if(fe(e.position,a.position)===1)return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...a.position}},nextState:s};const{position:u,state:f}=ct(e,a.position,s,s.occupiedCurrentTurn),p=!J(u,e.position),m=fe(u,a.position);return{entity:{...e,position:u,intent:p?"Advancing":m===1?"BASIC_ATTACK":"Waiting",intentPosition:p||m>1?void 0:{...a.position}},nextState:f,message:p?`${e.subtype} attacks ${a.subtype}!`:void 0}},aM=(e,t,s)=>{const o=fe(e.position,t);if((e.position.q===t.q||e.position.r===t.r||e.position.s===t.s)&&o>=2&&o<=4)return{entity:{...e,intent:"DASH",intentPosition:{...t}},nextState:s};const{position:l,state:u}=ct(e,t,s,s.occupiedCurrentTurn),f=!J(l,e.position),p=fe(l,t);return{entity:{...e,position:l,intent:f?"Moving":p===1?"BASIC_ATTACK":"Waiting",intentPosition:f||p>1?void 0:{...t}},nextState:u,message:f?`${e.subtype} moves to (${l.q}, ${l.r})`:void 0}},oM=(e,t,s)=>{const o=fe(e.position,t);if((e.position.q===t.q||e.position.r===t.r||e.position.s===t.s)&&o>=2&&o<=4)return{entity:{...e,intent:"GRAPPLE_HOOK",intentPosition:{...t}},nextState:s};const{position:l,state:u}=ct(e,t,s,s.occupiedCurrentTurn),f=!J(l,e.position);return{entity:{...e,position:l,intent:f?"Moving":"Waiting",intentPosition:void 0},nextState:u,message:f?`${e.subtype} moves to (${l.q}, ${l.r})`:void 0}},rM=(e,t,s)=>{const o=fe(e.position,t),a=e.activeSkills?.some(y=>y.id==="ARCHER_SHOT")?"ARCHER_SHOT":"SPEAR_THROW",l=st.get(a);if(o>1&&!!l?.getValidTargets&&l.getValidTargets(s,e.position).some(y=>J(y,t)))return{entity:{...e,intent:a,intentPosition:{...t}},nextState:s};if(o===1&&e.activeSkills?.some(y=>y.id==="BASIC_ATTACK"))return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...t}},nextState:s};const{position:f,state:p}=ct(e,t,s,s.occupiedCurrentTurn),m=!J(f,e.position);return{entity:{...e,position:f,intent:m?"Moving":"Idle",intentPosition:void 0},nextState:p,message:m?`${e.subtype} moves to (${f.q}, ${f.r})`:void 0}},lM=(e,t,s)=>{const o=fe(e.position,t),a=e.actionCooldown??0;if(a===0&&o>=2&&o<=3){const m=Ie.getNeighbors(t).filter(y=>{const b=!we.isWalkable(s,y),v=s.enemies.some(T=>J(T.position,y));return Ie.isWithinBounds(s,y)&&!b&&!v&&!J(y,t)});if(m.length>0){const{value:y,nextState:b}=_n(s),v=Math.floor(y*m.length)%m.length,T=m[v];return{entity:{...e,intent:"Bombing",intentPosition:T,actionCooldown:2},nextState:b}}}const{position:u,state:f}=ct(e,t,s,s.occupiedCurrentTurn,2.5),p=!J(u,e.position);return{entity:{...e,position:u,intent:p?"Moving":"Waiting",intentPosition:void 0,actionCooldown:Math.max(0,a-1)},nextState:f,message:p?`${e.subtype} repositioning to (${u.q}, ${u.r})`:void 0}},cM=(e,t,s)=>{if(fe(e.position,t)===1)return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...t}},nextState:s};const{position:a,state:l}=ct(e,t,s,s.occupiedCurrentTurn),u=!J(a,e.position),f=fe(a,t);return{entity:{...e,position:a,intent:u?"Moving":f===1?"BASIC_ATTACK":"Waiting",intentPosition:u||f>1?void 0:{...t}},nextState:l,message:u?`${e.subtype} moves to (${a.q}, ${a.r})`:void 0}},uM={sprinter:J_,shieldBearer:Q_,warlock:Z_,assassin:eM,golem:iM,sentinel:(e,t,s)=>nM(e,t,s,tM.sentinel),raider:aM,pouncer:oM,archer:rM,bomber:lM},bg=e=>{const{enemy:t,playerPos:s,state:o}=e;if(t.factionId==="player")return sM(t,s,o);if((o.player.stealthCounter||0)>0)return{entity:{...t,intent:"Searching",intentPosition:void 0},nextState:o};const l=t.subtype?uM[t.subtype]:void 0;return l?l(t,s,o):cM(t,s,o)},Sg=e=>{const t=e.planned.entity;return[e.source,String(t.intent||"Waiting"),ce(t.position),t.intentPosition?ce(t.intentPosition):"none",String(t.actionCooldown??"none"),String(t.facing??"none"),String(t.isVisible??"none"),String(e.planned.nextState.rngCounter||0),String(e.planned.message||"")].join("::")},vg=(e,t)=>e.q===t.q||e.r===t.r||e.s===t.s,_s=(e,t)=>!!e.activeSkills?.some(s=>s.id===t),dM=new Set(["sprinter","shieldBearer","warlock","assassin","golem","sentinel","raider","pouncer","archer","bomber"]),fM=(e,t={})=>{const s=[],o=t.includePolicyExact===!0,a=S=>{const x=Sg(S);s.some(_=>Sg(_)===x)||s.push(S)};if(o){const S=bg({enemy:e.enemy,playerPos:e.playerPos,state:e.state});a({id:"policy-exact",source:"policy_exact",reasoningCode:"POLICY_EXACT",preScore:0,planned:S})}if(e.enemy.factionId==="player"){const S=bg({enemy:e.enemy,playerPos:e.playerPos,state:e.state});return a({id:"minion-policy-shape",source:"synthetic",reasoningCode:"SYN_MINION_POLICY_SHAPE",preScore:10,planned:S}),s}a({id:"wait",source:"synthetic",reasoningCode:"SYN_WAIT",preScore:-10,planned:{entity:{...e.enemy,intent:"Waiting",intentPosition:void 0},nextState:e.state}});const l=fe(e.enemy.position,e.playerPos),u=e.enemy.subtype||"default",f=!dM.has(u),m=!!e.enemy.activeSkills?.some(S=>S.id==="BASIC_ATTACK")||f;if(l===1&&m&&a({id:"basic-attack",source:"synthetic",reasoningCode:"SYN_BASIC_ATTACK",preScore:5,planned:{entity:{...e.enemy,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}}),f&&l>1){const{position:S,state:x}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),_=!J(S,e.enemy.position),E=fe(S,e.playerPos);a({id:"default-move",source:"synthetic",reasoningCode:"SYN_DEFAULT_MOVE",preScore:0,planned:{entity:{...e.enemy,position:S,intent:_?"Moving":E===1?"BASIC_ATTACK":"Waiting",intentPosition:_||E>1?void 0:{...e.playerPos}},nextState:x,message:_?`${e.enemy.subtype} moves to (${S.q}, ${S.r})`:void 0}})}if(u==="sprinter"&&l>1){let S=e.enemy.position,x=e.state;for(let E=0;E<2&&!(fe(S,e.playerPos)<=1);E++){const w={...e.enemy,position:S},{position:M,state:k}=ct(w,e.playerPos,x,e.state.occupiedCurrentTurn);S=M,x=k}const _=!J(S,e.enemy.position);a({id:"sprinter-move",source:"synthetic",reasoningCode:"SYN_SPRINTER_MOVE",preScore:0,planned:{entity:{...e.enemy,position:S,intent:_?"Moving":"BASIC_ATTACK",intentPosition:_?void 0:{...e.playerPos}},nextState:x,message:_?`${e.enemy.subtype} moves to (${S.q}, ${S.r})`:void 0}})}if(u==="shieldBearer"){const S=Yl(e.enemy.position,e.playerPos);if(l===1)a({id:"shieldbearer-attack-facing",source:"synthetic",reasoningCode:"SYN_SHIELDBEARER_ATTACK",preScore:0,planned:{entity:{...e.enemy,facing:S,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}});else{const{position:x,state:_}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),E=!J(x,e.enemy.position);a({id:"shieldbearer-advance",source:"synthetic",reasoningCode:"SYN_SHIELDBEARER_ADVANCE",preScore:0,planned:{entity:{...e.enemy,position:x,facing:E?Yl(e.enemy.position,x):S,intent:E?"Advancing":"BASIC_ATTACK",intentPosition:E?void 0:{...e.playerPos}},nextState:_,message:E?`${e.enemy.subtype} advances to (${x.q}, ${x.r})`:void 0}})}}if(u==="assassin")if(l===1)a({id:"assassin-attack",source:"synthetic",reasoningCode:"SYN_ASSASSIN_ATTACK",preScore:0,planned:{entity:{...e.enemy,isVisible:!0,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}});else{const{position:S,state:x}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),_=!J(S,e.enemy.position);a({id:"assassin-move",source:"synthetic",reasoningCode:"SYN_ASSASSIN_MOVE",preScore:0,planned:{entity:{...e.enemy,position:S,isVisible:_?!1:l<=1,intent:_?"Moving":"BASIC_ATTACK",intentPosition:_?void 0:{...e.playerPos}},nextState:x,message:_?"You hear footsteps nearby...":void 0}})}if(u==="golem"){const S=e.enemy.actionCooldown??0;if(S>0)a({id:"golem-charging",source:"synthetic",reasoningCode:"SYN_GOLEM_CHARGING",preScore:0,planned:{entity:{...e.enemy,actionCooldown:S-1,intent:"Charging Power"},nextState:e.state}});else if(l>=1&&l<=3)a({id:"golem-attack",source:"synthetic",reasoningCode:"SYN_GOLEM_ATTACK",preScore:0,planned:{entity:{...e.enemy,actionCooldown:2,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}});else{const{position:x,state:_}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),E=!J(x,e.enemy.position);a({id:"golem-lumbering",source:"synthetic",reasoningCode:"SYN_GOLEM_LUMBERING",preScore:0,planned:{entity:{...e.enemy,position:x,intent:E?"Lumbering":"Waiting",actionCooldown:0},nextState:_,message:E?`${e.enemy.subtype} lumbers to (${x.q}, ${x.r})`:void 0}})}}if(u==="sentinel"){const S=l<=3,x=e.state.turnNumber%2===0,_=!x;if(S&&_&&ns(e.enemy))a({id:"sentinel-preparing-stunned",source:"synthetic",reasoningCode:"SYN_SENTINEL_STUNNED_PREPARING",preScore:0,planned:{entity:{...e.enemy,intent:"Preparing",intentPosition:void 0},nextState:e.state,message:`${e.enemy.subtype} loses focus!`}});else if(S&&x)a({id:"sentinel-telegraph",source:"synthetic",reasoningCode:"SYN_SENTINEL_TELEGRAPH",preScore:0,planned:{entity:{...e.enemy,intent:"SENTINEL_TELEGRAPH",intentPosition:{...e.playerPos}},nextState:e.state,message:"The Sentinel marks the blast zone..."}});else if(S&&_)a({id:"sentinel-blast",source:"synthetic",reasoningCode:"SYN_SENTINEL_BLAST",preScore:0,planned:{entity:{...e.enemy,intent:"SENTINEL_BLAST",intentPosition:{...e.playerPos}},nextState:e.state}});else{const{position:E,state:w}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn);a({id:"sentinel-move",source:"synthetic",reasoningCode:"SYN_SENTINEL_MOVE",preScore:0,planned:{entity:{...e.enemy,position:E,intent:"Moving",intentPosition:void 0},nextState:w}})}}if(u==="warlock"){let S=e.state;const{value:x,nextState:_}=_n(S);S=_;let E=e.enemy.position;if(l<=2||x<.3){const{value:R,nextState:O}=_n(S);S=O;const{value:I,nextState:D}=_n(S);S=D;const j=Math.floor(R*6),U=3+Math.floor(I*3);let q=e.enemy.position;for(let ee=0;ee<U;ee++)q=Kt(q,Mt(j));!Ie.isWithinBounds(e.state,q)||!we.isWalkable(e.state,q)||e.state.occupiedCurrentTurn?.some(ee=>J(ee,q))||e.state.enemies.some(ee=>ee.id!==e.enemy.id&&J(ee.position,q))||J(q,e.playerPos)||(E=q)}const w=!J(E,e.enemy.position),M=fe(E,e.playerPos),k=!w&&M>=2&&M<=4;a({id:"warlock-policy-like",source:"synthetic",reasoningCode:"SYN_WARLOCK_POLICY",preScore:0,planned:{entity:{...e.enemy,position:E,intent:w?"Repositioning":k?"Casting":"Preparing",intentPosition:k?{...e.playerPos}:void 0},nextState:S,message:w?`${e.enemy.subtype} teleports to (${E.q}, ${E.r})`:void 0}})}const y=u==="raider"&&_s(e.enemy,"DASH")&&vg(e.enemy.position,e.playerPos)&&l>=2&&l<=4;if(y&&a({id:"raider-dash",source:"synthetic",reasoningCode:"SYN_RAIDER_DASH_WINDOW",preScore:0,planned:{entity:{...e.enemy,intent:"DASH",intentPosition:{...e.playerPos}},nextState:e.state}}),u==="raider"&&!y){const{position:S,state:x}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),_=!J(S,e.enemy.position),E=fe(S,e.playerPos);a({id:"raider-move",source:"synthetic",reasoningCode:"SYN_RAIDER_MOVE",preScore:0,planned:{entity:{...e.enemy,position:S,intent:_?"Moving":E===1?"BASIC_ATTACK":"Waiting",intentPosition:_||E>1?void 0:{...e.playerPos}},nextState:x,message:_?`${e.enemy.subtype} moves to (${S.q}, ${S.r})`:void 0}})}const b=u==="pouncer"&&_s(e.enemy,"GRAPPLE_HOOK")&&vg(e.enemy.position,e.playerPos)&&l>=2&&l<=4;if(b&&a({id:"pouncer-grapple",source:"synthetic",reasoningCode:"SYN_POUNCER_HOOK_WINDOW",preScore:0,planned:{entity:{...e.enemy,intent:"GRAPPLE_HOOK",intentPosition:{...e.playerPos}},nextState:e.state}}),u==="pouncer"&&!b){const{position:S,state:x}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),_=!J(S,e.enemy.position);a({id:"pouncer-move",source:"synthetic",reasoningCode:"SYN_POUNCER_MOVE",preScore:0,planned:{entity:{...e.enemy,position:S,intent:_?"Moving":"Waiting",intentPosition:void 0},nextState:x,message:_?`${e.enemy.subtype} moves to (${S.q}, ${S.r})`:void 0}})}if(u==="archer"){const S=_s(e.enemy,"ARCHER_SHOT")?"ARCHER_SHOT":_s(e.enemy,"SPEAR_THROW")?"SPEAR_THROW":void 0;let x=!1;if(S){const E=st.get(S);x=l>1&&!!E?.getValidTargets&&E.getValidTargets(e.state,e.enemy.position).some(w=>J(w,e.playerPos)),x&&a({id:`archer-ranged-${S}`,source:"synthetic",reasoningCode:"SYN_ARCHER_RANGED_WINDOW",preScore:0,planned:{entity:{...e.enemy,intent:S,intentPosition:{...e.playerPos}},nextState:e.state}})}const _=l===1&&_s(e.enemy,"BASIC_ATTACK");if(l===1&&_s(e.enemy,"BASIC_ATTACK")&&a({id:"archer-melee-fallback",source:"synthetic",reasoningCode:"SYN_ARCHER_MELEE_FALLBACK",preScore:0,planned:{entity:{...e.enemy,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}}),!x&&!_){const{position:E,state:w}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),M=!J(E,e.enemy.position);a({id:"archer-move",source:"synthetic",reasoningCode:"SYN_ARCHER_MOVE",preScore:0,planned:{entity:{...e.enemy,position:E,intent:M?"Moving":"Idle",intentPosition:void 0},nextState:w,message:M?`${e.enemy.subtype} moves to (${E.q}, ${E.r})`:void 0}})}}if(u==="bomber"&&_s(e.enemy,"BOMB_TOSS")){const S=e.enemy.actionCooldown??0,x=l>=2&&l<=3;if(S===0&&x){const M=Ie.getNeighbors(e.playerPos).filter(k=>{const R=!we.isWalkable(e.state,k),O=e.state.enemies.some(I=>J(I.position,k));return Ie.isWithinBounds(e.state,k)&&!R&&!O&&!J(k,e.playerPos)});if(M.length>0){const{value:k,nextState:R}=_n(e.state),O=Math.floor(k*M.length)%M.length,I=M[O];a({id:"bomber-bomb-window",source:"synthetic",reasoningCode:"SYN_BOMBER_BOMB_WINDOW",preScore:0,planned:{entity:{...e.enemy,intent:"Bombing",intentPosition:I,actionCooldown:2},nextState:R}})}}const{position:_,state:E}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn,2.5),w=!J(_,e.enemy.position);a({id:"bomber-reposition",source:"synthetic",reasoningCode:"SYN_BOMBER_REPOSITION",preScore:0,planned:{entity:{...e.enemy,position:_,intent:w?"Moving":"Waiting",intentPosition:void 0,actionCooldown:Math.max(0,S-1)},nextState:E,message:w?`${e.enemy.subtype} repositioning to (${_.q}, ${_.r})`:void 0}})}const v={},T=e.enemy.subtype?v[e.enemy.subtype]:void 0;for(const S of e.enemy.activeSkills||[]){if(S.id==="AUTO_ATTACK"||S.id==="BASIC_MOVE"||S.id==="BASIC_ATTACK"||!T?.has(String(S.id)))continue;const x=st.get(S.id);x&&(x.getValidTargets&&!x.getValidTargets(e.state,e.enemy.position).some(_=>J(_,e.playerPos))||a({id:`skill-${S.id}`,source:"synthetic",reasoningCode:`SYN_SKILL_${S.id}`,preScore:1,planned:{entity:{...e.enemy,intent:String(S.id),intentPosition:{...e.playerPos}},nextState:e.state}}))}return s},ub=(e,t,s)=>{if(!s)return;const o=e.player.position.q===s.q&&e.player.position.r===s.r?e.player:e.enemies.find(a=>a.position.q===s.q&&a.position.r===s.r);if(o&&o.factionId!==t.factionId)return o.id},mM=(e,t,s,o)=>{const a=t.intentPosition;return s==="Moving"||s==="Advancing"||s==="Repositioning"||s==="Lumbering"||s==="Following"?{type:"MOVE",skillId:"BASIC_MOVE",targetHex:t.position}:s==="BASIC_ATTACK"?{type:"ATTACK",skillId:"BASIC_ATTACK",targetHex:a,primaryTargetId:ub(o,e,a)}:s==="SPEAR_THROW"?{type:"USE_SKILL",skillId:"SPEAR_THROW",targetHex:a}:s==="ARCHER_SHOT"?{type:"USE_SKILL",skillId:"ARCHER_SHOT",targetHex:a}:s==="DASH"?{type:"USE_SKILL",skillId:"DASH",targetHex:a}:s==="GRAPPLE_HOOK"?{type:"USE_SKILL",skillId:"GRAPPLE_HOOK",targetHex:a}:s==="Bombing"?{type:"USE_SKILL",skillId:"BOMB_TOSS",targetHex:a}:s==="SENTINEL_BLAST"?{type:"USE_SKILL",skillId:"SENTINEL_BLAST",targetHex:a}:s==="SENTINEL_TELEGRAPH"?{type:"USE_SKILL",skillId:"SENTINEL_TELEGRAPH",targetHex:a}:{type:"WAIT",skillId:"WAIT_SKILL"}},pM=(e,t,s)=>{const o=String(s.entity.intent||"Waiting"),a=mM(e,s.entity,o,t),l=t.rngCounter||0,u=s.nextState.rngCounter||0,f={action:a,reasoningCode:o.toUpperCase().replace(/\s+/g,"_"),expectedValue:0,nextState:s.nextState,rngConsumption:Math.max(0,u-l)};return{plannedEntity:s.entity,nextState:s.nextState,message:s.message,decision:f}},hM=(e,t,s,o=10)=>{const a=e.action;let l=a.skillId||"WAIT_SKILL",u=a.type;u==="WAIT"&&(l="WAIT_SKILL"),u==="MOVE"&&(l="BASIC_MOVE"),u==="ATTACK"&&(l="BASIC_ATTACK");const f=a.targetHex;let p=a.primaryTargetId;return!p&&f&&(u==="ATTACK"||u==="USE_SKILL")&&(p=ub(s,t,f)),u==="MOVE"&&f&&J(f,t.position)&&(u="WAIT",l="WAIT_SKILL"),{type:u,actorId:t.id,skillId:l,primaryTargetId:p,targetHex:f,priority:o,metadata:{expectedValue:e.expectedValue||0,reasoningCode:e.reasoningCode||"AI_DECISION_COMPAT",isGhost:!1,rngConsumption:e.rngConsumption||0}}},yM=(e,t,s)=>{const o=hM(e,t,s);if(o.skillId==="ARCHER_SHOT"&&!t.activeSkills?.some(l=>l.id==="ARCHER_SHOT")&&t.activeSkills?.some(l=>l.id==="SPEAR_THROW")&&(o.skillId="SPEAR_THROW"),!(o.skillId==="WAIT_SKILL"||t.activeSkills?.some(l=>l.id===o.skillId)))return o.type="WAIT",o.skillId="WAIT_SKILL",o.targetHex=void 0,o.primaryTargetId=void 0,o;if(o.skillId!=="WAIT_SKILL"&&o.targetHex){const l=st.get(o.skillId);l?.getValidTargets&&(l.getValidTargets(s,t.position).some(p=>J(p,o.targetHex))||(o.type="WAIT",o.skillId="WAIT_SKILL",o.targetHex=void 0,o.primaryTargetId=void 0))}return o};var gM={};const bM=(e,t)=>{const s=e.enemy.subtype||"default",o=s==="archer"||s==="warlock"||s==="bomber",a=!o,l=(M,k,R)=>{if(!Vl())return 0;const O=gM?.[M];if(!O)return 0;const I=Number(O);return Number.isFinite(I)?Math.max(k,Math.min(R,I)):0},u=s==="bomber"?l("HOP_ENEMY_AI_BOMBER_BOMB_WINDOW_BONUS",-50,50):0,f=s==="bomber"?l("HOP_ENEMY_AI_BOMBER_REPOSITION_BONUS",-50,50):0,p={candidate_pre_score:1,is_wait_action:-8,is_move_action:a?1:.6,is_attack_action:a?5:2,is_skill_action:o?3:1.5,moved:.5,dist_delta_toward_player:a?1:-.2,preferred_range_match:2,has_target_hex:.4,target_adjacent_to_player:s==="bomber"?2:.2,target_is_player_tile:s==="bomber"?-4:0,uses_signature_skill:1.5,raider_dash_window_match:s==="raider"?25:0,pouncer_hook_window_match:s==="pouncer"?25:0,archer_ranged_window_match:s==="archer"?16:0,archer_melee_window_match:s==="archer"?16:0,bomber_bomb_window_match:s==="bomber"?18+u:0,bomber_bomb_target_valid_shape:s==="bomber"?12:0,bomber_reposition_candidate:s==="bomber"?f:0,sentinel_phase_telegraph_match:s==="sentinel"?40:0,sentinel_phase_execute_match:s==="sentinel"?45:0,sentinel_phase_mismatch:s==="sentinel"?-60:0,cooldown_delta_positive:o?.4:.2,rng_consumption:0,message_present:.1,dist_to_player:0,adjacent_to_player:0,hostile_hidden:0,enemy_hp:0,enemy_action_cooldown:0,dist_before:0,dist_after:0};if(!Vl())return p;const m=xf();if(m<=0)return p;const y=rb(e),b=.45*m,v=Math.max(0,Number(e.enemy.hp||0))/Math.max(1,Number(e.enemy.maxHp||1)),T=Math.max(0,1-v),S=s==="bomber",x=S?0:.4,_=S?1.35:1.1,E=S?1.5:6,w=S?.15:1;return{...p,is_wait_action:p.is_wait_action+(y.defense*1.4*b+y.defense*T*E*b),is_move_action:p.is_move_action+(y.positioning*x*b+y.defense*T*w*b),is_attack_action:p.is_attack_action+y.offense*.85*b,is_skill_action:p.is_skill_action+(y.control*_*b+y.offense*.2*b),dist_delta_toward_player:p.dist_delta_toward_player+(y.offense-y.defense)*.2*b,preferred_range_match:p.preferred_range_match+y.positioning*.2*b}},db=()=>{if(!Vl())return 1;const e=xf();return e<=1?1:1+(e-1)*3},SM=e=>{const t=e.enemy.subtype||"default",s=t==="sentinel"||t==="warlock"||t==="raider"||t==="pouncer",o=db(),a=t==="bomber"?1+(o-1)*.15:o;return{intent_is_offense:0,intent_is_positioning:0,intent_is_control:0,intent_is_defense:0,intent_desire_offense:0,intent_desire_positioning:0,intent_desire_control:0,intent_desire_defense:0,intent_selected_desire:.25*a,intent_dominant_match:(s?.9:.7)*a,intent_preferred_range_gap:0,intent_player_hidden:0}},vM=(e,t,s)=>({total:s,features:{...e.features,...t.features},weights:{...e.weights,...t.weights},contributions:{...e.contributions,...t.contributions}}),AM=(e,t)=>t===1?e:{total:e.total*t,features:{...e.features},weights:Object.fromEntries(Object.entries(e.weights).map(([s,o])=>[s,Number(o)*t])),contributions:Object.fromEntries(Object.entries(e.contributions).map(([s,o])=>[s,Number(o)*t]))},Ag=(e,t)=>!e&&!t?!0:!e||!t?!1:J(e,t),xM=(e,t)=>{if(JSON.stringify(e.plannedEntity)!==JSON.stringify(t.plannedEntity))return"plannedEntity";if(!Ag(e.plannedEntity.position,t.plannedEntity.position))return"position";if(String(e.plannedEntity.intent||"")!==String(t.plannedEntity.intent||""))return"intent";if(!Ag(e.plannedEntity.intentPosition,t.plannedEntity.intentPosition))return"intentPosition";if((e.plannedEntity.actionCooldown??void 0)!==(t.plannedEntity.actionCooldown??void 0))return"actionCooldown";if((e.plannedEntity.facing??void 0)!==(t.plannedEntity.facing??void 0))return"facing";if((e.plannedEntity.isVisible??void 0)!==(t.plannedEntity.isVisible??void 0))return"isVisible";if((e.nextState.rngCounter??void 0)!==(t.nextState.rngCounter??void 0))return"rngCounter";if(String(e.message||"")!==String(t.message||""))return"message"},TM=(e,t={})=>{const s=G_(e.enemy.subtype),o={includePolicyExact:t.includePolicyExact},a=fM(e,o),l=bM(e),u=SM(e),f=db(),p=a.map((m,y)=>{const b=pM(e.enemy,e.state,m.planned),v=F_(e,m,b.decision,s),T=W_(e,m,b.decision,s),S=nf(v,l),x=nf(T,u),_=AM(x,f),E=S.total+_.total+Number(m.preScore||0);return{index:y,candidate:m,result:b,tacticalBreakdown:S,intentBreakdown:_,breakdown:vM(S,_,E),total:E}});return p.sort((m,y)=>y.total!==m.total?y.total-m.total:(y.candidate.preScore||0)!==(m.candidate.preScore||0)?Number(y.candidate.preScore||0)-Number(m.candidate.preScore||0):m.index-y.index),{scored:p,weights:l,intentWeights:u}},sf=e=>({...e.result,decision:{...e.result.decision,reasoningCode:e.candidate.reasoningCode,expectedValue:e.total,breakdown:e.breakdown}}),EM=(e,t)=>{if(e.candidate.source!=="policy_exact")return e;const s=sf(e);for(const o of t){if(o.candidate.source==="policy_exact")continue;const a=sf(o);if(xM(a,s)===void 0)return o}return e},_M=e=>{const t=nf({},{});return{plannedEntity:{...e.enemy,intent:"Waiting",intentPosition:void 0},nextState:e.state,message:void 0,decision:{action:{type:"WAIT",skillId:"WAIT_SKILL"},reasoningCode:"NO_CANDIDATES_WAIT",expectedValue:Number.NEGATIVE_INFINITY,breakdown:t,rngConsumption:0}}},Bd=(e,t={})=>{const s=TM(e,t);if(s.scored.length===0)return{selected:_M(e),scoredResult:s,selectedCandidate:void 0};const o=s.scored[0],a=EM(o,s.scored);return{selected:sf(a),scoredResult:s,selectedCandidate:a}},xg=e=>({selectedSource:e.selectedCandidate?.candidate.source,selectedCandidateId:e.selectedCandidate?.candidate.id,position:e.selected.plannedEntity.position,intent:e.selected.plannedEntity.intent,intentPosition:e.selected.plannedEntity.intentPosition,actionCooldown:e.selected.plannedEntity.actionCooldown,facing:e.selected.plannedEntity.facing,isVisible:e.selected.plannedEntity.isVisible,nextRngCounter:e.selected.nextState.rngCounter,message:e.selected.message}),MM=e=>{const t=Bd(e),s=globalThis.__HOP_ENEMY_AI_TURN_TRACE_HOOK__,o=globalThis.__HOP_ENEMY_AI_RUNTIME_DECISION_CONTEXT__;if(s&&o&&o.actorId===e.enemy.id)try{const a=Bd(e,{includePolicyExact:!0}),l=Bd(e,{includePolicyExact:!1});s({runId:globalThis.__HOP_ENEMY_AI_TRACE_RUN_ID__,floor:o.floor??e.state.floor,turnNumber:o.turnNumber??e.state.turnNumber,rngCounter:o.rngCounter??e.state.rngCounter,enemyId:e.enemy.id,enemySubtype:e.enemy.subtype,enemyPosition:e.enemy.position,playerPosition:e.playerPos,withPolicyExact:xg(a),syntheticOnly:xg(l)})}catch{}return t.selected},wM=e=>{const t=MM(e);return yM(t.decision,e.enemy,e.state)},CM=(e,t,s)=>wM({enemy:e,playerPos:t,state:s}),Ca={weightsByIntent:{offense:{survival:2.1,lethality:6.5,position:2.4,objective:.5,status:2.5,tempo:1.6,resource:1},defense:{survival:4.8,lethality:3.6,position:3,objective:.8,status:2.2,tempo:1.6,resource:1},positioning:{survival:2.3,lethality:3.8,position:3.1,objective:6,status:1.4,tempo:1.6,resource:1},control:{survival:2.3,lethality:4.2,position:2.8,objective:.6,status:3.4,tempo:1.6,resource:1}},thresholds:{defenseHpRatio:.45,defensePressureHpRatio:.65,defensePressureAdjacentHostiles:2,controlMinHostiles:3}};({...Ca.weightsByIntent,offense:{...Ca.weightsByIntent.offense},control:{...Ca.weightsByIntent.control}},{...Ca.thresholds});({...Ca.weightsByIntent},{...Ca.thresholds});class Tg{getFalconIntent(t,s){const o=s.companionState?.mode||"roost",a=s.companionOf===t.player.id?t.player:t.enemies.find(u=>u.id===s.companionOf),l={expectedValue:0,reasoningCode:`FALCON_${o.toUpperCase()}`,isGhost:!1,rngConsumption:0};if(o==="scout")return{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_SCOUT",targetHex:s.position,priority:10,metadata:l};if(o==="predator"&&typeof s.companionState?.markTarget=="string"){const u=t.enemies.find(p=>p.id===s.companionState.markTarget&&p.hp>0);if(!u)return{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_AUTO_ROOST",targetHex:s.position,priority:9,metadata:{...l,reasoningCode:"FALCON_AUTO_ROOST"}};const f=fe(s.position,u.position);return f<=4?{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_APEX_STRIKE",targetHex:u.position,primaryTargetId:u.id,priority:10,metadata:l}:f<=1?{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_PECK",targetHex:u.position,primaryTargetId:u.id,priority:9,metadata:l}:{type:"MOVE",actorId:s.id,skillId:"BASIC_MOVE",targetHex:this.findStepToward(t,s,u.position),primaryTargetId:u.id,priority:7,metadata:l}}return a?fe(s.position,a.position)<=1?{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_HEAL",targetHex:a.position,primaryTargetId:a.id,priority:10,metadata:l}:{type:"MOVE",actorId:s.id,skillId:"BASIC_MOVE",targetHex:this.findStepToward(t,s,a.position),primaryTargetId:a.id,priority:7,metadata:l}:{type:"WAIT",actorId:s.id,skillId:"WAIT_SKILL",priority:1,metadata:{...l,reasoningCode:"FALCON_WAIT"}}}findStepToward(t,s,o){const a=Ue(s.position).filter(l=>Ie.isWithinBounds(t,l)).filter(l=>we.isWalkable(t,l)).filter(l=>{const u=ye(t,l);return!u||u.id===s.id});return a.length===0?s.position:a.sort((l,u)=>fe(l,o)-fe(u,o))[0]}getIntent(t,s){if(s.subtype==="falcon")return this.getFalconIntent(t,s);if(s.subtype==="bomb")return{type:"USE_SKILL",actorId:s.id,skillId:"TIME_BOMB",targetHex:s.position,priority:10,metadata:{expectedValue:0,reasoningCode:"BOMB_FUSE_TICK",isGhost:!1,rngConsumption:0}};const o=t.player.position;return CM(s,o,{...t,occupiedCurrentTurn:t.occupiedCurrentTurn})}}class af{inputQueue=[];resolveInput;pushIntent(t){this.inputQueue.push(t),this.resolveInput&&(this.resolveInput(t),this.resolveInput=void 0)}getIntent(t,s){return this.inputQueue.length>0?this.inputQueue.shift():new Promise(o=>{this.resolveInput=o})}}class Tf{static strategies=new Map;static defaultEnemyStrategy=new Tg;static defaultPlayerStrategy=new af;static register(t,s){this.strategies.set(t,s)}static resolve(t){return this.strategies.has(t.id)?this.strategies.get(t.id):t.type==="player"?this.defaultPlayerStrategy:this.defaultEnemyStrategy}static reset(){this.strategies.clear(),this.defaultEnemyStrategy=new Tg,this.defaultPlayerStrategy=new af}}const OM=new Set(["MOVE","THROW_SPEAR","WAIT","USE_SKILL","JUMP","SHIELD_BASH","ATTACK","LEAP"]),Pd=(e,t)=>{const s=Tf.resolve(e.player);s instanceof af&&s.pushIntent(t)},Hd={expectedValue:0,reasoningCode:"PLAYER_INPUT",isGhost:!1},kM=(e,t,s)=>{if(OM.has(t.type)&&!Wo(e))return e;switch(t.type){case"SELECT_UPGRADE":return"payload"in t?P_(e,t.payload):e;case"USE_SKILL":{const{skillId:o,target:a}=t.payload;return Pd(e,{type:"USE_SKILL",actorId:e.player.id,skillId:o,targetHex:a,priority:10,metadata:Hd}),s.processNextTurn(e,!0)}case"MOVE":{if(!("payload"in t))return e;const o=t.payload,a=e.player.activeSkills||[],l=Pn(e.enemies,o),u=["BASIC_ATTACK","BASIC_MOVE","DASH"],f=a.filter(y=>y.slot==="passive"),p=[...f.filter(y=>u.includes(y.id)),...f.filter(y=>!u.includes(y.id))];let m;for(const y of p){const b=st.get(y.id);if(!b?.getValidTargets)continue;if(b.getValidTargets(e,e.player.position).some(T=>J(T,o))){m=y.id;break}}if(!m){const y=a.some(v=>v.id==="BASIC_ATTACK"),b=a.some(v=>v.id==="BASIC_MOVE");if(l&&y)m="BASIC_ATTACK";else if(!l&&b)m="BASIC_MOVE";else return{...e,message:it(e.message,l?"No valid passive attack for target.":"No valid passive movement for target.","CRITICAL","SYSTEM")}}return Pd(e,{type:l?"ATTACK":"MOVE",actorId:e.player.id,skillId:m,targetHex:o,primaryTargetId:l?.id,priority:10,metadata:Hd}),s.processNextTurn(e,!0)}case"WAIT":return Pd(e,{type:"WAIT",actorId:e.player.id,skillId:"WAIT",priority:10,metadata:Hd}),s.processNextTurn(e,!0);case"APPLY_LOADOUT":{if(!("payload"in t))return e;const o=t.payload,a=eb(o);return{...e,player:{...e.player,activeSkills:a.activeSkills,archetype:a.archetype},upgrades:a.upgrades,hasSpear:o.startingSkills.includes("SPEAR_THROW"),hasShield:o.startingSkills.includes("SHIELD_THROW")||e.hasShield,selectedLoadoutId:o.id,message:it(e.message,`${o.name} selected.`,"INFO","SYSTEM")}}case"START_RUN":{const{loadoutId:o,seed:a,mode:l,date:u}=t.payload,f=Yn[o];if(!f)return e;if(l==="daily"){const m=bT(u),y=ST(m),b=s.generateInitialState(1,a||y,void 0,void 0,f);return{...b,ruleset:e.ruleset||b.ruleset,dailyRunDate:m,runObjectives:vT(y),hazardBreaches:0}}const p=s.generateInitialState(1,a,void 0,void 0,f);return{...p,ruleset:e.ruleset||p.ruleset}}case"ADVANCE_TURN":return e.pendingStatus||(e.pendingFrames?.length??0)>0?(s.warnTurnStackInvariant("Ignored ADVANCE_TURN while pendingStatus is active.",{status:e.pendingStatus?.status,pendingFrames:e.pendingFrames?.length??0,turnNumber:e.turnNumber}),e):s.processNextTurn(e,!1);case"RESOLVE_PENDING":return H_(e,{generateInitialState:s.generateInitialState});case"EXIT_TO_HUB":return s.generateHubState();default:return e}},NM=(e,t,s,o)=>{let a=e;const l=[],u=s?e.enemies.filter(p=>p.id===s):e.enemies,f=[...a.enemies];return u.forEach(p=>{const m=a.enemies.find(y=>y.id===p.id);if(m){if(ns(m)){const y=f.findIndex(b=>b.id===p.id);y!==-1&&(f[y]={...f[y],intent:void 0,intentPosition:void 0});return}if(m.intent&&m.intentPosition){let y=!1;const b=st.get(m.intent);let v=m.activeSkills?.find(T=>T.id===m.intent);if(!v&&m.intent==="ARCHER_SHOT"&&(v=m.activeSkills?.find(T=>T.id==="SPEAR_THROW")),b&&v){const S=(b.getValidTargets?b.getValidTargets(a,m.position):[]).some(E=>J(E,a.player.position));let x=m.intentPosition;if(S)x=a.player.position;else{const E=f.findIndex(w=>w.id===p.id);E!==-1&&(f[E]={...f[E],intent:void 0,intentPosition:void 0});return}const _=b.execute(a,m,x,v.activeUpgrades);a=Yt(a,_.effects,{sourceId:m.id,targetId:a.player.id,stepId:o}),l.push(..._.messages),y=!0}else if(m.subtype!=="bomber"){if(J(m.intentPosition,t)){a={...a,player:hi(a.player,1)};const T=`${m.subtype||"enemy"}#${m.id}`;l.push(`${T} hit you! (HP: ${a.player.hp}/${a.player.maxHp})`),y=!0}}if(y){const T=f.findIndex(S=>S.id===p.id);T!==-1&&(f[T]={...f[T],intent:void 0,intentPosition:void 0})}}}}),a={...a,enemies:f},{state:a,messages:l}},fb=(e,t,s)=>ns(s)?{...e,type:"WAIT",skillId:"WAIT_SKILL",priority:0,metadata:{...e.metadata,reasoningCode:"STATUS_STUNNED"}}:e;class mb{static execute(t,s,o){return this.resolveExecution(t,s,o)}static simulate(t,s,o){return this.resolveExecution(t,s,o)}static resolveExecution(t,s,o){const a=[],l=[],u=st.get(t.skillId);if(!u&&t.type!=="WAIT")return{effects:[],messages:[`Failed to execute unknown skill: ${t.skillId}`],consumesTurn:!1};if(t.type==="WAIT")return{effects:[],messages:[],consumesTurn:!0};if(!(t.skillId==="WAIT_SKILL"||s.activeSkills.some(x=>x.id===t.skillId)))return{effects:[],messages:[`Actor ${s.id} does not have skill ${t.skillId} in loadout!`],consumesTurn:!1};const p=s.activeSkills.find(x=>x.id===t.skillId),m=s.factionId==="player"&&vf(o);if(!m&&p&&(p.currentCooldown||0)>0)return{effects:[],messages:[`${t.skillId} is on cooldown (${p.currentCooldown}).`],consumesTurn:s.type!=="player"};let y=t.targetHex,b=t.primaryTargetId;if(!y&&u&&(y=this.findOptimalTargetHex(t,s,o,u.baseVariables.range)),!y)return{effects:[],messages:[`No valid target found for ${t.skillId}`],consumesTurn:!1};if(y&&!b){const x=ye(o,y);x&&(b=x.id)}const v=p?.activeUpgrades||[],T=u.execute(o,s,y,v),S=[...a,...T.effects];if(T.consumesTurn!==!1&&!m){let _=u.baseVariables.cooldown||0;for(const E of v){const w=u.upgrades?.[E];typeof w?.modifyCooldown=="number"&&(_+=w.modifyCooldown)}_=Math.max(0,_),_>0&&S.push({type:"ModifyCooldown",skillId:t.skillId,amount:_+1,setExact:!0})}return{effects:S,messages:[...l,...T.messages],consumesTurn:T.consumesTurn??!0,targetId:b,kills:T.kills||0}}static findOptimalTargetHex(t,s,o,a){if(t.primaryTargetId){const l=o.enemies.find(u=>u.id===t.primaryTargetId)||(o.player.id===t.primaryTargetId?o.player:void 0);if(l&&(t.type==="ATTACK"||t.type==="USE_SKILL"))return l.position}}}const of=(e,t)=>e.q!==t.q?e.q-t.q:e.r!==t.r?e.r-t.r:e.s-t.s,Dl=(e,t)=>e.player.id===t?e.player:e.enemies.find(s=>s.id===t)||e.companions?.find(s=>s.id===t),RM=(e,t)=>{if(t.primaryTargetId)return Dl(e,t.primaryTargetId);if(t.targetHex)return ye(e,t.targetHex)},IM=(e,t,s)=>{const o=new Map,a=RM(e,t),l=u=>{u&&o.set(ce(u),u)};return s.forEach(u=>{u.type==="Damage"?typeof u.target=="string"&&u.target!=="targetActor"&&u.target!=="area"?l(Dl(e,u.target)?.position):u.target==="targetActor"?l(a?.position):u.target==="area"?l(u.source):typeof u.target=="object"&&"q"in u.target&&l(u.target):u.type==="Impact"||u.type==="LavaSink"?l(Dl(e,u.target)?.position):u.type==="Displacement"&&l(u.destination)}),[...o.values()].sort(of)},Eg=e=>{const t=[];e.enemies.filter(a=>a.hp>0&&a.factionId!==e.player.factionId).forEach(a=>{const u=Tf.resolve(a).getIntent(e,a);if(u instanceof Promise)return;const f=fb(u,e,a);let p=f;f.skillId==="SENTINEL_TELEGRAPH"&&(p={...f,skillId:"SENTINEL_BLAST"});const m=mb.simulate(p,a,e),y=IM(e,p,m.effects);y.length!==0&&t.push({actorId:a.id,skillId:f.skillId,targetHex:f.targetHex,dangerTiles:y})}),t.sort((a,l)=>a.actorId!==l.actorId?a.actorId.localeCompare(l.actorId):a.skillId!==l.skillId?a.skillId.localeCompare(l.skillId):!a.targetHex&&!l.targetHex?0:a.targetHex?l.targetHex?of(a.targetHex,l.targetHex):1:-1);const o=new Map;return t.forEach(a=>a.dangerTiles.forEach(l=>o.set(ce(l),l))),{sourceTurn:e.turnNumber,dangerTiles:[...o.values()].sort(of),projections:t}},LM=e=>(s,o=!1)=>{if(s.pendingStatus||(s.pendingFrames?.length??0)>0)return e.warnTurnStackInvariant("Blocked processNextTurn while pendingStatus is active.",{status:s.pendingStatus?.status,pendingFrames:s.pendingFrames?.length??0,turnNumber:s.turnNumber}),s;let a=s;const l=[],u=[];let f=0;const p=100;let m=!1;for(;f<p;){if(f++,a.player.hp<=0&&a.pendingStatus?.status!=="lost"){const F=Fo(a);return e.withPendingFrame({...a,message:it(a.message,"You have fallen...","CRITICAL","COMBAT")},{status:"lost",completedRun:F},"RUN_LOST",{reason:"GLOBAL_DEATH_CHECK"})}a.occupancyMask=Ie.refreshOccupancyMask(a);let b;if((o&&f===1||m)&&a.initiativeQueue){m=!1;const F=a.initiativeQueue;F.entries.length>0&&F.currentIndex>=0&&F.currentIndex<F.entries.length&&(b=F.entries[F.currentIndex].actorId)}else{const F=wE(a);a={...a,initiativeQueue:F.queue},b=F.actorId??void 0}if(!b)break;const v=b==="player"?a.player:a.enemies.find(F=>F.id===b),T=`${a.turnNumber}:${a.initiativeQueue?.round??0}:${b}:${f}`;if(!v||v.hp<=0){a={...a,initiativeQueue:kd(a.initiativeQueue,b)};continue}if(ME(a.initiativeQueue)?.turnStartPosition||(a={...a,initiativeQueue:CE(a,v)}),!o||f>1){const F=e.executeStatusWindow(a,b,"START_OF_TURN",T);if(a=F.state,l.push(...F.messages),b==="player"&&a.upgrades?.includes("RELIC_STEADY_PLATES")){const z=Math.min(2,(a.player.temporaryArmor||0)+1);z!==(a.player.temporaryArmor||0)&&(a={...a,player:{...a.player,temporaryArmor:z}},l.push(it([],"Steady Plates harden your stance.","INFO","COMBAT")[0]))}if(b==="player"){const z=a.player.activeSkills?.find(re=>re.id==="SHIELD_BASH");if(!!z?.activeUpgrades?.includes("PASSIVE_PROTECTION")&&(z?.currentCooldown||0)===0){const re=Math.max(a.player.temporaryArmor||0,1);re!==(a.player.temporaryArmor||0)&&(a={...a,player:{...a.player,temporaryArmor:re}},l.push(it([],"Passive Protection braces your guard.","INFO","COMBAT")[0]))}}const P=NM(a,a.player.position,b,T);a=P.state,l.push(...P.messages)}const x=b==="player"?a.player:a.enemies.find(F=>F.id===b);if(!x||x.hp<=0){a={...a,initiativeQueue:kd(a.initiativeQueue,b),message:Vn(a.message,l,"INFO","SYSTEM")};continue}const _=b==="player"?a.player:a.enemies.find(F=>F.id===b);if(!_||_.hp<=0)continue;let E,w=!1;if(ns(_))w=!0,E={type:"WAIT",actorId:_.id,skillId:"WAIT_SKILL",priority:0,metadata:{expectedValue:0,reasoningCode:"STATUS_STUNNED_AUTOSKIP",isGhost:!1}},b==="player"?l.push("You are stunned and skip your turn."):l.push(`${_.subtype||"Enemy"} is stunned and skips its turn.`);else{const F=Tf.resolve(_),P=b!=="player"?{actorId:_.id,floor:a.floor,turnNumber:a.turnNumber,rngCounter:a.rngCounter}:void 0;P&&(globalThis.__HOP_ENEMY_AI_RUNTIME_DECISION_CONTEXT__=P);let z;try{z=F.getIntent(a,_)}finally{P&&delete globalThis.__HOP_ENEMY_AI_RUNTIME_DECISION_CONTEXT__}if(z instanceof Promise){const Z=Eg(a);return{...a,intentPreview:Z,message:Vn(a.message,l,"INFO","SYSTEM"),dyingEntities:[...a.dyingEntities||[],...u]}}E=z}const M=x.activeSkills.map(F=>F.id).join(", ");e.engineDebug&&(console.log(`[ENGINE] Actor: ${b} | Loadout: [${M}] | Pos: ${JSON.stringify(x.position)}`),console.log(`[ENGINE] Intent: ${E.type} | Skill: ${E.skillId} | TargetHex: ${E.targetHex?JSON.stringify(E.targetHex):"none"} | TargetId: ${E.primaryTargetId||"none"}`)),E.metadata.rngConsumption&&(a={...a,rngCounter:(a.rngCounter||0)+E.metadata.rngConsumption}),E=fb(E,a,_);const{effects:k,messages:R,consumesTurn:O,targetId:I,kills:D}=mb.execute(E,_,a);if(e.engineDebug&&console.log(`[ENGINE] ${b} intends ${E.type} (${E.skillId}) onto ${I||(E.targetHex?JSON.stringify(E.targetHex):"self")}`),e.engineWarn&&k.length===0&&E.type!=="WAIT"){const F=`[ENGINE] WARNING: Intent ${E.type} (${E.skillId}) for actor ${b} produced ZERO effects!`;console.warn(F)}const j=a,U=Yt(a,k,{sourceId:b,targetId:I,stepId:T});if(b==="player"&&(U.kills=(U.kills||0)+(D||0)),O===!1){a={...j,message:Vn(a.message,R,"INFO","COMBAT")},m=!0;continue}if(a=U,l.push(...R),b!=="player"){const F=a.enemies.find(P=>P.id===b);if(F?.subtype==="bomber"){const P=E.skillId==="BOMB_TOSS"?2:Math.max(0,(F.actionCooldown??0)-1);F.actionCooldown!==P&&(a={...a,enemies:a.enemies.map(z=>z.id===b?{...z,actionCooldown:P}:z)})}}const q=b==="player"?a.player:a.enemies.find(F=>F.id===b);if(!q||q.hp<=0){if(b==="player"){const F=Fo(a);return e.withPendingFrame({...a,message:it(Vn(a.message,l,"INFO","SYSTEM"),"You have fallen...","CRITICAL","COMBAT")},{status:"lost",completedRun:F},"RUN_LOST",{reason:"SELF_ACTION_DEATH"})}a={...a,enemies:a.enemies.filter(F=>F.id!==b),initiativeQueue:kd(a.initiativeQueue,b),message:Vn(a.message,l,"INFO","SYSTEM")};continue}const se=e.executeStatusWindow(a,b,"END_OF_TURN",T);a=se.state,l.push(...se.messages),a={...a,enemies:a.enemies.map(F=>F.id===b?qy(tg(F)):F),player:b==="player"?qy(tg(a.player)):a.player,initiativeQueue:OE(a,b)};const ee=b==="player"?a.player:a.enemies.find(F=>F.id===b);if(!(w||E.metadata?.reasoningCode==="STATUS_STUNNED"||E.metadata?.reasoningCode==="STATUS_STUNNED_AUTOSKIP")&&ee&&ee.hp>0){const F=kE(a,b)||ee.previousPosition||ee.position,P=NE(a,b)??void 0,z=e1(a,ee,Ue(F),F,P,T);a=z.state,l.push(...z.messages),b==="player"&&(a.kills=(a.kills||0)+z.kills)}if(b==="player"){const F=e.applyPlayerEndOfTurnRules(a,T,{withPendingFrame:e.withPendingFrame});if(a=F.state,F.haltTurnLoop)return a;l.push(...F.messages)}}const y=Eg(a);return{...a,intentPreview:y,message:Vn(a.message,l,"INFO","SYSTEM"),dyingEntities:[...a.dyingEntities||[],...u]}};var pb={};const hb=typeof process<"u"&&pb?.HOP_ENGINE_DEBUG==="1",yb=typeof process<"u"&&pb?.HOP_ENGINE_WARN==="1",BM=hb||yb,gb=(e,t)=>{if(BM){if(t){console.warn(`[TURN_STACK] ${e}`,t);return}console.warn(`[TURN_STACK] ${e}`)}},Kl=()=>{const e=Is();return{...e,gameStatus:"hub",message:[it([],"Welcome to the Strategic Hub. Select your loadout.","INFO","SYSTEM")[0]],player:{...e.player,activeSkills:[]},hasSpear:!1,hasShield:!1}},Is=(e=1,t,s,o,a)=>{ib();const l=t||String(Date.now()),u=O_(e),f=w_(e,l),p=C_(e,f.spawnPositions||[],l),m=o?{hp:o.hp,maxHp:o.maxHp,speed:o.speed||ky.speed}:{speed:ky.speed},y=o?.upgrades||(a?a.startingUpgrades:[]),b=a?eb(a):{activeSkills:l_(),archetype:"VANGUARD"},v=tb(o?.activeSkills||b.activeSkills),T=o?.archetype||b.archetype,S=f.tiles||new Map,_={turnNumber:1,player:{...Qi({id:"player",type:"player",position:f.playerSpawn,hp:m.hp,maxHp:m.maxHp,speed:m.speed,factionId:"player",activeSkills:v,archetype:T,weightClass:"Standard",components:new Map}),previousPosition:f.playerSpawn},enemies:p.map(E=>({...E,previousPosition:E.position,statusEffects:E.statusEffects||[],temporaryArmor:E.temporaryArmor||0})),gridWidth:Bl,gridHeight:Pl,gameStatus:"playing",message:e===1?[it([],"Welcome to the arena. Survive.","INFO","SYSTEM")[0]]:it(o?.message||[],`Floor ${e} - ${u.charAt(0).toUpperCase()+u.slice(1)}. Be careful.`,"INFO","OBJECTIVE"),hasSpear:!0,stairsPosition:f.stairsPosition,occupancyMask:[0n],shrinePosition:f.shrinePosition,shrineOptions:void 0,hasShield:!0,floor:e,upgrades:y,rooms:f.rooms,theme:u,commandLog:[],undoStack:[],rngSeed:l,initialSeed:s??(e===1?l:void 0),rngCounter:0,actionLog:[],kills:o&&o.kills||0,environmentalKills:o&&o.environmentalKills||0,turnsSpent:o&&o.turnsSpent||0,dailyRunDate:o?.dailyRunDate,runObjectives:o?.runObjectives||[],hazardBreaches:o?.hazardBreaches||0,completedRun:void 0,combatScoreEvents:o?.combatScoreEvents||[],dyingEntities:[],visualEvents:[],timelineEvents:[],intentPreview:void 0,initiativeQueue:void 0,tiles:S};return _.ruleset=bf(_),_.initiativeQueue=Rs(_),_.occupancyMask=Ie.refreshOccupancyMask(_),_},PM=(e,t,s,o)=>{const a=t==="player"?e.player:e.enemies.find(m=>m.id===t);if(!a)return{state:e,messages:[]};const l=[],u=[];a.statusEffects.forEach(m=>{if(m.tickWindow===s&&m.onTick){const y=m.onTick(a,e);y&&l.push(...y)}});let f=Yt(e,l,{sourceId:t,stepId:o});const p=U0(f,t,s,o);return f=p.state,u.push(...p.messages),{state:f,messages:u}},HM=LM({executeStatusWindow:PM,withPendingFrame:I_,applyPlayerEndOfTurnRules:j_,warnTurnStackInvariant:gb,engineDebug:hb,engineWarn:yb}),jM=(e,t)=>{const s=Af(e.player),o=s===e.player?e:{...e,player:s};if(o.gameStatus!=="playing"&&t.type!=="RESET"&&t.type!=="SELECT_UPGRADE"&&t.type!=="LOAD_STATE"&&t.type!=="APPLY_LOADOUT"&&t.type!=="START_RUN"&&t.type!=="EXIT_TO_HUB")return o;const a={...o,isShaking:!1,lastSpearPath:void 0,dyingEntities:[],occupiedCurrentTurn:void 0,visualEvents:[],timelineEvents:[]};switch(t.type){case"LOAD_STATE":return B_(t.payload);case"RESET":{const v=e.player.archetype==="SKIRMISHER"?"SKIRMISHER":"VANGUARD",T=Yn[v];return Is(1,t.payload?.seed||String(Date.now()),void 0,void 0,T)}case"EXIT_TO_HUB":return Kl()}if(o.gameStatus!=="playing"&&t.type!=="SELECT_UPGRADE"&&t.type!=="APPLY_LOADOUT"&&t.type!=="START_RUN")return o;const l=k_(t,o),u=o;let f={...a,initiativeQueue:a.initiativeQueue};const m=((b,v)=>kM(b,v,{processNextTurn:HM,generateInitialState:Is,generateHubState:Kl,warnTurnStackInvariant:gb}))(f,t),y=N_(u,m,e);return l.delta=y,{...m,commandLog:[...m.commandLog||[],l],undoStack:[...m.undoStack||[],y],actionLog:[...m.actionLog||[],t]}},_g={skill:{staticWeight:.5,powerCoeff:1,reachCoeff:1,safetyCoeff:1,tempoCoeff:1,complexityCoeff:1,perSkillScalar:{}},policy:{offenseWeight:1,defenseWeight:1,positioningWeight:1,statusWeight:1,riskPenaltyWeight:1}};({..._g.policy},{..._g.skill});const DM=new Set(["MOVE","THROW_SPEAR","WAIT","USE_SKILL","JUMP","SHIELD_BASH","ATTACK","LEAP","ADVANCE_TURN","SELECT_UPGRADE","RESOLVE_PENDING"]),UM=e=>typeof e=="object"&&e!==null,bb=e=>{if(!Array.isArray(e))return{valid:!1,actions:[],errors:["Replay actions must be an array."]};const t=[],s=[];return e.forEach((o,a)=>{if(!UM(o)||typeof o.type!="string"){s.push(`Action[${a}] is not a valid action object with a "type" field.`);return}if(!DM.has(o.type)){s.push(`Action[${a}] type "${o.type}" is not replayable.`);return}t.push(o)}),{valid:s.length===0,actions:t,errors:s}},Ms=e=>({q:e.q,r:e.r,s:e.s}),$M=e=>{if(e){if(e instanceof Map)return new Map(Array.from(e.entries()).map(([t,s])=>[t,typeof s=="object"&&s!==null?{...s}:s]));if(Array.isArray(e))return new Map(e);if(typeof e=="object")return new Map(Object.entries(e).map(([t,s])=>[t,typeof s=="object"&&s!==null?{...s}:s]))}},bl=e=>({...e,position:Ms(e.position),previousPosition:e.previousPosition?Ms(e.previousPosition):void 0,intentPosition:e.intentPosition?Ms(e.intentPosition):void 0,statusEffects:e.statusEffects.map(t=>({...t})),activeSkills:e.activeSkills.map(t=>({...t,upgrades:[...t.upgrades||[]],activeUpgrades:[...t.activeUpgrades||[]]})),components:$M(e.components),companionState:e.companionState?{...e.companionState,markTarget:typeof e.companionState.markTarget=="object"&&e.companionState.markTarget?Ms(e.companionState.markTarget):e.companionState.markTarget}:void 0}),qM=e=>({...e,player:bl(e.player),enemies:e.enemies.map(bl),companions:e.companions?.map(bl),dyingEntities:e.dyingEntities?.map(bl),message:[...e.message],visualEvents:[...e.visualEvents||[]],simulationEvents:[...e.simulationEvents||[]],stackTrace:e.stackTrace?e.stackTrace.map(t=>({...t})):void 0,timelineEvents:e.timelineEvents?e.timelineEvents.map(t=>({...t})):void 0,occupancyMask:[...e.occupancyMask],tiles:new Map(Array.from(e.tiles.entries()).map(([t,s])=>[t,{...s,position:Ms(s.position),traits:new Set(s.traits),effects:s.effects.map(o=>({...o}))}])),traps:e.traps?.map(t=>({...t,position:Ms(t.position)})),lastSpearPath:e.lastSpearPath?.map(Ms),actionLog:e.actionLog?[...e.actionLog]:void 0}),Mg=(e,t)=>e.player.id===t?e.player:e.enemies.find(s=>s.id===t)||e.companions?.find(s=>s.id===t),zM=(e,t)=>{if(t)return ye(e,t)?.id},VM=(e,t)=>{const s=Mg(e,t.actorId);if(!s)return{ok:!1,reason:`Actor ${t.actorId} not found`,effects:[],messages:[],simulationEvents:[],stackTrace:[]};const o=st.get(t.skillId);if(!o)return{ok:!1,reason:`Skill ${t.skillId} not found`,effects:[],messages:[],simulationEvents:[],stackTrace:[]};if(t.target&&o.getValidTargets&&!o.getValidTargets(e,s.position).some(v=>ce(v)===ce(t.target)))return{ok:!1,reason:`Target ${ce(t.target)} is invalid`,effects:[],messages:[],simulationEvents:[],stackTrace:[]};const a=qM(e),l=Mg(a,t.actorId),u=o.execute(a,l,t.target,t.activeUpgrades||[],t.context||{}),f=a.simulationEvents?.length||0,p=a.stackTrace?.length||0,m=zM(a,t.target),y=Yt(a,u.effects,{sourceId:l.id,targetId:m});return{ok:!0,effects:u.effects,messages:u.messages,consumesTurn:u.consumesTurn,predictedState:y,simulationEvents:(y.simulationEvents||[]).slice(f),stackTrace:(y.stackTrace||[]).slice(p)}},YM=e=>({q:e.q,r:e.r,s:e.s}),KM=e=>{const t=[e.player,...e.enemies,...e.companions||[],...e.dyingEntities||[]];return{turn:e.turnNumber||0,stackTick:e.stackTrace?.length||0,actors:t.map(s=>({id:s.id,position:YM(s.position)}))}},FM=(e,t)=>{const s=[],o=new Map(e.actors.map(l=>[l.id,l.position])),a=new Map(t.actors.map(l=>[l.id,l.position]));for(const[l,u]of o.entries()){const f=a.get(l);if(!f){s.push({actorId:l,expected:u,reason:"missing_in_ui"});continue}ce(u)!==ce(f)&&s.push({actorId:l,expected:u,actual:f,reason:"position_mismatch"})}for(const[l,u]of a.entries())o.has(l)||s.push({actorId:l,actual:u,reason:"missing_in_engine"});return{ok:s.length===0,mismatches:s}},Ho={player:{icon:"",shape:"square",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1},vanguard:{icon:"",shape:"square",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1},skirmisher:{icon:"",shape:"square",color:"#3b82f6",borderColor:"#fbbf24",isRanged:!1},firemage:{icon:"",shape:"square",color:"#ef4444",borderColor:"#fbbf24",isRanged:!0},necromancer:{icon:"",shape:"square",color:"#6b21a8",borderColor:"#9333ea",isRanged:!0},hunter:{icon:"",shape:"square",color:"#10b981",borderColor:"#ffffff",isRanged:!0},assassin_player:{icon:"",shape:"square",color:"#1f2937",borderColor:"#ffffff",isRanged:!1},footman:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#ffffff",isRanged:!1},sprinter:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#ffffff",isRanged:!1,size:.9},spear:{icon:"",shape:"circle",color:"#ffffff",borderColor:"#3b82f6",isRanged:!1,size:.8,opacity:.9},shieldBearer:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#fbbf24",isRanged:!1,showFacing:!0},golem:{icon:"",shape:"diamond",color:"#78716c",borderColor:"#ffffff",isRanged:!1,size:1.2},assassin:{icon:"",shape:"diamond",color:"#6b21a8",borderColor:"#ffffff",isRanged:!1},archer:{icon:"",shape:"triangle",color:"#ef4444",borderColor:"#ffffff",isRanged:!0},bomber:{icon:"",shape:"circle",color:"#ef4444",borderColor:"#ffffff",isRanged:!0},warlock:{icon:"",shape:"triangle",color:"#9333ea",borderColor:"#ffffff",isRanged:!0},bomb:{icon:"",shape:"circle",color:"#1f2937",borderColor:"#000000",isRanged:!1,showTimer:!0},falcon:{icon:"",shape:"circle",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1,size:.8},skeleton:{icon:"",shape:"circle",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1,size:.8},sentinel:{icon:"",shape:"diamond",color:"#dc2626",borderColor:"#fbbf24",isRanged:!0,size:1.5}};function Xo(e,t,s,o){if(e&&Ho[e])return Ho[e];if(t==="player"&&o){const a=o==="ASSASSIN"?"assassin_player":o.toLowerCase();if(Ho[a])return Ho[a]}return t==="player"?Ho.player:s==="ranged"?{icon:"",shape:"triangle",color:"#ef4444",borderColor:"#ffffff",isRanged:!0}:s==="boss"?{icon:"",shape:"diamond",color:"#dc2626",borderColor:"#fbbf24",isRanged:!1,size:1.5}:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#ffffff",isRanged:!1}}function WM(e){return e.isFlying===!0}const XM=["catacombs","inferno","throne","frozen","void"],Fl=["off","repeat","cover"],GM=["normal","multiply","overlay","soft-light","screen","color-dodge"],wg=["off","multiply","overlay","soft-light","screen","color-dodge","normal"],JM=["#8b6f4a","#8f4a2e","#5b6d41","#536e8e","#5f5977","#b79a73","#d15a3a","#3e4f3a"],QM=["native","additive","custom"],ZM=({settings:e,setSettings:t})=>g.jsxs("section",{className:"space-y-3",children:[g.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/75",children:"Preview"}),g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Theme"}),g.jsx("select",{value:e.theme,onChange:s=>t(o=>o&&{...o,theme:s.target.value}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:XM.map(s=>g.jsx("option",{value:s,children:s},s))}),g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Seed"}),g.jsx("input",{value:e.seed,onChange:s=>t(o=>o&&{...o,seed:s.target.value}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"}),g.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/80",children:[g.jsx("input",{type:"checkbox",checked:e.injectHazards,onChange:s=>t(o=>o&&{...o,injectHazards:s.target.checked})}),"Inject synthetic lava/fire patches for mask testing"]})]}),Wl=64,Xl=192,Xi=64,Gi=512,xe=(e,t,s)=>Math.min(s,Math.max(t,e)),qe=(e,t)=>{const s=Number(e);return Number.isFinite(s)?s:t},Na=(e,t="#8b6f4a")=>{const s=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(s))return s.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(s)){const[l,u,f]=s.slice(1).split("");return`#${l}${l}${u}${u}${f}${f}`.toLowerCase()}return t},ac=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",Go=e=>e==="off"?"off":ac(e),ew=({settings:e,setSettings:t,pathSets:s})=>g.jsxs("section",{className:"space-y-3",children:[g.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-cyan-200",children:"Undercurrent"}),g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Asset Path"}),g.jsx("input",{list:"sandbox-undercurrent-paths",value:e.undercurrent.path,onChange:o=>t(a=>a&&{...a,undercurrent:{...a.undercurrent,path:o.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),g.jsx("datalist",{id:"sandbox-undercurrent-paths",children:s.undercurrent.map(o=>g.jsx("option",{value:o},o))}),g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Mode"}),g.jsx("select",{value:e.undercurrent.mode,onChange:o=>t(a=>a&&{...a,undercurrent:{...a.undercurrent,mode:o.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Fl.map(o=>g.jsx("option",{value:o,children:o},o))}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scale Px"}),g.jsx("input",{type:"number",min:Wl,max:Xl,step:16,value:e.undercurrent.scalePx,onChange:o=>t(a=>a&&{...a,undercurrent:{...a.undercurrent,scalePx:xe(qe(o.target.value,a.undercurrent.scalePx),Wl,Xl)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Opacity"}),g.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.undercurrent.opacity,onChange:o=>t(a=>a&&{...a,undercurrent:{...a.undercurrent,opacity:xe(qe(o.target.value,a.undercurrent.opacity),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),g.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scroll X"}),g.jsx("input",{type:"number",step:5,value:e.undercurrent.scrollX,onChange:o=>t(a=>a&&{...a,undercurrent:{...a.undercurrent,scrollX:qe(o.target.value,a.undercurrent.scrollX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scroll Y"}),g.jsx("input",{type:"number",step:5,value:e.undercurrent.scrollY,onChange:o=>t(a=>a&&{...a,undercurrent:{...a.undercurrent,scrollY:qe(o.target.value,a.undercurrent.scrollY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Duration"}),g.jsx("input",{type:"number",min:1e3,step:500,value:e.undercurrent.scrollDurationMs,onChange:o=>t(a=>a&&{...a,undercurrent:{...a.undercurrent,scrollDurationMs:Math.max(1e3,qe(o.target.value,a.undercurrent.scrollDurationMs))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset X"}),g.jsx("input",{type:"number",step:4,value:e.undercurrent.offsetX,onChange:o=>t(a=>a&&{...a,undercurrent:{...a.undercurrent,offsetX:qe(o.target.value,a.undercurrent.offsetX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset Y"}),g.jsx("input",{type:"number",step:4,value:e.undercurrent.offsetY,onChange:o=>t(a=>a&&{...a,undercurrent:{...a.undercurrent,offsetY:qe(o.target.value,a.undercurrent.offsetY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]})]}),tw=({settings:e,setSettings:t,pathSets:s})=>g.jsxs("section",{className:"space-y-3",children:[g.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-amber-200",children:"Crust"}),g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Asset Path"}),g.jsx("input",{list:"sandbox-crust-paths",value:e.crust.path,onChange:o=>t(a=>a&&{...a,crust:{...a.crust,path:o.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),g.jsx("datalist",{id:"sandbox-crust-paths",children:s.crust.map(o=>g.jsx("option",{value:o},o))}),g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Mode"}),g.jsx("select",{value:e.crust.mode,onChange:o=>t(a=>a&&{...a,crust:{...a.crust,mode:o.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Fl.map(o=>g.jsx("option",{value:o,children:o},o))}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scale Px"}),g.jsx("input",{type:"number",min:64,step:16,value:e.crust.scalePx,onChange:o=>t(a=>a&&{...a,crust:{...a.crust,scalePx:Math.max(64,qe(o.target.value,a.crust.scalePx))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Opacity"}),g.jsx("input",{type:"number",min:1,max:1,step:.01,value:1,onChange:()=>t(o=>o&&{...o,crust:{...o.crust,opacity:1}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Seed Shift Budget"}),g.jsx("input",{type:"number",min:0,step:8,value:e.crust.seedShiftPx,onChange:o=>t(a=>a&&{...a,crust:{...a.crust,seedShiftPx:Math.max(0,qe(o.target.value,a.crust.seedShiftPx))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset X"}),g.jsx("input",{type:"number",step:4,value:e.crust.offsetX,onChange:o=>t(a=>a&&{...a,crust:{...a.crust,offsetX:qe(o.target.value,a.crust.offsetX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset Y"}),g.jsx("input",{type:"number",step:4,value:e.crust.offsetY,onChange:o=>t(a=>a&&{...a,crust:{...a.crust,offsetY:qe(o.target.value,a.crust.offsetY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]})]}),nw=({settings:e,setSettings:t,pathSets:s,mountainTintPickerColor:o})=>g.jsxs("section",{className:"space-y-3",children:[g.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-rose-200",children:"Walls / Mountains"}),g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Mountain Asset"}),g.jsx("input",{list:"sandbox-mountain-paths",value:e.walls.mountainPath,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainPath:a.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs",placeholder:"/assets/biomes/biome.volcano.mountain.01.webp"}),g.jsx("datalist",{id:"sandbox-mountain-paths",children:s.mountain.map(a=>g.jsx("option",{value:a},a))}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scale"}),g.jsx("input",{type:"number",min:.2,max:3,step:.01,value:e.walls.mountainScale,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainScale:xe(qe(a.target.value,l.walls.mountainScale),.2,3)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Anchor X"}),g.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.walls.mountainAnchorX,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainAnchorX:xe(qe(a.target.value,l.walls.mountainAnchorX),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset X"}),g.jsx("input",{type:"number",step:2,value:e.walls.mountainOffsetX,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainOffsetX:qe(a.target.value,l.walls.mountainOffsetX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset Y"}),g.jsx("input",{type:"number",step:2,value:e.walls.mountainOffsetY,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainOffsetY:qe(a.target.value,l.walls.mountainOffsetY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Anchor Y"}),g.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.walls.mountainAnchorY,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainAnchorY:xe(qe(a.target.value,l.walls.mountainAnchorY),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Crust Blend"}),g.jsx("select",{value:e.walls.mountainCrustBlendMode,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainCrustBlendMode:Go(a.target.value)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:wg.map(a=>g.jsx("option",{value:a,children:a},`mountain-blend-${a}`))})]}),g.jsxs("div",{children:[g.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Blend Opacity ",e.walls.mountainCrustBlendOpacity.toFixed(2)]}),g.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.walls.mountainCrustBlendOpacity,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainCrustBlendOpacity:xe(qe(a.target.value,l.walls.mountainCrustBlendOpacity),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),g.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45",children:"Mountain Tint"}),g.jsxs("div",{className:"grid grid-cols-[72px_1fr] gap-3",children:[g.jsx("input",{type:"color",value:o,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainTintColor:a.target.value}}),className:"h-10 w-full rounded-lg border border-white/15 bg-white/5 p-1 cursor-pointer","aria-label":"Mountain Tint Color Picker"}),g.jsx("input",{value:e.walls.mountainTintColor,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainTintColor:a.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",placeholder:"#8b6f4a"})]}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Tint Blend"}),g.jsx("select",{value:e.walls.mountainTintBlendMode,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainTintBlendMode:Go(a.target.value)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:wg.map(a=>g.jsx("option",{value:a,children:a},`mountain-tint-blend-${a}`))})]}),g.jsxs("div",{children:[g.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Tint Opacity ",e.walls.mountainTintOpacity.toFixed(2)]}),g.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.walls.mountainTintOpacity,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mountainTintOpacity:xe(qe(a.target.value,l.walls.mountainTintOpacity),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Wall Layout Mode"}),g.jsx("select",{value:e.walls.mode,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,mode:a.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:QM.map(a=>g.jsx("option",{value:a,children:a},`wall-mode-${a}`))}),g.jsxs("div",{className:"space-y-2",children:[g.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Interior Density ",e.walls.interiorDensity.toFixed(2)]}),g.jsx("input",{type:"range",min:0,max:.45,step:.01,value:e.walls.interiorDensity,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,interiorDensity:xe(qe(a.target.value,l.walls.interiorDensity),0,.45)}}),className:"w-full"})]}),g.jsxs("div",{className:"space-y-2",children:[g.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Cluster Bias ",e.walls.clusterBias.toFixed(2)]}),g.jsx("input",{type:"range",min:0,max:1,step:.01,value:e.walls.clusterBias,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,clusterBias:xe(qe(a.target.value,l.walls.clusterBias),0,1)}}),className:"w-full"})]}),g.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/80",children:[g.jsx("input",{type:"checkbox",checked:e.walls.keepPerimeter,onChange:a=>t(l=>l&&{...l,walls:{...l.walls,keepPerimeter:a.target.checked}})}),"Keep perimeter walls (custom mode)"]})]}),iw=({settings:e,setSettings:t,pathSets:s,tintPickerColor:o})=>g.jsxs("section",{className:"space-y-3",children:[g.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-fuchsia-200",children:"Crust Materials"}),g.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45",children:"Detail A"}),g.jsx("input",{list:"sandbox-detail-paths",value:e.materials.detailA.path,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,detailA:{...l.materials.detailA,path:a.target.value}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),g.jsx("datalist",{id:"sandbox-detail-paths",children:s.detail.map(a=>g.jsx("option",{value:a},a))}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsx("select",{value:e.materials.detailA.mode,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,detailA:{...l.materials.detailA,mode:a.target.value}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Fl.map(a=>g.jsx("option",{value:a,children:a},`detail-a-${a}`))}),g.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.materials.detailA.opacity,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,detailA:{...l.materials.detailA,opacity:xe(qe(a.target.value,l.materials.detailA.opacity),0,1)}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsx("input",{type:"number",min:Xi,max:Gi,step:16,value:e.materials.detailA.scalePx,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,detailA:{...l.materials.detailA,scalePx:xe(qe(a.target.value,l.materials.detailA.scalePx),Xi,Gi)}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"}),g.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45 pt-1",children:"Detail B"}),g.jsx("input",{list:"sandbox-detail-paths",value:e.materials.detailB.path,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,detailB:{...l.materials.detailB,path:a.target.value}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsx("select",{value:e.materials.detailB.mode,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,detailB:{...l.materials.detailB,mode:a.target.value}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Fl.map(a=>g.jsx("option",{value:a,children:a},`detail-b-${a}`))}),g.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.materials.detailB.opacity,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,detailB:{...l.materials.detailB,opacity:xe(qe(a.target.value,l.materials.detailB.opacity),0,1)}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsx("input",{type:"number",min:Xi,max:Gi,step:16,value:e.materials.detailB.scalePx,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,detailB:{...l.materials.detailB,scalePx:xe(qe(a.target.value,l.materials.detailB.scalePx),Xi,Gi)}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"}),g.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45 pt-1",children:"Tint"}),g.jsxs("div",{className:"grid grid-cols-[72px_1fr] gap-3",children:[g.jsx("input",{type:"color",value:o,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,tintColor:a.target.value}}),className:"h-10 w-full rounded-lg border border-white/15 bg-white/5 p-1 cursor-pointer","aria-label":"Tint Color Picker"}),g.jsx("input",{value:e.materials.tintColor,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,tintColor:a.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",placeholder:"#8b6f4a"})]}),g.jsx("div",{className:"grid grid-cols-8 gap-2",children:JM.map(a=>g.jsx("button",{type:"button",onClick:()=>t(l=>l&&{...l,materials:{...l.materials,tintColor:a}}),className:`h-6 rounded border ${Na(e.materials.tintColor)===Na(a)?"border-white":"border-white/20"}`,style:{backgroundColor:a},title:a},`tint-swatch-${a}`))}),g.jsxs("div",{className:"space-y-2",children:[g.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Tint Opacity ",e.materials.tintOpacity.toFixed(2)]}),g.jsx("input",{type:"range",min:0,max:1,step:.01,value:e.materials.tintOpacity,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,tintOpacity:xe(qe(a.target.value,l.materials.tintOpacity),0,1)}}),className:"w-full"})]}),g.jsx("select",{value:e.materials.tintBlend,onChange:a=>t(l=>l&&{...l,materials:{...l.materials,tintBlend:ac(a.target.value)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:GM.map(a=>g.jsx("option",{value:a,children:a},`blend-${a}`))})]}),sw=({settings:e,setSettings:t})=>g.jsxs("section",{className:"space-y-3 pb-8",children:[g.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-emerald-200",children:"Clutter"}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Density"}),g.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.clutter.density,onChange:s=>t(o=>o&&{...o,clutter:{...o.clutter,density:xe(qe(s.target.value,o.clutter.density),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Max / Hex"}),g.jsx("input",{type:"number",min:0,max:5,step:1,value:e.clutter.maxPerHex,onChange:s=>t(o=>o&&{...o,clutter:{...o.clutter,maxPerHex:Math.max(0,Math.floor(qe(s.target.value,o.clutter.maxPerHex)))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),g.jsxs("div",{children:[g.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Bleed Max"}),g.jsx("input",{type:"number",min:1,max:2,step:.01,value:e.clutter.bleedScaleMax,onChange:s=>t(o=>o&&{...o,clutter:{...o.clutter,bleedScaleMax:xe(qe(s.target.value,o.clutter.bleedScaleMax),1,2)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]})]}),aw=({settings:e,setSettings:t,pathSets:s,copyStatus:o,onBack:a,onReset:l,onCopySettings:u,tintPickerColor:f,mountainTintPickerColor:p})=>g.jsxs("aside",{className:"w-[420px] border-r border-white/10 bg-[#02040a] overflow-y-auto",children:[g.jsxs("div",{className:"sticky top-0 z-20 border-b border-white/10 bg-[#02040a]/95 backdrop-blur p-4",children:[g.jsxs("div",{className:"flex items-center justify-between gap-3",children:[g.jsx("button",{type:"button",onClick:a,className:"px-3 py-2 rounded-lg border border-white/20 bg-white/5 hover:bg-white/10 text-[11px] font-black uppercase tracking-[0.18em]",children:"Back"}),g.jsx("button",{type:"button",onClick:l,className:"px-3 py-2 rounded-lg border border-amber-300/40 bg-amber-500/10 hover:bg-amber-500/20 text-[11px] font-black uppercase tracking-[0.18em]",children:"Reset"}),g.jsx("button",{type:"button",onClick:u,className:"px-3 py-2 rounded-lg border border-cyan-300/40 bg-cyan-500/10 hover:bg-cyan-500/20 text-[11px] font-black uppercase tracking-[0.18em]",children:"Copy JSON"})]}),g.jsxs("div",{className:"mt-3 text-[10px] uppercase tracking-[0.22em] text-white/50",children:["Hop / Biomes ",o?`* ${o}`:""]})]}),g.jsxs("div",{className:"p-4 space-y-6",children:[g.jsx(ZM,{settings:e,setSettings:t}),g.jsx(ew,{settings:e,setSettings:t,pathSets:s}),g.jsx(tw,{settings:e,setSettings:t,pathSets:s}),g.jsx(nw,{settings:e,setSettings:t,pathSets:s,mountainTintPickerColor:p}),g.jsx(iw,{settings:e,setSettings:t,pathSets:s,tintPickerColor:f}),g.jsx(sw,{settings:e,setSettings:t})]})]}),ow=({presets:e,activePreset:t,onSelectPreset:s,onResetView:o})=>g.jsx("div",{className:"absolute top-2 right-2 sm:top-3 sm:right-3 z-30 flex items-center gap-1.5 pointer-events-auto",children:g.jsxs("div",{className:"flex items-center gap-1 rounded-xl border border-white/15 bg-black/35 backdrop-blur-sm p-1",children:[e.map(a=>{const l=t===a;return g.jsx("button",{type:"button",onPointerDown:u=>u.stopPropagation(),onClick:()=>s(a),className:`px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest transition-colors ${l?"bg-white text-black":"bg-white/5 text-white/70 hover:bg-white/10"}`,"aria-label":`Set zoom to ${a} tiles wide`,children:a},`zoom-${a}`)}),g.jsx("button",{type:"button",onPointerDown:a=>a.stopPropagation(),onClick:o,className:"px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest bg-white/5 text-white/70 hover:bg-white/10","aria-label":"Reset camera to player",children:"Fit"})]})}),rw=({cells:e,biomeClipId:t,biomeClipPoints:s,maskHexPoints:o,biomeCoverFrame:a,undercurrentHref:l,undercurrentMode:u,undercurrentPatternId:f,undercurrentScalePx:p,undercurrentOffset:m,undercurrentScroll:y,crustHref:b,crustMode:v,crustPatternId:T,crustScalePx:S,crustPatternShift:x,crustDetailAHref:_,crustDetailAMode:E,crustDetailAPatternId:w,crustDetailAScalePx:M,crustDetailAShift:k,crustDetailAScroll:R,crustDetailBHref:O,crustDetailBMode:I,crustDetailBPatternId:D,crustDetailBScalePx:j,crustDetailBShift:U,crustDetailBScroll:q,crustMaskEnabled:se,crustMaskId:ee,crustMaskHoles:oe})=>g.jsxs("defs",{children:[g.jsx("clipPath",{id:t,clipPathUnits:"userSpaceOnUse",children:e.map(F=>{const{x:P,y:z}=Ae(F,G);return g.jsx("polygon",{points:s,transform:`translate(${P},${z})`},`biome-clip-${ce(F)}`)})}),l&&u==="repeat"&&g.jsxs("pattern",{id:f,patternUnits:"userSpaceOnUse",width:p,height:p,patternTransform:`translate(${m.x} ${m.y})`,children:[g.jsx("image",{href:l,x:"0",y:"0",width:p,height:p,preserveAspectRatio:"xMidYMid slice"}),(y.x!==0||y.y!==0)&&g.jsx("animateTransform",{attributeName:"patternTransform",type:"translate",from:`${m.x} ${m.y}`,to:`${m.x+y.x} ${m.y+y.y}`,dur:`${y.durationMs}ms`,repeatCount:"indefinite"})]}),b&&v==="repeat"&&g.jsx("pattern",{id:T,patternUnits:"userSpaceOnUse",width:S,height:S,patternTransform:`translate(${x.x} ${x.y})`,children:g.jsx("image",{href:b,x:"0",y:"0",width:S,height:S,preserveAspectRatio:"xMidYMid slice"})}),_&&E==="repeat"&&g.jsxs("pattern",{id:w,patternUnits:"userSpaceOnUse",width:M,height:M,patternTransform:`translate(${k.x} ${k.y})`,children:[g.jsx("image",{href:_,x:"0",y:"0",width:M,height:M,preserveAspectRatio:"xMidYMid slice"}),(R.x!==0||R.y!==0)&&g.jsx("animateTransform",{attributeName:"patternTransform",type:"translate",from:`${k.x} ${k.y}`,to:`${k.x+R.x} ${k.y+R.y}`,dur:`${R.durationMs}ms`,repeatCount:"indefinite"})]}),O&&I==="repeat"&&g.jsxs("pattern",{id:D,patternUnits:"userSpaceOnUse",width:j,height:j,patternTransform:`translate(${U.x} ${U.y})`,children:[g.jsx("image",{href:O,x:"0",y:"0",width:j,height:j,preserveAspectRatio:"xMidYMid slice"}),(q.x!==0||q.y!==0)&&g.jsx("animateTransform",{attributeName:"patternTransform",type:"translate",from:`${U.x} ${U.y}`,to:`${U.x+q.x} ${U.y+q.y}`,dur:`${q.durationMs}ms`,repeatCount:"indefinite"})]}),se&&g.jsxs("mask",{id:ee,maskUnits:"userSpaceOnUse",maskContentUnits:"userSpaceOnUse",x:a.x,y:a.y,width:a.width,height:a.height,children:[g.jsx("rect",{x:a.x,y:a.y,width:a.width,height:a.height,fill:"white"}),oe.map(F=>g.jsx("polygon",{points:o,transform:`translate(${F.x},${F.y})`,fill:"black",opacity:1},`hole-${F.key}`))]})]}),lw=({biomeClipId:e,biomeFrame:t,biomeCoverFrame:s,undercurrentHref:o,undercurrentMode:a,undercurrentPatternId:l,undercurrentOffset:u,undercurrentOpacity:f,crustHref:p,crustMode:m,crustPatternId:y,crustPatternShift:b,crustOpacity:v,crustDetailAHref:T,crustDetailAMode:S,crustDetailAPatternId:x,crustDetailAShift:_,crustDetailAOpacity:E,crustDetailBHref:w,crustDetailBMode:M,crustDetailBPatternId:k,crustDetailBShift:R,crustDetailBOpacity:O,crustMaskId:I,crustTintActive:D,crustTintColor:j,crustTintOpacity:U,crustTintBlendMode:q})=>g.jsxs(g.Fragment,{children:[g.jsxs("g",{"data-layer":"biome-undercurrent",pointerEvents:"none",clipPath:`url(#${e})`,children:[o&&a==="repeat"&&g.jsx("rect",{x:t.x,y:t.y,width:t.width,height:t.height,fill:`url(#${l})`,opacity:f}),o&&a==="cover"&&g.jsx("image",{href:o,x:s.x+u.x,y:s.y+u.y,width:s.width,height:s.height,preserveAspectRatio:"xMidYMid slice",opacity:f})]}),g.jsxs("g",{"data-layer":"biome-crust",pointerEvents:"none",clipPath:`url(#${e})`,children:[p&&m==="repeat"&&g.jsx("rect",{x:t.x,y:t.y,width:t.width,height:t.height,fill:`url(#${y})`,opacity:v,mask:`url(#${I})`}),p&&m==="cover"&&g.jsx("image",{href:p,x:s.x+b.x,y:s.y+b.y,width:s.width,height:s.height,preserveAspectRatio:"xMidYMid slice",opacity:v,mask:`url(#${I})`}),T&&S==="repeat"&&E>0&&g.jsx("rect",{x:t.x,y:t.y,width:t.width,height:t.height,fill:`url(#${x})`,opacity:E,mask:`url(#${I})`}),T&&S==="cover"&&E>0&&g.jsx("image",{href:T,x:s.x+_.x,y:s.y+_.y,width:s.width,height:s.height,preserveAspectRatio:"xMidYMid slice",opacity:E,mask:`url(#${I})`}),w&&M==="repeat"&&O>0&&g.jsx("rect",{x:t.x,y:t.y,width:t.width,height:t.height,fill:`url(#${k})`,opacity:O,mask:`url(#${I})`}),w&&M==="cover"&&O>0&&g.jsx("image",{href:w,x:s.x+R.x,y:s.y+R.y,width:s.width,height:s.height,preserveAspectRatio:"xMidYMid slice",opacity:O,mask:`url(#${I})`}),D&&j&&g.jsx("rect",{x:t.x,y:t.y,width:t.width,height:t.height,fill:j,opacity:U,mask:`url(#${I})`,style:q!=="normal"?{mixBlendMode:q}:void 0})]})]}),cw=({cells:e,biomeClipId:t,biomeClipPoints:s,maskHexPoints:o,biomeFrame:a,biomeCoverFrame:l,undercurrentHref:u,undercurrentMode:f,undercurrentPatternId:p,undercurrentScalePx:m,undercurrentOffset:y,undercurrentScroll:b,undercurrentOpacity:v,crustHref:T,crustMode:S,crustPatternId:x,crustScalePx:_,crustPatternShift:E,crustOpacity:w,crustDetailAHref:M,crustDetailAMode:k,crustDetailAPatternId:R,crustDetailAScalePx:O,crustDetailAShift:I,crustDetailAScroll:D,crustDetailAOpacity:j,crustDetailBHref:U,crustDetailBMode:q,crustDetailBPatternId:se,crustDetailBScalePx:ee,crustDetailBShift:oe,crustDetailBScroll:F,crustDetailBOpacity:P,crustMaskEnabled:z,crustMaskId:Z,crustMaskHoles:re,crustTintActive:pe,crustTintColor:B,crustTintOpacity:W,crustTintBlendMode:X})=>g.jsxs(g.Fragment,{children:[g.jsx(rw,{cells:e,biomeClipId:t,biomeClipPoints:s,maskHexPoints:o,biomeCoverFrame:l,undercurrentHref:u,undercurrentMode:f,undercurrentPatternId:p,undercurrentScalePx:m,undercurrentOffset:y,undercurrentScroll:b,crustHref:T,crustMode:S,crustPatternId:x,crustScalePx:_,crustPatternShift:E,crustDetailAHref:M,crustDetailAMode:k,crustDetailAPatternId:R,crustDetailAScalePx:O,crustDetailAShift:I,crustDetailAScroll:D,crustDetailBHref:U,crustDetailBMode:q,crustDetailBPatternId:se,crustDetailBScalePx:ee,crustDetailBShift:oe,crustDetailBScroll:F,crustMaskEnabled:z,crustMaskId:Z,crustMaskHoles:re}),g.jsx(lw,{biomeClipId:t,biomeFrame:a,biomeCoverFrame:l,undercurrentHref:u,undercurrentMode:f,undercurrentPatternId:p,undercurrentOffset:y,undercurrentOpacity:v,crustHref:T,crustMode:S,crustPatternId:x,crustPatternShift:E,crustOpacity:w,crustDetailAHref:M,crustDetailAMode:k,crustDetailAPatternId:R,crustDetailAShift:I,crustDetailAOpacity:j,crustDetailBHref:U,crustDetailBMode:q,crustDetailBPatternId:se,crustDetailBShift:oe,crustDetailBOpacity:P,crustMaskId:Z,crustTintActive:pe,crustTintColor:B,crustTintOpacity:W,crustTintBlendMode:X})]}),jd=e=>{const t=[];for(let s=0;s<6;s++){const o=60*s,a=Math.PI/180*o,l=e*Math.cos(a),u=e*Math.sin(a);t.push(`${l},${u}`)}return t.join(" ")},uw=()=>typeof window>"u"?!1:!!window.__HOP_DEBUG_HEX_COORDS,dw=[{cx:-8,cy:-6,r:3,delay:0},{cx:6,cy:2,r:2.5,delay:.3},{cx:-3,cy:8,r:2,delay:.6}],fw=e=>{const t=[[-.6,.42],[-.5,.15],[-.34,-.18],[-.16,-.36],[0,-.62],[.12,-.42],[.3,-.2],[.48,.1],[.6,.4],[.4,.48],[-.48,.48]],s=[[-.48,.48],[-.6,.42],[-.34,-.18],[-.18,-.24],[-.28,.28]],o=[[.6,.4],[.4,.48],[.2,.28],[.3,-.2],[.48,.1]],a=[[-.34,-.18],[-.16,-.36],[0,-.62],[.12,-.42],[.3,-.2]],l=[[-.46,.1],[-.3,-.12],[-.1,-.24],[0,-.4]],u=f=>f.map(([p,m])=>`${(p*e).toFixed(2)},${(m*e).toFixed(2)}`).join(" ");return{body:u(t),leftFace:u(s),rightFace:u(o),ridgeA:u(a),ridgeB:u(l)}},mw=({hex:e,onClick:t,isValidMove:s,isTargeted:o,isStairs:a,isLava:l,isShrine:u,isWall:f,isFire:p,onMouseEnter:m,assetHref:y,interactionOnly:b})=>{const[v,T]=N.useState(!1);N.useEffect(()=>{T(!1)},[y]);const{x:S,y:x}=Ae(e,G),_=uw(),E=jd(G-2),w=fw(G-2),M=`hex-clip-${e.q}-${e.r}-${e.s}`;let k=fl.floor,R="rgba(0,0,0,0.2)",O="default";f?(k=fl.wall,R="#1f2937"):l?(k="#7f1d1d",R="#7f1d1d"):p?(k="#7c2d12",R="#ea580c"):a?(k=fl.portal,R="#000000"):u&&(k=fl.shrine,R="#c2410c"),b&&(k="transparent",R="rgba(255,255,255,0.10)"),s&&(R="rgba(255,255,255,0.78)",O="pointer"),o&&(R="#f97316");const I=!!y&&!b&&!v;return g.jsxs("g",{transform:`translate(${S},${x})`,onClick:()=>t(e),onMouseEnter:()=>m?.(e),style:{cursor:O},className:"hex-tile transition-colors duration-200",children:[f&&I&&g.jsx("polygon",{points:jd(G-2),fill:"#111827",transform:"translate(0, 4)"}),!I&&(f?g.jsxs("g",{"data-wall-fallback":"relief",children:[g.jsx("ellipse",{cx:"0",cy:G*.56,rx:G*.56,ry:G*.18,fill:"rgba(3,7,18,0.55)"}),g.jsx("polygon",{points:E,fill:"#0f172a",transform:"translate(0, 5)",opacity:"0.92"}),g.jsx("polygon",{points:E,fill:"#1f2937",transform:"translate(0, 2)",opacity:"0.98"}),g.jsx("polygon",{points:E,fill:"#273447"}),g.jsx("polygon",{points:w.body,fill:"#4b5563",opacity:"0.96"}),g.jsx("polygon",{points:w.leftFace,fill:"#6b7280",opacity:"0.9"}),g.jsx("polygon",{points:w.rightFace,fill:"#374151",opacity:"0.95"}),g.jsx("polyline",{points:w.ridgeA,fill:"none",stroke:"rgba(229,231,235,0.55)",strokeWidth:"1.1",strokeLinecap:"round",strokeLinejoin:"round"}),g.jsx("polyline",{points:w.ridgeB,fill:"none",stroke:"rgba(17,24,39,0.58)",strokeWidth:"1",strokeLinecap:"round",strokeLinejoin:"round"}),g.jsx("polygon",{points:E,fill:"none",stroke:R,strokeWidth:o||s?"2":"1"})]}):g.jsx("polygon",{points:E,fill:k,stroke:R,strokeWidth:o||s?"2":"1"})),I&&g.jsxs(g.Fragment,{children:[g.jsx("defs",{children:g.jsx("clipPath",{id:M,children:g.jsx("polygon",{points:E})})}),g.jsx("image",{href:y,x:-G,y:-31.176,width:G*2,height:G*1.732,preserveAspectRatio:"xMidYMid slice",clipPath:`url(#${M})`,onError:()=>T(!0)}),g.jsx("polygon",{points:E,fill:"none",stroke:R,strokeWidth:o||s?"2":"1"})]}),l&&!b&&g.jsxs("g",{className:"lava-bubbles",children:[dw.map((D,j)=>g.jsx("circle",{cx:D.cx,cy:D.cy,r:D.r,fill:"#fbbf24",opacity:"0.7",style:{animation:`lavaBubble 2s ease-in-out ${D.delay}s infinite`}},j)),g.jsx("polygon",{points:jd(G-4),fill:"none",stroke:"#f97316",strokeWidth:"1",opacity:"0.35"})]}),p&&!b&&g.jsxs("g",{className:"fire-embers",children:[g.jsx("circle",{cx:"-6",cy:"4",r:"2",fill:"#fbbf24",opacity:"0.75",style:{animation:"lavaBubble 1.6s ease-in-out 0s infinite"}}),g.jsx("circle",{cx:"4",cy:"-6",r:"1.5",fill:"#fcd34d",opacity:"0.75",style:{animation:"lavaBubble 1.4s ease-in-out 0.5s infinite"}})]}),_&&g.jsx("text",{x:"0",y:"0",textAnchor:"middle",fill:"rgba(0,0,0,0.15)",fontSize:"8",dy:".3em",pointerEvents:"none",children:`${e.q},${e.r}`})]})},pw=Ln.memo(mw,(e,t)=>e.hex.q===t.hex.q&&e.hex.r===t.hex.r&&e.hex.s===t.hex.s&&e.onClick===t.onClick&&e.onMouseEnter===t.onMouseEnter&&e.isCenter===t.isCenter&&e.isSelected===t.isSelected&&e.isValidMove===t.isValidMove&&e.isTargeted===t.isTargeted&&e.isStairs===t.isStairs&&e.isLava===t.isLava&&e.isShrine===t.isShrine&&e.isWall===t.isWall&&e.isFire===t.isFire&&e.assetHref===t.assetHref&&e.interactionOnly===t.interactionOnly),hw=({gameState:e,selectedSkillId:t,showMovementRange:s,hoveredTile:o,enginePreviewGhost:a})=>{const l=e.player.position,u=N.useMemo(()=>{const v=new Set;for(const T of e.enemies)T.hp>0&&v.add(ce(T.position));return v},[e.enemies]),f=N.useMemo(()=>{if(!s||t)return[];const v=new Set(e.player.activeSkills.map(_=>_.id)),T=["BASIC_MOVE","DASH"],S=new Set,x=[];return T.forEach(_=>{if(v.has(_)){const E=st.get(_);E?.getValidTargets&&E.getValidTargets(e,l).forEach(M=>{const k=ce(M);S.has(k)||(S.add(k),x.push(M))})}}),x.length===0?[{q:l.q+1,r:l.r,s:l.s-1},{q:l.q+1,r:l.r-1,s:l.s},{q:l.q,r:l.r-1,s:l.s+1},{q:l.q-1,r:l.r,s:l.s+1},{q:l.q-1,r:l.r+1,s:l.s},{q:l.q,r:l.r+1,s:l.s-1}].filter(E=>Zi(E,e.gridWidth,e.gridHeight)):x},[e,s,t,l]),p=N.useMemo(()=>{const v=new Set;for(const T of f)v.add(ce(T));return v},[f]),m=N.useMemo(()=>{if(!t)return[];const v=st.get(t),T=u_(e.player,t)||v?.baseVariables?.range||0,S=v?.getValidTargets?v.getValidTargets(e,l):[],x=new Set(S.map(ce)),_=[];if(t==="DASH"||t==="SPEAR_THROW"||t==="SHIELD_THROW"||t==="GRAPPLE_HOOK")for(let w=0;w<6;w++)for(let M=1;M<=T;M++){const k=Kt(l,ff(w,M));if(!Zi(k,e.gridWidth,e.gridHeight))break;const R=we.isLosBlocking(e,k),O=u.has(ce(k)),j=Ze(l,k).slice(1,-1).some(q=>we.isLosBlocking(e,q)||u.has(ce(q))),U=x.has(ce(k));if(_.push({p:k,isValidTarget:U,isBlocked:j,isWall:R,isEnemy:O}),R||O)break}else S.forEach(w=>{const M=we.isLosBlocking(e,w),k=u.has(ce(w));_.push({p:w,isValidTarget:!0,isBlocked:!1,isWall:M,isEnemy:k})});return _},[e,t,l,u]),y=N.useMemo(()=>{const v=new Map;for(const T of m)v.set(ce(T.p),T);return v},[m]),b=N.useMemo(()=>{if(a)return a;if(s&&o&&!t&&p.has(ce(o)))return{path:Ze(l,o),aoe:[],hasEnemy:!1,target:o,ailmentDeltaLines:[]};if(!t||!o)return null;const v=y.get(ce(o));if(!v||!v.isValidTarget||v.isBlocked)return null;const T=Ze(l,o),S=yA(e,t,l,o),x=v.isEnemy;return{path:T,aoe:S,hasEnemy:x,target:o}},[a,e,t,o,y,p,s,l]);return g.jsx("g",{pointerEvents:"none",children:b&&g.jsxs("g",{children:[(()=>{const v=b.path.map(w=>Ae(w,G)),T=v.map((w,M)=>`${M===0?"M":"L"} ${w.x} ${w.y}`).join(" "),S=v[v.length-1],x=v[v.length-2]||{x:S.x-1,y:S.y},_=Math.atan2(S.y-x.y,S.x-x.x),E=8;return g.jsxs("g",{children:[g.jsx("path",{d:T,stroke:"rgba(255,255,255,0.9)",strokeWidth:"2.25",fill:"none",opacity:"0.85",style:{filter:"drop-shadow(0 0 4px rgba(255,255,255,0.22))"}}),g.jsx("path",{d:`M ${S.x} ${S.y} L ${S.x-E*Math.cos(_-Math.PI/6)} ${S.y-E*Math.sin(_-Math.PI/6)} M ${S.x} ${S.y} L ${S.x-E*Math.cos(_+Math.PI/6)} ${S.y-E*Math.sin(_+Math.PI/6)}`,stroke:"rgba(255,255,255,0.95)",strokeWidth:"2",opacity:"0.9"})]})})(),b.hasEnemy&&(()=>{const{x:v,y:T}=Ae(b.target,G),S=G*.7;return g.jsxs("g",{children:[g.jsx("circle",{cx:v,cy:T,r:S,fill:"none",stroke:"#ef4444",strokeWidth:"2",strokeDasharray:"4 2"}),g.jsx("line",{x1:v-S,y1:T,x2:v+S,y2:T,stroke:"#ef4444",strokeWidth:"1"}),g.jsx("line",{x1:v,y1:T-S,x2:v,y2:T+S,stroke:"#ef4444",strokeWidth:"1"})]})})(),!b.hasEnemy&&(()=>{const{x:v,y:T}=Ae(b.target,G);return g.jsx("circle",{cx:v,cy:T,r:G*.36,fill:"rgba(255,255,255,0.14)",stroke:"rgba(255,255,255,0.65)",strokeWidth:1.5})})(),!!b.ailmentDeltaLines?.length&&(()=>{const{x:v,y:T}=Ae(b.target,G);return g.jsx("g",{transform:`translate(${v},${T-G*.95})`,children:b.ailmentDeltaLines.slice(0,2).map((S,x)=>g.jsx("text",{x:0,y:x*10,textAnchor:"middle",fontSize:9,fill:"#f8fafc",stroke:"rgba(0,0,0,0.6)",strokeWidth:1.6,paintOrder:"stroke",style:{fontWeight:700},children:S},`ailment-delta-${x}`))})})(),Array.from(new Map(b.aoe.map(v=>[ce(v),v])).values()).map(v=>{const{x:T,y:S}=Ae(v,G);return g.jsx("circle",{cx:T,cy:S,r:G*.6,fill:"rgba(239, 68, 68, 0.2)",stroke:"rgba(239, 68, 68, 0.5)",strokeWidth:2,strokeDasharray:"4 2"},`aoe-${v.q}-${v.r}`)})]})})},yw=["white","blue","black","red","green"],Cg={white:{label:"Plains / Mesa",floorAssetId:"tile.catacombs.floor.01",hazardAssetId:"tile.catacombs.lava.01"},blue:{label:"Islands / Coast",floorAssetId:"tile.frozen.floor.01",hazardAssetId:"tile.catacombs.lava.01"},black:{label:"Swamp / Wastes",floorAssetId:"tile.void.floor.01",hazardAssetId:"tile.catacombs.lava.01"},red:{label:"Mountains / Volcanic",floorAssetId:"tile.inferno.floor.01",hazardAssetId:"tile.inferno.lava.01"},green:{label:"Forest / Jungle",floorAssetId:"tile.throne.floor.01",hazardAssetId:"tile.catacombs.lava.01"}},gw={catacombs:"white",frozen:"blue",void:"black",inferno:"red",throne:"green"},bw=e=>{if(typeof e!="string")return;const t=e.toLowerCase();return yw.includes(t)?t:void 0},Sw=()=>{if(!(typeof window>"u"))return bw(window.__HOP_FORCE_BIOME)},vw=e=>{const t=Sw();if(t)return t;const s=String(e||"").toLowerCase();return gw[s]||"white"},Aw=e=>{const t=vw(e.theme);return e.isWall?"tile.catacombs.wall.01":e.isLava?Cg[t].hazardAssetId:e.isFire?"tile.catacombs.fire.01":Cg[t].floorAssetId},Og=e=>{if(e.isStairs)return"prop.core.stairs.01";if(e.isShrine)return"prop.core.shrine.01"},Ji=e=>{if(e.type==="player")switch(e.archetype){case"FIREMAGE":return"unit.player.firemage.04";case"SKIRMISHER":return"unit.player.skirmisher.01";case"HUNTER":return"unit.player.hunter.01";case"NECROMANCER":return"unit.player.necromancer.01";case"ASSASSIN":return"unit.player.assassin.01";default:return"unit.player.vanguard.01"}switch(e.subtype){case"footman":return"unit.enemy.footman.01";case"shield_bearer":return"unit.enemy.shield_bearer.01";case"archer":return"unit.enemy.archer.01";case"warlock":return"unit.enemy.warlock.01";case"bomber":return"unit.enemy.bomber.01";case"bomb":return"unit.enemy.bomb.01";default:return e.enemyType==="boss"?"unit.enemy.boss.01":"unit.enemy.footman.01"}},kg="/Hop",Ng=(e,t)=>`${e.endsWith("/")?e:`${e}/`}${t.replace(/^\/+/,"")}`,xw=e=>/^(?:[a-z]+:)?\/\//i.test(e)||e.startsWith("data:")?e:e.startsWith("/")?e.startsWith("/assets/")?Ng(kg,e.slice(1)):e:Ng(kg,e),Tw={"unit.player.vanguard.01":"/assets/units/unit.player.vanguard.01.svg","unit.player.firemage.04":"/assets/units/unit.player.firemage.02.svg","unit.player.skirmisher.01":"/assets/units/unit.player.skirmisher.01.svg","unit.player.hunter.01":"/assets/units/unit.player.skirmisher.01.svg","unit.player.necromancer.01":"/assets/units/unit.player.vanguard.01.svg","unit.player.assassin.01":"/assets/units/unit.player.skirmisher.01.svg","unit.enemy.footman.01":"/assets/units/unit.enemy.footman.01.svg","unit.enemy.shield_bearer.01":"/assets/units/unit.enemy.shield_bearer.01.svg","unit.enemy.archer.01":"/assets/units/unit.enemy.archer.01.svg","unit.enemy.warlock.01":"/assets/units/unit.enemy.warlock.01.svg","unit.enemy.bomber.01":"/assets/units/unit.enemy.bomber.01.svg","unit.enemy.bomb.01":"/assets/units/unit.enemy.bomb.01.svg","unit.enemy.boss.01":"/assets/units/unit.enemy.boss.01.svg"},ws=e=>{const t=Ji(e),s=Tw[t];return s?xw(s):void 0},Ew=e=>{if(e==="impact")return"fx.core.impact.01";if(e==="vaporize")return"fx.core.vaporize.01";if(e==="lava_ripple")return"fx.core.lava_ripple.01";if(e==="explosion_ring")return"fx.core.explosion_ring.01"},_w=()=>"ui.core.hp_frame.01",Mw=()=>"decal.combat.blood.01",ww=({gameState:e,selectedSkillId:t,showMovementRange:s,hoveredTile:o,enginePreviewGhost:a,cells:l,tileVisualFlags:u,movementTargetSet:f,hasPrimaryMovementSkills:p,fallbackNeighborSet:m,selectedSkillTargetSet:y,stairsKey:b,shrineKey:v,mountainCoveredWallKeys:T,hybridInteractionLayerEnabled:S,assetById:x,onTileClick:_,onTileHover:E,decals:w})=>g.jsxs(g.Fragment,{children:[g.jsx("g",{"data-layer":"interaction-preview",children:g.jsx(hw,{gameState:e,selectedSkillId:t,showMovementRange:s,hoveredTile:o,enginePreviewGhost:a})}),g.jsxs("g",{"data-layer":"interaction-tiles",children:[l.map(M=>{const k=ce(M),R=u.get(k)||{isWall:!1,isLava:!1,isFire:!1},O=R.isWall,I=R.isLava,D=R.isFire,j=s&&!t&&f.has(k)||s&&!t&&!p&&m.has(k)&&!O,q=!!t&&y.has(k)||j,se=k===b,ee=v?k===v:!1,oe=O&&!T.has(k),F=S&&!oe,P=Aw({isWall:oe,isLava:I,isFire:D,theme:e.theme}),z=F?void 0:x.get(P)?.path;return g.jsx(pw,{hex:M,onClick:_,isValidMove:q,isTargeted:!1,isStairs:se,isLava:I,isFire:D,isShrine:ee,isWall:oe,onMouseEnter:E,assetHref:z,interactionOnly:F},k)}),g.jsx("g",{children:w.map(M=>{const{x:k,y:R}=Ae(M.position,G),O=Date.now()-M.createdAt,I=Math.max(.18,.75-O/12e3*.57);return g.jsx("image",{href:M.href,x:k-G*.7,y:R-G*.7,width:G*1.4,height:G*1.4,preserveAspectRatio:"xMidYMid meet",opacity:I},M.id)})})]})]}),Cw=e=>e.replace(/[^a-zA-Z0-9_-]/g,"-"),Ow=(e,t,s)=>g.jsxs("g",{transform:`translate(${t},${s})`,children:[g.jsx("polygon",{points:"0,-18 8,-4 5,12 -5,12 -8,-4",fill:"#f97316",stroke:"#fff",strokeWidth:"1",opacity:"0.9"}),g.jsx("polygon",{points:"-2,-14 2,-14 1,-2 -1,-2",fill:"rgba(255,255,255,0.6)"}),g.jsx("circle",{cx:"0",cy:"0",r:"14",fill:"none",stroke:"#fdba74",strokeWidth:"2",opacity:"0.4",style:{animation:"shrineGlow 2s ease-in-out infinite"}})]},e.id),kw=(e,t,s)=>g.jsxs("g",{transform:`translate(${t},${s})`,children:[g.jsx("rect",{x:"-12",y:"6",width:"8",height:"4",fill:"#1f2937",rx:"1"}),g.jsx("rect",{x:"-6",y:"2",width:"8",height:"4",fill:"#374151",rx:"1"}),g.jsx("rect",{x:"0",y:"-2",width:"8",height:"4",fill:"#4b5563",rx:"1"}),g.jsx("rect",{x:"6",y:"-6",width:"8",height:"4",fill:"#6b7280",rx:"1"}),g.jsx("path",{d:"M 2 -14 L 2 -20 L -4 -20 L 2 -26 L 8 -20 L 2 -20",fill:"#22c55e",stroke:"#16a34a",strokeWidth:"1"})]},e.id),Nw=(e,t,s,o,a,l,u)=>{const f=e.asset;if(!f?.path)return null;const p=Math.min(1,Math.max(0,f.anchor?.x??.5)),m=Math.min(1,Math.max(0,f.anchor?.y??.5)),y=e.kind==="mountain",b=y?l.get(f.id)||u(f):null,v=b?b.anchorX:p,T=b?b.anchorY:m,S=s+(b?b.offsetX:0),x=o+(b?b.offsetY:0),_=Math.max(8,f.width*a*e.renderScale),E=Math.max(8,f.height*a*e.renderScale),w=e.kind==="shrine",M=e.kind==="stairs",k=w||M,R=w?"rgba(251,146,60,0.25)":"rgba(74,222,128,0.22)",O=w?"#fdba74":"#86efac",I=s,D=o-E*T+E*.84,j=Math.max(14,_*.32),U=Math.max(8,E*.14),q=k?w?"drop-shadow(0 4px 6px rgba(0,0,0,0.55)) drop-shadow(0 0 4px rgba(251,146,60,0.45)) saturate(1.08) contrast(1.06)":"drop-shadow(0 4px 6px rgba(0,0,0,0.55)) drop-shadow(0 0 4px rgba(74,222,128,0.42)) saturate(1.08) contrast(1.06)":y?"drop-shadow(0 7px 10px rgba(0,0,0,0.56)) saturate(1.04) contrast(1.08)":"drop-shadow(0 5px 8px rgba(0,0,0,0.48)) saturate(0.98) contrast(1.04)",se=k?.99:y?.96:.9,ee=!!(b&&b.crustBlendMode!=="off"&&b.crustBlendOpacity>0),oe=!!(b&&b.tintBlendMode!=="off"&&b.tintOpacity>0),F=b?.crustBlendMode!=="off"?b?.crustBlendMode:void 0,P=b?.tintBlendMode!=="off"?b?.tintBlendMode:void 0,z=S-_*v,Z=x-E*T,re=Cw(e.id),pe=`mountain-ground-gradient-${t}-${re}`,B=`mountain-ground-mask-${t}-${re}`,W=`mountain-tint-filter-${t}-${re}`;return g.jsxs("g",{children:[k&&g.jsxs(g.Fragment,{children:[g.jsx("ellipse",{cx:I,cy:D,rx:j,ry:U,fill:R,opacity:.95}),g.jsx("ellipse",{cx:I,cy:D,rx:j*1.14,ry:U*1.14,fill:"none",stroke:O,strokeWidth:2,opacity:.72,style:{animation:`shrineGlow ${w?1.8:2.4}s ease-in-out infinite`}})]}),(ee||oe)&&g.jsxs("defs",{children:[ee&&g.jsxs(g.Fragment,{children:[g.jsxs("linearGradient",{id:pe,x1:"0",y1:"0",x2:"0",y2:"1",children:[g.jsx("stop",{offset:"0%",stopColor:"#ffffff",stopOpacity:"0"}),g.jsx("stop",{offset:"42%",stopColor:"#ffffff",stopOpacity:"0.04"}),g.jsx("stop",{offset:"64%",stopColor:"#ffffff",stopOpacity:"0.42"}),g.jsx("stop",{offset:"82%",stopColor:"#ffffff",stopOpacity:"0.82"}),g.jsx("stop",{offset:"100%",stopColor:"#ffffff",stopOpacity:"1"})]}),g.jsx("mask",{id:B,maskUnits:"userSpaceOnUse",maskContentUnits:"userSpaceOnUse",children:g.jsx("rect",{x:z,y:Z,width:_,height:E,fill:`url(#${pe})`})})]}),oe&&g.jsx("filter",{id:W,x:"-10%",y:"-10%",width:"120%",height:"120%",children:g.jsx("feColorMatrix",{type:"matrix",values:b?.tintMatrixValues})})]}),g.jsx("image",{href:f.path,x:z,y:Z,width:_,height:E,preserveAspectRatio:"xMidYMid meet",opacity:se,style:{filter:q}}),ee&&g.jsx("image",{href:f.path,x:z,y:Z,width:_,height:E,preserveAspectRatio:"xMidYMid meet",opacity:Math.min(.9,b?.crustBlendOpacity||0),mask:`url(#${B})`,style:{mixBlendMode:F,filter:"brightness(0.92) saturate(0.76) contrast(1.03)"}}),oe&&g.jsx("image",{href:f.path,x:z,y:Z,width:_,height:E,preserveAspectRatio:"xMidYMid meet",opacity:Math.min(.95,b?.tintOpacity||0),filter:`url(#${W})`,style:{mixBlendMode:P}})]},e.id)},Rw=({sprite:e,floor:t,manifestUnitToBoardScale:s,mountainSettingsByAssetId:o,resolveMountainSettings:a})=>{const{x:l,y:u}=Ae(e.position,G);return e.asset?.path?Nw(e,t,l,u,s,o,a):e.fallback==="shrine"?Ow(e,l,u):kw(e,l,u)},Iw=({sprites:e,floor:t,manifestUnitToBoardScale:s,mountainSettingsByAssetId:o,resolveMountainSettings:a})=>g.jsx("g",{"data-layer":"clutter-obstacles",pointerEvents:"none",children:e.map(l=>Rw({sprite:l,floor:t,manifestUnitToBoardScale:s,mountainSettingsByAssetId:o,resolveMountainSettings:a}))}),Lw={catacombs:.2,inferno:.16,throne:.24,frozen:.45,void:.08},Bw=(e,t)=>{const s=Math.max(e,t),o=Math.min(e,t);return(s+.05)/(o+.05)},Pw=e=>{const t=String(e||"").toLowerCase(),s=Lw[t]??.22;return Bw(s,.86)<4.5?1.22:1.06},Hw=(e,t,s=24,o,a,l=1)=>{const u=Xo(e.subtype,e.type,e.enemyType,e.archetype),{icon:f,shape:p,color:m,borderColor:y,size:b=1}=u,v=s*b,T=e.statusEffects?.find(E=>E.type==="time_bomb"),S=T?Math.max(0,T.duration):e.actionCooldown??0,x=`contrast(${l.toFixed(2)}) brightness(${(l>1?1.12:1.04).toFixed(2)})`,_=t?`drop-shadow(0 3px 4px rgba(0,0,0,0.45)) drop-shadow(0 0 2px rgba(255,255,255,0.5)) saturate(1.08) ${x}`:`drop-shadow(0 3px 4px rgba(0,0,0,0.50)) drop-shadow(0 0 2px rgba(255,255,255,0.35)) saturate(1.0) ${x}`;return g.jsxs("g",{children:[g.jsx("title",{children:t?"Player":`${e.subtype||"Enemy"}`}),o&&g.jsx("image",{href:o,x:-v,y:-v,width:v*2,height:v*2,preserveAspectRatio:"xMidYMid meet",onError:a,style:{filter:_,opacity:t?1:.97}}),!o&&p==="square"&&g.jsx("rect",{x:-v*.8,y:-v*.8,width:v*1.6,height:v*1.6,fill:m,stroke:y,strokeWidth:2}),!o&&p==="diamond"&&g.jsx("path",{d:`M0 ${-v*.8} L${v*.6} 0 L0 ${v*.8} L${-v*.6} 0 Z`,fill:m,stroke:y,strokeWidth:1}),!o&&p==="triangle"&&g.jsx("path",{d:`M0 ${-v*.8} L${v*.7} ${v*.5} L${-v*.7} ${v*.5} Z`,fill:m,stroke:y,strokeWidth:1}),!o&&p==="circle"&&g.jsx("circle",{r:v*.7,fill:m,stroke:y,strokeWidth:1}),e.subtype==="bomb"&&g.jsx("text",{y:v*.2,textAnchor:"middle",fill:"#fff",fontSize:"10",fontWeight:"bold",children:S}),!o&&!t&&e.subtype!=="bomb"&&g.jsx("text",{x:"0",y:"0",textAnchor:"middle",dy:".3em",fontSize:v*.8,opacity:.8,children:f}),!o&&t&&g.jsx("path",{d:`M0 ${-v*.4} L0 ${v*.4} M${-v*.15} ${-v*.2} L0 ${-v*.5} L${v*.15} ${-v*.2}`,stroke:y,strokeWidth:2,fill:"none"})]})},Rg=e=>{if(!e)return"";const t=(e.path||[]).map(s=>`${s.q},${s.r},${s.s}`).join(";");return`${e.actorId}|${e.movementType||""}|${e.destination?.q??""},${e.destination?.r??""},${e.destination?.s??""}|${t}|${e.durationMs??""}|${e.startDelayMs??0}|${e.wasLethal?1:0}`},Ig=(e=[])=>e.map(t=>`${t.id}:${t.duration??""}:${t.stacks??""}`).join("|"),Lg=e=>{const s=e.components?.get("ailments")?.counters||{};return Object.keys(s).sort((o,a)=>o.localeCompare(a)).map(o=>`${o}:${Math.max(0,Math.floor(Number(s[o]||0)))}`).join("|")},jw=(e,t)=>{const s=e.entity,o=t.entity;return e.isSpear===t.isSpear&&e.isDying===t.isDying&&e.waapiControlled===t.waapiControlled&&e.assetHref===t.assetHref&&e.fallbackAssetHref===t.fallbackAssetHref&&e.floorTheme===t.floorTheme&&(e.visualPose?.offsetX??0)===(t.visualPose?.offsetX??0)&&(e.visualPose?.offsetY??0)===(t.visualPose?.offsetY??0)&&(e.visualPose?.scaleX??1)===(t.visualPose?.scaleX??1)&&(e.visualPose?.scaleY??1)===(t.visualPose?.scaleY??1)&&Rg(e.movementTrace)===Rg(t.movementTrace)&&s.id===o.id&&s.hp===o.hp&&s.maxHp===o.maxHp&&s.facing===o.facing&&s.intent===o.intent&&s.isVisible===o.isVisible&&s.position.q===o.position.q&&s.position.r===o.position.r&&s.position.s===o.position.s&&(s.previousPosition?.q??0)===(o.previousPosition?.q??0)&&(s.previousPosition?.r??0)===(o.previousPosition?.r??0)&&(s.previousPosition?.s??0)===(o.previousPosition?.s??0)&&(s.intentPosition?.q??0)===(o.intentPosition?.q??0)&&(s.intentPosition?.r??0)===(o.intentPosition?.r??0)&&(s.intentPosition?.s??0)===(o.intentPosition?.s??0)&&Ig(s.statusEffects)===Ig(o.statusEffects)&&Lg(s)===Lg(o)},Dw=({stunned:e,showFacing:t,facing:s,borderColor:o})=>g.jsxs(g.Fragment,{children:[e&&g.jsxs("g",{transform:`translate(0, -${G*.8})`,className:"stun-icon",children:[g.jsx("text",{fontSize:"14",textAnchor:"middle",children:"*"}),g.jsx("text",{fontSize:"8",textAnchor:"middle",dy:"-3",dx:"6",children:"+"})]}),t&&s!==void 0&&!e&&g.jsx("line",{x1:0,y1:0,x2:Math.cos((s*60-90)*Math.PI/180)*G*.5,y2:Math.sin((s*60-90)*Math.PI/180)*G*.5,stroke:o,strokeWidth:3,strokeLinecap:"round"})]}),Uw=({isPlayer:e,isFlying:t})=>{const s=e?"#22e7ff":"rgba(255,120,120,0.7)",o=e?"rgba(34,231,255,0.20)":"rgba(239,68,68,0.16)",a=e?"rgba(34,231,255,0.36)":"rgba(255,90,90,0.28)",l=e?G*.48:G*.42,u=e?G*.17:G*.145,f=e?G*.32:G*.3;return g.jsxs(g.Fragment,{children:[g.jsxs("g",{transform:`translate(0,${f})`,children:[g.jsx("ellipse",{cx:0,cy:0,rx:l,ry:u,fill:o,stroke:s,strokeWidth:2,opacity:.95,style:{filter:`drop-shadow(0 0 5px ${a})`}}),g.jsx("ellipse",{cx:0,cy:0,rx:l*1.14,ry:u*1.14,fill:"none",stroke:s,strokeWidth:e?1.8:1.6,opacity:e?.62:.54})]}),t&&g.jsx("ellipse",{cx:0,cy:G*.3,rx:G*.4,ry:G*.15,fill:"black",opacity:.2})]})},$w={burn:"#d9480f",wet:"#0ea5e9",poison:"#16a34a",frozen:"#60a5fa",bleed:"#b91c1c"},qw=e=>e.components?.get("ailments")?.counters||{},zw=(e,t=3)=>{const s=qw(e);return Object.entries(s).map(([o,a])=>({ailment:o,count:Math.max(0,Math.floor(Number(a||0)))})).filter(o=>o.count>0).sort((o,a)=>a.count-o.count||o.ailment.localeCompare(a.ailment)).slice(0,Math.max(0,t))},Vw=({entity:e})=>{const t=zw(e,3);if(t.length===0)return null;const o=-(t.length*16/2)+8;return g.jsx("g",{transform:"translate(0,-22)",children:t.map((a,l)=>{const u=o+l*16,f=$w[a.ailment]||"#334155";return g.jsxs("g",{transform:`translate(${u},0)`,children:[g.jsx("rect",{x:-7,y:-7,width:14,height:12,rx:3,fill:f,fillOpacity:.92,stroke:"rgba(0,0,0,0.45)",strokeWidth:1}),g.jsx("text",{x:0,y:2,fontSize:8,textAnchor:"middle",fill:"#f8fafc",style:{fontWeight:700},children:a.count}),g.jsx("title",{children:`${a.ailment.toUpperCase()}: ${a.count}`})]},`${a.ailment}-${l}`)})})},Yw=({entity:e,x:t,y:s,waapiControlled:o,segmentDurationMs:a,segmentEasing:l,isDying:u,poseTransform:f,stretchTransform:p,isFlashing:m,teleportPhase:y,isInvisible:b,visualOpacity:v,isPlayer:T,isFlying:S,unitIconYOffset:x,unitIconScale:_,unitIconSize:E,resolvedAssetHref:w,handleAssetError:M,contrastBoost:k,stunned:R,showFacing:O,borderColor:I})=>g.jsx("g",{style:{pointerEvents:"none"},children:g.jsx("g",{"data-actor-node":e.id,style:{transition:o?"none":`transform ${a}ms ${l}`,transform:`translate(${t}px, ${s}px)`},className:u?"animate-lava-sink":"",children:g.jsx("g",{transform:f,children:g.jsxs("g",{transform:p,className:`${m?"entity-damaged":""} ${!u&&!R?"animate-idle":""} ${y==="out"?"entity-teleport-out":""} ${y==="in"?"entity-teleport-in":""}`,opacity:b?.3:v,style:{filter:b?"blur(1px)":"none"},children:[g.jsx(Uw,{isPlayer:T,isFlying:S}),g.jsx("g",{transform:`translate(0,${x}) scale(${_})`,children:Hw(e,T,E,w,M,k)}),g.jsx(Dw,{stunned:R,showFacing:O,facing:e.facing,borderColor:I}),g.jsx(Vw,{entity:e}),g.jsx("title",{children:`${e.subtype||e.type} - HP ${e.hp}/${e.maxHp}${e.intent?` - ${e.intent}`:""}`})]})})})}),Kw=({x:e,y:t,icon:s})=>g.jsx("g",{style:{pointerEvents:"none"},children:g.jsx("g",{transform:`translate(${e},${t})`,children:g.jsx("text",{x:"0",y:"0",textAnchor:"middle",dy:".3em",fontSize:"20",style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.5))"},children:s})})}),Fw=(e,t,s)=>!!(e&&e.actorId===t&&e.destination&&J(e.destination,s)&&Array.isArray(e.path)&&e.path.length>0),Ww=e=>{const{rawPath:t,movementTraceOrigin:s,hasMatchingTrace:o}=e;return!o||!s||t.length<=1?t:J(t[t.length-1],s)&&!J(t[0],s)?[...t].reverse():t},Xw=({entity:e,movementTrace:t,waapiControlled:s,movementDebugEnabled:o})=>{const[a,l]=N.useState(e.position),[u,f]=N.useState(()=>Ae(e.position,G)),[p,m]=N.useState(e.previousPosition),[y,b]=N.useState(220),[v,T]=N.useState("cubic-bezier(0.22, 1, 0.36, 1)"),[S,x]=N.useState("none"),_=N.useRef(!1),E=N.useRef(e.position),w=N.useRef([]),M=N.useRef(null);return N.useEffect(()=>{const k=()=>{for(const R of w.current)clearTimeout(R);w.current=[],M.current!==null&&(cancelAnimationFrame(M.current),M.current=null)};if(s){k(),_.current=!1;const R=!!(t&&t.actorId===e.id&&t.destination&&J(t.destination,e.position)),O=!J(e.position,E.current);E.current=e.position,O&&!R&&(l(e.position),m(e.previousPosition),f(Ae(e.position,G))),x("none"),b(0),T("linear");return}if(!J(e.position,E.current)){E.current=e.position;const R=Fw(t,e.id,e.position),O=R?t:void 0,I=O?.path,D=O?.movementType,j=O?Math.max(0,O.startDelayMs??0):0;if(o){const se=e.previousPosition?Ze(e.previousPosition,e.position).length:0;console.log("[HOP_MOVE]",{actorId:e.id,movementType:D||"fallback",usedEngineTrace:R,tracePathLength:I?.length||0,tracePath:I||[],startDelayMs:j,fallbackPathLength:se,origin:t?.origin||e.previousPosition,destination:e.position})}if(D==="teleport"&&O?.origin){k(),_.current=!0;const se=O.durationMs??180,ee=Math.max(80,Math.floor(se/2)),oe=()=>{b(0),T("linear"),m(O.origin),l(O.origin),f(Ae(O.origin,G)),x("out");const F=window.setTimeout(()=>{l(e.position),m(e.position),f(Ae(e.position,G)),x("in")},ee),P=window.setTimeout(()=>{x("none"),_.current=!1},ee*2);w.current.push(F,P)};if(j>0){const F=window.setTimeout(oe,j);w.current.push(F)}else oe();return()=>{k(),_.current=!1}}const U=!!(e.previousPosition&&!J(e.position,e.previousPosition));if(!!(I&&I.length>1)||U){const se=I||(e.previousPosition?Ze(e.previousPosition,e.position):[]),ee=Ww({rawPath:se,movementTraceOrigin:O?.origin,hasMatchingTrace:R});if(ee.length>1){k(),_.current=!0;const oe=Math.max(1,ee.length-1),F=O?.durationMs?O.durationMs/oe:0,P=Math.max(90,Math.min(130,F||112)),z=P*oe,Z=ee.map(X=>Ae(X,G)),re=performance.now(),pe=X=>X<.5?4*X*X*X:1-Math.pow(-2*X+2,3)/2;x("none"),b(0),T("linear"),l(ee[0]),m(ee[0]),f(Z[0]);let B=-1;const W=X=>{const ae=Math.max(0,X-re),le=Math.min(oe-1,Math.floor(ae/P)),ue=le*P,be=ae-ue,$e=Math.max(0,Math.min(1,be/P)),Ee=pe($e);le!==B&&(m(ee[le]),l(ee[Math.min(ee.length-1,le+1)]),B=le);const at=Z[le],ot=Z[Math.min(Z.length-1,le+1)];if(f({x:at.x+(ot.x-at.x)*Ee,y:at.y+(ot.y-at.y)*Ee}),ae<z){M.current=requestAnimationFrame(W);return}_.current=!1,l(e.position),m(e.previousPosition),f(Z[Z.length-1]),M.current=null};if(j>0){const X=window.setTimeout(()=>{M.current=requestAnimationFrame(W)},j);w.current.push(X)}else M.current=requestAnimationFrame(W);return()=>{k(),_.current=!1}}}x("none"),b(220),T("cubic-bezier(0.22, 1, 0.36, 1)"),l(e.position),m(e.previousPosition),f(Ae(e.position,G))}},[e.position,e.previousPosition,t,e.id,s,o]),{displayPos:a,displayPixel:u,animationPrevPos:p,segmentDurationMs:y,segmentEasing:v,teleportPhase:S}},Gw=e=>{const{entity:t,assetHref:s,fallbackAssetHref:o}=e,[a,l]=N.useState(s||o),[u,f]=N.useState(!1),[p,m]=N.useState(!1),y=N.useRef(t.hp);N.useEffect(()=>{l(s||o),f(!1)},[s,o,t.id]);const b=()=>{if(!u&&o&&a!==o){l(o),f(!0);return}l(void 0)};return N.useEffect(()=>{if(t.hp<y.current){m(!0);const v=setTimeout(()=>m(!1),150);return()=>clearTimeout(v)}y.current=t.hp},[t.hp]),{resolvedAssetHref:a,handleAssetError:b,isFlashing:p}},Jw=({entity:e,isSpear:t,isDying:s,movementTrace:o,waapiControlled:a=!1,assetHref:l,fallbackAssetHref:u,floorTheme:f,visualPose:p})=>{const m=e.type==="player",y=typeof window<"u"&&!!window.__HOP_DEBUG_MOVEMENT,{displayPos:b,displayPixel:v,animationPrevPos:T,segmentDurationMs:S,segmentEasing:x,teleportPhase:_}=Xw({entity:e,movementTrace:o,waapiControlled:a,movementDebugEnabled:y}),{resolvedAssetHref:E,handleAssetError:w,isFlashing:M}=Gw({entity:e,assetHref:l,fallbackAssetHref:u}),{x:k,y:R}=v||Ae(b,G);let O="";const I=T;if(I&&!J(b,I)){const W=Hn(I,b);if(W!==-1){const X=W*60;O=`rotate(${X}) scale(1.15, 0.85) rotate(${-X})`}}const D=e.isVisible===!1,j=ns(e);if(t){const W=Xo("spear","enemy");return g.jsx(Kw,{x:k,y:R,icon:W.icon})}const U=Xo(e.subtype,e.type,e.enemyType,e.archetype),q=WM(e),se=m?1.34:.92,ee=m?-9:-2,oe=m?24:18,F=Pw(f),P=p?.offsetX??0,z=p?.offsetY??0,Z=p?.scaleX??1,re=p?.scaleY??1,B=Math.abs(P)>.01||Math.abs(z)>.01||Math.abs(Z-1)>.01||Math.abs(re-1)>.01?`translate(${P},${z}) scale(${Z},${re})`:void 0;return g.jsx(Yw,{entity:e,x:k,y:R,waapiControlled:a,segmentDurationMs:S,segmentEasing:x,isDying:s,poseTransform:B,stretchTransform:O,isFlashing:M,teleportPhase:_,isInvisible:D,visualOpacity:U.opacity||1,isPlayer:m,isFlying:q,unitIconYOffset:ee,unitIconScale:se,unitIconSize:oe,resolvedAssetHref:E,handleAssetError:w,contrastBoost:F,stunned:j,showFacing:!!U.showFacing,borderColor:U.borderColor})},Sl=Ln.memo(Jw,jw),Qw=({effect:e,x:t,y:s,fxAssetHref:o,frameAssetHref:a})=>{if(e.type==="melee_lunge"||e.type==="arrow_shot"||e.type==="arcane_bolt"||e.type==="generic_line"){const l=e.payload?.source;if(!l)return null;const u=Ae(l,G),f=t-u.x,p=s-u.y,m=Math.max(1,Math.hypot(f,p)),y=f/m,b=p/m,v=t-y*Math.min(m*.18,14),T=s-b*Math.min(m*.18,14),S=e.type==="arrow_shot"?7:5,x=t-y*S-b*(S*.55),_=s-b*S+y*(S*.55),E=t-y*S+b*(S*.55),w=s-b*S-y*(S*.55);if(e.type==="melee_lunge")return g.jsxs("g",{className:"animate-melee-lunge",children:[g.jsx("line",{x1:u.x,y1:u.y,x2:v,y2:T,stroke:"rgba(255,255,255,0.35)",strokeWidth:5,strokeLinecap:"round"}),g.jsx("line",{x1:v,y1:T,x2:t,y2:s,stroke:"rgba(255,255,255,0.85)",strokeWidth:3,strokeLinecap:"round"})]},e.id);if(e.type==="arrow_shot"||e.type==="generic_line"){const M=e.type==="generic_line"?"rgba(255,255,255,0.85)":"rgba(253,230,138,0.9)",k=e.type==="generic_line"?"rgba(255,255,255,0.9)":"rgba(254,243,199,0.95)";return g.jsxs("g",{className:e.type==="generic_line"?"animate-melee-lunge":"animate-arrow-shot",children:[g.jsx("line",{x1:u.x,y1:u.y,x2:t,y2:s,stroke:M,strokeWidth:e.type==="generic_line"?2:2.5,strokeLinecap:"round",strokeDasharray:e.type==="generic_line"?"6 6":"10 8"}),g.jsx("path",{d:`M ${t} ${s} L ${x} ${_} M ${t} ${s} L ${E} ${w}`,stroke:k,strokeWidth:2,strokeLinecap:"round"})]},e.id)}return g.jsxs("g",{className:"animate-arcane-bolt",children:[g.jsx("line",{x1:u.x,y1:u.y,x2:t,y2:s,stroke:"rgba(34,211,238,0.92)",strokeWidth:4,strokeLinecap:"round",strokeDasharray:"12 10"}),g.jsx("line",{x1:u.x,y1:u.y,x2:t,y2:s,stroke:"rgba(207,250,254,0.85)",strokeWidth:1.8,strokeLinecap:"round"}),g.jsx("circle",{cx:t,cy:s,r:G*.22,fill:"rgba(34,211,238,0.35)"})]},e.id)}if(e.type==="kinetic_wave"||e.type==="generic_ring"){const l=e.type==="kinetic_wave"?"rgba(125,211,252,0.9)":"rgba(255,255,255,0.7)",u=e.type==="kinetic_wave"?"rgba(56,189,248,0.14)":"rgba(255,255,255,0.08)";return g.jsx("g",{className:"animate-explosion-ring",children:g.jsx("circle",{cx:t,cy:s,r:G*(e.type==="kinetic_wave"?1.5:1.1),fill:u,stroke:l,strokeWidth:e.type==="kinetic_wave"?3:2,strokeDasharray:e.type==="kinetic_wave"?"10 6":"6 4"})},e.id)}if(e.type==="wall_crack"){const l=e.payload||{},u=l.source,f=l.target,p=u&&f?Math.atan2(Ae(f,G).y-Ae(u,G).y,Ae(f,G).x-Ae(u,G).x):0,m=G*.32,y=p+Math.PI/2,b=t-Math.cos(p)*m,v=s-Math.sin(p)*m,T=t+Math.cos(p)*m,S=s+Math.sin(p)*m;return g.jsxs("g",{className:"animate-impact",children:[g.jsx("line",{x1:b,y1:v,x2:T,y2:S,stroke:"rgba(255,255,255,0.95)",strokeWidth:2.2,strokeLinecap:"round"}),g.jsx("line",{x1:t-Math.cos(y)*m*.8,y1:s-Math.sin(y)*m*.8,x2:t+Math.cos(y)*m*.8,y2:s+Math.sin(y)*m*.8,stroke:"rgba(147,197,253,0.9)",strokeWidth:1.7,strokeLinecap:"round"}),g.jsx("circle",{cx:t,cy:s,r:3.5,fill:"rgba(255,255,255,0.9)"})]},e.id)}if(e.type==="dash_blur"){const l=e.payload?.path;if(!l||l.length<2)return null;const u=l.map(f=>{const p=Ae(f,G);return`${p.x},${p.y}`}).join(" ");return g.jsx("polyline",{points:u,fill:"none",stroke:"rgba(255,255,255,0.4)",strokeWidth:"8",strokeLinecap:"round",strokeLinejoin:"round",className:"animate-arrow-shot",opacity:.6},e.id)}if(e.type==="hidden_fade")return g.jsxs("g",{className:"animate-flash",children:[g.jsx("circle",{cx:t,cy:s,r:G*.78,fill:"rgba(168,85,247,0.16)",stroke:"rgba(196,181,253,0.75)",strokeWidth:2}),g.jsx("circle",{cx:t,cy:s,r:G*.34,fill:"rgba(30,27,75,0.35)"})]},e.id);if(e.type==="impact")return o?g.jsx("image",{href:o,x:t-G*.75,y:s-G*.75,width:G*1.5,height:G*1.5,preserveAspectRatio:"xMidYMid meet",className:"animate-impact",opacity:"0.9"},e.id):g.jsx("circle",{cx:t,cy:s,r:G*.5,fill:"none",stroke:"#ffffff",strokeWidth:"2",className:"animate-impact"},e.id);if(e.type==="combat_text"){const l=String(e.payload.text||""),u=e.payload.color||(l.startsWith("-")?"#fb7185":"#86efac");return g.jsxs("g",{transform:`translate(${t}, ${s-10})`,children:[a&&g.jsx("image",{href:a,x:-46,y:-24,width:92,height:24,preserveAspectRatio:"xMidYMid meet",opacity:"0.78"}),g.jsx("text",{textAnchor:"middle",fill:u,fontSize:"16",fontWeight:"black",className:"animate-float-up",style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.8))",paintOrder:"stroke",stroke:"#000",strokeWidth:"4px"},children:l})]},e.id)}if(e.type==="flash")return g.jsx("circle",{cx:t,cy:s,r:G*2,fill:"#ffffff",className:"animate-flash"},e.id);if(e.type==="spear_trail"){const u=e.payload.path.map(f=>{const p=Ae(f,G);return`${p.x},${p.y}`}).join(" ");return g.jsx("polyline",{points:u,fill:"none",stroke:"#ffffff",strokeWidth:"4",strokeLinecap:"round",className:"animate-spear-trail"},e.id)}return e.type==="vaporize"?o?g.jsx("image",{href:o,x:t-G*.95,y:s-G*.95,width:G*1.9,height:G*1.9,preserveAspectRatio:"xMidYMid meet",className:"animate-vaporize",opacity:"0.9"},e.id):g.jsxs("g",{children:[g.jsx("circle",{cx:t,cy:s,r:G*.6,fill:"#f97316",className:"animate-vaporize",opacity:"0.8"}),g.jsx("circle",{cx:t,cy:s,r:G*1.2,fill:"none",stroke:"#f97316",strokeWidth:"2",className:"animate-ping"})]},e.id):e.type==="lava_ripple"?o?g.jsx("image",{href:o,x:t-G,y:s-G,width:G*2,height:G*2,preserveAspectRatio:"xMidYMid meet",className:"animate-ping",opacity:"0.85"},e.id):g.jsx("circle",{cx:t,cy:s,r:G*.8,fill:"none",stroke:"#ea580c",strokeWidth:"3",className:"animate-ping"},e.id):e.type==="explosion_ring"?o?g.jsx("image",{href:o,x:t-G*1.35,y:s-G*1.35,width:G*2.7,height:G*2.7,preserveAspectRatio:"xMidYMid meet",className:"animate-explosion-ring",opacity:"0.88"},e.id):g.jsx("circle",{cx:t,cy:s,r:G*2.5,fill:"rgba(255, 120, 0, 0.2)",stroke:"#ffaa00",strokeWidth:"4",className:"animate-explosion-ring"},e.id):null},Zw=({effect:e,x:t,y:s})=>{const o=e.payload||{},a=o.source,l=o.target,u=String(o.phase||"impact");if(!a||!l)return null;const f=Ae(a,G),p=o.contactWorld&&typeof o.contactWorld.x=="number"&&typeof o.contactWorld.y=="number"?o.contactWorld:{x:t,y:s},m=p.x-f.x,y=p.y-f.y,b=Math.max(1,Math.hypot(m,y)),v=m/b,T=y/b,S=String(o.intensity||"medium"),x=Math.max(120,Math.min(360,Number(e.ttlMs||180))),_=`${Math.round(x*.85)}ms`,E=S==="extreme"?G*.34:S==="high"?G*.28:G*.22;if(u!=="impact")return null;const w=S==="extreme"?"rgba(253,224,71,0.98)":S==="high"?"rgba(255,255,255,0.96)":"rgba(226,232,240,0.95)",M=S==="extreme"?"rgba(251,191,36,0.9)":"rgba(255,255,255,0.92)";return g.jsx("g",{children:g.jsxs("g",{className:"juice-basic-strike-spark",style:{animationDuration:_},children:[g.jsx("circle",{cx:p.x,cy:p.y,r:E*1.65,fill:"rgba(255,255,255,0.16)",stroke:"rgba(255,255,255,0.55)",strokeWidth:1.4}),g.jsx("circle",{cx:p.x,cy:p.y,r:E*.62,fill:M}),g.jsx("circle",{cx:p.x,cy:p.y,r:E*1.2,fill:"none",stroke:w,strokeWidth:2.4}),g.jsx("path",{d:`M ${p.x-v*E*1.6} ${p.y-T*E*1.6} L ${p.x+v*E*1.6} ${p.y+T*E*1.6}`,stroke:w,strokeWidth:2.1,strokeLinecap:"round"}),g.jsx("path",{d:`M ${p.x-T*E*1.35} ${p.y+v*E*1.35} L ${p.x+T*E*1.35} ${p.y-v*E*1.35}`,stroke:"rgba(255,255,255,0.9)",strokeWidth:1.8,strokeLinecap:"round"})]})},e.id)},eC=({effect:e,x:t,y:s})=>{const o=e.payload||{},a=o.source,l=o.target,u=String(o.phase||"travel");if(!a||!l)return null;const f=Ae(a,G),p=Ae(l,G),m=o.contactWorld&&typeof o.contactWorld.x=="number"&&typeof o.contactWorld.y=="number"?o.contactWorld:{x:t,y:s},y=u==="impact"?m:p,b=y.x-f.x,v=y.y-f.y,T=Math.max(1,Math.hypot(b,v)),S=b/T,x=v/T,_=String(o.intensity||"medium");if(u==="anticipation")return g.jsxs("g",{className:"animate-arrow-shot",opacity:.95,children:[g.jsx("line",{x1:f.x,y1:f.y,x2:p.x,y2:p.y,stroke:"rgba(248,113,113,0.75)",strokeWidth:1.5,strokeDasharray:"4 5",strokeLinecap:"round"}),g.jsx("circle",{cx:p.x,cy:p.y,r:G*.18,fill:"none",stroke:"rgba(254,202,202,0.9)",strokeWidth:1.5})]},e.id);if(u==="travel"){const w=Math.min(T*.22,G*.75),M=y.x-S*w,k=y.y-x*w,R=7.5,O=y.x-S*R-x*(R*.52),I=y.y-x*R+S*(R*.52),D=y.x-S*R+x*(R*.52),j=y.y-x*R-S*(R*.52);return g.jsxs("g",{className:"animate-arrow-shot",children:[g.jsx("line",{x1:f.x,y1:f.y,x2:y.x,y2:y.y,stroke:"rgba(180,83,9,0.38)",strokeWidth:3.2,strokeLinecap:"round",strokeDasharray:"8 9"}),g.jsx("line",{x1:M,y1:k,x2:y.x,y2:y.y,stroke:"rgba(254,240,138,0.98)",strokeWidth:2.2,strokeLinecap:"round"}),g.jsx("path",{d:`M ${y.x} ${y.y} L ${O} ${I} M ${y.x} ${y.y} L ${D} ${j}`,stroke:"rgba(255,251,235,0.98)",strokeWidth:1.9,strokeLinecap:"round"}),g.jsx("circle",{cx:f.x,cy:f.y,r:G*.08,fill:"rgba(251,191,36,0.55)"})]},e.id)}const E=_==="extreme"||_==="high"?G*.24:G*.19;return g.jsxs("g",{className:"animate-impact",children:[g.jsx("circle",{cx:m.x,cy:m.y,r:E*1.35,fill:"rgba(251,191,36,0.14)",stroke:"rgba(254,243,199,0.72)",strokeWidth:1.4}),g.jsx("line",{x1:m.x-S*E*1.6,y1:m.y-x*E*1.6,x2:m.x+S*E*1.25,y2:m.y+x*E*1.25,stroke:"rgba(255,251,235,0.95)",strokeWidth:2,strokeLinecap:"round"}),g.jsx("path",{d:`M ${m.x+S*E*1.2} ${m.y+x*E*1.2} L ${m.x+S*E*1.75-x*E*.45} ${m.y+x*E*1.75+S*E*.45} M ${m.x+S*E*1.2} ${m.y+x*E*1.2} L ${m.x+S*E*1.75+x*E*.45} ${m.y+x*E*1.75-S*E*.45}`,stroke:"rgba(254,240,138,0.9)",strokeWidth:1.5,strokeLinecap:"round"})]},e.id)},tC=e=>e.effect.type==="basic_attack_strike"?Zw(e):e.effect.type==="archer_shot_signature"?eC(e):null,nC=new Set(["impact","flash","combat_text","spear_trail","vaporize","lava_ripple","explosion_ring"]),iC=({effect:e,assetById:t,frameAssetHref:s,nowMs:o})=>{if(o<e.startTime||!e.position&&!e.worldPosition)return null;const a=e.position?Ae(e.position,G):{x:0,y:0},l=e.worldPosition?.x??a.x,u=e.worldPosition?.y??a.y,f=nC.has(e.type)?Ew(e.type):void 0,p=f?t.get(f)?.path:void 0;return e.type==="basic_attack_strike"||e.type==="archer_shot_signature"?tC({effect:e,x:l,y:u}):Qw({effect:e,x:l,y:u,fxAssetHref:p,frameAssetHref:s})},sC=({effects:e,assetById:t})=>{const s=t.get(_w())?.path,o=Date.now();return g.jsx("g",{style:{pointerEvents:"none"},children:e.map(a=>iC({effect:a,assetById:t,frameAssetHref:s,nowMs:o}))})},aC={"ATK.STRIKE.PHYSICAL.BASIC_ATTACK|anticipation":{rendererId:"basic_attack_strike",ttlMs:130},"ATK.STRIKE.PHYSICAL.BASIC_ATTACK|travel":{rendererId:"basic_attack_strike",ttlMs:110},"ATK.STRIKE.PHYSICAL.BASIC_ATTACK|impact":{rendererId:"basic_attack_strike",ttlMs:180},"ATK.STRIKE.PHYSICAL.BASIC_ATTACK|aftermath":{rendererId:"basic_attack_strike",ttlMs:190},"ATK.STRIKE.PHYSICAL.AUTO_ATTACK|anticipation":{rendererId:"basic_attack_strike",ttlMs:100},"ATK.STRIKE.PHYSICAL.AUTO_ATTACK|travel":{rendererId:"basic_attack_strike",ttlMs:90},"ATK.STRIKE.PHYSICAL.AUTO_ATTACK|impact":{rendererId:"basic_attack_strike",ttlMs:140},"ATK.STRIKE.PHYSICAL.AUTO_ATTACK|aftermath":{rendererId:"basic_attack_strike",ttlMs:120},"ATK.SHOOT.PHYSICAL.ARROW|anticipation":{rendererId:"archer_shot_signature",ttlMs:110},"ATK.SHOOT.PHYSICAL.ARROW|travel":{rendererId:"archer_shot_signature",ttlMs:160,skipIfLegacyMirrored:!0},"ATK.SHOOT.PHYSICAL.ARROW|impact":{rendererId:"archer_shot_signature",ttlMs:150}},oC={"ATK.STRIKE.PHYSICAL.IMPACT":{rendererId:"impact",ttlMs:420,skipIfLegacyMirrored:!0},"ATK.STRIKE.PHYSICAL.HEAVY":{rendererId:"melee_lunge",ttlMs:280},"ATK.STRIKE.PHYSICAL.LIGHT":{rendererId:"impact",ttlMs:380},"ATK.SHOOT.PHYSICAL.SPEAR_TRAIL":{rendererId:"spear_trail",ttlMs:520,skipIfLegacyMirrored:!0},"ATK.SHOOT.PHYSICAL.SPEAR_RETURN":{rendererId:"spear_trail",ttlMs:520},"ATK.BLAST.FIRE.EXPLOSION_RING":{rendererId:"explosion_ring",ttlMs:980},"ATK.BLAST.FIRE.TIME_BOMB":{rendererId:"explosion_ring",ttlMs:980},"ATK.BLAST.FIRE.FIREBALL_IMPACT":{rendererId:"explosion_ring",ttlMs:740},"ATK.BLAST.VOID.CORPSE_EXPLOSION":{rendererId:"generic_ring",ttlMs:840},"ENV.HAZARD.FIRE.LAVA_RIPPLE":{rendererId:"lava_ripple",ttlMs:820},"ENV.COLLISION.KINETIC.WALL_CRACK":{rendererId:"wall_crack",ttlMs:700},"ENV.COLLISION.KINETIC.IMPACT":{rendererId:"wall_crack",ttlMs:520},"ATK.PULSE.KINETIC.WAVE":{rendererId:"kinetic_wave",ttlMs:540},"MOVE.DASH.NEUTRAL.BLUR":{rendererId:"dash_blur",ttlMs:320},"MOVE.DASH.NEUTRAL.SWIFT_ROLL":{rendererId:"dash_blur",ttlMs:320},"MOVE.DASH.KINETIC.MOMENTUM_TRAIL":{rendererId:"dash_blur",ttlMs:360},"STATE.FADE.SHADOW.HIDDEN":{rendererId:"hidden_fade",ttlMs:360},"STATE.FADE.SHADOW.SMOKE_SCREEN":{rendererId:"hidden_fade",ttlMs:420},"MOVE.BLINK.SHADOW.SHADOW_STEP":{rendererId:"hidden_fade",ttlMs:380},"MOVE.BLINK.ARCANE.SOUL_SWAP_ARRIVE":{rendererId:"flash",ttlMs:280},"MOVE.BLINK.ARCANE.SOUL_SWAP_DEPART":{rendererId:"flash",ttlMs:280},"STATE.APPLY.NEUTRAL.STUN_BURST":{rendererId:"generic_ring",ttlMs:560},"UI.TEXT.NEUTRAL.POPUP":{rendererId:"combat_text",ttlMs:1100},"UI.SHAKE.NEUTRAL.CAMERA":{rendererId:"none",ttlMs:1,skipIfLegacyMirrored:!0},"UI.FREEZE.NEUTRAL.HITSTOP":{rendererId:"none",ttlMs:1}},rC={"attack|shoot|physical|travel":{rendererId:"arrow_shot",ttlMs:320},"attack|shoot|arcane|travel":{rendererId:"arcane_bolt",ttlMs:340},"attack|shoot|fire|travel":{rendererId:"arcane_bolt",ttlMs:340},"attack|strike|physical|impact":{rendererId:"melee_lunge",ttlMs:260},"attack|blast|fire|impact":{rendererId:"explosion_ring",ttlMs:900},"attack|pulse|kinetic|impact":{rendererId:"kinetic_wave",ttlMs:520},"environment|collision|kinetic|impact":{rendererId:"wall_crack",ttlMs:700},"status|state_fade|shadow|instant":{rendererId:"hidden_fade",ttlMs:360},"ui|text|neutral|instant":{rendererId:"combat_text",ttlMs:1e3}},lC={"attack|blast|impact":{rendererId:"generic_ring",ttlMs:680},"attack|shoot|travel":{rendererId:"generic_line",ttlMs:300},"attack|strike|impact":{rendererId:"impact",ttlMs:400},"environment|hazard_burst|impact":{rendererId:"generic_ring",ttlMs:760},"status|status_apply|impact":{rendererId:"flash",ttlMs:320},"ui|text|instant":{rendererId:"combat_text",ttlMs:1e3}},cC={"movement|dash":{rendererId:"dash_blur",ttlMs:300},"movement|blink":{rendererId:"flash",ttlMs:260},"attack|pulse":{rendererId:"kinetic_wave",ttlMs:500},"attack|blast":{rendererId:"generic_ring",ttlMs:700},"attack|shoot":{rendererId:"generic_line",ttlMs:280},"attack|strike":{rendererId:"impact",ttlMs:380},"environment|collision":{rendererId:"wall_crack",ttlMs:650},"ui|text":{rendererId:"combat_text",ttlMs:1e3}},uC=new Set(["impact","flash","spearTrail","shake"]),dC=e=>{const t=`${e.signature}|${e.phase}`,s=aC[t];if(s)return{key:`sigp:${t}`,recipe:s};const o=oC[e.signature];if(o)return{key:`sig:${e.signature}`,recipe:o};const a=`${e.family}|${e.primitive}|${e.element||"neutral"}|${e.phase}`,l=rC[a];if(l)return{key:`fpel:${a}`,recipe:l};const u=`${e.family}|${e.primitive}|${e.phase}`,f=lC[u];if(f)return{key:`fpp:${u}`,recipe:f};const p=`${e.family}|${e.primitive}`,m=cC[p];return m?{key:`fp:${p}`,recipe:m}:{key:"fallback:none",recipe:{rendererId:"none",ttlMs:1}}},fC=({payload:e,reducedMotion:t})=>{const{key:s,recipe:o}=dC(e);if(o.skipIfLegacyMirrored&&e.meta?.legacyMirrored&&e.meta?.legacyJuiceId&&uC.has(String(e.meta.legacyJuiceId)))return null;let a=Math.max(1,Number(e.timing?.ttlMs??e.timing?.durationMs??o.ttlMs));return t&&(a=Math.max(1,Math.floor(a*.7))),{key:s,ttlMs:a,recipe:o,payload:e}},Dd=e=>{const t=e?.hex;if(t&&typeof t.q=="number"&&typeof t.r=="number"&&typeof t.s=="number")return t},Ud=e=>{const t=e?.world;if(t&&typeof t.x=="number"&&typeof t.y=="number")return t},mC=({incoming:e,now:t,reducedMotion:s,recentSignatureImpactByTile:o})=>{const a=[];return e.forEach((l,u)=>{if(l.type!=="juice_signature")return;const f=l.payload;if(!f||f.protocol!=="juice-signature/v1")return;const p=fC({payload:f,reducedMotion:s});if(!p||p.recipe.rendererId==="none")return;const m=Dd(f.contact),y=Dd(f.target),b=Dd(f.source),v=Ud(f.contact),T=Ud(f.target),S=Ud(f.source),x=m||y||b,_=v||T||S,E={id:`sig-${t}-${u}`,startTime:t+Math.max(0,Number(f.timing?.delayMs||0)),ttlMs:p.ttlMs};if((f.signature==="ATK.STRIKE.PHYSICAL.BASIC_ATTACK"||f.signature==="ATK.STRIKE.PHYSICAL.AUTO_ATTACK")&&f.phase==="impact"&&y){const M=ce(y);o.set(M,{at:t,signature:f.signature})}const w=f.text?.value;switch(p.recipe.rendererId){case"basic_attack_strike":{if(!b||!y)return;a.push({...E,type:"basic_attack_strike",position:y,worldPosition:v||_,payload:{phase:f.phase,intensity:f.intensity||"medium",signature:f.signature,source:b,target:y,sourceActorId:f.source?.actorId,targetActorId:f.target?.actorId,contactWorld:v,contactHex:m,direction:f.direction,flags:f.flags||{}}});return}case"archer_shot_signature":{const M=y||m;if(!b||!M)return;a.push({...E,type:"archer_shot_signature",position:M,worldPosition:v||_,payload:{phase:f.phase,intensity:f.intensity||"medium",source:b,target:M,contactWorld:v,path:f.path||(f.area?.kind==="path"?f.area.points:void 0),signature:f.signature}});return}case"impact":case"flash":case"lava_ripple":case"explosion_ring":case"kinetic_wave":case"wall_crack":case"hidden_fade":case"generic_ring":{if(!x&&!_)return;a.push({...E,type:p.recipe.rendererId,position:x,worldPosition:_,payload:{signature:f.signature,color:f.text?.color,element:f.element,variant:f.variant,source:b,target:y}});return}case"combat_text":{if(!w||!x&&!_)return;a.push({...E,type:"combat_text",position:x,worldPosition:_,payload:{text:w,color:f.text?.color}});return}case"spear_trail":{if((!f.path||f.path.length===0)&&f.area?.kind!=="path")return;const M=f.path||(f.area?.kind==="path"?f.area.points:[]);if(!M||M.length===0)return;a.push({...E,type:"spear_trail",position:M[0],payload:{path:M}});return}case"melee_lunge":case"arrow_shot":case"arcane_bolt":case"generic_line":{const M=y||m;if(!M||!b)return;a.push({...E,type:p.recipe.rendererId,position:M,payload:{source:b,signature:f.signature,element:f.element}});return}case"dash_blur":{const M=f.path||(f.area?.kind==="path"?f.area.points:void 0);if(!M||M.length<2)return;a.push({...E,type:"dash_blur",position:M[M.length-1],payload:{path:M,source:M[0]}});return}default:return}}),a},pC=({incoming:e,now:t})=>{const s=[];return e.forEach((o,a)=>{const l=`juice-${t}-${a}`;o.type==="vfx"&&o.payload?.type==="impact"?o.payload.position&&s.push({id:l,type:"impact",position:o.payload.position,startTime:t}):o.type==="vfx"&&o.payload?.type==="flash"?o.payload.position&&s.push({id:l,type:"flash",position:o.payload.position,startTime:t}):o.type==="vfx"&&o.payload?.type==="spear_trail"?o.payload.path&&o.payload.path.length>0&&s.push({id:l,type:"spear_trail",position:o.payload.path[0],payload:o.payload,startTime:t}):o.type==="vfx"&&o.payload?.type==="vaporize"?o.payload.position&&s.push({id:l,type:"vaporize",position:o.payload.position,startTime:t}):o.type==="vfx"&&o.payload?.type==="lava_ripple"?o.payload.position&&s.push({id:l,type:"lava_ripple",position:o.payload.position,startTime:t}):o.type==="vfx"&&o.payload?.type==="explosion_ring"&&o.payload.position&&s.push({id:l,type:"explosion_ring",position:o.payload.position,startTime:t})}),s},hC=({incoming:e,now:t,startIndex:s,actorById:o,recentSignatureImpactByTile:a,classifyDamageCueType:l})=>{const u=[];return e.forEach((f,p)=>{if(f.type!=="DamageTaken"||!f.position)return;const m=f.position,y=String(f.payload?.sourceId||""),b=y?o.get(y):void 0,v=String(f.payload?.reason||""),T=a.get(ce(m)),S=T?.signature==="ATK.STRIKE.PHYSICAL.BASIC_ATTACK"||T?.signature==="ATK.STRIKE.PHYSICAL.AUTO_ATTACK",x=!!(T&&S&&t-T.at<=260),_=v.includes("basic_attack")||v.includes("auto_attack");if(b?.position){const E=Ae(b.position,G),w=Ae(m,G),M=Math.hypot(w.x-E.x,w.y-E.y),k=x&&_?null:l(b.subtype,v,M);k&&u.push({id:`sim-cue-${t}-${s+p}`,type:k,position:m,payload:{source:b.position,sourceSubtype:b.subtype,reason:v},startTime:t})}x&&_||u.push({id:`sim-impact-${t}-${s+p}`,type:"impact",position:m,startTime:t})}),u},yC=e=>new Promise(t=>setTimeout(t,e)),gC=e=>{if(!e)return null;const t=e.position||e.destination||e.origin||e.target;return t&&typeof t.q=="number"&&typeof t.r=="number"&&typeof t.s=="number"?t:null},Sb=e=>{if(e.ttlMs&&e.ttlMs>0)return e.ttlMs;const t=e.type;return t==="basic_attack_strike"?180:t==="archer_shot_signature"?170:t==="impact"?400:t==="combat_text"?1e3:t==="flash"?300:t==="melee_lunge"?240:t==="arrow_shot"?260:t==="arcane_bolt"?320:t==="kinetic_wave"?520:t==="wall_crack"?700:t==="dash_blur"?320:t==="hidden_fade"?360:t==="generic_ring"?700:t==="generic_line"?280:t==="spear_trail"?500:t==="vaporize"?600:t==="lava_ripple"?800:t==="explosion_ring"?1e3:2e3},Bg=.72,bC=(e,t,s)=>{const o=String(e||"").toLowerCase(),a=String(t||"").toLowerCase();return a.includes("lava")||a.includes("fire")||a.includes("hazard")||a.includes("burn")||a.includes("crush")||a.includes("collision")||o==="bomber"||a.includes("bomb")||a.includes("explosion")?null:o==="warlock"||a.includes("arcane")||a.includes("force")||a.includes("spell")?"arcane_bolt":o==="archer"||a.includes("arrow")||a.includes("spear_throw")?"arrow_shot":s<=G*2.05||a.includes("basic_attack")||a.includes("melee")?"melee_lunge":null},vb=650,SC=3500,vC=(e,t)=>{const s=gC(e.payload);if(!s)return[];const o=[],a=`${e.id}:${t}`;return e.phase==="HAZARD_CHECK"?o.push({id:`${a}:haz`,type:"combat_text",position:s,payload:{text:"!"},startTime:t}):e.phase==="DEATH_RESOLVE"&&o.push({id:`${a}:vapor`,type:"vaporize",position:s,startTime:t}),o},AC=(e,t,s)=>{let o=e.blocking?Math.round((e.suggestedDurationMs??140)*Bg):0;if(e.phase!=="MOVE_END")return o;const a=e.payload?.targetActorId;if(!a)return o;const l=t.get(a),u=l?s-l.seenAt<=2500:!1;return!l||!u||l.durationMs<=0?o:Math.max(o,Math.min(vb,Math.round(l.durationMs*Bg)))},xC=(e,t)=>e.phase==="MOVE_END"?Math.min(460,Math.max(70,t)):e.phase==="DEATH_RESOLVE"?Math.min(120,Math.max(55,t)):e.phase==="DAMAGE_APPLY"?Math.min(80,Math.max(35,t)):e.phase==="HAZARD_CHECK"?Math.min(70,Math.max(30,t)):e.blocking?Math.min(70,Math.max(0,t)):0,TC=(e,t,s,o)=>{const a=e.phase==="MOVE_END"?t:o?Math.min(70,Math.floor(s*.5)):s;return Math.max(0,Math.min(vb,a))},EC=(e,t)=>{let s=1/0;for(const o of e){if(o.startTime>t){const u=o.startTime-t;u>0&&u<s&&(s=u);continue}const a=t-o.startTime,l=Sb(o)-a;l>0&&l<s&&(s=l)}return s},_C=({visualEvents:e,timelineEvents:t,simulationEvents:s,actorSnapshots:o,onBusyStateChange:a})=>{const[l,u]=N.useState([]),f=N.useRef(null),p=N.useRef(null),m=N.useRef(null),y=N.useRef(0),b=N.useRef([]),v=N.useRef(!1),[T,S]=N.useState(!1),x=N.useRef(!1),_=N.useRef(new Map),E=N.useRef(null),w=N.useRef(Date.now()),M=N.useRef(new Map),k=N.useMemo(()=>{const O=new Map;for(const I of o)O.set(I.id,I);return O},[o]);N.useEffect(()=>{if(typeof window>"u"||!window.matchMedia)return;const O=window.matchMedia("(prefers-reduced-motion: reduce)"),I=()=>{x.current=O.matches};return I(),O.addEventListener?.("change",I),()=>O.removeEventListener?.("change",I)},[]),N.useEffect(()=>{if(!e.length)return;const O=new Map(_.current),I=Date.now();for(const D of e){if(D.type!=="kinetic_trace")continue;const j=D.payload;if(!j?.actorId)continue;const U=Number(j.durationMs??0);U>0&&O.set(String(j.actorId),{durationMs:U,seenAt:I})}_.current=O},[e]),N.useEffect(()=>{a?.(T)},[T,a]);const R=O=>{const I=Date.now(),D=vC(O,I);D.length>0&&u(j=>[...j,...D])};return N.useEffect(()=>{if(!t.length||f.current===t)return;f.current=t;const O=t;O.length&&(b.current.push(...O),!v.current&&(v.current=!0,S(!0),(async()=>{try{const I=Date.now();for(;b.current.length>0;){if(Date.now()-I>SC){console.warn("[HOP_JUICE] Timeline queue exceeded runtime budget; flushing remaining events.",{queued:b.current.length});break}const D=b.current.shift();R(D);const j=Date.now(),U=AC(D,_.current,j),q=xC(D,U),se=TC(D,U,q,x.current);se>0&&await yC(se)}}catch(I){console.error("[HOP_JUICE] Timeline queue processing failed; releasing busy lock.",I)}finally{b.current=[],v.current=!1,S(!1)}})()))},[t]),N.useEffect(()=>{if(m.current===e)return;m.current=e;const O=e;if(!O.length)return;const I=Date.now(),D=mC({incoming:O,now:I,reducedMotion:x.current,recentSignatureImpactByTile:M.current});D.length>0&&u(j=>[...j,...D])},[e]),N.useEffect(()=>{if(t.length>0){p.current=e;return}if(p.current===e)return;p.current=e;const O=e;if(!O.length)return;const I=Date.now(),D=pC({incoming:O,now:I});D.length>0&&u(j=>[...j,...D])},[e,t.length]),N.useEffect(()=>{s.length<y.current&&(y.current=0);const O=y.current;if(O>=s.length)return;const I=s.slice(O);y.current=s.length;const D=Date.now(),j=hC({incoming:I,now:D,startIndex:O,actorById:k,recentSignatureImpactByTile:M.current,classifyDamageCueType:bC});j.length>0&&u(U=>[...U,...j])},[s,k]),N.useEffect(()=>{if(E.current!==null&&(window.clearTimeout(E.current),E.current=null),l.length===0)return;const O=Date.now(),I=EC(l,O);if(!Number.isFinite(I)){u([]);return}const D=Math.max(16,Math.min(180,Math.floor(I)));return E.current=window.setTimeout(()=>{const j=Date.now();u(U=>{const q=w.current;w.current=j;const se=U.filter(oe=>j<oe.startTime+Sb(oe));return se.length!==U.length?se:U.some(oe=>q<oe.startTime&&oe.startTime<=j)?[...U]:U})},D),()=>{E.current!==null&&(window.clearTimeout(E.current),E.current=null)}},[l]),l},MC=({visualEvents:e,timelineEvents:t=[],simulationEvents:s=[],actorSnapshots:o=[],onBusyStateChange:a,assetManifest:l})=>{const u=N.useMemo(()=>{const p=new Map;for(const m of l?.assets||[])p.set(m.id,m);return p},[l]),f=_C({visualEvents:e,timelineEvents:t,simulationEvents:s,actorSnapshots:o,onBusyStateChange:a});return g.jsx(sC,{effects:f,assetById:u})},wC=({gameState:e,latestTraceByActor:t,entityVisualPoseById:s,assetById:o,biomeThemeKey:a,juiceActorSnapshots:l,assetManifest:u,onJuiceBusyStateChange:f})=>g.jsxs("g",{children:[e.lastSpearPath&&e.lastSpearPath.length>=2&&(()=>{const m=e.lastSpearPath.map(y=>Ae(y,G)).map((y,b)=>`${b===0?"M":"L"} ${y.x} ${y.y}`).join(" ");return g.jsx("path",{d:m,stroke:"rgba(255, 255, 255, 0.15)",strokeWidth:"2",fill:"none",strokeDasharray:"4 2",strokeLinecap:"round"})})(),e.spearPosition&&g.jsx(Sl,{entity:{id:"spear",type:"player",subtype:"footman",position:e.spearPosition,hp:1,maxHp:1,statusEffects:[],temporaryArmor:0,activeSkills:[],speed:0,factionId:"player"},isSpear:!0}),g.jsx(Sl,{entity:e.player,movementTrace:t[e.player.id],waapiControlled:!0,visualPose:s.get(e.player.id),assetHref:o.get(Ji(e.player))?.path,fallbackAssetHref:ws(e.player),floorTheme:a},`player-${e.floor}`),e.enemies.map(p=>g.jsx(Sl,{entity:p,movementTrace:t[p.id],waapiControlled:!0,visualPose:s.get(p.id),assetHref:o.get(Ji(p))?.path,fallbackAssetHref:ws(p),floorTheme:a},`${p.id}-${e.floor}`)),e.dyingEntities?.map(p=>g.jsx(Sl,{entity:p,isDying:!0,movementTrace:t[p.id],waapiControlled:!0,visualPose:s.get(p.id),assetHref:o.get(Ji(p))?.path,fallbackAssetHref:ws(p),floorTheme:a},`dying-${p.id}-${e.floor}-${e.turnNumber}`)),g.jsx(MC,{visualEvents:e.visualEvents||[],timelineEvents:e.timelineEvents||[],simulationEvents:e.simulationEvents||[],actorSnapshots:l,onBusyStateChange:f,assetManifest:u},`juice-${e.floor}`)]}),CC=({cells:e,gridPoints:t})=>g.jsx("g",{"data-layer":"interaction-ui-grid",pointerEvents:"none",shapeRendering:"crispEdges",children:e.map(s=>{const{x:o,y:a}=Ae(s,G);return g.jsx("g",{transform:`translate(${o},${a})`,children:g.jsx("polygon",{points:t,fill:"none",stroke:"rgba(201,224,255,0.12)",strokeWidth:.9})},`grid-${ce(s)}`)})}),OC=({boardProps:e})=>g.jsx("g",{"data-layer":"ui-objective-markers",pointerEvents:"none",children:e.map(t=>{const{x:s,y:o}=Ae(t.position,G),a=t.kind==="shrine",l=a?"#c2410c":"#15803d",u=a?"S":"E",f=s+G*.52,p=o-G*.52;return g.jsxs("g",{transform:`translate(${f},${p})`,children:[g.jsx("circle",{r:14,fill:"none",stroke:"rgba(255,255,255,0.55)",strokeWidth:2,style:{animation:`shrineGlow ${a?1.6:1.9}s ease-in-out infinite`}}),g.jsx("circle",{r:10.5,fill:l,stroke:"#ffffff",strokeWidth:2}),g.jsx("text",{x:0,y:0,textAnchor:"middle",dy:".34em",fill:"#ffffff",fontSize:10,fontWeight:900,style:{textShadow:"0 1px 2px rgba(0,0,0,0.7)"},children:u})]},`marker-${t.id}`)})}),kC=({svgRef:e,renderedViewBox:t,cells:s,gameState:o,selectedSkillId:a,showMovementRange:l,hoveredTile:u,resolvedEnginePreviewGhost:f,tileVisualFlags:p,movementTargetSet:m,hasPrimaryMovementSkills:y,fallbackNeighborSet:b,selectedSkillTargetSet:v,stairsKey:T,shrineKey:S,mountainCoveredWallKeys:x,hybridInteractionLayerEnabled:_,assetById:E,decals:w,depthSortedSprites:M,boardProps:k,manifestUnitToBoardScale:R,mountainSettingsByAssetId:O,resolveMountainSettings:I,latestTraceByActor:D,entityVisualPoseById:j,biomeThemeKey:U,juiceActorSnapshots:q,assetManifest:se,backdropLayerProps:ee,gridPoints:oe,onTileClick:F,onTileHover:P,onMouseLeave:z,onWheel:Z,onPointerDown:re,onPointerMove:pe,onPointerUp:B,onPointerCancel:W,onJuiceBusyStateChange:X})=>g.jsxs("svg",{ref:e,width:"100%",height:"100%",viewBox:`${t.x} ${t.y} ${t.width} ${t.height}`,preserveAspectRatio:"xMidYMid meet",shapeRendering:"geometricPrecision",className:"max-h-full max-w-full",onMouseLeave:z,onWheel:Z,onPointerDown:re,onPointerMove:pe,onPointerUp:B,onPointerCancel:W,style:{touchAction:"none"},children:[g.jsx(cw,{cells:s,...ee}),g.jsx(ww,{gameState:o,selectedSkillId:a,showMovementRange:l,hoveredTile:u,enginePreviewGhost:f,cells:s,tileVisualFlags:p,movementTargetSet:m,hasPrimaryMovementSkills:y,fallbackNeighborSet:b,selectedSkillTargetSet:v,stairsKey:T,shrineKey:S,mountainCoveredWallKeys:x,hybridInteractionLayerEnabled:_,assetById:E,onTileClick:F,onTileHover:P,decals:w}),g.jsx(Iw,{sprites:M,floor:o.floor,manifestUnitToBoardScale:R,mountainSettingsByAssetId:O,resolveMountainSettings:I}),g.jsx(wC,{gameState:o,latestTraceByActor:D,entityVisualPoseById:j,assetById:E,biomeThemeKey:U,juiceActorSnapshots:q,assetManifest:se,onJuiceBusyStateChange:X}),g.jsx(CC,{cells:s,gridPoints:oe}),g.jsx(OC,{boardProps:k})]}),NC=({svgRef:e,onMove:t,zoomPreset:s,setHoveredTile:o,setIsCameraPanning:a,cameraPanOffsetRef:l,isCameraPanningRef:u,isPinchingRef:f,suppressTileClickUntilRef:p,activePointersRef:m,dragStateRef:y,pinchStateRef:b,animateCameraToTarget:v,updatePanFromWorldDelta:T,setZoomPresetAnimated:S})=>{const x=N.useCallback((U,q)=>{const se=e.current;if(!se||!se.getScreenCTM)return null;const ee=se.getScreenCTM();if(!ee)return null;const oe=se.createSVGPoint();oe.x=U,oe.y=q;const F=oe.matrixTransform(ee.inverse());return{x:F.x,y:F.y}},[e]),_=N.useCallback(()=>{l.current={x:0,y:0},v({panOffset:{x:0,y:0},durationMs:220})},[v,l]),E=N.useCallback(U=>{Date.now()<p.current||t(U)},[t,p]),w=N.useCallback(U=>{u.current||f.current||o(U)},[u,f,o]),M=N.useCallback(()=>Array.from(m.current.entries()),[m]),k=N.useCallback(U=>{if(U.pointerType==="mouse"&&U.button!==0)return;if(m.current.set(U.pointerId,{x:U.clientX,y:U.clientY}),U.pointerType!=="mouse")try{U.currentTarget.setPointerCapture(U.pointerId)}catch{}const q=M();if(q.length>=2){f.current=!0,u.current=!1,a(!1),y.current.didPan=!0,p.current=Date.now()+250;const[se,ee]=q,oe=se[1].x-ee[1].x,F=se[1].y-ee[1].y;b.current={startDistance:Math.hypot(oe,F),startPreset:s,appliedPreset:s};return}y.current={activePointerId:U.pointerId,startClient:{x:U.clientX,y:U.clientY},lastWorld:x(U.clientX,U.clientY),didPan:!1}},[m,x,y,M,u,f,b,a,p,s]),R=N.useCallback(U=>{if(!m.current.has(U.pointerId))return;m.current.set(U.pointerId,{x:U.clientX,y:U.clientY});const q=M();if(f.current||q.length>=2){if(q.length>=2){f.current=!0;const[re,pe]=q,B=re[1].x-pe[1].x,W=re[1].y-pe[1].y,X=Math.max(1,Math.hypot(B,W));if(!b.current)b.current={startDistance:X,startPreset:s,appliedPreset:s};else{const ae=X/Math.max(1,b.current.startDistance);let le=b.current.startPreset;ae>1.08&&(le=7),ae<.92&&(le=11),le!==b.current.appliedPreset&&(b.current.appliedPreset=le,S(le))}p.current=Date.now()+250,U.preventDefault()}return}const se=y.current;if(!se.startClient||se.activePointerId!==U.pointerId)return;const ee=U.clientX-se.startClient.x,oe=U.clientY-se.startClient.y,F=Math.hypot(ee,oe);if(!se.didPan&&F>10&&(se.didPan=!0,u.current=!0,a(!0),p.current=Date.now()+250,o(null)),!se.didPan)return;const z=x(U.clientX,U.clientY);if(!se.lastWorld||!z)return;const Z={x:se.lastWorld.x-z.x,y:se.lastWorld.y-z.y};se.lastWorld=z,T(Z),U.preventDefault()},[m,x,y,M,u,f,b,o,a,S,p,T,s]),O=N.useCallback(U=>{m.current.delete(U);const q=M();q.length<2&&(f.current=!1,b.current=null);const se=y.current;se.activePointerId===U&&(se.didPan&&(p.current=Date.now()+250),y.current={activePointerId:q[0]?.[0]??null,startClient:q[0]?{...q[0][1]}:null,lastWorld:q[0]?x(q[0][1].x,q[0][1].y):null,didPan:!1}),m.current.size===0&&(u.current=!1,a(!1))},[m,x,y,M,u,f,b,a,p]),I=N.useCallback(U=>{O(U.pointerId);try{U.currentTarget.releasePointerCapture(U.pointerId)}catch{}},[O]),D=N.useCallback(U=>{O(U.pointerId)},[O]),j=N.useCallback(U=>{if((U.ctrlKey||U.deltaY!==0)&&U.preventDefault(),Math.abs(U.deltaY)<.1)return;const q=U.deltaY<0?7:11;S(q),p.current=Date.now()+120},[S,p]);return{handleResetView:_,handleTileClick:E,handleHoverTile:w,handleBoardPointerDown:k,handleBoardPointerMove:R,handleBoardPointerUp:I,handleBoardPointerCancel:D,handleBoardWheel:j}},RC=[7,11],Pg=(e,t,s)=>e<t?t:e>s?s:e,IC=e=>({top:Math.max(0,Number(e?.top??0)),right:Math.max(0,Number(e?.right??0)),bottom:Math.max(0,Number(e?.bottom??0)),left:Math.max(0,Number(e?.left??0))}),Ef=e=>{const t=IC(e.insets),s=Math.max(1,Number(e.width||0)-t.left-t.right),o=Math.max(1,Number(e.height||0)-t.top-t.bottom);return{width:s,height:o,insets:t}},LC=(e,t,s=0)=>{const o=Math.max(1,t),a=1.5*o,l=2*o;return(Math.max(1,e)-1)*a+l+Math.max(0,s)*2},BC=(e,t,s,o=0)=>{const a=Ef(e),l=LC(t,s,o);return a.width/Math.max(1,l)},PC=(e,t)=>{const s=Ef(e),o=Math.max(1,t.width),a=Math.max(1,t.height);return Math.min(s.width/o,s.height/a)},HC=(e,t)=>({x:e.x-t,y:e.y-t,width:e.width+t*2,height:e.height+t*2}),jC=(e,t)=>{const s=Math.max(1e-6,e),o=Math.max(1e-6,t);return Math.max(s,o)},Hg=(e,t)=>{const s=Ef(e),o=Math.max(1e-6,t);return{width:s.width/o,height:s.height/o}},DC=(e,t,s)=>{const o=t.width/2,a=t.height/2,l=s.x+o,u=s.x+s.width-o,f=s.y+a,p=s.y+s.height-a;return{x:l>u?s.x+s.width/2:Pg(e.x,l,u),y:f>p?s.y+s.height/2:Pg(e.y,f,p)}},jg=(e,t)=>({x:e.x-t.width/2,y:e.y-t.height/2,width:t.width,height:t.height}),UC=(e,t)=>e.didInit?(t.floor??null)!==e.lastCameraFloor?{action:"reset-floor",nextRefs:{...e,lastCameraFloor:t.floor??null,lastBoundsSignature:t.boundsSignature,lastViewportSignature:t.viewportSignature,lastPlayerKey:t.playerKey,lastZoomPreset:t.zoomPreset}}:t.floor!==void 0&&t.boundsSignature!==e.lastBoundsSignature?{action:"reset-bounds",nextRefs:{...e,lastBoundsSignature:t.boundsSignature,lastViewportSignature:t.viewportSignature,lastPlayerKey:t.playerKey,lastZoomPreset:t.zoomPreset}}:t.viewportSignature!==e.lastViewportSignature?{action:"snap-viewport",nextRefs:{...e,lastViewportSignature:t.viewportSignature,lastBoundsSignature:t.boundsSignature}}:t.zoomPreset!==e.lastZoomPreset?{action:"animate-zoom",nextRefs:{...e,lastZoomPreset:t.zoomPreset}}:t.playerKey!==e.lastPlayerKey?{action:"animate-player",nextRefs:{...e,lastPlayerKey:t.playerKey}}:{action:"none",nextRefs:e}:{action:"init",nextRefs:{didInit:!0,lastPlayerKey:t.playerKey,lastCameraFloor:t.floor??null,lastViewportSignature:t.viewportSignature,lastBoundsSignature:t.boundsSignature,lastZoomPreset:t.zoomPreset}},$C=({baseViewBox:e,playerWorld:t,playerPosition:s,floor:o,cameraSafeInsetsPx:a})=>{const[l,u]=N.useState(11),[f,p]=N.useState({width:0,height:0}),[m,y]=N.useState(!1),b=N.useRef(null),v=N.useRef(null),T=N.useRef(null),S=N.useRef(null),x=N.useRef({x:0,y:0}),_=N.useRef(!1),E=N.useRef(!1),w=N.useRef(0),M=N.useRef(new Map),k=N.useRef({activePointerId:null,startClient:null,lastWorld:null,didPan:!1}),R=N.useRef(null),O=N.useRef(null),I=N.useRef(null),D=N.useRef(!1),j=N.useRef(""),U=N.useRef(""),q=N.useRef(11),se=N.useRef(!1),ee=N.useCallback(()=>{S.current!==null&&(window.cancelAnimationFrame(S.current),S.current=null),se.current=!1},[]),oe=N.useCallback(X=>{const ae=b.current;ae&&ae.setAttribute("viewBox",`${X.x} ${X.y} ${X.width} ${X.height}`)},[]),F=N.useCallback(X=>{T.current=X,oe(X.viewBox)},[oe]),P=N.useCallback(X=>{const ae=Math.max(1,f.width),le=Math.max(1,f.height),ue=X?.zoomPreset??l,be=X?.panOffset??x.current,Ee={width:ae,height:le,insets:a||{}},at=G*.75,ot=HC(e,at),kt=BC(Ee,ue,G,G*.2),wt=PC(Ee,ot),ke=jC(wt,kt),et=Hg(Ee,ke),Gt={x:t.x+be.x,y:t.y+be.y},Ft=DC(Gt,et,ot),Cn=jg(Ft,et);return{center:Ft,scale:ke,viewBox:Cn}},[f.width,f.height,l,a,e,t.x,t.y]),z=N.useCallback((X,ae=220)=>{const le=T.current;if(!le){F(X);return}ee();const ue=le.center,be=le.scale,$e=X.center,Ee=X.scale,at=performance.now();se.current=!0;const ot=wt=>1-Math.pow(1-wt,3),kt=wt=>{const ke=Math.min(1,(wt-at)/Math.max(1,ae)),et=ot(ke),Gt=be+(Ee-be)*et,Ft={x:ue.x+($e.x-ue.x)*et,y:ue.y+($e.y-ue.y)*et},Cn={width:Math.max(1,f.width),height:Math.max(1,f.height),insets:a||{}},jn=Hg(Cn,Gt),Dn=jg(Ft,jn);F({center:Ft,scale:Gt,viewBox:Dn}),ke<1?S.current=window.requestAnimationFrame(kt):(S.current=null,se.current=!1,F(X))};S.current=window.requestAnimationFrame(kt)},[ee,F,f.width,f.height,a]),Z=N.useCallback(X=>{ee(),F(P(X))},[ee,F,P]),re=N.useCallback(X=>{const ae=P(X);z(ae,X?.durationMs??220)},[z,P]);N.useEffect(()=>{const X=v.current;if(!X)return;const ae=()=>{const ue=X.getBoundingClientRect();p(be=>{const $e=Math.round(ue.width),Ee=Math.round(ue.height);return be.width===$e&&be.height===Ee?be:{width:$e,height:Ee}})};if(ae(),typeof ResizeObserver>"u")return window.addEventListener("resize",ae),()=>window.removeEventListener("resize",ae);const le=new ResizeObserver(()=>ae());return le.observe(X),()=>le.disconnect()},[]),N.useEffect(()=>{if(f.width<=0||f.height<=0)return;const X=`${e.x}:${e.y}:${e.width}:${e.height}`,ae=`${f.width}:${f.height}:${a?.top??0}:${a?.right??0}:${a?.bottom??0}:${a?.left??0}`,le=ce(s),ue=UC({didInit:D.current,lastPlayerKey:O.current,lastCameraFloor:I.current,lastViewportSignature:j.current,lastBoundsSignature:U.current,lastZoomPreset:q.current},{floor:o,playerKey:le,boundsSignature:X,viewportSignature:ae,zoomPreset:l});if(D.current=ue.nextRefs.didInit,O.current=ue.nextRefs.lastPlayerKey,I.current=ue.nextRefs.lastCameraFloor,j.current=ue.nextRefs.lastViewportSignature,U.current=ue.nextRefs.lastBoundsSignature,q.current=ue.nextRefs.lastZoomPreset,ue.action==="init"){Z({panOffset:{x:0,y:0}});return}if(ue.action==="reset-floor"||ue.action==="reset-bounds"){const be={x:0,y:0};x.current=be,Z({panOffset:be});return}if(ue.action==="snap-viewport"){Z();return}if(ue.action==="animate-zoom"){re();return}if(ue.action==="animate-player"){const be={x:0,y:0};x.current=be,re({panOffset:be,durationMs:210})}},[f.width,f.height,e.x,e.y,e.width,e.height,a,o,s,l,Z,re]),N.useEffect(()=>()=>ee(),[ee]);const pe=N.useCallback(X=>{const ae={x:x.current.x+X.x,y:x.current.y+X.y};x.current=ae,ee(),F(P({panOffset:ae}))},[ee,F,P]),B=N.useCallback(X=>{u(ae=>ae===X?ae:X)},[]),W=T.current?.viewBox||e;return{svgRef:b,boardViewportRef:v,zoomPreset:l,isCameraPanning:m,setIsCameraPanning:y,cameraPanOffsetRef:x,isCameraPanningRef:_,isPinchingRef:E,suppressTileClickUntilRef:w,activePointersRef:M,dragStateRef:k,pinchStateRef:R,cancelCameraAnimation:ee,animateCameraToTarget:re,updatePanFromWorldDelta:pe,setZoomPresetAnimated:B,renderedViewBox:W}},qC=e=>{let t=2166136261;for(let s=0;s<e.length;s++)t^=e.charCodeAt(s),t=Math.imul(t,16777619);return t>>>0},jo=e=>qC(e)/4294967295,zC=e=>{const t=(e.tags||[]).map(o=>o.toLowerCase()),s=[e.id.toLowerCase(),...t];for(const o of s){const a=o.match(/(?:cluster|hex)[-_]?([123])\b/);if(a)return Number(a[1]);if(o.includes("1-hex")||o.includes("single"))return 1;if(o.includes("2-hex")||o.includes("double"))return 2;if(o.includes("3-hex")||o.includes("triple"))return 3}return 1},VC=({assetManifest:e,biomeThemeKey:t,biomeSeed:s,mountainAssetPathOverride:o,wallsMountainPath:a,wallsThemeMountainPath:l,clutterLayer:u,cells:f,tileVisualFlags:p,boardProps:m,resolveMountainSettings:y})=>{const b=N.useMemo(()=>{const M=(e?.assets||[]).filter(I=>{if(I.type!=="prop")return!1;const D=I.id.toLowerCase(),j=new Set((I.tags||[]).map(se=>se.toLowerCase()));if(!(D.includes("mountain")||j.has("mountain")))return!1;if(!I.theme)return!0;const q=I.theme.toLowerCase();return q===t||q==="core"}).sort((I,D)=>I.id.localeCompare(D.id)),k=String(l||a||"").trim(),R=String(o||k).trim();if(!R)return M;const O=M.find(I=>I.path===R);return O?[O]:[]},[e?.assets,t,o,a,l]),v=N.useMemo(()=>{const w=new Map;for(const M of b)w.set(M.id,y(M));return w},[b,y]),T=N.useMemo(()=>{if(!b.length)return[];const w=b.filter(R=>zC(R)===1),M=w.length?w:b,k=f.filter(R=>p.get(ce(R))?.isWall).sort((R,O)=>ce(R).localeCompare(ce(O)));return k.length?k.map(R=>{const O=ce(R),I=Math.floor(jo(`${s}|mountain-tile|${O}|asset`)*M.length)%M.length,D=M[I],j=v.get(D.id)||y(D),{y:U}=Ae(R,G);return{id:`mountain-${O}-${D.id}`,kind:"mountain",position:R,asset:D,renderScale:j.scale,zAnchorY:U+G*.42+j.offsetY}}):[]},[b,f,p,s,v,y]),S=N.useMemo(()=>{const w=new Set((u?.tags?.length?u.tags:["clutter","obstacle"]).map(M=>M.toLowerCase()));return(e?.assets||[]).filter(M=>{if(M.type!=="prop"&&M.type!=="decal"||M.id.toLowerCase().includes("mountain"))return!1;const R=(M.tags||[]).map(O=>O.toLowerCase());return R.includes("mountain")||!R.some(O=>w.has(O))?!1:M.theme?M.theme.toLowerCase()===t||M.theme.toLowerCase()==="core":!0})},[e?.assets,u?.tags,t]),x=N.useMemo(()=>{if(!S.length)return[];const w=Math.min(.6,Math.max(0,Number(u?.density??.08))),M=Math.max(1,Math.floor(Number(u?.maxPerHex??1))),k=Math.min(2,Math.max(1,Number(u?.bleedScaleMax??2))),R=[];for(const O of f){const I=ce(O),D=p.get(I);if(D?.isWall||D?.isLava||D?.isFire)continue;const{y:j}=Ae(O,G);for(let U=0;U<M;U++){if(jo(`${s}|clutter|${I}|slot:${U}|roll`)>w/(U+1))continue;const se=Math.floor(jo(`${s}|clutter|${I}|slot:${U}|pick`)*S.length)%S.length,ee=S[se],oe=1+jo(`${s}|clutter|${I}|slot:${U}|scale`)*(k-1),F=(jo(`${s}|clutter|${I}|slot:${U}|depth`)-.5)*G*.28;R.push({id:`clutter-${I}-${U}-${ee.id}`,kind:"clutter",position:O,asset:ee,renderScale:oe,zAnchorY:j+F})}}return R},[f,p,S,u?.density,u?.maxPerHex,u?.bleedScaleMax,s]),_=N.useMemo(()=>{const w=[...T,...x];for(const M of m){const{y:k}=Ae(M.position,G),R=M.kind==="shrine";w.push({id:M.id,kind:M.kind,position:M.position,asset:M.asset,renderScale:Math.min(2,R?1.5:1.42),zAnchorY:k+(R?G*.32:G*.28),fallback:M.kind})}return w.sort((M,k)=>M.zAnchorY===k.zAnchorY?M.id.localeCompare(k.id):M.zAnchorY-k.zAnchorY),w},[T,x,m]),E=N.useMemo(()=>{const w=new Set;for(const M of T)w.add(ce(M.position));return w},[T]);return{mountainSettingsByAssetId:v,depthSortedSprites:_,mountainCoveredWallKeys:E}},rf="/Hop",Ab=/^[a-z0-9]+(?:[._-][a-z0-9]+)*$/,Jo=/^\/assets\/[a-z0-9/_\-.]+$/,_f=["ground","decal","prop","unit","fx","ui"],YC=["svg","webp","avif","png","jpg","jpeg"],Dg=["svg","webp","avif","png"],Ug=["svg","webp","avif","png","jpg","jpeg"],$g=["svg","webp","avif","png"],qg=["svg"],lf=(e,t)=>`${e.endsWith("/")?e:`${e}/`}${t.replace(/^\/+/,"")}`,KC=lf(rf,"assets/manifest.json"),Os=e=>/^(?:[a-z]+:)?\/\//i.test(e)||e.startsWith("data:")?e:e.startsWith("/")?e.startsWith("/assets/")?lf(rf,e.slice(1)):e:lf(rf,e),Ra=e=>{if(e)return{...e,default:Os(e.default),themes:Object.fromEntries(Object.entries(e.themes||{}).map(([t,s])=>[t,Os(s)]))}},zg=e=>{if(e)return{...e,scale:e.scale??e.mountainScale,offsetX:e.offsetX??e.mountainOffsetX,offsetY:e.offsetY??e.mountainOffsetY,anchorX:e.anchorX??e.mountainAnchorX,anchorY:e.anchorY??e.mountainAnchorY,crustBlendMode:e.crustBlendMode??e.mountainCrustBlendMode,crustBlendOpacity:e.crustBlendOpacity??e.mountainCrustBlendOpacity,tintColor:e.tintColor??e.mountainTintColor,tintBlendMode:e.tintBlendMode??e.mountainTintBlendMode,tintOpacity:e.tintOpacity??e.mountainTintOpacity}},FC=e=>{if(e)return{...e,themes:Object.fromEntries(Object.entries(e.themes||{}).map(([t,s])=>[t,String(s)]))}},Gl=e=>{if(e)return{detailA:Ra(e.detailA),detailB:Ra(e.detailB),tint:FC(e.tint)}},cf=e=>{if(e)return{...e}},xb=e=>{if(!e)return;const t=zg(e);return{...t,mountainPath:t?.mountainPath?Os(t.mountainPath):t?.mountainPath,themes:Object.fromEntries(Object.entries(e.themes||{}).map(([s,o])=>[s,{...zg(o),mountainPath:o?.mountainPath?Os(o.mountainPath):o?.mountainPath}]))}},WC=e=>{if(e)return{...e,biomeLayers:e.biomeLayers?{undercurrent:Ra(e.biomeLayers.undercurrent),crust:Ra(e.biomeLayers.crust),clutter:e.biomeLayers.clutter?{...e.biomeLayers.clutter,tags:[...e.biomeLayers.clutter.tags||[]]}:void 0}:void 0,biomeMaterials:e.biomeMaterials?{undercurrent:Gl(e.biomeMaterials.undercurrent),crust:Gl(e.biomeMaterials.crust)}:void 0,walls:xb(e.walls),assetOverrides:Object.fromEntries(Object.entries(e.assetOverrides||{}).map(([t,s])=>[t,{...s,mountainSettings:cf(s?.mountainSettings)}]))}},XC=e=>({...e,biomeUnderlay:e.biomeUnderlay?{...e.biomeUnderlay,default:Os(e.biomeUnderlay.default),themes:Object.fromEntries(Object.entries(e.biomeUnderlay.themes||{}).map(([t,s])=>[t,Os(s)]))}:void 0,biomeLayers:e.biomeLayers?{undercurrent:Ra(e.biomeLayers.undercurrent),crust:Ra(e.biomeLayers.crust),clutter:e.biomeLayers.clutter?{...e.biomeLayers.clutter,tags:[...e.biomeLayers.clutter.tags||[]]}:void 0}:void 0,biomeMaterials:e.biomeMaterials?{undercurrent:Gl(e.biomeMaterials.undercurrent),crust:Gl(e.biomeMaterials.crust)}:void 0,walls:xb(e.walls),biomePresets:Object.fromEntries(Object.entries(e.biomePresets||{}).map(([t,s])=>[t,WC(s)||{}])),assets:e.assets.map(t=>({...t,path:Os(t.path),mountainSettings:cf(t.mountainSettings),mountainSettingsByTheme:Object.fromEntries(Object.entries(t.mountainSettingsByTheme||{}).map(([s,o])=>[s,cf(o)||{}]))}))}),Vg={version:"1.0.0",gridTopology:"flat-top-hex",tileUnitPx:256,tileAspectRatio:1.154700538,layers:[..._f],assets:[]};let vl=null;const Yg=e=>typeof e=="string"&&_f.includes(e),Kg=e=>typeof e=="string"&&["tile","decal","prop","unit","fx","ui"].includes(e),Fg=e=>typeof e=="string"&&YC.includes(e),ks=(e,t,s)=>{if(!e||typeof e!="object"){s.push(`"${t}" must be an object when provided.`);return}if((typeof e.default!="string"||!Jo.test(e.default))&&s.push(`"${t}.default" must be a /assets/... path.`),e.themes!==void 0)if(!e.themes||typeof e.themes!="object")s.push(`"${t}.themes" must be an object when provided.`);else for(const[o,a]of Object.entries(e.themes))(typeof o!="string"||o.trim().length===0)&&s.push(`"${t}.themes" contains an invalid theme key.`),(typeof a!="string"||!Jo.test(a))&&s.push(`"${t}.themes.${o}" must be a /assets/... path.`);if(e.mode!==void 0&&e.mode!=="off"&&e.mode!=="cover"&&e.mode!=="repeat"&&s.push(`"${t}.mode" must be one of "off", "cover", or "repeat".`),e.scalePx!==void 0&&(!Number.isFinite(e.scalePx)||Number(e.scalePx)<=0)&&s.push(`"${t}.scalePx" must be > 0 when provided.`),e.opacity!==void 0&&(!Number.isFinite(e.opacity)||Number(e.opacity)<0||Number(e.opacity)>1)&&s.push(`"${t}.opacity" must be in [0, 1] when provided.`),e.seedShiftPx!==void 0&&(!Number.isFinite(e.seedShiftPx)||Number(e.seedShiftPx)<0)&&s.push(`"${t}.seedShiftPx" must be >= 0 when provided.`),e.offsetX!==void 0&&!Number.isFinite(e.offsetX)&&s.push(`"${t}.offsetX" must be a finite number when provided.`),e.offsetY!==void 0&&!Number.isFinite(e.offsetY)&&s.push(`"${t}.offsetY" must be a finite number when provided.`),e.scroll!==void 0){const o=e.scroll;!o||typeof o!="object"?s.push(`"${t}.scroll" must be an object when provided.`):(o.x!==void 0&&!Number.isFinite(o.x)&&s.push(`"${t}.scroll.x" must be a finite number.`),o.y!==void 0&&!Number.isFinite(o.y)&&s.push(`"${t}.scroll.y" must be a finite number.`),o.durationMs!==void 0&&(!Number.isFinite(o.durationMs)||Number(o.durationMs)<=0)&&s.push(`"${t}.scroll.durationMs" must be > 0 when provided.`))}},GC=(e,t,s)=>{if(!e||typeof e!="object"){s.push(`"${t}" must be an object when provided.`);return}if((typeof e.default!="string"||e.default.trim().length===0)&&s.push(`"${t}.default" must be a non-empty color string.`),e.themes!==void 0)if(!e.themes||typeof e.themes!="object")s.push(`"${t}.themes" must be an object when provided.`);else for(const[o,a]of Object.entries(e.themes))(typeof o!="string"||o.trim().length===0)&&s.push(`"${t}.themes" contains an invalid theme key.`),(typeof a!="string"||a.trim().length===0)&&s.push(`"${t}.themes.${o}" must be a non-empty color string.`);e.opacity!==void 0&&(!Number.isFinite(e.opacity)||Number(e.opacity)<0||Number(e.opacity)>1)&&s.push(`"${t}.opacity" must be in [0, 1] when provided.`),e.blendMode!==void 0&&e.blendMode!=="normal"&&e.blendMode!=="multiply"&&e.blendMode!=="overlay"&&e.blendMode!=="soft-light"&&e.blendMode!=="screen"&&e.blendMode!=="color-dodge"&&s.push(`"${t}.blendMode" must be one of "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`)},Qo=(e,t,s)=>{if(!e||typeof e!="object"){s.push(`"${t}" must be an object when provided.`);return}e.scale!==void 0&&(!Number.isFinite(e.scale)||Number(e.scale)<=0)&&s.push(`"${t}.scale" must be > 0 when provided.`),e.offsetX!==void 0&&!Number.isFinite(e.offsetX)&&s.push(`"${t}.offsetX" must be a finite number when provided.`),e.offsetY!==void 0&&!Number.isFinite(e.offsetY)&&s.push(`"${t}.offsetY" must be a finite number when provided.`),e.anchorX!==void 0&&(!Number.isFinite(e.anchorX)||Number(e.anchorX)<0||Number(e.anchorX)>1)&&s.push(`"${t}.anchorX" must be in [0, 1] when provided.`),e.anchorY!==void 0&&(!Number.isFinite(e.anchorY)||Number(e.anchorY)<0||Number(e.anchorY)>1)&&s.push(`"${t}.anchorY" must be in [0, 1] when provided.`),e.crustBlendMode!==void 0&&e.crustBlendMode!=="off"&&e.crustBlendMode!=="normal"&&e.crustBlendMode!=="multiply"&&e.crustBlendMode!=="overlay"&&e.crustBlendMode!=="soft-light"&&e.crustBlendMode!=="screen"&&e.crustBlendMode!=="color-dodge"&&s.push(`"${t}.crustBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.tintBlendMode!==void 0&&e.tintBlendMode!=="off"&&e.tintBlendMode!=="normal"&&e.tintBlendMode!=="multiply"&&e.tintBlendMode!=="overlay"&&e.tintBlendMode!=="soft-light"&&e.tintBlendMode!=="screen"&&e.tintBlendMode!=="color-dodge"&&s.push(`"${t}.tintBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.crustBlendOpacity!==void 0&&(!Number.isFinite(e.crustBlendOpacity)||Number(e.crustBlendOpacity)<0||Number(e.crustBlendOpacity)>1)&&s.push(`"${t}.crustBlendOpacity" must be in [0, 1] when provided.`),e.tintOpacity!==void 0&&(!Number.isFinite(e.tintOpacity)||Number(e.tintOpacity)<0||Number(e.tintOpacity)>1)&&s.push(`"${t}.tintOpacity" must be in [0, 1] when provided.`),e.tintColor!==void 0&&(typeof e.tintColor!="string"||e.tintColor.trim().length===0)&&s.push(`"${t}.tintColor" must be a non-empty color string when provided.`)},Tb=(e,t,s)=>{if(!e||typeof e!="object"){s.push(`"${t}" must be an object when provided.`);return}if(e.mode!==void 0&&e.mode!=="native"&&e.mode!=="additive"&&e.mode!=="custom"&&s.push(`"${t}.mode" must be one of "native", "additive", or "custom".`),e.interiorDensity!==void 0&&(!Number.isFinite(e.interiorDensity)||Number(e.interiorDensity)<0||Number(e.interiorDensity)>1)&&s.push(`"${t}.interiorDensity" must be in [0, 1] when provided.`),e.clusterBias!==void 0&&(!Number.isFinite(e.clusterBias)||Number(e.clusterBias)<0||Number(e.clusterBias)>1)&&s.push(`"${t}.clusterBias" must be in [0, 1] when provided.`),e.keepPerimeter!==void 0&&typeof e.keepPerimeter!="boolean"&&s.push(`"${t}.keepPerimeter" must be a boolean when provided.`),e.mountainPath!==void 0&&(typeof e.mountainPath!="string"||!Jo.test(e.mountainPath))&&s.push(`"${t}.mountainPath" must be a /assets/... path when provided.`),e.mountainScale!==void 0&&(!Number.isFinite(e.mountainScale)||Number(e.mountainScale)<=0)&&s.push(`"${t}.mountainScale" must be > 0 when provided.`),e.mountainOffsetX!==void 0&&!Number.isFinite(e.mountainOffsetX)&&s.push(`"${t}.mountainOffsetX" must be a finite number when provided.`),e.mountainOffsetY!==void 0&&!Number.isFinite(e.mountainOffsetY)&&s.push(`"${t}.mountainOffsetY" must be a finite number when provided.`),e.mountainAnchorX!==void 0&&(!Number.isFinite(e.mountainAnchorX)||Number(e.mountainAnchorX)<0||Number(e.mountainAnchorX)>1)&&s.push(`"${t}.mountainAnchorX" must be in [0, 1] when provided.`),e.mountainAnchorY!==void 0&&(!Number.isFinite(e.mountainAnchorY)||Number(e.mountainAnchorY)<0||Number(e.mountainAnchorY)>1)&&s.push(`"${t}.mountainAnchorY" must be in [0, 1] when provided.`),e.mountainCrustBlendMode!==void 0&&e.mountainCrustBlendMode!=="off"&&e.mountainCrustBlendMode!=="normal"&&e.mountainCrustBlendMode!=="multiply"&&e.mountainCrustBlendMode!=="overlay"&&e.mountainCrustBlendMode!=="soft-light"&&e.mountainCrustBlendMode!=="screen"&&e.mountainCrustBlendMode!=="color-dodge"&&s.push(`"${t}.mountainCrustBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.mountainCrustBlendOpacity!==void 0&&(!Number.isFinite(e.mountainCrustBlendOpacity)||Number(e.mountainCrustBlendOpacity)<0||Number(e.mountainCrustBlendOpacity)>1)&&s.push(`"${t}.mountainCrustBlendOpacity" must be in [0, 1] when provided.`),e.mountainTintColor!==void 0&&(typeof e.mountainTintColor!="string"||e.mountainTintColor.trim().length===0)&&s.push(`"${t}.mountainTintColor" must be a non-empty color string when provided.`),e.mountainTintBlendMode!==void 0&&e.mountainTintBlendMode!=="off"&&e.mountainTintBlendMode!=="normal"&&e.mountainTintBlendMode!=="multiply"&&e.mountainTintBlendMode!=="overlay"&&e.mountainTintBlendMode!=="soft-light"&&e.mountainTintBlendMode!=="screen"&&e.mountainTintBlendMode!=="color-dodge"&&s.push(`"${t}.mountainTintBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.mountainTintOpacity!==void 0&&(!Number.isFinite(e.mountainTintOpacity)||Number(e.mountainTintOpacity)<0||Number(e.mountainTintOpacity)>1)&&s.push(`"${t}.mountainTintOpacity" must be in [0, 1] when provided.`),Qo(e,t,s),e.themes!==void 0)if(!e.themes||typeof e.themes!="object")s.push(`"${t}.themes" must be an object when provided.`);else for(const[o,a]of Object.entries(e.themes)){if(typeof o!="string"||o.trim().length===0){s.push(`"${t}.themes" contains an invalid theme key.`);continue}if(!a||typeof a!="object"){s.push(`"${t}.themes.${o}" must be an object.`);continue}a.mountainPath!==void 0&&(typeof a.mountainPath!="string"||!Jo.test(a.mountainPath))&&s.push(`"${t}.themes.${o}.mountainPath" must be a /assets/... path when provided.`);const l=a;l.mountainScale!==void 0&&(!Number.isFinite(l.mountainScale)||Number(l.mountainScale)<=0)&&s.push(`"${t}.themes.${o}.mountainScale" must be > 0 when provided.`),l.mountainOffsetX!==void 0&&!Number.isFinite(l.mountainOffsetX)&&s.push(`"${t}.themes.${o}.mountainOffsetX" must be a finite number when provided.`),l.mountainOffsetY!==void 0&&!Number.isFinite(l.mountainOffsetY)&&s.push(`"${t}.themes.${o}.mountainOffsetY" must be a finite number when provided.`),l.mountainAnchorX!==void 0&&(!Number.isFinite(l.mountainAnchorX)||Number(l.mountainAnchorX)<0||Number(l.mountainAnchorX)>1)&&s.push(`"${t}.themes.${o}.mountainAnchorX" must be in [0, 1] when provided.`),l.mountainAnchorY!==void 0&&(!Number.isFinite(l.mountainAnchorY)||Number(l.mountainAnchorY)<0||Number(l.mountainAnchorY)>1)&&s.push(`"${t}.themes.${o}.mountainAnchorY" must be in [0, 1] when provided.`),l.mountainCrustBlendMode!==void 0&&l.mountainCrustBlendMode!=="off"&&l.mountainCrustBlendMode!=="normal"&&l.mountainCrustBlendMode!=="multiply"&&l.mountainCrustBlendMode!=="overlay"&&l.mountainCrustBlendMode!=="soft-light"&&l.mountainCrustBlendMode!=="screen"&&l.mountainCrustBlendMode!=="color-dodge"&&s.push(`"${t}.themes.${o}.mountainCrustBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),l.mountainCrustBlendOpacity!==void 0&&(!Number.isFinite(l.mountainCrustBlendOpacity)||Number(l.mountainCrustBlendOpacity)<0||Number(l.mountainCrustBlendOpacity)>1)&&s.push(`"${t}.themes.${o}.mountainCrustBlendOpacity" must be in [0, 1] when provided.`),l.mountainTintBlendMode!==void 0&&l.mountainTintBlendMode!=="off"&&l.mountainTintBlendMode!=="normal"&&l.mountainTintBlendMode!=="multiply"&&l.mountainTintBlendMode!=="overlay"&&l.mountainTintBlendMode!=="soft-light"&&l.mountainTintBlendMode!=="screen"&&l.mountainTintBlendMode!=="color-dodge"&&s.push(`"${t}.themes.${o}.mountainTintBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),l.mountainTintOpacity!==void 0&&(!Number.isFinite(l.mountainTintOpacity)||Number(l.mountainTintOpacity)<0||Number(l.mountainTintOpacity)>1)&&s.push(`"${t}.themes.${o}.mountainTintOpacity" must be in [0, 1] when provided.`),l.mountainTintColor!==void 0&&(typeof l.mountainTintColor!="string"||l.mountainTintColor.trim().length===0)&&s.push(`"${t}.themes.${o}.mountainTintColor" must be a non-empty color string when provided.`),Qo(a,`${t}.themes.${o}`,s)}},Jl=(e,t,s)=>{if(!e||typeof e!="object"){s.push(`"${t}" must be an object when provided.`);return}e.detailA!==void 0&&ks(e.detailA,`${t}.detailA`,s),e.detailB!==void 0&&ks(e.detailB,`${t}.detailB`,s),e.tint!==void 0&&GC(e.tint,`${t}.tint`,s),e.detailA===void 0&&e.detailB===void 0&&e.tint===void 0&&s.push(`"${t}" must define at least one of "detailA", "detailB", or "tint".`)},JC=(e,t,s)=>{if(!e||typeof e!="object"){s.push(`"${t}" must be an object when provided.`);return}if(e.seed!==void 0&&(typeof e.seed!="string"||e.seed.trim().length===0)&&s.push(`"${t}.seed" must be a non-empty string when provided.`),e.injectHazards!==void 0&&typeof e.injectHazards!="boolean"&&s.push(`"${t}.injectHazards" must be a boolean when provided.`),e.biomeLayers!==void 0){const o=e.biomeLayers;if(!o||typeof o!="object")s.push(`"${t}.biomeLayers" must be an object when provided.`);else if(o.undercurrent!==void 0&&ks(o.undercurrent,`${t}.biomeLayers.undercurrent`,s),o.crust!==void 0&&ks(o.crust,`${t}.biomeLayers.crust`,s),o.clutter!==void 0){const a=o.clutter;!a||typeof a!="object"?s.push(`"${t}.biomeLayers.clutter" must be an object when provided.`):(a.density!==void 0&&(!Number.isFinite(a.density)||Number(a.density)<0||Number(a.density)>1)&&s.push(`"${t}.biomeLayers.clutter.density" must be in [0, 1] when provided.`),a.maxPerHex!==void 0&&(!Number.isFinite(a.maxPerHex)||Number(a.maxPerHex)<0)&&s.push(`"${t}.biomeLayers.clutter.maxPerHex" must be >= 0 when provided.`),a.bleedScaleMax!==void 0&&(!Number.isFinite(a.bleedScaleMax)||Number(a.bleedScaleMax)<1||Number(a.bleedScaleMax)>2)&&s.push(`"${t}.biomeLayers.clutter.bleedScaleMax" must be within [1, 2] when provided.`),a.tags!==void 0&&(!Array.isArray(a.tags)||!a.tags.every(l=>typeof l=="string"&&l.length>0))&&s.push(`"${t}.biomeLayers.clutter.tags" must be a string array when provided.`))}}if(e.biomeMaterials!==void 0){const o=e.biomeMaterials;!o||typeof o!="object"?s.push(`"${t}.biomeMaterials" must be an object when provided.`):(o.undercurrent!==void 0&&Jl(o.undercurrent,`${t}.biomeMaterials.undercurrent`,s),o.crust!==void 0&&Jl(o.crust,`${t}.biomeMaterials.crust`,s))}if(e.walls!==void 0&&Tb(e.walls,`${t}.walls`,s),e.assetOverrides!==void 0)if(!e.assetOverrides||typeof e.assetOverrides!="object")s.push(`"${t}.assetOverrides" must be an object when provided.`);else for(const[o,a]of Object.entries(e.assetOverrides)){if(!Ab.test(o)){s.push(`"${t}.assetOverrides" contains invalid asset id "${o}".`);continue}if(!a||typeof a!="object"){s.push(`"${t}.assetOverrides.${o}" must be an object.`);continue}a.mountainSettings!==void 0&&Qo(a.mountainSettings,`${t}.assetOverrides.${o}.mountainSettings`,s)}},QC=e=>{const t=[];if(!e||typeof e!="object")return{valid:!1,errors:["Manifest is not an object."]};const s=e;if((typeof s.version!="string"||s.version.length===0)&&t.push('Missing or invalid "version".'),s.gridTopology!=="flat-top-hex"&&t.push('Only "flat-top-hex" gridTopology is supported.'),(!Number.isFinite(s.tileUnitPx)||Number(s.tileUnitPx)<=0)&&t.push('Missing or invalid "tileUnitPx".'),(!Number.isFinite(s.tileAspectRatio)||Number(s.tileAspectRatio)<=0)&&t.push('Missing or invalid "tileAspectRatio".'),s.biomeUnderlay!==void 0&&ks(s.biomeUnderlay,"biomeUnderlay",t),s.biomeLayers!==void 0){const a=s.biomeLayers;if(!a||typeof a!="object")t.push('"biomeLayers" must be an object when provided.');else if(a.undercurrent!==void 0&&ks(a.undercurrent,"biomeLayers.undercurrent",t),a.crust!==void 0&&ks(a.crust,"biomeLayers.crust",t),!a.undercurrent&&!a.crust&&t.push('"biomeLayers" must define at least one of "undercurrent" or "crust".'),a.clutter!==void 0){const l=a.clutter;!l||typeof l!="object"?t.push('"biomeLayers.clutter" must be an object when provided.'):(l.density!==void 0&&(!Number.isFinite(l.density)||Number(l.density)<0||Number(l.density)>1)&&t.push('"biomeLayers.clutter.density" must be in [0, 1] when provided.'),l.maxPerHex!==void 0&&(!Number.isFinite(l.maxPerHex)||Number(l.maxPerHex)<0)&&t.push('"biomeLayers.clutter.maxPerHex" must be >= 0 when provided.'),l.bleedScaleMax!==void 0&&(!Number.isFinite(l.bleedScaleMax)||Number(l.bleedScaleMax)<1||Number(l.bleedScaleMax)>2)&&t.push('"biomeLayers.clutter.bleedScaleMax" must be within [1, 2] when provided.'),l.tags!==void 0&&(!Array.isArray(l.tags)||!l.tags.every(u=>typeof u=="string"&&u.length>0))&&t.push('"biomeLayers.clutter.tags" must be a string array when provided.'))}}if(s.biomeMaterials!==void 0){const a=s.biomeMaterials;!a||typeof a!="object"?t.push('"biomeMaterials" must be an object when provided.'):(a.undercurrent!==void 0&&Jl(a.undercurrent,"biomeMaterials.undercurrent",t),a.crust!==void 0&&Jl(a.crust,"biomeMaterials.crust",t),a.undercurrent===void 0&&a.crust===void 0&&t.push('"biomeMaterials" must define at least one of "undercurrent" or "crust".'))}if(s.walls!==void 0&&Tb(s.walls,"walls",t),s.biomePresets!==void 0)if(!s.biomePresets||typeof s.biomePresets!="object")t.push('"biomePresets" must be an object when provided.');else for(const[a,l]of Object.entries(s.biomePresets)){if(typeof a!="string"||a.trim().length===0){t.push('"biomePresets" contains an invalid theme key.');continue}JC(l,`biomePresets.${a}`,t)}if(!Array.isArray(s.layers)||s.layers.length===0||!s.layers.every(Yg))t.push('Missing or invalid "layers".');else for(const a of _f)s.layers.includes(a)||t.push(`Missing required layer "${a}" in "layers".`);if(!Array.isArray(s.assets))return t.push('Missing or invalid "assets".'),{valid:t.length===0,errors:t};const o=new Set;for(const[a,l]of s.assets.entries()){const u=`assets[${a}]`;if(!l||typeof l!="object"){t.push(`${u} is not an object.`);continue}const f=l;if(typeof f.id!="string"||!Ab.test(f.id)?t.push(`${u}.id is invalid; expected lowercase tokenized id.`):o.has(f.id)?t.push(`${u}.id is duplicated (${f.id}).`):o.add(f.id),Kg(f.type)||t.push(`${u}.type is invalid.`),Yg(f.layer)||t.push(`${u}.layer is invalid.`),Fg(f.recommendedFormat)||t.push(`${u}.recommendedFormat is invalid.`),Kg(f.type)&&Fg(f.recommendedFormat)&&((f.type==="tile"||f.type==="decal"||f.type==="prop")&&!Ug.includes(f.recommendedFormat)&&t.push(`${u}.recommendedFormat must be one of ${Ug.join(", ")} for ${f.type}.`),f.type==="ui"&&!qg.includes(f.recommendedFormat)&&t.push(`${u}.recommendedFormat must be one of ${qg.join(", ")} for ui.`),f.type==="unit"&&!Dg.includes(f.recommendedFormat)&&t.push(`${u}.recommendedFormat must be one of ${Dg.join(", ")} for units.`),f.type==="fx"&&!$g.includes(f.recommendedFormat)&&t.push(`${u}.recommendedFormat must be one of ${$g.join(", ")} for fx.`)),(typeof f.path!="string"||!Jo.test(f.path))&&t.push(`${u}.path is invalid; expected /assets/...`),(!Number.isFinite(f.width)||Number(f.width)<=0)&&t.push(`${u}.width must be > 0.`),(!Number.isFinite(f.height)||Number(f.height)<=0)&&t.push(`${u}.height must be > 0.`),f.mountainSettings!==void 0&&Qo(f.mountainSettings,`${u}.mountainSettings`,t),f.mountainSettingsByTheme!==void 0)if(!f.mountainSettingsByTheme||typeof f.mountainSettingsByTheme!="object")t.push(`${u}.mountainSettingsByTheme must be an object when provided.`);else for(const[p,m]of Object.entries(f.mountainSettingsByTheme)){if(typeof p!="string"||p.trim().length===0){t.push(`${u}.mountainSettingsByTheme contains an invalid theme key.`);continue}Qo(m,`${u}.mountainSettingsByTheme.${p}`,t)}}return{valid:t.length===0,errors:t}},ZC=async()=>vl||(vl=fetch(KC).then(async e=>{if(!e.ok)throw new Error(`Asset manifest fetch failed: ${e.status}`);return e.json()}).then(e=>{const t=QC(e);return t.valid?XC(e):(console.warn("[HOP_ASSETS] Invalid manifest; using fallback.",t.errors),Vg)}).catch(e=>(console.warn("[HOP_ASSETS] Failed to load manifest; using fallback.",e),Vg)),vl),Mf=(e,t)=>{if(!e)return;const s=String(t||"").toLowerCase();if(s)return e.biomePresets?.[s]},$d=e=>{let t=2166136261;for(let s=0;s<e.length;s++)t^=e.charCodeAt(s),t=Math.imul(t,16777619);return t>>>0},Al=(e,t)=>{if(e)return t&&e.themes?.[t]?e.themes[t]:e.default},xl=e=>e?e.mode==="cover"||e.mode==="repeat"||e.mode==="off"?e.mode:"cover":"off",qd=e=>Math.min(1,Math.max(0,Number(e?.opacity??1))),Tl=(e,t,s=64,o=Number.POSITIVE_INFINITY)=>{const a=Number(e?.scalePx||t);return Math.min(o,Math.max(s,a))},Wg=e=>({x:Number(e?.scroll?.x??0),y:Number(e?.scroll?.y??0),durationMs:Math.max(1e3,Number(e?.scroll?.durationMs??18e3))}),eO=(e,t)=>{if(e)return t&&e.themes?.[t]?e.themes[t]:e.default},tO=e=>Math.min(1,Math.max(0,Number(e?.opacity??0))),Eb=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",_b=(e,t="#8b6f4a")=>{const s=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(s))return s.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(s)){const[l,u,f]=s.slice(1).split("");return`#${l}${l}${u}${u}${f}${f}`.toLowerCase()}return t},nO=e=>{const s=_b(e).slice(1);return{r:parseInt(s.slice(0,2),16)/255,g:parseInt(s.slice(2,4),16)/255,b:parseInt(s.slice(4,6),16)/255}},Xg=(e,t)=>e==="off"?"off":e?Eb(e):t,Gg=e=>{const t=[];for(let s=0;s<6;s++){const o=Math.PI/180*(60*s);t.push(`${e*Math.cos(o)},${e*Math.sin(o)}`)}return t.join(" ")},iO=({asset:e,biomeThemeKey:t,biomeDebug:s,biomeThemePreset:o,wallsProfile:a,wallsThemeOverride:l,crustTintBlendMode:u,crustTintColor:f,defaultMountainCrustBlendOpacity:p})=>{const m=e?.mountainSettings,y=e?.mountainSettingsByTheme?.[t],v=(e?o?.assetOverrides?.[e.id]:void 0)?.mountainSettings,T=Math.min(3,Math.max(.2,Number(s?.mountainScale??v?.scale??y?.scale??l?.scale??a?.scale??m?.scale??.95))),S=Number(s?.mountainOffset?.x??v?.offsetX??y?.offsetX??l?.offsetX??a?.offsetX??m?.offsetX??0),x=Number(s?.mountainOffset?.y??v?.offsetY??y?.offsetY??l?.offsetY??a?.offsetY??m?.offsetY??0),_=Math.min(1,Math.max(0,Number(s?.mountainAnchor?.x??v?.anchorX??y?.anchorX??l?.anchorX??a?.anchorX??m?.anchorX??.5))),E=Math.min(1,Math.max(0,Number(s?.mountainAnchor?.y??v?.anchorY??y?.anchorY??l?.anchorY??a?.anchorY??m?.anchorY??.78))),w=Xg(s?.mountainCrustBlendMode??v?.crustBlendMode??y?.crustBlendMode??l?.crustBlendMode??a?.crustBlendMode??m?.crustBlendMode,u),M=Math.min(1,Math.max(0,Number(s?.mountainCrustBlendOpacity??v?.crustBlendOpacity??y?.crustBlendOpacity??l?.crustBlendOpacity??a?.crustBlendOpacity??m?.crustBlendOpacity??p))),k=_b(String(s?.mountainTintColor??v?.tintColor??y?.tintColor??l?.tintColor??a?.tintColor??m?.tintColor??f??"#8b6f4a")),R=Xg(s?.mountainTintBlendMode??v?.tintBlendMode??y?.tintBlendMode??l?.tintBlendMode??a?.tintBlendMode??m?.tintBlendMode,"soft-light"),O=Math.min(1,Math.max(0,Number(s?.mountainTintOpacity??v?.tintOpacity??y?.tintOpacity??l?.tintOpacity??a?.tintOpacity??m?.tintOpacity??0))),I=nO(k);return{scale:T,offsetX:S,offsetY:x,anchorX:_,anchorY:E,crustBlendMode:w,crustBlendOpacity:M,tintColor:k,tintBlendMode:R,tintOpacity:O,tintMatrixValues:`0 0 0 0 ${I.r.toFixed(4)} 0 0 0 0 ${I.g.toFixed(4)} 0 0 0 0 ${I.b.toFixed(4)} 0 0 0 1 0`}},sO=({cells:e,gameState:t,bounds:s,assetManifest:o,biomeDebug:a})=>{const l=N.useMemo(()=>{const _e=new Map;for(const ht of e){const Bt=ce(ht),rt=we.getTraitsAt(t,ht),pn=rt.has("BLOCKS_MOVEMENT")&&rt.has("BLOCKS_LOS"),on=rt.has("LAVA")||rt.has("HAZARDOUS")&&rt.has("LIQUID"),Ai=rt.has("FIRE");_e.set(Bt,{isWall:pn,isLava:!pn&&on,isFire:!pn&&Ai})}return _e},[e,t.tiles]),u=N.useMemo(()=>{const _e=new Map;for(const ht of o?.assets||[])_e.set(ht.id,ht);return _e},[o]),f=N.useMemo(()=>u.get(Mw())?.path,[u]),p=N.useMemo(()=>Math.max(1,o?.tileUnitPx||256),[o?.tileUnitPx]),m=N.useMemo(()=>G*2/p,[p]),y=N.useMemo(()=>String(t.theme||"").toLowerCase(),[t.theme]),b=N.useMemo(()=>`${t.initialSeed||t.rngSeed||t.turnNumber}:${t.floor}:${y}`,[t.initialSeed,t.rngSeed,t.turnNumber,t.floor,y]),v=N.useMemo(()=>Mf(o,y),[o,y]),T=N.useMemo(()=>{const _e=o?.biomeUnderlay;if(_e)return{default:_e.default,themes:_e.themes,mode:_e.mode,scalePx:_e.scalePx,opacity:_e.opacity}},[o?.biomeUnderlay]),S=N.useMemo(()=>v?.biomeLayers?.undercurrent||o?.biomeLayers?.undercurrent,[v?.biomeLayers?.undercurrent,o?.biomeLayers?.undercurrent]),x=N.useMemo(()=>v?.biomeLayers?.crust||o?.biomeLayers?.crust||T,[v?.biomeLayers?.crust,o?.biomeLayers?.crust,T]),_=N.useMemo(()=>v?.biomeLayers?.clutter||o?.biomeLayers?.clutter,[v?.biomeLayers?.clutter,o?.biomeLayers?.clutter]),E=N.useMemo(()=>Al(S,y),[S,y]),w=N.useMemo(()=>xl(S),[S]),M=N.useMemo(()=>Tl(S,p,64,192),[S,p]),k=N.useMemo(()=>qd(S),[S]),R=N.useMemo(()=>({x:Number(S?.scroll?.x??120),y:Number(S?.scroll?.y??90),durationMs:Math.max(1e3,Number(S?.scroll?.durationMs??92e3))}),[S?.scroll?.x,S?.scroll?.y,S?.scroll?.durationMs]),O=N.useMemo(()=>({x:Number(S?.offsetX??0)+Number(a?.undercurrentOffset?.x??0),y:Number(S?.offsetY??0)+Number(a?.undercurrentOffset?.y??0)}),[S?.offsetX,S?.offsetY,a?.undercurrentOffset?.x,a?.undercurrentOffset?.y]),I=N.useMemo(()=>Al(x,y),[x,y]),D=N.useMemo(()=>xl(x),[x]),j=N.useMemo(()=>Tl(x,p,64),[x,p]),U=1,q=N.useMemo(()=>{const _e=Math.max(0,Number(x?.seedShiftPx??G*5));if(_e===0)return{x:0,y:0};const ht=$d(`${b}|crust-offset`),Bt=((ht&65535)/65535*2-1)*_e,rt=((ht>>>16&65535)/65535*2-1)*_e;return{x:Bt,y:rt}},[x?.seedShiftPx,b]),se=N.useMemo(()=>({x:Number(x?.offsetX??0)+Number(a?.crustOffset?.x??0),y:Number(x?.offsetY??0)+Number(a?.crustOffset?.y??0)}),[x?.offsetX,x?.offsetY,a?.crustOffset?.x,a?.crustOffset?.y]),ee=N.useMemo(()=>({x:q.x+se.x,y:q.y+se.y}),[q.x,q.y,se.x,se.y]),oe=N.useMemo(()=>o?.walls,[o?.walls]),F=N.useMemo(()=>v?.walls||oe?.themes?.[y],[v?.walls,oe?.themes,y]),P=N.useMemo(()=>v?.biomeMaterials?.crust||o?.biomeMaterials?.crust,[v?.biomeMaterials?.crust,o?.biomeMaterials?.crust]),z=N.useMemo(()=>P?.detailA,[P?.detailA]),Z=N.useMemo(()=>P?.detailB,[P?.detailB]),re=N.useMemo(()=>Al(z,y),[z,y]),pe=N.useMemo(()=>Al(Z,y),[Z,y]),B=N.useMemo(()=>xl(z),[z]),W=N.useMemo(()=>xl(Z),[Z]),X=N.useMemo(()=>Tl(z,j,64),[z,j]),ae=N.useMemo(()=>Tl(Z,j,64),[Z,j]),le=N.useMemo(()=>qd(z),[z]),ue=N.useMemo(()=>qd(Z),[Z]),be=N.useMemo(()=>Wg(z),[z?.scroll?.x,z?.scroll?.y,z?.scroll?.durationMs]),$e=N.useMemo(()=>Wg(Z),[Z?.scroll?.x,Z?.scroll?.y,Z?.scroll?.durationMs]),Ee=N.useMemo(()=>{const _e=G*.75,ht=$d(`${b}|crust-detail-a-offset`),Bt=((ht&65535)/65535*2-1)*_e,rt=((ht>>>16&65535)/65535*2-1)*_e;return{x:Bt,y:rt}},[b]),at=N.useMemo(()=>{const _e=G*.75,ht=$d(`${b}|crust-detail-b-offset`),Bt=((ht&65535)/65535*2-1)*_e,rt=((ht>>>16&65535)/65535*2-1)*_e;return{x:Bt,y:rt}},[b]),ot=N.useMemo(()=>({x:ee.x+Ee.x,y:ee.y+Ee.y}),[ee.x,ee.y,Ee.x,Ee.y]),kt=N.useMemo(()=>({x:ee.x+at.x,y:ee.y+at.y}),[ee.x,ee.y,at.x,at.y]),wt=N.useMemo(()=>P?.tint,[P?.tint]),ke=N.useMemo(()=>eO(wt,y),[wt,y]),et=N.useMemo(()=>tO(wt),[wt?.opacity]),Gt=N.useMemo(()=>Eb(wt?.blendMode),[wt?.blendMode]),Ft=!!(ke&&et>0),Cn=N.useMemo(()=>Ft?Math.min(.55,Math.max(.15,et*.9)):0,[Ft,et]),jn=N.useCallback(_e=>iO({asset:_e,biomeThemeKey:y,biomeDebug:a,biomeThemePreset:v,wallsProfile:oe,wallsThemeOverride:F,crustTintBlendMode:Gt,crustTintColor:ke,defaultMountainCrustBlendOpacity:Cn}),[y,a,v?.assetOverrides,oe,F,Gt,ke,Cn]),Dn=!!(re&&B!=="off"&&le>0||pe&&W!=="off"&&ue>0||Ft),is=!!(E&&w!=="off"||I&&D!=="off"||Dn),Ia=N.useMemo(()=>`biome-undercurrent-${t.floor}`,[t.floor]),Ls=N.useMemo(()=>`biome-crust-${t.floor}`,[t.floor]),It=N.useMemo(()=>`biome-crust-mask-${t.floor}`,[t.floor]),La=N.useMemo(()=>`biome-crust-detail-a-${t.floor}`,[t.floor]),Bs=N.useMemo(()=>`biome-crust-detail-b-${t.floor}`,[t.floor]),Ps=!!(I&&D!=="off"||re&&B!=="off"&&le>0||pe&&W!=="off"&&ue>0||Ft),Kn=N.useMemo(()=>{const _e=[];for(const ht of e){const Bt=ce(ht),rt=l.get(Bt);if(!rt||!rt.isLava&&!rt.isFire)continue;const{x:pn,y:on}=Ae(ht,G);_e.push({key:Bt,x:pn,y:on})}return _e},[e,l]),ss=N.useMemo(()=>{const _e=Og({isStairs:!0});return _e?u.get(_e):void 0},[u]),as=N.useMemo(()=>{const _e=Og({isShrine:!0});return _e?u.get(_e):void 0},[u]),Ba=N.useMemo(()=>{const _e=[];return t.stairsPosition&&_e.push({id:`stairs-${ce(t.stairsPosition)}`,kind:"stairs",position:t.stairsPosition,asset:ss}),t.shrinePosition&&_e.push({id:`shrine-${ce(t.shrinePosition)}`,kind:"shrine",position:t.shrinePosition,asset:as}),_e},[t.stairsPosition,t.shrinePosition,ss,as]),Pa=N.useMemo(()=>Gg(G+1),[]),Fn=N.useMemo(()=>Gg(G-2),[]),Lt=N.useMemo(()=>`biome-map-clip-${t.floor}`,[t.floor]),mt=N.useMemo(()=>({x:s.minX-G*2,y:s.minY-G*2,width:s.width+G*4,height:s.height+G*4}),[s.minX,s.minY,s.width,s.height]),pt=N.useMemo(()=>{const _e=Math.max(Math.abs(Number(O?.x??0)),Math.abs(Number(O?.y??0)),Math.abs(Number(ee?.x??0)),Math.abs(Number(ee?.y??0)),Math.abs(Number(ot?.x??0)),Math.abs(Number(ot?.y??0)),Math.abs(Number(kt?.x??0)),Math.abs(Number(kt?.y??0)));return Math.min(G*32,Math.max(G*8,Math.ceil(_e+G*6)))},[O?.x,O?.y,ee?.x,ee?.y,ot?.x,ot?.y,kt?.x,kt?.y]),Ha=N.useMemo(()=>({x:mt.x-pt,y:mt.y-pt,width:mt.width+pt*2,height:mt.height+pt*2}),[mt.x,mt.y,mt.width,mt.height,pt]);return{tileVisualFlags:l,assetById:u,deathDecalHref:f,manifestUnitToBoardScale:m,biomeThemeKey:y,biomeSeed:b,clutterLayer:_,wallsProfile:oe,wallsThemeOverride:F,boardProps:Ba,resolveMountainSettings:jn,hybridInteractionLayerEnabled:is,backdropLayerProps:{biomeClipId:Lt,biomeClipPoints:Fn,maskHexPoints:Pa,biomeFrame:mt,biomeCoverFrame:Ha,undercurrentHref:E,undercurrentMode:w,undercurrentPatternId:Ia,undercurrentScalePx:M,undercurrentOffset:O,undercurrentScroll:R,undercurrentOpacity:k,crustHref:I,crustMode:D,crustPatternId:Ls,crustScalePx:j,crustPatternShift:ee,crustOpacity:U,crustDetailAHref:re,crustDetailAMode:B,crustDetailAPatternId:La,crustDetailAScalePx:X,crustDetailAShift:ot,crustDetailAScroll:be,crustDetailAOpacity:le,crustDetailBHref:pe,crustDetailBMode:W,crustDetailBPatternId:Bs,crustDetailBScalePx:ae,crustDetailBShift:kt,crustDetailBScroll:$e,crustDetailBOpacity:ue,crustMaskEnabled:Ps,crustMaskId:It,crustMaskHoles:Kn,crustTintActive:Ft,crustTintColor:ke,crustTintOpacity:et,crustTintBlendMode:Gt}}},aO=e=>e?oE(e):[],oO=({gameState:e,playerPos:t,selectedSkillId:s,showMovementRange:o,hoveredTile:a,enginePreviewGhost:l})=>{const u=N.useMemo(()=>{const x={};for(const _ of e.visualEvents||[]){if(_.type!=="kinetic_trace")continue;const E=_.payload;E?.actorId&&(x[E.actorId]=E)}return x},[e.visualEvents]),f=N.useMemo(()=>{if(!o||s)return[];const x=["BASIC_MOVE","DASH"],_=new Set(e.player.activeSkills.map(M=>M.id)),E=new Set,w=[];for(const M of x){if(!_.has(M))continue;const k=st.get(M);if(!k?.getValidTargets)continue;const R=k.getValidTargets(e,t);for(const O of R){const I=ce(O);E.has(I)||(E.add(I),w.push(O))}}return w},[o,s,e,t]),p=N.useMemo(()=>{const x=new Set;for(const _ of f)x.add(ce(_));return x},[f]),m=N.useMemo(()=>e.player.activeSkills.some(x=>x.id==="BASIC_MOVE"||x.id==="DASH"),[e.player.activeSkills]),y=N.useMemo(()=>ce(e.stairsPosition),[e.stairsPosition]),b=N.useMemo(()=>e.shrinePosition?ce(e.shrinePosition):null,[e.shrinePosition]),v=N.useMemo(()=>{const x=[{q:t.q+1,r:t.r,s:t.s-1},{q:t.q+1,r:t.r-1,s:t.s},{q:t.q,r:t.r-1,s:t.s+1},{q:t.q-1,r:t.r,s:t.s+1},{q:t.q-1,r:t.r+1,s:t.s},{q:t.q,r:t.r+1,s:t.s-1}],_=new Set;for(const E of x)Zl(E.q,E.r,e.gridWidth,e.gridHeight)&&_.add(ce(E));return _},[t,e.gridWidth,e.gridHeight]),T=N.useMemo(()=>{const x=new Set;if(!s)return x;const _=st.get(s);if(!_?.getValidTargets)return x;const E=_.getValidTargets(e,t);for(const w of E)x.add(ce(w));return x},[s,e,t]),S=N.useMemo(()=>{if(l)return l;if(!a)return null;const x=ce(a);if(o&&!s)return p.has(x)||!m&&v.has(x)?{path:Ze(t,a),aoe:[],hasEnemy:!1,target:a,ailmentDeltaLines:[]}:null;if(!s)return null;const _=e.player.activeSkills.find(R=>R.id===s),E=VM(e,{actorId:e.player.id,skillId:s,target:a,activeUpgrades:_?.activeUpgrades||[]});if(!E.ok)return null;const w=new Map;for(const R of E.simulationEvents)R.position&&(R.type!=="DamageTaken"&&R.type!=="StatusApplied"&&R.type!=="UnitMoved"||w.set(ce(R.position),R.position));const M=E.simulationEvents.some(R=>(R.type==="DamageTaken"||R.type==="StatusApplied")&&!!R.targetId&&R.targetId!==e.player.id),k=aO(E.simulationEvents);return{path:Ze(t,a),aoe:[...w.values()],hasEnemy:M,target:a,ailmentDeltaLines:k}},[l,a,o,s,p,m,v,e,t]);return{latestTraceByActor:u,movementTargetSet:p,hasPrimaryMovementSkills:m,stairsKey:y,shrineKey:b,fallbackNeighborSet:v,selectedSkillTargetSet:T,resolvedEnginePreviewGhost:S}},rO=({gameState:e,deathDecalHref:t,decals:s,setDecals:o,setEntityPoseEffects:a,setEntityPoseNowMs:l,onSimulationEvents:u})=>{const f=N.useRef(null),p=N.useRef(null),m=N.useRef(0),y=N.useRef(0),b=N.useCallback(T=>{if(!T)return null;const S=T.position||T.destination||T.origin||T.target;return S&&typeof S.q=="number"&&typeof S.r=="number"&&typeof S.s=="number"?S:null},[]);return N.useEffect(()=>{if(!t)return;const T=e.timelineEvents||[],S=e.visualEvents||[];if(f.current===T&&p.current===S)return;const x=f.current===T?[]:T;f.current=T;const _=p.current===S?[]:S;p.current=S;const E=[],w=Date.now();for(const M of x){if(M.phase!=="DEATH_RESOLVE")continue;const k=b(M.payload);k&&E.push({id:`decal-tl-${M.id}-${w}-${E.length}`,position:k,href:t,createdAt:w})}for(const M of _){if(M.type!=="vfx")continue;const k=M.payload?.type;if(k!=="vaporize"&&k!=="explosion_ring")continue;const R=b(M.payload);R&&E.push({id:`decal-vx-${k}-${w}-${E.length}`,position:R,href:t,createdAt:w})}E.length>0&&o(M=>[...M,...E].slice(-80))},[e.timelineEvents,e.visualEvents,t,b,o]),N.useEffect(()=>{const T=e.simulationEvents||[];T.length<m.current&&(m.current=0);const S=T.slice(m.current);m.current=T.length,S.length>0&&u?.(S)},[e.simulationEvents,u]),N.useEffect(()=>{const T=e.simulationEvents||[];T.length<y.current&&(y.current=0);const S=T.slice(y.current);if(y.current=T.length,S.length===0)return;const x=Date.now(),_=[e.player,...e.enemies,...e.companions||[],...e.dyingEntities||[]],E=new Map(_.map(k=>[k.id,k])),w=[],M=(k,R,O,I,D,j)=>{k&&w.push({id:`${R}:${k}:${D}`,actorId:k,startTime:D,endTime:D+Math.max(35,j),easing:"out",from:O,to:I})};for(const k of S){if(k.type!=="DamageTaken")continue;const R=String(k.targetId||""),O=R?E.get(R):void 0;if(!O)continue;const I=k.payload||{},D=String(I.reason||"").toLowerCase(),j=String(I.sourceId||"");if(!j||!D||D.includes("basic_attack"))continue;const U=E.get(j);if(!(D.includes("spear")||D.includes("multi_shoot")||D.includes("withdrawal")||U?.subtype==="archer"&&!D.includes("crush")))continue;const se=U?Ae(U.position,G):void 0,ee=Ae(O.position,G);let oe=0,F=1;if(se){const Z=ee.x-se.x,re=ee.y-se.y,pe=Math.hypot(Z,re);pe>.001&&(oe=Z/pe,F=re/pe)}const P=U?.subtype==="archer"?10:8,z=100;M(O.id,"projectile-hit",{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:oe*P,offsetY:F*P,scaleX:1.02,scaleY:.95},x,z),M(O.id,"projectile-hit-return",{offsetX:oe*(P*.35),offsetY:F*(P*.35),scaleX:1.01,scaleY:.99},{offsetX:0,offsetY:0,scaleX:1,scaleY:1},x+Math.floor(z*.5),130)}w.length>0&&(l(x),a(k=>[...k,...w]))},[e.simulationEvents,e.player,e.enemies,e.companions,e.dyingEntities,a,l]),N.useEffect(()=>{if(s.length===0)return;const T=12e3,S=window.setTimeout(()=>{const x=Date.now();o(_=>_.filter(E=>x-E.createdAt<T))},1e3);return()=>window.clearTimeout(S)},[s,o]),{resetBoardEventEffects:N.useCallback(()=>{o([]),a([]),l(0),f.current=null,p.current=null,m.current=0,y.current=0},[o,a,l])}},El=(e,t,s)=>e+(t-e)*s,lO=e=>1-Math.pow(1-e,3),cO=e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,uO=({gameState:e,assetById:t,entityPoseEffects:s,entityPoseNowMs:o,onMirrorSnapshot:a})=>{const l=N.useMemo(()=>{const p=new Map;p.set(e.player.id,e.player.position);for(const m of e.enemies)p.set(m.id,m.position);for(const m of e.companions||[])p.set(m.id,m.position);for(const m of e.dyingEntities||[])p.set(m.id,m.position);return p},[e.player.id,e.player.position,e.enemies,e.companions,e.dyingEntities]),u=N.useMemo(()=>[{id:e.player.id,position:e.player.position,subtype:e.player.subtype||"player",assetHref:t.get(Ji(e.player))?.path,fallbackAssetHref:ws(e.player)},...e.enemies.map(p=>({id:p.id,position:p.position,subtype:p.subtype,assetHref:t.get(Ji(p))?.path,fallbackAssetHref:ws(p)})),...(e.companions||[]).map(p=>({id:p.id,position:p.position,subtype:p.subtype,assetHref:t.get(Ji(p))?.path,fallbackAssetHref:ws(p)})),...(e.dyingEntities||[]).map(p=>({id:p.id,position:p.position,subtype:p.subtype,assetHref:t.get(Ji(p))?.path,fallbackAssetHref:ws(p)}))],[t,e.player,e.enemies,e.companions,e.dyingEntities]),f=N.useMemo(()=>{const p=new Map,m=o||Date.now();for(const y of s){if(m<y.startTime||m>y.endTime)continue;const b=Math.max(1,y.endTime-y.startTime),v=Math.max(0,Math.min(1,(m-y.startTime)/b)),T=y.easing==="inOut"?cO(v):lO(v),S={offsetX:El(y.from.offsetX,y.to.offsetX,T),offsetY:El(y.from.offsetY,y.to.offsetY,T),scaleX:El(y.from.scaleX,y.to.scaleX,T),scaleY:El(y.from.scaleY,y.to.scaleY,T)},x=p.get(y.actorId);if(!x){p.set(y.actorId,S);continue}p.set(y.actorId,{offsetX:(x.offsetX??0)+(S.offsetX??0),offsetY:(x.offsetY??0)+(S.offsetY??0),scaleX:(x.scaleX??1)*(S.scaleX??1),scaleY:(x.scaleY??1)*(S.scaleY??1)})}return p},[s,o]);return N.useEffect(()=>{if(!a)return;const p={turn:e.turnNumber||0,stackTick:e.stackTrace?.length||0,actors:[...l.entries()].map(([m,y])=>({id:m,position:{q:y.q,r:y.r,s:y.s}}))};a(p)},[a,e.turnNumber,e.stackTrace,l]),{actorPositionById:l,juiceActorSnapshots:u,entityVisualPoseById:f}},Ql=e=>{if(!e||typeof e.q!="number"||typeof e.r!="number"||typeof e.s!="number")return null;const{x:t,y:s}=Ae(e,G),o=Math.hypot(t,s);return!Number.isFinite(o)||o<=1e-4?null:{x:t/o,y:s/o}},_l=e=>{const t=e?.hex;if(t&&typeof t.q=="number"&&typeof t.r=="number"&&typeof t.s=="number")return t},Ml=e=>{const t=e?.world;if(t&&typeof t.x=="number"&&typeof t.y=="number")return t},dO=({gameState:e,visualEvents:t,nowMs:s})=>{const o=[],a=[e.player,...e.enemies,...e.companions||[],...e.dyingEntities||[]],l=new Map(a.map(p=>[p.id,p])),u=p=>{if(p){for(const m of a)if(J(m.position,p))return m.id}},f=(p,m,y,b,v,T,S)=>{p&&o.push({id:`${m}:${p}:${v}`,actorId:p,startTime:v,endTime:v+Math.max(30,T),easing:S,from:y,to:b})};for(let p=0;p<t.length;p++){const m=t[p];if(m.type!=="juice_signature")continue;const y=m.payload;if(!y||y.protocol!=="juice-signature/v1"||y.signature!=="ATK.STRIKE.PHYSICAL.BASIC_ATTACK"&&y.signature!=="ATK.STRIKE.PHYSICAL.AUTO_ATTACK")continue;const b=String(y.phase||"impact"),v=_l(y.source),T=_l(y.target),S=String(y.meta?.sourceId||y.source?.actorId||"")||u(v),x=y.target?.actorId||u(T);if(!v||!T||!S)continue;const _=Ae(v,G),E=Ae(T,G),w=Ml(y.contact)||E;let M=w.x-_.x,k=w.y-_.y,R=Math.hypot(M,k);if(!Number.isFinite(R)||R<.001){const re=Ql(y.direction);if(re)M=re.x,k=re.y,R=1;else{const pe=Ae(T,G);M=pe.x-_.x,k=pe.y-_.y,R=Math.max(1,Math.hypot(M,k))}}const O=M/Math.max(1,R),I=k/Math.max(1,R),D=Math.max(0,Number(y.timing?.delayMs||0)),j=Math.max(40,Number(y.timing?.durationMs||y.timing?.ttlMs||110)),U=s+D,q=String(y.meta?.sequenceId||`strike-${s}-${p}`),se=String(y.intensity||"medium"),ee=y.signature==="ATK.STRIKE.PHYSICAL.AUTO_ATTACK",oe=se==="extreme"?16:se==="high"?13:se==="low"?8:11,F=Math.min(G*(ee?.3:.46),R*(ee?.22:.32)),P=Math.min(G*(ee?.55:.82),R*(ee?.62:.9)),z=Math.min(G*(ee?.62:.9),R*(ee?.72:.98)),Z=Math.min(G*(ee?.22:.34),R*(ee?.24:.36));if(b==="anticipation"){f(S,`${q}:anticipation`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:-O*F,offsetY:-I*F,scaleX:.92,scaleY:1.08},U,j,"out");continue}if(b==="travel"){f(S,`${q}:travel`,{offsetX:-O*F,offsetY:-I*F,scaleX:.94,scaleY:1.06},{offsetX:O*P,offsetY:I*P,scaleX:1.09,scaleY:.93},U,j,"inOut");continue}if(b==="impact"){f(S,`${q}:impact-src`,{offsetX:O*(z*.92),offsetY:I*(z*.92),scaleX:1.06,scaleY:.95},{offsetX:O*z,offsetY:I*z,scaleX:1.02,scaleY:.98},U,j,"out"),f(x,`${q}:impact-tgt`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:O*oe,offsetY:I*oe,scaleX:1.03,scaleY:.94},U,j,"out");continue}b==="aftermath"&&(f(S,`${q}:after-src`,{offsetX:O*Z,offsetY:I*Z,scaleX:1.01,scaleY:.99},{offsetX:0,offsetY:0,scaleX:1,scaleY:1},U,j,"out"),f(x,`${q}:after-tgt`,{offsetX:O*(oe*.35),offsetY:I*(oe*.35),scaleX:1.01,scaleY:.99},{offsetX:0,offsetY:0,scaleX:1,scaleY:1},U,j,"out"))}for(let p=0;p<t.length;p++){const m=t[p];if(m.type!=="juice_signature")continue;const y=m.payload;if(!y||y.protocol!=="juice-signature/v1")continue;const b=String(y.signature||"");if(String(y.phase||"impact")!=="impact")continue;const T=Math.max(0,Number(y.timing?.delayMs||0)),S=Math.max(45,Number(y.timing?.durationMs||y.timing?.ttlMs||110)),x=s+T,_=_l(y.source),E=_l(y.target),w=Ml(y.source),M=Ml(y.target),k=Ml(y.contact),R=String(y.meta?.sourceId||y.source?.actorId||""),I=(R?l.get(R):void 0)?.id||u(_),D=y.target?.actorId||u(E),U=(()=>{const q=Ql(y.direction);if(q)return q;const se=_?Ae(_,G):w,ee=k||M||(E?Ae(E,G):void 0);if(se&&ee){const oe=ee.x-se.x,F=ee.y-se.y,P=Math.hypot(oe,F);if(P>.001)return{x:oe/P,y:F/P}}return null})();if(U){if(b==="ATK.PULSE.KINETIC.WAVE"){f(I,`${y.meta?.sequenceId||b}:pulse-caster`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:-U.x*8,offsetY:-U.y*8,scaleX:.96,scaleY:1.05},x,Math.max(40,Math.floor(S*.5)),"out"),f(I,`${y.meta?.sequenceId||b}:pulse-caster-return`,{offsetX:-U.x*(8*.6),offsetY:-U.y*(8*.6),scaleX:.98,scaleY:1.02},{offsetX:0,offsetY:0,scaleX:1,scaleY:1},x+Math.floor(S*.45),Math.max(50,Math.floor(S*.65)),"out"),f(D,`${y.meta?.sequenceId||b}:pulse-target`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:U.x*10,offsetY:U.y*10,scaleX:1.03,scaleY:.95},x,S,"out");continue}if(b.startsWith("ENV.COLLISION.KINETIC.")){const q=b==="ENV.COLLISION.KINETIC.SHIELD_BASH"?14:10,se=b==="ENV.COLLISION.KINETIC.SHIELD_BASH"?7:0;se>0&&f(I,`${y.meta?.sequenceId||b}:collision-source`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:U.x*se,offsetY:U.y*se,scaleX:1.03,scaleY:.97},x,Math.max(45,Math.floor(S*.55)),"out"),f(D,`${y.meta?.sequenceId||b}:collision-target`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:U.x*q,offsetY:U.y*q,scaleX:1.02,scaleY:.92},x,S,"out");continue}}}return o},zd={low:110,medium:160,high:210,extreme:260},Jg={light:6,medium:10,heavy:14},Qg={light:65,medium:85,heavy:110},fO=e=>{let t=0,s=0,o=0,a={x:0,y:0},l=0;const u=[];for(const f of e){if(f.type==="juice_signature"){const p=f.payload;if(p?.protocol==="juice-signature/v1"){const m=Math.max(0,Number(p.timing?.delayMs||0)),y=p.camera?.shake,b=Number(p.camera?.freezeMs||0),v=String(p.camera?.kick||"none"),T=v!=="none"?Ql(p.direction):null,S=Jg[v]||0,x=Qg[v]||80;if(m>0&&(y||b>0||T&&S>0)){u.push({delayMs:m,shakeDurationMs:y?zd[String(y)]||160:0,freezeDurationMs:b>0?Math.min(220,b):0,kickDurationMs:T&&S>0?x:0,kickOffset:T&&S>0?{x:T.x*S,y:T.y*S}:{x:0,y:0}});continue}if(y&&(t=Math.max(t,zd[String(y)]||160)),b>0&&(s=Math.max(s,Math.min(220,b))),v!=="none"){const _=Ql(p.direction),E=Jg[v]||0;_&&E>0&&E>=l&&(l=E,a={x:_.x*E,y:_.y*E},o=Math.max(o,Qg[v]||80))}continue}}if(f.type==="shake"){const p=String(f.payload?.intensity||"medium");t=Math.max(t,zd[p]||160)}else f.type==="freeze"&&(s=Math.max(s,Math.min(220,Math.max(50,Number(f.payload?.durationMs||80)))))}return{shakeDurationMs:t,freezeDurationMs:s,kickDurationMs:o,kickOffset:a,deferredCues:u}},mO=({gameState:e})=>{const[t,s]=N.useState(!1),[o,a]=N.useState(!1),[l,u]=N.useState({x:0,y:0}),[f,p]=N.useState(!1),[m,y]=N.useState([]),[b,v]=N.useState([]),[T,S]=N.useState(0),x=N.useRef(null),_=N.useRef(null),E=N.useRef(null),w=N.useRef(null);N.useRef(!1),N.useEffect(()=>{},[]),N.useEffect(()=>{const k=e.visualEvents||[];if(E.current===k)return;E.current=k;const R=k;if(R.length===0)return;const O=Date.now(),I=dO({gameState:e,visualEvents:R,nowMs:O});I.length>0&&(S(O),v(D=>[...D,...I]))},[e.visualEvents,e.player,e.enemies,e.companions,e.dyingEntities]),N.useEffect(()=>{if(typeof window>"u"||b.length===0)return;let k=!1;const R=()=>{if(k)return;const O=Date.now();S(O),v(I=>{const D=I.filter(j=>O<j.endTime+16);return D.length===I.length?I:D}),w.current=window.requestAnimationFrame(R)};return w.current=window.requestAnimationFrame(R),()=>{k=!0,w.current!==null&&(window.cancelAnimationFrame(w.current),w.current=null)}},[b.length]),N.useEffect(()=>{const k=e.visualEvents||[];if(x.current===k)return;x.current=k;const R=k;if(R.length===0)return;const O=fO(R),I=[],D=q=>{q<=0||(s(!0),I.push(window.setTimeout(()=>s(!1),q)))},j=q=>{q<=0||(a(!0),I.push(window.setTimeout(()=>a(!1),q)))},U=(q,se)=>{se<=0||!q.x&&!q.y||(u(q),I.push(window.setTimeout(()=>u({x:0,y:0}),se)))};for(const q of O.deferredCues)I.push(window.setTimeout(()=>{q.shakeDurationMs>0&&D(q.shakeDurationMs),q.freezeDurationMs>0&&j(q.freezeDurationMs),q.kickDurationMs>0&&U(q.kickOffset,q.kickDurationMs)},q.delayMs));return O.shakeDurationMs>0&&D(O.shakeDurationMs),O.freezeDurationMs>0&&j(O.freezeDurationMs),O.kickDurationMs>0&&(O.kickOffset.x!==0||O.kickOffset.y!==0)&&U(O.kickOffset,O.kickDurationMs),()=>{for(const q of I)window.clearTimeout(q)}},[e.visualEvents]),N.useEffect(()=>{},[e.visualEvents,f]);const M=N.useCallback(()=>{y([]),s(!1),a(!1),u({x:0,y:0}),v([]),S(0),x.current=null,_.current=null,E.current=null,w.current!==null&&(window.cancelAnimationFrame(w.current),w.current=null)},[]);return{isShaking:t,isFrozen:o,cameraKickOffsetPx:l,juiceDebugOverlayEnabled:f,juiceDebugEntries:m,entityPoseEffects:b,entityPoseNowMs:T,setEntityPoseEffects:v,setEntityPoseNowMs:S,resetBoardJuicePresentation:M}},pO=({visualEvents:e,turnNumber:t,actorPositionById:s,svgRef:o,cancelCameraAnimation:a})=>{const[l,u]=N.useState(!1),f=N.useRef([]),p=N.useRef(!1),m=N.useRef([]),y=N.useRef(0),b=N.useRef(""),v=N.useMemo(()=>(e||[]).filter(w=>w.type==="kinetic_trace").map(w=>w.payload).filter(w=>{if(!w?.actorId||!w.origin||!w.destination)return!1;const M=s.get(w.actorId);return!!M&&ce(M)===ce(w.destination)}),[e,s]),T=N.useMemo(()=>{if(!v.length)return"";const w=t??0,M=v.map(k=>{const R=(k.path||[]).map(O=>`${O.q},${O.r},${O.s}`).join(">");return[k.actorId,`${k.origin.q},${k.origin.r},${k.origin.s}`,`${k.destination.q},${k.destination.r},${k.destination.s}`,k.movementType||"slide",k.startDelayMs||0,k.durationMs||0,R].join("|")}).join("||");return`${w}::${M}`},[v,t]),S=N.useCallback(async(w,M,k,R)=>{if(R!==y.current)return;const O=w.animate(M,{...k,fill:k.fill??"forwards"});m.current.push(O);try{await O.finished}catch{}finally{m.current=m.current.filter(I=>I!==O)}},[]),x=N.useCallback(async(w,M,k)=>{if(M!==y.current)return;const R=.76,O=o.current?.querySelector(`[data-actor-node="${w.actorId}"]`),I=Z=>{const re=Ae(Z,G);return`translate(${re.x}px, ${re.y}px)`},D=Math.max(0,w.startDelayMs||0),j=Math.max(0,performance.now()-k),U=Math.round(D*R),q=Math.max(0,U-j),se=w.path&&w.path.length>1?w.path:[w.origin,w.destination],ee=Math.max(1,se.length-1),oe=Math.max(90,Math.round((w.durationMs||ee*110)*R));if(!O){const Z=Math.max(0,q+oe);Z>0&&await new Promise(re=>window.setTimeout(re,Z));return}if(q>0&&(await new Promise(Z=>window.setTimeout(Z,q)),M!==y.current))return;if((w.movementType||"slide")==="teleport"){const Z=Math.max(100,Math.round((w.durationMs||180)*R));await S(O,[{transform:I(w.origin),opacity:1,offset:0},{transform:I(w.origin),opacity:0,offset:.45},{transform:I(w.destination),opacity:0,offset:.55},{transform:I(w.destination),opacity:1,offset:1}],{duration:Z,easing:"linear"},M),M===y.current&&(O.style.transform=I(w.destination),O.style.opacity="1");return}const F=[...se],P=F[F.length-1];(!P||P.q!==w.destination.q||P.r!==w.destination.r||P.s!==w.destination.s)&&F.push(w.destination);const z=F.map((Z,re)=>({transform:I(Z),offset:F.length===1?1:re/(F.length-1)}));z[z.length-1]={...z[z.length-1],transform:I(w.destination),offset:1},await S(O,z,{duration:oe,easing:"linear"},M),M===y.current&&(O.style.transform=I(w.destination),O.style.opacity="1")},[S,o]),_=N.useCallback(async()=>{if(p.current)return;p.current=!0,u(!0);const w=++y.current,M=performance.now();try{for(;f.current.length>0&&w===y.current;){const k=f.current.shift();k&&await x(k,w,M)}}finally{w===y.current&&(p.current=!1,u(!1))}},[x]);N.useEffect(()=>{if(!T){b.current="";return}T!==b.current&&(b.current=T,f.current.push(...v),_())},[T,v,_]);const E=N.useCallback((w=!0)=>{y.current++,f.current=[],p.current=!1,m.current.forEach(M=>{try{M.cancel()}catch{}}),m.current=[],u(!1),w&&(b.current="")},[]);return N.useEffect(()=>()=>{a(),E(!1)},[a,E]),{movementBusy:l,resetMovementPlayback:E}},hO=e=>{const t=[];for(let s=0;s<6;s++){const o=Math.PI/180*(60*s);t.push(`${e*Math.cos(o)},${e*Math.sin(o)}`)}return t.join(" ")},Mb=({gameState:e,onMove:t,selectedSkillId:s,showMovementRange:o,onBusyStateChange:a,assetManifest:l,biomeDebug:u,onSimulationEvents:f,onMirrorSnapshot:p,enginePreviewGhost:m,cameraSafeInsetsPx:y})=>{const[b,v]=N.useState(null),[T,S]=N.useState(!1),[x,_]=N.useState([]),E=e.player.position,w=N.useMemo(()=>{let Jt=e.rooms?.[0]?.hexes;if(!Jt||Jt.length===0){Jt=[];for(let Pt=0;Pt<e.gridWidth;Pt++)for(let On=0;On<e.gridHeight;On++)Jt.push({q:Pt,r:On,s:-Pt-On})}return Jt.filter(Pt=>Zl(Pt.q,Pt.r,e.gridWidth,e.gridHeight))},[e.rooms,e.gridWidth,e.gridHeight]),{isShaking:M,isFrozen:k,cameraKickOffsetPx:R,entityPoseEffects:O,entityPoseNowMs:I,setEntityPoseEffects:D,setEntityPoseNowMs:j,resetBoardJuicePresentation:U}=mO({gameState:e}),q=N.useMemo(()=>{if(w.length===0)return{minX:0,minY:0,width:100,height:100};let Jt=1/0,Pt=1/0,On=-1/0,js=-1/0;return w.forEach(Da=>{const{x:Ds,y:Ua}=Ae(Da,G);Jt=Math.min(Jt,Ds-G),Pt=Math.min(Pt,Ua-G),On=Math.max(On,Ds+G),js=Math.max(js,Ua+G)}),{minX:Jt,minY:Pt,width:On-Jt,height:js-Pt}},[w]),se=N.useMemo(()=>{const{x:Jt,y:Pt}=Ae(E,G);return{x:Jt,y:Pt}},[E]),ee=N.useMemo(()=>({x:q.minX,y:q.minY,width:q.width,height:q.height}),[q.minX,q.minY,q.width,q.height]),{svgRef:oe,boardViewportRef:F,zoomPreset:P,isCameraPanning:z,setIsCameraPanning:Z,cameraPanOffsetRef:re,isCameraPanningRef:pe,isPinchingRef:B,suppressTileClickUntilRef:W,activePointersRef:X,dragStateRef:ae,pinchStateRef:le,cancelCameraAnimation:ue,animateCameraToTarget:be,updatePanFromWorldDelta:$e,setZoomPresetAnimated:Ee,renderedViewBox:at}=$C({baseViewBox:ee,playerWorld:se,playerPosition:E,floor:e.floor,cameraSafeInsetsPx:y}),{latestTraceByActor:ot,movementTargetSet:kt,hasPrimaryMovementSkills:wt,stairsKey:ke,shrineKey:et,fallbackNeighborSet:Gt,selectedSkillTargetSet:Ft,resolvedEnginePreviewGhost:Cn}=oO({gameState:e,playerPos:E,selectedSkillId:s,showMovementRange:o,hoveredTile:b,enginePreviewGhost:m}),{tileVisualFlags:jn,assetById:Dn,deathDecalHref:is,manifestUnitToBoardScale:Ia,biomeThemeKey:Ls,biomeSeed:It,clutterLayer:La,wallsProfile:Bs,wallsThemeOverride:Ps,boardProps:Kn,resolveMountainSettings:ss,hybridInteractionLayerEnabled:as,backdropLayerProps:Ba}=sO({cells:w,gameState:e,bounds:q,assetManifest:l,biomeDebug:u}),{mountainSettingsByAssetId:Pa,depthSortedSprites:Fn,mountainCoveredWallKeys:Lt}=VC({assetManifest:l,biomeThemeKey:Ls,biomeSeed:It,mountainAssetPathOverride:u?.mountainAssetPath,wallsMountainPath:Bs?.mountainPath,wallsThemeMountainPath:Ps?.mountainPath,clutterLayer:La,cells:w,tileVisualFlags:jn,boardProps:Kn,resolveMountainSettings:ss}),{resetBoardEventEffects:mt}=rO({gameState:e,deathDecalHref:is,decals:x,setDecals:_,setEntityPoseEffects:D,setEntityPoseNowMs:j,onSimulationEvents:f}),{handleResetView:pt,handleTileClick:Ha,handleHoverTile:_e,handleBoardPointerDown:ht,handleBoardPointerMove:Bt,handleBoardPointerUp:rt,handleBoardPointerCancel:pn,handleBoardWheel:on}=NC({svgRef:oe,onMove:t,zoomPreset:P,setHoveredTile:v,setIsCameraPanning:Z,cameraPanOffsetRef:re,isCameraPanningRef:pe,isPinchingRef:B,suppressTileClickUntilRef:W,activePointersRef:X,dragStateRef:ae,pinchStateRef:le,animateCameraToTarget:be,updatePanFromWorldDelta:$e,setZoomPresetAnimated:Ee}),{actorPositionById:Ai,juiceActorSnapshots:os,entityVisualPoseById:oc}=uO({gameState:e,assetById:Dn,entityPoseEffects:O,entityPoseNowMs:I,onMirrorSnapshot:p}),{movementBusy:ja,resetMovementPlayback:Hs}=pO({visualEvents:e.visualEvents,turnNumber:e.turnNumber,actorPositionById:Ai,svgRef:oe,cancelCameraAnimation:ue});N.useEffect(()=>{a?.(ja||T)},[ja,T,a]),N.useLayoutEffect(()=>{ue(),Hs(),mt(),U()},[e.floor,ue,Hs,mt,U]);const rs=N.useMemo(()=>hO(G-1),[]);return g.jsxs("div",{ref:F,className:`relative w-full h-full flex justify-center items-center overflow-hidden transition-transform duration-75 ${M?"animate-shake":""} ${z?"cursor-grabbing":""}`,children:[g.jsxs("div",{className:"relative w-full h-full",style:{transform:`translate3d(${R.x}px, ${R.y}px, 0)`,transition:"transform 85ms ease-out",willChange:R.x||R.y?"transform":void 0},children:[k&&g.jsx("div",{className:"absolute inset-0 z-20 pointer-events-none bg-white/10",style:{boxShadow:"inset 0 0 60px rgba(255,255,255,0.18)",animation:"flash 120ms ease-out"}}),g.jsx(kC,{svgRef:oe,renderedViewBox:at,cells:w,gameState:e,selectedSkillId:s,showMovementRange:o,hoveredTile:b,resolvedEnginePreviewGhost:Cn,tileVisualFlags:jn,movementTargetSet:kt,hasPrimaryMovementSkills:wt,fallbackNeighborSet:Gt,selectedSkillTargetSet:Ft,stairsKey:ke,shrineKey:et,mountainCoveredWallKeys:Lt,hybridInteractionLayerEnabled:as,assetById:Dn,decals:x,depthSortedSprites:Fn,boardProps:Kn,manifestUnitToBoardScale:Ia,mountainSettingsByAssetId:Pa,resolveMountainSettings:ss,latestTraceByActor:ot,entityVisualPoseById:oc,biomeThemeKey:Ls,juiceActorSnapshots:os,assetManifest:l,backdropLayerProps:Ba,gridPoints:rs,onTileClick:Ha,onTileHover:_e,onMouseLeave:()=>v(null),onWheel:on,onPointerDown:ht,onPointerMove:Bt,onPointerUp:rt,onPointerCancel:pn,onJuiceBusyStateChange:S})]}),!1,g.jsx(ow,{presets:RC,activePreset:P,onSelectPreset:Ee,onResetView:pt})]})},yO=({theme:e,previewState:t,previewManifest:s})=>g.jsxs("main",{className:"flex-1 relative bg-[#050914] overflow-hidden",children:[g.jsxs("div",{className:"absolute top-4 right-5 z-20 px-3 py-2 rounded-lg border border-white/15 bg-black/35 text-[10px] font-black uppercase tracking-[0.2em]",children:["Theme: ",e]}),g.jsx("div",{className:"w-full h-full p-6",children:g.jsx("div",{className:"w-full h-full rounded-[28px] border border-white/10 bg-[#030712]/70 overflow-hidden",children:g.jsx(Mb,{gameState:t,onMove:()=>{},selectedSkillId:null,showMovementRange:!1,assetManifest:s})})})]}),Zg="/Hop",gO=64,bO=192,e0=64,t0=512,lt=(e,t,s)=>Math.min(s,Math.max(t,e)),n0=(e,t)=>`${e.endsWith("/")?e:`${e}/`}${t.replace(/^\/+/,"")}`,Do=e=>{const t=e.trim();return!t||/^(?:[a-z]+:)?\/\//i.test(t)||t.startsWith("data:")?t:t.startsWith("/")?t.startsWith("/assets/")?n0(Zg,t.slice(1)):t:n0(Zg,t)},i0=(e,t="#8b6f4a")=>{const s=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(s))return s.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(s)){const[l,u,f]=s.slice(1).split("");return`#${l}${l}${u}${u}${f}${f}`.toLowerCase()}return t},wb=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",wl=e=>e==="off"?"off":wb(e),SO=(e,t,s)=>{if(!e||!t)return null;const o=Do(t.undercurrent.path),a=Do(t.crust.path),l=Do(t.materials.detailA.path),u=Do(t.materials.detailB.path),f=Mf(e,s),p=f?.biomeLayers?.undercurrent??e.biomeLayers?.undercurrent,m=f?.biomeLayers?.crust??e.biomeLayers?.crust??(e.biomeUnderlay?{default:e.biomeUnderlay.default,themes:e.biomeUnderlay.themes,mode:e.biomeUnderlay.mode,scalePx:e.biomeUnderlay.scalePx,opacity:e.biomeUnderlay.opacity}:void 0),y=f?.biomeMaterials?.crust??e.biomeMaterials?.crust,b=p||o?{...p||{default:o||a||""},default:o||p?.default||"",themes:{...p?.themes||{},[s]:o||p?.default||""},mode:t.undercurrent.mode,scalePx:lt(t.undercurrent.scalePx,gO,bO),opacity:lt(t.undercurrent.opacity,0,1),offsetX:t.undercurrent.offsetX,offsetY:t.undercurrent.offsetY,scroll:{x:t.undercurrent.scrollX,y:t.undercurrent.scrollY,durationMs:Math.max(1e3,t.undercurrent.scrollDurationMs)}}:void 0,v=m||a?{...m||{default:a||o||""},default:a||m?.default||"",themes:{...m?.themes||{},[s]:a||m?.default||""},mode:t.crust.mode,scalePx:Math.max(64,t.crust.scalePx),opacity:1,seedShiftPx:Math.max(0,t.crust.seedShiftPx),offsetX:t.crust.offsetX,offsetY:t.crust.offsetY}:void 0,T=l||y?.detailA?.default||"",S={...y?.detailA?.themes||{}};T&&(S[s]=T);const x=T?{...y?.detailA||{default:T},default:T,themes:S,mode:t.materials.detailA.mode,scalePx:lt(t.materials.detailA.scalePx,e0,t0),opacity:lt(t.materials.detailA.opacity,0,1)}:void 0,_=u||y?.detailB?.default||"",E={...y?.detailB?.themes||{}};_&&(E[s]=_);const w=_?{...y?.detailB||{default:_},default:_,themes:E,mode:t.materials.detailB.mode,scalePx:lt(t.materials.detailB.scalePx,e0,t0),opacity:lt(t.materials.detailB.opacity,0,1)}:void 0,M=String(t.materials.tintColor||"").trim()||y?.tint?.default||"#8b6f4a",k={...y?.tint?.themes||{}};k[s]=M;const R={...y?.tint||{default:M},default:M,themes:k,opacity:lt(t.materials.tintOpacity,0,1),blendMode:wb(t.materials.tintBlend)},O=x||w||R?{...y||{},detailA:x,detailB:w,tint:R}:void 0,I=Do(t.walls.mountainPath),D=f?.walls,j={...D||e.walls?.themes?.[s]||{},mountainPath:I,scale:lt(t.walls.mountainScale,.2,3),offsetX:t.walls.mountainOffsetX,offsetY:t.walls.mountainOffsetY,anchorX:lt(t.walls.mountainAnchorX,0,1),anchorY:lt(t.walls.mountainAnchorY,0,1),crustBlendMode:wl(t.walls.mountainCrustBlendMode),crustBlendOpacity:lt(t.walls.mountainCrustBlendOpacity,0,1),tintColor:i0(t.walls.mountainTintColor,"#7d7d7d"),tintBlendMode:wl(t.walls.mountainTintBlendMode),tintOpacity:lt(t.walls.mountainTintOpacity,0,1),mountainScale:lt(t.walls.mountainScale,.2,3),mountainOffsetX:t.walls.mountainOffsetX,mountainOffsetY:t.walls.mountainOffsetY,mountainAnchorX:lt(t.walls.mountainAnchorX,0,1),mountainAnchorY:lt(t.walls.mountainAnchorY,0,1),mountainCrustBlendMode:wl(t.walls.mountainCrustBlendMode),mountainCrustBlendOpacity:lt(t.walls.mountainCrustBlendOpacity,0,1),mountainTintColor:i0(t.walls.mountainTintColor,"#7d7d7d"),mountainTintBlendMode:wl(t.walls.mountainTintBlendMode),mountainTintOpacity:lt(t.walls.mountainTintOpacity,0,1)},U={...e.walls||{},...D||{},mode:t.walls.mode,interiorDensity:lt(t.walls.interiorDensity,0,.45),clusterBias:lt(t.walls.clusterBias,0,1),keepPerimeter:!!t.walls.keepPerimeter,mountainPath:I,scale:j.scale,offsetX:j.offsetX,offsetY:j.offsetY,anchorX:j.anchorX,anchorY:j.anchorY,crustBlendMode:j.crustBlendMode,crustBlendOpacity:j.crustBlendOpacity,tintColor:j.tintColor,tintBlendMode:j.tintBlendMode,tintOpacity:j.tintOpacity,mountainScale:j.mountainScale,mountainOffsetX:j.mountainOffsetX,mountainOffsetY:j.mountainOffsetY,mountainAnchorX:j.mountainAnchorX,mountainAnchorY:j.mountainAnchorY,mountainCrustBlendMode:j.mountainCrustBlendMode,mountainCrustBlendOpacity:j.mountainCrustBlendOpacity,mountainTintColor:j.mountainTintColor,mountainTintBlendMode:j.mountainTintBlendMode,mountainTintOpacity:j.mountainTintOpacity,themes:{...e.walls?.themes||{},[s]:j}},q={...f?.biomeLayers||{},undercurrent:b,crust:v,clutter:{...f?.biomeLayers?.clutter||e.biomeLayers?.clutter||{},density:lt(t.clutter.density,0,1),maxPerHex:Math.max(0,Math.floor(t.clutter.maxPerHex)),bleedScaleMax:lt(t.clutter.bleedScaleMax,1,2)}},se={...f?.biomeMaterials||{},crust:O},ee={...f||{},seed:t.seed.trim()||"biome-sandbox-seed",injectHazards:t.injectHazards,biomeLayers:q,biomeMaterials:se,walls:U};return{...e,biomeLayers:{...e.biomeLayers||{},undercurrent:b,crust:v,clutter:{...e.biomeLayers?.clutter||{},density:lt(t.clutter.density,0,1),maxPerHex:Math.max(0,Math.floor(t.clutter.maxPerHex)),bleedScaleMax:lt(t.clutter.bleedScaleMax,1,2)}},biomeMaterials:{...e.biomeMaterials||{},crust:O},walls:U,biomePresets:{...e.biomePresets||{},[s]:ee}}},vO=e=>N.useMemo(()=>{const t=new Set,s=new Set,o=new Set,a=new Set;if(!e)return{undercurrent:[],crust:[],detail:[],mountain:[]};const l=u=>{if(u){u.default&&(t.add(u.default),s.add(u.default),o.add(u.default));for(const f of Object.values(u.themes||{}))t.add(f),s.add(f),o.add(f)}};l(e.biomeLayers?.undercurrent),l(e.biomeLayers?.crust);for(const u of Object.values(e.biomePresets||{}))l(u?.biomeLayers?.undercurrent),l(u?.biomeLayers?.crust),u?.biomeMaterials?.crust?.detailA&&l(u.biomeMaterials.crust.detailA),u?.biomeMaterials?.crust?.detailB&&l(u.biomeMaterials.crust.detailB);if(e.biomeUnderlay){e.biomeUnderlay.default&&s.add(e.biomeUnderlay.default);for(const u of Object.values(e.biomeUnderlay.themes||{}))s.add(u)}e.biomeMaterials?.crust?.detailA&&l(e.biomeMaterials.crust.detailA),e.biomeMaterials?.crust?.detailB&&l(e.biomeMaterials.crust.detailB);for(const u of e.assets||[]){const f=new Set((u.tags||[]).map(m=>m.toLowerCase())),p=u.type==="prop"&&(u.id.toLowerCase().includes("mountain")||f.has("mountain"));(f.has("floor")||f.has("stone")||f.has("void")||f.has("frozen")||f.has("inferno"))&&(s.add(u.path),o.add(u.path)),(f.has("lava")||f.has("hazard")||f.has("fire")||f.has("quicksand"))&&t.add(u.path),(u.type==="decal"||u.type==="prop"||u.type==="tile")&&o.add(u.path),p&&a.add(u.path)}e.walls?.mountainPath&&a.add(e.walls.mountainPath);for(const u of Object.values(e.walls?.themes||{}))u?.mountainPath&&a.add(u.mountainPath);for(const u of Object.values(e.biomePresets||{})){u?.walls?.mountainPath&&a.add(u.walls.mountainPath);for(const f of Object.values(u?.walls?.themes||{}))f?.mountainPath&&a.add(f.mountainPath)}return{undercurrent:Array.from(t).sort((u,f)=>u.localeCompare(f)),crust:Array.from(s).sort((u,f)=>u.localeCompare(f)),detail:Array.from(o).sort((u,f)=>u.localeCompare(f)),mountain:Array.from(a).sort((u,f)=>u.localeCompare(f))}},[e]),AO=[{q:1,r:0,s:-1},{q:0,r:1,s:-1},{q:-1,r:1,s:0},{q:-1,r:0,s:1},{q:0,r:-1,s:1},{q:1,r:-1,s:0}],xO=e=>{let t=2166136261;for(let s=0;s<e.length;s++)t^=e.charCodeAt(s),t=Math.imul(t,16777619);return t>>>0},s0=e=>xO(e)/4294967295,Cb=e=>e.has("BLOCKS_MOVEMENT")&&e.has("BLOCKS_LOS"),TO=e=>e.has("LAVA")||e.has("FIRE")||e.has("HAZARDOUS")&&e.has("LIQUID"),wf=e=>AO.map(t=>ce({q:e.q+t.q,r:e.r+t.r,s:e.s+t.s})),EO=e=>{const t=new Set;for(const[s,o]of e.entries())wf(o.position).some(l=>!e.has(l))&&t.add(s);return t},_O=(e,t,s)=>{const o=new Set,a=[{point:t,depth:0}];for(;a.length>0;){const l=a.shift(),u=ce(l.point);if(!o.has(u)&&e.has(u)&&(o.add(u),!(l.depth>=s)))for(const f of wf(l.point)){const p=e.get(f);p&&a.push({point:p.position,depth:l.depth+1})}}return o},Vd=(e,t,s)=>{const o=e.get(t);if(!o)return;const a=new Set(Array.from(o.traits));s?(a.add("BLOCKS_MOVEMENT"),a.add("BLOCKS_LOS"),a.delete("LAVA"),a.delete("FIRE"),a.delete("LIQUID"),a.delete("HAZARDOUS")):(a.delete("BLOCKS_MOVEMENT"),a.delete("BLOCKS_LOS")),e.set(t,{...o,traits:a})},MO=e=>{const t=new Map;for(const[s,o]of e.tiles.entries())t.set(s,{...o,traits:new Set(o.traits),effects:Array.isArray(o.effects)?[...o.effects]:[]});return t},wO=(e,t)=>{const s=(l,u,f)=>{const m=ce({q:l,r:u}),y=e.get(m);if(!y)return;const b=new Set(Array.from(y.traits));if(!Cb(b)){for(const v of f)b.add(v);e.set(m,{...y,traits:b})}},o=[[0,0],[1,0],[0,1],[-1,1],[-1,0],[0,-1],[1,-1],[2,-1],[2,0],[1,1],[-2,1],[-2,0],[-1,-1]];for(const[l,u]of o)s(t.q+l,t.r+u,["HAZARDOUS","LIQUID","LAVA"]);const a=[[3,-1],[3,0],[2,1],[-3,1],[-3,0],[-2,-1]];for(const[l,u]of a)s(t.q+l,t.r+u,["HAZARDOUS","FIRE"])},CO=(e,t,s,o)=>{const a=o.mode,l=EO(e),u=_O(e,s,2),f=Array.from(e.keys()).sort((T,S)=>T.localeCompare(S));if(a==="custom")for(const T of f){if(u.has(T)){Vd(e,T,!1);continue}const S=o.keepPerimeter&&l.has(T);Vd(e,T,S)}if(a==="native")return;const p=xe(Number(o.interiorDensity||0),0,.45),m=xe(Number(o.clusterBias||0),0,1);if(p<=0&&m<=0)return;const y=f.filter(T=>{if(l.has(T)||u.has(T))return!1;const S=e.get(T);if(!S)return!1;const x=S.traits;return!TO(x)}),b=T=>{const S=e.get(T);return S?Cb(S.traits):!1},v=new Set;for(const T of y){if(b(T))continue;s0(`${t}|sandbox-wall-seed|${T}`)<p&&v.add(T)}for(let T=0;T<2;T++)for(const S of y){if(b(S)||v.has(S))continue;const x=e.get(S);if(!x)continue;const _=wf(x.position).filter(k=>e.has(k));let E=0;for(const k of _)(b(k)||v.has(k))&&E++;if(E===0)continue;const w=m*(E/6);s0(`${t}|sandbox-wall-grow|pass:${T}|${S}`)<w&&v.add(S)}for(const T of v)Vd(e,T,!0)},OO=e=>{switch(e){case"inferno":return 4;case"throne":return 6;case"frozen":return 8;case"void":return 10;default:return 1}},kO=(e,t,s,o)=>{const a=OO(e),l=t.trim()||"biome-sandbox-seed",u=Is(a,l,l,void 0,Yn.VANGUARD),f=MO(u);return CO(f,l,u.player.position,o),s&&wO(f,u.player.position),{...u,floor:a,theme:e,rngSeed:l,initialSeed:l,turnNumber:1,tiles:f,visualEvents:[],timelineEvents:[],intentPreview:void 0}},Cl="/Hop",a0=64,o0=192,Ol=64,kl=512,nt=(e,t,s)=>Math.min(s,Math.max(t,e)),NO=(e,t)=>`${e.endsWith("/")?e:`${e}/`}${t.replace(/^\/+/,"")}`,Uo=e=>{const t=e.trim();if(!t||/^\/assets\/[a-z0-9/_\-.]+$/i.test(t))return t;const o=`${Cl.endsWith("/")?Cl:`${Cl}/`}assets/`;return t.startsWith(o)?`/assets/${t.slice(o.length)}`:t.startsWith("/")?t:NO(Cl,t)},Nl=(e,t="#8b6f4a")=>{const s=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(s))return s.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(s)){const[l,u,f]=s.slice(1).split("");return`#${l}${l}${u}${u}${f}${f}`.toLowerCase()}return t},uf=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",Rl=e=>e==="off"?"off":uf(e),RO=e=>{const t=e.theme.toLowerCase(),s=Uo(e.undercurrent.path),o=Uo(e.crust.path),a=Uo(e.materials.detailA.path),l=Uo(e.materials.detailB.path),f={mountainPath:Uo(e.walls.mountainPath),mountainScale:nt(e.walls.mountainScale,.2,3),mountainOffsetX:e.walls.mountainOffsetX,mountainOffsetY:e.walls.mountainOffsetY,mountainAnchorX:nt(e.walls.mountainAnchorX,0,1),mountainAnchorY:nt(e.walls.mountainAnchorY,0,1),mountainCrustBlendMode:Rl(e.walls.mountainCrustBlendMode),mountainCrustBlendOpacity:nt(e.walls.mountainCrustBlendOpacity,0,1),mountainTintColor:Nl(e.walls.mountainTintColor,"#7d7d7d"),mountainTintBlendMode:Rl(e.walls.mountainTintBlendMode),mountainTintOpacity:nt(e.walls.mountainTintOpacity,0,1),scale:nt(e.walls.mountainScale,.2,3),offsetX:e.walls.mountainOffsetX,offsetY:e.walls.mountainOffsetY,anchorX:nt(e.walls.mountainAnchorX,0,1),anchorY:nt(e.walls.mountainAnchorY,0,1),crustBlendMode:Rl(e.walls.mountainCrustBlendMode),crustBlendOpacity:nt(e.walls.mountainCrustBlendOpacity,0,1),tintColor:Nl(e.walls.mountainTintColor,"#7d7d7d"),tintBlendMode:Rl(e.walls.mountainTintBlendMode),tintOpacity:nt(e.walls.mountainTintOpacity,0,1)},p={seed:e.seed.trim()||"biome-sandbox-seed",injectHazards:e.injectHazards,biomeLayers:{undercurrent:{default:s,mode:e.undercurrent.mode,scalePx:nt(e.undercurrent.scalePx,a0,o0),opacity:nt(e.undercurrent.opacity,0,1),offsetX:e.undercurrent.offsetX,offsetY:e.undercurrent.offsetY,scroll:{x:e.undercurrent.scrollX,y:e.undercurrent.scrollY,durationMs:Math.max(1e3,e.undercurrent.scrollDurationMs)}},crust:{default:o,mode:e.crust.mode,scalePx:Math.max(64,e.crust.scalePx),opacity:1,seedShiftPx:e.crust.seedShiftPx,offsetX:e.crust.offsetX,offsetY:e.crust.offsetY},clutter:{density:e.clutter.density,maxPerHex:e.clutter.maxPerHex,bleedScaleMax:e.clutter.bleedScaleMax}},walls:{mode:e.walls.mode,interiorDensity:e.walls.interiorDensity,clusterBias:e.walls.clusterBias,keepPerimeter:e.walls.keepPerimeter,...f},biomeMaterials:{crust:{detailA:{default:a,mode:e.materials.detailA.mode,scalePx:nt(e.materials.detailA.scalePx,Ol,kl),opacity:nt(e.materials.detailA.opacity,0,1)},detailB:{default:l,mode:e.materials.detailB.mode,scalePx:nt(e.materials.detailB.scalePx,Ol,kl),opacity:nt(e.materials.detailB.opacity,0,1)},tint:{default:Nl(e.materials.tintColor,"#8b6f4a"),opacity:nt(e.materials.tintOpacity,0,1),blendMode:uf(e.materials.tintBlend)}}}};return{theme:e.theme,seed:e.seed.trim()||"biome-sandbox-seed",injectHazards:e.injectHazards,biomeLayers:{undercurrent:{default:s,mode:e.undercurrent.mode,scalePx:nt(e.undercurrent.scalePx,a0,o0),opacity:nt(e.undercurrent.opacity,0,1),offsetX:e.undercurrent.offsetX,offsetY:e.undercurrent.offsetY,scroll:{x:e.undercurrent.scrollX,y:e.undercurrent.scrollY,durationMs:Math.max(1e3,e.undercurrent.scrollDurationMs)}},crust:{default:o,mode:e.crust.mode,scalePx:Math.max(64,e.crust.scalePx),opacity:1,seedShiftPx:e.crust.seedShiftPx,offsetX:e.crust.offsetX,offsetY:e.crust.offsetY},clutter:{density:e.clutter.density,maxPerHex:e.clutter.maxPerHex,bleedScaleMax:e.clutter.bleedScaleMax}},walls:{mode:e.walls.mode,interiorDensity:e.walls.interiorDensity,clusterBias:e.walls.clusterBias,keepPerimeter:e.walls.keepPerimeter,...f,themes:{[t]:f}},biomeMaterials:{crust:{detailA:{default:a,mode:e.materials.detailA.mode,scalePx:nt(e.materials.detailA.scalePx,Ol,kl),opacity:nt(e.materials.detailA.opacity,0,1)},detailB:{default:l,mode:e.materials.detailB.mode,scalePx:nt(e.materials.detailB.scalePx,Ol,kl),opacity:nt(e.materials.detailB.opacity,0,1)},tint:{default:Nl(e.materials.tintColor,"#8b6f4a"),opacity:nt(e.materials.tintOpacity,0,1),blendMode:uf(e.materials.tintBlend)}}},biomePresets:{[t]:p}}},Il=(e,t)=>e?t&&e.themes?.[t]?e.themes[t]:e.default||"":"",Ll=e=>e?e.mode==="cover"||e.mode==="repeat"||e.mode==="off"?e.mode:"repeat":"off",IO=(e,t)=>e?t&&e.themes?.[t]?e.themes[t]:e.default||"#8b6f4a":"#8b6f4a",Yd=(e,t,s,o)=>{const a=e?.[s]??e?.[o];return a!==void 0?a:t?.[s]??t?.[o]},r0=(e,t)=>{const s=t.toLowerCase(),o=Mf(e,s),a=o?.biomeLayers?.undercurrent??e.biomeLayers?.undercurrent,l=o?.biomeLayers?.crust??e.biomeLayers?.crust??(e.biomeUnderlay?{default:e.biomeUnderlay.default,themes:e.biomeUnderlay.themes,mode:e.biomeUnderlay.mode,scalePx:e.biomeUnderlay.scalePx,opacity:e.biomeUnderlay.opacity}:void 0),u=o?.biomeMaterials?.crust??e.biomeMaterials?.crust,f=u?.detailA,p=u?.detailB,m=u?.tint,y=o?.walls||e.walls,b=o?.walls?o.walls:e.walls?.themes?.[s],v=(e.assets||[]).filter(O=>{if(O.type!=="prop")return!1;const I=O.id.toLowerCase(),D=new Set((O.tags||[]).map(U=>U.toLowerCase()));if(!I.includes("mountain")&&!D.has("mountain"))return!1;if(!O.theme)return!0;const j=O.theme.toLowerCase();return j===s||j==="core"}).sort((O,I)=>O.id.localeCompare(I.id)),S=String(b?.mountainPath??y?.mountainPath??"").trim()||v.find(O=>O.path.toLowerCase().includes("biome.volcano.mountain.03.webp"))?.path||v[0]?.path||"",x=v.find(O=>O.path===S)||v[0],_=x?.mountainSettings,E=x?.mountainSettingsByTheme?.[s],w=x?o?.assetOverrides?.[x.id]?.mountainSettings:void 0,M=(O,I,D)=>{const U=Yd(b,y,O,I)??w?.[O]??E?.[O]??_?.[O]??D,q=Number(U);return Number.isFinite(q)?q:D},k=(O,I,D)=>{const U=Yd(b,y,O,I)??w?.[O]??E?.[O]??_?.[O]??D;return Go(U)},R=(O,I,D)=>{const U=Yd(b,y,O,I)??w?.[O]??E?.[O]??_?.[O]??D;return Na(String(U||""),D)};return{theme:t,seed:String(o?.seed||"biome-sandbox-seed"),injectHazards:o?.injectHazards!==void 0?!!o.injectHazards:!0,undercurrent:{path:Il(a,s),mode:Ll(a),scalePx:xe(Number(a?.scalePx??e.tileUnitPx??256),Wl,Xl),opacity:xe(Number(a?.opacity??.6),0,1),scrollX:Number(a?.scroll?.x??120),scrollY:Number(a?.scroll?.y??90),scrollDurationMs:Math.max(1e3,Number(a?.scroll?.durationMs??92e3)),offsetX:Number(a?.offsetX??0),offsetY:Number(a?.offsetY??0)},crust:{path:Il(l,s),mode:Ll(l),scalePx:Math.max(64,Number(l?.scalePx??e.tileUnitPx??256)),opacity:1,seedShiftPx:Math.max(0,Number(l?.seedShiftPx??96)),offsetX:Number(l?.offsetX??0),offsetY:Number(l?.offsetY??0)},clutter:{density:xe(Number((o?.biomeLayers?.clutter??e.biomeLayers?.clutter)?.density??.14),0,1),maxPerHex:Math.max(0,Number((o?.biomeLayers?.clutter??e.biomeLayers?.clutter)?.maxPerHex??1)),bleedScaleMax:xe(Number((o?.biomeLayers?.clutter??e.biomeLayers?.clutter)?.bleedScaleMax??2),1,2)},walls:{mode:y?.mode==="native"||y?.mode==="additive"||y?.mode==="custom"?y.mode:"custom",interiorDensity:xe(Number(y?.interiorDensity??.05),0,.45),clusterBias:xe(Number(y?.clusterBias??0),0,1),keepPerimeter:y?.keepPerimeter!==void 0?!!y.keepPerimeter:!0,mountainPath:S,mountainScale:xe(M("scale","mountainScale",.53),.2,3),mountainOffsetX:M("offsetX","mountainOffsetX",0),mountainOffsetY:M("offsetY","mountainOffsetY",0),mountainAnchorX:xe(M("anchorX","mountainAnchorX",.5),0,1),mountainAnchorY:xe(M("anchorY","mountainAnchorY",.55),0,1),mountainCrustBlendMode:k("crustBlendMode","mountainCrustBlendMode","multiply"),mountainCrustBlendOpacity:xe(M("crustBlendOpacity","mountainCrustBlendOpacity",1),0,1),mountainTintColor:R("tintColor","mountainTintColor","#7d7d7d"),mountainTintBlendMode:k("tintBlendMode","mountainTintBlendMode","overlay"),mountainTintOpacity:xe(M("tintOpacity","mountainTintOpacity",1),0,1)},materials:{detailA:{path:Il(f,s),mode:Ll(f),scalePx:xe(Number(f?.scalePx??192),Xi,Gi),opacity:xe(Number(f?.opacity??0),0,1)},detailB:{path:Il(p,s),mode:Ll(p),scalePx:xe(Number(p?.scalePx??256),Xi,Gi),opacity:xe(Number(p?.opacity??0),0,1)},tintColor:IO(m,s),tintOpacity:xe(Number(m?.opacity??0),0,1),tintBlend:ac(m?.blendMode)}}},l0="hop_biome_sandbox_settings_v1",LO=e=>e==="native"||e==="additive"||e==="custom",BO=e=>{if(!e)return null;try{const t=JSON.parse(e);return!t||typeof t!="object"?null:t}catch{return null}},PO=(e,t)=>t?{...e,...t,undercurrent:{...e.undercurrent,...t.undercurrent||{},scalePx:xe(Number((t.undercurrent||{}).scalePx??e.undercurrent.scalePx),Wl,Xl)},crust:{...e.crust,...t.crust||{},opacity:1},clutter:{...e.clutter,...t.clutter||{}},walls:{...e.walls,...t.walls||{},mode:LO((t.walls||{}).mode)?(t.walls||{}).mode:e.walls.mode,interiorDensity:xe(Number((t.walls||{}).interiorDensity??e.walls.interiorDensity),0,.45),clusterBias:xe(Number((t.walls||{}).clusterBias??e.walls.clusterBias),0,1),keepPerimeter:(t.walls||{}).keepPerimeter!==void 0?!!(t.walls||{}).keepPerimeter:e.walls.keepPerimeter,mountainPath:String((t.walls||{}).mountainPath||e.walls.mountainPath||""),mountainScale:xe(Number((t.walls||{}).mountainScale??e.walls.mountainScale),.2,3),mountainOffsetX:qe(String((t.walls||{}).mountainOffsetX??e.walls.mountainOffsetX),e.walls.mountainOffsetX),mountainOffsetY:qe(String((t.walls||{}).mountainOffsetY??e.walls.mountainOffsetY),e.walls.mountainOffsetY),mountainAnchorX:xe(Number((t.walls||{}).mountainAnchorX??e.walls.mountainAnchorX),0,1),mountainAnchorY:xe(Number((t.walls||{}).mountainAnchorY??e.walls.mountainAnchorY),0,1),mountainCrustBlendMode:Go((t.walls||{}).mountainCrustBlendMode??e.walls.mountainCrustBlendMode),mountainCrustBlendOpacity:xe(Number((t.walls||{}).mountainCrustBlendOpacity??e.walls.mountainCrustBlendOpacity),0,1),mountainTintColor:Na(String((t.walls||{}).mountainTintColor??e.walls.mountainTintColor),e.walls.mountainTintColor),mountainTintBlendMode:Go((t.walls||{}).mountainTintBlendMode??e.walls.mountainTintBlendMode),mountainTintOpacity:xe(Number((t.walls||{}).mountainTintOpacity??e.walls.mountainTintOpacity),0,1)},materials:{...e.materials,...t.materials||{},detailA:{...e.materials.detailA,...(t.materials||{}).detailA||{},scalePx:xe(Number(((t.materials||{}).detailA||{}).scalePx??e.materials.detailA.scalePx),Xi,Gi),opacity:xe(Number(((t.materials||{}).detailA||{}).opacity??e.materials.detailA.opacity),0,1)},detailB:{...e.materials.detailB,...(t.materials||{}).detailB||{},scalePx:xe(Number(((t.materials||{}).detailB||{}).scalePx??e.materials.detailB.scalePx),Xi,Gi),opacity:xe(Number(((t.materials||{}).detailB||{}).opacity??e.materials.detailB.opacity),0,1)},tintOpacity:xe(Number((t.materials||{}).tintOpacity??e.materials.tintOpacity),0,1),tintBlend:ac((t.materials||{}).tintBlend)}}:e,HO=e=>{const t=N.useRef(!1),[s,o]=N.useState(""),[a,l]=N.useState(null);return N.useEffect(()=>{if(!e||t.current)return;const p=r0(e,"inferno"),m=BO(localStorage.getItem(l0));l(PO(p,m)),t.current=!0},[e]),N.useEffect(()=>{a&&localStorage.setItem(l0,JSON.stringify(a))},[a]),{settings:a,setSettings:l,copyStatus:s,copySettings:async()=>{if(!a)return;const p=RO(a);try{await navigator.clipboard.writeText(JSON.stringify(p,null,2)),o("Copied"),window.setTimeout(()=>o(""),1600)}catch{o("Copy failed"),window.setTimeout(()=>o(""),1600)}},resetSettings:()=>{e&&l(p=>p&&r0(e,p.theme))}}},jO=({assetManifest:e,onBack:t})=>{const{settings:s,setSettings:o,copyStatus:a,copySettings:l,resetSettings:u}=HO(e),f=s?.theme?.toLowerCase()||"inferno",p=N.useMemo(()=>Na(s?.materials.tintColor||"#8b6f4a"),[s?.materials.tintColor]),m=N.useMemo(()=>Na(s?.walls.mountainTintColor||"#8b6f4a"),[s?.walls.mountainTintColor]),y=vO(e),b=N.useMemo(()=>SO(e,s,f),[e,s,f]),v=N.useMemo(()=>s?kO(s.theme,s.seed,s.injectHazards,s.walls):null,[s]);return!e||!s||!b||!v?g.jsxs("div",{className:"w-screen h-screen bg-[#030712] text-white flex items-center justify-center",children:[g.jsx("button",{type:"button",onClick:t,className:"absolute top-5 left-5 px-4 py-2 rounded-lg border border-white/20 bg-white/5 hover:bg-white/10 text-xs font-black uppercase tracking-[0.2em]",children:"Back"}),g.jsx("div",{className:"text-sm text-white/70 uppercase tracking-[0.25em] font-black",children:"Loading Biome Sandbox..."})]}):g.jsxs("div",{className:"w-screen h-screen bg-[#030712] text-white flex",children:[g.jsx(aw,{settings:s,setSettings:o,pathSets:y,copyStatus:a,onBack:t,onReset:u,onCopySettings:l,tintPickerColor:p,mountainTintPickerColor:m}),g.jsx(yO,{theme:s.theme,previewState:v,previewManifest:b})]})},DO=()=>{const[e,t]=N.useState(null);return N.useEffect(()=>{let s=!0;return ZC().then(o=>{s&&(t(o),window.__HOP_ASSET_MANIFEST=o)}),()=>{s=!1}},[]),e},UO=e=>{N.useEffect(()=>{if(!(typeof window<"u"&&!!window.__HOP_DEBUG_PERF))return;let s=0,o=performance.now(),a=0,l=0,u=o;const f=p=>{const m=p-o;if(o=p,a++,l+=m,p-u>=2e3){const y=l/Math.max(1,a),b=1e3/Math.max(1,y);console.log("[HOP_PERF]",{fps:Number(b.toFixed(1)),avgFrameMs:Number(y.toFixed(2)),frames:a}),u=p,a=0,l=0}s=requestAnimationFrame(f)};return s=requestAnimationFrame(f),()=>cancelAnimationFrame(s)},e)},$O=(e,t)=>{N.useEffect(()=>{t&&(window.state=e,window.QUERY={tile:(s,o)=>{const l=ce({q:s,r:o});return console.log(`Checking Map for Key: "${l}"`),e.tiles.get(l)},whereAmI:()=>{const s=e.player.position,o=ce(s),a=e.tiles.get(o);return{coords:s,key:o,tileExists:!!a,tileData:a}},dumpKeys:()=>Array.from(e.tiles.keys())})},[e,t])},qO=e=>{const[t,s]=N.useState(null),o=N.useRef(null);return N.useEffect(()=>{if(e.gameStatus!=="playing"||o.current===e.floor)return;s({floor:e.floor,theme:e.theme||"Inferno"}),o.current=e.floor;const a=setTimeout(()=>s(null),3e3);return()=>clearTimeout(a)},[e.floor,e.gameStatus,e.theme]),t},zO=e=>e instanceof Map?e:Array.isArray(e)?new Map(e):e&&typeof e=="object"?new Map(Object.entries(e)):new Map,c0=e=>{const t={...e,components:zO(e?.components)},s=zo(t),a=(s.components??new Map).get("trinity");if(!a)return s;const l=tc({body:Number(a.body||0),mind:Number(a.mind||0),instinct:Number(a.instinct||0)});return{...s,maxHp:l,hp:Math.min(l,Math.max(0,Number(s.hp??l)))}},VO=()=>{const e=localStorage.getItem("hop_save");if(!e)return Kl();try{const t=JSON.parse(e);if(t.tiles){const s=Array.isArray(t.tiles)?t.tiles:Object.entries(t.tiles);t.tiles=new Map(s.map(([o,a])=>[o,{...a,traits:new Set(a.traits)}]))}return Array.isArray(t.occupancyMask)&&(t.occupancyMask=t.occupancyMask.map(s=>typeof s=="string"?BigInt(s):s)),t.player=Af(c0(t.player)),t.enemies=Array.isArray(t.enemies)?t.enemies.map(c0):[],t}catch(t){return console.error("Failed to hydrate Map state:",t),Kl()}},YO=()=>{const[e,t]=N.useReducer(jM,null,VO),s=N.useRef(null),o=N.useRef(""),a=e.gameStatus==="playing"||e.gameStatus==="choosing_upgrade",l=`${e.gameStatus}|${e.floor}|${e.turnNumber}|${e.player.hp}|${ce(e.player.position)}|${e.enemies.length}|${e.actionLog?.length??0}|${e.message?.length??0}`;return N.useEffect(()=>{if(s.current!==null&&(typeof window.cancelIdleCallback=="function"?window.cancelIdleCallback(s.current):window.clearTimeout(s.current),s.current=null),!a){o.current="",localStorage.removeItem("hop_save");return}if(l===o.current)return;const u=()=>{const f={...e,tiles:Array.from(e.tiles.entries()).map(([m,y])=>[m,{...y,traits:Array.from(y.traits)}])},p=m=>JSON.stringify(m,(y,b)=>typeof b=="bigint"?b.toString():b);localStorage.setItem("hop_save",p(f)),o.current=l,s.current=null};return typeof window.requestIdleCallback=="function"?s.current=window.requestIdleCallback(u,{timeout:500}):s.current=window.setTimeout(u,120),()=>{s.current!==null&&(typeof window.cancelIdleCallback=="function"?window.cancelIdleCallback(s.current):window.clearTimeout(s.current),s.current=null)}},[e,a,l]),[e,t]},KO=({dispatchWithTrace:e})=>{const[t,s]=N.useState(!1),[o,a]=N.useState([]),[l,u]=N.useState(!1),[f,p]=N.useState(null),m=N.useRef(0),y=N.useCallback(()=>{u(!1),s(!1),p(null),a([]),m.current=0},[]),b=N.useCallback(T=>{if(!T)return;const S=bb(T.actions||[]);if(!S.valid){const w=`Replay rejected: ${S.errors.slice(0,3).join(" | ")}`;p(w),console.error("[HOP_REPLAY] Invalid replay actions",{replayId:T.id,errors:S.errors});return}p(null),s(!0),a(S.actions),u(!1),m.current=0;const x=T.seed||T.id||String(Date.now()),_=T.loadoutId?Yn[T.loadoutId]:void 0,E=Is(1,x,x,void 0,_);e({type:"LOAD_STATE",payload:E},"replay_start")},[e]),v=N.useCallback(()=>{const T=m.current;if(T>=o.length){u(!1);return}e(o[T],"replay_step"),m.current=T+1},[e,o]);return N.useEffect(()=>{if(!l||!t)return;const T=window.setInterval(v,500);return()=>window.clearInterval(T)},[l,t,v]),{isReplayMode:t,replayActions:o,replayActive:l,replayError:f,replayIndexRef:m,setReplayActive:u,resetReplayUi:y,startReplay:b,stepReplay:v}},FO=(e,t)=>{const s=new Set(e.map(f=>f.type)),o=s.has("ADVANCE_TURN"),a=s.has("RESOLVE_PENDING"),l=e.length,u=t>=5&&l<Math.max(25,t*4);return{actionCount:l,hasTurnAdvance:o,hasPendingResolve:a,suspiciouslyShort:u}},u0="hop_replays_v1",d0="hop_leaderboard_v1",WO=(e,t)=>{const s=N.useRef(null);N.useEffect(()=>{if(!t){if((e.gameStatus==="won"||e.gameStatus==="lost")&&s.current!==e.initialSeed){s.current=e.initialSeed||"default";const o=e.initialSeed??e.rngSeed??"0",a=e.completedRun?.score||(e.player.hp||0)+(e.floor||0)*100,l=bb(e.actionLog||[]);if(!l.valid){console.error("[HOP_REPLAY] Refusing to persist replay with invalid action log",{errors:l.errors});return}const u=FO(l.actions,e.floor||0),f={id:`run-${Date.now()}`,seed:o,loadoutId:e.player.archetype,actions:l.actions,score:a,floor:e.floor,date:new Date().toISOString(),replayVersion:2,diagnostics:u},p=localStorage.getItem(u0),m=p?JSON.parse(p):[],y=[f,...m].slice(0,100);localStorage.setItem(u0,JSON.stringify(y));const b=localStorage.getItem(d0);let v=b?JSON.parse(b):[];v.push({id:f.id,name:"Player",score:f.score,floor:f.floor,date:f.date,seed:f.seed,loadoutId:f.loadoutId,actions:f.actions,replayVersion:f.replayVersion,diagnostics:f.diagnostics}),v.sort((T,S)=>S.score-T.score),v=v.slice(0,5),localStorage.setItem(d0,JSON.stringify(v))}e.gameStatus==="hub"&&(s.current=null)}},[e.gameStatus,e.initialSeed,e.rngSeed,e.completedRun?.score,e.floor,e.player.hp,e.player.archetype,e.actionLog,t])},XO=(e,t)=>{const s=[];for(const o of e)if(o.type==="DamageTaken"&&o.targetId===t){const a=Math.max(0,Number(o.payload?.amount||0));a>0&&s.push({id:`sim-toast-${o.id}`,text:`-${a} HP`,tone:"damage"})}else if(o.type==="Healed"&&o.targetId===t){const a=Math.max(0,Number(o.payload?.amount||0));a>0&&s.push({id:`sim-toast-${o.id}`,text:`+${a} HP`,tone:"heal"})}else if(o.type==="StatusApplied"&&o.targetId===t){const l=String(o.payload?.status||"Status").split("_").filter(Boolean).map(u=>u.charAt(0).toUpperCase()+u.slice(1)).join(" ");s.push({id:`sim-toast-${o.id}`,text:l,tone:"status"})}else if(o.type==="AilmentResilienceGained"&&o.targetId===t){const a=String(o.payload?.ailment||"ailment"),l=Number(o.payload?.nextPct||0);s.push({id:`sim-toast-${o.id}`,text:`Hardened: ${a} ${l.toFixed(1)}%`,tone:"status"})}else if(o.type==="AilmentThresholdTriggered"&&o.targetId===t){const a=String(o.payload?.effectId||"Threshold");s.push({id:`sim-toast-${o.id}`,text:a,tone:"status"})}else if(o.type==="MessageLogged"){const a=String(o.payload?.text||"").trim();if(!a)continue;const l=a.toLowerCase();if(!(l.includes("stun")||l.includes("snare")||l.includes("lava")||l.includes("fire")||l.includes("burn")||l.includes("heal")||l.includes("shrine")||l.includes("stairs")||l.includes("roll away")||l.includes("ward")||l.includes("orb")))continue;const f=a.length>52?`${a.slice(0,49)}...`:a;s.push({id:`sim-toast-${o.id}`,text:f,tone:"system"})}return s},GO=({gameState:e,appendTurnTrace:t})=>{const s=N.useRef([]),o=N.useRef(null),a=N.useRef(""),[l,u]=N.useState([]),f=N.useCallback(y=>{const b=Date.now();u(v=>[...v,{...y,createdAt:b}].slice(-4))},[]),p=N.useCallback(y=>{if(!(!y||y.length===0)){s.current=[...s.current,...y].slice(-600),window.__HOP_SIM_EVENTS=s.current,window.dispatchEvent(new CustomEvent("hop:simulation-events",{detail:{turn:e.turnNumber,events:y}})),t("SIM_EVENTS",{count:y.length,lastType:y[y.length-1]?.type??"unknown"});for(const b of XO(y,e.player.id))f(b)}},[t,e.turnNumber,e.player.id,f]),m=N.useCallback(y=>{o.current=y,window.__HOP_UI_MIRROR=y},[]);return N.useEffect(()=>(window.__HOP_SIM_EVENTS=s.current,window.__HOP_DUMP_SIM_EVENTS=()=>[...s.current],window.__HOP_CLEAR_SIM_EVENTS=()=>{s.current=[],window.__HOP_SIM_EVENTS=[]},window.__HOP_DUMP_MIRROR=()=>window.__HOP_MIRROR_LAST,()=>{delete window.__HOP_DUMP_SIM_EVENTS,delete window.__HOP_CLEAR_SIM_EVENTS,delete window.__HOP_DUMP_MIRROR}),[]),N.useEffect(()=>{if(l.length===0)return;const y=window.setTimeout(()=>{const b=Date.now();u(v=>v.filter(T=>b-T.createdAt<2200))},180);return()=>window.clearTimeout(y)},[l]),N.useEffect(()=>{const y=KM(e);window.__HOP_ENGINE_MIRROR=y;const b=o.current;if(!b||b.turn!==y.turn||b.stackTick!==y.stackTick)return;const v=FM(y,b),T=`${y.turn}:${y.stackTick}:${v.ok?"ok":v.mismatches.length}`;T!==a.current&&(a.current=T,window.__HOP_MIRROR_LAST={engineSnapshot:y,uiSnapshot:b,result:v},v.ok||(t("MIRROR_MISMATCH",{count:v.mismatches.length}),console.warn("[HOP_MIRROR] snapshot mismatch detected",v.mismatches)))},[e,t]),{mobileToasts:l,handleSimulationEvents:p,handleUiMirrorSnapshot:m}},JO=e=>{const t=e||[],s=t.length>0?t[t.length-1]:void 0;return`${t.length}:${s?.type??"none"}`},QO=e=>{const t=e||[],s=t.length>0?t[t.length-1]:void 0;return`${t.length}:${s?.id??"none"}:${s?.phase??"none"}`},ZO=({gameState:e,turnDriver:t,isBusy:s,isReplayMode:o,postCommitInputLock:a,setPostCommitInputLock:l,appendTurnTrace:u,dispatchWithTrace:f})=>{const[p,m]=N.useState(0),y=N.useRef(null),b=N.useRef(null),v=N.useRef(null),T=N.useRef(null),S=N.useRef(""),x=N.useRef(""),_=N.useRef(!1),E=N.useRef(""),w=N.useRef(""),M=N.useRef(!1),k=N.useRef(0),R=220,O=900,I=e.pendingFrames?.length??0,D=JO(e.visualEvents),j=QO(e.timelineEvents),U=`${e.pendingStatus?.status??"none"}:${I}`,q=N.useCallback((ee="unknown")=>{a&&u("LOCK_RELEASE",{reason:ee,lockTurn:y.current,expectedActionLogLength:b.current}),l(!1),y.current=null,b.current=null,v.current=null,_.current=!1,E.current="",w.current="",T.current!==null&&(window.clearTimeout(T.current),T.current=null)},[u,a,l]);return N.useEffect(()=>{if(!t.shouldAdvanceQueue)return;u("QUEUE_SCHEDULE",{delayMs:t.queueAdvanceDelayMs});const ee=window.setTimeout(()=>{f({type:"ADVANCE_TURN"},"queue_pump")},t.queueAdvanceDelayMs);return()=>window.clearTimeout(ee)},[t.shouldAdvanceQueue,t.queueAdvanceDelayMs,e.turnNumber,e.initiativeQueue,e.player.id,e.enemies,f,u]),N.useEffect(()=>{s||(S.current=D,x.current=j)},[s,D,j]),N.useEffect(()=>{M.current=!1,k.current=performance.now()},[U]),N.useEffect(()=>{(e.pendingStatus||I>0)&&s&&(M.current=!0)},[e.pendingStatus,I,s]),N.useEffect(()=>{a&&s&&(_.current=!0)},[a,s]),N.useEffect(()=>{if(!a)return;const ee=window.setTimeout(()=>{m(oe=>oe+1)},120);return()=>window.clearTimeout(ee)},[a,p]),N.useEffect(()=>{const ee=!s&&D===S.current&&j===x.current,oe=(e.timelineEvents||[]).some(X=>X.blocking),F=(e.timelineEvents||[]).filter(X=>X.blocking).reduce((X,ae)=>X+(ae.suggestedDurationMs||0),0),P=(e.visualEvents||[]).reduce((X,ae)=>{if(ae.type!=="kinetic_trace")return X;const le=ae.payload;if(!le)return X;const ue=Math.max(0,Number(le.startDelayMs||0)),be=Math.max(0,Number(le.durationMs||0));return Math.max(X,ue+be)},0),z=Math.max(F,P),Z=z>0?Math.max(160,Math.min(3200,z+40)):0,re=Math.max(0,performance.now()-k.current),pe=!oe||M.current,B=!oe||re>=Z,W=ee&&(pe||B);if(t.shouldResolvePending){if(W){u("PENDING_RESOLVE_READY",{noPendingAnimations:ee,hasBlockingTimeline:oe,movementTraceBudgetMs:P,elapsedPendingMs:re,requiredFallbackDelayMs:Z}),f({type:"RESOLVE_PENDING"},"pending_ready");return}if(!s&&oe&&!M.current){u("PENDING_RESOLVE_WAIT",{movementTraceBudgetMs:P,elapsedPendingMs:re,requiredFallbackDelayMs:Z});const X=Math.max(0,Z-re),ae=window.setTimeout(()=>{f({type:"RESOLVE_PENDING"},"pending_fallback_delay")},X);return()=>window.clearTimeout(ae)}}},[t.shouldResolvePending,e.timelineEvents,e.visualEvents,s,D,j,f,u]),N.useEffect(()=>{if(!a)return;if(o||e.gameStatus!=="playing"){q("mode_or_status_change");return}if(e.pendingStatus||(e.pendingFrames?.length??0)>0){q("pending_intercept");return}const ee=y.current,oe=b.current,F=v.current!==null?Math.max(0,performance.now()-v.current):Number.POSITIVE_INFINITY,P=ee!==null?e.turnNumber>ee:!1,z=oe!==null?(e.actionLog?.length??0)>=oe:!1,Z=F>=R,re=D!==E.current||j!==w.current,pe=!P&&!z,B=!_.current&&re&&F<O,W=e.gameStatus==="playing"&&!o&&!s&&!e.pendingStatus&&(e.pendingFrames?.length??0)===0&&Wo(e);if(B){u("LOCK_WAIT_FOR_BUSY",{lockAgeMs:F,visualsChangedSinceArm:re});return}if(W&&pe&&F>450){q("no_progress_timeout");return}W&&Z&&(P||z||F>1500)&&q(P?"turn_advanced":z?"action_committed":"age_fallback")},[a,o,e.gameStatus,e.turnNumber,e.pendingStatus,e.pendingFrames,e.initiativeQueue,e.actionLog,s,e.player.id,e.enemies,u,D,j,p,q]),N.useEffect(()=>{e.gameStatus!=="playing"&&a&&q("not_playing")},[e.gameStatus,a,q]),N.useEffect(()=>{if(a)return T.current!==null&&window.clearTimeout(T.current),T.current=window.setTimeout(()=>{if(a){const ee=Array.isArray(window.__HOP_TURN_TRACE)?window.__HOP_TURN_TRACE:[];console.error("[HOP_INPUT_LOCK] Watchdog released stuck post-commit lock",{turnNumber:e.turnNumber,pendingStatus:e.pendingStatus?.status,pendingFrames:e.pendingFrames?.length??0,playerTurn:Wo(e),isBusy:s,actionLogLength:e.actionLog?.length??0,traceTail:ee.slice(-40)}),u("LOCK_WATCHDOG_RELEASE"),q("watchdog")}},8e3),()=>{T.current!==null&&(window.clearTimeout(T.current),T.current=null)}},[a,e.turnNumber,e.pendingStatus,e.actionLog,s,e.initiativeQueue,e.player.id,e.enemies,u,q]),N.useEffect(()=>{if(!a)return;const ee=window.setTimeout(()=>{u("LOCK_STALL_SNAPSHOT",{lockAgeMs:v.current!==null?Math.max(0,performance.now()-v.current):null})},2500);return()=>window.clearTimeout(ee)},[a,u]),{armPostCommitLock:N.useCallback(()=>{T.current!==null&&(window.clearTimeout(T.current),T.current=null),y.current=e.turnNumber,b.current=(e.actionLog?.length??0)+1,v.current=performance.now(),_.current=!1,E.current=D,w.current=j,l(!0),u("LOCK_ARM",{lockTurn:e.turnNumber,expectedActionLogLength:(e.actionLog?.length??0)+1,eventHashAtArm:D,timelineHashAtArm:j})},[e.turnNumber,e.actionLog,D,j,l,u])}},ek=e=>{const{gameStatus:t,isReplayMode:s,isBusy:o,postCommitInputLock:a,isPlayerTurn:l,hasPendingStatus:u,pendingFrameCount:f}=e,p=u||f>0;let m="IDLE";return s?m="REPLAY":t!=="playing"?m="IDLE":p?m=o?"INTERCEPT_ANIMATING":"INTERCEPT_READY":o?m="PLAYBACK":a&&l?m="POST_COMMIT_LOCK":a&&!l?m="POST_COMMIT_QUEUE":l?m="INPUT_OPEN":m="QUEUE_ADVANCE",{phase:m,canPlayerInput:m==="INPUT_OPEN",shouldAdvanceQueue:m==="QUEUE_ADVANCE"||m==="POST_COMMIT_QUEUE",shouldResolvePending:m==="INTERCEPT_READY",queueAdvanceDelayMs:380}},tk=({gameState:e,dispatch:t,isReplayMode:s,isBusy:o,postCommitInputLock:a,dispatchWithTraceProxyRef:l,summarizeActionPayload:u})=>{const f=e.pendingFrames?.length??0,p=N.useMemo(()=>ek({gameStatus:e.gameStatus,isReplayMode:s,isBusy:o,postCommitInputLock:a,isPlayerTurn:Wo(e),hasPendingStatus:!!e.pendingStatus,pendingFrameCount:f}),[e.gameStatus,s,o,a,e.pendingStatus,f,e.initiativeQueue,e.player.id,e.enemies]),m=!p.canPlayerInput,y=N.useRef([]),b=N.useRef(0),v=N.useRef(""),T=e.initiativeQueue?.entries?.[Math.max(0,e.initiativeQueue.currentIndex??0)]?.actorId??e.initiativeQueue?.entries?.[0]?.actorId??"none",S=N.useCallback((_,E)=>{const w={id:++b.current,t:Date.now(),event:_,turnNumber:e.turnNumber,phase:p.phase,gameStatus:e.gameStatus,playerTurn:Wo(e),isBusy:o,postCommitInputLock:a,pendingStatus:e.pendingStatus?.status??"none",pendingFrames:e.pendingFrames?.length??0,canPlayerInput:p.canPlayerInput,shouldAdvanceQueue:p.shouldAdvanceQueue,shouldResolvePending:p.shouldResolvePending,actionLogLength:e.actionLog?.length??0,queueHead:T,details:E};y.current.push(w),y.current.length>800&&y.current.splice(0,y.current.length-800)},[e.turnNumber,e.gameStatus,e.pendingStatus,e.pendingFrames,e.actionLog,e.initiativeQueue,e.player.id,e.enemies,p.phase,p.canPlayerInput,p.shouldAdvanceQueue,p.shouldResolvePending,o,a,T]),x=N.useCallback((_,E)=>{S("DISPATCH",{source:E,actionType:_.type,payload:u(_)}),t(_)},[S,t,u]);return l&&(l.current=x),N.useEffect(()=>{const _=[p.phase,e.turnNumber,e.gameStatus,e.pendingStatus?.status??"none",e.pendingFrames?.length??0,o?1:0,a?1:0,T].join("|");_!==v.current&&(S("TURN_STATE"),v.current=_)},[p.phase,e.turnNumber,e.gameStatus,e.pendingStatus,e.pendingFrames,o,a,T,S]),N.useEffect(()=>(window.__HOP_TURN_TRACE=y.current,window.__HOP_DUMP_TURN_TRACE=()=>[...y.current],window.__HOP_PRINT_TURN_TRACE=(_=80)=>{const E=y.current.slice(-Math.max(1,Math.floor(_)));return console.table(E.map(w=>({id:w.id,event:w.event,turn:w.turnNumber,phase:w.phase,status:w.gameStatus,playerTurn:w.playerTurn,busy:w.isBusy,lock:w.postCommitInputLock,pending:`${w.pendingStatus}/${w.pendingFrames}`,queueHead:w.queueHead,actionLog:w.actionLogLength,details:w.details?JSON.stringify(w.details):""}))),E},window.__HOP_CLEAR_TURN_TRACE=()=>{y.current.length=0,b.current=0},y.current.push({id:++b.current,t:Date.now(),event:"TRACE_READY",turnNumber:0,phase:"INIT",gameStatus:"init",playerTurn:!1,isBusy:!1,postCommitInputLock:!1,pendingStatus:"none",pendingFrames:0,canPlayerInput:!1,shouldAdvanceQueue:!1,shouldResolvePending:!1,actionLogLength:0,queueHead:"none"}),()=>{delete window.__HOP_DUMP_TURN_TRACE,delete window.__HOP_PRINT_TURN_TRACE,delete window.__HOP_CLEAR_TURN_TRACE}),[]),{turnDriver:p,isInputLocked:m,appendTurnTrace:S,dispatchWithTrace:x}},nk=()=>{const[e,t]=N.useState(()=>window.location.pathname);N.useEffect(()=>{const a=()=>t(window.location.pathname);return window.addEventListener("popstate",a),()=>window.removeEventListener("popstate",a)},[]);const s=a=>{window.location.pathname!==a&&window.history.pushState({},"",a),t(a)},o=N.useMemo(()=>{const a=e.toLowerCase().startsWith("/hop")?"/Hop":"",l=`${a||""}`||"/",u=`${a}/Arcade`||"/Arcade",f=`${a}/Biomes`||"/Biomes",m=e.toLowerCase().replace(/\/+$/,""),y=m.endsWith("/arcade")||m.endsWith("/arcarde"),b=m.endsWith("/biomes");return{hubPath:l,arcadePath:u,biomesPath:f,isArcadeRoute:y,isBiomesRoute:b}},[e]);return{pathname:e,navigateTo:s,...o}},ik=({onSelect:e})=>g.jsxs("div",{className:"relative z-50 flex flex-col items-center justify-center p-8 gap-8 animate-in fade-in zoom-in duration-500",children:[g.jsxs("div",{className:"text-center space-y-2",children:[g.jsx("h1",{className:"text-4xl font-black uppercase tracking-widest text-white mb-2",children:"Select Class"}),g.jsx("p",{className:"text-white/40 text-sm uppercase tracking-wider",children:"Choose your combat doctrine"})]}),g.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl",children:Object.values(Yn).map(t=>g.jsxs("button",{onClick:()=>{console.log("Archetype Selected:",t.id),e(t)},className:"group relative flex flex-col items-start p-8 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/30 rounded-3xl transition-all hover:scale-[1.02] text-left cursor-pointer",children:[g.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity"}),g.jsxs("div",{className:"relative z-10 w-full",children:[g.jsxs("div",{className:"flex justify-between items-start mb-4",children:[g.jsx("div",{className:"p-3 bg-white/5 rounded-xl border border-white/10 group-hover:border-white/30 transition-colors",children:g.jsx("span",{className:"text-3xl",children:Xo(t.id==="ASSASSIN"?"assassin_player":t.id.toLowerCase(),"player").icon})}),g.jsx("div",{className:"px-3 py-1 bg-white/5 rounded-full border border-white/10 text-[10px] font-bold uppercase tracking-widest text-white/50",children:t.id==="VANGUARD"?"Standard":"Advanced"})]}),g.jsx("h3",{className:"text-2xl font-black uppercase tracking-wide text-white mb-2",children:t.name}),g.jsx("p",{className:"text-white/60 text-sm leading-relaxed mb-6 h-12",children:t.description}),g.jsxs("div",{className:"space-y-3",children:[g.jsx("div",{className:"text-[10px] uppercase tracking-widest text-white/30 font-bold border-b border-white/5 pb-1",children:"Starting Loadout"}),g.jsx("div",{className:"flex flex-wrap gap-2",children:t.startingSkills.map(s=>g.jsx("div",{className:"px-2 py-1 bg-black/40 rounded border border-white/10 text-[10px] text-blue-200",children:s.replace("_"," ")},s))})]})]})]},t.id))})]}),sk="hop_replays_v1",ak="hop_leaderboard_v1",f0=()=>{try{const e=localStorage.getItem(sk);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load replays",e),[]}},m0=()=>{try{const e=localStorage.getItem(ak);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load leaderboard",e),[]}},p0=e=>{const t=Array.isArray(e.actions)?e.actions:[],s=new Set(t.map(m=>m?.type)),o=s.has("ADVANCE_TURN"),a=s.has("RESOLVE_PENDING"),l=(e.floor||0)>=5&&t.length<Math.max(25,(e.floor||0)*4),u=(e.replayVersion??1)<2,f=t.length===0,p=f?"invalid replay":l?"truncated replay":u?"legacy replay":null;return{isLegacy:u,invalid:f,suspicious:l||e.floor>1&&!a,label:p,hasTurnAdvance:o,hasPendingResolve:a,actionCount:t.length}},h0=({onStartReplay:e})=>{const[t,s]=N.useState(()=>f0()),[o,a]=N.useState(()=>m0()),[l,u]=N.useState(""),[f,p]=N.useState(""),[m,y]=N.useState(""),[b,v]=N.useState(null);N.useEffect(()=>{const x=()=>{s(f0()),a(m0())};return window.addEventListener("storage",x),()=>window.removeEventListener("storage",x)},[]);const T=()=>{v(null);try{const x=m.trim();if(!x)return v("Paste actions JSON first."),null;const _=JSON.parse(x);let E=l.trim()||void 0,w=f.trim()||void 0,M=[];return Array.isArray(_)?M=_:_&&typeof _=="object"&&(M=Array.isArray(_.actions)?_.actions:[],E=E||(typeof _.seed=="string"?_.seed:void 0),w=w||(typeof _.loadoutId=="string"?_.loadoutId:void 0)),!Array.isArray(M)||M.length===0?(v('No actions found. Provide a JSON action array or object with "actions".'),null):M.filter(O=>O&&typeof O.type=="string").length===0?(v('Actions must be objects with a "type" field.'),null):{id:`manual-${Date.now()}`,seed:E,loadoutId:w,actions:M,score:0,floor:1,date:new Date().toISOString(),replayVersion:2,diagnostics:{actionCount:M.length,hasTurnAdvance:M.some(O=>O?.type==="ADVANCE_TURN"),hasPendingResolve:M.some(O=>O?.type==="RESOLVE_PENDING"),suspiciouslyShort:!1}}}catch(x){return v(`Invalid JSON: ${x?.message||"parse error"}`),null}},S=()=>{const x=T();x&&e(x)};return g.jsxs("div",{className:"flex flex-col gap-8",children:[g.jsxs("section",{children:[g.jsxs("div",{className:"flex items-center justify-between mb-4",children:[g.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-emerald-400",children:"Manual Replay"}),g.jsx("span",{className:"text-[10px] text-white/20 font-bold uppercase tracking-widest",children:"Paste from UPA"})]}),g.jsxs("div",{className:"space-y-2 p-3 rounded-2xl border border-white/5 bg-white/[0.02]",children:[g.jsx("input",{value:l,onChange:x=>u(x.target.value),placeholder:"Seed (optional if included in JSON)",className:"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-emerald-400/40"}),g.jsx("input",{value:f,onChange:x=>p(x.target.value),placeholder:"Loadout ID (optional)",className:"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-emerald-400/40"}),g.jsx("textarea",{value:m,onChange:x=>y(x.target.value),placeholder:'Paste JSON actions array, or object: {"seed":"...","loadoutId":"...","actions":[...]}',rows:6,className:"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-emerald-400/40 font-mono"}),b&&g.jsx("div",{className:"text-[10px] text-red-400 font-bold uppercase tracking-wider",children:b}),g.jsx("button",{onClick:S,className:"w-full py-2 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-400/30 text-emerald-300 text-xs font-black uppercase tracking-widest transition-colors",children:"Start Manual Replay"})]})]}),g.jsxs("section",{children:[g.jsxs("div",{className:"flex items-center justify-between mb-4",children:[g.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400",children:"Hall of Fame"}),g.jsx("span",{className:"text-[10px] text-white/20 font-bold uppercase tracking-widest",children:"Top 5 Only"})]}),g.jsxs("div",{className:"space-y-2",children:[o.length===0&&g.jsx("div",{className:"p-4 rounded-xl border border-white/5 bg-white/[0.02] text-center",children:g.jsx("span",{className:"text-[10px] text-white/30 uppercase font-black",children:"No Champions Yet"})}),o.slice(0,5).map((x,_)=>{const E={id:x.id,seed:x.seed,loadoutId:x.loadoutId,actions:x.actions||[],score:x.score,floor:x.floor,date:x.date,replayVersion:x.replayVersion,diagnostics:x.diagnostics},w=p0(E);return g.jsxs("button",{onClick:()=>e(E),className:"w-full group relative flex items-center gap-4 p-4 bg-white/[0.03] hover:bg-white/[0.07] border border-white/5 hover:border-indigo-500/30 rounded-2xl transition-all text-left",children:[g.jsx("div",{className:"flex-shrink-0 w-8 h-8 flex items-center justify-center bg-indigo-500/10 rounded-lg text-indigo-400 font-black text-sm border border-indigo-500/20",children:_+1}),g.jsxs("div",{className:"flex-1 min-w-0",children:[g.jsxs("div",{className:"flex justify-between items-center mb-0.5",children:[g.jsx("span",{className:"font-black text-white uppercase text-xs truncate tracking-wider",children:x.name}),g.jsx("span",{className:"text-[10px] font-black text-indigo-400 tabular-nums",children:x.score.toLocaleString()})]}),g.jsxs("div",{className:"text-[9px] text-white/30 font-bold uppercase tracking-widest",children:["Floor ",x.floor," * ",new Date(x.date).toLocaleDateString()," * ",w.actionCount," acts"]}),w.label&&g.jsx("div",{className:"text-[9px] mt-1 text-amber-400/80 font-bold uppercase tracking-widest",children:w.label})]}),g.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity text-indigo-400 text-xs",children:"Play"})]},x.id)})]})]}),g.jsxs("section",{children:[g.jsx("div",{className:"flex items-center justify-between mb-4",children:g.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-white/30",children:"Recent Simulations"})}),g.jsxs("div",{className:"space-y-1 max-h-[300px] overflow-y-auto custom-scrollbar pr-2",children:[t.length===0&&g.jsx("div",{className:"text-center py-4",children:g.jsx("span",{className:"text-[10px] text-white/10 uppercase font-bold",children:"Log Empty"})}),t.slice(0,10).map(x=>{const _=p0(x);return g.jsxs("button",{onClick:()=>e(x),className:"w-full flex items-center justify-between p-3 hover:bg-white/[0.04] rounded-xl transition-colors text-left group",children:[g.jsxs("div",{className:"min-w-0",children:[g.jsxs("div",{className:"text-[10px] font-bold text-white/60 mb-0.5 truncate uppercase",children:["Score: ",g.jsx("span",{className:"text-white",children:x.score})," * F",x.floor," * ",_.actionCount," acts"]}),g.jsx("div",{className:"text-[9px] text-white/20 font-medium",children:new Date(x.date).toLocaleTimeString()}),_.label&&g.jsx("div",{className:"text-[9px] mt-1 text-amber-400/80 font-bold uppercase tracking-widest",children:_.label})]}),g.jsx("div",{className:"text-[10px] text-white/0 group-hover:text-white/40 font-black uppercase tracking-widest transition-all",children:"Replay"})]},x.id)})]})]})]})};class ok{state;constructor(){this.state=Is(1,"tutorial-seed"),this.state.enemies=[],this.state.tiles=new Map}setPlayer(t,s){this.state.player={...this.state.player,position:t,previousPosition:t,activeSkills:s.map(o=>{const a=st.get(o);return{id:o,name:typeof a?.name=="function"?a.name(this.state):a?.name||o,description:a?.description||"",slot:a?.slot||"offensive",cooldown:a?.baseVariables.cooldown||0,currentCooldown:0,range:a?.baseVariables.range||0,upgrades:Object.keys(a?.upgrades||{}),activeUpgrades:[]}})}}spawnEnemy(t,s,o){const a=$l(t)?.bestiary.stats;this.state.enemies.push({id:o,type:"enemy",subtype:t,position:s,previousPosition:s,hp:a?.hp??1,maxHp:a?.maxHp??1,enemyType:a?.type??"melee",statusEffects:[],temporaryArmor:0,activeSkills:[],speed:a?.speed??1,factionId:"enemy"})}spawnFalcon(t,s){const o={id:s,type:"enemy",subtype:"falcon",factionId:"player",speed:95,position:{...t},previousPosition:{...t},hp:1,maxHp:1,statusEffects:[],temporaryArmor:0,activeSkills:[],isFlying:!0,companionOf:"player",companionState:{mode:"roost",orbitStep:0,apexStrikeCooldown:0}};this.state.enemies.push(o),this.state.companions||(this.state.companions=[]),this.state.companions.push(o)}spawnCompanion(t,s,o){t==="falcon"&&this.spawnFalcon(s,o)}setTile(t,s){const o=s.toUpperCase(),a=ce(t),l=Oa[o];if(!l){console.warn(`Attempted to set unknown tile type: ${o}`);return}this.state.tiles.set(a,{baseId:o,position:t,traits:new Set(l.defaultTraits||[]),effects:[],occupantId:void 0})}addUpgrade(t,s){this.state.player.activeSkills=(this.state.player.activeSkills||[]).map(o=>o.id===t?{...o,activeUpgrades:[...o.activeUpgrades,s]}:o)}useSkill(t,s){}wait(){}move(t){}getEnemy(t){return this.state.enemies.find(s=>s.id===t)}setTurn(t){this.state.turnNumber=t}exitToHub(){}applyStatus(t,s){const o=this.state.enemies.findIndex(a=>a.id===t);o!==-1&&(this.state.enemies[o]=Gd(this.state.enemies[o],s,1))}}const y0=({onLoadScenario:e})=>{const t=Object.values(sc),s=o=>{const a=new ok;o.setup(a),a.state.initiativeQueue=Rs(a.state),e(a.state,o.description)};return g.jsx("div",{className:"flex flex-col gap-4",children:t.map(o=>g.jsxs("div",{className:"flex flex-col gap-2",children:[g.jsx("h4",{className:"text-[10px] font-bold uppercase tracking-wider text-white/50",children:typeof o.name=="function"?o.name(Is(1,"temp")):o.name}),g.jsx("div",{className:"flex flex-col gap-1",children:o.scenarios?.map(a=>g.jsx("button",{onClick:()=>s(a),className:"text-left px-3 py-2 bg-white/5 hover:bg-white/10 rounded text-xs text-white/80 transition-colors border border-transparent hover:border-white/20",children:a.title},a.id))})]},o.id))})},rk=({gameState:e,onSelectLoadout:t,onStartRun:s,onOpenArcade:o,onLoadScenario:a,onStartReplay:l})=>g.jsxs("div",{className:"w-full h-full flex flex-col bg-[#020617]",children:[g.jsx("header",{className:"border-b border-white/5 px-4 sm:px-6 lg:px-12 py-3 sm:py-4 bg-[#030712]/50 backdrop-blur-xl z-30",children:g.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[g.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[g.jsx("div",{className:"w-9 h-9 sm:w-10 sm:h-10 bg-indigo-500 rounded-lg flex items-center justify-center font-black text-lg sm:text-xl shadow-[0_0_20px_rgba(99,102,241,0.5)]",children:"H"}),g.jsxs("div",{children:[g.jsxs("h1",{className:"text-base sm:text-lg font-black uppercase tracking-tighter leading-none italic",children:["Hop ",g.jsx("span",{className:"text-indigo-500",children:"Engine"})]}),g.jsx("div",{className:"text-[9px] sm:text-[10px] font-bold text-white/30 tracking-[0.22em] sm:tracking-[0.3em] uppercase mt-1",children:"Strategic Hub v5.0"})]})]}),g.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6 lg:gap-8",children:[g.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.03] px-3 py-2 sm:bg-transparent sm:border-0 sm:p-0",children:[g.jsx("div",{className:"text-[10px] uppercase tracking-widest text-white/40 mb-1",children:"Current Loadout"}),g.jsx("div",{className:"text-sm font-bold text-indigo-400 truncate",children:e.selectedLoadoutId||"No Archetype Selected"})]}),e.selectedLoadoutId&&g.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:flex sm:items-center sm:gap-3",children:[g.jsxs("button",{onClick:()=>s("normal"),className:"px-4 sm:px-6 py-2.5 sm:py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-black uppercase text-xs sm:text-sm tracking-widest transition-all hover:scale-[1.02] active:scale-95 shadow-[0_0_30px_rgba(79,70,229,0.3)] flex flex-col items-center justify-center leading-tight",children:[g.jsx("span",{children:"Start Run"}),g.jsx("span",{className:"hidden sm:block text-[9px] opacity-50 tracking-[0.2em]",children:"10 Floors | Boss Defeat"})]}),g.jsxs("button",{onClick:()=>s("daily"),className:"px-4 sm:px-6 py-2.5 sm:py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-black uppercase text-xs sm:text-sm tracking-widest transition-all hover:scale-[1.02] active:scale-95 shadow-[0_0_30px_rgba(16,185,129,0.3)] flex flex-col items-center justify-center leading-tight",children:[g.jsx("span",{children:"Daily"}),g.jsx("span",{className:"hidden sm:block text-[9px] opacity-50 tracking-[0.2em]",children:"Seeded Challenge"})]})]})]})]})}),g.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden",children:[g.jsx("main",{className:"flex-1 overflow-y-auto p-4 sm:p-6 lg:p-12 custom-scrollbar",children:g.jsxs("div",{className:"max-w-4xl mx-auto",children:[g.jsxs("div",{className:"mb-6 sm:mb-10 lg:mb-12",children:[g.jsx("button",{onClick:o,className:"mb-4 sm:mb-5 w-full sm:w-auto px-5 sm:px-6 py-2.5 sm:py-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-200 font-black uppercase tracking-widest text-xs sm:text-sm transition-all",children:"Arcade Mode"}),g.jsxs("h2",{className:"text-xl sm:text-2xl lg:text-3xl font-black uppercase tracking-tighter mb-2 italic",children:["Select Your ",g.jsx("span",{className:"text-indigo-500",children:"Archetype"})]}),g.jsx("p",{className:"text-sm sm:text-base text-white/40 max-w-xl",children:"Choose your tactical specialty. Each archetype provides unique skills and modifies your core interaction with the engine."})]}),g.jsx(ik,{onSelect:t})]})}),g.jsxs("section",{className:"lg:hidden border-t border-white/5 bg-[#030712]/50 backdrop-blur-sm p-4 sm:p-6 space-y-4",children:[g.jsxs("details",{className:"rounded-2xl border border-white/10 bg-white/[0.02] p-3",children:[g.jsxs("summary",{className:"cursor-pointer list-none flex items-center justify-between",children:[g.jsx("span",{className:"text-[11px] font-black uppercase tracking-[0.2em] text-white/60",children:"Historical Replay"}),g.jsx("span",{className:"text-[10px] text-white/30 uppercase tracking-widest",children:"Optional"})]}),g.jsx("div",{className:"mt-3",children:g.jsx(h0,{gameState:e,onStartReplay:l})})]}),g.jsxs("details",{className:"rounded-2xl border border-white/10 bg-white/[0.02] p-3",children:[g.jsxs("summary",{className:"cursor-pointer list-none flex items-center justify-between",children:[g.jsx("span",{className:"text-[11px] font-black uppercase tracking-[0.2em] text-white/60",children:"Training Simulations"}),g.jsx("span",{className:"text-[10px] text-white/30 uppercase tracking-widest",children:"Optional"})]}),g.jsx("div",{className:"mt-3",children:g.jsx(y0,{onLoadScenario:a})})]})]}),g.jsx("aside",{className:"hidden lg:flex w-[450px] border-l border-white/5 bg-[#030712]/80 backdrop-blur-md flex-col z-20",children:g.jsxs("div",{className:"p-8 flex flex-col gap-12 h-full overflow-y-auto custom-scrollbar",children:[g.jsxs("section",{children:[g.jsxs("div",{className:"flex items-center justify-between mb-6",children:[g.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/30",children:"Historical Replay"}),g.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500 animate-pulse"})]}),g.jsx("div",{className:"bg-white/[0.02] border border-white/5 rounded-2xl p-4 overflow-hidden",children:g.jsx(h0,{gameState:e,onStartReplay:l})})]}),g.jsxs("section",{children:[g.jsxs("div",{className:"flex items-center justify-between mb-6",children:[g.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/30",children:"Training Simulations"}),g.jsx("div",{className:"w-2 h-2 rounded-full bg-indigo-500 animate-pulse"})]}),g.jsx("div",{className:"bg-white/[0.02] border border-white/5 rounded-2xl p-4 overflow-hidden",children:g.jsx(y0,{onLoadScenario:a})})]}),g.jsx("div",{className:"mt-auto pt-8 border-t border-white/5 opacity-20 hover:opacity-100 transition-opacity",children:g.jsx("div",{className:"text-[10px] font-bold uppercase tracking-[0.4em] mb-2 text-center text-white/50",children:"Engine Status: Online"})})]})})]})]}),lk={VANGUARD:"V",HUNTER:"H",FIREMAGE:"F",NECROMANCER:"N",SKIRMISHER:"S"},g0=e=>{let t=2166136261;for(let s=0;s<e.length;s++)t^=e.charCodeAt(s),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return t>>>0},ck=(e=new Date)=>e.toISOString().slice(0,10),uk=(e,t)=>{if(e.length<2)throw new Error("Arcade mode requires at least two loadouts.");const o=g0(`arcade-a:${t}`)%e.length,a=e[o],l=e.filter(m=>m.id!==a.id),f=g0(`arcade-b:${t}`)%l.length,p=l[f];return[a,p]},dk=({onBack:e,onLaunchArcade:t})=>{const s=Ln.useMemo(()=>Object.values(Yn),[]),o=Ln.useMemo(()=>ck(),[]),[a,l]=Ln.useMemo(()=>uk(s,o),[s,o]);return g.jsxs("div",{className:"w-full h-full flex flex-col bg-[#040a18]",children:[g.jsxs("header",{className:"h-20 border-b border-white/10 flex items-center justify-between px-12 bg-[#050b1f]/80 backdrop-blur-xl z-30",children:[g.jsxs("div",{children:[g.jsxs("h1",{className:"text-xl font-black uppercase tracking-tight italic",children:["Hop ",g.jsx("span",{className:"text-emerald-400",children:"Arcade"})]}),g.jsxs("div",{className:"text-[10px] uppercase tracking-[0.3em] text-white/40 mt-1",children:["Daily Draft ",o]})]}),g.jsx("button",{onClick:e,className:"px-5 py-2.5 rounded-xl border border-white/20 bg-white/5 hover:bg-white/10 text-xs font-black uppercase tracking-widest",children:"Back to Strategic Hub"})]}),g.jsx("main",{className:"flex-1 overflow-y-auto p-12",children:g.jsxs("div",{className:"max-w-5xl mx-auto",children:[g.jsxs("div",{className:"mb-10",children:[g.jsx("h2",{className:"text-4xl font-black uppercase tracking-tight italic mb-3",children:"Arcade Mode"}),g.jsx("p",{className:"text-white/60 max-w-3xl",children:"Pick one of two daily archetypes and run the seeded challenge. Both options share the same seed for fair comparison."})]}),g.jsx("div",{className:"flex flex-col gap-6",children:[a,l].map((u,f)=>{const p=f===1,m=lk[u.id]||u.id.slice(0,1);return g.jsx("button",{onClick:()=>t(u.id),className:"w-full text-left group rounded-3xl border border-white/10 bg-gradient-to-r from-white/[0.06] to-white/[0.02] hover:from-emerald-500/20 hover:to-cyan-500/10 transition-all p-6",children:g.jsxs("div",{className:`flex items-center justify-between gap-6 ${p?"flex-row-reverse":""}`,children:[g.jsxs("div",{className:"flex items-center gap-4 min-w-[200px]",children:[g.jsx("div",{className:`w-20 h-20 rounded-2xl border border-white/15 bg-[#0b1733] flex items-center justify-center text-4xl font-black text-emerald-300 shadow-[0_0_35px_rgba(16,185,129,0.25)] ${p?"-scale-x-100":""}`,children:m}),g.jsxs("div",{children:[g.jsx("div",{className:"text-[10px] uppercase tracking-[0.25em] text-white/40",children:"Daily Archetype"}),g.jsx("div",{className:"text-2xl font-black uppercase tracking-tight",children:u.name})]})]}),g.jsxs("div",{className:"flex-1",children:[g.jsx("div",{className:"text-[10px] uppercase tracking-[0.2em] text-white/40 mb-2",children:"Starting Skills"}),g.jsx("div",{className:"flex flex-wrap gap-2",children:u.startingSkills.slice(0,6).map(y=>g.jsx("span",{className:"text-[10px] px-2 py-1 rounded-full border border-white/20 bg-white/5 font-bold tracking-wide",children:y},y))})]}),g.jsxs("div",{className:"text-right min-w-[150px]",children:[g.jsx("div",{className:"text-[10px] uppercase tracking-[0.25em] text-white/40",children:"Launch"}),g.jsx("div",{className:"text-sm font-black uppercase tracking-widest text-emerald-300 group-hover:text-emerald-200",children:"Start Arcade Run"})]})]})},u.id)})})]})})]})},fk=({replayError:e})=>e?g.jsx("div",{className:"absolute top-4 right-4 z-40 max-w-xl px-4 py-3 rounded-xl border border-red-400/40 bg-red-900/70 text-red-100 text-xs font-bold tracking-wide",children:e}):null,Ob=({tutorialInstructions:e,onDismiss:t})=>e?g.jsxs("div",{className:"absolute top-8 left-1/2 -translate-x-1/2 bg-blue-900/90 border border-blue-500/30 p-4 rounded-xl backdrop-blur-md shadow-xl z-30 max-w-lg text-center animate-in fade-in slide-in-from-top-4",children:[g.jsx("h4",{className:"text-blue-200 font-bold uppercase text-xs tracking-widest mb-1",children:"Simulation Objective"}),g.jsx("p",{className:"text-white text-sm",children:e}),g.jsx("button",{onClick:t,className:"absolute -top-2 -right-2 w-6 h-6 bg-blue-950 rounded-full border border-blue-500/50 flex items-center justify-center text-xs hover:bg-blue-800 transition-colors",children:"X"})]}):null,mk=({visible:e})=>e?g.jsx("div",{className:"absolute inset-0 z-40 pointer-events-auto",children:g.jsx("div",{className:"absolute top-3 sm:top-4 lg:top-6 left-1/2 -translate-x-1/2 h-10 w-10 rounded-full bg-black/55 border border-white/15 text-lg flex items-center justify-center text-white/80 animate-pulse","aria-label":"Resolving turn",title:"Resolving turn",children:"..."})}):null,pk=({mobileToasts:e})=>e.length===0?null:g.jsx("div",{className:"lg:hidden fixed left-1/2 -translate-x-1/2 top-16 z-50 pointer-events-none flex flex-col gap-2 w-[min(92vw,26rem)]",children:e.map(t=>{const s=t.tone==="damage"?"border-red-400/30 bg-red-950/75 text-red-100":t.tone==="heal"?"border-emerald-400/30 bg-emerald-950/70 text-emerald-100":t.tone==="status"?"border-cyan-300/30 bg-cyan-950/70 text-cyan-100":"border-white/15 bg-black/65 text-white/85";return g.jsx("div",{className:`rounded-xl border px-3 py-2 backdrop-blur-md shadow-[0_4px_20px_rgba(0,0,0,0.35)] text-xs font-bold tracking-wide ${s}`,children:t.text},t.id)})}),hk=({visible:e,onReset:t})=>e?g.jsxs("div",{className:"fixed inset-0 bg-red-950/90 backdrop-blur-xl flex flex-col items-center justify-center z-[200] transition-opacity duration-500",children:[g.jsx("div",{className:"text-8xl mb-8 animate-bounce",children:"X"}),g.jsx("h2",{className:"text-6xl font-black text-white mb-2 tracking-tighter italic uppercase",children:"Identity Deleted"}),g.jsx("p",{className:"text-red-200/60 mb-12 text-xl font-medium tracking-widest uppercase",children:"Simulation Terminated"}),g.jsx("button",{onClick:t,className:"px-12 py-4 bg-white text-black rounded-2xl font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-[0_0_50px_rgba(255,255,255,0.3)]",children:"Reinitialize Simulation"})]}):null,yk=({visible:e,score:t,onExitToHub:s})=>e?g.jsxs("div",{className:"fixed inset-0 bg-indigo-950/90 backdrop-blur-xl flex flex-col items-center justify-center z-[200] transition-opacity duration-500",children:[g.jsx("div",{className:"text-8xl mb-8 animate-bounce",children:"OK"}),g.jsx("h2",{className:"text-6xl font-black text-white mb-2 tracking-tighter italic uppercase",children:"Arcade Mode Cleared"}),g.jsx("p",{className:"text-indigo-200/60 mb-2 text-xl font-medium tracking-widest uppercase",children:"The Sentinel has fallen"}),g.jsxs("p",{className:"text-white/20 mb-12 text-sm font-bold uppercase tracking-[0.3em]",children:["Score: ",t]}),g.jsx("button",{onClick:s,className:"px-12 py-4 bg-white text-black rounded-2xl font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-[0_0_50px_rgba(255,255,255,0.3)]",children:"Return to Command Center"})]}):null,gk=({floorIntro:e})=>e?g.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[150] pointer-events-none animate-in fade-in duration-700",children:g.jsxs("div",{className:"text-center",children:[g.jsxs("div",{className:"text-indigo-500 font-black text-2xl uppercase tracking-[0.5em] mb-4 animate-in slide-in-from-bottom-8 duration-1000",children:["Floor ",e.floor]}),g.jsx("h2",{className:"text-8xl font-black text-white uppercase tracking-tighter italic animate-in slide-in-from-top-12 duration-1000",children:e.theme}),g.jsx("div",{className:"h-1 w-64 bg-white/20 mx-auto mt-8 rounded-full overflow-hidden",children:g.jsx("div",{className:"h-full bg-indigo-500 animate-[progress_3s_linear]"})})]})}):null,bk=({isReplayMode:e,replayIndex:t,replayLength:s,replayActive:o,onToggleReplay:a,onStepReplay:l,onCloseReplay:u})=>e?g.jsxs("div",{className:"fixed bottom-12 left-1/2 -translate-x-1/2 bg-[#030712]/90 border border-indigo-500/30 p-6 rounded-3xl backdrop-blur-2xl shadow-[0_0_50px_rgba(79,70,229,0.2)] z-[250] flex items-center gap-8 animate-in slide-in-from-bottom-8 duration-500",children:[g.jsxs("div",{className:"flex flex-col",children:[g.jsx("span",{className:"text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400 mb-1",children:"Replay System"}),g.jsxs("span",{className:"text-white font-bold text-sm",children:["Step ",t," / ",s]})]}),g.jsx("div",{className:"h-8 w-px bg-white/10"}),g.jsxs("div",{className:"flex items-center gap-4",children:[g.jsx("button",{onClick:a,className:`w-12 h-12 rounded-xl flex items-center justify-center transition-all ${o?"bg-indigo-500 text-white shadow-[0_0_20px_rgba(79,70,229,0.5)]":"bg-white/5 text-white/50 hover:bg-white/10"}`,children:o?"PAUSE":"PLAY"}),g.jsx("button",{onClick:l,disabled:o,className:"w-12 h-12 bg-white/5 hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-white/5 text-white rounded-xl flex items-center justify-center transition-all",children:"NEXT"})]}),g.jsx("div",{className:"h-8 w-px bg-white/10"}),g.jsx("button",{onClick:u,className:"px-6 py-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-xl font-bold uppercase text-xs tracking-widest transition-all",children:"Close"})]}):null,Sk=({gameState:e,isArcadeRoute:t,hubPath:s,arcadePath:o,biomesPath:a,replayError:l,tutorialInstructions:u,navigateTo:f,onStartArcadeRun:p,onSelectLoadout:m,onStartRun:y,onLoadScenario:b,onStartReplay:v,onDismissTutorial:T})=>g.jsxs("div",{className:"w-screen h-screen bg-[#030712] overflow-hidden text-white font-['Inter',_sans-serif]",children:[!t&&g.jsx("button",{type:"button",onClick:()=>f(a),className:"absolute top-4 right-4 z-40 px-4 py-2 rounded-xl border border-cyan-300/35 bg-cyan-500/10 hover:bg-cyan-500/20 text-[10px] font-black uppercase tracking-[0.2em]",children:"Biome Sandbox"}),t?g.jsx(dk,{onBack:()=>f(s),onLaunchArcade:p}):g.jsx(rk,{gameState:e,onSelectLoadout:m,onStartRun:y,onOpenArcade:()=>f(o),onLoadScenario:b,onStartReplay:v}),g.jsx(fk,{replayError:l}),g.jsx(Ob,{tutorialInstructions:u,onDismiss:T})]}),vk=({gameState:e})=>{const{initiativeQueue:t,player:s,enemies:o}=e;if(!t||!t.entries||t.entries.length===0)return null;const a=t.entries.map(l=>l.actorId===s.id?s:o.find(u=>u.id===l.actorId)).filter(l=>!!l);return g.jsxs("div",{className:"flex flex-col gap-2 p-4 bg-white/5 border border-white/10 rounded-2xl backdrop-blur-md",children:[g.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-1",children:"Turn Sequence"}),g.jsx("div",{className:"flex items-center gap-3 overflow-x-auto pb-2 scrollbar-none",children:a.map((l,u)=>{const f=l.id===s.id,p=u===t.currentIndex,y=t.entries.find(b=>b.actorId===l.id)?.hasActed;return g.jsxs("div",{className:`flex flex-col items-center shrink-0 transition-all duration-300 ${p?"scale-110":"opacity-60 scale-90"}`,children:[g.jsxs("div",{className:`
                                w-10 h-10 rounded-xl flex items-center justify-center border-2 transition-all relative
                                ${f?"bg-blue-500/20 border-blue-500/50":"bg-red-500/20 border-red-500/50"}
                                ${p?"shadow-[0_0_15px_rgba(255,255,255,0.2)] border-white/80":""}
                                ${y?"grayscale":""}
                            `,children:[g.jsx("span",{className:"text-xl",children:Xo(l.subtype,l.type,l.enemyType,l.archetype).icon}),p&&g.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-white rounded-full animate-ping"}),y&&!p&&g.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center border-2 border-[#030712] text-[8px]",children:""})]}),g.jsx("div",{className:"w-8 h-1 bg-white/10 rounded-full mt-2 overflow-hidden",children:g.jsx("div",{className:`h-full ${f?"bg-blue-400":"bg-red-400"}`,style:{width:`${l.hp/l.maxHp*100}%`}})}),g.jsx("span",{className:`text-[8px] font-bold uppercase mt-1 ${f?"text-blue-300":"text-red-300"} ${p?"text-white":""}`,children:f?"You":l.subtype||"Enemy"})]},`${l.id}-${u}`)})})]})},Ak=({compact:e})=>g.jsxs("div",{className:"flex justify-between items-start",children:[g.jsxs("div",{children:[g.jsx("h1",{className:`${e?"text-base":"text-xl"} font-black uppercase tracking-widest text-white/90 mb-1`,children:"Hoplite"}),g.jsx("p",{className:"text-[10px] font-bold text-white/30 uppercase tracking-[0.2em]",children:"Tactical Arena"})]}),g.jsx("div",{className:`px-2 py-1 bg-white/10 rounded border border-white/20 text-[10px] font-black text-white/60 ${e?"hidden sm:block":""}`,children:"V2.1.0"})]}),xk=({hideInitiativeQueue:e,gameState:t})=>e?null:g.jsx(vk,{gameState:t}),Tk=({gameState:e,compact:t})=>g.jsxs("div",{className:t?"space-y-4":"space-y-6",children:[g.jsxs("div",{className:"flex flex-col",children:[g.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-2",children:"Vitality"}),g.jsxs("div",{className:"flex items-end gap-2",children:[g.jsx("span",{className:`${t?"text-3xl":"text-4xl"} font-black text-red-500 leading-none`,children:e.player.hp}),g.jsx("span",{className:"text-xl text-white/20 font-bold leading-none mb-1",children:"/"}),g.jsx("span",{className:"text-xl text-gray-500 font-bold leading-none mb-1",children:e.player.maxHp})]})]}),g.jsxs("div",{className:"flex flex-col",children:[g.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-2",children:"Guardian Plating"}),g.jsxs("div",{className:"flex items-center gap-3",children:[g.jsx("div",{className:`w-3 h-3 rounded-sm ${e.player.temporaryArmor?"bg-blue-400 rotate-45":"bg-white/5 border border-white/10"}`}),g.jsx("span",{className:"text-2xl font-black text-blue-400 leading-none",children:e.player.temporaryArmor||0})]})]}),e.enemies.filter(s=>s.subtype==="sentinel").map(s=>g.jsxs("div",{className:"pt-4 animate-in slide-in-from-right-8 duration-500",children:[g.jsxs("div",{className:"flex justify-between items-end mb-2",children:[g.jsx("span",{className:"text-xs font-black text-red-500 uppercase tracking-tighter italic",children:"Sentinel Directive"}),g.jsxs("span",{className:"text-lg font-black",children:[s.hp," ",g.jsxs("span",{className:"text-white/20 text-xs",children:["/ ",s.maxHp]})]})]}),g.jsx("div",{className:"h-4 w-full bg-red-950/30 rounded-md border border-red-500/20 overflow-hidden",children:g.jsx("div",{className:"h-full bg-gradient-to-r from-red-600 to-red-400 shadow-[0_0_20px_rgba(239,68,68,0.4)] transition-all duration-300",style:{width:`${s.hp/s.maxHp*100}%`}})})]},s.id))]}),Ek=({compact:e,gameState:t,score:s})=>g.jsxs("div",{className:`${e?"py-4 space-y-4":"py-8 space-y-6"} border-y border-white/5`,children:[g.jsxs("div",{className:"flex flex-col gap-3",children:[g.jsxs("div",{className:"flex justify-between items-center",children:[g.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold",children:"Arcade Progress"}),g.jsxs("span",{className:"text-xl font-black",children:[t.floor," ",g.jsx("span",{className:"text-white/20 text-sm",children:"/ 10"})]})]}),g.jsx("div",{className:"h-1.5 w-full bg-white/5 rounded-full overflow-hidden border border-white/5",children:g.jsx("div",{className:"h-full bg-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.4)] transition-all duration-1000 ease-out",style:{width:`${t.floor/10*100}%`}})})]}),g.jsxs("div",{className:"flex justify-between items-center",children:[g.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold",children:"Current Score"}),g.jsx("span",{className:"text-xl font-black text-white",children:s.toLocaleString()})]})]}),_k=({compact:e,inputLocked:t,onWait:s,onReset:o,onExitToHub:a})=>g.jsxs("div",{className:`flex flex-col ${e?"gap-2":"gap-3"}`,children:[g.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-1",children:"Directives"}),g.jsxs("button",{disabled:t,onClick:s,className:`w-full flex justify-between items-center ${e?"px-3 py-2.5":"px-4 py-3"} border rounded-xl transition-all group ${t?"bg-white/[0.03] border-white/5 text-white/30 cursor-not-allowed opacity-50":"bg-white/5 hover:bg-white/10 border-white/10"}`,children:[g.jsx("span",{className:"text-sm font-bold text-white/70",children:"Secure & Wait"}),g.jsx("span",{className:"text-lg grayscale group-hover:grayscale-0 transition-all",children:"S"})]}),g.jsxs("button",{onClick:o,className:`w-full flex justify-between items-center ${e?"px-3 py-2.5":"px-4 py-3"} bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 rounded-xl transition-all group`,children:[g.jsx("span",{className:"text-sm font-bold text-red-400/80",children:"Reset Chronology"}),g.jsx("span",{className:"text-lg grayscale group-hover:grayscale-0 transition-all",children:"R"})]}),g.jsxs("button",{onClick:a,className:`w-full flex justify-between items-center ${e?"px-3 py-2.5":"px-4 py-3"} bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl transition-all group`,children:[g.jsx("span",{className:"text-sm font-bold text-white/70",children:"Return to Hub"}),g.jsx("span",{className:"text-lg grayscale group-hover:grayscale-0 transition-all",children:"H"})]})]}),Mk=({gameState:e,onReset:t,onWait:s,onExitToHub:o,inputLocked:a=!1,compact:l=!1,hideInitiativeQueue:u=!1})=>{const f=N0(e);return g.jsxs("div",{className:`flex flex-col overflow-y-auto flex-1 min-h-0 ${l?"gap-4 p-4":"gap-8 p-8"}`,children:[g.jsx(Ak,{compact:l}),g.jsx(xk,{gameState:e,hideInitiativeQueue:u}),g.jsx(Tk,{gameState:e,compact:l}),g.jsx(Ek,{gameState:e,compact:l,score:f}),g.jsx(_k,{compact:l,inputLocked:a,onWait:s,onReset:t,onExitToHub:o})]})},wk=(e,t)=>{const s=e||"",o=s.toLowerCase(),a=s.match(/^\[(INFO|VERBOSE|DEBUG|CRITICAL)\|([A-Z_]+)\]\s*(.*)$/i);if(a){const f=a[1].toLowerCase(),p=a[2].toLowerCase(),m=a[3]||"",y=p.includes("combat")?"combat":p.includes("hazard")?"hazard":p.includes("objective")||p.includes("score")?"objective":p.includes("ai")?"ai":"system";return{idx:t,raw:e,text:m,level:f,channel:y}}const l=/(attacked|killed|blast|stunned|damage|hit|healed|shield|bash|spear|fireball|jump|dash)/i.test(o)?"combat":/(lava|burn|hazard|void|sink|fire damage)/i.test(o)?"hazard":/(score|objective|floor|stairs|descending|arcade cleared)/i.test(o)?"objective":/(enemy|falcon|intent|telegraph|moves to|repositioning|attacks)/i.test(o)?"ai":"system",u=/(fallen|warning|error|failed|invalid|blocked|cannot)/i.test(o)?"critical":/(debug|trace|telemetry|seed|counter|rng)/i.test(o)?"debug":/(marks the impact zone|telegraph|planning|intent)/i.test(o)?"verbose":"info";return{idx:t,raw:e,text:s,level:u,channel:l}},Ck=({compact:e=!1,levelFilter:t,channelFilter:s,onLevelFilterChange:o,onChannelFilterChange:a})=>g.jsxs("div",{className:`items-center gap-2 ${e?"hidden sm:flex":"flex"}`,children:[g.jsxs("select",{value:s,onChange:l=>a(l.target.value),className:"text-[10px] bg-white/5 border border-white/10 rounded px-2 py-1 text-white/80",children:[g.jsx("option",{value:"all",children:"All Channels"}),g.jsx("option",{value:"combat",children:"Combat"}),g.jsx("option",{value:"hazard",children:"Hazard"}),g.jsx("option",{value:"objective",children:"Objective"}),g.jsx("option",{value:"ai",children:"AI"}),g.jsx("option",{value:"system",children:"System"})]}),g.jsxs("select",{value:t,onChange:l=>o(l.target.value),className:"text-[10px] bg-white/5 border border-white/10 rounded px-2 py-1 text-white/80",children:[g.jsx("option",{value:"all",children:"All Levels"}),g.jsx("option",{value:"info",children:"Info"}),g.jsx("option",{value:"verbose",children:"Verbose"}),g.jsx("option",{value:"debug",children:"Debug"}),g.jsx("option",{value:"critical",children:"Critical"})]})]}),Ok=e=>e==="critical"?"text-red-300 border-red-400/40 bg-red-500/10":e==="debug"?"text-cyan-300 border-cyan-400/40 bg-cyan-500/10":e==="verbose"?"text-amber-300 border-amber-400/40 bg-amber-500/10":"text-white/60 border-white/20 bg-white/5",kk=({entries:e,listRef:t})=>g.jsxs("div",{ref:t,className:"flex flex-col gap-2 bg-white/[0.02] border border-white/5 p-4 rounded-2xl overflow-y-auto max-h-[140px]",children:[e.slice(-20).map(s=>g.jsxs("div",{className:"flex gap-2 items-start",children:[g.jsxs("span",{className:"text-[10px] text-white/20 font-bold mt-1 leading-none shrink-0",children:["[",s.idx,"]"]}),g.jsx("span",{className:`text-[9px] mt-1 px-1.5 py-0.5 rounded border shrink-0 ${Ok(s.level)}`,children:s.level.toUpperCase()}),g.jsx("span",{className:"text-[9px] mt-1 px-1.5 py-0.5 rounded border border-white/20 bg-white/5 text-white/60 shrink-0",children:s.channel.toUpperCase()}),g.jsx("p",{className:"text-[11px] leading-tight text-white/70 font-medium whitespace-pre-wrap",children:s.text})]},s.idx)),e.length===0&&g.jsx("div",{className:"text-[11px] text-white/40 italic",children:"No messages match current filters."})]}),Nk=({messages:e,compact:t=!1})=>{const s=Ln.useRef(null),[o,a]=Ln.useState("all"),[l,u]=Ln.useState("all"),f=Ln.useMemo(()=>e.map((m,y)=>wk(m,y)),[e]),p=Ln.useMemo(()=>f.filter(m=>(o==="all"||m.level===o)&&(l==="all"||m.channel===l)),[f,o,l]);return Ln.useEffect(()=>{s.current&&(s.current.scrollTop=s.current.scrollHeight)},[p]),e.length===0?null:g.jsxs("div",{className:`${t?"p-4":"p-8"} border-t border-white/5 bg-[#030712]/80 backdrop-blur-sm`,children:[g.jsxs("div",{className:"flex items-center justify-between mb-3",children:[g.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold block",children:"Tactical Log"}),g.jsx(Ck,{compact:t,levelFilter:o,channelFilter:l,onLevelFilterChange:a,onChannelFilterChange:u})]}),g.jsx(kk,{entries:p,listRef:s})]})},Rk=({gameState:e,onReset:t,onWait:s,onExitToHub:o,inputLocked:a=!1,compact:l=!1,hideInitiativeQueue:u=!1,hideLog:f=!1})=>{const p=Array.isArray(e.message)?e.message:[];return g.jsxs("div",{className:"flex flex-col h-full max-h-screen",children:[g.jsx(Mk,{gameState:e,onReset:t,onWait:s,onExitToHub:o,inputLocked:a,compact:l,hideInitiativeQueue:u}),!f&&g.jsx(Nk,{messages:p,compact:l})]})},Ik=({onSelect:e,gameState:t})=>{const s=t.player,a=(t.pendingStatus?.shrineOptions||t.shrineOptions||["EXTRA_HP"]).map(l=>{if(l==="EXTRA_HP")return{id:"EXTRA_HP",label:"Extra Heart",desc:"Increases your Max HP by 1 and heals you to full.",color:"bg-red-900/40 border-red-500"};const u=st.getUpgrade(l),f=st.getSkillForUpgrade(l),p=s.activeSkills?.find(y=>y.id===f),m=p?.slot==="offensive"?"bg-orange-900/40 border-orange-500":p?.slot==="defensive"?"bg-blue-900/40 border-blue-500":"bg-green-900/40 border-green-500";return{id:l,label:u?u.name:l,desc:u?.description||"Unknown upgrade.",color:m}});return g.jsx("div",{className:"fixed inset-0 bg-slate-950/90 backdrop-blur-md flex items-center justify-center z-[100] p-4",children:g.jsxs("div",{className:"bg-gray-900 p-8 rounded-3xl border-2 border-slate-700 max-w-2xl w-full shadow-2xl relative overflow-hidden",children:[g.jsx("div",{className:"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 via-blue-500 to-green-500"}),g.jsx("h2",{className:"text-4xl font-black text-white mb-2 text-center tracking-tight",children:"SHRINE BLESSING"}),g.jsx("p",{className:"text-slate-400 mb-8 text-center text-lg",children:"The gods offer you a choice. Choose wisely."}),g.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:a.map(l=>g.jsxs("button",{onClick:()=>e(l.id),className:`
                                relative p-6 border-2 rounded-2xl text-left transition-all group overflow-hidden
                                hover:scale-[1.02] active:scale-[0.98]
                                ${l.color} hover:bg-slate-800
                            `,children:[g.jsx("h3",{className:"text-xl font-bold text-white mb-2 group-hover:text-blue-200",children:l.label}),g.jsx("p",{className:"text-sm text-slate-400 group-hover:text-slate-300 leading-relaxed",children:l.desc}),g.jsx("div",{className:"absolute -right-2 -bottom-2 opacity-0 group-hover:opacity-10 scale-0 group-hover:scale-150 transition-all font-bold text-4xl",children:"*"})]},l.id))})]})})},b0=({skills:e,selectedSkillId:t,onSelectSkill:s,hasSpear:o,gameState:a,inputLocked:l=!1,compact:u=!1})=>{const f=["offensive","defensive","utility"];return g.jsx("div",{className:u?"grid grid-cols-3 gap-2 sm:grid-cols-4":"flex flex-col gap-4",children:f.flatMap(p=>e.filter(y=>y.slot===p).map(y=>{const b=t===y.id,v=y.currentCooldown>0,T=y.id==="SPEAR_THROW",S=l||v&&!T||T&&!o,x=d_(y.id),_=x?.name||y.name,E=typeof _=="function"?_(a):_,w=x?.icon||"";return g.jsxs("button",{disabled:S,onClick:()=>s(b?null:y.id),className:`
                            relative w-full ${u?"h-20 rounded-xl gap-0.5":"h-24 rounded-2xl gap-1"} flex flex-col items-center justify-center
                            border transition-all transform hover:translate-x-1
                            ${b?"bg-blue-600 border-white shadow-[0_0_20px_rgba(59,130,246,0.5)]":"bg-white/5 border-white/10 hover:border-blue-500/50"}
                            ${S?"opacity-40 grayscale pointer-events-none":"cursor-pointer"}
                        `,children:[g.jsx("span",{className:u?"text-2xl":"text-3xl",children:w}),g.jsx("span",{className:`${u?"text-[9px] tracking-[0.12em]":"text-[10px] tracking-widest"} uppercase font-bold text-white/50 text-center px-2 leading-tight`,children:E}),v&&!T&&g.jsx("div",{className:`absolute inset-0 flex items-center justify-center bg-black/40 ${u?"rounded-xl":"rounded-2xl"} backdrop-blur-[2px]`,children:g.jsx("span",{className:`${u?"text-2xl":"text-3xl"} font-black text-white`,children:y.currentCooldown})}),g.jsx("div",{className:`absolute ${u?"-top-1 left-2 px-1.5":"-top-2 left-4 px-2"} py-0.5 bg-[#030712] rounded-full border border-white/10 text-[8px] uppercase font-black tracking-widest text-white/40`,children:p})]},y.id)}))})},Lk=({gameState:e,selectedSkillId:t,showMovementRange:s,isInputLocked:o,isReplayMode:a,replayActionsLength:l,replayIndex:u,replayActive:f,mobileToasts:p,tutorialInstructions:m,floorIntro:y,assetManifest:b,onSetBoardBusy:v,onTileClick:T,onSimulationEvents:S,onMirrorSnapshot:x,onReset:_,onWait:E,onExitToHub:w,onSelectSkill:M,onSelectUpgrade:k,onDismissTutorial:R,onToggleReplay:O,onStepReplay:I,onCloseReplay:D})=>g.jsxs("div",{className:"flex flex-col lg:flex-row w-screen h-screen bg-[#030712] overflow-hidden text-white font-['Inter',_sans-serif]",children:[g.jsx("div",{className:"lg:hidden shrink-0 border-b border-white/5 bg-[#030712]/95 backdrop-blur-sm z-20",children:g.jsxs("div",{className:"px-4 py-3 flex items-center justify-between gap-4",children:[g.jsxs("div",{className:"min-w-0",children:[g.jsx("div",{className:"text-[10px] uppercase tracking-[0.2em] text-white/35 font-bold",children:"Level"}),g.jsxs("div",{className:"text-lg font-black text-white leading-none",children:[e.floor,g.jsx("span",{className:"text-white/25 text-sm ml-1",children:"/ 10"})]})]}),g.jsxs("div",{className:"ml-auto min-w-0 text-right",children:[g.jsx("div",{className:"text-[10px] uppercase tracking-[0.2em] text-white/35 font-bold",children:"HP"}),g.jsxs("div",{className:"text-lg font-black text-red-400 leading-none",children:[e.player.hp,g.jsxs("span",{className:"text-white/25 text-sm ml-1",children:["/ ",e.player.maxHp]})]})]})]})}),g.jsx("aside",{className:"hidden lg:flex w-80 border-r border-white/5 bg-[#030712] flex-col z-20 overflow-y-auto",children:g.jsx(Rk,{gameState:e,onReset:_,onWait:E,onExitToHub:w,inputLocked:o})}),g.jsx("main",{className:"flex-1 min-h-0 relative flex items-center justify-center bg-[#020617] overflow-hidden",children:g.jsx("div",{className:"w-full h-full p-0 sm:p-3 lg:p-8 flex items-center justify-center",children:g.jsxs("div",{className:`w-full h-full relative border border-white/5 bg-[#030712]/50 rounded-none sm:rounded-3xl lg:rounded-[40px] shadow-[inset_0_0_100px_rgba(0,0,0,0.5)] flex items-center justify-center overflow-hidden ${e.isShaking?"animate-shake":""}`,children:[g.jsx(Mb,{gameState:e,onMove:T,selectedSkillId:t,showMovementRange:s,onBusyStateChange:v,assetManifest:b,onSimulationEvents:S,onMirrorSnapshot:x}),g.jsx(mk,{visible:o&&e.gameStatus==="playing"})]})})}),g.jsx(pk,{mobileToasts:e.gameStatus==="playing"?p:[]}),g.jsx("aside",{className:"lg:hidden shrink-0 h-[26svh] min-h-[160px] max-h-[250px] border-t border-white/5 bg-[#030712] z-20 overflow-y-auto",children:g.jsxs("div",{className:"p-3 flex flex-col gap-3 h-full",children:[g.jsxs("div",{className:"flex items-center justify-between gap-2",children:[g.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-white/30",children:"Skills"}),g.jsxs("div",{className:"flex items-center gap-1.5",children:[g.jsx("button",{disabled:o,onClick:E,className:`px-2.5 py-1.5 rounded-lg border text-[10px] font-black uppercase tracking-widest ${o?"bg-white/[0.03] border-white/5 text-white/30 opacity-50":"bg-white/5 border-white/10 text-white/70 active:bg-white/10"}`,children:"Wait"}),g.jsx("button",{onClick:w,className:"px-2.5 py-1.5 rounded-lg border border-white/10 bg-white/5 text-[10px] font-black uppercase tracking-widest text-white/70 active:bg-white/10",children:"Hub"}),g.jsx("button",{onClick:_,className:"px-2.5 py-1.5 rounded-lg border border-red-500/20 bg-red-500/10 text-[10px] font-black uppercase tracking-widest text-red-300/90 active:bg-red-500/20",children:"Reset"})]})]}),g.jsx(b0,{skills:e.player.activeSkills||[],selectedSkillId:t,onSelectSkill:M,hasSpear:e.hasSpear,gameState:e,inputLocked:o,compact:!0})]})}),g.jsx("aside",{className:"hidden lg:flex w-80 border-l border-white/5 bg-[#030712] flex-col z-20 overflow-y-auto",children:g.jsxs("div",{className:"p-6 flex flex-col gap-8 h-full",children:[g.jsxs("div",{className:"flex-1",children:[g.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/30 mb-6",children:"Tactical Skills"}),g.jsx(b0,{skills:e.player.activeSkills||[],selectedSkillId:t,onSelectSkill:M,hasSpear:e.hasSpear,gameState:e,inputLocked:o})]}),g.jsx("div",{className:"pt-8 border-t border-white/5 text-center",children:g.jsx("div",{className:"text-[10px] font-bold uppercase tracking-widest text-white/20",children:"Hop Engine v5.0"})})]})}),g.jsx(Ob,{tutorialInstructions:m,onDismiss:R}),e.gameStatus==="choosing_upgrade"&&g.jsx(Ik,{onSelect:k,gameState:e}),g.jsx(hk,{visible:e.gameStatus==="lost",onReset:_}),g.jsx(yk,{visible:e.gameStatus==="won",score:e.completedRun?.score||0,onExitToHub:w}),g.jsx(gk,{floorIntro:y}),g.jsx(bk,{isReplayMode:a,replayIndex:u,replayLength:l,replayActive:f,onToggleReplay:O,onStepReplay:I,onCloseReplay:D})]}),Bk=e=>{const t=e.payload;if(!(!t||typeof t!="object")){if("q"in t&&"r"in t)return{q:Number(t.q??0),r:Number(t.r??0),s:Number(t.s??0)};if(e.type==="USE_SKILL"){const s=t;return{skillId:s.skillId??"unknown",target:s.target?{q:s.target.q,r:s.target.r,s:s.target.s}:null}}if(e.type==="START_RUN")return{loadoutId:t.loadoutId??"unknown",mode:t.mode??"normal"};if(e.type==="LOAD_STATE"){const s=t;return{floor:s?.floor??0,gameStatus:s?.gameStatus??"unknown",turnNumber:s?.turnNumber??0,queueLength:Array.isArray(s?.initiativeQueue)?s.initiativeQueue.length:0}}return{}}};function Pk(){const{hubPath:e,arcadePath:t,biomesPath:s,isArcadeRoute:o,isBiomesRoute:a,navigateTo:l}=nk(),[u,f]=YO(),p=typeof window<"u"&&!!window.__HOP_DEBUG_QUERY,m=DO();$O(u,p);const y=N.useRef(()=>{}),b=N.useCallback((ke,et)=>{y.current(ke,et)},[]),{isReplayMode:v,replayActions:T,replayActive:S,replayError:x,replayIndexRef:_,setReplayActive:E,resetReplayUi:w,startReplay:M,stepReplay:k}=KO({dispatchWithTrace:b});UO([u.gameStatus,v]);const[R,O]=N.useState(null),[I,D]=N.useState(!1),[j,U]=N.useState(!1),[q,se]=N.useState(!1),{turnDriver:ee,isInputLocked:oe,appendTurnTrace:F,dispatchWithTrace:P}=tk({gameState:u,dispatch:f,isReplayMode:v,isBusy:j,postCommitInputLock:q,dispatchWithTraceProxyRef:y,summarizeActionPayload:Bk}),{mobileToasts:z,handleSimulationEvents:Z,handleUiMirrorSnapshot:re}=GO({gameState:u,appendTurnTrace:F}),{armPostCommitLock:pe}=ZO({gameState:u,turnDriver:ee,isBusy:j,isReplayMode:v,postCommitInputLock:q,setPostCommitInputLock:se,appendTurnTrace:F,dispatchWithTrace:P}),[B,W]=N.useState(null),X=qO(u);WO(u,v);const ae=ke=>{oe||O(ke)},le=ke=>{if(!oe){if(R){pe(),P({type:"USE_SKILL",payload:{skillId:R,target:ke}},"player_use_skill"),O(null);return}if(J(ke,u.player.position)){D(!I);return}pe(),P({type:"MOVE",payload:ke},"player_move"),D(!1)}},ue=ke=>{v||j||P({type:"SELECT_UPGRADE",payload:ke},"upgrade_select")},be=()=>{P({type:"RESET"},"reset"),O(null),w()},$e=()=>{oe||(pe(),P({type:"WAIT"},"player_wait"),O(null))},Ee=()=>{ot()},at=(ke,et)=>{P({type:"LOAD_STATE",payload:ke},"scenario_load"),W(et),O(null)},ot=()=>{P({type:"EXIT_TO_HUB"},"exit_to_hub"),O(null),w(),l(e)},kt=ke=>{const et=u.selectedLoadoutId;if(!et){console.warn("Start Run called without a selected loadout.");return}P({type:"START_RUN",payload:{loadoutId:et,mode:ke}},"hub_start_run")},wt=ke=>{P({type:"START_RUN",payload:{loadoutId:ke,mode:"daily"}},"arcade_start_run"),l(e)};return a?g.jsx(jO,{assetManifest:m,onBack:()=>l(e)}):u.gameStatus==="hub"?g.jsx(Sk,{gameState:u,isArcadeRoute:o,hubPath:e,arcadePath:t,biomesPath:s,replayError:x,tutorialInstructions:B,navigateTo:l,onStartArcadeRun:wt,onSelectLoadout:ke=>{P({type:"APPLY_LOADOUT",payload:ke},"hub_select_loadout")},onStartRun:kt,onLoadScenario:at,onStartReplay:M,onDismissTutorial:()=>W(null)}):g.jsx(Lk,{gameState:u,selectedSkillId:R,showMovementRange:I,isInputLocked:oe,isReplayMode:v,replayActionsLength:T.length,replayIndex:_.current,replayActive:S,mobileToasts:z,tutorialInstructions:B,floorIntro:X,assetManifest:m,onSetBoardBusy:U,onTileClick:le,onSimulationEvents:Z,onMirrorSnapshot:re,onReset:be,onWait:$e,onExitToHub:ot,onSelectSkill:ae,onSelectUpgrade:ue,onDismissTutorial:()=>W(null),onToggleReplay:()=>E(!S),onStepReplay:k,onCloseReplay:Ee})}Jv.createRoot(document.getElementById("root")).render(g.jsx(N.StrictMode,{children:g.jsx(Pk,{})}));
