(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function s(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(a){if(a.ep)return;a.ep=!0;const l=s(a);fetch(a.href,l)}})();function av(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var rd={exports:{}},To={};var sy;function ov(){if(sy)return To;sy=1;var e=Symbol.for("react.transitional.element"),n=Symbol.for("react.fragment");function s(o,a,l){var u=null;if(l!==void 0&&(u=""+l),a.key!==void 0&&(u=""+a.key),"key"in a){l={};for(var f in a)f!=="key"&&(l[f]=a[f])}else l=a;return a=l.ref,{$$typeof:e,type:o,key:u,ref:a!==void 0?a:null,props:l}}return To.Fragment=n,To.jsx=s,To.jsxs=s,To}var ay;function rv(){return ay||(ay=1,rd.exports=ov()),rd.exports}var y=rv(),ld={exports:{}},Te={};var oy;function lv(){if(oy)return Te;oy=1;var e=Symbol.for("react.transitional.element"),n=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),a=Symbol.for("react.profiler"),l=Symbol.for("react.consumer"),u=Symbol.for("react.context"),f=Symbol.for("react.forward_ref"),p=Symbol.for("react.suspense"),h=Symbol.for("react.memo"),g=Symbol.for("react.lazy"),b=Symbol.for("react.activity"),S=Symbol.iterator;function T(B){return B===null||typeof B!="object"?null:(B=S&&B[S]||B["@@iterator"],typeof B=="function"?B:null)}var v={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},A=Object.assign,_={};function E(B,W,G){this.props=B,this.context=W,this.refs=_,this.updater=G||v}E.prototype.isReactComponent={},E.prototype.setState=function(B,W){if(typeof B!="object"&&typeof B!="function"&&B!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,B,W,"setState")},E.prototype.forceUpdate=function(B){this.updater.enqueueForceUpdate(this,B,"forceUpdate")};function w(){}w.prototype=E.prototype;function M(B,W,G){this.props=B,this.context=W,this.refs=_,this.updater=G||v}var C=M.prototype=new w;C.constructor=M,A(C,E.prototype),C.isPureReactComponent=!0;var I=Array.isArray;function k(){}var R={H:null,A:null,T:null,S:null},$=Object.prototype.hasOwnProperty;function j(B,W,G){var ae=G.ref;return{$$typeof:e,type:B,key:W,ref:ae!==void 0?ae:null,props:G}}function D(B,W){return j(B.type,W,B.props)}function q(B){return typeof B=="object"&&B!==null&&B.$$typeof===e}function se(B){var W={"=":"=0",":":"=2"};return"$"+B.replace(/[=:]/g,function(G){return W[G]})}var ee=/\/+/g;function oe(B,W){return typeof B=="object"&&B!==null&&B.key!=null?se(""+B.key):W.toString(36)}function F(B){switch(B.status){case"fulfilled":return B.value;case"rejected":throw B.reason;default:switch(typeof B.status=="string"?B.then(k,k):(B.status="pending",B.then(function(W){B.status==="pending"&&(B.status="fulfilled",B.value=W)},function(W){B.status==="pending"&&(B.status="rejected",B.reason=W)})),B.status){case"fulfilled":return B.value;case"rejected":throw B.reason}}throw B}function H(B,W,G,ae,le){var ue=typeof B;(ue==="undefined"||ue==="boolean")&&(B=null);var be=!1;if(B===null)be=!0;else switch(ue){case"bigint":case"string":case"number":be=!0;break;case"object":switch(B.$$typeof){case e:case n:be=!0;break;case g:return be=B._init,H(be(B._payload),W,G,ae,le)}}if(be)return le=le(B),be=ae===""?"."+oe(B,0):ae,I(le)?(G="",be!=null&&(G=be.replace(ee,"$&/")+"/"),H(le,W,G,"",function(at){return at})):le!=null&&(q(le)&&(le=D(le,G+(le.key==null||B&&B.key===le.key?"":(""+le.key).replace(ee,"$&/")+"/")+be)),W.push(le)),1;be=0;var $e=ae===""?".":ae+":";if(I(B))for(var Ee=0;Ee<B.length;Ee++)ae=B[Ee],ue=$e+oe(ae,Ee),be+=H(ae,W,G,ue,le);else if(Ee=T(B),typeof Ee=="function")for(B=Ee.call(B),Ee=0;!(ae=B.next()).done;)ae=ae.value,ue=$e+oe(ae,Ee++),be+=H(ae,W,G,ue,le);else if(ue==="object"){if(typeof B.then=="function")return H(F(B),W,G,ae,le);throw W=String(B),Error("Objects are not valid as a React child (found: "+(W==="[object Object]"?"object with keys {"+Object.keys(B).join(", ")+"}":W)+"). If you meant to render a collection of children, use an array instead.")}return be}function z(B,W,G){if(B==null)return B;var ae=[],le=0;return H(B,ae,"","",function(ue){return W.call(G,ue,le++)}),ae}function Z(B){if(B._status===-1){var W=B._result;W=W(),W.then(function(G){(B._status===0||B._status===-1)&&(B._status=1,B._result=G)},function(G){(B._status===0||B._status===-1)&&(B._status=2,B._result=G)}),B._status===-1&&(B._status=0,B._result=W)}if(B._status===1)return B._result.default;throw B._result}var re=typeof reportError=="function"?reportError:function(B){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var W=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof B=="object"&&B!==null&&typeof B.message=="string"?String(B.message):String(B),error:B});if(!window.dispatchEvent(W))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",B);return}console.error(B)},pe={map:z,forEach:function(B,W,G){z(B,function(){W.apply(this,arguments)},G)},count:function(B){var W=0;return z(B,function(){W++}),W},toArray:function(B){return z(B,function(W){return W})||[]},only:function(B){if(!q(B))throw Error("React.Children.only expected to receive a single React element child.");return B}};return Te.Activity=b,Te.Children=pe,Te.Component=E,Te.Fragment=s,Te.Profiler=a,Te.PureComponent=M,Te.StrictMode=o,Te.Suspense=p,Te.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=R,Te.__COMPILER_RUNTIME={__proto__:null,c:function(B){return R.H.useMemoCache(B)}},Te.cache=function(B){return function(){return B.apply(null,arguments)}},Te.cacheSignal=function(){return null},Te.cloneElement=function(B,W,G){if(B==null)throw Error("The argument must be a React element, but you passed "+B+".");var ae=A({},B.props),le=B.key;if(W!=null)for(ue in W.key!==void 0&&(le=""+W.key),W)!$.call(W,ue)||ue==="key"||ue==="__self"||ue==="__source"||ue==="ref"&&W.ref===void 0||(ae[ue]=W[ue]);var ue=arguments.length-2;if(ue===1)ae.children=G;else if(1<ue){for(var be=Array(ue),$e=0;$e<ue;$e++)be[$e]=arguments[$e+2];ae.children=be}return j(B.type,le,ae)},Te.createContext=function(B){return B={$$typeof:u,_currentValue:B,_currentValue2:B,_threadCount:0,Provider:null,Consumer:null},B.Provider=B,B.Consumer={$$typeof:l,_context:B},B},Te.createElement=function(B,W,G){var ae,le={},ue=null;if(W!=null)for(ae in W.key!==void 0&&(ue=""+W.key),W)$.call(W,ae)&&ae!=="key"&&ae!=="__self"&&ae!=="__source"&&(le[ae]=W[ae]);var be=arguments.length-2;if(be===1)le.children=G;else if(1<be){for(var $e=Array(be),Ee=0;Ee<be;Ee++)$e[Ee]=arguments[Ee+2];le.children=$e}if(B&&B.defaultProps)for(ae in be=B.defaultProps,be)le[ae]===void 0&&(le[ae]=be[ae]);return j(B,ue,le)},Te.createRef=function(){return{current:null}},Te.forwardRef=function(B){return{$$typeof:f,render:B}},Te.isValidElement=q,Te.lazy=function(B){return{$$typeof:g,_payload:{_status:-1,_result:B},_init:Z}},Te.memo=function(B,W){return{$$typeof:h,type:B,compare:W===void 0?null:W}},Te.startTransition=function(B){var W=R.T,G={};R.T=G;try{var ae=B(),le=R.S;le!==null&&le(G,ae),typeof ae=="object"&&ae!==null&&typeof ae.then=="function"&&ae.then(k,re)}catch(ue){re(ue)}finally{W!==null&&G.types!==null&&(W.types=G.types),R.T=W}},Te.unstable_useCacheRefresh=function(){return R.H.useCacheRefresh()},Te.use=function(B){return R.H.use(B)},Te.useActionState=function(B,W,G){return R.H.useActionState(B,W,G)},Te.useCallback=function(B,W){return R.H.useCallback(B,W)},Te.useContext=function(B){return R.H.useContext(B)},Te.useDebugValue=function(){},Te.useDeferredValue=function(B,W){return R.H.useDeferredValue(B,W)},Te.useEffect=function(B,W){return R.H.useEffect(B,W)},Te.useEffectEvent=function(B){return R.H.useEffectEvent(B)},Te.useId=function(){return R.H.useId()},Te.useImperativeHandle=function(B,W,G){return R.H.useImperativeHandle(B,W,G)},Te.useInsertionEffect=function(B,W){return R.H.useInsertionEffect(B,W)},Te.useLayoutEffect=function(B,W){return R.H.useLayoutEffect(B,W)},Te.useMemo=function(B,W){return R.H.useMemo(B,W)},Te.useOptimistic=function(B,W){return R.H.useOptimistic(B,W)},Te.useReducer=function(B,W,G){return R.H.useReducer(B,W,G)},Te.useRef=function(B){return R.H.useRef(B)},Te.useState=function(B){return R.H.useState(B)},Te.useSyncExternalStore=function(B,W,G){return R.H.useSyncExternalStore(B,W,G)},Te.useTransition=function(){return R.H.useTransition()},Te.version="19.2.3",Te}var ry;function Qd(){return ry||(ry=1,ld.exports=lv()),ld.exports}var N=Qd();const kn=av(N);var cd={exports:{}},Eo={},ud={exports:{}},dd={};var ly;function cv(){return ly||(ly=1,(function(e){function n(H,z){var Z=H.length;H.push(z);e:for(;0<Z;){var re=Z-1>>>1,pe=H[re];if(0<a(pe,z))H[re]=z,H[Z]=pe,Z=re;else break e}}function s(H){return H.length===0?null:H[0]}function o(H){if(H.length===0)return null;var z=H[0],Z=H.pop();if(Z!==z){H[0]=Z;e:for(var re=0,pe=H.length,B=pe>>>1;re<B;){var W=2*(re+1)-1,G=H[W],ae=W+1,le=H[ae];if(0>a(G,Z))ae<pe&&0>a(le,G)?(H[re]=le,H[ae]=Z,re=ae):(H[re]=G,H[W]=Z,re=W);else if(ae<pe&&0>a(le,Z))H[re]=le,H[ae]=Z,re=ae;else break e}}return z}function a(H,z){var Z=H.sortIndex-z.sortIndex;return Z!==0?Z:H.id-z.id}if(e.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var l=performance;e.unstable_now=function(){return l.now()}}else{var u=Date,f=u.now();e.unstable_now=function(){return u.now()-f}}var p=[],h=[],g=1,b=null,S=3,T=!1,v=!1,A=!1,_=!1,E=typeof setTimeout=="function"?setTimeout:null,w=typeof clearTimeout=="function"?clearTimeout:null,M=typeof setImmediate<"u"?setImmediate:null;function C(H){for(var z=s(h);z!==null;){if(z.callback===null)o(h);else if(z.startTime<=H)o(h),z.sortIndex=z.expirationTime,n(p,z);else break;z=s(h)}}function I(H){if(A=!1,C(H),!v)if(s(p)!==null)v=!0,k||(k=!0,se());else{var z=s(h);z!==null&&F(I,z.startTime-H)}}var k=!1,R=-1,$=5,j=-1;function D(){return _?!0:!(e.unstable_now()-j<$)}function q(){if(_=!1,k){var H=e.unstable_now();j=H;var z=!0;try{e:{v=!1,A&&(A=!1,w(R),R=-1),T=!0;var Z=S;try{t:{for(C(H),b=s(p);b!==null&&!(b.expirationTime>H&&D());){var re=b.callback;if(typeof re=="function"){b.callback=null,S=b.priorityLevel;var pe=re(b.expirationTime<=H);if(H=e.unstable_now(),typeof pe=="function"){b.callback=pe,C(H),z=!0;break t}b===s(p)&&o(p),C(H)}else o(p);b=s(p)}if(b!==null)z=!0;else{var B=s(h);B!==null&&F(I,B.startTime-H),z=!1}}break e}finally{b=null,S=Z,T=!1}z=void 0}}finally{z?se():k=!1}}}var se;if(typeof M=="function")se=function(){M(q)};else if(typeof MessageChannel<"u"){var ee=new MessageChannel,oe=ee.port2;ee.port1.onmessage=q,se=function(){oe.postMessage(null)}}else se=function(){E(q,0)};function F(H,z){R=E(function(){H(e.unstable_now())},z)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(H){H.callback=null},e.unstable_forceFrameRate=function(H){0>H||125<H?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):$=0<H?Math.floor(1e3/H):5},e.unstable_getCurrentPriorityLevel=function(){return S},e.unstable_next=function(H){switch(S){case 1:case 2:case 3:var z=3;break;default:z=S}var Z=S;S=z;try{return H()}finally{S=Z}},e.unstable_requestPaint=function(){_=!0},e.unstable_runWithPriority=function(H,z){switch(H){case 1:case 2:case 3:case 4:case 5:break;default:H=3}var Z=S;S=H;try{return z()}finally{S=Z}},e.unstable_scheduleCallback=function(H,z,Z){var re=e.unstable_now();switch(typeof Z=="object"&&Z!==null?(Z=Z.delay,Z=typeof Z=="number"&&0<Z?re+Z:re):Z=re,H){case 1:var pe=-1;break;case 2:pe=250;break;case 5:pe=1073741823;break;case 4:pe=1e4;break;default:pe=5e3}return pe=Z+pe,H={id:g++,callback:z,priorityLevel:H,startTime:Z,expirationTime:pe,sortIndex:-1},Z>re?(H.sortIndex=Z,n(h,H),s(p)===null&&H===s(h)&&(A?(w(R),R=-1):A=!0,F(I,Z-re))):(H.sortIndex=pe,n(p,H),v||T||(v=!0,k||(k=!0,se()))),H},e.unstable_shouldYield=D,e.unstable_wrapCallback=function(H){var z=S;return function(){var Z=S;S=z;try{return H.apply(this,arguments)}finally{S=Z}}}})(dd)),dd}var cy;function uv(){return cy||(cy=1,ud.exports=cv()),ud.exports}var fd={exports:{}},zt={};var uy;function dv(){if(uy)return zt;uy=1;var e=Qd();function n(p){var h="https://react.dev/errors/"+p;if(1<arguments.length){h+="?args[]="+encodeURIComponent(arguments[1]);for(var g=2;g<arguments.length;g++)h+="&args[]="+encodeURIComponent(arguments[g])}return"Minified React error #"+p+"; visit "+h+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function s(){}var o={d:{f:s,r:function(){throw Error(n(522))},D:s,C:s,L:s,m:s,X:s,S:s,M:s},p:0,findDOMNode:null},a=Symbol.for("react.portal");function l(p,h,g){var b=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:a,key:b==null?null:""+b,children:p,containerInfo:h,implementation:g}}var u=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function f(p,h){if(p==="font")return"";if(typeof h=="string")return h==="use-credentials"?h:""}return zt.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=o,zt.createPortal=function(p,h){var g=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!h||h.nodeType!==1&&h.nodeType!==9&&h.nodeType!==11)throw Error(n(299));return l(p,h,null,g)},zt.flushSync=function(p){var h=u.T,g=o.p;try{if(u.T=null,o.p=2,p)return p()}finally{u.T=h,o.p=g,o.d.f()}},zt.preconnect=function(p,h){typeof p=="string"&&(h?(h=h.crossOrigin,h=typeof h=="string"?h==="use-credentials"?h:"":void 0):h=null,o.d.C(p,h))},zt.prefetchDNS=function(p){typeof p=="string"&&o.d.D(p)},zt.preinit=function(p,h){if(typeof p=="string"&&h&&typeof h.as=="string"){var g=h.as,b=f(g,h.crossOrigin),S=typeof h.integrity=="string"?h.integrity:void 0,T=typeof h.fetchPriority=="string"?h.fetchPriority:void 0;g==="style"?o.d.S(p,typeof h.precedence=="string"?h.precedence:void 0,{crossOrigin:b,integrity:S,fetchPriority:T}):g==="script"&&o.d.X(p,{crossOrigin:b,integrity:S,fetchPriority:T,nonce:typeof h.nonce=="string"?h.nonce:void 0})}},zt.preinitModule=function(p,h){if(typeof p=="string")if(typeof h=="object"&&h!==null){if(h.as==null||h.as==="script"){var g=f(h.as,h.crossOrigin);o.d.M(p,{crossOrigin:g,integrity:typeof h.integrity=="string"?h.integrity:void 0,nonce:typeof h.nonce=="string"?h.nonce:void 0})}}else h==null&&o.d.M(p)},zt.preload=function(p,h){if(typeof p=="string"&&typeof h=="object"&&h!==null&&typeof h.as=="string"){var g=h.as,b=f(g,h.crossOrigin);o.d.L(p,g,{crossOrigin:b,integrity:typeof h.integrity=="string"?h.integrity:void 0,nonce:typeof h.nonce=="string"?h.nonce:void 0,type:typeof h.type=="string"?h.type:void 0,fetchPriority:typeof h.fetchPriority=="string"?h.fetchPriority:void 0,referrerPolicy:typeof h.referrerPolicy=="string"?h.referrerPolicy:void 0,imageSrcSet:typeof h.imageSrcSet=="string"?h.imageSrcSet:void 0,imageSizes:typeof h.imageSizes=="string"?h.imageSizes:void 0,media:typeof h.media=="string"?h.media:void 0})}},zt.preloadModule=function(p,h){if(typeof p=="string")if(h){var g=f(h.as,h.crossOrigin);o.d.m(p,{as:typeof h.as=="string"&&h.as!=="script"?h.as:void 0,crossOrigin:g,integrity:typeof h.integrity=="string"?h.integrity:void 0})}else o.d.m(p)},zt.requestFormReset=function(p){o.d.r(p)},zt.unstable_batchedUpdates=function(p,h){return p(h)},zt.useFormState=function(p,h,g){return u.H.useFormState(p,h,g)},zt.useFormStatus=function(){return u.H.useHostTransitionStatus()},zt.version="19.2.3",zt}var dy;function fv(){if(dy)return fd.exports;dy=1;function e(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(n){console.error(n)}}return e(),fd.exports=dv(),fd.exports}var fy;function mv(){if(fy)return Eo;fy=1;var e=uv(),n=Qd(),s=fv();function o(t){var i="https://react.dev/errors/"+t;if(1<arguments.length){i+="?args[]="+encodeURIComponent(arguments[1]);for(var r=2;r<arguments.length;r++)i+="&args[]="+encodeURIComponent(arguments[r])}return"Minified React error #"+t+"; visit "+i+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function a(t){return!(!t||t.nodeType!==1&&t.nodeType!==9&&t.nodeType!==11)}function l(t){var i=t,r=t;if(t.alternate)for(;i.return;)i=i.return;else{t=i;do i=t,(i.flags&4098)!==0&&(r=i.return),t=i.return;while(t)}return i.tag===3?r:null}function u(t){if(t.tag===13){var i=t.memoizedState;if(i===null&&(t=t.alternate,t!==null&&(i=t.memoizedState)),i!==null)return i.dehydrated}return null}function f(t){if(t.tag===31){var i=t.memoizedState;if(i===null&&(t=t.alternate,t!==null&&(i=t.memoizedState)),i!==null)return i.dehydrated}return null}function p(t){if(l(t)!==t)throw Error(o(188))}function h(t){var i=t.alternate;if(!i){if(i=l(t),i===null)throw Error(o(188));return i!==t?null:t}for(var r=t,c=i;;){var d=r.return;if(d===null)break;var m=d.alternate;if(m===null){if(c=d.return,c!==null){r=c;continue}break}if(d.child===m.child){for(m=d.child;m;){if(m===r)return p(d),t;if(m===c)return p(d),i;m=m.sibling}throw Error(o(188))}if(r.return!==c.return)r=d,c=m;else{for(var x=!1,O=d.child;O;){if(O===r){x=!0,r=d,c=m;break}if(O===c){x=!0,c=d,r=m;break}O=O.sibling}if(!x){for(O=m.child;O;){if(O===r){x=!0,r=m,c=d;break}if(O===c){x=!0,c=m,r=d;break}O=O.sibling}if(!x)throw Error(o(189))}}if(r.alternate!==c)throw Error(o(190))}if(r.tag!==3)throw Error(o(188));return r.stateNode.current===r?t:i}function g(t){var i=t.tag;if(i===5||i===26||i===27||i===6)return t;for(t=t.child;t!==null;){if(i=g(t),i!==null)return i;t=t.sibling}return null}var b=Object.assign,S=Symbol.for("react.element"),T=Symbol.for("react.transitional.element"),v=Symbol.for("react.portal"),A=Symbol.for("react.fragment"),_=Symbol.for("react.strict_mode"),E=Symbol.for("react.profiler"),w=Symbol.for("react.consumer"),M=Symbol.for("react.context"),C=Symbol.for("react.forward_ref"),I=Symbol.for("react.suspense"),k=Symbol.for("react.suspense_list"),R=Symbol.for("react.memo"),$=Symbol.for("react.lazy"),j=Symbol.for("react.activity"),D=Symbol.for("react.memo_cache_sentinel"),q=Symbol.iterator;function se(t){return t===null||typeof t!="object"?null:(t=q&&t[q]||t["@@iterator"],typeof t=="function"?t:null)}var ee=Symbol.for("react.client.reference");function oe(t){if(t==null)return null;if(typeof t=="function")return t.$$typeof===ee?null:t.displayName||t.name||null;if(typeof t=="string")return t;switch(t){case A:return"Fragment";case E:return"Profiler";case _:return"StrictMode";case I:return"Suspense";case k:return"SuspenseList";case j:return"Activity"}if(typeof t=="object")switch(t.$$typeof){case v:return"Portal";case M:return t.displayName||"Context";case w:return(t._context.displayName||"Context")+".Consumer";case C:var i=t.render;return t=t.displayName,t||(t=i.displayName||i.name||"",t=t!==""?"ForwardRef("+t+")":"ForwardRef"),t;case R:return i=t.displayName||null,i!==null?i:oe(t.type)||"Memo";case $:i=t._payload,t=t._init;try{return oe(t(i))}catch{}}return null}var F=Array.isArray,H=n.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,z=s.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,Z={pending:!1,data:null,method:null,action:null},re=[],pe=-1;function B(t){return{current:t}}function W(t){0>pe||(t.current=re[pe],re[pe]=null,pe--)}function G(t,i){pe++,re[pe]=t.current,t.current=i}var ae=B(null),le=B(null),ue=B(null),be=B(null);function $e(t,i){switch(G(ue,i),G(le,t),G(ae,null),i.nodeType){case 9:case 11:t=(t=i.documentElement)&&(t=t.namespaceURI)?Mh(t):0;break;default:if(t=i.tagName,i=i.namespaceURI)i=Mh(i),t=Ch(i,t);else switch(t){case"svg":t=1;break;case"math":t=2;break;default:t=0}}W(ae),G(ae,t)}function Ee(){W(ae),W(le),W(ue)}function at(t){t.memoizedState!==null&&G(be,t);var i=ae.current,r=Ch(i,t.type);i!==r&&(G(le,t),G(ae,r))}function ot(t){le.current===t&&(W(ae),W(le)),be.current===t&&(W(be),So._currentValue=Z)}var Nt,Mt;function Ne(t){if(Nt===void 0)try{throw Error()}catch(r){var i=r.stack.trim().match(/\n( *(at )?)/);Nt=i&&i[1]||"",Mt=-1<r.stack.indexOf(`
    at`)?" (<anonymous>)":-1<r.stack.indexOf("@")?"@unknown:0:0":""}return`
`+Nt+t+Mt}var et=!1;function Wt(t,i){if(!t||et)return"";et=!0;var r=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var c={DetermineComponentFrameRoot:function(){try{if(i){var ie=function(){throw Error()};if(Object.defineProperty(ie.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(ie,[])}catch(J){var K=J}Reflect.construct(t,[],ie)}else{try{ie.call()}catch(J){K=J}t.call(ie.prototype)}}else{try{throw Error()}catch(J){K=J}(ie=t())&&typeof ie.catch=="function"&&ie.catch(function(){})}}catch(J){if(J&&K&&typeof J.stack=="string")return[J.stack,K.stack]}return[null,null]}};c.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var d=Object.getOwnPropertyDescriptor(c.DetermineComponentFrameRoot,"name");d&&d.configurable&&Object.defineProperty(c.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var m=c.DetermineComponentFrameRoot(),x=m[0],O=m[1];if(x&&O){var L=x.split(`
`),Y=O.split(`
`);for(d=c=0;c<L.length&&!L[c].includes("DetermineComponentFrameRoot");)c++;for(;d<Y.length&&!Y[d].includes("DetermineComponentFrameRoot");)d++;if(c===L.length||d===Y.length)for(c=L.length-1,d=Y.length-1;1<=c&&0<=d&&L[c]!==Y[d];)d--;for(;1<=c&&0<=d;c--,d--)if(L[c]!==Y[d]){if(c!==1||d!==1)do if(c--,d--,0>d||L[c]!==Y[d]){var te=`
`+L[c].replace(" at new "," at ");return t.displayName&&te.includes("<anonymous>")&&(te=te.replace("<anonymous>",t.displayName)),te}while(1<=c&&0<=d);break}}}finally{et=!1,Error.prepareStackTrace=r}return(r=t?t.displayName||t.name:"")?Ne(r):""}function Yt(t,i){switch(t.tag){case 26:case 27:case 5:return Ne(t.type);case 16:return Ne("Lazy");case 13:return t.child!==i&&i!==null?Ne("Suspense Fallback"):Ne("Suspense");case 19:return Ne("SuspenseList");case 0:case 15:return Wt(t.type,!1);case 11:return Wt(t.type.render,!1);case 1:return Wt(t.type,!0);case 31:return Ne("Activity");default:return""}}function _n(t){try{var i="",r=null;do i+=Yt(t,r),r=t,t=t.return;while(t);return i}catch(c){return`
Error generating stack: `+c.message+`
`+c.stack}}var Pn=Object.prototype.hasOwnProperty,jn=e.unstable_scheduleCallback,Qi=e.unstable_cancelCallback,_a=e.unstable_shouldYield,Os=e.unstable_requestPaint,It=e.unstable_now,wa=e.unstable_getCurrentPriorityLevel,Ns=e.unstable_ImmediatePriority,ks=e.unstable_UserBlockingPriority,Yn=e.unstable_NormalPriority,Zi=e.unstable_LowPriority,es=e.unstable_IdlePriority,Ma=e.log,Ca=e.unstable_setDisableYieldValue,Kn=null,Lt=null;function mt(t){if(typeof Ma=="function"&&Ca(t),Lt&&typeof Lt.setStrictMode=="function")try{Lt.setStrictMode(Kn,t)}catch{}}var pt=Math.clz32?Math.clz32:ht,Oa=Math.log,_e=Math.LN2;function ht(t){return t>>>=0,t===0?32:31-(Oa(t)/_e|0)|0}var Bt=256,rt=262144,fn=4194304;function sn(t){var i=t&42;if(i!==0)return i;switch(t&-t){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return t&261888;case 262144:case 524288:case 1048576:case 2097152:return t&3932160;case 4194304:case 8388608:case 16777216:case 33554432:return t&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return t}}function yi(t,i,r){var c=t.pendingLanes;if(c===0)return 0;var d=0,m=t.suspendedLanes,x=t.pingedLanes;t=t.warmLanes;var O=c&134217727;return O!==0?(c=O&~m,c!==0?d=sn(c):(x&=O,x!==0?d=sn(x):r||(r=O&~t,r!==0&&(d=sn(r))))):(O=c&~m,O!==0?d=sn(O):x!==0?d=sn(x):r||(r=c&~t,r!==0&&(d=sn(r)))),d===0?0:i!==0&&i!==d&&(i&m)===0&&(m=d&-d,r=i&-i,m>=r||m===32&&(r&4194048)!==0)?i:d}function ts(t,i){return(t.pendingLanes&~(t.suspendedLanes&~t.pingedLanes)&i)===0}function Jl(t,i){switch(t){case 1:case 2:case 4:case 8:case 64:return i+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return i+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function Na(){var t=fn;return fn<<=1,(fn&62914560)===0&&(fn=4194304),t}function Rs(t){for(var i=[],r=0;31>r;r++)i.push(t);return i}function ns(t,i){t.pendingLanes|=i,i!==268435456&&(t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0)}function Gt(t,i,r,c,d,m){var x=t.pendingLanes;t.pendingLanes=r,t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0,t.expiredLanes&=r,t.entangledLanes&=r,t.errorRecoveryDisabledLanes&=r,t.shellSuspendCounter=0;var O=t.entanglements,L=t.expirationTimes,Y=t.hiddenUpdates;for(r=x&~r;0<r;){var te=31-pt(r),ie=1<<te;O[te]=0,L[te]=-1;var K=Y[te];if(K!==null)for(Y[te]=null,te=0;te<K.length;te++){var J=K[te];J!==null&&(J.lane&=-536870913)}r&=~ie}c!==0&&Ht(t,c,0),m!==0&&d===0&&t.tag!==0&&(t.suspendedLanes|=m&~(x&~i))}function Ht(t,i,r){t.pendingLanes|=i,t.suspendedLanes&=~i;var c=31-pt(i);t.entangledLanes|=i,t.entanglements[c]=t.entanglements[c]|1073741824|r&261930}function wn(t,i){var r=t.entangledLanes|=i;for(t=t.entanglements;r;){var c=31-pt(r),d=1<<c;d&i|t[c]&i&&(t[c]|=i),r&=~d}}function Is(t,i){var r=i&-i;return r=(r&42)!==0?1:ka(r),(r&(t.suspendedLanes|i))!==0?0:r}function ka(t){switch(t){case 2:t=1;break;case 8:t=4;break;case 32:t=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:t=128;break;case 268435456:t=134217728;break;default:t=0}return t}function Ls(t){return t&=-t,2<t?8<t?(t&134217727)!==0?32:268435456:8:2}function Ra(){var t=z.p;return t!==0?t:(t=window.event,t===void 0?32:Jh(t.type))}function mf(t,i){var r=z.p;try{return z.p=t,i()}finally{z.p=r}}var gi=Math.random().toString(36).slice(2),Pt="__reactFiber$"+gi,Xt="__reactProps$"+gi,Bs="__reactContainer$"+gi,Ql="__reactEvents$"+gi,W0="__reactListeners$"+gi,G0="__reactHandles$"+gi,pf="__reactResources$"+gi,Ia="__reactMarker$"+gi;function Zl(t){delete t[Pt],delete t[Xt],delete t[Ql],delete t[W0],delete t[G0]}function Hs(t){var i=t[Pt];if(i)return i;for(var r=t.parentNode;r;){if(i=r[Bs]||r[Pt]){if(r=i.alternate,i.child!==null||r!==null&&r.child!==null)for(t=Bh(t);t!==null;){if(r=t[Pt])return r;t=Bh(t)}return i}t=r,r=t.parentNode}return null}function Ps(t){if(t=t[Pt]||t[Bs]){var i=t.tag;if(i===5||i===6||i===13||i===31||i===26||i===27||i===3)return t}return null}function La(t){var i=t.tag;if(i===5||i===26||i===27||i===6)return t.stateNode;throw Error(o(33))}function js(t){var i=t[pf];return i||(i=t[pf]={hoistableStyles:new Map,hoistableScripts:new Map}),i}function kt(t){t[Ia]=!0}var hf=new Set,yf={};function is(t,i){Ds(t,i),Ds(t+"Capture",i)}function Ds(t,i){for(yf[t]=i,t=0;t<i.length;t++)hf.add(i[t])}var X0=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),gf={},bf={};function J0(t){return Pn.call(bf,t)?!0:Pn.call(gf,t)?!1:X0.test(t)?bf[t]=!0:(gf[t]=!0,!1)}function Yo(t,i,r){if(J0(i))if(r===null)t.removeAttribute(i);else{switch(typeof r){case"undefined":case"function":case"symbol":t.removeAttribute(i);return;case"boolean":var c=i.toLowerCase().slice(0,5);if(c!=="data-"&&c!=="aria-"){t.removeAttribute(i);return}}t.setAttribute(i,""+r)}}function Ko(t,i,r){if(r===null)t.removeAttribute(i);else{switch(typeof r){case"undefined":case"function":case"symbol":case"boolean":t.removeAttribute(i);return}t.setAttribute(i,""+r)}}function Fn(t,i,r,c){if(c===null)t.removeAttribute(r);else{switch(typeof c){case"undefined":case"function":case"symbol":case"boolean":t.removeAttribute(r);return}t.setAttributeNS(i,r,""+c)}}function mn(t){switch(typeof t){case"bigint":case"boolean":case"number":case"string":case"undefined":return t;case"object":return t;default:return""}}function Sf(t){var i=t.type;return(t=t.nodeName)&&t.toLowerCase()==="input"&&(i==="checkbox"||i==="radio")}function Q0(t,i,r){var c=Object.getOwnPropertyDescriptor(t.constructor.prototype,i);if(!t.hasOwnProperty(i)&&typeof c<"u"&&typeof c.get=="function"&&typeof c.set=="function"){var d=c.get,m=c.set;return Object.defineProperty(t,i,{configurable:!0,get:function(){return d.call(this)},set:function(x){r=""+x,m.call(this,x)}}),Object.defineProperty(t,i,{enumerable:c.enumerable}),{getValue:function(){return r},setValue:function(x){r=""+x},stopTracking:function(){t._valueTracker=null,delete t[i]}}}}function ec(t){if(!t._valueTracker){var i=Sf(t)?"checked":"value";t._valueTracker=Q0(t,i,""+t[i])}}function vf(t){if(!t)return!1;var i=t._valueTracker;if(!i)return!0;var r=i.getValue(),c="";return t&&(c=Sf(t)?t.checked?"true":"false":t.value),t=c,t!==r?(i.setValue(t),!0):!1}function Fo(t){if(t=t||(typeof document<"u"?document:void 0),typeof t>"u")return null;try{return t.activeElement||t.body}catch{return t.body}}var Z0=/[\n"\\]/g;function pn(t){return t.replace(Z0,function(i){return"\\"+i.charCodeAt(0).toString(16)+" "})}function tc(t,i,r,c,d,m,x,O){t.name="",x!=null&&typeof x!="function"&&typeof x!="symbol"&&typeof x!="boolean"?t.type=x:t.removeAttribute("type"),i!=null?x==="number"?(i===0&&t.value===""||t.value!=i)&&(t.value=""+mn(i)):t.value!==""+mn(i)&&(t.value=""+mn(i)):x!=="submit"&&x!=="reset"||t.removeAttribute("value"),i!=null?nc(t,x,mn(i)):r!=null?nc(t,x,mn(r)):c!=null&&t.removeAttribute("value"),d==null&&m!=null&&(t.defaultChecked=!!m),d!=null&&(t.checked=d&&typeof d!="function"&&typeof d!="symbol"),O!=null&&typeof O!="function"&&typeof O!="symbol"&&typeof O!="boolean"?t.name=""+mn(O):t.removeAttribute("name")}function xf(t,i,r,c,d,m,x,O){if(m!=null&&typeof m!="function"&&typeof m!="symbol"&&typeof m!="boolean"&&(t.type=m),i!=null||r!=null){if(!(m!=="submit"&&m!=="reset"||i!=null)){ec(t);return}r=r!=null?""+mn(r):"",i=i!=null?""+mn(i):r,O||i===t.value||(t.value=i),t.defaultValue=i}c=c??d,c=typeof c!="function"&&typeof c!="symbol"&&!!c,t.checked=O?t.checked:!!c,t.defaultChecked=!!c,x!=null&&typeof x!="function"&&typeof x!="symbol"&&typeof x!="boolean"&&(t.name=x),ec(t)}function nc(t,i,r){i==="number"&&Fo(t.ownerDocument)===t||t.defaultValue===""+r||(t.defaultValue=""+r)}function Us(t,i,r,c){if(t=t.options,i){i={};for(var d=0;d<r.length;d++)i["$"+r[d]]=!0;for(r=0;r<t.length;r++)d=i.hasOwnProperty("$"+t[r].value),t[r].selected!==d&&(t[r].selected=d),d&&c&&(t[r].defaultSelected=!0)}else{for(r=""+mn(r),i=null,d=0;d<t.length;d++){if(t[d].value===r){t[d].selected=!0,c&&(t[d].defaultSelected=!0);return}i!==null||t[d].disabled||(i=t[d])}i!==null&&(i.selected=!0)}}function Af(t,i,r){if(i!=null&&(i=""+mn(i),i!==t.value&&(t.value=i),r==null)){t.defaultValue!==i&&(t.defaultValue=i);return}t.defaultValue=r!=null?""+mn(r):""}function Tf(t,i,r,c){if(i==null){if(c!=null){if(r!=null)throw Error(o(92));if(F(c)){if(1<c.length)throw Error(o(93));c=c[0]}r=c}r==null&&(r=""),i=r}r=mn(i),t.defaultValue=r,c=t.textContent,c===r&&c!==""&&c!==null&&(t.value=c),ec(t)}function $s(t,i){if(i){var r=t.firstChild;if(r&&r===t.lastChild&&r.nodeType===3){r.nodeValue=i;return}}t.textContent=i}var eb=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function Ef(t,i,r){var c=i.indexOf("--")===0;r==null||typeof r=="boolean"||r===""?c?t.setProperty(i,""):i==="float"?t.cssFloat="":t[i]="":c?t.setProperty(i,r):typeof r!="number"||r===0||eb.has(i)?i==="float"?t.cssFloat=r:t[i]=(""+r).trim():t[i]=r+"px"}function _f(t,i,r){if(i!=null&&typeof i!="object")throw Error(o(62));if(t=t.style,r!=null){for(var c in r)!r.hasOwnProperty(c)||i!=null&&i.hasOwnProperty(c)||(c.indexOf("--")===0?t.setProperty(c,""):c==="float"?t.cssFloat="":t[c]="");for(var d in i)c=i[d],i.hasOwnProperty(d)&&r[d]!==c&&Ef(t,d,c)}else for(var m in i)i.hasOwnProperty(m)&&Ef(t,m,i[m])}function ic(t){if(t.indexOf("-")===-1)return!1;switch(t){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var tb=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),nb=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function Wo(t){return nb.test(""+t)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":t}function Wn(){}var sc=null;function ac(t){return t=t.target||t.srcElement||window,t.correspondingUseElement&&(t=t.correspondingUseElement),t.nodeType===3?t.parentNode:t}var qs=null,zs=null;function wf(t){var i=Ps(t);if(i&&(t=i.stateNode)){var r=t[Xt]||null;e:switch(t=i.stateNode,i.type){case"input":if(tc(t,r.value,r.defaultValue,r.defaultValue,r.checked,r.defaultChecked,r.type,r.name),i=r.name,r.type==="radio"&&i!=null){for(r=t;r.parentNode;)r=r.parentNode;for(r=r.querySelectorAll('input[name="'+pn(""+i)+'"][type="radio"]'),i=0;i<r.length;i++){var c=r[i];if(c!==t&&c.form===t.form){var d=c[Xt]||null;if(!d)throw Error(o(90));tc(c,d.value,d.defaultValue,d.defaultValue,d.checked,d.defaultChecked,d.type,d.name)}}for(i=0;i<r.length;i++)c=r[i],c.form===t.form&&vf(c)}break e;case"textarea":Af(t,r.value,r.defaultValue);break e;case"select":i=r.value,i!=null&&Us(t,!!r.multiple,i,!1)}}}var oc=!1;function Mf(t,i,r){if(oc)return t(i,r);oc=!0;try{var c=t(i);return c}finally{if(oc=!1,(qs!==null||zs!==null)&&(Br(),qs&&(i=qs,t=zs,zs=qs=null,wf(i),t)))for(i=0;i<t.length;i++)wf(t[i])}}function Ba(t,i){var r=t.stateNode;if(r===null)return null;var c=r[Xt]||null;if(c===null)return null;r=c[i];e:switch(i){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(c=!c.disabled)||(t=t.type,c=!(t==="button"||t==="input"||t==="select"||t==="textarea")),t=!c;break e;default:t=!1}if(t)return null;if(r&&typeof r!="function")throw Error(o(231,i,typeof r));return r}var Gn=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),rc=!1;if(Gn)try{var Ha={};Object.defineProperty(Ha,"passive",{get:function(){rc=!0}}),window.addEventListener("test",Ha,Ha),window.removeEventListener("test",Ha,Ha)}catch{rc=!1}var bi=null,lc=null,Go=null;function Cf(){if(Go)return Go;var t,i=lc,r=i.length,c,d="value"in bi?bi.value:bi.textContent,m=d.length;for(t=0;t<r&&i[t]===d[t];t++);var x=r-t;for(c=1;c<=x&&i[r-c]===d[m-c];c++);return Go=d.slice(t,1<c?1-c:void 0)}function Xo(t){var i=t.keyCode;return"charCode"in t?(t=t.charCode,t===0&&i===13&&(t=13)):t=i,t===10&&(t=13),32<=t||t===13?t:0}function Jo(){return!0}function Of(){return!1}function Jt(t){function i(r,c,d,m,x){this._reactName=r,this._targetInst=d,this.type=c,this.nativeEvent=m,this.target=x,this.currentTarget=null;for(var O in t)t.hasOwnProperty(O)&&(r=t[O],this[O]=r?r(m):m[O]);return this.isDefaultPrevented=(m.defaultPrevented!=null?m.defaultPrevented:m.returnValue===!1)?Jo:Of,this.isPropagationStopped=Of,this}return b(i.prototype,{preventDefault:function(){this.defaultPrevented=!0;var r=this.nativeEvent;r&&(r.preventDefault?r.preventDefault():typeof r.returnValue!="unknown"&&(r.returnValue=!1),this.isDefaultPrevented=Jo)},stopPropagation:function(){var r=this.nativeEvent;r&&(r.stopPropagation?r.stopPropagation():typeof r.cancelBubble!="unknown"&&(r.cancelBubble=!0),this.isPropagationStopped=Jo)},persist:function(){},isPersistent:Jo}),i}var ss={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(t){return t.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Qo=Jt(ss),Pa=b({},ss,{view:0,detail:0}),ib=Jt(Pa),cc,uc,ja,Zo=b({},Pa,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:fc,button:0,buttons:0,relatedTarget:function(t){return t.relatedTarget===void 0?t.fromElement===t.srcElement?t.toElement:t.fromElement:t.relatedTarget},movementX:function(t){return"movementX"in t?t.movementX:(t!==ja&&(ja&&t.type==="mousemove"?(cc=t.screenX-ja.screenX,uc=t.screenY-ja.screenY):uc=cc=0,ja=t),cc)},movementY:function(t){return"movementY"in t?t.movementY:uc}}),Nf=Jt(Zo),sb=b({},Zo,{dataTransfer:0}),ab=Jt(sb),ob=b({},Pa,{relatedTarget:0}),dc=Jt(ob),rb=b({},ss,{animationName:0,elapsedTime:0,pseudoElement:0}),lb=Jt(rb),cb=b({},ss,{clipboardData:function(t){return"clipboardData"in t?t.clipboardData:window.clipboardData}}),ub=Jt(cb),db=b({},ss,{data:0}),kf=Jt(db),fb={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},mb={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},pb={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function hb(t){var i=this.nativeEvent;return i.getModifierState?i.getModifierState(t):(t=pb[t])?!!i[t]:!1}function fc(){return hb}var yb=b({},Pa,{key:function(t){if(t.key){var i=fb[t.key]||t.key;if(i!=="Unidentified")return i}return t.type==="keypress"?(t=Xo(t),t===13?"Enter":String.fromCharCode(t)):t.type==="keydown"||t.type==="keyup"?mb[t.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:fc,charCode:function(t){return t.type==="keypress"?Xo(t):0},keyCode:function(t){return t.type==="keydown"||t.type==="keyup"?t.keyCode:0},which:function(t){return t.type==="keypress"?Xo(t):t.type==="keydown"||t.type==="keyup"?t.keyCode:0}}),gb=Jt(yb),bb=b({},Zo,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Rf=Jt(bb),Sb=b({},Pa,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:fc}),vb=Jt(Sb),xb=b({},ss,{propertyName:0,elapsedTime:0,pseudoElement:0}),Ab=Jt(xb),Tb=b({},Zo,{deltaX:function(t){return"deltaX"in t?t.deltaX:"wheelDeltaX"in t?-t.wheelDeltaX:0},deltaY:function(t){return"deltaY"in t?t.deltaY:"wheelDeltaY"in t?-t.wheelDeltaY:"wheelDelta"in t?-t.wheelDelta:0},deltaZ:0,deltaMode:0}),Eb=Jt(Tb),_b=b({},ss,{newState:0,oldState:0}),wb=Jt(_b),Mb=[9,13,27,32],mc=Gn&&"CompositionEvent"in window,Da=null;Gn&&"documentMode"in document&&(Da=document.documentMode);var Cb=Gn&&"TextEvent"in window&&!Da,If=Gn&&(!mc||Da&&8<Da&&11>=Da),Lf=" ",Bf=!1;function Hf(t,i){switch(t){case"keyup":return Mb.indexOf(i.keyCode)!==-1;case"keydown":return i.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Pf(t){return t=t.detail,typeof t=="object"&&"data"in t?t.data:null}var Vs=!1;function Ob(t,i){switch(t){case"compositionend":return Pf(i);case"keypress":return i.which!==32?null:(Bf=!0,Lf);case"textInput":return t=i.data,t===Lf&&Bf?null:t;default:return null}}function Nb(t,i){if(Vs)return t==="compositionend"||!mc&&Hf(t,i)?(t=Cf(),Go=lc=bi=null,Vs=!1,t):null;switch(t){case"paste":return null;case"keypress":if(!(i.ctrlKey||i.altKey||i.metaKey)||i.ctrlKey&&i.altKey){if(i.char&&1<i.char.length)return i.char;if(i.which)return String.fromCharCode(i.which)}return null;case"compositionend":return If&&i.locale!=="ko"?null:i.data;default:return null}}var kb={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function jf(t){var i=t&&t.nodeName&&t.nodeName.toLowerCase();return i==="input"?!!kb[t.type]:i==="textarea"}function Df(t,i,r,c){qs?zs?zs.push(c):zs=[c]:qs=c,i=qr(i,"onChange"),0<i.length&&(r=new Qo("onChange","change",null,r,c),t.push({event:r,listeners:i}))}var Ua=null,$a=null;function Rb(t){xh(t,0)}function er(t){var i=La(t);if(vf(i))return t}function Uf(t,i){if(t==="change")return i}var $f=!1;if(Gn){var pc;if(Gn){var hc="oninput"in document;if(!hc){var qf=document.createElement("div");qf.setAttribute("oninput","return;"),hc=typeof qf.oninput=="function"}pc=hc}else pc=!1;$f=pc&&(!document.documentMode||9<document.documentMode)}function zf(){Ua&&(Ua.detachEvent("onpropertychange",Vf),$a=Ua=null)}function Vf(t){if(t.propertyName==="value"&&er($a)){var i=[];Df(i,$a,t,ac(t)),Mf(Rb,i)}}function Ib(t,i,r){t==="focusin"?(zf(),Ua=i,$a=r,Ua.attachEvent("onpropertychange",Vf)):t==="focusout"&&zf()}function Lb(t){if(t==="selectionchange"||t==="keyup"||t==="keydown")return er($a)}function Bb(t,i){if(t==="click")return er(i)}function Hb(t,i){if(t==="input"||t==="change")return er(i)}function Pb(t,i){return t===i&&(t!==0||1/t===1/i)||t!==t&&i!==i}var an=typeof Object.is=="function"?Object.is:Pb;function qa(t,i){if(an(t,i))return!0;if(typeof t!="object"||t===null||typeof i!="object"||i===null)return!1;var r=Object.keys(t),c=Object.keys(i);if(r.length!==c.length)return!1;for(c=0;c<r.length;c++){var d=r[c];if(!Pn.call(i,d)||!an(t[d],i[d]))return!1}return!0}function Yf(t){for(;t&&t.firstChild;)t=t.firstChild;return t}function Kf(t,i){var r=Yf(t);t=0;for(var c;r;){if(r.nodeType===3){if(c=t+r.textContent.length,t<=i&&c>=i)return{node:r,offset:i-t};t=c}e:{for(;r;){if(r.nextSibling){r=r.nextSibling;break e}r=r.parentNode}r=void 0}r=Yf(r)}}function Ff(t,i){return t&&i?t===i?!0:t&&t.nodeType===3?!1:i&&i.nodeType===3?Ff(t,i.parentNode):"contains"in t?t.contains(i):t.compareDocumentPosition?!!(t.compareDocumentPosition(i)&16):!1:!1}function Wf(t){t=t!=null&&t.ownerDocument!=null&&t.ownerDocument.defaultView!=null?t.ownerDocument.defaultView:window;for(var i=Fo(t.document);i instanceof t.HTMLIFrameElement;){try{var r=typeof i.contentWindow.location.href=="string"}catch{r=!1}if(r)t=i.contentWindow;else break;i=Fo(t.document)}return i}function yc(t){var i=t&&t.nodeName&&t.nodeName.toLowerCase();return i&&(i==="input"&&(t.type==="text"||t.type==="search"||t.type==="tel"||t.type==="url"||t.type==="password")||i==="textarea"||t.contentEditable==="true")}var jb=Gn&&"documentMode"in document&&11>=document.documentMode,Ys=null,gc=null,za=null,bc=!1;function Gf(t,i,r){var c=r.window===r?r.document:r.nodeType===9?r:r.ownerDocument;bc||Ys==null||Ys!==Fo(c)||(c=Ys,"selectionStart"in c&&yc(c)?c={start:c.selectionStart,end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset}),za&&qa(za,c)||(za=c,c=qr(gc,"onSelect"),0<c.length&&(i=new Qo("onSelect","select",null,i,r),t.push({event:i,listeners:c}),i.target=Ys)))}function as(t,i){var r={};return r[t.toLowerCase()]=i.toLowerCase(),r["Webkit"+t]="webkit"+i,r["Moz"+t]="moz"+i,r}var Ks={animationend:as("Animation","AnimationEnd"),animationiteration:as("Animation","AnimationIteration"),animationstart:as("Animation","AnimationStart"),transitionrun:as("Transition","TransitionRun"),transitionstart:as("Transition","TransitionStart"),transitioncancel:as("Transition","TransitionCancel"),transitionend:as("Transition","TransitionEnd")},Sc={},Xf={};Gn&&(Xf=document.createElement("div").style,"AnimationEvent"in window||(delete Ks.animationend.animation,delete Ks.animationiteration.animation,delete Ks.animationstart.animation),"TransitionEvent"in window||delete Ks.transitionend.transition);function os(t){if(Sc[t])return Sc[t];if(!Ks[t])return t;var i=Ks[t],r;for(r in i)if(i.hasOwnProperty(r)&&r in Xf)return Sc[t]=i[r];return t}var Jf=os("animationend"),Qf=os("animationiteration"),Zf=os("animationstart"),Db=os("transitionrun"),Ub=os("transitionstart"),$b=os("transitioncancel"),em=os("transitionend"),tm=new Map,vc="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");vc.push("scrollEnd");function Mn(t,i){tm.set(t,i),is(i,[t])}var tr=typeof reportError=="function"?reportError:function(t){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var i=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof t=="object"&&t!==null&&typeof t.message=="string"?String(t.message):String(t),error:t});if(!window.dispatchEvent(i))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",t);return}console.error(t)},hn=[],Fs=0,xc=0;function nr(){for(var t=Fs,i=xc=Fs=0;i<t;){var r=hn[i];hn[i++]=null;var c=hn[i];hn[i++]=null;var d=hn[i];hn[i++]=null;var m=hn[i];if(hn[i++]=null,c!==null&&d!==null){var x=c.pending;x===null?d.next=d:(d.next=x.next,x.next=d),c.pending=d}m!==0&&nm(r,d,m)}}function ir(t,i,r,c){hn[Fs++]=t,hn[Fs++]=i,hn[Fs++]=r,hn[Fs++]=c,xc|=c,t.lanes|=c,t=t.alternate,t!==null&&(t.lanes|=c)}function Ac(t,i,r,c){return ir(t,i,r,c),sr(t)}function rs(t,i){return ir(t,null,null,i),sr(t)}function nm(t,i,r){t.lanes|=r;var c=t.alternate;c!==null&&(c.lanes|=r);for(var d=!1,m=t.return;m!==null;)m.childLanes|=r,c=m.alternate,c!==null&&(c.childLanes|=r),m.tag===22&&(t=m.stateNode,t===null||t._visibility&1||(d=!0)),t=m,m=m.return;return t.tag===3?(m=t.stateNode,d&&i!==null&&(d=31-pt(r),t=m.hiddenUpdates,c=t[d],c===null?t[d]=[i]:c.push(i),i.lane=r|536870912),m):null}function sr(t){if(50<fo)throw fo=0,ku=null,Error(o(185));for(var i=t.return;i!==null;)t=i,i=t.return;return t.tag===3?t.stateNode:null}var Ws={};function qb(t,i,r,c){this.tag=t,this.key=r,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=i,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=c,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function on(t,i,r,c){return new qb(t,i,r,c)}function Tc(t){return t=t.prototype,!(!t||!t.isReactComponent)}function Xn(t,i){var r=t.alternate;return r===null?(r=on(t.tag,i,t.key,t.mode),r.elementType=t.elementType,r.type=t.type,r.stateNode=t.stateNode,r.alternate=t,t.alternate=r):(r.pendingProps=i,r.type=t.type,r.flags=0,r.subtreeFlags=0,r.deletions=null),r.flags=t.flags&65011712,r.childLanes=t.childLanes,r.lanes=t.lanes,r.child=t.child,r.memoizedProps=t.memoizedProps,r.memoizedState=t.memoizedState,r.updateQueue=t.updateQueue,i=t.dependencies,r.dependencies=i===null?null:{lanes:i.lanes,firstContext:i.firstContext},r.sibling=t.sibling,r.index=t.index,r.ref=t.ref,r.refCleanup=t.refCleanup,r}function im(t,i){t.flags&=65011714;var r=t.alternate;return r===null?(t.childLanes=0,t.lanes=i,t.child=null,t.subtreeFlags=0,t.memoizedProps=null,t.memoizedState=null,t.updateQueue=null,t.dependencies=null,t.stateNode=null):(t.childLanes=r.childLanes,t.lanes=r.lanes,t.child=r.child,t.subtreeFlags=0,t.deletions=null,t.memoizedProps=r.memoizedProps,t.memoizedState=r.memoizedState,t.updateQueue=r.updateQueue,t.type=r.type,i=r.dependencies,t.dependencies=i===null?null:{lanes:i.lanes,firstContext:i.firstContext}),t}function ar(t,i,r,c,d,m){var x=0;if(c=t,typeof t=="function")Tc(t)&&(x=1);else if(typeof t=="string")x=FS(t,r,ae.current)?26:t==="html"||t==="head"||t==="body"?27:5;else e:switch(t){case j:return t=on(31,r,i,d),t.elementType=j,t.lanes=m,t;case A:return ls(r.children,d,m,i);case _:x=8,d|=24;break;case E:return t=on(12,r,i,d|2),t.elementType=E,t.lanes=m,t;case I:return t=on(13,r,i,d),t.elementType=I,t.lanes=m,t;case k:return t=on(19,r,i,d),t.elementType=k,t.lanes=m,t;default:if(typeof t=="object"&&t!==null)switch(t.$$typeof){case M:x=10;break e;case w:x=9;break e;case C:x=11;break e;case R:x=14;break e;case $:x=16,c=null;break e}x=29,r=Error(o(130,t===null?"null":typeof t,"")),c=null}return i=on(x,r,i,d),i.elementType=t,i.type=c,i.lanes=m,i}function ls(t,i,r,c){return t=on(7,t,c,i),t.lanes=r,t}function Ec(t,i,r){return t=on(6,t,null,i),t.lanes=r,t}function sm(t){var i=on(18,null,null,0);return i.stateNode=t,i}function _c(t,i,r){return i=on(4,t.children!==null?t.children:[],t.key,i),i.lanes=r,i.stateNode={containerInfo:t.containerInfo,pendingChildren:null,implementation:t.implementation},i}var am=new WeakMap;function yn(t,i){if(typeof t=="object"&&t!==null){var r=am.get(t);return r!==void 0?r:(i={value:t,source:i,stack:_n(i)},am.set(t,i),i)}return{value:t,source:i,stack:_n(i)}}var Gs=[],Xs=0,or=null,Va=0,gn=[],bn=0,Si=null,Dn=1,Un="";function Jn(t,i){Gs[Xs++]=Va,Gs[Xs++]=or,or=t,Va=i}function om(t,i,r){gn[bn++]=Dn,gn[bn++]=Un,gn[bn++]=Si,Si=t;var c=Dn;t=Un;var d=32-pt(c)-1;c&=~(1<<d),r+=1;var m=32-pt(i)+d;if(30<m){var x=d-d%5;m=(c&(1<<x)-1).toString(32),c>>=x,d-=x,Dn=1<<32-pt(i)+d|r<<d|c,Un=m+t}else Dn=1<<m|r<<d|c,Un=t}function wc(t){t.return!==null&&(Jn(t,1),om(t,1,0))}function Mc(t){for(;t===or;)or=Gs[--Xs],Gs[Xs]=null,Va=Gs[--Xs],Gs[Xs]=null;for(;t===Si;)Si=gn[--bn],gn[bn]=null,Un=gn[--bn],gn[bn]=null,Dn=gn[--bn],gn[bn]=null}function rm(t,i){gn[bn++]=Dn,gn[bn++]=Un,gn[bn++]=Si,Dn=i.id,Un=i.overflow,Si=t}var jt=null,Je=null,He=!1,vi=null,Sn=!1,Cc=Error(o(519));function xi(t){var i=Error(o(418,1<arguments.length&&arguments[1]!==void 0&&arguments[1]?"text":"HTML",""));throw Ya(yn(i,t)),Cc}function lm(t){var i=t.stateNode,r=t.type,c=t.memoizedProps;switch(i[Pt]=t,i[Xt]=c,r){case"dialog":Re("cancel",i),Re("close",i);break;case"iframe":case"object":case"embed":Re("load",i);break;case"video":case"audio":for(r=0;r<po.length;r++)Re(po[r],i);break;case"source":Re("error",i);break;case"img":case"image":case"link":Re("error",i),Re("load",i);break;case"details":Re("toggle",i);break;case"input":Re("invalid",i),xf(i,c.value,c.defaultValue,c.checked,c.defaultChecked,c.type,c.name,!0);break;case"select":Re("invalid",i);break;case"textarea":Re("invalid",i),Tf(i,c.value,c.defaultValue,c.children)}r=c.children,typeof r!="string"&&typeof r!="number"&&typeof r!="bigint"||i.textContent===""+r||c.suppressHydrationWarning===!0||_h(i.textContent,r)?(c.popover!=null&&(Re("beforetoggle",i),Re("toggle",i)),c.onScroll!=null&&Re("scroll",i),c.onScrollEnd!=null&&Re("scrollend",i),c.onClick!=null&&(i.onclick=Wn),i=!0):i=!1,i||xi(t,!0)}function cm(t){for(jt=t.return;jt;)switch(jt.tag){case 5:case 31:case 13:Sn=!1;return;case 27:case 3:Sn=!0;return;default:jt=jt.return}}function Js(t){if(t!==jt)return!1;if(!He)return cm(t),He=!0,!1;var i=t.tag,r;if((r=i!==3&&i!==27)&&((r=i===5)&&(r=t.type,r=!(r!=="form"&&r!=="button")||Ku(t.type,t.memoizedProps)),r=!r),r&&Je&&xi(t),cm(t),i===13){if(t=t.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(o(317));Je=Lh(t)}else if(i===31){if(t=t.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(o(317));Je=Lh(t)}else i===27?(i=Je,Bi(t.type)?(t=Ju,Ju=null,Je=t):Je=i):Je=jt?xn(t.stateNode.nextSibling):null;return!0}function cs(){Je=jt=null,He=!1}function Oc(){var t=vi;return t!==null&&(tn===null?tn=t:tn.push.apply(tn,t),vi=null),t}function Ya(t){vi===null?vi=[t]:vi.push(t)}var Nc=B(null),us=null,Qn=null;function Ai(t,i,r){G(Nc,i._currentValue),i._currentValue=r}function Zn(t){t._currentValue=Nc.current,W(Nc)}function kc(t,i,r){for(;t!==null;){var c=t.alternate;if((t.childLanes&i)!==i?(t.childLanes|=i,c!==null&&(c.childLanes|=i)):c!==null&&(c.childLanes&i)!==i&&(c.childLanes|=i),t===r)break;t=t.return}}function Rc(t,i,r,c){var d=t.child;for(d!==null&&(d.return=t);d!==null;){var m=d.dependencies;if(m!==null){var x=d.child;m=m.firstContext;e:for(;m!==null;){var O=m;m=d;for(var L=0;L<i.length;L++)if(O.context===i[L]){m.lanes|=r,O=m.alternate,O!==null&&(O.lanes|=r),kc(m.return,r,t),c||(x=null);break e}m=O.next}}else if(d.tag===18){if(x=d.return,x===null)throw Error(o(341));x.lanes|=r,m=x.alternate,m!==null&&(m.lanes|=r),kc(x,r,t),x=null}else x=d.child;if(x!==null)x.return=d;else for(x=d;x!==null;){if(x===t){x=null;break}if(d=x.sibling,d!==null){d.return=x.return,x=d;break}x=x.return}d=x}}function Qs(t,i,r,c){t=null;for(var d=i,m=!1;d!==null;){if(!m){if((d.flags&524288)!==0)m=!0;else if((d.flags&262144)!==0)break}if(d.tag===10){var x=d.alternate;if(x===null)throw Error(o(387));if(x=x.memoizedProps,x!==null){var O=d.type;an(d.pendingProps.value,x.value)||(t!==null?t.push(O):t=[O])}}else if(d===be.current){if(x=d.alternate,x===null)throw Error(o(387));x.memoizedState.memoizedState!==d.memoizedState.memoizedState&&(t!==null?t.push(So):t=[So])}d=d.return}t!==null&&Rc(i,t,r,c),i.flags|=262144}function rr(t){for(t=t.firstContext;t!==null;){if(!an(t.context._currentValue,t.memoizedValue))return!0;t=t.next}return!1}function ds(t){us=t,Qn=null,t=t.dependencies,t!==null&&(t.firstContext=null)}function Dt(t){return um(us,t)}function lr(t,i){return us===null&&ds(t),um(t,i)}function um(t,i){var r=i._currentValue;if(i={context:i,memoizedValue:r,next:null},Qn===null){if(t===null)throw Error(o(308));Qn=i,t.dependencies={lanes:0,firstContext:i},t.flags|=524288}else Qn=Qn.next=i;return r}var zb=typeof AbortController<"u"?AbortController:function(){var t=[],i=this.signal={aborted:!1,addEventListener:function(r,c){t.push(c)}};this.abort=function(){i.aborted=!0,t.forEach(function(r){return r()})}},Vb=e.unstable_scheduleCallback,Yb=e.unstable_NormalPriority,St={$$typeof:M,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function Ic(){return{controller:new zb,data:new Map,refCount:0}}function Ka(t){t.refCount--,t.refCount===0&&Vb(Yb,function(){t.controller.abort()})}var Fa=null,Lc=0,Zs=0,ea=null;function Kb(t,i){if(Fa===null){var r=Fa=[];Lc=0,Zs=Pu(),ea={status:"pending",value:void 0,then:function(c){r.push(c)}}}return Lc++,i.then(dm,dm),i}function dm(){if(--Lc===0&&Fa!==null){ea!==null&&(ea.status="fulfilled");var t=Fa;Fa=null,Zs=0,ea=null;for(var i=0;i<t.length;i++)(0,t[i])()}}function Fb(t,i){var r=[],c={status:"pending",value:null,reason:null,then:function(d){r.push(d)}};return t.then(function(){c.status="fulfilled",c.value=i;for(var d=0;d<r.length;d++)(0,r[d])(i)},function(d){for(c.status="rejected",c.reason=d,d=0;d<r.length;d++)(0,r[d])(void 0)}),c}var fm=H.S;H.S=function(t,i){Gp=It(),typeof i=="object"&&i!==null&&typeof i.then=="function"&&Kb(t,i),fm!==null&&fm(t,i)};var fs=B(null);function Bc(){var t=fs.current;return t!==null?t:Ge.pooledCache}function cr(t,i){i===null?G(fs,fs.current):G(fs,i.pool)}function mm(){var t=Bc();return t===null?null:{parent:St._currentValue,pool:t}}var ta=Error(o(460)),Hc=Error(o(474)),ur=Error(o(542)),dr={then:function(){}};function pm(t){return t=t.status,t==="fulfilled"||t==="rejected"}function hm(t,i,r){switch(r=t[r],r===void 0?t.push(i):r!==i&&(i.then(Wn,Wn),i=r),i.status){case"fulfilled":return i.value;case"rejected":throw t=i.reason,gm(t),t;default:if(typeof i.status=="string")i.then(Wn,Wn);else{if(t=Ge,t!==null&&100<t.shellSuspendCounter)throw Error(o(482));t=i,t.status="pending",t.then(function(c){if(i.status==="pending"){var d=i;d.status="fulfilled",d.value=c}},function(c){if(i.status==="pending"){var d=i;d.status="rejected",d.reason=c}})}switch(i.status){case"fulfilled":return i.value;case"rejected":throw t=i.reason,gm(t),t}throw ps=i,ta}}function ms(t){try{var i=t._init;return i(t._payload)}catch(r){throw r!==null&&typeof r=="object"&&typeof r.then=="function"?(ps=r,ta):r}}var ps=null;function ym(){if(ps===null)throw Error(o(459));var t=ps;return ps=null,t}function gm(t){if(t===ta||t===ur)throw Error(o(483))}var na=null,Wa=0;function fr(t){var i=Wa;return Wa+=1,na===null&&(na=[]),hm(na,t,i)}function Ga(t,i){i=i.props.ref,t.ref=i!==void 0?i:null}function mr(t,i){throw i.$$typeof===S?Error(o(525)):(t=Object.prototype.toString.call(i),Error(o(31,t==="[object Object]"?"object with keys {"+Object.keys(i).join(", ")+"}":t)))}function bm(t){function i(U,P){if(t){var V=U.deletions;V===null?(U.deletions=[P],U.flags|=16):V.push(P)}}function r(U,P){if(!t)return null;for(;P!==null;)i(U,P),P=P.sibling;return null}function c(U){for(var P=new Map;U!==null;)U.key!==null?P.set(U.key,U):P.set(U.index,U),U=U.sibling;return P}function d(U,P){return U=Xn(U,P),U.index=0,U.sibling=null,U}function m(U,P,V){return U.index=V,t?(V=U.alternate,V!==null?(V=V.index,V<P?(U.flags|=67108866,P):V):(U.flags|=67108866,P)):(U.flags|=1048576,P)}function x(U){return t&&U.alternate===null&&(U.flags|=67108866),U}function O(U,P,V,ne){return P===null||P.tag!==6?(P=Ec(V,U.mode,ne),P.return=U,P):(P=d(P,V),P.return=U,P)}function L(U,P,V,ne){var Se=V.type;return Se===A?te(U,P,V.props.children,ne,V.key):P!==null&&(P.elementType===Se||typeof Se=="object"&&Se!==null&&Se.$$typeof===$&&ms(Se)===P.type)?(P=d(P,V.props),Ga(P,V),P.return=U,P):(P=ar(V.type,V.key,V.props,null,U.mode,ne),Ga(P,V),P.return=U,P)}function Y(U,P,V,ne){return P===null||P.tag!==4||P.stateNode.containerInfo!==V.containerInfo||P.stateNode.implementation!==V.implementation?(P=_c(V,U.mode,ne),P.return=U,P):(P=d(P,V.children||[]),P.return=U,P)}function te(U,P,V,ne,Se){return P===null||P.tag!==7?(P=ls(V,U.mode,ne,Se),P.return=U,P):(P=d(P,V),P.return=U,P)}function ie(U,P,V){if(typeof P=="string"&&P!==""||typeof P=="number"||typeof P=="bigint")return P=Ec(""+P,U.mode,V),P.return=U,P;if(typeof P=="object"&&P!==null){switch(P.$$typeof){case T:return V=ar(P.type,P.key,P.props,null,U.mode,V),Ga(V,P),V.return=U,V;case v:return P=_c(P,U.mode,V),P.return=U,P;case $:return P=ms(P),ie(U,P,V)}if(F(P)||se(P))return P=ls(P,U.mode,V,null),P.return=U,P;if(typeof P.then=="function")return ie(U,fr(P),V);if(P.$$typeof===M)return ie(U,lr(U,P),V);mr(U,P)}return null}function K(U,P,V,ne){var Se=P!==null?P.key:null;if(typeof V=="string"&&V!==""||typeof V=="number"||typeof V=="bigint")return Se!==null?null:O(U,P,""+V,ne);if(typeof V=="object"&&V!==null){switch(V.$$typeof){case T:return V.key===Se?L(U,P,V,ne):null;case v:return V.key===Se?Y(U,P,V,ne):null;case $:return V=ms(V),K(U,P,V,ne)}if(F(V)||se(V))return Se!==null?null:te(U,P,V,ne,null);if(typeof V.then=="function")return K(U,P,fr(V),ne);if(V.$$typeof===M)return K(U,P,lr(U,V),ne);mr(U,V)}return null}function J(U,P,V,ne,Se){if(typeof ne=="string"&&ne!==""||typeof ne=="number"||typeof ne=="bigint")return U=U.get(V)||null,O(P,U,""+ne,Se);if(typeof ne=="object"&&ne!==null){switch(ne.$$typeof){case T:return U=U.get(ne.key===null?V:ne.key)||null,L(P,U,ne,Se);case v:return U=U.get(ne.key===null?V:ne.key)||null,Y(P,U,ne,Se);case $:return ne=ms(ne),J(U,P,V,ne,Se)}if(F(ne)||se(ne))return U=U.get(V)||null,te(P,U,ne,Se,null);if(typeof ne.then=="function")return J(U,P,V,fr(ne),Se);if(ne.$$typeof===M)return J(U,P,V,lr(P,ne),Se);mr(P,ne)}return null}function me(U,P,V,ne){for(var Se=null,Pe=null,ge=P,Ce=P=0,Be=null;ge!==null&&Ce<V.length;Ce++){ge.index>Ce?(Be=ge,ge=null):Be=ge.sibling;var je=K(U,ge,V[Ce],ne);if(je===null){ge===null&&(ge=Be);break}t&&ge&&je.alternate===null&&i(U,ge),P=m(je,P,Ce),Pe===null?Se=je:Pe.sibling=je,Pe=je,ge=Be}if(Ce===V.length)return r(U,ge),He&&Jn(U,Ce),Se;if(ge===null){for(;Ce<V.length;Ce++)ge=ie(U,V[Ce],ne),ge!==null&&(P=m(ge,P,Ce),Pe===null?Se=ge:Pe.sibling=ge,Pe=ge);return He&&Jn(U,Ce),Se}for(ge=c(ge);Ce<V.length;Ce++)Be=J(ge,U,Ce,V[Ce],ne),Be!==null&&(t&&Be.alternate!==null&&ge.delete(Be.key===null?Ce:Be.key),P=m(Be,P,Ce),Pe===null?Se=Be:Pe.sibling=Be,Pe=Be);return t&&ge.forEach(function(Ui){return i(U,Ui)}),He&&Jn(U,Ce),Se}function ve(U,P,V,ne){if(V==null)throw Error(o(151));for(var Se=null,Pe=null,ge=P,Ce=P=0,Be=null,je=V.next();ge!==null&&!je.done;Ce++,je=V.next()){ge.index>Ce?(Be=ge,ge=null):Be=ge.sibling;var Ui=K(U,ge,je.value,ne);if(Ui===null){ge===null&&(ge=Be);break}t&&ge&&Ui.alternate===null&&i(U,ge),P=m(Ui,P,Ce),Pe===null?Se=Ui:Pe.sibling=Ui,Pe=Ui,ge=Be}if(je.done)return r(U,ge),He&&Jn(U,Ce),Se;if(ge===null){for(;!je.done;Ce++,je=V.next())je=ie(U,je.value,ne),je!==null&&(P=m(je,P,Ce),Pe===null?Se=je:Pe.sibling=je,Pe=je);return He&&Jn(U,Ce),Se}for(ge=c(ge);!je.done;Ce++,je=V.next())je=J(ge,U,Ce,je.value,ne),je!==null&&(t&&je.alternate!==null&&ge.delete(je.key===null?Ce:je.key),P=m(je,P,Ce),Pe===null?Se=je:Pe.sibling=je,Pe=je);return t&&ge.forEach(function(sv){return i(U,sv)}),He&&Jn(U,Ce),Se}function We(U,P,V,ne){if(typeof V=="object"&&V!==null&&V.type===A&&V.key===null&&(V=V.props.children),typeof V=="object"&&V!==null){switch(V.$$typeof){case T:e:{for(var Se=V.key;P!==null;){if(P.key===Se){if(Se=V.type,Se===A){if(P.tag===7){r(U,P.sibling),ne=d(P,V.props.children),ne.return=U,U=ne;break e}}else if(P.elementType===Se||typeof Se=="object"&&Se!==null&&Se.$$typeof===$&&ms(Se)===P.type){r(U,P.sibling),ne=d(P,V.props),Ga(ne,V),ne.return=U,U=ne;break e}r(U,P);break}else i(U,P);P=P.sibling}V.type===A?(ne=ls(V.props.children,U.mode,ne,V.key),ne.return=U,U=ne):(ne=ar(V.type,V.key,V.props,null,U.mode,ne),Ga(ne,V),ne.return=U,U=ne)}return x(U);case v:e:{for(Se=V.key;P!==null;){if(P.key===Se)if(P.tag===4&&P.stateNode.containerInfo===V.containerInfo&&P.stateNode.implementation===V.implementation){r(U,P.sibling),ne=d(P,V.children||[]),ne.return=U,U=ne;break e}else{r(U,P);break}else i(U,P);P=P.sibling}ne=_c(V,U.mode,ne),ne.return=U,U=ne}return x(U);case $:return V=ms(V),We(U,P,V,ne)}if(F(V))return me(U,P,V,ne);if(se(V)){if(Se=se(V),typeof Se!="function")throw Error(o(150));return V=Se.call(V),ve(U,P,V,ne)}if(typeof V.then=="function")return We(U,P,fr(V),ne);if(V.$$typeof===M)return We(U,P,lr(U,V),ne);mr(U,V)}return typeof V=="string"&&V!==""||typeof V=="number"||typeof V=="bigint"?(V=""+V,P!==null&&P.tag===6?(r(U,P.sibling),ne=d(P,V),ne.return=U,U=ne):(r(U,P),ne=Ec(V,U.mode,ne),ne.return=U,U=ne),x(U)):r(U,P)}return function(U,P,V,ne){try{Wa=0;var Se=We(U,P,V,ne);return na=null,Se}catch(ge){if(ge===ta||ge===ur)throw ge;var Pe=on(29,ge,null,U.mode);return Pe.lanes=ne,Pe.return=U,Pe}}}var hs=bm(!0),Sm=bm(!1),Ti=!1;function Pc(t){t.updateQueue={baseState:t.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function jc(t,i){t=t.updateQueue,i.updateQueue===t&&(i.updateQueue={baseState:t.baseState,firstBaseUpdate:t.firstBaseUpdate,lastBaseUpdate:t.lastBaseUpdate,shared:t.shared,callbacks:null})}function Ei(t){return{lane:t,tag:0,payload:null,callback:null,next:null}}function _i(t,i,r){var c=t.updateQueue;if(c===null)return null;if(c=c.shared,(De&2)!==0){var d=c.pending;return d===null?i.next=i:(i.next=d.next,d.next=i),c.pending=i,i=sr(t),nm(t,null,r),i}return ir(t,c,i,r),sr(t)}function Xa(t,i,r){if(i=i.updateQueue,i!==null&&(i=i.shared,(r&4194048)!==0)){var c=i.lanes;c&=t.pendingLanes,r|=c,i.lanes=r,wn(t,r)}}function Dc(t,i){var r=t.updateQueue,c=t.alternate;if(c!==null&&(c=c.updateQueue,r===c)){var d=null,m=null;if(r=r.firstBaseUpdate,r!==null){do{var x={lane:r.lane,tag:r.tag,payload:r.payload,callback:null,next:null};m===null?d=m=x:m=m.next=x,r=r.next}while(r!==null);m===null?d=m=i:m=m.next=i}else d=m=i;r={baseState:c.baseState,firstBaseUpdate:d,lastBaseUpdate:m,shared:c.shared,callbacks:c.callbacks},t.updateQueue=r;return}t=r.lastBaseUpdate,t===null?r.firstBaseUpdate=i:t.next=i,r.lastBaseUpdate=i}var Uc=!1;function Ja(){if(Uc){var t=ea;if(t!==null)throw t}}function Qa(t,i,r,c){Uc=!1;var d=t.updateQueue;Ti=!1;var m=d.firstBaseUpdate,x=d.lastBaseUpdate,O=d.shared.pending;if(O!==null){d.shared.pending=null;var L=O,Y=L.next;L.next=null,x===null?m=Y:x.next=Y,x=L;var te=t.alternate;te!==null&&(te=te.updateQueue,O=te.lastBaseUpdate,O!==x&&(O===null?te.firstBaseUpdate=Y:O.next=Y,te.lastBaseUpdate=L))}if(m!==null){var ie=d.baseState;x=0,te=Y=L=null,O=m;do{var K=O.lane&-536870913,J=K!==O.lane;if(J?(Le&K)===K:(c&K)===K){K!==0&&K===Zs&&(Uc=!0),te!==null&&(te=te.next={lane:0,tag:O.tag,payload:O.payload,callback:null,next:null});e:{var me=t,ve=O;K=i;var We=r;switch(ve.tag){case 1:if(me=ve.payload,typeof me=="function"){ie=me.call(We,ie,K);break e}ie=me;break e;case 3:me.flags=me.flags&-65537|128;case 0:if(me=ve.payload,K=typeof me=="function"?me.call(We,ie,K):me,K==null)break e;ie=b({},ie,K);break e;case 2:Ti=!0}}K=O.callback,K!==null&&(t.flags|=64,J&&(t.flags|=8192),J=d.callbacks,J===null?d.callbacks=[K]:J.push(K))}else J={lane:K,tag:O.tag,payload:O.payload,callback:O.callback,next:null},te===null?(Y=te=J,L=ie):te=te.next=J,x|=K;if(O=O.next,O===null){if(O=d.shared.pending,O===null)break;J=O,O=J.next,J.next=null,d.lastBaseUpdate=J,d.shared.pending=null}}while(!0);te===null&&(L=ie),d.baseState=L,d.firstBaseUpdate=Y,d.lastBaseUpdate=te,m===null&&(d.shared.lanes=0),Ni|=x,t.lanes=x,t.memoizedState=ie}}function vm(t,i){if(typeof t!="function")throw Error(o(191,t));t.call(i)}function xm(t,i){var r=t.callbacks;if(r!==null)for(t.callbacks=null,t=0;t<r.length;t++)vm(r[t],i)}var ia=B(null),pr=B(0);function Am(t,i){t=li,G(pr,t),G(ia,i),li=t|i.baseLanes}function $c(){G(pr,li),G(ia,ia.current)}function qc(){li=pr.current,W(ia),W(pr)}var rn=B(null),vn=null;function wi(t){var i=t.alternate;G(yt,yt.current&1),G(rn,t),vn===null&&(i===null||ia.current!==null||i.memoizedState!==null)&&(vn=t)}function zc(t){G(yt,yt.current),G(rn,t),vn===null&&(vn=t)}function Tm(t){t.tag===22?(G(yt,yt.current),G(rn,t),vn===null&&(vn=t)):Mi()}function Mi(){G(yt,yt.current),G(rn,rn.current)}function ln(t){W(rn),vn===t&&(vn=null),W(yt)}var yt=B(0);function hr(t){for(var i=t;i!==null;){if(i.tag===13){var r=i.memoizedState;if(r!==null&&(r=r.dehydrated,r===null||Gu(r)||Xu(r)))return i}else if(i.tag===19&&(i.memoizedProps.revealOrder==="forwards"||i.memoizedProps.revealOrder==="backwards"||i.memoizedProps.revealOrder==="unstable_legacy-backwards"||i.memoizedProps.revealOrder==="together")){if((i.flags&128)!==0)return i}else if(i.child!==null){i.child.return=i,i=i.child;continue}if(i===t)break;for(;i.sibling===null;){if(i.return===null||i.return===t)return null;i=i.return}i.sibling.return=i.return,i=i.sibling}return null}var ei=0,we=null,Ke=null,vt=null,yr=!1,sa=!1,ys=!1,gr=0,Za=0,aa=null,Wb=0;function ut(){throw Error(o(321))}function Vc(t,i){if(i===null)return!1;for(var r=0;r<i.length&&r<t.length;r++)if(!an(t[r],i[r]))return!1;return!0}function Yc(t,i,r,c,d,m){return ei=m,we=i,i.memoizedState=null,i.updateQueue=null,i.lanes=0,H.H=t===null||t.memoizedState===null?op:ou,ys=!1,m=r(c,d),ys=!1,sa&&(m=_m(i,r,c,d)),Em(t),m}function Em(t){H.H=no;var i=Ke!==null&&Ke.next!==null;if(ei=0,vt=Ke=we=null,yr=!1,Za=0,aa=null,i)throw Error(o(300));t===null||xt||(t=t.dependencies,t!==null&&rr(t)&&(xt=!0))}function _m(t,i,r,c){we=t;var d=0;do{if(sa&&(aa=null),Za=0,sa=!1,25<=d)throw Error(o(301));if(d+=1,vt=Ke=null,t.updateQueue!=null){var m=t.updateQueue;m.lastEffect=null,m.events=null,m.stores=null,m.memoCache!=null&&(m.memoCache.index=0)}H.H=rp,m=i(r,c)}while(sa);return m}function Gb(){var t=H.H,i=t.useState()[0];return i=typeof i.then=="function"?eo(i):i,t=t.useState()[0],(Ke!==null?Ke.memoizedState:null)!==t&&(we.flags|=1024),i}function Kc(){var t=gr!==0;return gr=0,t}function Fc(t,i,r){i.updateQueue=t.updateQueue,i.flags&=-2053,t.lanes&=~r}function Wc(t){if(yr){for(t=t.memoizedState;t!==null;){var i=t.queue;i!==null&&(i.pending=null),t=t.next}yr=!1}ei=0,vt=Ke=we=null,sa=!1,Za=gr=0,aa=null}function Kt(){var t={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return vt===null?we.memoizedState=vt=t:vt=vt.next=t,vt}function gt(){if(Ke===null){var t=we.alternate;t=t!==null?t.memoizedState:null}else t=Ke.next;var i=vt===null?we.memoizedState:vt.next;if(i!==null)vt=i,Ke=t;else{if(t===null)throw we.alternate===null?Error(o(467)):Error(o(310));Ke=t,t={memoizedState:Ke.memoizedState,baseState:Ke.baseState,baseQueue:Ke.baseQueue,queue:Ke.queue,next:null},vt===null?we.memoizedState=vt=t:vt=vt.next=t}return vt}function br(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function eo(t){var i=Za;return Za+=1,aa===null&&(aa=[]),t=hm(aa,t,i),i=we,(vt===null?i.memoizedState:vt.next)===null&&(i=i.alternate,H.H=i===null||i.memoizedState===null?op:ou),t}function Sr(t){if(t!==null&&typeof t=="object"){if(typeof t.then=="function")return eo(t);if(t.$$typeof===M)return Dt(t)}throw Error(o(438,String(t)))}function Gc(t){var i=null,r=we.updateQueue;if(r!==null&&(i=r.memoCache),i==null){var c=we.alternate;c!==null&&(c=c.updateQueue,c!==null&&(c=c.memoCache,c!=null&&(i={data:c.data.map(function(d){return d.slice()}),index:0})))}if(i==null&&(i={data:[],index:0}),r===null&&(r=br(),we.updateQueue=r),r.memoCache=i,r=i.data[i.index],r===void 0)for(r=i.data[i.index]=Array(t),c=0;c<t;c++)r[c]=D;return i.index++,r}function ti(t,i){return typeof i=="function"?i(t):i}function vr(t){var i=gt();return Xc(i,Ke,t)}function Xc(t,i,r){var c=t.queue;if(c===null)throw Error(o(311));c.lastRenderedReducer=r;var d=t.baseQueue,m=c.pending;if(m!==null){if(d!==null){var x=d.next;d.next=m.next,m.next=x}i.baseQueue=d=m,c.pending=null}if(m=t.baseState,d===null)t.memoizedState=m;else{i=d.next;var O=x=null,L=null,Y=i,te=!1;do{var ie=Y.lane&-536870913;if(ie!==Y.lane?(Le&ie)===ie:(ei&ie)===ie){var K=Y.revertLane;if(K===0)L!==null&&(L=L.next={lane:0,revertLane:0,gesture:null,action:Y.action,hasEagerState:Y.hasEagerState,eagerState:Y.eagerState,next:null}),ie===Zs&&(te=!0);else if((ei&K)===K){Y=Y.next,K===Zs&&(te=!0);continue}else ie={lane:0,revertLane:Y.revertLane,gesture:null,action:Y.action,hasEagerState:Y.hasEagerState,eagerState:Y.eagerState,next:null},L===null?(O=L=ie,x=m):L=L.next=ie,we.lanes|=K,Ni|=K;ie=Y.action,ys&&r(m,ie),m=Y.hasEagerState?Y.eagerState:r(m,ie)}else K={lane:ie,revertLane:Y.revertLane,gesture:Y.gesture,action:Y.action,hasEagerState:Y.hasEagerState,eagerState:Y.eagerState,next:null},L===null?(O=L=K,x=m):L=L.next=K,we.lanes|=ie,Ni|=ie;Y=Y.next}while(Y!==null&&Y!==i);if(L===null?x=m:L.next=O,!an(m,t.memoizedState)&&(xt=!0,te&&(r=ea,r!==null)))throw r;t.memoizedState=m,t.baseState=x,t.baseQueue=L,c.lastRenderedState=m}return d===null&&(c.lanes=0),[t.memoizedState,c.dispatch]}function Jc(t){var i=gt(),r=i.queue;if(r===null)throw Error(o(311));r.lastRenderedReducer=t;var c=r.dispatch,d=r.pending,m=i.memoizedState;if(d!==null){r.pending=null;var x=d=d.next;do m=t(m,x.action),x=x.next;while(x!==d);an(m,i.memoizedState)||(xt=!0),i.memoizedState=m,i.baseQueue===null&&(i.baseState=m),r.lastRenderedState=m}return[m,c]}function wm(t,i,r){var c=we,d=gt(),m=He;if(m){if(r===void 0)throw Error(o(407));r=r()}else r=i();var x=!an((Ke||d).memoizedState,r);if(x&&(d.memoizedState=r,xt=!0),d=d.queue,eu(Om.bind(null,c,d,t),[t]),d.getSnapshot!==i||x||vt!==null&&vt.memoizedState.tag&1){if(c.flags|=2048,oa(9,{destroy:void 0},Cm.bind(null,c,d,r,i),null),Ge===null)throw Error(o(349));m||(ei&127)!==0||Mm(c,i,r)}return r}function Mm(t,i,r){t.flags|=16384,t={getSnapshot:i,value:r},i=we.updateQueue,i===null?(i=br(),we.updateQueue=i,i.stores=[t]):(r=i.stores,r===null?i.stores=[t]:r.push(t))}function Cm(t,i,r,c){i.value=r,i.getSnapshot=c,Nm(i)&&km(t)}function Om(t,i,r){return r(function(){Nm(i)&&km(t)})}function Nm(t){var i=t.getSnapshot;t=t.value;try{var r=i();return!an(t,r)}catch{return!0}}function km(t){var i=rs(t,2);i!==null&&nn(i,t,2)}function Qc(t){var i=Kt();if(typeof t=="function"){var r=t;if(t=r(),ys){mt(!0);try{r()}finally{mt(!1)}}}return i.memoizedState=i.baseState=t,i.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:ti,lastRenderedState:t},i}function Rm(t,i,r,c){return t.baseState=r,Xc(t,Ke,typeof c=="function"?c:ti)}function Xb(t,i,r,c,d){if(Tr(t))throw Error(o(485));if(t=i.action,t!==null){var m={payload:d,action:t,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(x){m.listeners.push(x)}};H.T!==null?r(!0):m.isTransition=!1,c(m),r=i.pending,r===null?(m.next=i.pending=m,Im(i,m)):(m.next=r.next,i.pending=r.next=m)}}function Im(t,i){var r=i.action,c=i.payload,d=t.state;if(i.isTransition){var m=H.T,x={};H.T=x;try{var O=r(d,c),L=H.S;L!==null&&L(x,O),Lm(t,i,O)}catch(Y){Zc(t,i,Y)}finally{m!==null&&x.types!==null&&(m.types=x.types),H.T=m}}else try{m=r(d,c),Lm(t,i,m)}catch(Y){Zc(t,i,Y)}}function Lm(t,i,r){r!==null&&typeof r=="object"&&typeof r.then=="function"?r.then(function(c){Bm(t,i,c)},function(c){return Zc(t,i,c)}):Bm(t,i,r)}function Bm(t,i,r){i.status="fulfilled",i.value=r,Hm(i),t.state=r,i=t.pending,i!==null&&(r=i.next,r===i?t.pending=null:(r=r.next,i.next=r,Im(t,r)))}function Zc(t,i,r){var c=t.pending;if(t.pending=null,c!==null){c=c.next;do i.status="rejected",i.reason=r,Hm(i),i=i.next;while(i!==c)}t.action=null}function Hm(t){t=t.listeners;for(var i=0;i<t.length;i++)(0,t[i])()}function Pm(t,i){return i}function jm(t,i){if(He){var r=Ge.formState;if(r!==null){e:{var c=we;if(He){if(Je){t:{for(var d=Je,m=Sn;d.nodeType!==8;){if(!m){d=null;break t}if(d=xn(d.nextSibling),d===null){d=null;break t}}m=d.data,d=m==="F!"||m==="F"?d:null}if(d){Je=xn(d.nextSibling),c=d.data==="F!";break e}}xi(c)}c=!1}c&&(i=r[0])}}return r=Kt(),r.memoizedState=r.baseState=i,c={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Pm,lastRenderedState:i},r.queue=c,r=ip.bind(null,we,c),c.dispatch=r,c=Qc(!1),m=au.bind(null,we,!1,c.queue),c=Kt(),d={state:i,dispatch:null,action:t,pending:null},c.queue=d,r=Xb.bind(null,we,d,m,r),d.dispatch=r,c.memoizedState=t,[i,r,!1]}function Dm(t){var i=gt();return Um(i,Ke,t)}function Um(t,i,r){if(i=Xc(t,i,Pm)[0],t=vr(ti)[0],typeof i=="object"&&i!==null&&typeof i.then=="function")try{var c=eo(i)}catch(x){throw x===ta?ur:x}else c=i;i=gt();var d=i.queue,m=d.dispatch;return r!==i.memoizedState&&(we.flags|=2048,oa(9,{destroy:void 0},Jb.bind(null,d,r),null)),[c,m,t]}function Jb(t,i){t.action=i}function $m(t){var i=gt(),r=Ke;if(r!==null)return Um(i,r,t);gt(),i=i.memoizedState,r=gt();var c=r.queue.dispatch;return r.memoizedState=t,[i,c,!1]}function oa(t,i,r,c){return t={tag:t,create:r,deps:c,inst:i,next:null},i=we.updateQueue,i===null&&(i=br(),we.updateQueue=i),r=i.lastEffect,r===null?i.lastEffect=t.next=t:(c=r.next,r.next=t,t.next=c,i.lastEffect=t),t}function qm(){return gt().memoizedState}function xr(t,i,r,c){var d=Kt();we.flags|=t,d.memoizedState=oa(1|i,{destroy:void 0},r,c===void 0?null:c)}function Ar(t,i,r,c){var d=gt();c=c===void 0?null:c;var m=d.memoizedState.inst;Ke!==null&&c!==null&&Vc(c,Ke.memoizedState.deps)?d.memoizedState=oa(i,m,r,c):(we.flags|=t,d.memoizedState=oa(1|i,m,r,c))}function zm(t,i){xr(8390656,8,t,i)}function eu(t,i){Ar(2048,8,t,i)}function Qb(t){we.flags|=4;var i=we.updateQueue;if(i===null)i=br(),we.updateQueue=i,i.events=[t];else{var r=i.events;r===null?i.events=[t]:r.push(t)}}function Vm(t){var i=gt().memoizedState;return Qb({ref:i,nextImpl:t}),function(){if((De&2)!==0)throw Error(o(440));return i.impl.apply(void 0,arguments)}}function Ym(t,i){return Ar(4,2,t,i)}function Km(t,i){return Ar(4,4,t,i)}function Fm(t,i){if(typeof i=="function"){t=t();var r=i(t);return function(){typeof r=="function"?r():i(null)}}if(i!=null)return t=t(),i.current=t,function(){i.current=null}}function Wm(t,i,r){r=r!=null?r.concat([t]):null,Ar(4,4,Fm.bind(null,i,t),r)}function tu(){}function Gm(t,i){var r=gt();i=i===void 0?null:i;var c=r.memoizedState;return i!==null&&Vc(i,c[1])?c[0]:(r.memoizedState=[t,i],t)}function Xm(t,i){var r=gt();i=i===void 0?null:i;var c=r.memoizedState;if(i!==null&&Vc(i,c[1]))return c[0];if(c=t(),ys){mt(!0);try{t()}finally{mt(!1)}}return r.memoizedState=[c,i],c}function nu(t,i,r){return r===void 0||(ei&1073741824)!==0&&(Le&261930)===0?t.memoizedState=i:(t.memoizedState=r,t=Jp(),we.lanes|=t,Ni|=t,r)}function Jm(t,i,r,c){return an(r,i)?r:ia.current!==null?(t=nu(t,r,c),an(t,i)||(xt=!0),t):(ei&42)===0||(ei&1073741824)!==0&&(Le&261930)===0?(xt=!0,t.memoizedState=r):(t=Jp(),we.lanes|=t,Ni|=t,i)}function Qm(t,i,r,c,d){var m=z.p;z.p=m!==0&&8>m?m:8;var x=H.T,O={};H.T=O,au(t,!1,i,r);try{var L=d(),Y=H.S;if(Y!==null&&Y(O,L),L!==null&&typeof L=="object"&&typeof L.then=="function"){var te=Fb(L,c);to(t,i,te,dn(t))}else to(t,i,c,dn(t))}catch(ie){to(t,i,{then:function(){},status:"rejected",reason:ie},dn())}finally{z.p=m,x!==null&&O.types!==null&&(x.types=O.types),H.T=x}}function Zb(){}function iu(t,i,r,c){if(t.tag!==5)throw Error(o(476));var d=Zm(t).queue;Qm(t,d,i,Z,r===null?Zb:function(){return ep(t),r(c)})}function Zm(t){var i=t.memoizedState;if(i!==null)return i;i={memoizedState:Z,baseState:Z,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:ti,lastRenderedState:Z},next:null};var r={};return i.next={memoizedState:r,baseState:r,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:ti,lastRenderedState:r},next:null},t.memoizedState=i,t=t.alternate,t!==null&&(t.memoizedState=i),i}function ep(t){var i=Zm(t);i.next===null&&(i=t.alternate.memoizedState),to(t,i.next.queue,{},dn())}function su(){return Dt(So)}function tp(){return gt().memoizedState}function np(){return gt().memoizedState}function eS(t){for(var i=t.return;i!==null;){switch(i.tag){case 24:case 3:var r=dn();t=Ei(r);var c=_i(i,t,r);c!==null&&(nn(c,i,r),Xa(c,i,r)),i={cache:Ic()},t.payload=i;return}i=i.return}}function tS(t,i,r){var c=dn();r={lane:c,revertLane:0,gesture:null,action:r,hasEagerState:!1,eagerState:null,next:null},Tr(t)?sp(i,r):(r=Ac(t,i,r,c),r!==null&&(nn(r,t,c),ap(r,i,c)))}function ip(t,i,r){var c=dn();to(t,i,r,c)}function to(t,i,r,c){var d={lane:c,revertLane:0,gesture:null,action:r,hasEagerState:!1,eagerState:null,next:null};if(Tr(t))sp(i,d);else{var m=t.alternate;if(t.lanes===0&&(m===null||m.lanes===0)&&(m=i.lastRenderedReducer,m!==null))try{var x=i.lastRenderedState,O=m(x,r);if(d.hasEagerState=!0,d.eagerState=O,an(O,x))return ir(t,i,d,0),Ge===null&&nr(),!1}catch{}if(r=Ac(t,i,d,c),r!==null)return nn(r,t,c),ap(r,i,c),!0}return!1}function au(t,i,r,c){if(c={lane:2,revertLane:Pu(),gesture:null,action:c,hasEagerState:!1,eagerState:null,next:null},Tr(t)){if(i)throw Error(o(479))}else i=Ac(t,r,c,2),i!==null&&nn(i,t,2)}function Tr(t){var i=t.alternate;return t===we||i!==null&&i===we}function sp(t,i){sa=yr=!0;var r=t.pending;r===null?i.next=i:(i.next=r.next,r.next=i),t.pending=i}function ap(t,i,r){if((r&4194048)!==0){var c=i.lanes;c&=t.pendingLanes,r|=c,i.lanes=r,wn(t,r)}}var no={readContext:Dt,use:Sr,useCallback:ut,useContext:ut,useEffect:ut,useImperativeHandle:ut,useLayoutEffect:ut,useInsertionEffect:ut,useMemo:ut,useReducer:ut,useRef:ut,useState:ut,useDebugValue:ut,useDeferredValue:ut,useTransition:ut,useSyncExternalStore:ut,useId:ut,useHostTransitionStatus:ut,useFormState:ut,useActionState:ut,useOptimistic:ut,useMemoCache:ut,useCacheRefresh:ut};no.useEffectEvent=ut;var op={readContext:Dt,use:Sr,useCallback:function(t,i){return Kt().memoizedState=[t,i===void 0?null:i],t},useContext:Dt,useEffect:zm,useImperativeHandle:function(t,i,r){r=r!=null?r.concat([t]):null,xr(4194308,4,Fm.bind(null,i,t),r)},useLayoutEffect:function(t,i){return xr(4194308,4,t,i)},useInsertionEffect:function(t,i){xr(4,2,t,i)},useMemo:function(t,i){var r=Kt();i=i===void 0?null:i;var c=t();if(ys){mt(!0);try{t()}finally{mt(!1)}}return r.memoizedState=[c,i],c},useReducer:function(t,i,r){var c=Kt();if(r!==void 0){var d=r(i);if(ys){mt(!0);try{r(i)}finally{mt(!1)}}}else d=i;return c.memoizedState=c.baseState=d,t={pending:null,lanes:0,dispatch:null,lastRenderedReducer:t,lastRenderedState:d},c.queue=t,t=t.dispatch=tS.bind(null,we,t),[c.memoizedState,t]},useRef:function(t){var i=Kt();return t={current:t},i.memoizedState=t},useState:function(t){t=Qc(t);var i=t.queue,r=ip.bind(null,we,i);return i.dispatch=r,[t.memoizedState,r]},useDebugValue:tu,useDeferredValue:function(t,i){var r=Kt();return nu(r,t,i)},useTransition:function(){var t=Qc(!1);return t=Qm.bind(null,we,t.queue,!0,!1),Kt().memoizedState=t,[!1,t]},useSyncExternalStore:function(t,i,r){var c=we,d=Kt();if(He){if(r===void 0)throw Error(o(407));r=r()}else{if(r=i(),Ge===null)throw Error(o(349));(Le&127)!==0||Mm(c,i,r)}d.memoizedState=r;var m={value:r,getSnapshot:i};return d.queue=m,zm(Om.bind(null,c,m,t),[t]),c.flags|=2048,oa(9,{destroy:void 0},Cm.bind(null,c,m,r,i),null),r},useId:function(){var t=Kt(),i=Ge.identifierPrefix;if(He){var r=Un,c=Dn;r=(c&~(1<<32-pt(c)-1)).toString(32)+r,i="_"+i+"R_"+r,r=gr++,0<r&&(i+="H"+r.toString(32)),i+="_"}else r=Wb++,i="_"+i+"r_"+r.toString(32)+"_";return t.memoizedState=i},useHostTransitionStatus:su,useFormState:jm,useActionState:jm,useOptimistic:function(t){var i=Kt();i.memoizedState=i.baseState=t;var r={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return i.queue=r,i=au.bind(null,we,!0,r),r.dispatch=i,[t,i]},useMemoCache:Gc,useCacheRefresh:function(){return Kt().memoizedState=eS.bind(null,we)},useEffectEvent:function(t){var i=Kt(),r={impl:t};return i.memoizedState=r,function(){if((De&2)!==0)throw Error(o(440));return r.impl.apply(void 0,arguments)}}},ou={readContext:Dt,use:Sr,useCallback:Gm,useContext:Dt,useEffect:eu,useImperativeHandle:Wm,useInsertionEffect:Ym,useLayoutEffect:Km,useMemo:Xm,useReducer:vr,useRef:qm,useState:function(){return vr(ti)},useDebugValue:tu,useDeferredValue:function(t,i){var r=gt();return Jm(r,Ke.memoizedState,t,i)},useTransition:function(){var t=vr(ti)[0],i=gt().memoizedState;return[typeof t=="boolean"?t:eo(t),i]},useSyncExternalStore:wm,useId:tp,useHostTransitionStatus:su,useFormState:Dm,useActionState:Dm,useOptimistic:function(t,i){var r=gt();return Rm(r,Ke,t,i)},useMemoCache:Gc,useCacheRefresh:np};ou.useEffectEvent=Vm;var rp={readContext:Dt,use:Sr,useCallback:Gm,useContext:Dt,useEffect:eu,useImperativeHandle:Wm,useInsertionEffect:Ym,useLayoutEffect:Km,useMemo:Xm,useReducer:Jc,useRef:qm,useState:function(){return Jc(ti)},useDebugValue:tu,useDeferredValue:function(t,i){var r=gt();return Ke===null?nu(r,t,i):Jm(r,Ke.memoizedState,t,i)},useTransition:function(){var t=Jc(ti)[0],i=gt().memoizedState;return[typeof t=="boolean"?t:eo(t),i]},useSyncExternalStore:wm,useId:tp,useHostTransitionStatus:su,useFormState:$m,useActionState:$m,useOptimistic:function(t,i){var r=gt();return Ke!==null?Rm(r,Ke,t,i):(r.baseState=t,[t,r.queue.dispatch])},useMemoCache:Gc,useCacheRefresh:np};rp.useEffectEvent=Vm;function ru(t,i,r,c){i=t.memoizedState,r=r(c,i),r=r==null?i:b({},i,r),t.memoizedState=r,t.lanes===0&&(t.updateQueue.baseState=r)}var lu={enqueueSetState:function(t,i,r){t=t._reactInternals;var c=dn(),d=Ei(c);d.payload=i,r!=null&&(d.callback=r),i=_i(t,d,c),i!==null&&(nn(i,t,c),Xa(i,t,c))},enqueueReplaceState:function(t,i,r){t=t._reactInternals;var c=dn(),d=Ei(c);d.tag=1,d.payload=i,r!=null&&(d.callback=r),i=_i(t,d,c),i!==null&&(nn(i,t,c),Xa(i,t,c))},enqueueForceUpdate:function(t,i){t=t._reactInternals;var r=dn(),c=Ei(r);c.tag=2,i!=null&&(c.callback=i),i=_i(t,c,r),i!==null&&(nn(i,t,r),Xa(i,t,r))}};function lp(t,i,r,c,d,m,x){return t=t.stateNode,typeof t.shouldComponentUpdate=="function"?t.shouldComponentUpdate(c,m,x):i.prototype&&i.prototype.isPureReactComponent?!qa(r,c)||!qa(d,m):!0}function cp(t,i,r,c){t=i.state,typeof i.componentWillReceiveProps=="function"&&i.componentWillReceiveProps(r,c),typeof i.UNSAFE_componentWillReceiveProps=="function"&&i.UNSAFE_componentWillReceiveProps(r,c),i.state!==t&&lu.enqueueReplaceState(i,i.state,null)}function gs(t,i){var r=i;if("ref"in i){r={};for(var c in i)c!=="ref"&&(r[c]=i[c])}if(t=t.defaultProps){r===i&&(r=b({},r));for(var d in t)r[d]===void 0&&(r[d]=t[d])}return r}function up(t){tr(t)}function dp(t){console.error(t)}function fp(t){tr(t)}function Er(t,i){try{var r=t.onUncaughtError;r(i.value,{componentStack:i.stack})}catch(c){setTimeout(function(){throw c})}}function mp(t,i,r){try{var c=t.onCaughtError;c(r.value,{componentStack:r.stack,errorBoundary:i.tag===1?i.stateNode:null})}catch(d){setTimeout(function(){throw d})}}function cu(t,i,r){return r=Ei(r),r.tag=3,r.payload={element:null},r.callback=function(){Er(t,i)},r}function pp(t){return t=Ei(t),t.tag=3,t}function hp(t,i,r,c){var d=r.type.getDerivedStateFromError;if(typeof d=="function"){var m=c.value;t.payload=function(){return d(m)},t.callback=function(){mp(i,r,c)}}var x=r.stateNode;x!==null&&typeof x.componentDidCatch=="function"&&(t.callback=function(){mp(i,r,c),typeof d!="function"&&(ki===null?ki=new Set([this]):ki.add(this));var O=c.stack;this.componentDidCatch(c.value,{componentStack:O!==null?O:""})})}function nS(t,i,r,c,d){if(r.flags|=32768,c!==null&&typeof c=="object"&&typeof c.then=="function"){if(i=r.alternate,i!==null&&Qs(i,r,d,!0),r=rn.current,r!==null){switch(r.tag){case 31:case 13:return vn===null?Hr():r.alternate===null&&dt===0&&(dt=3),r.flags&=-257,r.flags|=65536,r.lanes=d,c===dr?r.flags|=16384:(i=r.updateQueue,i===null?r.updateQueue=new Set([c]):i.add(c),Lu(t,c,d)),!1;case 22:return r.flags|=65536,c===dr?r.flags|=16384:(i=r.updateQueue,i===null?(i={transitions:null,markerInstances:null,retryQueue:new Set([c])},r.updateQueue=i):(r=i.retryQueue,r===null?i.retryQueue=new Set([c]):r.add(c)),Lu(t,c,d)),!1}throw Error(o(435,r.tag))}return Lu(t,c,d),Hr(),!1}if(He)return i=rn.current,i!==null?((i.flags&65536)===0&&(i.flags|=256),i.flags|=65536,i.lanes=d,c!==Cc&&(t=Error(o(422),{cause:c}),Ya(yn(t,r)))):(c!==Cc&&(i=Error(o(423),{cause:c}),Ya(yn(i,r))),t=t.current.alternate,t.flags|=65536,d&=-d,t.lanes|=d,c=yn(c,r),d=cu(t.stateNode,c,d),Dc(t,d),dt!==4&&(dt=2)),!1;var m=Error(o(520),{cause:c});if(m=yn(m,r),uo===null?uo=[m]:uo.push(m),dt!==4&&(dt=2),i===null)return!0;c=yn(c,r),r=i;do{switch(r.tag){case 3:return r.flags|=65536,t=d&-d,r.lanes|=t,t=cu(r.stateNode,c,t),Dc(r,t),!1;case 1:if(i=r.type,m=r.stateNode,(r.flags&128)===0&&(typeof i.getDerivedStateFromError=="function"||m!==null&&typeof m.componentDidCatch=="function"&&(ki===null||!ki.has(m))))return r.flags|=65536,d&=-d,r.lanes|=d,d=pp(d),hp(d,t,r,c),Dc(r,d),!1}r=r.return}while(r!==null);return!1}var uu=Error(o(461)),xt=!1;function Ut(t,i,r,c){i.child=t===null?Sm(i,null,r,c):hs(i,t.child,r,c)}function yp(t,i,r,c,d){r=r.render;var m=i.ref;if("ref"in c){var x={};for(var O in c)O!=="ref"&&(x[O]=c[O])}else x=c;return ds(i),c=Yc(t,i,r,x,m,d),O=Kc(),t!==null&&!xt?(Fc(t,i,d),ni(t,i,d)):(He&&O&&wc(i),i.flags|=1,Ut(t,i,c,d),i.child)}function gp(t,i,r,c,d){if(t===null){var m=r.type;return typeof m=="function"&&!Tc(m)&&m.defaultProps===void 0&&r.compare===null?(i.tag=15,i.type=m,bp(t,i,m,c,d)):(t=ar(r.type,null,c,i,i.mode,d),t.ref=i.ref,t.return=i,i.child=t)}if(m=t.child,!bu(t,d)){var x=m.memoizedProps;if(r=r.compare,r=r!==null?r:qa,r(x,c)&&t.ref===i.ref)return ni(t,i,d)}return i.flags|=1,t=Xn(m,c),t.ref=i.ref,t.return=i,i.child=t}function bp(t,i,r,c,d){if(t!==null){var m=t.memoizedProps;if(qa(m,c)&&t.ref===i.ref)if(xt=!1,i.pendingProps=c=m,bu(t,d))(t.flags&131072)!==0&&(xt=!0);else return i.lanes=t.lanes,ni(t,i,d)}return du(t,i,r,c,d)}function Sp(t,i,r,c){var d=c.children,m=t!==null?t.memoizedState:null;if(t===null&&i.stateNode===null&&(i.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),c.mode==="hidden"){if((i.flags&128)!==0){if(m=m!==null?m.baseLanes|r:r,t!==null){for(c=i.child=t.child,d=0;c!==null;)d=d|c.lanes|c.childLanes,c=c.sibling;c=d&~m}else c=0,i.child=null;return vp(t,i,m,r,c)}if((r&536870912)!==0)i.memoizedState={baseLanes:0,cachePool:null},t!==null&&cr(i,m!==null?m.cachePool:null),m!==null?Am(i,m):$c(),Tm(i);else return c=i.lanes=536870912,vp(t,i,m!==null?m.baseLanes|r:r,r,c)}else m!==null?(cr(i,m.cachePool),Am(i,m),Mi(),i.memoizedState=null):(t!==null&&cr(i,null),$c(),Mi());return Ut(t,i,d,r),i.child}function io(t,i){return t!==null&&t.tag===22||i.stateNode!==null||(i.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),i.sibling}function vp(t,i,r,c,d){var m=Bc();return m=m===null?null:{parent:St._currentValue,pool:m},i.memoizedState={baseLanes:r,cachePool:m},t!==null&&cr(i,null),$c(),Tm(i),t!==null&&Qs(t,i,c,!0),i.childLanes=d,null}function _r(t,i){return i=Mr({mode:i.mode,children:i.children},t.mode),i.ref=t.ref,t.child=i,i.return=t,i}function xp(t,i,r){return hs(i,t.child,null,r),t=_r(i,i.pendingProps),t.flags|=2,ln(i),i.memoizedState=null,t}function iS(t,i,r){var c=i.pendingProps,d=(i.flags&128)!==0;if(i.flags&=-129,t===null){if(He){if(c.mode==="hidden")return t=_r(i,c),i.lanes=536870912,io(null,t);if(zc(i),(t=Je)?(t=Ih(t,Sn),t=t!==null&&t.data==="&"?t:null,t!==null&&(i.memoizedState={dehydrated:t,treeContext:Si!==null?{id:Dn,overflow:Un}:null,retryLane:536870912,hydrationErrors:null},r=sm(t),r.return=i,i.child=r,jt=i,Je=null)):t=null,t===null)throw xi(i);return i.lanes=536870912,null}return _r(i,c)}var m=t.memoizedState;if(m!==null){var x=m.dehydrated;if(zc(i),d)if(i.flags&256)i.flags&=-257,i=xp(t,i,r);else if(i.memoizedState!==null)i.child=t.child,i.flags|=128,i=null;else throw Error(o(558));else if(xt||Qs(t,i,r,!1),d=(r&t.childLanes)!==0,xt||d){if(c=Ge,c!==null&&(x=Is(c,r),x!==0&&x!==m.retryLane))throw m.retryLane=x,rs(t,x),nn(c,t,x),uu;Hr(),i=xp(t,i,r)}else t=m.treeContext,Je=xn(x.nextSibling),jt=i,He=!0,vi=null,Sn=!1,t!==null&&rm(i,t),i=_r(i,c),i.flags|=4096;return i}return t=Xn(t.child,{mode:c.mode,children:c.children}),t.ref=i.ref,i.child=t,t.return=i,t}function wr(t,i){var r=i.ref;if(r===null)t!==null&&t.ref!==null&&(i.flags|=4194816);else{if(typeof r!="function"&&typeof r!="object")throw Error(o(284));(t===null||t.ref!==r)&&(i.flags|=4194816)}}function du(t,i,r,c,d){return ds(i),r=Yc(t,i,r,c,void 0,d),c=Kc(),t!==null&&!xt?(Fc(t,i,d),ni(t,i,d)):(He&&c&&wc(i),i.flags|=1,Ut(t,i,r,d),i.child)}function Ap(t,i,r,c,d,m){return ds(i),i.updateQueue=null,r=_m(i,c,r,d),Em(t),c=Kc(),t!==null&&!xt?(Fc(t,i,m),ni(t,i,m)):(He&&c&&wc(i),i.flags|=1,Ut(t,i,r,m),i.child)}function Tp(t,i,r,c,d){if(ds(i),i.stateNode===null){var m=Ws,x=r.contextType;typeof x=="object"&&x!==null&&(m=Dt(x)),m=new r(c,m),i.memoizedState=m.state!==null&&m.state!==void 0?m.state:null,m.updater=lu,i.stateNode=m,m._reactInternals=i,m=i.stateNode,m.props=c,m.state=i.memoizedState,m.refs={},Pc(i),x=r.contextType,m.context=typeof x=="object"&&x!==null?Dt(x):Ws,m.state=i.memoizedState,x=r.getDerivedStateFromProps,typeof x=="function"&&(ru(i,r,x,c),m.state=i.memoizedState),typeof r.getDerivedStateFromProps=="function"||typeof m.getSnapshotBeforeUpdate=="function"||typeof m.UNSAFE_componentWillMount!="function"&&typeof m.componentWillMount!="function"||(x=m.state,typeof m.componentWillMount=="function"&&m.componentWillMount(),typeof m.UNSAFE_componentWillMount=="function"&&m.UNSAFE_componentWillMount(),x!==m.state&&lu.enqueueReplaceState(m,m.state,null),Qa(i,c,m,d),Ja(),m.state=i.memoizedState),typeof m.componentDidMount=="function"&&(i.flags|=4194308),c=!0}else if(t===null){m=i.stateNode;var O=i.memoizedProps,L=gs(r,O);m.props=L;var Y=m.context,te=r.contextType;x=Ws,typeof te=="object"&&te!==null&&(x=Dt(te));var ie=r.getDerivedStateFromProps;te=typeof ie=="function"||typeof m.getSnapshotBeforeUpdate=="function",O=i.pendingProps!==O,te||typeof m.UNSAFE_componentWillReceiveProps!="function"&&typeof m.componentWillReceiveProps!="function"||(O||Y!==x)&&cp(i,m,c,x),Ti=!1;var K=i.memoizedState;m.state=K,Qa(i,c,m,d),Ja(),Y=i.memoizedState,O||K!==Y||Ti?(typeof ie=="function"&&(ru(i,r,ie,c),Y=i.memoizedState),(L=Ti||lp(i,r,L,c,K,Y,x))?(te||typeof m.UNSAFE_componentWillMount!="function"&&typeof m.componentWillMount!="function"||(typeof m.componentWillMount=="function"&&m.componentWillMount(),typeof m.UNSAFE_componentWillMount=="function"&&m.UNSAFE_componentWillMount()),typeof m.componentDidMount=="function"&&(i.flags|=4194308)):(typeof m.componentDidMount=="function"&&(i.flags|=4194308),i.memoizedProps=c,i.memoizedState=Y),m.props=c,m.state=Y,m.context=x,c=L):(typeof m.componentDidMount=="function"&&(i.flags|=4194308),c=!1)}else{m=i.stateNode,jc(t,i),x=i.memoizedProps,te=gs(r,x),m.props=te,ie=i.pendingProps,K=m.context,Y=r.contextType,L=Ws,typeof Y=="object"&&Y!==null&&(L=Dt(Y)),O=r.getDerivedStateFromProps,(Y=typeof O=="function"||typeof m.getSnapshotBeforeUpdate=="function")||typeof m.UNSAFE_componentWillReceiveProps!="function"&&typeof m.componentWillReceiveProps!="function"||(x!==ie||K!==L)&&cp(i,m,c,L),Ti=!1,K=i.memoizedState,m.state=K,Qa(i,c,m,d),Ja();var J=i.memoizedState;x!==ie||K!==J||Ti||t!==null&&t.dependencies!==null&&rr(t.dependencies)?(typeof O=="function"&&(ru(i,r,O,c),J=i.memoizedState),(te=Ti||lp(i,r,te,c,K,J,L)||t!==null&&t.dependencies!==null&&rr(t.dependencies))?(Y||typeof m.UNSAFE_componentWillUpdate!="function"&&typeof m.componentWillUpdate!="function"||(typeof m.componentWillUpdate=="function"&&m.componentWillUpdate(c,J,L),typeof m.UNSAFE_componentWillUpdate=="function"&&m.UNSAFE_componentWillUpdate(c,J,L)),typeof m.componentDidUpdate=="function"&&(i.flags|=4),typeof m.getSnapshotBeforeUpdate=="function"&&(i.flags|=1024)):(typeof m.componentDidUpdate!="function"||x===t.memoizedProps&&K===t.memoizedState||(i.flags|=4),typeof m.getSnapshotBeforeUpdate!="function"||x===t.memoizedProps&&K===t.memoizedState||(i.flags|=1024),i.memoizedProps=c,i.memoizedState=J),m.props=c,m.state=J,m.context=L,c=te):(typeof m.componentDidUpdate!="function"||x===t.memoizedProps&&K===t.memoizedState||(i.flags|=4),typeof m.getSnapshotBeforeUpdate!="function"||x===t.memoizedProps&&K===t.memoizedState||(i.flags|=1024),c=!1)}return m=c,wr(t,i),c=(i.flags&128)!==0,m||c?(m=i.stateNode,r=c&&typeof r.getDerivedStateFromError!="function"?null:m.render(),i.flags|=1,t!==null&&c?(i.child=hs(i,t.child,null,d),i.child=hs(i,null,r,d)):Ut(t,i,r,d),i.memoizedState=m.state,t=i.child):t=ni(t,i,d),t}function Ep(t,i,r,c){return cs(),i.flags|=256,Ut(t,i,r,c),i.child}var fu={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function mu(t){return{baseLanes:t,cachePool:mm()}}function pu(t,i,r){return t=t!==null?t.childLanes&~r:0,i&&(t|=un),t}function _p(t,i,r){var c=i.pendingProps,d=!1,m=(i.flags&128)!==0,x;if((x=m)||(x=t!==null&&t.memoizedState===null?!1:(yt.current&2)!==0),x&&(d=!0,i.flags&=-129),x=(i.flags&32)!==0,i.flags&=-33,t===null){if(He){if(d?wi(i):Mi(),(t=Je)?(t=Ih(t,Sn),t=t!==null&&t.data!=="&"?t:null,t!==null&&(i.memoizedState={dehydrated:t,treeContext:Si!==null?{id:Dn,overflow:Un}:null,retryLane:536870912,hydrationErrors:null},r=sm(t),r.return=i,i.child=r,jt=i,Je=null)):t=null,t===null)throw xi(i);return Xu(t)?i.lanes=32:i.lanes=536870912,null}var O=c.children;return c=c.fallback,d?(Mi(),d=i.mode,O=Mr({mode:"hidden",children:O},d),c=ls(c,d,r,null),O.return=i,c.return=i,O.sibling=c,i.child=O,c=i.child,c.memoizedState=mu(r),c.childLanes=pu(t,x,r),i.memoizedState=fu,io(null,c)):(wi(i),hu(i,O))}var L=t.memoizedState;if(L!==null&&(O=L.dehydrated,O!==null)){if(m)i.flags&256?(wi(i),i.flags&=-257,i=yu(t,i,r)):i.memoizedState!==null?(Mi(),i.child=t.child,i.flags|=128,i=null):(Mi(),O=c.fallback,d=i.mode,c=Mr({mode:"visible",children:c.children},d),O=ls(O,d,r,null),O.flags|=2,c.return=i,O.return=i,c.sibling=O,i.child=c,hs(i,t.child,null,r),c=i.child,c.memoizedState=mu(r),c.childLanes=pu(t,x,r),i.memoizedState=fu,i=io(null,c));else if(wi(i),Xu(O)){if(x=O.nextSibling&&O.nextSibling.dataset,x)var Y=x.dgst;x=Y,c=Error(o(419)),c.stack="",c.digest=x,Ya({value:c,source:null,stack:null}),i=yu(t,i,r)}else if(xt||Qs(t,i,r,!1),x=(r&t.childLanes)!==0,xt||x){if(x=Ge,x!==null&&(c=Is(x,r),c!==0&&c!==L.retryLane))throw L.retryLane=c,rs(t,c),nn(x,t,c),uu;Gu(O)||Hr(),i=yu(t,i,r)}else Gu(O)?(i.flags|=192,i.child=t.child,i=null):(t=L.treeContext,Je=xn(O.nextSibling),jt=i,He=!0,vi=null,Sn=!1,t!==null&&rm(i,t),i=hu(i,c.children),i.flags|=4096);return i}return d?(Mi(),O=c.fallback,d=i.mode,L=t.child,Y=L.sibling,c=Xn(L,{mode:"hidden",children:c.children}),c.subtreeFlags=L.subtreeFlags&65011712,Y!==null?O=Xn(Y,O):(O=ls(O,d,r,null),O.flags|=2),O.return=i,c.return=i,c.sibling=O,i.child=c,io(null,c),c=i.child,O=t.child.memoizedState,O===null?O=mu(r):(d=O.cachePool,d!==null?(L=St._currentValue,d=d.parent!==L?{parent:L,pool:L}:d):d=mm(),O={baseLanes:O.baseLanes|r,cachePool:d}),c.memoizedState=O,c.childLanes=pu(t,x,r),i.memoizedState=fu,io(t.child,c)):(wi(i),r=t.child,t=r.sibling,r=Xn(r,{mode:"visible",children:c.children}),r.return=i,r.sibling=null,t!==null&&(x=i.deletions,x===null?(i.deletions=[t],i.flags|=16):x.push(t)),i.child=r,i.memoizedState=null,r)}function hu(t,i){return i=Mr({mode:"visible",children:i},t.mode),i.return=t,t.child=i}function Mr(t,i){return t=on(22,t,null,i),t.lanes=0,t}function yu(t,i,r){return hs(i,t.child,null,r),t=hu(i,i.pendingProps.children),t.flags|=2,i.memoizedState=null,t}function wp(t,i,r){t.lanes|=i;var c=t.alternate;c!==null&&(c.lanes|=i),kc(t.return,i,r)}function gu(t,i,r,c,d,m){var x=t.memoizedState;x===null?t.memoizedState={isBackwards:i,rendering:null,renderingStartTime:0,last:c,tail:r,tailMode:d,treeForkCount:m}:(x.isBackwards=i,x.rendering=null,x.renderingStartTime=0,x.last=c,x.tail=r,x.tailMode=d,x.treeForkCount=m)}function Mp(t,i,r){var c=i.pendingProps,d=c.revealOrder,m=c.tail;c=c.children;var x=yt.current,O=(x&2)!==0;if(O?(x=x&1|2,i.flags|=128):x&=1,G(yt,x),Ut(t,i,c,r),c=He?Va:0,!O&&t!==null&&(t.flags&128)!==0)e:for(t=i.child;t!==null;){if(t.tag===13)t.memoizedState!==null&&wp(t,r,i);else if(t.tag===19)wp(t,r,i);else if(t.child!==null){t.child.return=t,t=t.child;continue}if(t===i)break e;for(;t.sibling===null;){if(t.return===null||t.return===i)break e;t=t.return}t.sibling.return=t.return,t=t.sibling}switch(d){case"forwards":for(r=i.child,d=null;r!==null;)t=r.alternate,t!==null&&hr(t)===null&&(d=r),r=r.sibling;r=d,r===null?(d=i.child,i.child=null):(d=r.sibling,r.sibling=null),gu(i,!1,d,r,m,c);break;case"backwards":case"unstable_legacy-backwards":for(r=null,d=i.child,i.child=null;d!==null;){if(t=d.alternate,t!==null&&hr(t)===null){i.child=d;break}t=d.sibling,d.sibling=r,r=d,d=t}gu(i,!0,r,null,m,c);break;case"together":gu(i,!1,null,null,void 0,c);break;default:i.memoizedState=null}return i.child}function ni(t,i,r){if(t!==null&&(i.dependencies=t.dependencies),Ni|=i.lanes,(r&i.childLanes)===0)if(t!==null){if(Qs(t,i,r,!1),(r&i.childLanes)===0)return null}else return null;if(t!==null&&i.child!==t.child)throw Error(o(153));if(i.child!==null){for(t=i.child,r=Xn(t,t.pendingProps),i.child=r,r.return=i;t.sibling!==null;)t=t.sibling,r=r.sibling=Xn(t,t.pendingProps),r.return=i;r.sibling=null}return i.child}function bu(t,i){return(t.lanes&i)!==0?!0:(t=t.dependencies,!!(t!==null&&rr(t)))}function sS(t,i,r){switch(i.tag){case 3:$e(i,i.stateNode.containerInfo),Ai(i,St,t.memoizedState.cache),cs();break;case 27:case 5:at(i);break;case 4:$e(i,i.stateNode.containerInfo);break;case 10:Ai(i,i.type,i.memoizedProps.value);break;case 31:if(i.memoizedState!==null)return i.flags|=128,zc(i),null;break;case 13:var c=i.memoizedState;if(c!==null)return c.dehydrated!==null?(wi(i),i.flags|=128,null):(r&i.child.childLanes)!==0?_p(t,i,r):(wi(i),t=ni(t,i,r),t!==null?t.sibling:null);wi(i);break;case 19:var d=(t.flags&128)!==0;if(c=(r&i.childLanes)!==0,c||(Qs(t,i,r,!1),c=(r&i.childLanes)!==0),d){if(c)return Mp(t,i,r);i.flags|=128}if(d=i.memoizedState,d!==null&&(d.rendering=null,d.tail=null,d.lastEffect=null),G(yt,yt.current),c)break;return null;case 22:return i.lanes=0,Sp(t,i,r,i.pendingProps);case 24:Ai(i,St,t.memoizedState.cache)}return ni(t,i,r)}function Cp(t,i,r){if(t!==null)if(t.memoizedProps!==i.pendingProps)xt=!0;else{if(!bu(t,r)&&(i.flags&128)===0)return xt=!1,sS(t,i,r);xt=(t.flags&131072)!==0}else xt=!1,He&&(i.flags&1048576)!==0&&om(i,Va,i.index);switch(i.lanes=0,i.tag){case 16:e:{var c=i.pendingProps;if(t=ms(i.elementType),i.type=t,typeof t=="function")Tc(t)?(c=gs(t,c),i.tag=1,i=Tp(null,i,t,c,r)):(i.tag=0,i=du(null,i,t,c,r));else{if(t!=null){var d=t.$$typeof;if(d===C){i.tag=11,i=yp(null,i,t,c,r);break e}else if(d===R){i.tag=14,i=gp(null,i,t,c,r);break e}}throw i=oe(t)||t,Error(o(306,i,""))}}return i;case 0:return du(t,i,i.type,i.pendingProps,r);case 1:return c=i.type,d=gs(c,i.pendingProps),Tp(t,i,c,d,r);case 3:e:{if($e(i,i.stateNode.containerInfo),t===null)throw Error(o(387));c=i.pendingProps;var m=i.memoizedState;d=m.element,jc(t,i),Qa(i,c,null,r);var x=i.memoizedState;if(c=x.cache,Ai(i,St,c),c!==m.cache&&Rc(i,[St],r,!0),Ja(),c=x.element,m.isDehydrated)if(m={element:c,isDehydrated:!1,cache:x.cache},i.updateQueue.baseState=m,i.memoizedState=m,i.flags&256){i=Ep(t,i,c,r);break e}else if(c!==d){d=yn(Error(o(424)),i),Ya(d),i=Ep(t,i,c,r);break e}else for(t=i.stateNode.containerInfo,t.nodeType===9?t=t.body:t=t.nodeName==="HTML"?t.ownerDocument.body:t,Je=xn(t.firstChild),jt=i,He=!0,vi=null,Sn=!0,r=Sm(i,null,c,r),i.child=r;r;)r.flags=r.flags&-3|4096,r=r.sibling;else{if(cs(),c===d){i=ni(t,i,r);break e}Ut(t,i,c,r)}i=i.child}return i;case 26:return wr(t,i),t===null?(r=Dh(i.type,null,i.pendingProps,null))?i.memoizedState=r:He||(r=i.type,t=i.pendingProps,c=zr(ue.current).createElement(r),c[Pt]=i,c[Xt]=t,$t(c,r,t),kt(c),i.stateNode=c):i.memoizedState=Dh(i.type,t.memoizedProps,i.pendingProps,t.memoizedState),null;case 27:return at(i),t===null&&He&&(c=i.stateNode=Hh(i.type,i.pendingProps,ue.current),jt=i,Sn=!0,d=Je,Bi(i.type)?(Ju=d,Je=xn(c.firstChild)):Je=d),Ut(t,i,i.pendingProps.children,r),wr(t,i),t===null&&(i.flags|=4194304),i.child;case 5:return t===null&&He&&((d=c=Je)&&(c=LS(c,i.type,i.pendingProps,Sn),c!==null?(i.stateNode=c,jt=i,Je=xn(c.firstChild),Sn=!1,d=!0):d=!1),d||xi(i)),at(i),d=i.type,m=i.pendingProps,x=t!==null?t.memoizedProps:null,c=m.children,Ku(d,m)?c=null:x!==null&&Ku(d,x)&&(i.flags|=32),i.memoizedState!==null&&(d=Yc(t,i,Gb,null,null,r),So._currentValue=d),wr(t,i),Ut(t,i,c,r),i.child;case 6:return t===null&&He&&((t=r=Je)&&(r=BS(r,i.pendingProps,Sn),r!==null?(i.stateNode=r,jt=i,Je=null,t=!0):t=!1),t||xi(i)),null;case 13:return _p(t,i,r);case 4:return $e(i,i.stateNode.containerInfo),c=i.pendingProps,t===null?i.child=hs(i,null,c,r):Ut(t,i,c,r),i.child;case 11:return yp(t,i,i.type,i.pendingProps,r);case 7:return Ut(t,i,i.pendingProps,r),i.child;case 8:return Ut(t,i,i.pendingProps.children,r),i.child;case 12:return Ut(t,i,i.pendingProps.children,r),i.child;case 10:return c=i.pendingProps,Ai(i,i.type,c.value),Ut(t,i,c.children,r),i.child;case 9:return d=i.type._context,c=i.pendingProps.children,ds(i),d=Dt(d),c=c(d),i.flags|=1,Ut(t,i,c,r),i.child;case 14:return gp(t,i,i.type,i.pendingProps,r);case 15:return bp(t,i,i.type,i.pendingProps,r);case 19:return Mp(t,i,r);case 31:return iS(t,i,r);case 22:return Sp(t,i,r,i.pendingProps);case 24:return ds(i),c=Dt(St),t===null?(d=Bc(),d===null&&(d=Ge,m=Ic(),d.pooledCache=m,m.refCount++,m!==null&&(d.pooledCacheLanes|=r),d=m),i.memoizedState={parent:c,cache:d},Pc(i),Ai(i,St,d)):((t.lanes&r)!==0&&(jc(t,i),Qa(i,null,null,r),Ja()),d=t.memoizedState,m=i.memoizedState,d.parent!==c?(d={parent:c,cache:c},i.memoizedState=d,i.lanes===0&&(i.memoizedState=i.updateQueue.baseState=d),Ai(i,St,c)):(c=m.cache,Ai(i,St,c),c!==d.cache&&Rc(i,[St],r,!0))),Ut(t,i,i.pendingProps.children,r),i.child;case 29:throw i.pendingProps}throw Error(o(156,i.tag))}function ii(t){t.flags|=4}function Su(t,i,r,c,d){if((i=(t.mode&32)!==0)&&(i=!1),i){if(t.flags|=16777216,(d&335544128)===d)if(t.stateNode.complete)t.flags|=8192;else if(th())t.flags|=8192;else throw ps=dr,Hc}else t.flags&=-16777217}function Op(t,i){if(i.type!=="stylesheet"||(i.state.loading&4)!==0)t.flags&=-16777217;else if(t.flags|=16777216,!Vh(i))if(th())t.flags|=8192;else throw ps=dr,Hc}function Cr(t,i){i!==null&&(t.flags|=4),t.flags&16384&&(i=t.tag!==22?Na():536870912,t.lanes|=i,ua|=i)}function so(t,i){if(!He)switch(t.tailMode){case"hidden":i=t.tail;for(var r=null;i!==null;)i.alternate!==null&&(r=i),i=i.sibling;r===null?t.tail=null:r.sibling=null;break;case"collapsed":r=t.tail;for(var c=null;r!==null;)r.alternate!==null&&(c=r),r=r.sibling;c===null?i||t.tail===null?t.tail=null:t.tail.sibling=null:c.sibling=null}}function Qe(t){var i=t.alternate!==null&&t.alternate.child===t.child,r=0,c=0;if(i)for(var d=t.child;d!==null;)r|=d.lanes|d.childLanes,c|=d.subtreeFlags&65011712,c|=d.flags&65011712,d.return=t,d=d.sibling;else for(d=t.child;d!==null;)r|=d.lanes|d.childLanes,c|=d.subtreeFlags,c|=d.flags,d.return=t,d=d.sibling;return t.subtreeFlags|=c,t.childLanes=r,i}function aS(t,i,r){var c=i.pendingProps;switch(Mc(i),i.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Qe(i),null;case 1:return Qe(i),null;case 3:return r=i.stateNode,c=null,t!==null&&(c=t.memoizedState.cache),i.memoizedState.cache!==c&&(i.flags|=2048),Zn(St),Ee(),r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),(t===null||t.child===null)&&(Js(i)?ii(i):t===null||t.memoizedState.isDehydrated&&(i.flags&256)===0||(i.flags|=1024,Oc())),Qe(i),null;case 26:var d=i.type,m=i.memoizedState;return t===null?(ii(i),m!==null?(Qe(i),Op(i,m)):(Qe(i),Su(i,d,null,c,r))):m?m!==t.memoizedState?(ii(i),Qe(i),Op(i,m)):(Qe(i),i.flags&=-16777217):(t=t.memoizedProps,t!==c&&ii(i),Qe(i),Su(i,d,t,c,r)),null;case 27:if(ot(i),r=ue.current,d=i.type,t!==null&&i.stateNode!=null)t.memoizedProps!==c&&ii(i);else{if(!c){if(i.stateNode===null)throw Error(o(166));return Qe(i),null}t=ae.current,Js(i)?lm(i):(t=Hh(d,c,r),i.stateNode=t,ii(i))}return Qe(i),null;case 5:if(ot(i),d=i.type,t!==null&&i.stateNode!=null)t.memoizedProps!==c&&ii(i);else{if(!c){if(i.stateNode===null)throw Error(o(166));return Qe(i),null}if(m=ae.current,Js(i))lm(i);else{var x=zr(ue.current);switch(m){case 1:m=x.createElementNS("http://www.w3.org/2000/svg",d);break;case 2:m=x.createElementNS("http://www.w3.org/1998/Math/MathML",d);break;default:switch(d){case"svg":m=x.createElementNS("http://www.w3.org/2000/svg",d);break;case"math":m=x.createElementNS("http://www.w3.org/1998/Math/MathML",d);break;case"script":m=x.createElement("div"),m.innerHTML="<script><\/script>",m=m.removeChild(m.firstChild);break;case"select":m=typeof c.is=="string"?x.createElement("select",{is:c.is}):x.createElement("select"),c.multiple?m.multiple=!0:c.size&&(m.size=c.size);break;default:m=typeof c.is=="string"?x.createElement(d,{is:c.is}):x.createElement(d)}}m[Pt]=i,m[Xt]=c;e:for(x=i.child;x!==null;){if(x.tag===5||x.tag===6)m.appendChild(x.stateNode);else if(x.tag!==4&&x.tag!==27&&x.child!==null){x.child.return=x,x=x.child;continue}if(x===i)break e;for(;x.sibling===null;){if(x.return===null||x.return===i)break e;x=x.return}x.sibling.return=x.return,x=x.sibling}i.stateNode=m;e:switch($t(m,d,c),d){case"button":case"input":case"select":case"textarea":c=!!c.autoFocus;break e;case"img":c=!0;break e;default:c=!1}c&&ii(i)}}return Qe(i),Su(i,i.type,t===null?null:t.memoizedProps,i.pendingProps,r),null;case 6:if(t&&i.stateNode!=null)t.memoizedProps!==c&&ii(i);else{if(typeof c!="string"&&i.stateNode===null)throw Error(o(166));if(t=ue.current,Js(i)){if(t=i.stateNode,r=i.memoizedProps,c=null,d=jt,d!==null)switch(d.tag){case 27:case 5:c=d.memoizedProps}t[Pt]=i,t=!!(t.nodeValue===r||c!==null&&c.suppressHydrationWarning===!0||_h(t.nodeValue,r)),t||xi(i,!0)}else t=zr(t).createTextNode(c),t[Pt]=i,i.stateNode=t}return Qe(i),null;case 31:if(r=i.memoizedState,t===null||t.memoizedState!==null){if(c=Js(i),r!==null){if(t===null){if(!c)throw Error(o(318));if(t=i.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(o(557));t[Pt]=i}else cs(),(i.flags&128)===0&&(i.memoizedState=null),i.flags|=4;Qe(i),t=!1}else r=Oc(),t!==null&&t.memoizedState!==null&&(t.memoizedState.hydrationErrors=r),t=!0;if(!t)return i.flags&256?(ln(i),i):(ln(i),null);if((i.flags&128)!==0)throw Error(o(558))}return Qe(i),null;case 13:if(c=i.memoizedState,t===null||t.memoizedState!==null&&t.memoizedState.dehydrated!==null){if(d=Js(i),c!==null&&c.dehydrated!==null){if(t===null){if(!d)throw Error(o(318));if(d=i.memoizedState,d=d!==null?d.dehydrated:null,!d)throw Error(o(317));d[Pt]=i}else cs(),(i.flags&128)===0&&(i.memoizedState=null),i.flags|=4;Qe(i),d=!1}else d=Oc(),t!==null&&t.memoizedState!==null&&(t.memoizedState.hydrationErrors=d),d=!0;if(!d)return i.flags&256?(ln(i),i):(ln(i),null)}return ln(i),(i.flags&128)!==0?(i.lanes=r,i):(r=c!==null,t=t!==null&&t.memoizedState!==null,r&&(c=i.child,d=null,c.alternate!==null&&c.alternate.memoizedState!==null&&c.alternate.memoizedState.cachePool!==null&&(d=c.alternate.memoizedState.cachePool.pool),m=null,c.memoizedState!==null&&c.memoizedState.cachePool!==null&&(m=c.memoizedState.cachePool.pool),m!==d&&(c.flags|=2048)),r!==t&&r&&(i.child.flags|=8192),Cr(i,i.updateQueue),Qe(i),null);case 4:return Ee(),t===null&&$u(i.stateNode.containerInfo),Qe(i),null;case 10:return Zn(i.type),Qe(i),null;case 19:if(W(yt),c=i.memoizedState,c===null)return Qe(i),null;if(d=(i.flags&128)!==0,m=c.rendering,m===null)if(d)so(c,!1);else{if(dt!==0||t!==null&&(t.flags&128)!==0)for(t=i.child;t!==null;){if(m=hr(t),m!==null){for(i.flags|=128,so(c,!1),t=m.updateQueue,i.updateQueue=t,Cr(i,t),i.subtreeFlags=0,t=r,r=i.child;r!==null;)im(r,t),r=r.sibling;return G(yt,yt.current&1|2),He&&Jn(i,c.treeForkCount),i.child}t=t.sibling}c.tail!==null&&It()>Ir&&(i.flags|=128,d=!0,so(c,!1),i.lanes=4194304)}else{if(!d)if(t=hr(m),t!==null){if(i.flags|=128,d=!0,t=t.updateQueue,i.updateQueue=t,Cr(i,t),so(c,!0),c.tail===null&&c.tailMode==="hidden"&&!m.alternate&&!He)return Qe(i),null}else 2*It()-c.renderingStartTime>Ir&&r!==536870912&&(i.flags|=128,d=!0,so(c,!1),i.lanes=4194304);c.isBackwards?(m.sibling=i.child,i.child=m):(t=c.last,t!==null?t.sibling=m:i.child=m,c.last=m)}return c.tail!==null?(t=c.tail,c.rendering=t,c.tail=t.sibling,c.renderingStartTime=It(),t.sibling=null,r=yt.current,G(yt,d?r&1|2:r&1),He&&Jn(i,c.treeForkCount),t):(Qe(i),null);case 22:case 23:return ln(i),qc(),c=i.memoizedState!==null,t!==null?t.memoizedState!==null!==c&&(i.flags|=8192):c&&(i.flags|=8192),c?(r&536870912)!==0&&(i.flags&128)===0&&(Qe(i),i.subtreeFlags&6&&(i.flags|=8192)):Qe(i),r=i.updateQueue,r!==null&&Cr(i,r.retryQueue),r=null,t!==null&&t.memoizedState!==null&&t.memoizedState.cachePool!==null&&(r=t.memoizedState.cachePool.pool),c=null,i.memoizedState!==null&&i.memoizedState.cachePool!==null&&(c=i.memoizedState.cachePool.pool),c!==r&&(i.flags|=2048),t!==null&&W(fs),null;case 24:return r=null,t!==null&&(r=t.memoizedState.cache),i.memoizedState.cache!==r&&(i.flags|=2048),Zn(St),Qe(i),null;case 25:return null;case 30:return null}throw Error(o(156,i.tag))}function oS(t,i){switch(Mc(i),i.tag){case 1:return t=i.flags,t&65536?(i.flags=t&-65537|128,i):null;case 3:return Zn(St),Ee(),t=i.flags,(t&65536)!==0&&(t&128)===0?(i.flags=t&-65537|128,i):null;case 26:case 27:case 5:return ot(i),null;case 31:if(i.memoizedState!==null){if(ln(i),i.alternate===null)throw Error(o(340));cs()}return t=i.flags,t&65536?(i.flags=t&-65537|128,i):null;case 13:if(ln(i),t=i.memoizedState,t!==null&&t.dehydrated!==null){if(i.alternate===null)throw Error(o(340));cs()}return t=i.flags,t&65536?(i.flags=t&-65537|128,i):null;case 19:return W(yt),null;case 4:return Ee(),null;case 10:return Zn(i.type),null;case 22:case 23:return ln(i),qc(),t!==null&&W(fs),t=i.flags,t&65536?(i.flags=t&-65537|128,i):null;case 24:return Zn(St),null;case 25:return null;default:return null}}function Np(t,i){switch(Mc(i),i.tag){case 3:Zn(St),Ee();break;case 26:case 27:case 5:ot(i);break;case 4:Ee();break;case 31:i.memoizedState!==null&&ln(i);break;case 13:ln(i);break;case 19:W(yt);break;case 10:Zn(i.type);break;case 22:case 23:ln(i),qc(),t!==null&&W(fs);break;case 24:Zn(St)}}function ao(t,i){try{var r=i.updateQueue,c=r!==null?r.lastEffect:null;if(c!==null){var d=c.next;r=d;do{if((r.tag&t)===t){c=void 0;var m=r.create,x=r.inst;c=m(),x.destroy=c}r=r.next}while(r!==d)}}catch(O){Ve(i,i.return,O)}}function Ci(t,i,r){try{var c=i.updateQueue,d=c!==null?c.lastEffect:null;if(d!==null){var m=d.next;c=m;do{if((c.tag&t)===t){var x=c.inst,O=x.destroy;if(O!==void 0){x.destroy=void 0,d=i;var L=r,Y=O;try{Y()}catch(te){Ve(d,L,te)}}}c=c.next}while(c!==m)}}catch(te){Ve(i,i.return,te)}}function kp(t){var i=t.updateQueue;if(i!==null){var r=t.stateNode;try{xm(i,r)}catch(c){Ve(t,t.return,c)}}}function Rp(t,i,r){r.props=gs(t.type,t.memoizedProps),r.state=t.memoizedState;try{r.componentWillUnmount()}catch(c){Ve(t,i,c)}}function oo(t,i){try{var r=t.ref;if(r!==null){switch(t.tag){case 26:case 27:case 5:var c=t.stateNode;break;case 30:c=t.stateNode;break;default:c=t.stateNode}typeof r=="function"?t.refCleanup=r(c):r.current=c}}catch(d){Ve(t,i,d)}}function $n(t,i){var r=t.ref,c=t.refCleanup;if(r!==null)if(typeof c=="function")try{c()}catch(d){Ve(t,i,d)}finally{t.refCleanup=null,t=t.alternate,t!=null&&(t.refCleanup=null)}else if(typeof r=="function")try{r(null)}catch(d){Ve(t,i,d)}else r.current=null}function Ip(t){var i=t.type,r=t.memoizedProps,c=t.stateNode;try{e:switch(i){case"button":case"input":case"select":case"textarea":r.autoFocus&&c.focus();break e;case"img":r.src?c.src=r.src:r.srcSet&&(c.srcset=r.srcSet)}}catch(d){Ve(t,t.return,d)}}function vu(t,i,r){try{var c=t.stateNode;CS(c,t.type,r,i),c[Xt]=i}catch(d){Ve(t,t.return,d)}}function Lp(t){return t.tag===5||t.tag===3||t.tag===26||t.tag===27&&Bi(t.type)||t.tag===4}function xu(t){e:for(;;){for(;t.sibling===null;){if(t.return===null||Lp(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;t.tag!==5&&t.tag!==6&&t.tag!==18;){if(t.tag===27&&Bi(t.type)||t.flags&2||t.child===null||t.tag===4)continue e;t.child.return=t,t=t.child}if(!(t.flags&2))return t.stateNode}}function Au(t,i,r){var c=t.tag;if(c===5||c===6)t=t.stateNode,i?(r.nodeType===9?r.body:r.nodeName==="HTML"?r.ownerDocument.body:r).insertBefore(t,i):(i=r.nodeType===9?r.body:r.nodeName==="HTML"?r.ownerDocument.body:r,i.appendChild(t),r=r._reactRootContainer,r!=null||i.onclick!==null||(i.onclick=Wn));else if(c!==4&&(c===27&&Bi(t.type)&&(r=t.stateNode,i=null),t=t.child,t!==null))for(Au(t,i,r),t=t.sibling;t!==null;)Au(t,i,r),t=t.sibling}function Or(t,i,r){var c=t.tag;if(c===5||c===6)t=t.stateNode,i?r.insertBefore(t,i):r.appendChild(t);else if(c!==4&&(c===27&&Bi(t.type)&&(r=t.stateNode),t=t.child,t!==null))for(Or(t,i,r),t=t.sibling;t!==null;)Or(t,i,r),t=t.sibling}function Bp(t){var i=t.stateNode,r=t.memoizedProps;try{for(var c=t.type,d=i.attributes;d.length;)i.removeAttributeNode(d[0]);$t(i,c,r),i[Pt]=t,i[Xt]=r}catch(m){Ve(t,t.return,m)}}var si=!1,At=!1,Tu=!1,Hp=typeof WeakSet=="function"?WeakSet:Set,Rt=null;function rS(t,i){if(t=t.containerInfo,Vu=Xr,t=Wf(t),yc(t)){if("selectionStart"in t)var r={start:t.selectionStart,end:t.selectionEnd};else e:{r=(r=t.ownerDocument)&&r.defaultView||window;var c=r.getSelection&&r.getSelection();if(c&&c.rangeCount!==0){r=c.anchorNode;var d=c.anchorOffset,m=c.focusNode;c=c.focusOffset;try{r.nodeType,m.nodeType}catch{r=null;break e}var x=0,O=-1,L=-1,Y=0,te=0,ie=t,K=null;t:for(;;){for(var J;ie!==r||d!==0&&ie.nodeType!==3||(O=x+d),ie!==m||c!==0&&ie.nodeType!==3||(L=x+c),ie.nodeType===3&&(x+=ie.nodeValue.length),(J=ie.firstChild)!==null;)K=ie,ie=J;for(;;){if(ie===t)break t;if(K===r&&++Y===d&&(O=x),K===m&&++te===c&&(L=x),(J=ie.nextSibling)!==null)break;ie=K,K=ie.parentNode}ie=J}r=O===-1||L===-1?null:{start:O,end:L}}else r=null}r=r||{start:0,end:0}}else r=null;for(Yu={focusedElem:t,selectionRange:r},Xr=!1,Rt=i;Rt!==null;)if(i=Rt,t=i.child,(i.subtreeFlags&1028)!==0&&t!==null)t.return=i,Rt=t;else for(;Rt!==null;){switch(i=Rt,m=i.alternate,t=i.flags,i.tag){case 0:if((t&4)!==0&&(t=i.updateQueue,t=t!==null?t.events:null,t!==null))for(r=0;r<t.length;r++)d=t[r],d.ref.impl=d.nextImpl;break;case 11:case 15:break;case 1:if((t&1024)!==0&&m!==null){t=void 0,r=i,d=m.memoizedProps,m=m.memoizedState,c=r.stateNode;try{var me=gs(r.type,d);t=c.getSnapshotBeforeUpdate(me,m),c.__reactInternalSnapshotBeforeUpdate=t}catch(ve){Ve(r,r.return,ve)}}break;case 3:if((t&1024)!==0){if(t=i.stateNode.containerInfo,r=t.nodeType,r===9)Wu(t);else if(r===1)switch(t.nodeName){case"HEAD":case"HTML":case"BODY":Wu(t);break;default:t.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((t&1024)!==0)throw Error(o(163))}if(t=i.sibling,t!==null){t.return=i.return,Rt=t;break}Rt=i.return}}function Pp(t,i,r){var c=r.flags;switch(r.tag){case 0:case 11:case 15:oi(t,r),c&4&&ao(5,r);break;case 1:if(oi(t,r),c&4)if(t=r.stateNode,i===null)try{t.componentDidMount()}catch(x){Ve(r,r.return,x)}else{var d=gs(r.type,i.memoizedProps);i=i.memoizedState;try{t.componentDidUpdate(d,i,t.__reactInternalSnapshotBeforeUpdate)}catch(x){Ve(r,r.return,x)}}c&64&&kp(r),c&512&&oo(r,r.return);break;case 3:if(oi(t,r),c&64&&(t=r.updateQueue,t!==null)){if(i=null,r.child!==null)switch(r.child.tag){case 27:case 5:i=r.child.stateNode;break;case 1:i=r.child.stateNode}try{xm(t,i)}catch(x){Ve(r,r.return,x)}}break;case 27:i===null&&c&4&&Bp(r);case 26:case 5:oi(t,r),i===null&&c&4&&Ip(r),c&512&&oo(r,r.return);break;case 12:oi(t,r);break;case 31:oi(t,r),c&4&&Up(t,r);break;case 13:oi(t,r),c&4&&$p(t,r),c&64&&(t=r.memoizedState,t!==null&&(t=t.dehydrated,t!==null&&(r=yS.bind(null,r),HS(t,r))));break;case 22:if(c=r.memoizedState!==null||si,!c){i=i!==null&&i.memoizedState!==null||At,d=si;var m=At;si=c,(At=i)&&!m?ri(t,r,(r.subtreeFlags&8772)!==0):oi(t,r),si=d,At=m}break;case 30:break;default:oi(t,r)}}function jp(t){var i=t.alternate;i!==null&&(t.alternate=null,jp(i)),t.child=null,t.deletions=null,t.sibling=null,t.tag===5&&(i=t.stateNode,i!==null&&Zl(i)),t.stateNode=null,t.return=null,t.dependencies=null,t.memoizedProps=null,t.memoizedState=null,t.pendingProps=null,t.stateNode=null,t.updateQueue=null}var tt=null,Qt=!1;function ai(t,i,r){for(r=r.child;r!==null;)Dp(t,i,r),r=r.sibling}function Dp(t,i,r){if(Lt&&typeof Lt.onCommitFiberUnmount=="function")try{Lt.onCommitFiberUnmount(Kn,r)}catch{}switch(r.tag){case 26:At||$n(r,i),ai(t,i,r),r.memoizedState?r.memoizedState.count--:r.stateNode&&(r=r.stateNode,r.parentNode.removeChild(r));break;case 27:At||$n(r,i);var c=tt,d=Qt;Bi(r.type)&&(tt=r.stateNode,Qt=!1),ai(t,i,r),yo(r.stateNode),tt=c,Qt=d;break;case 5:At||$n(r,i);case 6:if(c=tt,d=Qt,tt=null,ai(t,i,r),tt=c,Qt=d,tt!==null)if(Qt)try{(tt.nodeType===9?tt.body:tt.nodeName==="HTML"?tt.ownerDocument.body:tt).removeChild(r.stateNode)}catch(m){Ve(r,i,m)}else try{tt.removeChild(r.stateNode)}catch(m){Ve(r,i,m)}break;case 18:tt!==null&&(Qt?(t=tt,kh(t.nodeType===9?t.body:t.nodeName==="HTML"?t.ownerDocument.body:t,r.stateNode),ba(t)):kh(tt,r.stateNode));break;case 4:c=tt,d=Qt,tt=r.stateNode.containerInfo,Qt=!0,ai(t,i,r),tt=c,Qt=d;break;case 0:case 11:case 14:case 15:Ci(2,r,i),At||Ci(4,r,i),ai(t,i,r);break;case 1:At||($n(r,i),c=r.stateNode,typeof c.componentWillUnmount=="function"&&Rp(r,i,c)),ai(t,i,r);break;case 21:ai(t,i,r);break;case 22:At=(c=At)||r.memoizedState!==null,ai(t,i,r),At=c;break;default:ai(t,i,r)}}function Up(t,i){if(i.memoizedState===null&&(t=i.alternate,t!==null&&(t=t.memoizedState,t!==null))){t=t.dehydrated;try{ba(t)}catch(r){Ve(i,i.return,r)}}}function $p(t,i){if(i.memoizedState===null&&(t=i.alternate,t!==null&&(t=t.memoizedState,t!==null&&(t=t.dehydrated,t!==null))))try{ba(t)}catch(r){Ve(i,i.return,r)}}function lS(t){switch(t.tag){case 31:case 13:case 19:var i=t.stateNode;return i===null&&(i=t.stateNode=new Hp),i;case 22:return t=t.stateNode,i=t._retryCache,i===null&&(i=t._retryCache=new Hp),i;default:throw Error(o(435,t.tag))}}function Nr(t,i){var r=lS(t);i.forEach(function(c){if(!r.has(c)){r.add(c);var d=gS.bind(null,t,c);c.then(d,d)}})}function Zt(t,i){var r=i.deletions;if(r!==null)for(var c=0;c<r.length;c++){var d=r[c],m=t,x=i,O=x;e:for(;O!==null;){switch(O.tag){case 27:if(Bi(O.type)){tt=O.stateNode,Qt=!1;break e}break;case 5:tt=O.stateNode,Qt=!1;break e;case 3:case 4:tt=O.stateNode.containerInfo,Qt=!0;break e}O=O.return}if(tt===null)throw Error(o(160));Dp(m,x,d),tt=null,Qt=!1,m=d.alternate,m!==null&&(m.return=null),d.return=null}if(i.subtreeFlags&13886)for(i=i.child;i!==null;)qp(i,t),i=i.sibling}var Cn=null;function qp(t,i){var r=t.alternate,c=t.flags;switch(t.tag){case 0:case 11:case 14:case 15:Zt(i,t),en(t),c&4&&(Ci(3,t,t.return),ao(3,t),Ci(5,t,t.return));break;case 1:Zt(i,t),en(t),c&512&&(At||r===null||$n(r,r.return)),c&64&&si&&(t=t.updateQueue,t!==null&&(c=t.callbacks,c!==null&&(r=t.shared.hiddenCallbacks,t.shared.hiddenCallbacks=r===null?c:r.concat(c))));break;case 26:var d=Cn;if(Zt(i,t),en(t),c&512&&(At||r===null||$n(r,r.return)),c&4){var m=r!==null?r.memoizedState:null;if(c=t.memoizedState,r===null)if(c===null)if(t.stateNode===null){e:{c=t.type,r=t.memoizedProps,d=d.ownerDocument||d;t:switch(c){case"title":m=d.getElementsByTagName("title")[0],(!m||m[Ia]||m[Pt]||m.namespaceURI==="http://www.w3.org/2000/svg"||m.hasAttribute("itemprop"))&&(m=d.createElement(c),d.head.insertBefore(m,d.querySelector("head > title"))),$t(m,c,r),m[Pt]=t,kt(m),c=m;break e;case"link":var x=qh("link","href",d).get(c+(r.href||""));if(x){for(var O=0;O<x.length;O++)if(m=x[O],m.getAttribute("href")===(r.href==null||r.href===""?null:r.href)&&m.getAttribute("rel")===(r.rel==null?null:r.rel)&&m.getAttribute("title")===(r.title==null?null:r.title)&&m.getAttribute("crossorigin")===(r.crossOrigin==null?null:r.crossOrigin)){x.splice(O,1);break t}}m=d.createElement(c),$t(m,c,r),d.head.appendChild(m);break;case"meta":if(x=qh("meta","content",d).get(c+(r.content||""))){for(O=0;O<x.length;O++)if(m=x[O],m.getAttribute("content")===(r.content==null?null:""+r.content)&&m.getAttribute("name")===(r.name==null?null:r.name)&&m.getAttribute("property")===(r.property==null?null:r.property)&&m.getAttribute("http-equiv")===(r.httpEquiv==null?null:r.httpEquiv)&&m.getAttribute("charset")===(r.charSet==null?null:r.charSet)){x.splice(O,1);break t}}m=d.createElement(c),$t(m,c,r),d.head.appendChild(m);break;default:throw Error(o(468,c))}m[Pt]=t,kt(m),c=m}t.stateNode=c}else zh(d,t.type,t.stateNode);else t.stateNode=$h(d,c,t.memoizedProps);else m!==c?(m===null?r.stateNode!==null&&(r=r.stateNode,r.parentNode.removeChild(r)):m.count--,c===null?zh(d,t.type,t.stateNode):$h(d,c,t.memoizedProps)):c===null&&t.stateNode!==null&&vu(t,t.memoizedProps,r.memoizedProps)}break;case 27:Zt(i,t),en(t),c&512&&(At||r===null||$n(r,r.return)),r!==null&&c&4&&vu(t,t.memoizedProps,r.memoizedProps);break;case 5:if(Zt(i,t),en(t),c&512&&(At||r===null||$n(r,r.return)),t.flags&32){d=t.stateNode;try{$s(d,"")}catch(me){Ve(t,t.return,me)}}c&4&&t.stateNode!=null&&(d=t.memoizedProps,vu(t,d,r!==null?r.memoizedProps:d)),c&1024&&(Tu=!0);break;case 6:if(Zt(i,t),en(t),c&4){if(t.stateNode===null)throw Error(o(162));c=t.memoizedProps,r=t.stateNode;try{r.nodeValue=c}catch(me){Ve(t,t.return,me)}}break;case 3:if(Kr=null,d=Cn,Cn=Vr(i.containerInfo),Zt(i,t),Cn=d,en(t),c&4&&r!==null&&r.memoizedState.isDehydrated)try{ba(i.containerInfo)}catch(me){Ve(t,t.return,me)}Tu&&(Tu=!1,zp(t));break;case 4:c=Cn,Cn=Vr(t.stateNode.containerInfo),Zt(i,t),en(t),Cn=c;break;case 12:Zt(i,t),en(t);break;case 31:Zt(i,t),en(t),c&4&&(c=t.updateQueue,c!==null&&(t.updateQueue=null,Nr(t,c)));break;case 13:Zt(i,t),en(t),t.child.flags&8192&&t.memoizedState!==null!=(r!==null&&r.memoizedState!==null)&&(Rr=It()),c&4&&(c=t.updateQueue,c!==null&&(t.updateQueue=null,Nr(t,c)));break;case 22:d=t.memoizedState!==null;var L=r!==null&&r.memoizedState!==null,Y=si,te=At;if(si=Y||d,At=te||L,Zt(i,t),At=te,si=Y,en(t),c&8192)e:for(i=t.stateNode,i._visibility=d?i._visibility&-2:i._visibility|1,d&&(r===null||L||si||At||bs(t)),r=null,i=t;;){if(i.tag===5||i.tag===26){if(r===null){L=r=i;try{if(m=L.stateNode,d)x=m.style,typeof x.setProperty=="function"?x.setProperty("display","none","important"):x.display="none";else{O=L.stateNode;var ie=L.memoizedProps.style,K=ie!=null&&ie.hasOwnProperty("display")?ie.display:null;O.style.display=K==null||typeof K=="boolean"?"":(""+K).trim()}}catch(me){Ve(L,L.return,me)}}}else if(i.tag===6){if(r===null){L=i;try{L.stateNode.nodeValue=d?"":L.memoizedProps}catch(me){Ve(L,L.return,me)}}}else if(i.tag===18){if(r===null){L=i;try{var J=L.stateNode;d?Rh(J,!0):Rh(L.stateNode,!1)}catch(me){Ve(L,L.return,me)}}}else if((i.tag!==22&&i.tag!==23||i.memoizedState===null||i===t)&&i.child!==null){i.child.return=i,i=i.child;continue}if(i===t)break e;for(;i.sibling===null;){if(i.return===null||i.return===t)break e;r===i&&(r=null),i=i.return}r===i&&(r=null),i.sibling.return=i.return,i=i.sibling}c&4&&(c=t.updateQueue,c!==null&&(r=c.retryQueue,r!==null&&(c.retryQueue=null,Nr(t,r))));break;case 19:Zt(i,t),en(t),c&4&&(c=t.updateQueue,c!==null&&(t.updateQueue=null,Nr(t,c)));break;case 30:break;case 21:break;default:Zt(i,t),en(t)}}function en(t){var i=t.flags;if(i&2){try{for(var r,c=t.return;c!==null;){if(Lp(c)){r=c;break}c=c.return}if(r==null)throw Error(o(160));switch(r.tag){case 27:var d=r.stateNode,m=xu(t);Or(t,m,d);break;case 5:var x=r.stateNode;r.flags&32&&($s(x,""),r.flags&=-33);var O=xu(t);Or(t,O,x);break;case 3:case 4:var L=r.stateNode.containerInfo,Y=xu(t);Au(t,Y,L);break;default:throw Error(o(161))}}catch(te){Ve(t,t.return,te)}t.flags&=-3}i&4096&&(t.flags&=-4097)}function zp(t){if(t.subtreeFlags&1024)for(t=t.child;t!==null;){var i=t;zp(i),i.tag===5&&i.flags&1024&&i.stateNode.reset(),t=t.sibling}}function oi(t,i){if(i.subtreeFlags&8772)for(i=i.child;i!==null;)Pp(t,i.alternate,i),i=i.sibling}function bs(t){for(t=t.child;t!==null;){var i=t;switch(i.tag){case 0:case 11:case 14:case 15:Ci(4,i,i.return),bs(i);break;case 1:$n(i,i.return);var r=i.stateNode;typeof r.componentWillUnmount=="function"&&Rp(i,i.return,r),bs(i);break;case 27:yo(i.stateNode);case 26:case 5:$n(i,i.return),bs(i);break;case 22:i.memoizedState===null&&bs(i);break;case 30:bs(i);break;default:bs(i)}t=t.sibling}}function ri(t,i,r){for(r=r&&(i.subtreeFlags&8772)!==0,i=i.child;i!==null;){var c=i.alternate,d=t,m=i,x=m.flags;switch(m.tag){case 0:case 11:case 15:ri(d,m,r),ao(4,m);break;case 1:if(ri(d,m,r),c=m,d=c.stateNode,typeof d.componentDidMount=="function")try{d.componentDidMount()}catch(Y){Ve(c,c.return,Y)}if(c=m,d=c.updateQueue,d!==null){var O=c.stateNode;try{var L=d.shared.hiddenCallbacks;if(L!==null)for(d.shared.hiddenCallbacks=null,d=0;d<L.length;d++)vm(L[d],O)}catch(Y){Ve(c,c.return,Y)}}r&&x&64&&kp(m),oo(m,m.return);break;case 27:Bp(m);case 26:case 5:ri(d,m,r),r&&c===null&&x&4&&Ip(m),oo(m,m.return);break;case 12:ri(d,m,r);break;case 31:ri(d,m,r),r&&x&4&&Up(d,m);break;case 13:ri(d,m,r),r&&x&4&&$p(d,m);break;case 22:m.memoizedState===null&&ri(d,m,r),oo(m,m.return);break;case 30:break;default:ri(d,m,r)}i=i.sibling}}function Eu(t,i){var r=null;t!==null&&t.memoizedState!==null&&t.memoizedState.cachePool!==null&&(r=t.memoizedState.cachePool.pool),t=null,i.memoizedState!==null&&i.memoizedState.cachePool!==null&&(t=i.memoizedState.cachePool.pool),t!==r&&(t!=null&&t.refCount++,r!=null&&Ka(r))}function _u(t,i){t=null,i.alternate!==null&&(t=i.alternate.memoizedState.cache),i=i.memoizedState.cache,i!==t&&(i.refCount++,t!=null&&Ka(t))}function On(t,i,r,c){if(i.subtreeFlags&10256)for(i=i.child;i!==null;)Vp(t,i,r,c),i=i.sibling}function Vp(t,i,r,c){var d=i.flags;switch(i.tag){case 0:case 11:case 15:On(t,i,r,c),d&2048&&ao(9,i);break;case 1:On(t,i,r,c);break;case 3:On(t,i,r,c),d&2048&&(t=null,i.alternate!==null&&(t=i.alternate.memoizedState.cache),i=i.memoizedState.cache,i!==t&&(i.refCount++,t!=null&&Ka(t)));break;case 12:if(d&2048){On(t,i,r,c),t=i.stateNode;try{var m=i.memoizedProps,x=m.id,O=m.onPostCommit;typeof O=="function"&&O(x,i.alternate===null?"mount":"update",t.passiveEffectDuration,-0)}catch(L){Ve(i,i.return,L)}}else On(t,i,r,c);break;case 31:On(t,i,r,c);break;case 13:On(t,i,r,c);break;case 23:break;case 22:m=i.stateNode,x=i.alternate,i.memoizedState!==null?m._visibility&2?On(t,i,r,c):ro(t,i):m._visibility&2?On(t,i,r,c):(m._visibility|=2,ra(t,i,r,c,(i.subtreeFlags&10256)!==0||!1)),d&2048&&Eu(x,i);break;case 24:On(t,i,r,c),d&2048&&_u(i.alternate,i);break;default:On(t,i,r,c)}}function ra(t,i,r,c,d){for(d=d&&((i.subtreeFlags&10256)!==0||!1),i=i.child;i!==null;){var m=t,x=i,O=r,L=c,Y=x.flags;switch(x.tag){case 0:case 11:case 15:ra(m,x,O,L,d),ao(8,x);break;case 23:break;case 22:var te=x.stateNode;x.memoizedState!==null?te._visibility&2?ra(m,x,O,L,d):ro(m,x):(te._visibility|=2,ra(m,x,O,L,d)),d&&Y&2048&&Eu(x.alternate,x);break;case 24:ra(m,x,O,L,d),d&&Y&2048&&_u(x.alternate,x);break;default:ra(m,x,O,L,d)}i=i.sibling}}function ro(t,i){if(i.subtreeFlags&10256)for(i=i.child;i!==null;){var r=t,c=i,d=c.flags;switch(c.tag){case 22:ro(r,c),d&2048&&Eu(c.alternate,c);break;case 24:ro(r,c),d&2048&&_u(c.alternate,c);break;default:ro(r,c)}i=i.sibling}}var lo=8192;function la(t,i,r){if(t.subtreeFlags&lo)for(t=t.child;t!==null;)Yp(t,i,r),t=t.sibling}function Yp(t,i,r){switch(t.tag){case 26:la(t,i,r),t.flags&lo&&t.memoizedState!==null&&WS(r,Cn,t.memoizedState,t.memoizedProps);break;case 5:la(t,i,r);break;case 3:case 4:var c=Cn;Cn=Vr(t.stateNode.containerInfo),la(t,i,r),Cn=c;break;case 22:t.memoizedState===null&&(c=t.alternate,c!==null&&c.memoizedState!==null?(c=lo,lo=16777216,la(t,i,r),lo=c):la(t,i,r));break;default:la(t,i,r)}}function Kp(t){var i=t.alternate;if(i!==null&&(t=i.child,t!==null)){i.child=null;do i=t.sibling,t.sibling=null,t=i;while(t!==null)}}function co(t){var i=t.deletions;if((t.flags&16)!==0){if(i!==null)for(var r=0;r<i.length;r++){var c=i[r];Rt=c,Wp(c,t)}Kp(t)}if(t.subtreeFlags&10256)for(t=t.child;t!==null;)Fp(t),t=t.sibling}function Fp(t){switch(t.tag){case 0:case 11:case 15:co(t),t.flags&2048&&Ci(9,t,t.return);break;case 3:co(t);break;case 12:co(t);break;case 22:var i=t.stateNode;t.memoizedState!==null&&i._visibility&2&&(t.return===null||t.return.tag!==13)?(i._visibility&=-3,kr(t)):co(t);break;default:co(t)}}function kr(t){var i=t.deletions;if((t.flags&16)!==0){if(i!==null)for(var r=0;r<i.length;r++){var c=i[r];Rt=c,Wp(c,t)}Kp(t)}for(t=t.child;t!==null;){switch(i=t,i.tag){case 0:case 11:case 15:Ci(8,i,i.return),kr(i);break;case 22:r=i.stateNode,r._visibility&2&&(r._visibility&=-3,kr(i));break;default:kr(i)}t=t.sibling}}function Wp(t,i){for(;Rt!==null;){var r=Rt;switch(r.tag){case 0:case 11:case 15:Ci(8,r,i);break;case 23:case 22:if(r.memoizedState!==null&&r.memoizedState.cachePool!==null){var c=r.memoizedState.cachePool.pool;c!=null&&c.refCount++}break;case 24:Ka(r.memoizedState.cache)}if(c=r.child,c!==null)c.return=r,Rt=c;else e:for(r=t;Rt!==null;){c=Rt;var d=c.sibling,m=c.return;if(jp(c),c===r){Rt=null;break e}if(d!==null){d.return=m,Rt=d;break e}Rt=m}}}var cS={getCacheForType:function(t){var i=Dt(St),r=i.data.get(t);return r===void 0&&(r=t(),i.data.set(t,r)),r},cacheSignal:function(){return Dt(St).controller.signal}},uS=typeof WeakMap=="function"?WeakMap:Map,De=0,Ge=null,ke=null,Le=0,ze=0,cn=null,Oi=!1,ca=!1,wu=!1,li=0,dt=0,Ni=0,Ss=0,Mu=0,un=0,ua=0,uo=null,tn=null,Cu=!1,Rr=0,Gp=0,Ir=1/0,Lr=null,ki=null,Ct=0,Ri=null,da=null,ci=0,Ou=0,Nu=null,Xp=null,fo=0,ku=null;function dn(){return(De&2)!==0&&Le!==0?Le&-Le:H.T!==null?Pu():Ra()}function Jp(){if(un===0)if((Le&536870912)===0||He){var t=rt;rt<<=1,(rt&3932160)===0&&(rt=262144),un=t}else un=536870912;return t=rn.current,t!==null&&(t.flags|=32),un}function nn(t,i,r){(t===Ge&&(ze===2||ze===9)||t.cancelPendingCommit!==null)&&(fa(t,0),Ii(t,Le,un,!1)),ns(t,r),((De&2)===0||t!==Ge)&&(t===Ge&&((De&2)===0&&(Ss|=r),dt===4&&Ii(t,Le,un,!1)),qn(t))}function Qp(t,i,r){if((De&6)!==0)throw Error(o(327));var c=!r&&(i&127)===0&&(i&t.expiredLanes)===0||ts(t,i),d=c?mS(t,i):Iu(t,i,!0),m=c;do{if(d===0){ca&&!c&&Ii(t,i,0,!1);break}else{if(r=t.current.alternate,m&&!dS(r)){d=Iu(t,i,!1),m=!1;continue}if(d===2){if(m=i,t.errorRecoveryDisabledLanes&m)var x=0;else x=t.pendingLanes&-536870913,x=x!==0?x:x&536870912?536870912:0;if(x!==0){i=x;e:{var O=t;d=uo;var L=O.current.memoizedState.isDehydrated;if(L&&(fa(O,x).flags|=256),x=Iu(O,x,!1),x!==2){if(wu&&!L){O.errorRecoveryDisabledLanes|=m,Ss|=m,d=4;break e}m=tn,tn=d,m!==null&&(tn===null?tn=m:tn.push.apply(tn,m))}d=x}if(m=!1,d!==2)continue}}if(d===1){fa(t,0),Ii(t,i,0,!0);break}e:{switch(c=t,m=d,m){case 0:case 1:throw Error(o(345));case 4:if((i&4194048)!==i)break;case 6:Ii(c,i,un,!Oi);break e;case 2:tn=null;break;case 3:case 5:break;default:throw Error(o(329))}if((i&62914560)===i&&(d=Rr+300-It(),10<d)){if(Ii(c,i,un,!Oi),yi(c,0,!0)!==0)break e;ci=i,c.timeoutHandle=Oh(Zp.bind(null,c,r,tn,Lr,Cu,i,un,Ss,ua,Oi,m,"Throttled",-0,0),d);break e}Zp(c,r,tn,Lr,Cu,i,un,Ss,ua,Oi,m,null,-0,0)}}break}while(!0);qn(t)}function Zp(t,i,r,c,d,m,x,O,L,Y,te,ie,K,J){if(t.timeoutHandle=-1,ie=i.subtreeFlags,ie&8192||(ie&16785408)===16785408){ie={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:Wn},Yp(i,m,ie);var me=(m&62914560)===m?Rr-It():(m&4194048)===m?Gp-It():0;if(me=GS(ie,me),me!==null){ci=m,t.cancelPendingCommit=me(rh.bind(null,t,i,m,r,c,d,x,O,L,te,ie,null,K,J)),Ii(t,m,x,!Y);return}}rh(t,i,m,r,c,d,x,O,L)}function dS(t){for(var i=t;;){var r=i.tag;if((r===0||r===11||r===15)&&i.flags&16384&&(r=i.updateQueue,r!==null&&(r=r.stores,r!==null)))for(var c=0;c<r.length;c++){var d=r[c],m=d.getSnapshot;d=d.value;try{if(!an(m(),d))return!1}catch{return!1}}if(r=i.child,i.subtreeFlags&16384&&r!==null)r.return=i,i=r;else{if(i===t)break;for(;i.sibling===null;){if(i.return===null||i.return===t)return!0;i=i.return}i.sibling.return=i.return,i=i.sibling}}return!0}function Ii(t,i,r,c){i&=~Mu,i&=~Ss,t.suspendedLanes|=i,t.pingedLanes&=~i,c&&(t.warmLanes|=i),c=t.expirationTimes;for(var d=i;0<d;){var m=31-pt(d),x=1<<m;c[m]=-1,d&=~x}r!==0&&Ht(t,r,i)}function Br(){return(De&6)===0?(mo(0),!1):!0}function Ru(){if(ke!==null){if(ze===0)var t=ke.return;else t=ke,Qn=us=null,Wc(t),na=null,Wa=0,t=ke;for(;t!==null;)Np(t.alternate,t),t=t.return;ke=null}}function fa(t,i){var r=t.timeoutHandle;r!==-1&&(t.timeoutHandle=-1,kS(r)),r=t.cancelPendingCommit,r!==null&&(t.cancelPendingCommit=null,r()),ci=0,Ru(),Ge=t,ke=r=Xn(t.current,null),Le=i,ze=0,cn=null,Oi=!1,ca=ts(t,i),wu=!1,ua=un=Mu=Ss=Ni=dt=0,tn=uo=null,Cu=!1,(i&8)!==0&&(i|=i&32);var c=t.entangledLanes;if(c!==0)for(t=t.entanglements,c&=i;0<c;){var d=31-pt(c),m=1<<d;i|=t[d],c&=~m}return li=i,nr(),r}function eh(t,i){we=null,H.H=no,i===ta||i===ur?(i=ym(),ze=3):i===Hc?(i=ym(),ze=4):ze=i===uu?8:i!==null&&typeof i=="object"&&typeof i.then=="function"?6:1,cn=i,ke===null&&(dt=1,Er(t,yn(i,t.current)))}function th(){var t=rn.current;return t===null?!0:(Le&4194048)===Le?vn===null:(Le&62914560)===Le||(Le&536870912)!==0?t===vn:!1}function nh(){var t=H.H;return H.H=no,t===null?no:t}function ih(){var t=H.A;return H.A=cS,t}function Hr(){dt=4,Oi||(Le&4194048)!==Le&&rn.current!==null||(ca=!0),(Ni&134217727)===0&&(Ss&134217727)===0||Ge===null||Ii(Ge,Le,un,!1)}function Iu(t,i,r){var c=De;De|=2;var d=nh(),m=ih();(Ge!==t||Le!==i)&&(Lr=null,fa(t,i)),i=!1;var x=dt;e:do try{if(ze!==0&&ke!==null){var O=ke,L=cn;switch(ze){case 8:Ru(),x=6;break e;case 3:case 2:case 9:case 6:rn.current===null&&(i=!0);var Y=ze;if(ze=0,cn=null,ma(t,O,L,Y),r&&ca){x=0;break e}break;default:Y=ze,ze=0,cn=null,ma(t,O,L,Y)}}fS(),x=dt;break}catch(te){eh(t,te)}while(!0);return i&&t.shellSuspendCounter++,Qn=us=null,De=c,H.H=d,H.A=m,ke===null&&(Ge=null,Le=0,nr()),x}function fS(){for(;ke!==null;)sh(ke)}function mS(t,i){var r=De;De|=2;var c=nh(),d=ih();Ge!==t||Le!==i?(Lr=null,Ir=It()+500,fa(t,i)):ca=ts(t,i);e:do try{if(ze!==0&&ke!==null){i=ke;var m=cn;t:switch(ze){case 1:ze=0,cn=null,ma(t,i,m,1);break;case 2:case 9:if(pm(m)){ze=0,cn=null,ah(i);break}i=function(){ze!==2&&ze!==9||Ge!==t||(ze=7),qn(t)},m.then(i,i);break e;case 3:ze=7;break e;case 4:ze=5;break e;case 7:pm(m)?(ze=0,cn=null,ah(i)):(ze=0,cn=null,ma(t,i,m,7));break;case 5:var x=null;switch(ke.tag){case 26:x=ke.memoizedState;case 5:case 27:var O=ke;if(x?Vh(x):O.stateNode.complete){ze=0,cn=null;var L=O.sibling;if(L!==null)ke=L;else{var Y=O.return;Y!==null?(ke=Y,Pr(Y)):ke=null}break t}}ze=0,cn=null,ma(t,i,m,5);break;case 6:ze=0,cn=null,ma(t,i,m,6);break;case 8:Ru(),dt=6;break e;default:throw Error(o(462))}}pS();break}catch(te){eh(t,te)}while(!0);return Qn=us=null,H.H=c,H.A=d,De=r,ke!==null?0:(Ge=null,Le=0,nr(),dt)}function pS(){for(;ke!==null&&!_a();)sh(ke)}function sh(t){var i=Cp(t.alternate,t,li);t.memoizedProps=t.pendingProps,i===null?Pr(t):ke=i}function ah(t){var i=t,r=i.alternate;switch(i.tag){case 15:case 0:i=Ap(r,i,i.pendingProps,i.type,void 0,Le);break;case 11:i=Ap(r,i,i.pendingProps,i.type.render,i.ref,Le);break;case 5:Wc(i);default:Np(r,i),i=ke=im(i,li),i=Cp(r,i,li)}t.memoizedProps=t.pendingProps,i===null?Pr(t):ke=i}function ma(t,i,r,c){Qn=us=null,Wc(i),na=null,Wa=0;var d=i.return;try{if(nS(t,d,i,r,Le)){dt=1,Er(t,yn(r,t.current)),ke=null;return}}catch(m){if(d!==null)throw ke=d,m;dt=1,Er(t,yn(r,t.current)),ke=null;return}i.flags&32768?(He||c===1?t=!0:ca||(Le&536870912)!==0?t=!1:(Oi=t=!0,(c===2||c===9||c===3||c===6)&&(c=rn.current,c!==null&&c.tag===13&&(c.flags|=16384))),oh(i,t)):Pr(i)}function Pr(t){var i=t;do{if((i.flags&32768)!==0){oh(i,Oi);return}t=i.return;var r=aS(i.alternate,i,li);if(r!==null){ke=r;return}if(i=i.sibling,i!==null){ke=i;return}ke=i=t}while(i!==null);dt===0&&(dt=5)}function oh(t,i){do{var r=oS(t.alternate,t);if(r!==null){r.flags&=32767,ke=r;return}if(r=t.return,r!==null&&(r.flags|=32768,r.subtreeFlags=0,r.deletions=null),!i&&(t=t.sibling,t!==null)){ke=t;return}ke=t=r}while(t!==null);dt=6,ke=null}function rh(t,i,r,c,d,m,x,O,L){t.cancelPendingCommit=null;do jr();while(Ct!==0);if((De&6)!==0)throw Error(o(327));if(i!==null){if(i===t.current)throw Error(o(177));if(m=i.lanes|i.childLanes,m|=xc,Gt(t,r,m,x,O,L),t===Ge&&(ke=Ge=null,Le=0),da=i,Ri=t,ci=r,Ou=m,Nu=d,Xp=c,(i.subtreeFlags&10256)!==0||(i.flags&10256)!==0?(t.callbackNode=null,t.callbackPriority=0,bS(Yn,function(){return fh(),null})):(t.callbackNode=null,t.callbackPriority=0),c=(i.flags&13878)!==0,(i.subtreeFlags&13878)!==0||c){c=H.T,H.T=null,d=z.p,z.p=2,x=De,De|=4;try{rS(t,i,r)}finally{De=x,z.p=d,H.T=c}}Ct=1,lh(),ch(),uh()}}function lh(){if(Ct===1){Ct=0;var t=Ri,i=da,r=(i.flags&13878)!==0;if((i.subtreeFlags&13878)!==0||r){r=H.T,H.T=null;var c=z.p;z.p=2;var d=De;De|=4;try{qp(i,t);var m=Yu,x=Wf(t.containerInfo),O=m.focusedElem,L=m.selectionRange;if(x!==O&&O&&O.ownerDocument&&Ff(O.ownerDocument.documentElement,O)){if(L!==null&&yc(O)){var Y=L.start,te=L.end;if(te===void 0&&(te=Y),"selectionStart"in O)O.selectionStart=Y,O.selectionEnd=Math.min(te,O.value.length);else{var ie=O.ownerDocument||document,K=ie&&ie.defaultView||window;if(K.getSelection){var J=K.getSelection(),me=O.textContent.length,ve=Math.min(L.start,me),We=L.end===void 0?ve:Math.min(L.end,me);!J.extend&&ve>We&&(x=We,We=ve,ve=x);var U=Kf(O,ve),P=Kf(O,We);if(U&&P&&(J.rangeCount!==1||J.anchorNode!==U.node||J.anchorOffset!==U.offset||J.focusNode!==P.node||J.focusOffset!==P.offset)){var V=ie.createRange();V.setStart(U.node,U.offset),J.removeAllRanges(),ve>We?(J.addRange(V),J.extend(P.node,P.offset)):(V.setEnd(P.node,P.offset),J.addRange(V))}}}}for(ie=[],J=O;J=J.parentNode;)J.nodeType===1&&ie.push({element:J,left:J.scrollLeft,top:J.scrollTop});for(typeof O.focus=="function"&&O.focus(),O=0;O<ie.length;O++){var ne=ie[O];ne.element.scrollLeft=ne.left,ne.element.scrollTop=ne.top}}Xr=!!Vu,Yu=Vu=null}finally{De=d,z.p=c,H.T=r}}t.current=i,Ct=2}}function ch(){if(Ct===2){Ct=0;var t=Ri,i=da,r=(i.flags&8772)!==0;if((i.subtreeFlags&8772)!==0||r){r=H.T,H.T=null;var c=z.p;z.p=2;var d=De;De|=4;try{Pp(t,i.alternate,i)}finally{De=d,z.p=c,H.T=r}}Ct=3}}function uh(){if(Ct===4||Ct===3){Ct=0,Os();var t=Ri,i=da,r=ci,c=Xp;(i.subtreeFlags&10256)!==0||(i.flags&10256)!==0?Ct=5:(Ct=0,da=Ri=null,dh(t,t.pendingLanes));var d=t.pendingLanes;if(d===0&&(ki=null),Ls(r),i=i.stateNode,Lt&&typeof Lt.onCommitFiberRoot=="function")try{Lt.onCommitFiberRoot(Kn,i,void 0,(i.current.flags&128)===128)}catch{}if(c!==null){i=H.T,d=z.p,z.p=2,H.T=null;try{for(var m=t.onRecoverableError,x=0;x<c.length;x++){var O=c[x];m(O.value,{componentStack:O.stack})}}finally{H.T=i,z.p=d}}(ci&3)!==0&&jr(),qn(t),d=t.pendingLanes,(r&261930)!==0&&(d&42)!==0?t===ku?fo++:(fo=0,ku=t):fo=0,mo(0)}}function dh(t,i){(t.pooledCacheLanes&=i)===0&&(i=t.pooledCache,i!=null&&(t.pooledCache=null,Ka(i)))}function jr(){return lh(),ch(),uh(),fh()}function fh(){if(Ct!==5)return!1;var t=Ri,i=Ou;Ou=0;var r=Ls(ci),c=H.T,d=z.p;try{z.p=32>r?32:r,H.T=null,r=Nu,Nu=null;var m=Ri,x=ci;if(Ct=0,da=Ri=null,ci=0,(De&6)!==0)throw Error(o(331));var O=De;if(De|=4,Fp(m.current),Vp(m,m.current,x,r),De=O,mo(0,!1),Lt&&typeof Lt.onPostCommitFiberRoot=="function")try{Lt.onPostCommitFiberRoot(Kn,m)}catch{}return!0}finally{z.p=d,H.T=c,dh(t,i)}}function mh(t,i,r){i=yn(r,i),i=cu(t.stateNode,i,2),t=_i(t,i,2),t!==null&&(ns(t,2),qn(t))}function Ve(t,i,r){if(t.tag===3)mh(t,t,r);else for(;i!==null;){if(i.tag===3){mh(i,t,r);break}else if(i.tag===1){var c=i.stateNode;if(typeof i.type.getDerivedStateFromError=="function"||typeof c.componentDidCatch=="function"&&(ki===null||!ki.has(c))){t=yn(r,t),r=pp(2),c=_i(i,r,2),c!==null&&(hp(r,c,i,t),ns(c,2),qn(c));break}}i=i.return}}function Lu(t,i,r){var c=t.pingCache;if(c===null){c=t.pingCache=new uS;var d=new Set;c.set(i,d)}else d=c.get(i),d===void 0&&(d=new Set,c.set(i,d));d.has(r)||(wu=!0,d.add(r),t=hS.bind(null,t,i,r),i.then(t,t))}function hS(t,i,r){var c=t.pingCache;c!==null&&c.delete(i),t.pingedLanes|=t.suspendedLanes&r,t.warmLanes&=~r,Ge===t&&(Le&r)===r&&(dt===4||dt===3&&(Le&62914560)===Le&&300>It()-Rr?(De&2)===0&&fa(t,0):Mu|=r,ua===Le&&(ua=0)),qn(t)}function ph(t,i){i===0&&(i=Na()),t=rs(t,i),t!==null&&(ns(t,i),qn(t))}function yS(t){var i=t.memoizedState,r=0;i!==null&&(r=i.retryLane),ph(t,r)}function gS(t,i){var r=0;switch(t.tag){case 31:case 13:var c=t.stateNode,d=t.memoizedState;d!==null&&(r=d.retryLane);break;case 19:c=t.stateNode;break;case 22:c=t.stateNode._retryCache;break;default:throw Error(o(314))}c!==null&&c.delete(i),ph(t,r)}function bS(t,i){return jn(t,i)}var Dr=null,pa=null,Bu=!1,Ur=!1,Hu=!1,Li=0;function qn(t){t!==pa&&t.next===null&&(pa===null?Dr=pa=t:pa=pa.next=t),Ur=!0,Bu||(Bu=!0,vS())}function mo(t,i){if(!Hu&&Ur){Hu=!0;do for(var r=!1,c=Dr;c!==null;){if(t!==0){var d=c.pendingLanes;if(d===0)var m=0;else{var x=c.suspendedLanes,O=c.pingedLanes;m=(1<<31-pt(42|t)+1)-1,m&=d&~(x&~O),m=m&201326741?m&201326741|1:m?m|2:0}m!==0&&(r=!0,bh(c,m))}else m=Le,m=yi(c,c===Ge?m:0,c.cancelPendingCommit!==null||c.timeoutHandle!==-1),(m&3)===0||ts(c,m)||(r=!0,bh(c,m));c=c.next}while(r);Hu=!1}}function SS(){hh()}function hh(){Ur=Bu=!1;var t=0;Li!==0&&NS()&&(t=Li);for(var i=It(),r=null,c=Dr;c!==null;){var d=c.next,m=yh(c,i);m===0?(c.next=null,r===null?Dr=d:r.next=d,d===null&&(pa=r)):(r=c,(t!==0||(m&3)!==0)&&(Ur=!0)),c=d}Ct!==0&&Ct!==5||mo(t),Li!==0&&(Li=0)}function yh(t,i){for(var r=t.suspendedLanes,c=t.pingedLanes,d=t.expirationTimes,m=t.pendingLanes&-62914561;0<m;){var x=31-pt(m),O=1<<x,L=d[x];L===-1?((O&r)===0||(O&c)!==0)&&(d[x]=Jl(O,i)):L<=i&&(t.expiredLanes|=O),m&=~O}if(i=Ge,r=Le,r=yi(t,t===i?r:0,t.cancelPendingCommit!==null||t.timeoutHandle!==-1),c=t.callbackNode,r===0||t===i&&(ze===2||ze===9)||t.cancelPendingCommit!==null)return c!==null&&c!==null&&Qi(c),t.callbackNode=null,t.callbackPriority=0;if((r&3)===0||ts(t,r)){if(i=r&-r,i===t.callbackPriority)return i;switch(c!==null&&Qi(c),Ls(r)){case 2:case 8:r=ks;break;case 32:r=Yn;break;case 268435456:r=es;break;default:r=Yn}return c=gh.bind(null,t),r=jn(r,c),t.callbackPriority=i,t.callbackNode=r,i}return c!==null&&c!==null&&Qi(c),t.callbackPriority=2,t.callbackNode=null,2}function gh(t,i){if(Ct!==0&&Ct!==5)return t.callbackNode=null,t.callbackPriority=0,null;var r=t.callbackNode;if(jr()&&t.callbackNode!==r)return null;var c=Le;return c=yi(t,t===Ge?c:0,t.cancelPendingCommit!==null||t.timeoutHandle!==-1),c===0?null:(Qp(t,c,i),yh(t,It()),t.callbackNode!=null&&t.callbackNode===r?gh.bind(null,t):null)}function bh(t,i){if(jr())return null;Qp(t,i,!0)}function vS(){RS(function(){(De&6)!==0?jn(Ns,SS):hh()})}function Pu(){if(Li===0){var t=Zs;t===0&&(t=Bt,Bt<<=1,(Bt&261888)===0&&(Bt=256)),Li=t}return Li}function Sh(t){return t==null||typeof t=="symbol"||typeof t=="boolean"?null:typeof t=="function"?t:Wo(""+t)}function vh(t,i){var r=i.ownerDocument.createElement("input");return r.name=i.name,r.value=i.value,t.id&&r.setAttribute("form",t.id),i.parentNode.insertBefore(r,i),t=new FormData(t),r.parentNode.removeChild(r),t}function xS(t,i,r,c,d){if(i==="submit"&&r&&r.stateNode===d){var m=Sh((d[Xt]||null).action),x=c.submitter;x&&(i=(i=x[Xt]||null)?Sh(i.formAction):x.getAttribute("formAction"),i!==null&&(m=i,x=null));var O=new Qo("action","action",null,c,d);t.push({event:O,listeners:[{instance:null,listener:function(){if(c.defaultPrevented){if(Li!==0){var L=x?vh(d,x):new FormData(d);iu(r,{pending:!0,data:L,method:d.method,action:m},null,L)}}else typeof m=="function"&&(O.preventDefault(),L=x?vh(d,x):new FormData(d),iu(r,{pending:!0,data:L,method:d.method,action:m},m,L))},currentTarget:d}]})}}for(var ju=0;ju<vc.length;ju++){var Du=vc[ju],AS=Du.toLowerCase(),TS=Du[0].toUpperCase()+Du.slice(1);Mn(AS,"on"+TS)}Mn(Jf,"onAnimationEnd"),Mn(Qf,"onAnimationIteration"),Mn(Zf,"onAnimationStart"),Mn("dblclick","onDoubleClick"),Mn("focusin","onFocus"),Mn("focusout","onBlur"),Mn(Db,"onTransitionRun"),Mn(Ub,"onTransitionStart"),Mn($b,"onTransitionCancel"),Mn(em,"onTransitionEnd"),Ds("onMouseEnter",["mouseout","mouseover"]),Ds("onMouseLeave",["mouseout","mouseover"]),Ds("onPointerEnter",["pointerout","pointerover"]),Ds("onPointerLeave",["pointerout","pointerover"]),is("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),is("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),is("onBeforeInput",["compositionend","keypress","textInput","paste"]),is("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),is("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),is("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var po="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),ES=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(po));function xh(t,i){i=(i&4)!==0;for(var r=0;r<t.length;r++){var c=t[r],d=c.event;c=c.listeners;e:{var m=void 0;if(i)for(var x=c.length-1;0<=x;x--){var O=c[x],L=O.instance,Y=O.currentTarget;if(O=O.listener,L!==m&&d.isPropagationStopped())break e;m=O,d.currentTarget=Y;try{m(d)}catch(te){tr(te)}d.currentTarget=null,m=L}else for(x=0;x<c.length;x++){if(O=c[x],L=O.instance,Y=O.currentTarget,O=O.listener,L!==m&&d.isPropagationStopped())break e;m=O,d.currentTarget=Y;try{m(d)}catch(te){tr(te)}d.currentTarget=null,m=L}}}}function Re(t,i){var r=i[Ql];r===void 0&&(r=i[Ql]=new Set);var c=t+"__bubble";r.has(c)||(Ah(i,t,2,!1),r.add(c))}function Uu(t,i,r){var c=0;i&&(c|=4),Ah(r,t,c,i)}var $r="_reactListening"+Math.random().toString(36).slice(2);function $u(t){if(!t[$r]){t[$r]=!0,hf.forEach(function(r){r!=="selectionchange"&&(ES.has(r)||Uu(r,!1,t),Uu(r,!0,t))});var i=t.nodeType===9?t:t.ownerDocument;i===null||i[$r]||(i[$r]=!0,Uu("selectionchange",!1,i))}}function Ah(t,i,r,c){switch(Jh(i)){case 2:var d=QS;break;case 8:d=ZS;break;default:d=nd}r=d.bind(null,i,r,t),d=void 0,!rc||i!=="touchstart"&&i!=="touchmove"&&i!=="wheel"||(d=!0),c?d!==void 0?t.addEventListener(i,r,{capture:!0,passive:d}):t.addEventListener(i,r,!0):d!==void 0?t.addEventListener(i,r,{passive:d}):t.addEventListener(i,r,!1)}function qu(t,i,r,c,d){var m=c;if((i&1)===0&&(i&2)===0&&c!==null)e:for(;;){if(c===null)return;var x=c.tag;if(x===3||x===4){var O=c.stateNode.containerInfo;if(O===d)break;if(x===4)for(x=c.return;x!==null;){var L=x.tag;if((L===3||L===4)&&x.stateNode.containerInfo===d)return;x=x.return}for(;O!==null;){if(x=Hs(O),x===null)return;if(L=x.tag,L===5||L===6||L===26||L===27){c=m=x;continue e}O=O.parentNode}}c=c.return}Mf(function(){var Y=m,te=ac(r),ie=[];e:{var K=tm.get(t);if(K!==void 0){var J=Qo,me=t;switch(t){case"keypress":if(Xo(r)===0)break e;case"keydown":case"keyup":J=gb;break;case"focusin":me="focus",J=dc;break;case"focusout":me="blur",J=dc;break;case"beforeblur":case"afterblur":J=dc;break;case"click":if(r.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":J=Nf;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":J=ab;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":J=vb;break;case Jf:case Qf:case Zf:J=lb;break;case em:J=Ab;break;case"scroll":case"scrollend":J=ib;break;case"wheel":J=Eb;break;case"copy":case"cut":case"paste":J=ub;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":J=Rf;break;case"toggle":case"beforetoggle":J=wb}var ve=(i&4)!==0,We=!ve&&(t==="scroll"||t==="scrollend"),U=ve?K!==null?K+"Capture":null:K;ve=[];for(var P=Y,V;P!==null;){var ne=P;if(V=ne.stateNode,ne=ne.tag,ne!==5&&ne!==26&&ne!==27||V===null||U===null||(ne=Ba(P,U),ne!=null&&ve.push(ho(P,ne,V))),We)break;P=P.return}0<ve.length&&(K=new J(K,me,null,r,te),ie.push({event:K,listeners:ve}))}}if((i&7)===0){e:{if(K=t==="mouseover"||t==="pointerover",J=t==="mouseout"||t==="pointerout",K&&r!==sc&&(me=r.relatedTarget||r.fromElement)&&(Hs(me)||me[Bs]))break e;if((J||K)&&(K=te.window===te?te:(K=te.ownerDocument)?K.defaultView||K.parentWindow:window,J?(me=r.relatedTarget||r.toElement,J=Y,me=me?Hs(me):null,me!==null&&(We=l(me),ve=me.tag,me!==We||ve!==5&&ve!==27&&ve!==6)&&(me=null)):(J=null,me=Y),J!==me)){if(ve=Nf,ne="onMouseLeave",U="onMouseEnter",P="mouse",(t==="pointerout"||t==="pointerover")&&(ve=Rf,ne="onPointerLeave",U="onPointerEnter",P="pointer"),We=J==null?K:La(J),V=me==null?K:La(me),K=new ve(ne,P+"leave",J,r,te),K.target=We,K.relatedTarget=V,ne=null,Hs(te)===Y&&(ve=new ve(U,P+"enter",me,r,te),ve.target=V,ve.relatedTarget=We,ne=ve),We=ne,J&&me)t:{for(ve=_S,U=J,P=me,V=0,ne=U;ne;ne=ve(ne))V++;ne=0;for(var Se=P;Se;Se=ve(Se))ne++;for(;0<V-ne;)U=ve(U),V--;for(;0<ne-V;)P=ve(P),ne--;for(;V--;){if(U===P||P!==null&&U===P.alternate){ve=U;break t}U=ve(U),P=ve(P)}ve=null}else ve=null;J!==null&&Th(ie,K,J,ve,!1),me!==null&&We!==null&&Th(ie,We,me,ve,!0)}}e:{if(K=Y?La(Y):window,J=K.nodeName&&K.nodeName.toLowerCase(),J==="select"||J==="input"&&K.type==="file")var Pe=Uf;else if(jf(K))if($f)Pe=Hb;else{Pe=Lb;var ge=Ib}else J=K.nodeName,!J||J.toLowerCase()!=="input"||K.type!=="checkbox"&&K.type!=="radio"?Y&&ic(Y.elementType)&&(Pe=Uf):Pe=Bb;if(Pe&&(Pe=Pe(t,Y))){Df(ie,Pe,r,te);break e}ge&&ge(t,K,Y),t==="focusout"&&Y&&K.type==="number"&&Y.memoizedProps.value!=null&&nc(K,"number",K.value)}switch(ge=Y?La(Y):window,t){case"focusin":(jf(ge)||ge.contentEditable==="true")&&(Ys=ge,gc=Y,za=null);break;case"focusout":za=gc=Ys=null;break;case"mousedown":bc=!0;break;case"contextmenu":case"mouseup":case"dragend":bc=!1,Gf(ie,r,te);break;case"selectionchange":if(jb)break;case"keydown":case"keyup":Gf(ie,r,te)}var Ce;if(mc)e:{switch(t){case"compositionstart":var Be="onCompositionStart";break e;case"compositionend":Be="onCompositionEnd";break e;case"compositionupdate":Be="onCompositionUpdate";break e}Be=void 0}else Vs?Hf(t,r)&&(Be="onCompositionEnd"):t==="keydown"&&r.keyCode===229&&(Be="onCompositionStart");Be&&(If&&r.locale!=="ko"&&(Vs||Be!=="onCompositionStart"?Be==="onCompositionEnd"&&Vs&&(Ce=Cf()):(bi=te,lc="value"in bi?bi.value:bi.textContent,Vs=!0)),ge=qr(Y,Be),0<ge.length&&(Be=new kf(Be,t,null,r,te),ie.push({event:Be,listeners:ge}),Ce?Be.data=Ce:(Ce=Pf(r),Ce!==null&&(Be.data=Ce)))),(Ce=Cb?Ob(t,r):Nb(t,r))&&(Be=qr(Y,"onBeforeInput"),0<Be.length&&(ge=new kf("onBeforeInput","beforeinput",null,r,te),ie.push({event:ge,listeners:Be}),ge.data=Ce)),xS(ie,t,Y,r,te)}xh(ie,i)})}function ho(t,i,r){return{instance:t,listener:i,currentTarget:r}}function qr(t,i){for(var r=i+"Capture",c=[];t!==null;){var d=t,m=d.stateNode;if(d=d.tag,d!==5&&d!==26&&d!==27||m===null||(d=Ba(t,r),d!=null&&c.unshift(ho(t,d,m)),d=Ba(t,i),d!=null&&c.push(ho(t,d,m))),t.tag===3)return c;t=t.return}return[]}function _S(t){if(t===null)return null;do t=t.return;while(t&&t.tag!==5&&t.tag!==27);return t||null}function Th(t,i,r,c,d){for(var m=i._reactName,x=[];r!==null&&r!==c;){var O=r,L=O.alternate,Y=O.stateNode;if(O=O.tag,L!==null&&L===c)break;O!==5&&O!==26&&O!==27||Y===null||(L=Y,d?(Y=Ba(r,m),Y!=null&&x.unshift(ho(r,Y,L))):d||(Y=Ba(r,m),Y!=null&&x.push(ho(r,Y,L)))),r=r.return}x.length!==0&&t.push({event:i,listeners:x})}var wS=/\r\n?/g,MS=/\u0000|\uFFFD/g;function Eh(t){return(typeof t=="string"?t:""+t).replace(wS,`
`).replace(MS,"")}function _h(t,i){return i=Eh(i),Eh(t)===i}function Fe(t,i,r,c,d,m){switch(r){case"children":typeof c=="string"?i==="body"||i==="textarea"&&c===""||$s(t,c):(typeof c=="number"||typeof c=="bigint")&&i!=="body"&&$s(t,""+c);break;case"className":Ko(t,"class",c);break;case"tabIndex":Ko(t,"tabindex",c);break;case"dir":case"role":case"viewBox":case"width":case"height":Ko(t,r,c);break;case"style":_f(t,c,m);break;case"data":if(i!=="object"){Ko(t,"data",c);break}case"src":case"href":if(c===""&&(i!=="a"||r!=="href")){t.removeAttribute(r);break}if(c==null||typeof c=="function"||typeof c=="symbol"||typeof c=="boolean"){t.removeAttribute(r);break}c=Wo(""+c),t.setAttribute(r,c);break;case"action":case"formAction":if(typeof c=="function"){t.setAttribute(r,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof m=="function"&&(r==="formAction"?(i!=="input"&&Fe(t,i,"name",d.name,d,null),Fe(t,i,"formEncType",d.formEncType,d,null),Fe(t,i,"formMethod",d.formMethod,d,null),Fe(t,i,"formTarget",d.formTarget,d,null)):(Fe(t,i,"encType",d.encType,d,null),Fe(t,i,"method",d.method,d,null),Fe(t,i,"target",d.target,d,null)));if(c==null||typeof c=="symbol"||typeof c=="boolean"){t.removeAttribute(r);break}c=Wo(""+c),t.setAttribute(r,c);break;case"onClick":c!=null&&(t.onclick=Wn);break;case"onScroll":c!=null&&Re("scroll",t);break;case"onScrollEnd":c!=null&&Re("scrollend",t);break;case"dangerouslySetInnerHTML":if(c!=null){if(typeof c!="object"||!("__html"in c))throw Error(o(61));if(r=c.__html,r!=null){if(d.children!=null)throw Error(o(60));t.innerHTML=r}}break;case"multiple":t.multiple=c&&typeof c!="function"&&typeof c!="symbol";break;case"muted":t.muted=c&&typeof c!="function"&&typeof c!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(c==null||typeof c=="function"||typeof c=="boolean"||typeof c=="symbol"){t.removeAttribute("xlink:href");break}r=Wo(""+c),t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",r);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":c!=null&&typeof c!="function"&&typeof c!="symbol"?t.setAttribute(r,""+c):t.removeAttribute(r);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":c&&typeof c!="function"&&typeof c!="symbol"?t.setAttribute(r,""):t.removeAttribute(r);break;case"capture":case"download":c===!0?t.setAttribute(r,""):c!==!1&&c!=null&&typeof c!="function"&&typeof c!="symbol"?t.setAttribute(r,c):t.removeAttribute(r);break;case"cols":case"rows":case"size":case"span":c!=null&&typeof c!="function"&&typeof c!="symbol"&&!isNaN(c)&&1<=c?t.setAttribute(r,c):t.removeAttribute(r);break;case"rowSpan":case"start":c==null||typeof c=="function"||typeof c=="symbol"||isNaN(c)?t.removeAttribute(r):t.setAttribute(r,c);break;case"popover":Re("beforetoggle",t),Re("toggle",t),Yo(t,"popover",c);break;case"xlinkActuate":Fn(t,"http://www.w3.org/1999/xlink","xlink:actuate",c);break;case"xlinkArcrole":Fn(t,"http://www.w3.org/1999/xlink","xlink:arcrole",c);break;case"xlinkRole":Fn(t,"http://www.w3.org/1999/xlink","xlink:role",c);break;case"xlinkShow":Fn(t,"http://www.w3.org/1999/xlink","xlink:show",c);break;case"xlinkTitle":Fn(t,"http://www.w3.org/1999/xlink","xlink:title",c);break;case"xlinkType":Fn(t,"http://www.w3.org/1999/xlink","xlink:type",c);break;case"xmlBase":Fn(t,"http://www.w3.org/XML/1998/namespace","xml:base",c);break;case"xmlLang":Fn(t,"http://www.w3.org/XML/1998/namespace","xml:lang",c);break;case"xmlSpace":Fn(t,"http://www.w3.org/XML/1998/namespace","xml:space",c);break;case"is":Yo(t,"is",c);break;case"innerText":case"textContent":break;default:(!(2<r.length)||r[0]!=="o"&&r[0]!=="O"||r[1]!=="n"&&r[1]!=="N")&&(r=tb.get(r)||r,Yo(t,r,c))}}function zu(t,i,r,c,d,m){switch(r){case"style":_f(t,c,m);break;case"dangerouslySetInnerHTML":if(c!=null){if(typeof c!="object"||!("__html"in c))throw Error(o(61));if(r=c.__html,r!=null){if(d.children!=null)throw Error(o(60));t.innerHTML=r}}break;case"children":typeof c=="string"?$s(t,c):(typeof c=="number"||typeof c=="bigint")&&$s(t,""+c);break;case"onScroll":c!=null&&Re("scroll",t);break;case"onScrollEnd":c!=null&&Re("scrollend",t);break;case"onClick":c!=null&&(t.onclick=Wn);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!yf.hasOwnProperty(r))e:{if(r[0]==="o"&&r[1]==="n"&&(d=r.endsWith("Capture"),i=r.slice(2,d?r.length-7:void 0),m=t[Xt]||null,m=m!=null?m[r]:null,typeof m=="function"&&t.removeEventListener(i,m,d),typeof c=="function")){typeof m!="function"&&m!==null&&(r in t?t[r]=null:t.hasAttribute(r)&&t.removeAttribute(r)),t.addEventListener(i,c,d);break e}r in t?t[r]=c:c===!0?t.setAttribute(r,""):Yo(t,r,c)}}}function $t(t,i,r){switch(i){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":Re("error",t),Re("load",t);var c=!1,d=!1,m;for(m in r)if(r.hasOwnProperty(m)){var x=r[m];if(x!=null)switch(m){case"src":c=!0;break;case"srcSet":d=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(o(137,i));default:Fe(t,i,m,x,r,null)}}d&&Fe(t,i,"srcSet",r.srcSet,r,null),c&&Fe(t,i,"src",r.src,r,null);return;case"input":Re("invalid",t);var O=m=x=d=null,L=null,Y=null;for(c in r)if(r.hasOwnProperty(c)){var te=r[c];if(te!=null)switch(c){case"name":d=te;break;case"type":x=te;break;case"checked":L=te;break;case"defaultChecked":Y=te;break;case"value":m=te;break;case"defaultValue":O=te;break;case"children":case"dangerouslySetInnerHTML":if(te!=null)throw Error(o(137,i));break;default:Fe(t,i,c,te,r,null)}}xf(t,m,O,L,Y,x,d,!1);return;case"select":Re("invalid",t),c=x=m=null;for(d in r)if(r.hasOwnProperty(d)&&(O=r[d],O!=null))switch(d){case"value":m=O;break;case"defaultValue":x=O;break;case"multiple":c=O;default:Fe(t,i,d,O,r,null)}i=m,r=x,t.multiple=!!c,i!=null?Us(t,!!c,i,!1):r!=null&&Us(t,!!c,r,!0);return;case"textarea":Re("invalid",t),m=d=c=null;for(x in r)if(r.hasOwnProperty(x)&&(O=r[x],O!=null))switch(x){case"value":c=O;break;case"defaultValue":d=O;break;case"children":m=O;break;case"dangerouslySetInnerHTML":if(O!=null)throw Error(o(91));break;default:Fe(t,i,x,O,r,null)}Tf(t,c,d,m);return;case"option":for(L in r)r.hasOwnProperty(L)&&(c=r[L],c!=null)&&(L==="selected"?t.selected=c&&typeof c!="function"&&typeof c!="symbol":Fe(t,i,L,c,r,null));return;case"dialog":Re("beforetoggle",t),Re("toggle",t),Re("cancel",t),Re("close",t);break;case"iframe":case"object":Re("load",t);break;case"video":case"audio":for(c=0;c<po.length;c++)Re(po[c],t);break;case"image":Re("error",t),Re("load",t);break;case"details":Re("toggle",t);break;case"embed":case"source":case"link":Re("error",t),Re("load",t);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(Y in r)if(r.hasOwnProperty(Y)&&(c=r[Y],c!=null))switch(Y){case"children":case"dangerouslySetInnerHTML":throw Error(o(137,i));default:Fe(t,i,Y,c,r,null)}return;default:if(ic(i)){for(te in r)r.hasOwnProperty(te)&&(c=r[te],c!==void 0&&zu(t,i,te,c,r,void 0));return}}for(O in r)r.hasOwnProperty(O)&&(c=r[O],c!=null&&Fe(t,i,O,c,r,null))}function CS(t,i,r,c){switch(i){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var d=null,m=null,x=null,O=null,L=null,Y=null,te=null;for(J in r){var ie=r[J];if(r.hasOwnProperty(J)&&ie!=null)switch(J){case"checked":break;case"value":break;case"defaultValue":L=ie;default:c.hasOwnProperty(J)||Fe(t,i,J,null,c,ie)}}for(var K in c){var J=c[K];if(ie=r[K],c.hasOwnProperty(K)&&(J!=null||ie!=null))switch(K){case"type":m=J;break;case"name":d=J;break;case"checked":Y=J;break;case"defaultChecked":te=J;break;case"value":x=J;break;case"defaultValue":O=J;break;case"children":case"dangerouslySetInnerHTML":if(J!=null)throw Error(o(137,i));break;default:J!==ie&&Fe(t,i,K,J,c,ie)}}tc(t,x,O,L,Y,te,m,d);return;case"select":J=x=O=K=null;for(m in r)if(L=r[m],r.hasOwnProperty(m)&&L!=null)switch(m){case"value":break;case"multiple":J=L;default:c.hasOwnProperty(m)||Fe(t,i,m,null,c,L)}for(d in c)if(m=c[d],L=r[d],c.hasOwnProperty(d)&&(m!=null||L!=null))switch(d){case"value":K=m;break;case"defaultValue":O=m;break;case"multiple":x=m;default:m!==L&&Fe(t,i,d,m,c,L)}i=O,r=x,c=J,K!=null?Us(t,!!r,K,!1):!!c!=!!r&&(i!=null?Us(t,!!r,i,!0):Us(t,!!r,r?[]:"",!1));return;case"textarea":J=K=null;for(O in r)if(d=r[O],r.hasOwnProperty(O)&&d!=null&&!c.hasOwnProperty(O))switch(O){case"value":break;case"children":break;default:Fe(t,i,O,null,c,d)}for(x in c)if(d=c[x],m=r[x],c.hasOwnProperty(x)&&(d!=null||m!=null))switch(x){case"value":K=d;break;case"defaultValue":J=d;break;case"children":break;case"dangerouslySetInnerHTML":if(d!=null)throw Error(o(91));break;default:d!==m&&Fe(t,i,x,d,c,m)}Af(t,K,J);return;case"option":for(var me in r)K=r[me],r.hasOwnProperty(me)&&K!=null&&!c.hasOwnProperty(me)&&(me==="selected"?t.selected=!1:Fe(t,i,me,null,c,K));for(L in c)K=c[L],J=r[L],c.hasOwnProperty(L)&&K!==J&&(K!=null||J!=null)&&(L==="selected"?t.selected=K&&typeof K!="function"&&typeof K!="symbol":Fe(t,i,L,K,c,J));return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var ve in r)K=r[ve],r.hasOwnProperty(ve)&&K!=null&&!c.hasOwnProperty(ve)&&Fe(t,i,ve,null,c,K);for(Y in c)if(K=c[Y],J=r[Y],c.hasOwnProperty(Y)&&K!==J&&(K!=null||J!=null))switch(Y){case"children":case"dangerouslySetInnerHTML":if(K!=null)throw Error(o(137,i));break;default:Fe(t,i,Y,K,c,J)}return;default:if(ic(i)){for(var We in r)K=r[We],r.hasOwnProperty(We)&&K!==void 0&&!c.hasOwnProperty(We)&&zu(t,i,We,void 0,c,K);for(te in c)K=c[te],J=r[te],!c.hasOwnProperty(te)||K===J||K===void 0&&J===void 0||zu(t,i,te,K,c,J);return}}for(var U in r)K=r[U],r.hasOwnProperty(U)&&K!=null&&!c.hasOwnProperty(U)&&Fe(t,i,U,null,c,K);for(ie in c)K=c[ie],J=r[ie],!c.hasOwnProperty(ie)||K===J||K==null&&J==null||Fe(t,i,ie,K,c,J)}function wh(t){switch(t){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}function OS(){if(typeof performance.getEntriesByType=="function"){for(var t=0,i=0,r=performance.getEntriesByType("resource"),c=0;c<r.length;c++){var d=r[c],m=d.transferSize,x=d.initiatorType,O=d.duration;if(m&&O&&wh(x)){for(x=0,O=d.responseEnd,c+=1;c<r.length;c++){var L=r[c],Y=L.startTime;if(Y>O)break;var te=L.transferSize,ie=L.initiatorType;te&&wh(ie)&&(L=L.responseEnd,x+=te*(L<O?1:(O-Y)/(L-Y)))}if(--c,i+=8*(m+x)/(d.duration/1e3),t++,10<t)break}}if(0<t)return i/t/1e6}return navigator.connection&&(t=navigator.connection.downlink,typeof t=="number")?t:5}var Vu=null,Yu=null;function zr(t){return t.nodeType===9?t:t.ownerDocument}function Mh(t){switch(t){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function Ch(t,i){if(t===0)switch(i){case"svg":return 1;case"math":return 2;default:return 0}return t===1&&i==="foreignObject"?0:t}function Ku(t,i){return t==="textarea"||t==="noscript"||typeof i.children=="string"||typeof i.children=="number"||typeof i.children=="bigint"||typeof i.dangerouslySetInnerHTML=="object"&&i.dangerouslySetInnerHTML!==null&&i.dangerouslySetInnerHTML.__html!=null}var Fu=null;function NS(){var t=window.event;return t&&t.type==="popstate"?t===Fu?!1:(Fu=t,!0):(Fu=null,!1)}var Oh=typeof setTimeout=="function"?setTimeout:void 0,kS=typeof clearTimeout=="function"?clearTimeout:void 0,Nh=typeof Promise=="function"?Promise:void 0,RS=typeof queueMicrotask=="function"?queueMicrotask:typeof Nh<"u"?function(t){return Nh.resolve(null).then(t).catch(IS)}:Oh;function IS(t){setTimeout(function(){throw t})}function Bi(t){return t==="head"}function kh(t,i){var r=i,c=0;do{var d=r.nextSibling;if(t.removeChild(r),d&&d.nodeType===8)if(r=d.data,r==="/$"||r==="/&"){if(c===0){t.removeChild(d),ba(i);return}c--}else if(r==="$"||r==="$?"||r==="$~"||r==="$!"||r==="&")c++;else if(r==="html")yo(t.ownerDocument.documentElement);else if(r==="head"){r=t.ownerDocument.head,yo(r);for(var m=r.firstChild;m;){var x=m.nextSibling,O=m.nodeName;m[Ia]||O==="SCRIPT"||O==="STYLE"||O==="LINK"&&m.rel.toLowerCase()==="stylesheet"||r.removeChild(m),m=x}}else r==="body"&&yo(t.ownerDocument.body);r=d}while(r);ba(i)}function Rh(t,i){var r=t;t=0;do{var c=r.nextSibling;if(r.nodeType===1?i?(r._stashedDisplay=r.style.display,r.style.display="none"):(r.style.display=r._stashedDisplay||"",r.getAttribute("style")===""&&r.removeAttribute("style")):r.nodeType===3&&(i?(r._stashedText=r.nodeValue,r.nodeValue=""):r.nodeValue=r._stashedText||""),c&&c.nodeType===8)if(r=c.data,r==="/$"){if(t===0)break;t--}else r!=="$"&&r!=="$?"&&r!=="$~"&&r!=="$!"||t++;r=c}while(r)}function Wu(t){var i=t.firstChild;for(i&&i.nodeType===10&&(i=i.nextSibling);i;){var r=i;switch(i=i.nextSibling,r.nodeName){case"HTML":case"HEAD":case"BODY":Wu(r),Zl(r);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(r.rel.toLowerCase()==="stylesheet")continue}t.removeChild(r)}}function LS(t,i,r,c){for(;t.nodeType===1;){var d=r;if(t.nodeName.toLowerCase()!==i.toLowerCase()){if(!c&&(t.nodeName!=="INPUT"||t.type!=="hidden"))break}else if(c){if(!t[Ia])switch(i){case"meta":if(!t.hasAttribute("itemprop"))break;return t;case"link":if(m=t.getAttribute("rel"),m==="stylesheet"&&t.hasAttribute("data-precedence"))break;if(m!==d.rel||t.getAttribute("href")!==(d.href==null||d.href===""?null:d.href)||t.getAttribute("crossorigin")!==(d.crossOrigin==null?null:d.crossOrigin)||t.getAttribute("title")!==(d.title==null?null:d.title))break;return t;case"style":if(t.hasAttribute("data-precedence"))break;return t;case"script":if(m=t.getAttribute("src"),(m!==(d.src==null?null:d.src)||t.getAttribute("type")!==(d.type==null?null:d.type)||t.getAttribute("crossorigin")!==(d.crossOrigin==null?null:d.crossOrigin))&&m&&t.hasAttribute("async")&&!t.hasAttribute("itemprop"))break;return t;default:return t}}else if(i==="input"&&t.type==="hidden"){var m=d.name==null?null:""+d.name;if(d.type==="hidden"&&t.getAttribute("name")===m)return t}else return t;if(t=xn(t.nextSibling),t===null)break}return null}function BS(t,i,r){if(i==="")return null;for(;t.nodeType!==3;)if((t.nodeType!==1||t.nodeName!=="INPUT"||t.type!=="hidden")&&!r||(t=xn(t.nextSibling),t===null))return null;return t}function Ih(t,i){for(;t.nodeType!==8;)if((t.nodeType!==1||t.nodeName!=="INPUT"||t.type!=="hidden")&&!i||(t=xn(t.nextSibling),t===null))return null;return t}function Gu(t){return t.data==="$?"||t.data==="$~"}function Xu(t){return t.data==="$!"||t.data==="$?"&&t.ownerDocument.readyState!=="loading"}function HS(t,i){var r=t.ownerDocument;if(t.data==="$~")t._reactRetry=i;else if(t.data!=="$?"||r.readyState!=="loading")i();else{var c=function(){i(),r.removeEventListener("DOMContentLoaded",c)};r.addEventListener("DOMContentLoaded",c),t._reactRetry=c}}function xn(t){for(;t!=null;t=t.nextSibling){var i=t.nodeType;if(i===1||i===3)break;if(i===8){if(i=t.data,i==="$"||i==="$!"||i==="$?"||i==="$~"||i==="&"||i==="F!"||i==="F")break;if(i==="/$"||i==="/&")return null}}return t}var Ju=null;function Lh(t){t=t.nextSibling;for(var i=0;t;){if(t.nodeType===8){var r=t.data;if(r==="/$"||r==="/&"){if(i===0)return xn(t.nextSibling);i--}else r!=="$"&&r!=="$!"&&r!=="$?"&&r!=="$~"&&r!=="&"||i++}t=t.nextSibling}return null}function Bh(t){t=t.previousSibling;for(var i=0;t;){if(t.nodeType===8){var r=t.data;if(r==="$"||r==="$!"||r==="$?"||r==="$~"||r==="&"){if(i===0)return t;i--}else r!=="/$"&&r!=="/&"||i++}t=t.previousSibling}return null}function Hh(t,i,r){switch(i=zr(r),t){case"html":if(t=i.documentElement,!t)throw Error(o(452));return t;case"head":if(t=i.head,!t)throw Error(o(453));return t;case"body":if(t=i.body,!t)throw Error(o(454));return t;default:throw Error(o(451))}}function yo(t){for(var i=t.attributes;i.length;)t.removeAttributeNode(i[0]);Zl(t)}var An=new Map,Ph=new Set;function Vr(t){return typeof t.getRootNode=="function"?t.getRootNode():t.nodeType===9?t:t.ownerDocument}var ui=z.d;z.d={f:PS,r:jS,D:DS,C:US,L:$S,m:qS,X:VS,S:zS,M:YS};function PS(){var t=ui.f(),i=Br();return t||i}function jS(t){var i=Ps(t);i!==null&&i.tag===5&&i.type==="form"?ep(i):ui.r(t)}var ha=typeof document>"u"?null:document;function jh(t,i,r){var c=ha;if(c&&typeof i=="string"&&i){var d=pn(i);d='link[rel="'+t+'"][href="'+d+'"]',typeof r=="string"&&(d+='[crossorigin="'+r+'"]'),Ph.has(d)||(Ph.add(d),t={rel:t,crossOrigin:r,href:i},c.querySelector(d)===null&&(i=c.createElement("link"),$t(i,"link",t),kt(i),c.head.appendChild(i)))}}function DS(t){ui.D(t),jh("dns-prefetch",t,null)}function US(t,i){ui.C(t,i),jh("preconnect",t,i)}function $S(t,i,r){ui.L(t,i,r);var c=ha;if(c&&t&&i){var d='link[rel="preload"][as="'+pn(i)+'"]';i==="image"&&r&&r.imageSrcSet?(d+='[imagesrcset="'+pn(r.imageSrcSet)+'"]',typeof r.imageSizes=="string"&&(d+='[imagesizes="'+pn(r.imageSizes)+'"]')):d+='[href="'+pn(t)+'"]';var m=d;switch(i){case"style":m=ya(t);break;case"script":m=ga(t)}An.has(m)||(t=b({rel:"preload",href:i==="image"&&r&&r.imageSrcSet?void 0:t,as:i},r),An.set(m,t),c.querySelector(d)!==null||i==="style"&&c.querySelector(go(m))||i==="script"&&c.querySelector(bo(m))||(i=c.createElement("link"),$t(i,"link",t),kt(i),c.head.appendChild(i)))}}function qS(t,i){ui.m(t,i);var r=ha;if(r&&t){var c=i&&typeof i.as=="string"?i.as:"script",d='link[rel="modulepreload"][as="'+pn(c)+'"][href="'+pn(t)+'"]',m=d;switch(c){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":m=ga(t)}if(!An.has(m)&&(t=b({rel:"modulepreload",href:t},i),An.set(m,t),r.querySelector(d)===null)){switch(c){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(r.querySelector(bo(m)))return}c=r.createElement("link"),$t(c,"link",t),kt(c),r.head.appendChild(c)}}}function zS(t,i,r){ui.S(t,i,r);var c=ha;if(c&&t){var d=js(c).hoistableStyles,m=ya(t);i=i||"default";var x=d.get(m);if(!x){var O={loading:0,preload:null};if(x=c.querySelector(go(m)))O.loading=5;else{t=b({rel:"stylesheet",href:t,"data-precedence":i},r),(r=An.get(m))&&Qu(t,r);var L=x=c.createElement("link");kt(L),$t(L,"link",t),L._p=new Promise(function(Y,te){L.onload=Y,L.onerror=te}),L.addEventListener("load",function(){O.loading|=1}),L.addEventListener("error",function(){O.loading|=2}),O.loading|=4,Yr(x,i,c)}x={type:"stylesheet",instance:x,count:1,state:O},d.set(m,x)}}}function VS(t,i){ui.X(t,i);var r=ha;if(r&&t){var c=js(r).hoistableScripts,d=ga(t),m=c.get(d);m||(m=r.querySelector(bo(d)),m||(t=b({src:t,async:!0},i),(i=An.get(d))&&Zu(t,i),m=r.createElement("script"),kt(m),$t(m,"link",t),r.head.appendChild(m)),m={type:"script",instance:m,count:1,state:null},c.set(d,m))}}function YS(t,i){ui.M(t,i);var r=ha;if(r&&t){var c=js(r).hoistableScripts,d=ga(t),m=c.get(d);m||(m=r.querySelector(bo(d)),m||(t=b({src:t,async:!0,type:"module"},i),(i=An.get(d))&&Zu(t,i),m=r.createElement("script"),kt(m),$t(m,"link",t),r.head.appendChild(m)),m={type:"script",instance:m,count:1,state:null},c.set(d,m))}}function Dh(t,i,r,c){var d=(d=ue.current)?Vr(d):null;if(!d)throw Error(o(446));switch(t){case"meta":case"title":return null;case"style":return typeof r.precedence=="string"&&typeof r.href=="string"?(i=ya(r.href),r=js(d).hoistableStyles,c=r.get(i),c||(c={type:"style",instance:null,count:0,state:null},r.set(i,c)),c):{type:"void",instance:null,count:0,state:null};case"link":if(r.rel==="stylesheet"&&typeof r.href=="string"&&typeof r.precedence=="string"){t=ya(r.href);var m=js(d).hoistableStyles,x=m.get(t);if(x||(d=d.ownerDocument||d,x={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},m.set(t,x),(m=d.querySelector(go(t)))&&!m._p&&(x.instance=m,x.state.loading=5),An.has(t)||(r={rel:"preload",as:"style",href:r.href,crossOrigin:r.crossOrigin,integrity:r.integrity,media:r.media,hrefLang:r.hrefLang,referrerPolicy:r.referrerPolicy},An.set(t,r),m||KS(d,t,r,x.state))),i&&c===null)throw Error(o(528,""));return x}if(i&&c!==null)throw Error(o(529,""));return null;case"script":return i=r.async,r=r.src,typeof r=="string"&&i&&typeof i!="function"&&typeof i!="symbol"?(i=ga(r),r=js(d).hoistableScripts,c=r.get(i),c||(c={type:"script",instance:null,count:0,state:null},r.set(i,c)),c):{type:"void",instance:null,count:0,state:null};default:throw Error(o(444,t))}}function ya(t){return'href="'+pn(t)+'"'}function go(t){return'link[rel="stylesheet"]['+t+"]"}function Uh(t){return b({},t,{"data-precedence":t.precedence,precedence:null})}function KS(t,i,r,c){t.querySelector('link[rel="preload"][as="style"]['+i+"]")?c.loading=1:(i=t.createElement("link"),c.preload=i,i.addEventListener("load",function(){return c.loading|=1}),i.addEventListener("error",function(){return c.loading|=2}),$t(i,"link",r),kt(i),t.head.appendChild(i))}function ga(t){return'[src="'+pn(t)+'"]'}function bo(t){return"script[async]"+t}function $h(t,i,r){if(i.count++,i.instance===null)switch(i.type){case"style":var c=t.querySelector('style[data-href~="'+pn(r.href)+'"]');if(c)return i.instance=c,kt(c),c;var d=b({},r,{"data-href":r.href,"data-precedence":r.precedence,href:null,precedence:null});return c=(t.ownerDocument||t).createElement("style"),kt(c),$t(c,"style",d),Yr(c,r.precedence,t),i.instance=c;case"stylesheet":d=ya(r.href);var m=t.querySelector(go(d));if(m)return i.state.loading|=4,i.instance=m,kt(m),m;c=Uh(r),(d=An.get(d))&&Qu(c,d),m=(t.ownerDocument||t).createElement("link"),kt(m);var x=m;return x._p=new Promise(function(O,L){x.onload=O,x.onerror=L}),$t(m,"link",c),i.state.loading|=4,Yr(m,r.precedence,t),i.instance=m;case"script":return m=ga(r.src),(d=t.querySelector(bo(m)))?(i.instance=d,kt(d),d):(c=r,(d=An.get(m))&&(c=b({},r),Zu(c,d)),t=t.ownerDocument||t,d=t.createElement("script"),kt(d),$t(d,"link",c),t.head.appendChild(d),i.instance=d);case"void":return null;default:throw Error(o(443,i.type))}else i.type==="stylesheet"&&(i.state.loading&4)===0&&(c=i.instance,i.state.loading|=4,Yr(c,r.precedence,t));return i.instance}function Yr(t,i,r){for(var c=r.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),d=c.length?c[c.length-1]:null,m=d,x=0;x<c.length;x++){var O=c[x];if(O.dataset.precedence===i)m=O;else if(m!==d)break}m?m.parentNode.insertBefore(t,m.nextSibling):(i=r.nodeType===9?r.head:r,i.insertBefore(t,i.firstChild))}function Qu(t,i){t.crossOrigin==null&&(t.crossOrigin=i.crossOrigin),t.referrerPolicy==null&&(t.referrerPolicy=i.referrerPolicy),t.title==null&&(t.title=i.title)}function Zu(t,i){t.crossOrigin==null&&(t.crossOrigin=i.crossOrigin),t.referrerPolicy==null&&(t.referrerPolicy=i.referrerPolicy),t.integrity==null&&(t.integrity=i.integrity)}var Kr=null;function qh(t,i,r){if(Kr===null){var c=new Map,d=Kr=new Map;d.set(r,c)}else d=Kr,c=d.get(r),c||(c=new Map,d.set(r,c));if(c.has(t))return c;for(c.set(t,null),r=r.getElementsByTagName(t),d=0;d<r.length;d++){var m=r[d];if(!(m[Ia]||m[Pt]||t==="link"&&m.getAttribute("rel")==="stylesheet")&&m.namespaceURI!=="http://www.w3.org/2000/svg"){var x=m.getAttribute(i)||"";x=t+x;var O=c.get(x);O?O.push(m):c.set(x,[m])}}return c}function zh(t,i,r){t=t.ownerDocument||t,t.head.insertBefore(r,i==="title"?t.querySelector("head > title"):null)}function FS(t,i,r){if(r===1||i.itemProp!=null)return!1;switch(t){case"meta":case"title":return!0;case"style":if(typeof i.precedence!="string"||typeof i.href!="string"||i.href==="")break;return!0;case"link":if(typeof i.rel!="string"||typeof i.href!="string"||i.href===""||i.onLoad||i.onError)break;return i.rel==="stylesheet"?(t=i.disabled,typeof i.precedence=="string"&&t==null):!0;case"script":if(i.async&&typeof i.async!="function"&&typeof i.async!="symbol"&&!i.onLoad&&!i.onError&&i.src&&typeof i.src=="string")return!0}return!1}function Vh(t){return!(t.type==="stylesheet"&&(t.state.loading&3)===0)}function WS(t,i,r,c){if(r.type==="stylesheet"&&(typeof c.media!="string"||matchMedia(c.media).matches!==!1)&&(r.state.loading&4)===0){if(r.instance===null){var d=ya(c.href),m=i.querySelector(go(d));if(m){i=m._p,i!==null&&typeof i=="object"&&typeof i.then=="function"&&(t.count++,t=Fr.bind(t),i.then(t,t)),r.state.loading|=4,r.instance=m,kt(m);return}m=i.ownerDocument||i,c=Uh(c),(d=An.get(d))&&Qu(c,d),m=m.createElement("link"),kt(m);var x=m;x._p=new Promise(function(O,L){x.onload=O,x.onerror=L}),$t(m,"link",c),r.instance=m}t.stylesheets===null&&(t.stylesheets=new Map),t.stylesheets.set(r,i),(i=r.state.preload)&&(r.state.loading&3)===0&&(t.count++,r=Fr.bind(t),i.addEventListener("load",r),i.addEventListener("error",r))}}var ed=0;function GS(t,i){return t.stylesheets&&t.count===0&&Gr(t,t.stylesheets),0<t.count||0<t.imgCount?function(r){var c=setTimeout(function(){if(t.stylesheets&&Gr(t,t.stylesheets),t.unsuspend){var m=t.unsuspend;t.unsuspend=null,m()}},6e4+i);0<t.imgBytes&&ed===0&&(ed=62500*OS());var d=setTimeout(function(){if(t.waitingForImages=!1,t.count===0&&(t.stylesheets&&Gr(t,t.stylesheets),t.unsuspend)){var m=t.unsuspend;t.unsuspend=null,m()}},(t.imgBytes>ed?50:800)+i);return t.unsuspend=r,function(){t.unsuspend=null,clearTimeout(c),clearTimeout(d)}}:null}function Fr(){if(this.count--,this.count===0&&(this.imgCount===0||!this.waitingForImages)){if(this.stylesheets)Gr(this,this.stylesheets);else if(this.unsuspend){var t=this.unsuspend;this.unsuspend=null,t()}}}var Wr=null;function Gr(t,i){t.stylesheets=null,t.unsuspend!==null&&(t.count++,Wr=new Map,i.forEach(XS,t),Wr=null,Fr.call(t))}function XS(t,i){if(!(i.state.loading&4)){var r=Wr.get(t);if(r)var c=r.get(null);else{r=new Map,Wr.set(t,r);for(var d=t.querySelectorAll("link[data-precedence],style[data-precedence]"),m=0;m<d.length;m++){var x=d[m];(x.nodeName==="LINK"||x.getAttribute("media")!=="not all")&&(r.set(x.dataset.precedence,x),c=x)}c&&r.set(null,c)}d=i.instance,x=d.getAttribute("data-precedence"),m=r.get(x)||c,m===c&&r.set(null,d),r.set(x,d),this.count++,c=Fr.bind(this),d.addEventListener("load",c),d.addEventListener("error",c),m?m.parentNode.insertBefore(d,m.nextSibling):(t=t.nodeType===9?t.head:t,t.insertBefore(d,t.firstChild)),i.state.loading|=4}}var So={$$typeof:M,Provider:null,Consumer:null,_currentValue:Z,_currentValue2:Z,_threadCount:0};function JS(t,i,r,c,d,m,x,O,L){this.tag=1,this.containerInfo=t,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=Rs(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Rs(0),this.hiddenUpdates=Rs(null),this.identifierPrefix=c,this.onUncaughtError=d,this.onCaughtError=m,this.onRecoverableError=x,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=L,this.incompleteTransitions=new Map}function Yh(t,i,r,c,d,m,x,O,L,Y,te,ie){return t=new JS(t,i,r,x,L,Y,te,ie,O),i=1,m===!0&&(i|=24),m=on(3,null,null,i),t.current=m,m.stateNode=t,i=Ic(),i.refCount++,t.pooledCache=i,i.refCount++,m.memoizedState={element:c,isDehydrated:r,cache:i},Pc(m),t}function Kh(t){return t?(t=Ws,t):Ws}function Fh(t,i,r,c,d,m){d=Kh(d),c.context===null?c.context=d:c.pendingContext=d,c=Ei(i),c.payload={element:r},m=m===void 0?null:m,m!==null&&(c.callback=m),r=_i(t,c,i),r!==null&&(nn(r,t,i),Xa(r,t,i))}function Wh(t,i){if(t=t.memoizedState,t!==null&&t.dehydrated!==null){var r=t.retryLane;t.retryLane=r!==0&&r<i?r:i}}function td(t,i){Wh(t,i),(t=t.alternate)&&Wh(t,i)}function Gh(t){if(t.tag===13||t.tag===31){var i=rs(t,67108864);i!==null&&nn(i,t,67108864),td(t,67108864)}}function Xh(t){if(t.tag===13||t.tag===31){var i=dn();i=ka(i);var r=rs(t,i);r!==null&&nn(r,t,i),td(t,i)}}var Xr=!0;function QS(t,i,r,c){var d=H.T;H.T=null;var m=z.p;try{z.p=2,nd(t,i,r,c)}finally{z.p=m,H.T=d}}function ZS(t,i,r,c){var d=H.T;H.T=null;var m=z.p;try{z.p=8,nd(t,i,r,c)}finally{z.p=m,H.T=d}}function nd(t,i,r,c){if(Xr){var d=id(c);if(d===null)qu(t,i,c,Jr,r),Qh(t,c);else if(tv(d,t,i,r,c))c.stopPropagation();else if(Qh(t,c),i&4&&-1<ev.indexOf(t)){for(;d!==null;){var m=Ps(d);if(m!==null)switch(m.tag){case 3:if(m=m.stateNode,m.current.memoizedState.isDehydrated){var x=sn(m.pendingLanes);if(x!==0){var O=m;for(O.pendingLanes|=2,O.entangledLanes|=2;x;){var L=1<<31-pt(x);O.entanglements[1]|=L,x&=~L}qn(m),(De&6)===0&&(Ir=It()+500,mo(0))}}break;case 31:case 13:O=rs(m,2),O!==null&&nn(O,m,2),Br(),td(m,2)}if(m=id(c),m===null&&qu(t,i,c,Jr,r),m===d)break;d=m}d!==null&&c.stopPropagation()}else qu(t,i,c,null,r)}}function id(t){return t=ac(t),sd(t)}var Jr=null;function sd(t){if(Jr=null,t=Hs(t),t!==null){var i=l(t);if(i===null)t=null;else{var r=i.tag;if(r===13){if(t=u(i),t!==null)return t;t=null}else if(r===31){if(t=f(i),t!==null)return t;t=null}else if(r===3){if(i.stateNode.current.memoizedState.isDehydrated)return i.tag===3?i.stateNode.containerInfo:null;t=null}else i!==t&&(t=null)}}return Jr=t,null}function Jh(t){switch(t){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(wa()){case Ns:return 2;case ks:return 8;case Yn:case Zi:return 32;case es:return 268435456;default:return 32}default:return 32}}var ad=!1,Hi=null,Pi=null,ji=null,vo=new Map,xo=new Map,Di=[],ev="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function Qh(t,i){switch(t){case"focusin":case"focusout":Hi=null;break;case"dragenter":case"dragleave":Pi=null;break;case"mouseover":case"mouseout":ji=null;break;case"pointerover":case"pointerout":vo.delete(i.pointerId);break;case"gotpointercapture":case"lostpointercapture":xo.delete(i.pointerId)}}function Ao(t,i,r,c,d,m){return t===null||t.nativeEvent!==m?(t={blockedOn:i,domEventName:r,eventSystemFlags:c,nativeEvent:m,targetContainers:[d]},i!==null&&(i=Ps(i),i!==null&&Gh(i)),t):(t.eventSystemFlags|=c,i=t.targetContainers,d!==null&&i.indexOf(d)===-1&&i.push(d),t)}function tv(t,i,r,c,d){switch(i){case"focusin":return Hi=Ao(Hi,t,i,r,c,d),!0;case"dragenter":return Pi=Ao(Pi,t,i,r,c,d),!0;case"mouseover":return ji=Ao(ji,t,i,r,c,d),!0;case"pointerover":var m=d.pointerId;return vo.set(m,Ao(vo.get(m)||null,t,i,r,c,d)),!0;case"gotpointercapture":return m=d.pointerId,xo.set(m,Ao(xo.get(m)||null,t,i,r,c,d)),!0}return!1}function Zh(t){var i=Hs(t.target);if(i!==null){var r=l(i);if(r!==null){if(i=r.tag,i===13){if(i=u(r),i!==null){t.blockedOn=i,mf(t.priority,function(){Xh(r)});return}}else if(i===31){if(i=f(r),i!==null){t.blockedOn=i,mf(t.priority,function(){Xh(r)});return}}else if(i===3&&r.stateNode.current.memoizedState.isDehydrated){t.blockedOn=r.tag===3?r.stateNode.containerInfo:null;return}}}t.blockedOn=null}function Qr(t){if(t.blockedOn!==null)return!1;for(var i=t.targetContainers;0<i.length;){var r=id(t.nativeEvent);if(r===null){r=t.nativeEvent;var c=new r.constructor(r.type,r);sc=c,r.target.dispatchEvent(c),sc=null}else return i=Ps(r),i!==null&&Gh(i),t.blockedOn=r,!1;i.shift()}return!0}function ey(t,i,r){Qr(t)&&r.delete(i)}function nv(){ad=!1,Hi!==null&&Qr(Hi)&&(Hi=null),Pi!==null&&Qr(Pi)&&(Pi=null),ji!==null&&Qr(ji)&&(ji=null),vo.forEach(ey),xo.forEach(ey)}function Zr(t,i){t.blockedOn===i&&(t.blockedOn=null,ad||(ad=!0,e.unstable_scheduleCallback(e.unstable_NormalPriority,nv)))}var el=null;function ty(t){el!==t&&(el=t,e.unstable_scheduleCallback(e.unstable_NormalPriority,function(){el===t&&(el=null);for(var i=0;i<t.length;i+=3){var r=t[i],c=t[i+1],d=t[i+2];if(typeof c!="function"){if(sd(c||r)===null)continue;break}var m=Ps(r);m!==null&&(t.splice(i,3),i-=3,iu(m,{pending:!0,data:d,method:r.method,action:c},c,d))}}))}function ba(t){function i(L){return Zr(L,t)}Hi!==null&&Zr(Hi,t),Pi!==null&&Zr(Pi,t),ji!==null&&Zr(ji,t),vo.forEach(i),xo.forEach(i);for(var r=0;r<Di.length;r++){var c=Di[r];c.blockedOn===t&&(c.blockedOn=null)}for(;0<Di.length&&(r=Di[0],r.blockedOn===null);)Zh(r),r.blockedOn===null&&Di.shift();if(r=(t.ownerDocument||t).$$reactFormReplay,r!=null)for(c=0;c<r.length;c+=3){var d=r[c],m=r[c+1],x=d[Xt]||null;if(typeof m=="function")x||ty(r);else if(x){var O=null;if(m&&m.hasAttribute("formAction")){if(d=m,x=m[Xt]||null)O=x.formAction;else if(sd(d)!==null)continue}else O=x.action;typeof O=="function"?r[c+1]=O:(r.splice(c,3),c-=3),ty(r)}}}function ny(){function t(m){m.canIntercept&&m.info==="react-transition"&&m.intercept({handler:function(){return new Promise(function(x){return d=x})},focusReset:"manual",scroll:"manual"})}function i(){d!==null&&(d(),d=null),c||setTimeout(r,20)}function r(){if(!c&&!navigation.transition){var m=navigation.currentEntry;m&&m.url!=null&&navigation.navigate(m.url,{state:m.getState(),info:"react-transition",history:"replace"})}}if(typeof navigation=="object"){var c=!1,d=null;return navigation.addEventListener("navigate",t),navigation.addEventListener("navigatesuccess",i),navigation.addEventListener("navigateerror",i),setTimeout(r,100),function(){c=!0,navigation.removeEventListener("navigate",t),navigation.removeEventListener("navigatesuccess",i),navigation.removeEventListener("navigateerror",i),d!==null&&(d(),d=null)}}}function od(t){this._internalRoot=t}tl.prototype.render=od.prototype.render=function(t){var i=this._internalRoot;if(i===null)throw Error(o(409));var r=i.current,c=dn();Fh(r,c,t,i,null,null)},tl.prototype.unmount=od.prototype.unmount=function(){var t=this._internalRoot;if(t!==null){this._internalRoot=null;var i=t.containerInfo;Fh(t.current,2,null,t,null,null),Br(),i[Bs]=null}};function tl(t){this._internalRoot=t}tl.prototype.unstable_scheduleHydration=function(t){if(t){var i=Ra();t={blockedOn:null,target:t,priority:i};for(var r=0;r<Di.length&&i!==0&&i<Di[r].priority;r++);Di.splice(r,0,t),r===0&&Zh(t)}};var iy=n.version;if(iy!=="19.2.3")throw Error(o(527,iy,"19.2.3"));z.findDOMNode=function(t){var i=t._reactInternals;if(i===void 0)throw typeof t.render=="function"?Error(o(188)):(t=Object.keys(t).join(","),Error(o(268,t)));return t=h(i),t=t!==null?g(t):null,t=t===null?null:t.stateNode,t};var iv={bundleType:0,version:"19.2.3",rendererPackageName:"react-dom",currentDispatcherRef:H,reconcilerVersion:"19.2.3"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var nl=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!nl.isDisabled&&nl.supportsFiber)try{Kn=nl.inject(iv),Lt=nl}catch{}}return Eo.createRoot=function(t,i){if(!a(t))throw Error(o(299));var r=!1,c="",d=up,m=dp,x=fp;return i!=null&&(i.unstable_strictMode===!0&&(r=!0),i.identifierPrefix!==void 0&&(c=i.identifierPrefix),i.onUncaughtError!==void 0&&(d=i.onUncaughtError),i.onCaughtError!==void 0&&(m=i.onCaughtError),i.onRecoverableError!==void 0&&(x=i.onRecoverableError)),i=Yh(t,1,!1,null,null,r,c,null,d,m,x,ny),t[Bs]=i.current,$u(t),new od(i)},Eo.hydrateRoot=function(t,i,r){if(!a(t))throw Error(o(299));var c=!1,d="",m=up,x=dp,O=fp,L=null;return r!=null&&(r.unstable_strictMode===!0&&(c=!0),r.identifierPrefix!==void 0&&(d=r.identifierPrefix),r.onUncaughtError!==void 0&&(m=r.onUncaughtError),r.onCaughtError!==void 0&&(x=r.onCaughtError),r.onRecoverableError!==void 0&&(O=r.onRecoverableError),r.formState!==void 0&&(L=r.formState)),i=Yh(t,1,!0,i,r??null,c,d,L,m,x,O,ny),i.context=Kh(null),r=i.current,c=dn(),c=ka(c),d=Ei(c),d.callback=null,_i(r,d,c),r=c,i.current.lanes=r,ns(i,r),qn(i),t[Bs]=i.current,$u(t),new tl(i)},Eo.version="19.2.3",Eo}var my;function pv(){if(my)return cd.exports;my=1;function e(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(n){console.error(n)}}return e(),cd.exports=mv(),cd.exports}var hv=pv();const Ft=(e,n)=>({q:e,r:n,s:-e-n}),yv=e=>`${e.q},${e.r}`,ce=yv,Q=(e,n)=>e.q===n.q&&e.r===n.r&&e.s===n.s,Vt=(e,n)=>Ft(e.q+n.q,e.r+n.r),Hd=(e,n)=>Ft(e.q-n.q,e.r-n.r),fe=(e,n)=>(Math.abs(e.q-n.q)+Math.abs(e.r-n.r)+Math.abs(e.s-n.s))/2,Ae=(e,n)=>{const s=n*(1.5*e.q),o=n*Math.sqrt(3)*(e.r+e.q/2);return{x:s,y:o}},py=e=>({q:e.q,r:e.r,s:e.s??-e.q-e.r}),gv=e=>Ft(e.q,e.r),bv=e=>{let n=Math.round(e.q),s=Math.round(e.r),o=Math.round(e.s);const a=Math.abs(n-e.q),l=Math.abs(s-e.r),u=Math.abs(o-e.s);return a>l&&a>u?n=-s-o:l>u?s=-n-o:o=-n-s,{q:n,r:s,s:o}},Po=[Ft(1,0),Ft(1,-1),Ft(0,-1),Ft(-1,0),Ft(-1,1),Ft(0,1)],Ue=e=>Po.map(n=>Vt(e,n)),wt=e=>Po[(e%6+6)%6],md=(e,n,s)=>e+(n-e)*s,Ze=(e,n)=>{const s=fe(e,n),o=[],a=py(e),l=py(n);for(let u=0;u<=s;u++){const f=s===0?0:u/s,p={q:md(a.q+1e-6,l.q+1e-6,f),r:md(a.r+1e-6,l.r+1e-6,f),s:md(a.s+1e-6,l.s+1e-6,f)};o.push(gv(bv(p)))}return o},Bn=(e,n)=>{const s=fe(e,n);if(s===0)return-1;const o=Hd(n,e),a=o.q/s,l=o.r/s,u=(0-o.q-o.r)/s;return Po.findIndex(f=>Math.abs(f.q-a)<.01&&Math.abs(f.r-l)<.01&&Math.abs(f.s-u)<.01)};function Zd(e,n){const s=wt(e);return{q:s.q*n,r:s.r*n,s:-(s.q*n)-s.r*n}}const Yl=(e,n,s,o)=>{if(e<0||e>=s||n<0||n>=o)return!1;const a=e+n,l=Math.floor(s/2),u=s-1+(o-1)-l;return a>=l&&a<=u},Sv=(e,n)=>{const s=[];for(let o=0;o<e;o++)for(let a=0;a<n;a++)Yl(o,a,e,n)&&s.push(Ft(o,a));return s},Gi=(e,n,s)=>Yl(e.q,e.r,n,s),Cl=7,Ol=9,X=36,hy={speed:1},vv={stunned:{tickWindow:"START_OF_TURN"},poisoned:{tickWindow:"START_OF_TURN"},armored:{tickWindow:"END_OF_TURN"},hidden:{tickWindow:"END_OF_TURN"},time_bomb:{tickWindow:"END_OF_TURN"}},xv=.17,il={floor:"#6b7b3c",wall:"#374151",shrine:"#f97316",portal:"#ffffff"},Av={1:"inferno",2:"inferno",3:"inferno",4:"inferno",5:"inferno",6:"inferno",7:"inferno",8:"inferno",9:"inferno",10:"inferno"},xa={GRASS:{id:"GRASS",name:"Grass",description:"Soft grass",defaultTraits:new Set(["WALKABLE","FLAMMABLE"]),visual:{color:"#4a7c59",icon:""}},STONE:{id:"STONE",name:"Stone Floor",description:"Hard stone",defaultTraits:new Set(["WALKABLE"]),visual:{color:"#808080",icon:""}},LAVA:{id:"LAVA",name:"Lava",description:"Molten lava",defaultTraits:new Set(["LIQUID","HAZARDOUS"]),visual:{color:"#ff4400",icon:""}},WALL:{id:"WALL",name:"Wall",description:"Solid wall",defaultTraits:new Set(["BLOCKS_LOS","BLOCKS_MOVEMENT","ANCHOR"]),visual:{color:"#333333",icon:""}},ICE:{id:"ICE",name:"Ice",description:"Slippery ice",defaultTraits:new Set(["WALKABLE","SLIPPERY"]),visual:{color:"#aaddff",icon:""}},VOID:{id:"VOID",name:"Void",description:"The endless void",defaultTraits:new Set(["HAZARDOUS"]),visual:{color:"#000000",icon:""}},STAIRS:{id:"STAIRS",name:"Stairs",description:"Lead to the next floor",defaultTraits:new Set(["WALKABLE"]),visual:{color:"#ffffff",icon:""}},SHRINE:{id:"SHRINE",name:"Shrine",description:"A place of power",defaultTraits:new Set(["WALKABLE","ANCHOR"]),visual:{color:"#ffd700",icon:""}},GATE:{id:"GATE",name:"Gate",description:"A heavy gate",defaultTraits:new Set(["BLOCKS_MOVEMENT","BLOCKS_LOS"]),visual:{color:"#444444",icon:""}},BRIDGE:{id:"BRIDGE",name:"Bridge",description:"Crossing the gap",defaultTraits:new Set(["WALKABLE"]),visual:{color:"#8b4513",icon:""}}},sl={FIRE:{id:"FIRE",name:"Fire",description:"Burning flames",onStay:e=>({effects:[{type:"Damage",target:e.actor.id,amount:1,reason:"fire_damage"}],messages:[`${e.actor.subtype||e.actor.type} burns!`]}),interactsWith:{WET:e=>({effects:[{type:"Juice",effect:"flash",target:e.tile.position,color:"#aaaaaa"}],messages:["Steam rises!"],modifyTile:{effects:e.tile.effects.filter(n=>n.id!=="FIRE"&&n.id!=="WET"&&n.id!=="STEAM").concat({id:"STEAM",duration:2,potency:1})}})}},WET:{id:"WET",name:"Wet",description:"Soaked with water",onApply:e=>e.tile.effects.some(s=>s.id==="FIRE")?{effects:[],messages:["Water extinguishes the flames!"],modifyTile:{effects:e.tile.effects.filter(s=>s.id!=="FIRE")}}:{effects:[],messages:[]}},OIL:{id:"OIL",name:"Oil",description:"Slippery oil",interactsWith:{FIRE:e=>({effects:[{type:"Damage",target:"area",amount:3,reason:"oil_explosion"},{type:"Juice",effect:"explosion_ring",target:e.tile.position}],messages:["Oil explodes!"],modifyTile:{effects:e.tile.effects.filter(n=>n.id!=="OIL")}})}},STEAM:{id:"STEAM",name:"Steam",description:"Obscuring steam cloud"},BLESSED:{id:"BLESSED",name:"Blessed",description:"Holy ground"},CURSED:{id:"CURSED",name:"Cursed",description:"Unholy ground"},ICE_WALL:{id:"ICE_WALL",name:"Ice Wall",description:"A wall of ice"},SMOKE:{id:"SMOKE",name:"Smoke",description:"Thick smoke"},BOMB_TICK:{id:"BOMB_TICK",name:"Bomb Tick",description:"About to explode"},TRI_TRAP:{id:"TRI_TRAP",name:"Kinetic Trap",description:"Hidden trap that flings non-flying units outward"},SNARE:{id:"SNARE",name:"Snare",description:"Entangling roots that halt movement and root the target.",onPass:e=>e.actor.isFlying?{effects:[],messages:[]}:{effects:[{type:"ApplyStatus",target:e.actor.id,status:"rooted",duration:2}],messages:["Snared! Movement halted."],interrupt:!0,newMomentum:0}}},Tv=e=>{let n=2166136261;for(let s=0;s<e.length;s++)n^=e.charCodeAt(s),n=Math.imul(n,16777619)>>>0;return n>>>0},Ev=e=>function(){let n=(e+=1831565813)>>>0;return n=Math.imul(n^n>>>15,n|1)>>>0,n^=n+Math.imul(n^n>>>7,n|61)>>>0,((n^n>>>14)>>>0)/4294967296},Kl=e=>{const n=typeof e=="number"?e>>>0:Tv(String(e)),s=Ev(n||1);return{next:()=>s(),id:(o=9)=>{const a="abcdefghijklmnopqrstuvwxyz0123456789";let l="";for(let u=0;u<o;u++){const f=Math.floor(s()*a.length)%a.length;l+=a[f]}return l}}},Aa=(e,n,s=9,o="")=>{const a=`${e}:${n}:${o}`,l=Kl(a),u="abcdefghijklmnopqrstuvwxyz0123456789";let f="";for(let p=0;p<s;p++){const h=Math.floor(l.next()*u.length)%u.length;f+=u[h]}return f},Il=(e,n)=>{const s=`${e}:${n}`;return Kl(s).next()},In=e=>{const n=e.rngSeed||"default",s=e.rngCounter||0;return{value:Il(n,s),nextState:{...e,rngCounter:s+1}}},Vo={footman:{packUnitId:"ENEMY_FOOTMAN_V1",bestiary:{subtype:"footman",name:"Footman",stats:{hp:1,maxHp:1,range:1,damage:1,type:"melee",cost:1,actionCooldown:2,weightClass:"Standard",speed:1},trinity:{body:4,mind:0,instinct:0},skills:{base:["BASIC_MOVE","BASIC_ATTACK"],passive:["AUTO_ATTACK"]}},runtimeSkills:{base:["BASIC_MOVE","BASIC_ATTACK"],passive:[]}},sprinter:{packUnitId:"ENEMY_SPRINTER_V1",bestiary:{subtype:"sprinter",name:"Sprinter",stats:{hp:1,maxHp:1,range:1,damage:1,type:"melee",cost:1,actionCooldown:1,weightClass:"Standard",speed:2},trinity:{body:2,mind:0,instinct:0},skills:{base:["BASIC_MOVE","BASIC_ATTACK"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","BASIC_ATTACK"],passive:[]}},raider:{packUnitId:"ENEMY_RAIDER_V1",bestiary:{subtype:"raider",name:"Raider",stats:{hp:1,maxHp:1,range:4,damage:1,type:"melee",cost:2,actionCooldown:1,weightClass:"Standard",speed:1},trinity:{body:2,mind:0,instinct:1},skills:{base:["BASIC_MOVE","BASIC_ATTACK","DASH"],passive:[]}},runtimeSkills:{base:["DASH"],passive:[]}},pouncer:{packUnitId:"ENEMY_POUNCER_V1",bestiary:{subtype:"pouncer",name:"Pouncer",stats:{hp:1,maxHp:1,range:4,damage:1,type:"melee",cost:2,actionCooldown:1,weightClass:"Standard",speed:1},trinity:{body:2,mind:0,instinct:1},skills:{base:["BASIC_MOVE","BASIC_ATTACK","GRAPPLE_HOOK"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","GRAPPLE_HOOK"],passive:[]}},shieldBearer:{packUnitId:"ENEMY_SHIELDBEARER_V1",bestiary:{subtype:"shieldBearer",name:"Shield Bearer",stats:{hp:2,maxHp:2,range:1,damage:1,type:"melee",cost:2,actionCooldown:2,weightClass:"Heavy",speed:1},trinity:{body:1,mind:0,instinct:.4},skills:{base:["BASIC_MOVE","BASIC_ATTACK","SHIELD_BASH"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","SHIELD_BASH"],passive:[]}},archer:{packUnitId:"ENEMY_ARCHER_V1",bestiary:{subtype:"archer",name:"Archer",stats:{hp:1,maxHp:1,range:4,damage:1,type:"ranged",cost:1,actionCooldown:3,weightClass:"Standard",speed:1},trinity:{body:.2,mind:0,instinct:.2},skills:{base:["BASIC_MOVE","BASIC_ATTACK","ARCHER_SHOT"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","ARCHER_SHOT"],passive:[]}},bomber:{packUnitId:"ENEMY_BOMBER_V1",bestiary:{subtype:"bomber",name:"Bomber",stats:{hp:1,maxHp:1,range:3,damage:1,type:"ranged",cost:1,actionCooldown:2,weightClass:"Standard",speed:1},trinity:{body:.4,mind:.2,instinct:.2},skills:{base:["BASIC_MOVE","BASIC_ATTACK","BOMB_TOSS"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","BOMB_TOSS"],passive:[]}},warlock:{packUnitId:"ENEMY_WARLOCK_V1",bestiary:{subtype:"warlock",name:"Warlock",stats:{hp:1,maxHp:1,range:4,damage:1,type:"ranged",cost:2,actionCooldown:2,weightClass:"Standard",speed:1},trinity:{body:.4,mind:.6,instinct:.2},skills:{base:["BASIC_MOVE","BASIC_ATTACK","SENTINEL_BLAST"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","SENTINEL_BLAST"],passive:[]}},sentinel:{packUnitId:"ENEMY_SENTINEL_V1",bestiary:{subtype:"sentinel",name:"Sentinel",stats:{hp:30,maxHp:30,range:4,damage:2,type:"boss",cost:25,actionCooldown:1,weightClass:"Heavy",speed:1},trinity:{body:4,mind:2,instinct:2},skills:{base:["BASIC_MOVE","BASIC_ATTACK","SENTINEL_BLAST"],passive:[]}},runtimeSkills:{base:["BASIC_MOVE","SENTINEL_TELEGRAPH","SENTINEL_BLAST"],passive:[]}}},_v=e=>Vo[e],wv=Object.keys(Vo),Xg=e=>{const n=Vo[e];return{subtype:e,...n}},Mv=()=>wv.map(Xg),Ll=e=>{const n=e;if(Object.prototype.hasOwnProperty.call(Vo,n))return Xg(n)},yy=(e,n={})=>{const s=Ll(e);if(!s)return[];const o=n.includePassive??!0,l=(n.source??"runtime")==="runtime"?s.runtimeSkills:s.bestiary.skills;return o?[...l.base,...l.passive]:[...l.base]},Pd={0:{budget:0,allowedSubtypes:[]},1:{budget:2,allowedSubtypes:["footman"]},2:{budget:3,allowedSubtypes:["footman","sprinter"]},3:{budget:5,allowedSubtypes:["footman","archer"]},4:{budget:7,allowedSubtypes:["footman","archer","bomber","raider"]},5:{budget:10,allowedSubtypes:["footman","archer","bomber","shieldBearer","raider"]},6:{budget:12,allowedSubtypes:["footman","archer","bomber","shieldBearer","warlock","pouncer"]},7:{budget:15,allowedSubtypes:["footman","archer","bomber","shieldBearer","warlock","sprinter","pouncer"]},8:{budget:18,allowedSubtypes:["footman","archer","bomber","shieldBearer","warlock","sprinter","pouncer"]},9:{budget:22,allowedSubtypes:["footman","archer","bomber","shieldBearer","warlock","sprinter","pouncer"]},10:{budget:0,allowedSubtypes:[]}},gy=Math.max(...Object.keys(Pd).map(Number)),Cv=e=>{const n=Math.max(0,Math.floor(e)),s=Math.min(n,gy),o=Pd[s]||Pd[gy];return{floor:s,budget:o.budget,allowedSubtypes:[...o.allowedSubtypes]}},al=(e,n)=>{const s=e.propensities[n];if(!(!s||s.method!=="fixed"))return s.value},by=(e,n)=>e.length===n.length&&e.every((s,o)=>s===n[o]),Ov=e=>{const n=[],s=new Map;for(const o of e.units)o.actorType!=="enemy"||!o.subtype||s.set(o.subtype,o);for(const o of Mv()){const a=s.get(o.subtype);if(!a){n.push({code:"MISSING_UNIT_FOR_SUBTYPE",subtype:o.subtype,message:`Missing enemy unit definition for subtype "${o.subtype}"`});continue}a.id!==o.packUnitId&&n.push({code:"PACK_UNIT_ID_MISMATCH",subtype:o.subtype,message:`Unit id "${a.id}" does not match content packUnitId "${o.packUnitId}"`}),a.weightClass!==o.bestiary.stats.weightClass&&n.push({code:"WEIGHT_CLASS_MISMATCH",subtype:o.subtype,message:`weightClass "${a.weightClass}" does not match bestiary "${o.bestiary.stats.weightClass}"`});const l=al(a,"speed");(l===void 0||l!==o.bestiary.stats.speed)&&n.push({code:"SPEED_PROPENSITY_MISMATCH",subtype:o.subtype,message:`speed propensity "${String(l)}" does not match bestiary "${o.bestiary.stats.speed}"`});const u=al(a,"body"),f=al(a,"mind"),p=al(a,"instinct");(u===void 0||f===void 0||p===void 0||u!==o.bestiary.trinity.body||f!==o.bestiary.trinity.mind||p!==o.bestiary.trinity.instinct)&&n.push({code:"TRINITY_PROPENSITY_MISMATCH",subtype:o.subtype,message:`trinity propensities {body:${String(u)}, mind:${String(f)}, instinct:${String(p)}} do not match bestiary {body:${o.bestiary.trinity.body}, mind:${o.bestiary.trinity.mind}, instinct:${o.bestiary.trinity.instinct}}`});const h=o.runtimeSkills.base,g=o.runtimeSkills.passive;by(a.skillLoadout.baseSkillIds,h)||n.push({code:"BASE_SKILL_LOADOUT_MISMATCH",subtype:o.subtype,message:`baseSkillIds ${JSON.stringify(a.skillLoadout.baseSkillIds)} do not match runtimeSkills.base ${JSON.stringify(h)}`});const b=a.skillLoadout.passiveSkillIds||[];by(b,g)||n.push({code:"PASSIVE_SKILL_LOADOUT_MISMATCH",subtype:o.subtype,message:`passiveSkillIds ${JSON.stringify(b)} do not match runtimeSkills.passive ${JSON.stringify(g)}`})}return n},Nv=e=>{const n=Ov(e);if(n.length===0)return;const s=n.map(o=>`[${o.code}] ${o.subtype}: ${o.message}`).join(" | ");throw new Error(`Enemy content consistency validation failed: ${s}`)},Me={getTileAt(e,n){const s=ce(n);let o;return e.tiles&&(e.tiles instanceof Map?o=e.tiles.get(s):Array.isArray(e.tiles)?o=e.tiles.find(a=>Array.isArray(a)&&a[0]===s||a.position&&Q(a.position,n)):o=e.tiles[s]),o||{position:n,baseId:"STONE",traits:new Set(["WALKABLE"]),effects:[]}},getTraitsForTile(e,n){const s=new Set,o=n.position;return Gi(o,e.gridWidth,e.gridHeight)?(n.baseId==="LAVA"&&(s.add("HAZARDOUS"),s.add("LIQUID"),s.add("LAVA")),n.baseId==="WALL"&&(s.add("BLOCKS_MOVEMENT"),s.add("BLOCKS_LOS"),s.add("ANCHOR")),n.traits.forEach(l=>s.add(l)),n.effects.forEach(l=>{l.id==="FIRE"&&(s.add("FIRE"),s.add("HAZARDOUS")),l.id==="ICE_WALL"&&(s.add("BLOCKS_MOVEMENT"),s.add("BLOCKS_LOS"),s.add("ANCHOR")),l.id==="SMOKE"&&s.add("BLOCKS_LOS")}),s):(s.add("BLOCKS_MOVEMENT"),s.add("BLOCKS_LOS"),s.add("ANCHOR"),s)},getTraitsAt(e,n){const s=this.getTileAt(e,n);return this.getTraitsForTile(e,s)},isPassable(e,n){const s=this.getTraitsAt(e,n);return!s.has("BLOCKS_MOVEMENT")&&!s.has("HAZARDOUS")},isWalkable(e,n){return!this.getTraitsAt(e,n).has("BLOCKS_MOVEMENT")},isLosBlocking(e,n){return this.getTraitsAt(e,n).has("BLOCKS_LOS")},isAnchorable(e,n){return this.getTraitsAt(e,n).has("ANCHOR")},hasTrait(e,n,s){return this.getTraitsAt(e,n).has(s)}},kv=(e,n)=>Array(n).fill(0n),pd=(e,n,s)=>{if(!Number.isInteger(n.q)||!Number.isInteger(n.r))return[...e];if(n.r<0||n.r>=e.length||n.q<0)return[...e];const o=[...e];return o[n.r]|=1n<<BigInt(n.q),o},jd=(e,n)=>n.r<0||n.r>=e.length?!0:(e[n.r]&1n<<BigInt(n.q))!==0n,Sy=(e,n)=>{if(n.playerStart&&Q(e,n.playerStart)||n.stairsPosition&&Q(e,n.stairsPosition)||n.shrinePosition&&Q(e,n.shrinePosition))return!0;if(n.tiles){const s=Me.getTraitsAt(n,e);if(s.has("HAZARDOUS")||s.has("BLOCKS_MOVEMENT"))return!0}return!1},Ln=(e,n)=>{if(e)return e.find(s=>s&&s.position&&Q(s.position,n))},ye=(e,n)=>Q(e.player.position,n)?e.player:Ln(e.enemies,n),Rv=(e,n)=>!!e.shrinePosition&&Q(n,e.shrinePosition),Iv=(e,n)=>!(!Q(n,e.stairsPosition)||e.enemies.some(o=>o.subtype==="sentinel"&&o.hp>0)),Lv=(e,n,s,o)=>{const a=fe(s,o);if(a===0)return[];const l=(o.q-s.q)/a,u=(o.r-s.r)/a,f=(o.s-s.s)/a,p=[],h=new Set,g=2;for(let b=1;b<=g;b++){const S={q:o.q+Math.round(l*b),r:o.r+Math.round(u*b),s:o.s+Math.round(f*b)};if(Gi(S,e.gridWidth,e.gridHeight)){const T=`${S.q},${S.r}`;h.has(T)||(h.add(T),p.push(S))}}return p},hd=(e,n,s)=>Math.max(n,Math.min(s,e)),_o=e=>Math.round(e*1e3)/1e3,ef=e=>{const n=Math.max(0,e.body),s=Math.max(0,e.mind),o=Math.max(0,e.instinct);return{bodyDamageMultiplier:_o(1+n/20),bodyMitigation:_o(hd(n*.01,0,.5)),mindStatusDurationBonus:Math.floor(s/15),mindMagicMultiplier:_o(1+s/20),instinctInitiativeBonus:o*2,instinctCriticalMultiplier:_o(1+hd(o,0,10)*.02),instinctSparkDiscountMultiplier:_o(1-hd(o,0,100)/100)}},Fl=e=>{const n=Math.max(0,e.body),s=Math.max(0,e.mind),o=Math.max(0,e.instinct),a={base:0,body:5,mind:2,instinct:3},l=Math.floor(n*a.body+s*a.mind+o*a.instinct+a.base);return Math.max(1,l)},Ot={body:0,mind:0,instinct:0},Bv=e=>({body:e.body,mind:e.mind,instinct:e.instinct}),Sa=e=>{const n={};for(const[s,o]of Object.entries(e))n[s]=Bv(o);return n},Hv={neutral:{id:"neutral",default:Ot,archetype:Sa({VANGUARD:Ot,SKIRMISHER:Ot,FIREMAGE:Ot,NECROMANCER:Ot,HUNTER:Ot,ASSASSIN:Ot}),enemySubtype:Sa({footman:Ot,sprinter:Ot,raider:Ot,pouncer:Ot,shieldBearer:Ot,archer:Ot,bomber:Ot,warlock:Ot,sentinel:Ot}),companionSubtype:Sa({falcon:Ot,skeleton:Ot})},live:{id:"live",default:Ot,archetype:Sa({VANGUARD:{body:9,mind:4,instinct:5},SKIRMISHER:{body:7,mind:6,instinct:10},FIREMAGE:{body:2,mind:9,instinct:4},NECROMANCER:{body:5,mind:9,instinct:5},HUNTER:{body:3,mind:4,instinct:8},ASSASSIN:{body:3,mind:3,instinct:9}}),enemySubtype:Sa({footman:{body:0,mind:0,instinct:0},sprinter:{body:0,mind:0,instinct:0},raider:{body:.4,mind:0,instinct:.2},pouncer:{body:.4,mind:0,instinct:.2},shieldBearer:{body:1,mind:0,instinct:.4},archer:{body:.2,mind:0,instinct:.2},bomber:{body:.4,mind:.2,instinct:.2},warlock:{body:.4,mind:.6,instinct:.2},sentinel:{body:4,mind:2,instinct:2}}),companionSubtype:Sa({falcon:{body:2,mind:2,instinct:9},skeleton:{body:15,mind:1,instinct:4}})}},Pv=e=>e?.toLowerCase()==="neutral"?"neutral":"live",jv=()=>globalThis?.process?.env?.HOP_TRINITY_PROFILE,Dv=e=>Hv[Pv(jv())];function Dd(e,n){return e?.get(n)}const Rn={outgoingPhysical:1,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},Uv={VANGUARD:Rn,SKIRMISHER:Rn,FIREMAGE:Rn,NECROMANCER:Rn,HUNTER:Rn,ASSASSIN:Rn},$v={footman:{outgoingPhysical:3,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},sprinter:{outgoingPhysical:2.8,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},raider:{outgoingPhysical:3.2,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},pouncer:{outgoingPhysical:3.2,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},shieldBearer:{outgoingPhysical:3.5,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},archer:{outgoingPhysical:2.6,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},bomber:{outgoingPhysical:2.8,outgoingMagical:3,incomingPhysical:1,incomingMagical:1},warlock:{outgoingPhysical:1.5,outgoingMagical:3.5,incomingPhysical:1,incomingMagical:1},sentinel:{outgoingPhysical:4,outgoingMagical:4,incomingPhysical:1,incomingMagical:1}},qv={falcon:{outgoingPhysical:1.2,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},skeleton:{outgoingPhysical:1.1,outgoingMagical:1,incomingPhysical:1,incomingMagical:1}},Io=e=>({outgoingPhysical:e.outgoingPhysical,outgoingMagical:e.outgoingMagical,incomingPhysical:e.incomingPhysical,incomingMagical:e.incomingMagical}),Jg=e=>e.type==="player"?Io(Uv[(e.archetype||"VANGUARD").toUpperCase()]||Rn):e.companionOf&&e.subtype?Io(qv[e.subtype]||Rn):e.subtype?Io($v[e.subtype]||Rn):Io(Rn),Qg=e=>{const n=Dd(e.components,"combat_profile");return n?{outgoingPhysical:Number.isFinite(n.outgoingPhysical)?n.outgoingPhysical:1,outgoingMagical:Number.isFinite(n.outgoingMagical)?n.outgoingMagical:1,incomingPhysical:Number.isFinite(n.incomingPhysical)?n.incomingPhysical:1,incomingMagical:Number.isFinite(n.incomingMagical)?n.incomingMagical:1}:Io(Rn)},zv=(e,n)=>{const s=Qg(e);return n==="magical"?s.outgoingMagical:s.outgoingPhysical},Vv=(e,n)=>{const s=Qg(e);return n==="magical"?s.incomingMagical:s.incomingPhysical},Yv=()=>{const e=Object.entries(Vo).map(([n,s])=>[n,s.bestiary]);return Object.fromEntries(e)},Kv=Yv(),Fv=e=>Kv[e],Wv=(e,n={})=>{const s=Fv(e);return s?n.includePassive??!0?[...s.skills.base,...s.skills.passive]:[...s.skills.base]:[]},wo=e=>({body:e.body,mind:e.mind,instinct:e.instinct}),Zg=e=>{if(e.trinity)return wo(e.trinity);const n=Dv(),s=n.default;if(e.type==="player"){const o=(e.archetype||"VANGUARD").toUpperCase();return wo(n.archetype[o]||s)}if(e.companionOf&&e.subtype){const o=e.subtype;if(n.companionSubtype[o])return wo(n.companionSubtype[o])}return e.subtype?wo(n.enemySubtype[e.subtype]||s):wo(s)},Lo=e=>{const n=new Map(e.components||[]),s=n.has("trinity"),o=n.has("combat_profile");if(s&&o)return e;const a=Zg({id:e.id,type:e.type,subtype:e.subtype,position:e.position,hp:e.hp,maxHp:e.maxHp,speed:e.speed,factionId:e.factionId,archetype:e.archetype,companionOf:e.companionOf}),l=Jg({type:e.type,archetype:e.archetype,subtype:e.subtype,companionOf:e.companionOf});return s||n.set("trinity",{type:"trinity",...a}),o||n.set("combat_profile",{type:"combat_profile",...l}),{...e,components:n}};function Gv(e){return e.map(n=>({id:n,name:String(n),description:String(n),slot:"utility",cooldown:0,currentCooldown:0,range:0,upgrades:[],activeUpgrades:[]}))}function Wi(e){const n=e.activeSkills?[...e.activeSkills]:Gv(e.skills||[]),s=new Map(e.components||[]),o=Zg(e),a=e.combatProfile||Jg(e);s.has("trinity")||s.set("trinity",{type:"trinity",...o}),s.has("combat_profile")||s.set("combat_profile",{type:"combat_profile",...a});const l=Fl(o),u=Math.max(1,e.maxHp??l),f=Math.min(u,Math.max(0,e.hp??u));return e.weightClass&&s.set("physics",{type:"physics",weightClass:e.weightClass}),e.archetype&&s.set("archetype",{type:"archetype",archetype:e.archetype}),{id:e.id,type:e.type,subtype:e.subtype,position:e.position,hp:f,maxHp:u,speed:e.speed,factionId:e.factionId,initiative:e.initiative,statusEffects:[],temporaryArmor:0,activeSkills:n,weightClass:e.weightClass,archetype:e.archetype,components:s,isFlying:e.isFlying,companionOf:e.companionOf,isVisible:!0}}function Xv(e){const n=Wi({id:e.id,type:"enemy",subtype:e.subtype,position:e.position,hp:e.hp,maxHp:e.maxHp,speed:e.speed,factionId:"enemy",skills:e.skills,weightClass:e.weightClass||"Standard",trinity:e.trinity});return n.enemyType=e.enemyType,n}function e0(e){if(e.companionType==="falcon"){const n=Wi({id:e.id||`falcon-${e.ownerId}`,type:"enemy",subtype:"falcon",position:e.position,speed:95,factionId:"player",skills:["BASIC_MOVE","FALCON_PECK","FALCON_APEX_STRIKE","FALCON_HEAL","FALCON_SCOUT","FALCON_AUTO_ROOST"],weightClass:"Light",isFlying:!0,companionOf:e.ownerId,trinity:e.trinity});return n.companionState={mode:"roost",orbitStep:0},n}return e.companionType==="skeleton"?Wi({id:e.id||`${e.companionType}-${e.ownerId}`,type:"enemy",subtype:"skeleton",position:e.position,hp:2,maxHp:2,speed:50,factionId:"player",skills:["BASIC_MOVE","BASIC_ATTACK","AUTO_ATTACK"],companionOf:e.ownerId,weightClass:"Standard",trinity:e.trinity}):Wi({id:e.id||`${e.companionType}-${e.ownerId}`,type:"enemy",subtype:e.companionType,position:e.position,speed:80,factionId:"player",skills:["BASIC_MOVE","BASIC_ATTACK"],companionOf:e.ownerId,weightClass:"Standard",trinity:e.trinity})}function Jv(e){return e0({companionType:"falcon",ownerId:e.ownerId,position:e.position})}function Qv(e){const n=Wv(e);return n.length>0?n:["BASIC_MOVE"]}class vy extends Error{issues;constructor(n,s){super(`${n} validation failed:
${s.map(o=>`${o.path}: ${o.message}`).join(`
`)}`),this.name="ContractValidationError",this.issues=s}}const Et=e=>typeof e=="object"&&e!==null&&!Array.isArray(e),fi=e=>typeof e=="number"&&Number.isFinite(e),Nn=e=>Number.isInteger(e),Xe=e=>typeof e=="string",de=(e,n,s)=>e.push({path:n,message:s}),Zv=e=>{if(!Xe(e))return e;try{return JSON.parse(e)}catch(n){throw new Error(`Invalid JSON: ${n.message}`)}},Bo=(e,n,s,o={})=>{if(!Array.isArray(e))return de(n,s,"Expected array");const a=new Set;o.nonEmpty&&e.length===0&&de(n,s,"Must not be empty"),e.forEach((l,u)=>{if(!Xe(l)||l.length===0)return de(n,`${s}[${u}]`,"Expected non-empty string");o.unique&&(a.has(l)&&de(n,`${s}[${u}]`,`Duplicate "${l}"`),a.add(l))})},xy=(e,n,s)=>{if(!Et(e))return de(n,s,"Expected object");fi(e.base)||de(n,`${s}.base`,"Expected number"),e.min!==void 0&&!fi(e.min)&&de(n,`${s}.min`,"Expected number"),e.max!==void 0&&!fi(e.max)&&de(n,`${s}.max`,"Expected number"),fi(e.min)&&fi(e.max)&&e.min>e.max&&de(n,s,"min must be <= max")},ex=(e,n,s)=>Et(e)?((!Xe(e.id)||e.id.length===0)&&de(n,`${s}.id`,"Expected non-empty string"),Bo(e.tags,n,`${s}.tags`,{nonEmpty:!0,unique:!0}),Xe(e.kind)?e.kind==="DEAL_DAMAGE"?(xy(e.amount,n,`${s}.amount`),(!Et(e.target)||!Xe(e.target.selector))&&de(n,`${s}.target`,"Expected selector"),!0):e.kind==="APPLY_STATUS"?((!Xe(e.statusId)||e.statusId.length===0)&&de(n,`${s}.statusId`,"Expected statusId"),(!Nn(e.duration)||e.duration<0)&&de(n,`${s}.duration`,"Expected integer >= 0"),(!Et(e.target)||!Xe(e.target.selector))&&de(n,`${s}.target`,"Expected selector"),!0):e.kind==="APPLY_FORCE"?Et(e.force)?((!Xe(e.force.mode)||!new Set(["push","pull"]).has(e.force.mode))&&de(n,`${s}.force.mode`,"Expected push|pull"),(!Xe(e.force.direction)||!new Set(["source_to_target","target_to_source"]).has(e.force.direction))&&de(n,`${s}.force.direction`,"Invalid direction"),(!Nn(e.force.maxDistance)||e.force.maxDistance<0)&&de(n,`${s}.force.maxDistance`,"Expected integer >= 0"),xy(e.force.magnitude,n,`${s}.force.magnitude`),Et(e.force.collision)||de(n,`${s}.force.collision`,"Expected object"),!0):(de(n,`${s}.force`,"Expected object"),!0):e.kind==="MESSAGE"?((!Xe(e.text)||e.text.length===0)&&de(n,`${s}.text`,"Expected non-empty string"),!0):(de(n,`${s}.kind`,"Unknown kind"),!1):(de(n,`${s}.kind`,"Expected kind"),!1)):(de(n,s,"Expected object"),!1),tx=(e,n,s)=>{if(!Et(e))return de(n,s,"Expected object");if(!Xe(e.method))return de(n,`${s}.method`,"Expected method");if(e.method==="fixed"){fi(e.value)||de(n,`${s}.value`,"Expected number");return}if(e.method==="uniform_int"){Nn(e.min)||de(n,`${s}.min`,"Expected integer"),Nn(e.max)||de(n,`${s}.max`,"Expected integer"),Nn(e.min)&&Nn(e.max)&&e.min>e.max&&de(n,s,"min must be <= max");return}if(e.method==="triangular_int"){Nn(e.min)||de(n,`${s}.min`,"Expected integer"),Nn(e.mode)||de(n,`${s}.mode`,"Expected integer"),Nn(e.max)||de(n,`${s}.max`,"Expected integer");return}if(e.method==="weighted_table"){if(!Array.isArray(e.table)||e.table.length===0)return de(n,`${s}.table`,"Expected non-empty array");e.table.forEach((o,a)=>{if(!Et(o))return de(n,`${s}.table[${a}]`,"Expected object");fi(o.value)||de(n,`${s}.table[${a}].value`,"Expected number"),(!fi(o.weight)||o.weight<=0)&&de(n,`${s}.table[${a}].weight`,"Expected number > 0")});return}de(n,`${s}.method`,"Unknown propensity method")},nx=e=>{const n=[];if(!Et(e))return de(n,"$","Expected object"),n;if((!Xe(e.version)||!/^1\./.test(e.version))&&de(n,"$.version","Expected v1.x"),(!Xe(e.id)||!/^[A-Z0-9_]+$/.test(e.id))&&de(n,"$.id","Expected uppercase id"),(!Xe(e.name)||e.name.length===0)&&de(n,"$.name","Expected non-empty string"),(!Xe(e.actorType)||!new Set(["player","enemy"]).has(e.actorType))&&de(n,"$.actorType","Expected player|enemy"),(!Xe(e.factionId)||e.factionId.length===0)&&de(n,"$.factionId","Expected non-empty string"),(!Et(e.coordSpace)||e.coordSpace.system!=="cube-axial"||e.coordSpace.pointFormat!=="qrs")&&de(n,"$.coordSpace","Expected {system:cube-axial,pointFormat:qrs}"),Et(e.instantiate)?((!Xe(e.instantiate.rngStream)||e.instantiate.rngStream.length===0)&&de(n,"$.instantiate.rngStream","Expected non-empty string"),(!Xe(e.instantiate.counterMode)||!new Set(["consume_global","stateless"]).has(e.instantiate.counterMode))&&de(n,"$.instantiate.counterMode","Expected consume_global|stateless"),Bo(e.instantiate.drawOrder,n,"$.instantiate.drawOrder",{nonEmpty:!0,unique:!0})):de(n,"$.instantiate","Expected object"),!Et(e.propensities))de(n,"$.propensities","Expected object");else{const s=e.propensities;["body","mind","instinct","speed","mass"].forEach(o=>{o in s||de(n,`$.propensities.${o}`,"Missing required propensity")}),Object.entries(s).forEach(([o,a])=>tx(a,n,`$.propensities.${o}`))}return Et(e.skillLoadout)?(Bo(e.skillLoadout.baseSkillIds,n,"$.skillLoadout.baseSkillIds",{nonEmpty:!0,unique:!0}),e.skillLoadout.passiveSkillIds!==void 0&&Bo(e.skillLoadout.passiveSkillIds,n,"$.skillLoadout.passiveSkillIds",{unique:!0})):de(n,"$.skillLoadout","Expected object"),n},ix=e=>{const n=[];return Et(e)?((!Xe(e.version)||!/^1\./.test(e.version))&&de(n,"$.version","Expected v1.x"),(!Xe(e.id)||!/^[A-Z0-9_]+$/.test(e.id))&&de(n,"$.id","Expected uppercase id"),(!Xe(e.name)||e.name.length===0)&&de(n,"$.name","Expected non-empty string"),(!Xe(e.slot)||!new Set(["offensive","defensive","utility","passive"]).has(e.slot))&&de(n,"$.slot","Invalid slot"),Bo(e.keywords,n,"$.keywords",{unique:!0}),Et(e.targeting)?((!Xe(e.targeting.mode)||!new Set(["self","single","line","radius","global"]).has(e.targeting.mode))&&de(n,"$.targeting.mode","Invalid mode"),(!Nn(e.targeting.range)||e.targeting.range<0)&&de(n,"$.targeting.range","Expected integer >= 0"),typeof e.targeting.requiresLos!="boolean"&&de(n,"$.targeting.requiresLos","Expected boolean"),typeof e.targeting.allowOccupied!="boolean"&&de(n,"$.targeting.allowOccupied","Expected boolean")):de(n,"$.targeting","Expected object"),(!Et(e.stackPolicy)||e.stackPolicy.resolveOrder!=="LIFO")&&de(n,"$.stackPolicy.resolveOrder","MVP requires LIFO"),Et(e.baseAction)?(Et(e.baseAction.costs)?((!fi(e.baseAction.costs.energy)||e.baseAction.costs.energy<0)&&de(n,"$.baseAction.costs.energy","Expected number >= 0"),(!Nn(e.baseAction.costs.cooldown)||e.baseAction.costs.cooldown<0)&&de(n,"$.baseAction.costs.cooldown","Expected integer >= 0"),typeof e.baseAction.costs.consumesTurn!="boolean"&&de(n,"$.baseAction.costs.consumesTurn","Expected boolean")):de(n,"$.baseAction.costs","Expected object"),!Array.isArray(e.baseAction.effects)||e.baseAction.effects.length===0?de(n,"$.baseAction.effects","Expected non-empty array"):e.baseAction.effects.forEach((s,o)=>ex(s,n,`$.baseAction.effects[${o}]`))):de(n,"$.baseAction","Expected object"),Array.isArray(e.upgrades)?e.upgrades.forEach((s,o)=>{if(!Et(s))return de(n,`$.upgrades[${o}]`,"Expected object");(!Xe(s.id)||!/^[A-Z0-9_]+$/.test(s.id))&&de(n,`$.upgrades[${o}].id`,"Expected uppercase id"),(!Xe(s.name)||s.name.length===0)&&de(n,`$.upgrades[${o}].name`,"Expected non-empty string"),Array.isArray(s.modifiers)||de(n,`$.upgrades[${o}].modifiers`,"Expected array")}):de(n,"$.upgrades","Expected array"),n):(de(n,"$","Expected object"),n)},sx=e=>{const n=Zv(e),s=[];if(!Et(n))throw new vy("TacticalDataPack",[{path:"$",message:"Expected pack object"}]);if((!Xe(n.version)||!/^1\./.test(n.version))&&s.push({path:"$.version",message:"Expected v1.x string"}),Array.isArray(n.units)?n.units.forEach((o,a)=>{nx(o).forEach(u=>s.push({path:`$.units[${a}]${u.path.slice(1)}`,message:u.message}))}):s.push({path:"$.units",message:"Expected array"}),Array.isArray(n.skills)?n.skills.forEach((o,a)=>{ix(o).forEach(u=>s.push({path:`$.skills[${a}]${u.path.slice(1)}`,message:u.message}))}):s.push({path:"$.skills",message:"Expected array"}),s.length>0)throw new vy("TacticalDataPack",s);return n},ax=e=>({definition:e,drawOrder:[...e.instantiate.drawOrder],skillIds:[...e.skillLoadout.baseSkillIds],passiveSkillIds:[...e.skillLoadout.passiveSkillIds||[]]}),ox={Light:3,Standard:5,Heavy:8,Anchored:12,OuterWall:20},rx=e=>({version:"1.0.0",id:e.id,name:e.name,actorType:"enemy",subtype:e.subtype,factionId:"enemy",weightClass:e.weightClass,coordSpace:{system:"cube-axial",pointFormat:"qrs"},instantiate:{rngStream:"enemy.instantiate",seedSalt:e.subtype,counterMode:"consume_global",drawOrder:["body","mind","instinct","speed","mass"],includeRollTrace:!1},propensities:{body:{method:"fixed",value:e.trinity.body},mind:{method:"fixed",value:e.trinity.mind},instinct:{method:"fixed",value:e.trinity.instinct},speed:{method:"fixed",value:e.speed},mass:{method:"fixed",value:ox[e.weightClass]}},derivedStats:{maxHp:{formula:"trinity_hp_v1"}},physics:{collisionPolicy:"crush_damage",crushModel:{baseDamage:0,impulseMultiplier:1,massDivider:1,minDamage:1}},skillLoadout:{baseSkillIds:e.baseSkills,passiveSkillIds:e.passiveSkills||[]},runtimeDefaults:{startingHp:"maxHp",temporaryArmor:0,isVisible:!0}}),di=e=>{const n=_v(e);if(!n)throw new Error(`Missing MVP enemy content for ${e}`);const s=n.bestiary;return rx({id:n.packUnitId,name:s.name,subtype:s.subtype,weightClass:s.stats.weightClass,speed:s.stats.speed,trinity:s.trinity,baseSkills:n.runtimeSkills.base,passiveSkills:n.runtimeSkills.passive})},lx={version:"1.0.0",id:"SHIELD_BASH_V1",name:"Shield Bash V1",description:"Data-driven migration variant of shield bash.",slot:"offensive",keywords:["Momentum"],intentTags:["damage","control","move"],targeting:{mode:"single",range:1,requiresLos:!0,allowOccupied:!0,deterministicSort:"distance_then_q_then_r"},stackPolicy:{resolveOrder:"LIFO",reactionWindow:"automated",playerPriority:!1,emitTickEvents:!0},baseAction:{costs:{energy:0,cooldown:2,consumesTurn:!0},effects:[{id:"shield_bash_v1_force",kind:"APPLY_FORCE",tags:["movement","momentum"],target:{selector:"targetActor"},force:{mode:"push",direction:"source_to_target",magnitude:{base:2,scaling:[{stat:"body",coefficient:.2}],min:1,round:"floor"},maxDistance:3,collision:{onBlocked:"crush_damage",crushDamage:{base:1,scaling:[{stat:"momentum",coefficient:1}],min:1,round:"floor"}}}},{id:"shield_bash_v1_damage",kind:"DEAL_DAMAGE",tags:["damage","physical"],target:{selector:"targetActor"},amount:{base:2,scaling:[{stat:"body",coefficient:.4}],min:1,round:"floor"},damageClass:"physical",reason:"shield_bash_v1"}]},reactivePassives:[],upgrades:[],inhibit:{filterMode:"exclude_matching_tags",removableTags:["movement","momentum"]},preview:{dryRunEnabled:!0,eventMap:{APPLY_FORCE:"UnitMoved",DEAL_DAMAGE:"DamageTaken"}}},Ay={version:"1.0.0",units:[di("footman"),di("sprinter"),di("raider"),di("pouncer"),di("shieldBearer"),di("archer"),di("bomber"),di("warlock"),di("sentinel")],skills:[lx]},cx=new Map,t0=new Map,ux=e=>(cx.set(e.id,e),e.subtype&&t0.set(e.subtype,e),e),dx=e=>e.map(ux),fx=e=>t0.get(e);function Tn(e,n){const s=e.tiles.get(ce(n));return!!(s?.traits.has("BLOCKS_LOS")||s?.baseId==="WALL")}function ws(e,n){const s=e.tiles.get(ce(n));return s?.baseId==="LAVA"||s?.traits.has("LIQUID")||!1}function Xi(e,n,s){const o=ye(e,n);return!!o&&o.id!==s}function bt(e,n,s){const o=fe(e,n);return o>=1&&o<=s}function En(e,n){const s=Bn(e,n);return{isAxial:s!==-1,directionIndex:s}}function tf(e,n,s={}){const{checkWalls:o=!0,checkActors:a=!0,checkLava:l=!1,excludeActorId:u}=s;for(const f of n){if(o&&Tn(e,f))return{obstacle:"wall",position:f};if(l&&ws(e,f))return{obstacle:"lava",position:f};if(a){const p=ye(e,f);if(p&&p.id!==u)return{obstacle:"actor",position:f,actor:p}}}return{}}function nf(e,n,s,o={}){const l=Ze(n,s).slice(1),{stopAtWalls:u=!0,stopAtActors:f=!0,stopAtLava:p=!1,excludeActorId:h}=o,g=tf(e,l,{checkWalls:u,checkActors:f,checkLava:p,excludeActorId:h});return g.obstacle&&g.position&&!Q(g.position,s)?{isValid:!1,blockedBy:g.obstacle,blockedAt:g.position}:{isValid:!0}}function Bl(e,n,s,o,a){const u=Ze(n,s).slice(1),f=tf(e,u,{checkWalls:!0,checkActors:!0,checkLava:!1,excludeActorId:a});return f.obstacle==="actor"&&f.actor?.id===o&&!!f.position&&Q(f.position,s)}function mx(e,n){const s=Me.getTraitsAt(e,n),o=s.has("HAZARDOUS")||s.has("LAVA")||s.has("FIRE")||s.has("VOID"),a=s.has("LAVA")||s.has("FIRE");return{isHazard:o,isFireHazard:a}}function pi(e,n,s){const{isHazard:o,isFireHazard:a}=mx(e,s);return!!(!o||n.isFlying||(n.activeSkills?.some(u=>u.id==="ABSORB_FIRE")||n.statusEffects?.some(u=>u.type==="fire_immunity"))&&a)}function n0(e,n,s,o){return pi(e,n,s)?!0:new Set(["JUMP","VAULT","GRAPPLE_HOOK","DASH"]).has(o)}const qt=(e,n,s)=>Math.max(n,Math.min(s,e)),Tt=e=>Math.round(e*1e3)/1e3,px=()=>globalThis?.process?.env?.HOP_COMBAT_INTERACTION_MODEL,hx=e=>e.length===0?1:e.reduce((n,s)=>n*s.multiplier,1),yx=e=>{let n=1;if(e.inDangerPreviewHex&&(n+=.15),typeof e.proximityDistance=="number"){const s=qt(e.proximityDistance,0,6);n+=(6-s)*.02}return n},gx=(e,n,s,o,a,l,u,f)=>{if(!n)return{multiplier:1,pressure:0,rangePressure:0,rangeMultiplier:1};const p=s==="physical"?.85+e.instinct*.015+e.body*.005:.85+e.mind*.015+e.instinct*.005,h=s==="physical"?n.instinct*.012+n.body*.004:n.instinct*.008+n.mind*.008,g=qt(p-h,.1,.99);if(typeof o!="number")return{multiplier:g,pressure:Tt(p-h),rangePressure:0,rangeMultiplier:1};const b={min:qt(a??(s==="physical"?1:2),1,6),max:qt(l??(s==="physical"?2:4),1,6)};if(b.max<b.min){const k=b.min;b.min=b.max,b.max=k}const S={min:qt(u??(s==="physical"?1:2),1,6),max:qt(f??(s==="physical"?3:5),1,6)};if(S.max<S.min){const k=S.min;S.min=S.max,S.max=k}const T=qt(o,1,6),v=Math.max(0,b.min-T),A=Math.max(0,T-b.max),_=v*.06+A*.1,E=e.instinct*.015,w=(T>=S.min&&T<=S.max?.05:0)+n.instinct*.006,M=E-_-w,C=qt(1+M,.55,1.25);return{multiplier:qt(g*C,.05,.99),pressure:Tt(p-h),rangePressure:Tt(M),rangeMultiplier:Tt(C)}},bx=(e,n)=>{if(!e)return{multiplier:1,pressure:0};const s=qt(n==="physical"?e.body*.01+e.instinct*.004:e.mind*.01+e.instinct*.004,0,.75);return{multiplier:1-s,pressure:Tt(s)}},Sx=(e,n,s,o)=>{if(!n)return{multiplier:o,critPressure:0,resistancePressure:0};const a=qt(s==="physical"?.05+e.instinct*.01:.05+e.mind*.01,0,.75),l=qt(s==="physical"?n.body*.006+n.instinct*.004:n.mind*.006+n.instinct*.004,0,.7);return{multiplier:1+qt(a-l,0,.75)*(o-1),critPressure:Tt(a),resistancePressure:Tt(l)}},vx=(e,n,s,o,a)=>{const l=e.scaling.filter(b=>b.attribute==="body").reduce((b,S)=>b+(e.trinity.body||0)*S.coefficient,0),u=e.scaling.filter(b=>b.attribute==="mind").reduce((b,S)=>b+(e.trinity.mind||0)*S.coefficient,0),f=e.scaling.filter(b=>b.attribute==="instinct").reduce((b,S)=>b+(e.trinity.instinct||0)*S.coefficient,0),p=e.damageClass==="physical"?Math.max(0,e.basePower*(n.bodyDamageMultiplier-1)):0,h=e.damageClass==="magical"?Math.max(0,e.basePower*(n.mindMagicMultiplier-1)):0,g=Math.max(0,(a-1)*(s+o));return{body:Math.max(0,p+l),mind:Math.max(0,h+u),instinct:Math.max(0,f+g)}},xx=(e,n)=>{if(e<=0)return e;const s=ef(n).mindStatusDurationBonus;return e+s},Ax=e=>ef(e).instinctInitiativeBonus,_t=e=>{const n=ef(e.trinity),s=e.damageClass||"physical",o=px()==="triangle"?"triangle":"legacy",a=e.interactionModel||o,l=s==="magical"?n.mindMagicMultiplier:n.bodyDamageMultiplier,u=e.basePower*l,f=e.scaling.reduce((R,$)=>{const j=e.trinity[$.attribute]||0;return R+j*$.coefficient},0),p=hx(e.statusMultipliers),h=yx(e),g=n.instinctCriticalMultiplier,b=a==="triangle"?gx(e.trinity,e.targetTrinity,s,e.engagementRange,e.optimalRangeMin,e.optimalRangeMax,e.targetOptimalRangeMin,e.targetOptimalRangeMax):{multiplier:1,pressure:0,rangePressure:0,rangeMultiplier:1},S=a==="triangle"?bx(e.targetTrinity,s):{multiplier:1,pressure:0},T=a==="triangle"?Sx(e.trinity,e.targetTrinity,s,g):{multiplier:g,critPressure:0,resistancePressure:0},v=(u+f)*p*h*b.multiplier*S.multiplier*T.multiplier*(e.attackPowerMultiplier??1)*(e.targetDamageTakenMultiplier??1),A=Math.max(0,Math.floor(v)),_=vx(e,n,u,f,g),E=Math.max(1e-6,_.body+_.mind+_.instinct),w=Tt(_.body/E),M=Tt(_.mind/E),C=Tt(_.instinct/E),I=Math.max(1,e.theoreticalMaxPower??v),k=qt(A/I,0,1);return{basePower:e.basePower,bodyScaledPower:Tt(u),scalingPower:Tt(f),statusMultiplier:Tt(p),riskMultiplier:Tt(h),criticalMultiplier:Tt(g),hitMultiplier:Tt(b.multiplier),rangeMultiplier:Tt(b.rangeMultiplier),mitigationMultiplier:Tt(S.multiplier),critExpectedMultiplier:Tt(T.multiplier),finalPower:A,bodyContribution:w,mindContribution:M,instinctContribution:C,scoreEvent:{skillId:e.skillId,attackerId:e.attackerId,targetId:e.targetId,finalPower:A,efficiency:Tt(k),riskBonusApplied:!!e.inDangerPreviewHex,damageClass:s,hitPressure:b.pressure,rangePressure:b.rangePressure,mitigationPressure:S.pressure,critPressure:T.critPressure,resistancePressure:T.resistancePressure,bodyContribution:w,mindContribution:M,instinctContribution:C}}},Oe=e=>{const n=Dd(e.components,"trinity");if(n)return{body:n.body,mind:n.mind,instinct:n.instinct};const s=Dd(e.components,"stats"),o=s?.strength??0,a=s?.defense??0,l=s?.evasion??0;return{body:o,mind:a,instinct:l}},Tx=(e,n)=>e.player.id===n?e.player:e.enemies.find(s=>s.id===n)||e.companions?.find(s=>s.id===n),Ex=(e,n,s)=>!!(e.player.id!==s&&Q(e.player.position,n)||e.enemies.some(o=>o.id!==s&&o.hp>0&&Q(o.position,n))||e.companions?.some(o=>o.id!==s&&o.hp>0&&Q(o.position,n))),Ty=(e,n)=>{const s={q:n.q-e.q,r:n.r-e.r,s:n.s-e.s};let o=Po[0],a=Number.NEGATIVE_INFINITY;for(const l of Po){const u=l.q*s.q+l.r*s.r+l.s*s.s;u>a&&(a=u,o=l)}return o},_x=(e,n)=>{const s=Tx(e,n.targetActorId);if(!s)return{effects:[],destination:null,collided:!1};const o=Math.max(0,Math.min(n.maxDistance,Math.floor(n.magnitude)));if(o<=0)return{effects:[],destination:s.position,collided:!1};const a=s.position,l=n.mode==="push"?Ty(n.source,a):Ty(a,n.source),u=[a];let f=a,p=!1;for(let g=0;g<o;g++){const b=Vt(f,l);if(!Me.isWalkable(e,b)||Ex(e,b,s.id)){p=!0;break}u.push(b),f=b}const h=[];return Q(f,a)||h.push({type:"Displacement",target:s.id,destination:f,path:u,simulatePath:!0}),p&&n.collision.onBlocked==="crush_damage"&&h.push({type:"Damage",target:s.id,amount:Math.max(0,Math.floor(n.collision.crushDamage??0)),reason:n.damageReason||"crush"}),{effects:h,destination:f,collided:p}},ol=e=>JSON.parse(JSON.stringify(e)),wx=(e,n)=>n==="floor"?Math.floor(e):n==="round"?Math.round(e):n==="ceil"?Math.ceil(e):e,yd=(e,n)=>{let s=e.base;for(const o of e.scaling||[])s+=(n[o.stat]??0)*o.coefficient;return s=wx(s,e.round),e.min!==void 0&&(s=Math.max(e.min,s)),e.max!==void 0&&(s=Math.min(e.max,s)),s},Mx=(e,n,s,o)=>{const a=n.split(".");let l=e;for(let p=0;p<a.length-1;p++){const h=a[p],g=l[h];if(!g||typeof g!="object")return;l=g}const u=a[a.length-1],f=Number(l[u]);Number.isFinite(f)&&(s==="set"&&(l[u]=o),s==="add"&&(l[u]=f+o),s==="multiply"&&(l[u]=f*o))},Cx=(e,n,s)=>{let o=ol(e.baseAction.effects);const a=ol(e.reactivePassives||[]),l=new Set(e.keywords),u={};for(const f of e.upgrades)u[f.id]=f;for(const f of n){const p=u[f];if(p)for(const h of p.modifiers){if(h.op==="add_effect"&&o.push(ol(h.effect)),h.op==="remove_effect_by_tag"&&(o=o.filter(g=>!g.tags.includes(h.tag))),h.op==="modify_number"){const g=o.find(b=>b.id===h.effectId);g&&Mx(g,h.field,h.mode,h.value)}h.op==="add_keyword"&&l.add(h.keyword),h.op==="remove_keyword"&&l.delete(h.keyword),h.op==="add_reaction"&&a.push(ol(h.reaction))}}return e.inhibit?.filterMode==="exclude_matching_tags"&&s.size>0&&(o=o.filter(f=>!f.tags.some(p=>s.has(p)))),{effects:o,reactions:a,keywords:l}},Ox=(e,n)=>{const s=Oe(e),o=Number(n?.momentum??0),a=Number(n?.mass??1);return{body:s.body,mind:s.mind,instinct:s.instinct,mass:Number.isFinite(a)?a:1,speed:e.speed||1,momentum:Number.isFinite(o)?o:0}},gd=(e,n)=>n?ye(e,n)?.id:void 0,Nx=(e,n,s,o,a)=>{if(o.kind==="MESSAGE")return[{type:"Message",text:o.text}];if(o.kind==="DEAL_DAMAGE"){const p=Math.max(0,Math.floor(yd(o.amount,a))),h=gd(e,s);return[{type:"Damage",target:o.target.selector==="targetActor"?h||"targetActor":o.target.selector==="self"?n.id:s||"targetActor",amount:p,reason:o.reason}]}if(o.kind==="APPLY_STATUS"){const p=gd(e,s);return[{type:"ApplyStatus",target:o.target.selector==="targetActor"?p||"targetActor":o.target.selector==="self"?n.id:s||"targetActor",status:o.statusId,duration:o.duration}]}const l=gd(e,s);if(!l)return[];const u=yd(o.force.magnitude,a),f=o.force.collision.crushDamage?yd(o.force.collision.crushDamage,a):0;return _x(e,{source:n.position,targetActorId:l,mode:o.force.mode,magnitude:u,maxDistance:o.force.maxDistance,collision:{onBlocked:o.force.collision.onBlocked,crushDamage:f}}).effects},kx=(e,n,s,o)=>{const a=[];for(let l=0;l<e.gridWidth;l++)for(let u=0;u<e.gridHeight;u++){const f=Ft(l,u);Gi(f,e.gridWidth,e.gridHeight)&&fe(n,f)<=s&&a.push(f)}return a.sort((l,u)=>{if(o==="q_then_r")return l.q===u.q?l.r-u.r:l.q-u.q;if(o==="r_then_q")return l.r===u.r?l.q-u.q:l.r-u.r;const f=fe(n,l),p=fe(n,u);return f!==p?f-p:l.q===u.q?l.r-u.r:l.q-u.q}),a},Rx=e=>{const n=e.baseAction.effects.find(a=>a.kind==="DEAL_DAMAGE"),s=e.baseAction.effects.find(a=>a.kind==="APPLY_FORCE"),o={};return e.upgrades.forEach(a=>{o[a.id]={id:a.id,name:a.name,description:a.description||a.name}}),{id:e.id,name:e.name,description:e.description||e.name,slot:e.slot,icon:"data-driven",baseVariables:{range:e.targeting.range,cost:e.baseAction.costs.energy,cooldown:e.baseAction.costs.cooldown,damage:n?.amount?.base,momentum:s?.force?.magnitude?.base},execute:(a,l,u,f=[],p={})=>{const h=new Set(p.inhibitTags||[]),g=Cx(e,f,h),b=Ox(l,p),T=[...(g.reactions||[]).filter(A=>A.trigger==="ON_DECLARE").flatMap(A=>A.effects),...g.effects],v=[];for(const A of T)v.push(...Nx(a,l,u,A,b));return{effects:v,messages:[],consumesTurn:e.baseAction.costs.consumesTurn}},getValidTargets:(a,l)=>{if(e.targeting.mode==="self")return[l];let u=kx(a,l,e.targeting.range,e.targeting.deterministicSort);return(e.targeting.mode==="single"||e.targeting.mode==="radius"||e.targeting.mode==="line")&&(e.targeting.requiresLos&&(u=u.filter(f=>nf(a,l,f).isValid)),e.targeting.allowOccupied||(u=u.filter(f=>!ye(a,f)))),u},upgrades:o}},Ix=new Map,i0=new Map,Lx=e=>{const n=Rx(e);return Ix.set(e.id,e),i0.set(e.id,n),n},Bx=e=>e.map(Lx),Hx=()=>{const e={};for(const[n,s]of i0.entries())e[n]=s;return e},$i=(e,n)=>e.includes(n),Px=e=>{const n=new Set,s=e.id;return((e.baseVariables.damage||0)>0||/(ATTACK|THROW|BLAST|FIREBALL|BASH|PECK|EXPLOSION|SPEAR|SHOOT)/.test(s))&&n.add("damage"),/(MOVE|DASH|JUMP|ROLL|VAULT|STEP|GRAPPLE|WITHDRAWAL|WALK)/.test(s)&&n.add("move"),/(HEAL|ABSORB)/.test(s)&&n.add("heal"),/(SHIELD|PROTECT|BULWARK)/.test(s)&&n.add("protect"),/(STUN|TRAP|SMOKE|TELEGRAPH|ROOT|SWAP|SCOUT)/.test(s)&&n.add("control"),/(RAISE|FALCON|SUMMON)/.test(s)&&n.add("summon"),/(FIRE|LAVA|HAZARD|TRAP)/.test(s)&&n.add("hazard"),e.slot==="offensive"&&n.add("damage"),e.slot==="defensive"&&n.add("protect"),e.slot==="utility"&&n.add("utility"),(e.baseVariables.cooldown>0||e.baseVariables.cost>0)&&n.add("economy"),n.size||n.add("utility"),[...n]},jx={BASIC_MOVE:{intentTags:["move","objective","utility"],target:{pattern:"single"},estimates:{movement:1}},BASIC_ATTACK:{intentTags:["damage"],target:{pattern:"single"},estimates:{damage:4}},AUTO_ATTACK:{intentTags:["damage","utility"],target:{pattern:"single"},estimates:{damage:2}},DASH:{intentTags:["move","damage","utility"],target:{pattern:"line"},estimates:{movement:2,damage:2},risk:{noProgressCastPenalty:5}},JUMP:{intentTags:["move","utility"],target:{pattern:"single"},estimates:{movement:2},risk:{noProgressCastPenalty:6}},SHIELD_BASH:{intentTags:["damage","control","protect"],target:{pattern:"single"},estimates:{damage:3,control:2},risk:{requireEnemyContact:!0,noContactPenalty:5,noProgressCastPenalty:7}},BULWARK_CHARGE:{intentTags:["move","protect","damage"],target:{pattern:"line"},estimates:{movement:2,damage:4,shielding:2}},VAULT:{intentTags:["move","utility","control"],target:{pattern:"single"},estimates:{movement:3,control:2}},GRAPPLE_HOOK:{intentTags:["move","control"],target:{pattern:"line"},estimates:{movement:3,control:2}},SHIELD_THROW:{intentTags:["damage","control"],target:{pattern:"line"},estimates:{damage:6,control:2}},SPEAR_THROW:{intentTags:["damage"],target:{pattern:"line"},estimates:{damage:5},risk:{requireEnemyContact:!0,noContactPenalty:4,noProgressCastPenalty:5}},ARCHER_SHOT:{intentTags:["damage"],target:{pattern:"line"},estimates:{damage:2},risk:{requireEnemyContact:!0,noContactPenalty:4,noProgressCastPenalty:4}},FIREBALL:{intentTags:["damage","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{damage:5,control:1}},FIREWALL:{intentTags:["hazard","control","damage"],target:{pattern:"radius",aoeRadius:2},estimates:{damage:5,control:3}},FIREWALK:{intentTags:["move","hazard","utility"],target:{pattern:"single"},estimates:{movement:3},risk:{noProgressCastPenalty:8}},ABSORB_FIRE:{intentTags:["heal","hazard","utility"],target:{pattern:"self"},estimates:{healing:6},risk:{noProgressCastPenalty:2}},BOMB_TOSS:{intentTags:["damage","control","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{damage:6,control:2}},TIME_BOMB:{intentTags:["damage","hazard","utility"],target:{pattern:"self"},estimates:{damage:6,control:1}},CORPSE_EXPLOSION:{intentTags:["damage","control","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{damage:6,control:1}},RAISE_DEAD:{intentTags:["summon","control","utility"],target:{pattern:"single"},estimates:{summon:5}},SOUL_SWAP:{intentTags:["move","control","utility"],target:{pattern:"single"},estimates:{movement:2,control:2}},MULTI_SHOOT:{intentTags:["damage"],target:{pattern:"line"},estimates:{damage:5}},SET_TRAP:{intentTags:["control","hazard"],target:{pattern:"single"},estimates:{control:3}},SWIFT_ROLL:{intentTags:["move","utility"],target:{pattern:"single"},estimates:{movement:2}},SNEAK_ATTACK:{intentTags:["damage","move"],target:{pattern:"single"},estimates:{damage:8,movement:2},risk:{requireEnemyContact:!0,noContactPenalty:3,noProgressCastPenalty:4}},SMOKE_SCREEN:{intentTags:["control","protect","utility"],target:{pattern:"radius",aoeRadius:1},estimates:{control:4,shielding:4}},SHADOW_STEP:{intentTags:["move","damage","utility"],target:{pattern:"single"},estimates:{movement:3,damage:3}},FALCON_COMMAND:{intentTags:["summon","control","utility"],target:{pattern:"single"},estimates:{summon:4,control:2}},FALCON_PECK:{intentTags:["damage"],target:{pattern:"single"},estimates:{damage:3}},FALCON_APEX_STRIKE:{intentTags:["damage","control"],target:{pattern:"single"},estimates:{damage:5,control:1}},FALCON_HEAL:{intentTags:["heal","utility"],target:{pattern:"single"},estimates:{healing:4}},FALCON_SCOUT:{intentTags:["control","utility"],target:{pattern:"self"},estimates:{control:3}},FALCON_AUTO_ROOST:{intentTags:["summon","utility"],target:{pattern:"self"},estimates:{summon:2}},KINETIC_TRI_TRAP:{intentTags:["control","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{control:5,damage:4}},WITHDRAWAL:{intentTags:["move","control","utility"],target:{pattern:"single"},estimates:{movement:2,control:1}},SENTINEL_TELEGRAPH:{intentTags:["control","objective"],target:{pattern:"radius",aoeRadius:2},estimates:{control:3}},SENTINEL_BLAST:{intentTags:["damage","hazard"],target:{pattern:"radius",aoeRadius:2},estimates:{damage:7}},THEME_HAZARDS:{intentTags:["hazard","control"],target:{pattern:"global"},estimates:{control:2}}},Dx=(e,n)=>n?{...e,...n,target:{...e.target,...n.target||{}},estimates:{...e.estimates,...n.estimates||{}},economy:{...e.economy,...n.economy||{}},risk:{...e.risk,...n.risk||{}}}:e,Ux=e=>{const n=Px(e),s=($i(n,"move"),"single"),o={id:e.id,intentTags:n,target:{range:Math.max(0,e.baseVariables.range||0),pattern:s},estimates:{damage:Math.max(0,e.baseVariables.damage||0),movement:$i(n,"move")?Math.max(1,Math.min(3,e.baseVariables.range||1)):0,healing:$i(n,"heal")?2:0,shielding:$i(n,"protect")?1:0,control:$i(n,"control")?1:0,summon:$i(n,"summon")?1:0},economy:{cost:Math.max(0,e.baseVariables.cost||0),cooldown:Math.max(0,e.baseVariables.cooldown||0),consumesTurn:!0},risk:{selfExposure:$i(n,"move")?.5:0,hazardAffinity:$i(n,"hazard")?.5:0},complexity:1};return Dx(o,jx[e.id])},$x=e=>{const n=[];return(!e.intentTags||e.intentTags.length===0)&&n.push("intentTags must not be empty"),(!Number.isFinite(e.target.range)||e.target.range<0)&&n.push("target.range must be >= 0"),e.target.pattern||n.push("target.pattern is required"),(!Number.isFinite(e.economy.cooldown)||e.economy.cooldown<0)&&n.push("economy.cooldown must be >= 0"),(!Number.isFinite(e.economy.cost)||e.economy.cost<0)&&n.push("economy.cost must be >= 0"),(!Number.isFinite(e.complexity)||e.complexity<0)&&n.push("complexity must be >= 0"),n},qx=e=>{const n=[],s=[];for(const[o,a]of Object.entries(e)){const l=a.intentProfile||Ux(a);a.intentProfile=l;const u=$x(l);u.length>0&&s.push({skillId:o,errors:u}),l||n.push(o)}return{missing:n,invalid:s}},zx={id:"ABSORB_FIRE",name:"Absorb Fire",description:"Fire heals you instead of harming you.",slot:"passive",icon:"",baseVariables:{cost:0,cooldown:0,range:0},execute:(e,n,s)=>({effects:[],messages:[]}),getValidTargets:()=>[],upgrades:{}},Vx={id:"grapple_hook",name:"Grapple Hook",description:"Tests for grapple hook mechanics including LoS, lava sinking, and weight-based behavior",scenarios:[{id:"hook_lava_intercept",title:"Lava Interceptor & LoS",description:"Verify LoS blocking and Lava killing targets.",relatedSkills:["GRAPPLE_HOOK"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["lava","line-of-sight","displacement"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},["GRAPPLE_HOOK"]),e.spawnEnemy("footman",{q:4,r:4,s:-8},"target1"),e.spawnEnemy("footman",{q:7,r:3,s:-10},"hidden"),e.setTile({q:6,r:4,s:-10},"wall"),e.setTile({q:4,r:5,s:-9},"lava")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:7,r:3,s:-10}),e.useSkill("GRAPPLE_HOOK",{q:4,r:4,s:-8}),e.wait(),e.wait()},verify:(e,n)=>{const s=e.player,o=e.enemies.find(l=>l.id==="target1"),a={playerInOriginalPosition:s.position.q===4&&s.position.r===6&&s.position.s===-10,target1Dead:!o,losWarning:n.some(l=>l.includes("Line of sight"))};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Failed Details:",a),console.log("Logs:",n)),Object.values(a).every(l=>l===!0)}},{id:"hook_wall_anchor_zip",title:"Heavy Zip to Wall",description:"Verify zipping to a wall and stunning nearby enemies.",relatedSkills:["GRAPPLE_HOOK"],category:"movement",difficulty:"beginner",isTutorial:!0,tags:["wall","displacement","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["GRAPPLE_HOOK"]),e.setTile({q:6,r:3,s:-9},"wall"),e.spawnEnemy("footman",{q:5,r:4,s:-9},"blocker"),e.setTile({q:6,r:6,s:-12},"wall"),e.setTile({q:5,r:6,s:-11},"lava"),e.spawnEnemy("footman",{q:6,r:5,s:-11},"stunMe"),e.spawnEnemy("footman",{q:7,r:5,s:-12},"noStun")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:6,r:3,s:-9}),e.useSkill("GRAPPLE_HOOK",{q:6,r:6,s:-12})},verify:(e,n)=>{const s=e.enemies.find(l=>l.id==="stunMe"),o=e.enemies.find(l=>l.id==="noStun"),a={stunnedEnemy:!!(s&&s.statusEffects.some(l=>l.type==="stunned")),safeEnemy:!!(o&&!o.statusEffects.some(l=>l.type==="stunned")),zipLog:n.some(l=>l.includes("Zipped")),lavaSinkLog:n.some(l=>l.includes("Lava Sink"))};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Failed Details:",a),console.log("Player Pos:",e.player.position),console.log("Victim Status:",s?.statusEffects)),Object.values(a).every(l=>l===!0)}}]},Yx={id:"shield_throw",name:"Shield Throw",description:"Tests for shield throw mechanics including push, stun, and collision behavior",scenarios:[{id:"shield_stun_push",title:"Standard Push",description:"Verify 4-tile push in a straight line.",relatedSkills:["SHIELD_THROW"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["push","displacement","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_THROW"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>e.useSkill("SHIELD_THROW",{q:3,r:5,s:-8}),verify:(e,n)=>{const s=e.enemies.find(a=>a.id==="victim"),o={victimAt1:s?.position.r===1,victimStunned:n?.some(a=>a.includes("stunned"))};return Object.values(o).some(a=>a===!1)&&(console.log(" Shield Throw Failed:",o),console.log("Enemy Pos:",s?.position),console.log("Logs:",n)),Object.values(o).every(a=>a===!0)}},{id:"shield_unit_collision",title:"Unit Collision",description:"Verify push stops when hitting another unit.",relatedSkills:["SHIELD_THROW"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["collision","lava","push","environmental-kill"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_THROW"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim"),e.spawnEnemy("shieldbearer",{q:3,r:3,s:-6},"obstacle"),e.setTile({q:3,r:1,s:-4},"lava")},run:e=>e.useSkill("SHIELD_THROW",{q:3,r:5,s:-8}),verify:(e,n)=>{const s=e.enemies.find(l=>l.id==="victim"),o=e.enemies.find(l=>l.id==="obstacle"),a={victimPushed:(s?.position.r??5)===3,obstacleDead:!o};return Object.values(a).some(l=>l===!1)&&(console.log(" Shield Throw Failed:",a),console.log("Victim Pushed:",a.victimPushed),console.log("Victim Pos:",s?.position),console.log("Obstacle Dead:",a.obstacleDead),console.log("Logs:",n)),Object.values(a).every(l=>l===!0)}}]},Kx={id:"auto_attack",name:"Auto Attack",description:"Tests for auto-attack passive skill including turn-start memory and friendly fire logic",scenarios:[{id:"auto_attack_persistence_stress_test",title:"Persistence: Three-Point Validation",description:"Verifies that Auto-Attack only hits units that were adjacent at BOTH start and end.",relatedSkills:["AUTO_ATTACK","BASIC_MOVE"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["passive","spatial-memory","edge-case"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["AUTO_ATTACK","BASIC_MOVE"]),e.spawnEnemy("footman",{q:5,r:5,s:-10},"persistent_foe"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"new_neighbor"),e.spawnEnemy("footman",{q:5,r:4,s:-9},"former_neighbor"),e.state.player.previousPosition={q:4,r:5,s:-9}},run:e=>{e.move({q:4,r:6,s:-10})},verify:(e,n)=>{const s=e.enemies.find(u=>u.id==="persistent_foe"),o=e.enemies.find(u=>u.id==="new_neighbor"),a=e.enemies.find(u=>u.id==="former_neighbor"),l={persistentDead:!s||s.hp<s.maxHp,ignoredNew:o&&o.hp===o.maxHp,ignoredFormer:a&&a.hp===a.maxHp,logFound:n.some(u=>u.includes("attacked footman"))};return Object.values(l).some(u=>u===!1)&&(console.log(" Scenario Failed Details:",l),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",n)),Object.values(l).every(u=>u===!0)}},{id:"enemy_auto_attack_no_friendly_fire",title:"Enemy Auto-Attack: Team Alignment",description:"Ensures enemy passives only target the player and not their own allies.",relatedSkills:["AUTO_ATTACK"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["passive","alignment","friendly-fire"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},[]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"enemy_attacker");const n=e.state.enemies.find(s=>s.id==="enemy_attacker");n&&(n.activeSkills=[{id:"AUTO_ATTACK",range:1}],n.previousPosition={q:3,r:5,s:-8}),e.spawnEnemy("shieldBearer",{q:2,r:6,s:-8},"enemy_ally"),n.previousPosition={q:3,r:5,s:-8},e.state.player.previousPosition={q:3,r:6,s:-9}},run:e=>{e.wait()},verify:(e,n)=>{const s=e.player,o=e.enemies.find(l=>l.id==="enemy_ally"),a={playerHit:s.hp<s.maxHp,allySafe:o&&o.hp===o.maxHp,hitPlayerLog:n.some(l=>l.includes("attacked you")),hitAllyLog:!n.some(l=>l.includes("attacked enemy_ally"))};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Failed Details:",a),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",n)),Object.values(a).every(l=>l===!0)}}]},Fx={id:"integration",name:"Integration Tests",description:"Multi-skill integration scenarios testing complex interactions",scenarios:[{id:"environmental_chain_reaction",title:"Environmental Chain Reaction",description:"Test complex environmental interactions with multiple hazards",relatedSkills:["GRAPPLE_HOOK","SHIELD_THROW"],category:"hazards",difficulty:"advanced",isTutorial:!1,tags:["lava","wall","environmental-kill","chain-reaction"],setup:e=>{e.setPlayer({q:5,r:4,s:-9},["GRAPPLE_HOOK","SHIELD_THROW"]),e.spawnEnemy("shieldbearer",{q:5,r:2,s:-7},"victim1"),e.spawnEnemy("footman",{q:5,r:6,s:-11},"victim2"),e.spawnEnemy("footman",{q:5,r:7,s:-12},"victim3"),e.setTile({q:5,r:8,s:-13},"lava")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:5,r:2,s:-7}),e.useSkill("SHIELD_THROW",{q:5,r:5,s:-10})},verify:(e,n)=>{const s=e.player.position.q===5&&e.player.position.r===3,o=!e.enemies.find(h=>h.id==="victim3")||!!e.dyingEntities?.find(h=>h.id==="victim3"),a=!e.enemies.find(h=>h.id==="victim2")||!!e.dyingEntities?.find(h=>h.id==="victim2"),l=e.enemies.find(h=>h.id==="victim1"),u=l&&n.some(h=>h.includes("stunned")),f=l&&l.position.q===5&&l.position.r===6,p=[s,o,a,u,f];return Object.values(p).some(h=>h===!1)&&(console.log(" Environmental Chain Reaction Failed:",p),console.log("Player at 5,3:",s),console.log("Player Pos:",e.player.position),console.log("Logs found:",n),console.log("Victim1 at 5,6:",f),console.log("Victim1 Pos:",l?.position),console.log("Victim1 Stunned:",u),console.log("Victim2 Dead:",a),console.log("Victim3 Dead:",o)),Object.values(p).every(h=>h===!0)}},{id:"auto_attack_after_grapple",title:"Auto-Attack After Grapple",description:"Verify auto-attack triggers correctly after grapple displacement",relatedSkills:["GRAPPLE_HOOK","AUTO_ATTACK"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["passive","displacement","integration"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["GRAPPLE_HOOK","AUTO_ATTACK"]),e.state.player.previousPosition={q:4,r:6,s:-10},e.spawnEnemy("footman",{q:7,r:6,s:-13},"grappleHookTarget"),e.spawnEnemy("footman",{q:3,r:5,s:-8},"safe"),e.spawnEnemy("footman",{q:4,r:5,s:-9},"auto-attacked"),e.spawnEnemy("footman",{q:5,r:5,s:-10},"safe2")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:7,r:6,s:-13})},verify:(e,n)=>{const s=e.enemies.find(f=>f.id==="grappleHookTarget"),o=e.enemies.find(f=>f.id==="auto-attacked"),a=e.enemies.find(f=>f.id==="safe"),l=e.enemies.find(f=>f.id==="safe2"),u={targetPulled:!!(s&&s.position.q<7),targetNotHit:!!(s&&s.hp===s.maxHp),safeNotHit:!!(a&&a.hp===a.maxHp),safe2NotHit:!!(l&&l.hp===l.maxHp),autoattackedDead:!o||o.hp<=0};return Object.values(u).some(f=>f===!1)&&(console.log(" Scenario Failed Details:",u),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",n),console.log("target Pos:",s?.position.q),console.log("target Pulled:",u.targetPulled),console.log("target Not Hit:",u.targetNotHit),console.log("safe Not Hit:",u.safeNotHit),console.log("safe2 Not Hit:",u.safe2NotHit),console.log("autoattacked Dead:",u.autoattackedDead)),Object.values(u).every(f=>f===!0)}}]},Wx="modulepreload",Gx=function(e){return"/Hop/"+e},Ey={},Xx=function(n,s,o){let a=Promise.resolve();if(s&&s.length>0){let h=function(g){return Promise.all(g.map(b=>Promise.resolve(b).then(S=>({status:"fulfilled",value:S}),S=>({status:"rejected",reason:S}))))};var u=h;document.getElementsByTagName("link");const f=document.querySelector("meta[property=csp-nonce]"),p=f?.nonce||f?.getAttribute("nonce");a=h(s.map(g=>{if(g=Gx(g),g in Ey)return;Ey[g]=!0;const b=g.endsWith(".css"),S=b?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${g}"]${S}`))return;const T=document.createElement("link");if(T.rel=b?"stylesheet":Wx,b||(T.as="script"),T.crossOrigin="",T.href=g,p&&T.setAttribute("nonce",p),document.head.appendChild(T),b)return new Promise((v,A)=>{T.addEventListener("load",v),T.addEventListener("error",()=>A(new Error(`Unable to preload CSS for ${g}`)))})}))}function l(f){const p=new Event("vite:preloadError",{cancelable:!0});if(p.payload=f,window.dispatchEvent(p),!p.defaultPrevented)throw f}return a.then(f=>{for(const p of f||[])p.status==="rejected"&&l(p.reason);return n().catch(l)})},Jx=async(e,n)=>{if(typeof window>"u")try{(await Xx(()=>import("./__vite-browser-external-BIHI7g3E.js"),[])).appendFileSync(e,n)}catch(s){console.warn(`Failed to persist log to ${e}:`,s)}},Qx={id:"basic_attack",name:"Basic Attack",description:"Tests for basic melee attack mechanics including range and move-to-attack logic",scenarios:[{id:"basic_attack_player_mechanics",title:"Player Basic Attack: Range & Bump",description:"Validates range enforcement, turn accounting, and bump-attack redirection.",relatedSkills:["BASIC_ATTACK"],category:"combat",tags:["melee","targeting","bump-attack"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BASIC_ATTACK"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"adj_victim"),e.spawnEnemy("footman",{q:3,r:4,s:-7},"far_victim")},run:e=>{e.useSkill("BASIC_ATTACK",{q:3,r:4,s:-7}),e.move({q:3,r:5,s:-8})},verify:(e,n)=>{const s=e.enemies.find(l=>l.id==="adj_victim"),o=e.enemies.find(l=>l.id==="far_victim"),a={farStaysAlive:o&&o.hp===o.maxHp,rangeError:n.some(l=>l.includes("out of range")),adjTookDamage:!s||s.hp<=s.maxHp,playerPositionHeld:Q(e.player.position,{q:3,r:6,s:-9}),oneTurnConsumed:e.turnsSpent===1};if(Object.values(a).some(l=>l===!1)){const l=` Basic Attack Failed: ${JSON.stringify(a)}
Current Player Pos: ${JSON.stringify(e.player.position)}
Logs: ${JSON.stringify(n)}
`;console.log(l),Jx("integration_debug.txt",l)}return Object.values(a).every(l=>l===!0)}}]},Zx={id:"spear_throw",name:"Spear Throw",description:"Tests for spear throw mechanics including range, LoS, and spear retrieval",scenarios:[{id:"spear_kill",title:"Spear Kill",description:"Throw spear to kill an enemy and verify item spawn.",relatedSkills:["SPEAR_THROW"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["projectile","combat","item-spawn"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SPEAR_THROW"]),e.spawnEnemy("footman",{q:3,r:4,s:-7},"target"),e.state.hasSpear=!0},run:e=>{e.useSkill("SPEAR_THROW",{q:3,r:4,s:-7})},verify:(e,n)=>{const s=!e.enemies.find(l=>l.id==="target"),o=!!e.spearPosition&&e.spearPosition.q===3&&e.spearPosition.r===4,a=n.some(l=>l.includes("Spear killed"));return s&&o&&a}},{id:"spear_miss_spawn",title:"Spear Rejects Empty Tile",description:"Enemy-only contract: empty tiles are invalid targets and do not spawn spear.",relatedSkills:["SPEAR_THROW"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["projectile","item-spawn"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SPEAR_THROW"]),e.state.hasSpear=!0},run:e=>{e.useSkill("SPEAR_THROW",{q:3,r:4,s:-7})},verify:(e,n)=>{const s=n.some(a=>a.includes("No enemy at target.")),o=e.hasSpear===!0&&!e.spearPosition;return s&&o}},{id:"spear_wall_block",title:"Spear Wall Block",description:"Spear throw is blocked by walls.",relatedSkills:["SPEAR_THROW"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["projectile","wall","boundary"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["SPEAR_THROW"]),e.spawnEnemy("footman",{q:4,r:3,s:-7},"target"),e.setTile({q:4,r:4,s:-8},"wall"),e.state.hasSpear=!0},run:e=>{e.useSkill("SPEAR_THROW",{q:4,r:3,s:-7})},verify:(e,n)=>{const s=n.some(l=>l.includes("No clear line of sight to enemy.")),o=!!e.enemies.find(l=>l.id==="target"),a=e.hasSpear===!0&&!e.spearPosition;return s&&o&&a}}]},eA={id:"dash",name:"Dash",description:"Tests for dash mechanics including path validation and shield-based enemy shunting",scenarios:[{id:"dash_shunt_lava",title:"Shunt into Lava",description:"Shunt an enemy into lava for an environmental kill.",relatedSkills:["DASH"],category:"hazards",difficulty:"intermediate",isTutorial:!1,tags:["lava","push","environmental-kill"],setup:e=>{e.setPlayer({q:3,r:5,s:-8},["DASH"]),e.spawnEnemy("footman",{q:5,r:5,s:-10},"victim"),e.setTile({q:7,r:5,s:-12},"lava"),e.state.hasShield=!0},run:e=>{e.useSkill("DASH",{q:5,r:5,s:-10})},verify:(e,n)=>{const s=e.enemies.find(a=>a.id==="victim"),o={playerPosition:e.player.position.q===5&&e.player.position.r===5,victimDead:!s};return Object.values(o).some(a=>a===!1)&&(console.log(" Dash Shunt Lava Failed:",o),console.log("Final State:",e.player.position),console.log("Victim Pos:",s?.position),console.log("Logs:",n)),Object.values(o).every(a=>a===!0)}},{id:"dash_comprehensive_validation",title:"Dash: Constraints & Shunt Physics",description:"Validates range limits, wall blocking, and Shield Shunt displacement in one sequence.",relatedSkills:["DASH"],category:"movement",difficulty:"advanced",isTutorial:!1,tags:["stress-test","collision","range"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["DASH"]),e.state.hasShield=!0,e.setTile({q:4,r:4,s:-8},"wall"),e.setTile({q:6,r:5,s:-11},"wall"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"victim")},run:e=>{e.useSkill("DASH",{q:4,r:7,s:-11}),e.useSkill("DASH",{q:7,r:4,s:-11}),e.useSkill("DASH",{q:6,r:6,s:-12}),e.useSkill("DASH",{q:4,r:5,s:-9})},verify:(e,n)=>{const s=e.enemies.find(a=>a.id==="victim"),o={finalPositionCorrect:e.player.position.q===4&&e.player.position.r===6,victimPushed:!!(s&&s.position.q===4&&s.position.r===5),wallErrorFound:n.some(a=>a.includes("wall blocks")),axialRangeErrorFound:n.some(a=>a.includes("Axial only!")),shuntSuccess:n.some(a=>a.includes("Shield Shunt")),twoTurnSpent:e.turnsSpent===2};return Object.values(o).some(a=>a===!1)&&(console.log(" Dash Stress Test Failed:",o),console.log("Final State:",e.player.position),console.log("Victim Pos:",s?.position),console.log("Logs:",n)),Object.values(o).every(a=>a===!0)}}]},tA={id:"jump",name:"Jump",description:"Tests for jump mechanics including range validation and stunning landing",scenarios:[{id:"jump_basic",title:"Basic Jump",description:"Jump to a tile.",relatedSkills:["JUMP"],category:"movement",difficulty:"beginner",isTutorial:!0,tags:["movement","leap"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["JUMP"]),e.setTile({q:3,r:5,s:-8},"lava")},run:e=>{e.useSkill("JUMP",{q:3,r:4,s:-7})},verify:(e,n)=>{const s=Q(e.player.position,{q:3,r:4,s:-7}),o=jd(e.occupancyMask,{q:3,r:4}),a=!jd(e.occupancyMask,{q:3,r:6}),l={playerInPosition:s,spatialMaskRefreshed:o&&a,noLavaDamage:e.player.hp===e.player.maxHp,jumpedSuccessfully:n.some(u=>u.includes("Jumped"))};return Object.values(l).some(u=>u===!1)&&(console.error(" Jump Basic Failed:",l),console.error("Final State:",e.player.position),console.error("Logs:",n)),Object.values(l).every(u=>u===!0)}},{id:"jump_stunning_landing",title:"Stunning Landing",description:"Jump into a group of enemies and ensure neighbors are stunned.",relatedSkills:["JUMP"],category:"movement",difficulty:"intermediate",isTutorial:!0,tags:["movement","stun","aoe"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["JUMP"]),e.addUpgrade("JUMP","STUNNING_LANDING"),e.spawnEnemy("footman",{q:3,r:7,s:-10},"neighbor_1"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"neighbor_2"),e.spawnEnemy("footman",{q:3,r:5,s:-8},"distant_enemy")},run:e=>{e.useSkill("JUMP",{q:3,r:8,s:-11})},verify:(e,n,s=[])=>{const o={n1StunnedMessage:n.some(a=>a.includes("stunned by landing impact")),hasShakeJuice:s.some(a=>a.type==="shake"),hasStunBurstVFX:s.some(a=>a.type==="vfx"&&a.payload.type==="stunBurst"),hasStunnedCombatText:s.some(a=>a.type==="combat_text"&&a.payload.text==="STUNNED"),playerAtTarget:Q(e.player.position,{q:3,r:8,s:-11}),oneTurnSpent:e.turnsSpent===1};return Object.values(o).some(a=>a===!1)&&(console.error(" Jump Stunning Landing Failed:",o),console.error("Final State:",e.player.position),console.error("turnsSpent:",e.turnsSpent),console.error("Logs:",n)),Object.values(o).every(a=>a===!0)}}]},nA={id:"shield_bash",name:"Shield Bash",description:"Tests for shield bash mechanics including push, stun, and collision behavior",scenarios:[{id:"bash_push",title:"Shield Push",description:"Push an enemy into lava.",relatedSkills:["SHIELD_BASH"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["push","displacement","lava"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_BASH"]),e.setTile({q:3,r:4,s:-7},"lava"),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>{e.useSkill("SHIELD_BASH",{q:3,r:5,s:-8})},verify:(e,n)=>{const s={enemyGone:e.enemies.length===0,messageOk:n.some(o=>o.includes("Lava"))};return Object.values(s).some(o=>o===!1)&&(console.log(" Scenario Failed Details:",s),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",n)),Object.values(s).every(o=>o===!0)}},{id:"bash_wall_stun",title:"Wall Slam Stun",description:"Bash enemy into wall to cause a stun.",relatedSkills:["SHIELD_BASH"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["collision","wall","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_BASH"]),e.spawnEnemy("shieldBearer",{q:3,r:5,s:-8},"victim"),e.setTile({q:3,r:4,s:-7},"wall")},run:e=>{e.useSkill("SHIELD_BASH",{q:3,r:5,s:-8})},verify:(e,n)=>{const s=e.enemies.find(l=>l.id==="victim");if(!s)return!1;const o=Q(s.position,{q:3,r:5,s:-8}),a=n.some(l=>l.includes("into obstacle"));return o&&a}}]},iA={id:"bulwark_charge",name:"Bulwark Charge",description:"Tests for bulwark charge mechanics including chain pushing and wall slamming",scenarios:[{id:"chain_stun",title:"The Chain-Stun",description:"Wall prevents chain movement, causing all members to be stunned.",relatedSkills:["BULWARK_CHARGE"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["chain","wall","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BULWARK_CHARGE"]),e.spawnEnemy("shieldBearer",{q:3,r:5,s:-8},"A"),e.spawnEnemy("shieldBearer",{q:3,r:4,s:-7},"B"),e.setTile({q:3,r:3,s:-6},"wall"),e.state.hasShield=!0},run:e=>{e.useSkill("BULWARK_CHARGE",{q:3,r:5,s:-8})},verify:(e,n)=>!0},{id:"bulwark_chain_push",title:"Bulwark Chain Push",description:"Push a chain of enemies successfully.",relatedSkills:["BULWARK_CHARGE"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["chain","push","displacement"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BULWARK_CHARGE"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"A"),e.spawnEnemy("footman",{q:3,r:4,s:-7},"B"),e.state.hasShield=!0},run:e=>{e.useSkill("BULWARK_CHARGE",{q:3,r:5,s:-8})},verify:(e,n)=>!0}]},sA={id:"vault",name:"Vault",description:"Tests for vault mechanics including state-shifting behavior between odd and even turns",scenarios:[{id:"vault_shift_stun",title:"Vault Stun (Odd Turn)",description:"Verify vault stuns neighbors on Turn 1.",relatedSkills:["VAULT"],category:"movement",difficulty:"intermediate",isTutorial:!0,tags:["state-shift","stun","movement"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.setTile({q:3,r:5,s:-8},"lava"),e.spawnEnemy("footman",{q:4,r:4,s:-8},"victim")},run:e=>{e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,n)=>{const s={stunned:n.some(o=>o.includes("Stun Vault executed!"))};return Object.values(s).some(o=>o===!1)&&(console.log(" Vault Stun Failed:",s),console.log("Logs:",n)),Object.values(s).every(o=>o===!0)}},{id:"vault_shift_normal",title:"Vault Normal (Even Turn)",description:"Verify vault is normal on Turn 2.",relatedSkills:["VAULT"],category:"movement",difficulty:"intermediate",isTutorial:!0,tags:["state-shift","movement"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.setTile({q:3,r:5,s:-8},"lava"),e.spawnEnemy("footman",{q:4,r:3,s:-7},"victim")},run:e=>{e.wait(),e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,n)=>{const s={vaulted:n.some(o=>o.includes("Vaulted!"))};return Object.values(s).some(o=>o===!1)&&(console.log(" Vault Normal Failed:",s),console.log("Logs:",n)),Object.values(s).every(o=>o===!0)}}]},aA={id:"basic_move",name:"Basic Move",description:"Fundamental movement mechanics",scenarios:[{id:"walk_to_tile",title:"Movement 101",description:"Move your character from the center to an adjacent tile.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"beginner",isTutorial:!0,tags:["movement","basics"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"]),e.setTile({q:4,r:6,s:-10},"wall")},run:e=>{e.move({q:4,r:6,s:-10}),e.move({q:4,r:4,s:-8})},verify:(e,n)=>{const s={positionCorrect:Q(e.player.position,{q:4,r:4,s:-8}),logFound:n.some(o=>o.includes("blocked")),oneTurnSpent:e.turnsSpent===1};return Object.values(s).some(o=>o===!1)&&(console.log(" Scenario Failed Details:",s),console.log("Final Position:",e.player.position),console.log("Logs found:",n)),Object.values(s).every(o=>o===!0)}},{id:"free_move_out_of_combat",title:"Exploration Mode",description:"Verify that movement range expands only when no enemies are present.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"beginner",isTutorial:!1,tags:["movement","exploration","free-move"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE","BASIC_ATTACK"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"adj_victim")},run:e=>{e.move({q:7,r:1,s:-8}),e.useSkill("BASIC_ATTACK",{q:3,r:5,s:-8}),e.move({q:7,r:1,s:-8})},verify:(e,n)=>{const s=n.filter(l=>l.toLowerCase().includes("out of reach")).length,o=n.some(l=>l.toLowerCase().includes("you attacked")),a={wasBlockedInitially:s===1,attackLogs:o,reachedDistantHex:Q(e.player.position,{q:7,r:1,s:-8})};return Object.values(a).some(l=>l===!1)&&(console.log(" Free Move Scenario Failed:",a),console.log("Final Position:",e.player.position),console.log("Logs found:",n)),Object.values(a).every(l=>l===!0)}},{id:"invalid_enemy_move_intent_is_rejected_pre_execution",title:"Move Intent Rejected Before Execution",description:"Enemy AI may decide to move, but execution must not run a skill the actor does not own.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["movement","validation","intent"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:7,r:5,s:-12},"attacker_without_move");const n=e.getEnemy("attacker_without_move");n&&(n.activeSkills=(n.activeSkills||[]).filter(s=>s.id!=="BASIC_MOVE"))},run:e=>{e.wait()},verify:(e,n)=>{const s=e.enemies.find(a=>a.id==="attacker_without_move"),o={enemyDidNotMove:!!s&&Q(s.position,{q:7,r:5,s:-12}),noMissingSkillRuntimeError:!n.some(a=>a.includes("does not have skill BASIC_MOVE"))};return Object.values(o).some(a=>a===!1)&&(console.log("Invalid Enemy Move Intent Rejection Failed:",o),console.log("Enemy:",s),console.log("Logs:",n)),Object.values(o).every(a=>a===!0)}},{id:"single_enemy_single_action_per_turn",title:"Single Action Per Actor Turn",description:"Each actor resolves exactly one action per turn in normal flow.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["turn-loop","movement","integrity"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:7,r:5,s:-12},"single_actor")},run:e=>{e.wait()},verify:(e,n)=>{const s={q:7,r:5,s:-12},o=e.enemies.find(u=>u.id==="single_actor"),a=o?fe(s,o.position):-1,l={enemyExists:!!o,movedExactlyOneTile:a===1,noZeroEffectMoveWarning:!n.some(u=>u.includes("produced ZERO effects"))};return Object.values(l).some(u=>u===!1)&&(console.log("Single Action Per Actor Turn Failed:",l),console.log("Enemy:",o),console.log("Logs:",n)),Object.values(l).every(u=>u===!0)}}]},qi=e=>{const s={BASIC_MOVE:{slot:"passive",range:1,cooldown:0,name:"Walk",description:"Move to adjacent tile."},BASIC_ATTACK:{slot:"passive",range:1,cooldown:0,name:"Basic Attack",description:"Strike adjacent target."},SENTINEL_TELEGRAPH:{slot:"offensive",range:3,cooldown:0,name:"Sentinel Telegraph",description:"Marks blast zone."},SENTINEL_BLAST:{slot:"offensive",range:3,cooldown:0,name:"Sentinel Blast",description:"Massive area blast."}}[e]||{slot:"offensive",range:1,cooldown:0,name:e,description:e};return{id:e,name:s.name,description:s.description,slot:s.slot,cooldown:s.cooldown,currentCooldown:0,range:s.range,upgrades:[],activeUpgrades:[]}},oA={id:"sentinel_blast",name:"Sentinel Blast",description:"Sentinel unique area-of-effect attack",scenarios:[{id:"blast_aoe",title:"Blast Away",description:"Use Sentinel Blast to hit multiple enemies.",relatedSkills:["SENTINEL_BLAST"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["aoe","damage","sentinel"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SENTINEL_BLAST"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"center"),e.spawnEnemy("footman",{q:4,r:4,s:-8},"side")},run:e=>{e.useSkill("SENTINEL_BLAST",{q:3,r:5,s:-8})},verify:(e,n)=>n.some(s=>s.includes("massive blast"))},{id:"sentinel_playlist_two_turn_timing",title:"Playlist: Telegraph then Execute",description:"Boss uses a 2-turn skill playlist: telegraph first, blast on next turn.",relatedSkills:["SENTINEL_TELEGRAPH","SENTINEL_BLAST"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["boss","playlist","telegraph"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("sentinel",{q:4,r:2,s:-6},"boss");const n=e.getEnemy("boss");n&&(n.activeSkills=[qi("BASIC_MOVE"),qi("BASIC_ATTACK"),qi("SENTINEL_TELEGRAPH"),qi("SENTINEL_BLAST")])},run:e=>{e.wait(),e.logs.push(`HP_AFTER_TELEGRAPH=${e.state.player.hp}`),e.wait()},verify:(e,n)=>{const s=n.find(l=>l.startsWith("HP_AFTER_TELEGRAPH=")),o=s?Number(s.split("=")[1]):-1,a={telegraphEmitted:n.some(l=>l.includes("marks the impact zone")),executeEmitted:n.some(l=>l.includes("massive blast")),noDamageOnTelegraphTurn:o===e.player.maxHp,damageOnExecuteTurn:e.player.hp<e.player.maxHp};return Object.values(a).some(l=>l===!1)&&(console.log("Sentinel Playlist Timing Failed:",a),console.log("Logs:",n),console.log("Player HP:",e.player.hp,"/",e.player.maxHp)),Object.values(a).every(l=>l===!0)}},{id:"sentinel_playlist_interruption_by_stun",title:"Playlist: Interruption Cancels Execute",description:"Stunning the boss during telegraph cancels the follow-up execute turn.",relatedSkills:["SENTINEL_TELEGRAPH","SENTINEL_BLAST"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["boss","playlist","interruption","stun"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("sentinel",{q:4,r:2,s:-6},"boss");const n=e.getEnemy("boss");n&&(n.activeSkills=[qi("BASIC_MOVE"),qi("BASIC_ATTACK"),qi("SENTINEL_TELEGRAPH"),qi("SENTINEL_BLAST")])},run:e=>{e.wait(),e.applyStatus("boss","stunned",1),e.wait()},verify:(e,n)=>{const s=e.enemies.find(a=>a.id==="boss"),o={telegraphEmitted:n.some(a=>a.includes("marks the impact zone")),executeCancelled:!n.some(a=>a.includes("massive blast")),playerUnharmed:e.player.hp===e.player.maxHp,bossStillExists:!!s};return Object.values(o).some(a=>a===!1)&&(console.log("Sentinel Playlist Interruption Failed:",o),console.log("Logs:",n),console.log("Player HP:",e.player.hp,"/",e.player.maxHp),console.log("Boss:",s)),Object.values(o).every(a=>a===!0)}}]},rA={id:"fireball",name:"Fireball",description:"Validates axial targeting, AoE damage, and environmental fire placement.",scenarios:[{id:"fireball_axial_aoe",title:"Axial Alignment & AoE Spread",description:"Verify the skill only fires axially and damages all neighbors at the impact site.",relatedSkills:["FIREBALL"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["aoe","axial","fire"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["FIREBALL"]),e.spawnEnemy("footman",{q:5,r:4,s:-9},"primary_target"),e.spawnEnemy("footman",{q:6,r:4,s:-10},"neighbor_target"),e.spawnEnemy("footman",{q:6,r:5,s:-11},"diagonal_enemy"),e.setTile({q:6,r:3,s:-9},"wall"),e.setTile({q:6,r:6,s:-12},"wall"),e.setTile({q:5,r:6,s:-11},"lava")},run:e=>{e.useSkill("FIREBALL",{q:7,r:5,s:-12}),e.useSkill("FIREBALL",{q:5,r:4,s:-9})},verify:()=>!0},{id:"fireball_max_range_edge",title:"Max Range & Fire Duration",description:"Verify fireball at exactly range 3 and check fire duration persistence.",relatedSkills:["FIREBALL"],category:"balancing",difficulty:"intermediate",isTutorial:!1,tags:["range","persistence"],setup:e=>{e.setPlayer({q:0,r:0,s:0},["FIREBALL"]),e.setTile({q:0,r:3,s:-3},"grass")},run:e=>{e.useSkill("FIREBALL",{q:0,r:3,s:-3}),e.wait(),e.wait()},verify:()=>!0}]},lA={id:"hazards_v1",name:"Hazard Consolidation",description:"Verifies centralized hazard logic and flight immunity",scenarios:[{id:"Jump Over Lava",title:"Jump Over Lava",description:"Jumping over lava should not result in damage.",relatedSkills:["JUMP"],category:"hazards",tags:["lava","jump"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["JUMP"]),e.state.tiles.set("4,8",{baseId:"LAVA",position:{q:4,r:8,s:-12},traits:new Set(["HAZARDOUS","LAVA","LIQUID"]),effects:[]})},run:e=>{e.useSkill("JUMP",{q:4,r:7,s:-11})},verify:e=>{const n=e.player,s={playerPos:Q(n.position,{q:4,r:7,s:-11}),isAlive:n.hp===n.maxHp};return Object.values(s).every(o=>o===!0)}},{id:"Walk Into Lava",title:"Walk Into Lava",description:"Walking into lava should be invalid unless the mover is hazard-safe.",relatedSkills:["BASIC_MOVE"],category:"hazards",tags:["lava","walk"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["BASIC_MOVE"]),e.state.tiles.set("4,8",{baseId:"LAVA",position:{q:4,r:8,s:-12},traits:new Set(["HAZARDOUS","LAVA","LIQUID"]),effects:[]})},run:e=>{e.useSkill("BASIC_MOVE",{q:4,r:8,s:-12})},verify:e=>{const n=e.player,s={playerPos:Q(n.position,{q:4,r:9,s:-13}),hpUnchanged:n.hp===n.maxHp};return Object.values(s).every(o=>o===!0)}},{id:"Falcon Flying Over Lava",title:"Falcon Flying Over Lava",description:"Flying units (Falcon) should ignore lava during transit and stay.",relatedSkills:["FALCON_COMMAND"],category:"hazards",tags:["lava","falcon","flight"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.spawnFalcon({q:4,r:8,s:-12},"my-falcon"),e.state.tiles.set("4,8",{baseId:"LAVA",position:{q:4,r:8,s:-12},traits:new Set(["HAZARDOUS","LAVA","LIQUID"]),effects:[]})},run:e=>{e.wait()},verify:e=>{const n=e.enemies.find(o=>o.id==="my-falcon"),s={falconExists:!!n,falconAlive:(n?.hp||0)>0,falconPos:Q(n?.position,{q:4,r:8,s:-12})};return Object.values(s).every(o=>o===!0)}}]},cA={id:"falcon_command_v2",name:"Falcon's Command",description:"Validates Predator/Scout mode transitions and spatial orbit logic.",scenarios:[{id:"falcon_predator_strike_path",title:"Predator Mode: Apex Strike Geometry",description:`
                Tests the Falcon's flight path from its current position to the Target.
                Layout:
                   (F)  <- Falcon Start (6, 5, -11)
                      .
                         (T) <- Target/Prey (8, 5, -13)
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"beginner",isTutorial:!0,tags:["falcon","summon","companion"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.spawnFalcon({q:3,r:9,s:-12},"my-falcon"),e.spawnEnemy("footman",{q:4,r:2,s:-6},"prey")},run:e=>{e.useSkill("FALCON_COMMAND",{q:4,r:2,s:-6}),e.wait()},verify:(e,n)=>{const s=e.companions?.find(l=>l.id==="my-falcon"),o=e.enemies.find(l=>l.id==="prey"),a={modeSet:s?.companionState?.mode==="predator",targetLocked:s?.companionState?.markTarget==="prey",movedCloser:s&&fe(s.position,{q:4,r:2,s:-6})<7,preyHealthy:o?.hp===o?.maxHp,turnSpent:e.turnsSpent===2};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Falcon Predator Strike Failed:",a),console.log("Falcon:",s)),Object.values(a).every(l=>l===!0)}},{id:"falcon_scout_orbit",title:"Scout Mode: Hex Ring Orbit",description:`
                Ensures that in Scout mode, the Falcon rotates around the mark 
                on the flat-top hex ring.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"beginner",isTutorial:!0,tags:["falcon","summon","companion"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.spawnFalcon({q:3,r:9,s:-12},"my-falcon")},run:e=>{e.useSkill("FALCON_COMMAND",{q:3,r:6,s:-9}),e.wait(),e.wait()},verify:(e,n)=>{const s=e.companions?.find(l=>l.id==="my-falcon"),o={q:3,r:6,s:-9},a={isScout:s?.companionState?.mode==="scout",onOrbitRing:s&&fe(s.position,o)===1,hasRotated:s&&!!s.previousPosition&&!Q(s.position,s.previousPosition),turnSpent:e.turnsSpent===3};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Falcon Scout Orbit Failed:",a),console.log("Falcon:",s)),Object.values(a).every(l=>l===!0)}},{id:"falcon_roost_mode",title:"Roost Mode: Return and Heal",description:`
                Ensures that when targeting self, the Falcon returns to the Hunter
                and provides a heal on arrival.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"beginner",isTutorial:!0,tags:["falcon","roost","heal"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.state.player.hp=2,e.spawnFalcon({q:3,r:6,s:-9},"my-falcon")},run:e=>{e.useSkill("FALCON_COMMAND",{q:4,r:9,s:-13}),e.wait(),e.wait()},verify:(e,n)=>{const s=e.companions?.find(l=>l.id==="my-falcon"),o=e.player,a={modeRoost:s?.companionState?.mode==="roost",healed:o.hp>2,closeToHunter:s&&fe(s.position,o.position)<=1};return Object.values(a).some(l=>l===!1)&&console.log(" Scenario Falcon Roost Heal Failed:",a),Object.values(a).every(l=>l===!0)}},{id:"falcon_predator_auto_return",title:"Predator Mode: Auto-Roost on Kill",description:`
                Ensures that if a marked predator target dies, the Falcon
                automatically reverts to Roost mode.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"intermediate",isTutorial:!0,tags:["falcon","predator","cleanup"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.state.player.hp=1,e.spawnFalcon({q:4,r:8,s:-12},"my-falcon"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"prey")},run:e=>{e.useSkill("FALCON_COMMAND",{q:4,r:7,s:-11}),e.wait(),e.wait(),e.wait()},verify:(e,n)=>{const s=e.companions?.find(u=>u.id==="my-falcon"),o=e.enemies.find(u=>u.id==="prey"),a=e.player,l={preyDead:!o,autoRoost:s?.companionState?.mode==="roost",healed:a.hp>1};return Object.values(l).some(u=>u===!1),Object.values(l).every(u=>u===!0)}},{id:"falcon_command_metadata_null_safety",title:"Command Metadata Null-Safety",description:`
                Ensures FALCON_COMMAND name/description resolution is safe
                when player context is remapped in harness-like states.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"intermediate",isTutorial:!1,tags:["falcon","null-safety","metadata"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.state.player.id="hunter_remapped"},run:e=>{e.wait()},verify:(e,n)=>{const s={playerIdRemapped:e.player.id==="hunter_remapped",noRuntimeReferenceError:!n.some(o=>o.toLowerCase().includes("cannot read properties"))};return Object.values(s).some(o=>o===!1)&&console.log("Falcon Command Metadata Null-Safety Failed:",s),Object.values(s).every(o=>o===!0)}}]},uA={id:"kinetic_tri_trap",name:"Kinetic Tri-Trap",description:"Tests for trap deployment and fling mechanics",scenarios:[{id:"tri_trap_basic_deployment",title:"Trap Deployment",description:"Deploy 3 traps on axial tiles at range 2.",relatedSkills:["KINETIC_TRI_TRAP"],category:"deployment",difficulty:"beginner",isTutorial:!0,tags:["trap","deployment"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["KINETIC_TRI_TRAP"]),e.state.player.archetype="HUNTER"},run:e=>{e.useSkill("KINETIC_TRI_TRAP",{q:5,r:5,s:-10})},verify:(e,n)=>{const s=e.player.position,o=e.traps||[],a={countIsThree:o.length===3,isAtRangeTwo:o.every(l=>fe(l.position,s)===2),isAxialToPlayer:o.every(l=>l.position.q===s.q||l.position.r===s.r||l.position.s===s.s),trapsHidden:o.every(l=>!l.isRevealed)};return Object.values(a).some(l=>l===!1)&&(console.log(" Scenario Tri-Trap Deployment Failed:",a),console.log("Traps:",e.traps),console.log("Logs:",n)),Object.values(a).every(l=>l===!0)}},{id:"tri_trap_state_tracking",title:"Trap State Tracking",description:"Traps are tracked with correct owner and hidden state.",relatedSkills:["KINETIC_TRI_TRAP"],category:"state",difficulty:"intermediate",isTutorial:!1,tags:["trap","state"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["KINETIC_TRI_TRAP"]),e.state.player.archetype="HUNTER"},run:e=>{e.useSkill("KINETIC_TRI_TRAP",{q:5,r:5,s:-10}),e.useSkill("KINETIC_TRI_TRAP",{q:5,r:5,s:-10})},verify:(e,n)=>{const s=e.traps,o={trapsExist:s&&s.length>0,allHidden:s?.every(a=>!a.isRevealed)??!1,allZeroCooldown:s?.every(a=>a.cooldown===0)??!1,deployMessage:n.some(a=>a.includes("trap")||a.includes("Trap")),trapsCount:s?.length===3};return Object.values(o).some(a=>a===!1)&&(console.log(" Trap State Failed:",o),console.log("Traps:",e.traps)),Object.values(o).every(a=>a===!0)}}]},dA={id:"withdrawal",name:"Withdrawal",description:"Tests for shot + backroll mechanics and passive reaction",scenarios:[{id:"withdrawal_basic",title:"Shot and Backroll",description:"Shoot adjacent enemy and backroll to safety.",relatedSkills:["WITHDRAWAL"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["shot","backroll","displacement"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["WITHDRAWAL"]),e.state.player.archetype="HUNTER",e.spawnEnemy("footman",{q:6,r:5,s:-11},"target")},run:e=>{e.useSkill("WITHDRAWAL",{q:6,r:5,s:-11})},verify:(e,n)=>{const s=e.enemies.find(a=>a.id==="target"),o={enemyDamagedOrDead:!s||s.hp<s.maxHp,playerMoved:e.player.position.q!==5||e.player.position.r!==5,playerBackrolled:e.player.position.q<5,shotFired:n.some(a=>a.includes("Withdrawal")||a.includes("shot"))};return Object.values(o).some(a=>a===!1)&&(console.log(" Withdrawal Failed:",o),console.log("Player:",e.player.position),console.log("Target HP:",s?.hp)),Object.values(o).every(a=>a===!0)}},{id:"withdrawal_wall_block",title:"Backroll Blocked by Wall",description:"Backroll finds alternate safe spot when wall blocks retreat.",relatedSkills:["WITHDRAWAL"],category:"collision",difficulty:"intermediate",isTutorial:!1,tags:["backroll","wall","pathfinding"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["WITHDRAWAL"]),e.state.player.archetype="HUNTER",e.setTile({q:4,r:5,s:-9},"wall"),e.setTile({q:3,r:5,s:-8},"wall"),e.spawnEnemy("footman",{q:6,r:5,s:-11},"target")},run:e=>{e.useSkill("WITHDRAWAL",{q:6,r:5,s:-11})},verify:(e,n)=>{const s={playerNotOnWall:!Q(e.player.position,{q:4,r:5,s:-9}),playerMoved:e.player.position.q!==5||e.player.position.r!==5};return Object.values(s).some(o=>o===!1)&&(console.log(" Wall Block Failed:",s),console.log("Player:",e.player.position)),Object.values(s).every(o=>o===!0)}}]},fA={id:"absorb_fire",name:"Absorb Fire Passive",description:"Verifies that fire damage is converted to healing.",scenarios:[{id:"Absorb Fire Damage",title:"Stand on Fire",description:"Player with Absorb Fire should be healed when standing on fire.",relatedSkills:["ABSORB_FIRE"],category:"passive",tags:["fire","healing"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["ABSORB_FIRE"]),e.state.player.hp=1,e.setTile({q:4,r:5,s:-9},"stone");const n={q:4,r:5,s:-9},s=e.getTileAt(n);s&&s.effects.push({id:"FIRE",duration:3,potency:1})},run:e=>{e.wait()},verify:e=>{const n=e.player;return n.hp<=1&&console.log("Stand on Fire Failed: HP did not increase",n.hp),n.hp>1}},{id:"Absorb Lava Damage",title:"Walk into Lava",description:"Player with Absorb Fire should be healed when walking into lava.",relatedSkills:["ABSORB_FIRE","BASIC_MOVE"],category:"passive",tags:["lava","healing"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["ABSORB_FIRE","BASIC_MOVE"]),e.state.player.hp=1,e.setTile({q:4,r:6,s:-10},"lava")},run:e=>{e.useSkill("BASIC_MOVE",{q:4,r:6,s:-10})},verify:e=>{const n=e.player,s={alive:n.hp>0,healed:n.hp===n.maxHp,onLava:Q(n.position,{q:4,r:6,s:-10})};return(!s.alive||!s.healed||!s.onLava)&&(console.log("Walk into Lava Failed:",s,"HP:",n.hp,"MaxHP:",n.maxHp),console.log("Player Pos:",n.position)),Object.values(s).every(o=>o===!0)}}]},mA={id:"tile_interactions",name:"Tile Interactions",description:"Verifies interactions with special tiles like Shrines and Stairs.",scenarios:[{id:"shrine_interaction",title:"Shrine Interaction",description:"Moving onto a shrine should trigger an upgrade choice.",relatedSkills:["BASIC_MOVE"],category:"progression",tags:["shrine","upgrade"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"]),e.state.shrinePosition={q:4,r:6,s:-10},e.state.tiles.set("4,6",{baseId:"SHRINE",position:{q:4,r:6,s:-10},traits:new Set(["INTERACTABLE","SHRINE"]),effects:[]})},run:e=>{e.move({q:4,r:6,s:-10})},verify:e=>{const n={playerOnShrine:Q(e.player.position,{q:4,r:6,s:-10}),isChoosingUpgrade:e.pendingStatus?.status==="choosing_upgrade",hasOptions:e.pendingStatus?.shrineOptions?.length>0};return Object.values(n).every(s=>s===!0)}},{id:"stairs_interaction",title:"Stairs Interaction",description:"Moving onto stairs should trigger level transition.",relatedSkills:["BASIC_MOVE"],category:"progression",tags:["stairs","portal"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"]),e.state.stairsPosition={q:4,r:6,s:-10},e.state.tiles.set("4,6",{baseId:"STAIRS",position:{q:4,r:6,s:-10},traits:new Set(["INTERACTABLE","STAIRS"]),effects:[]})},run:e=>{e.move({q:4,r:6,s:-10})},verify:e=>{const n={playerOnStairs:Q(e.player.position,{q:4,r:6,s:-10}),isTransitioning:e.pendingStatus?.status==="playing"||e.pendingStatus?.status==="won",messageFound:e.message.some(s=>s.includes("Descending")||s.includes("Cleared"))};return Object.values(n).every(s=>s===!0)}}]},pA={id:"telegraph_projection",name:"Telegraph Projection",description:"Deterministic intent previews for next-turn danger tiles.",scenarios:[{id:"telegraph_projection_is_deterministic",title:"Projection Determinism",description:"Same state should always produce the same danger projection.",relatedSkills:["BASIC_ATTACK"],category:"telegraph",difficulty:"intermediate",isTutorial:!1,tags:["projection","determinism"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:7,r:5,s:-12},"threat")},run:e=>{e.wait()},verify:e=>{const n=e.intentPreview,s=n?.dangerTiles||[],o=n?.projections||[],a=s.map(g=>`${g.q},${g.r},${g.s}`),l=new Set(a),u=a.every((g,b)=>b===0||a[b-1].localeCompare(g)<=0),f=o.map(g=>`${g.actorId}|${g.skillId}|${g.targetHex?`${g.targetHex.q},${g.targetHex.r},${g.targetHex.s}`:"none"}`),p=f.every((g,b)=>b===0||f[b-1].localeCompare(g)<=0),h={hasEnginePreview:!!n,noDuplicateTiles:l.size===a.length,tilesAreSorted:u,projectionsAreSorted:p};return Object.values(h).some(g=>g===!1)&&(console.log("Telegraph Projection Determinism Failed:",h),console.log("Engine Preview:",n)),Object.values(h).every(g=>g===!0)}},{id:"telegraph_projection_matches_execute_footprint",title:"Projection Matches Execute Footprint",description:"Projected danger tiles should include the tile actually damaged on execution.",relatedSkills:["BASIC_ATTACK"],category:"telegraph",difficulty:"intermediate",isTutorial:!1,tags:["projection","parity","combat"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:4,r:2,s:-6},"threat")},run:e=>{e.wait();const o=e.state.intentPreview?.projections?.find(a=>a.actorId==="threat")?.dangerTiles?.[0];o?e.logs.push(`PREVIEW_TILE=${o.q},${o.r},${o.s}`):e.logs.push("PREVIEW_TILE=none"),e.wait()},verify:(e,n)=>{const s=e.enemies.find(f=>f.id==="threat"),a=n.find(f=>f.startsWith("PREVIEW_TILE="))?.split("=")[1]||"none",l=a==="none"?void 0:(()=>{const[f,p,h]=a.split(",").map(g=>Number(g));return{q:f,r:p,s:h}})(),u={previewProducedTile:!!l,projectedTileMatchesExecute:!!l&&!!s&&Q(s.position,l)};return Object.values(u).some(f=>f===!1)&&(console.log("Telegraph Projection Parity Failed:",u),console.log("Logs:",n),console.log("Player HP:",e.player.hp,"/",e.player.maxHp)),Object.values(u).every(f=>f===!0)}}]},bd=e=>{const s={BASIC_MOVE:{slot:"passive",range:1,cooldown:0,name:"Walk",description:"Move to adjacent tile."},BASIC_ATTACK:{slot:"passive",range:1,cooldown:0,name:"Basic Attack",description:"Strike adjacent target."},DASH:{slot:"passive",range:4,cooldown:0,name:"Kinetic Dash",description:"Dash in a straight line."}}[e]||{slot:"offensive",range:1,cooldown:0,name:e,description:e};return{id:e,name:s.name,description:s.description,slot:s.slot,cooldown:s.cooldown,currentCooldown:0,range:s.range,upgrades:[],activeUpgrades:[]}},hA={id:"raider_dash",name:"Raider Dash",description:"Parity checks for enemy Raider reusing the player DASH contract.",scenarios:[{id:"player_dash_stops_before_adjacent_enemy",title:"Parity Baseline: Player Dash Stops Before Blocker",description:"Player DASH should stop on the tile before an occupied target.",relatedSkills:["DASH"],category:"movement",difficulty:"beginner",isTutorial:!1,tags:["parity","dash","reuse"],setup:e=>{e.setPlayer({q:4,r:2,s:-6},["DASH"]),e.spawnEnemy("footman",{q:4,r:6,s:-10},"blocker"),e.state.hasShield=!1},run:e=>{e.useSkill("DASH",{q:4,r:6,s:-10})},verify:(e,n)=>{const s={playerStoppedBeforeBlocker:e.player.position.q===4&&e.player.position.r===5,dashResolved:n.some(o=>o.includes("Stopped by an obstacle")||o.includes("Dashed!")||o.includes("Shield Shunt"))};return Object.values(s).every(o=>o===!0)}},{id:"raider_ai_uses_dash_with_player_contract",title:"Parity: Raider Uses Same Dash Stop Rule",description:"Raider AI selects DASH and lands on the same stop tile as player-owned DASH in mirrored geometry.",relatedSkills:["DASH"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["parity","enemy-ai","dash"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},[]),e.spawnEnemy("raider",{q:4,r:2,s:-6},"raider"),e.state.hasShield=!1;const n=e.getEnemy("raider");n&&(n.activeSkills=[bd("BASIC_MOVE"),bd("BASIC_ATTACK"),bd("DASH")])},run:e=>{e.wait()},verify:(e,n)=>{const s=e.enemies.find(a=>a.id==="raider"),o={raiderStillAlive:!!s,raiderStoppedBeforePlayer:!!s&&s.position.q===4&&s.position.r===5,playerUnharmed:e.player.hp===e.player.maxHp,dashResolved:n.some(a=>a.includes("Stopped by an obstacle")||a.includes("Dashed!")||a.includes("Shield Shunt"))};return Object.values(o).every(a=>a===!0)}}]},Sd=e=>{const s={BASIC_MOVE:{slot:"passive",range:1,cooldown:0,name:"Walk",description:"Move to adjacent tile."},BASIC_ATTACK:{slot:"passive",range:1,cooldown:0,name:"Basic Attack",description:"Strike adjacent target."},GRAPPLE_HOOK:{slot:"offensive",range:4,cooldown:0,name:"Grapple Hook",description:"Pull and swap with target."}}[e]||{slot:"offensive",range:1,cooldown:0,name:e,description:e};return{id:e,name:s.name,description:s.description,slot:s.slot,cooldown:s.cooldown,currentCooldown:0,range:s.range,upgrades:[],activeUpgrades:[]}},yA={id:"pouncer_hook",name:"Pouncer Hook",description:"Second archetype reuse: enemy uses player GRAPPLE_HOOK via normal skill execution.",scenarios:[{id:"pouncer_uses_grapple_hook_deterministically",title:"Pouncer Uses Grapple Hook Through Skill Pipeline",description:"Pouncer selects GRAPPLE_HOOK from AI and resolves via standard USE_SKILL execution.",relatedSkills:["GRAPPLE_HOOK"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["parity","enemy-ai","determinism"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},[]),e.spawnEnemy("pouncer",{q:4,r:2,s:-6},"pouncer");const n=e.getEnemy("pouncer");n&&(n.activeSkills=[Sd("BASIC_MOVE"),Sd("BASIC_ATTACK"),Sd("GRAPPLE_HOOK")])},run:e=>{e.wait()},verify:(e,n)=>{const o={pouncerStillAlive:!!e.enemies.find(a=>a.id==="pouncer"),grappleExecuted:n.filter(a=>a.includes("Vaulted and Flung!")).length>=1,deterministicStatus:n.filter(a=>a.includes("You are stunned!")).length===1,noZeroEffectWarning:!n.some(a=>a.includes("produced ZERO effects"))};return Object.values(o).every(a=>a===!0)}}]},gA={id:"ice",name:"Ice Terrain",description:"ICE/SLIPPERY terrain behavior for pass-through momentum and landing slide.",scenarios:[{id:"ice_pass_preserves_dash_momentum",title:"Ice Pass: Dash Carries Momentum",description:"Passing through ICE during DASH should preserve momentum and carry movement beyond nominal target.",relatedSkills:["DASH"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["terrain","ice","momentum","pass"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["DASH"]),e.state.hasShield=!1,e.setTile({q:5,r:4,s:-9},"slippery"),e.setTile({q:6,r:4,s:-10},"floor"),e.setTile({q:7,r:4,s:-11},"floor")},run:e=>{e.useSkill("DASH",{q:6,r:4,s:-10})},verify:e=>e.player.position.q>6},{id:"ice_land_slides_after_basic_move",title:"Ice Land: Basic Move Slides Forward",description:"Landing on ICE with BASIC_MOVE should slide one hex in the move direction when the next tile is walkable.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"beginner",isTutorial:!1,tags:["terrain","ice","slide","land"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["BASIC_MOVE"]),e.setTile({q:5,r:4,s:-9},"slippery"),e.setTile({q:6,r:4,s:-10},"floor")},run:e=>{e.move({q:5,r:4,s:-9})},verify:e=>e.player.position.q===6&&e.player.position.r===4}]},bA={id:"snare",name:"Snare Terrain",description:"Snare tile effect movement restriction and status interaction.",scenarios:[{id:"snare_interrupts_dash_and_roots_actor",title:"Snare Interrupts Dash",description:"DASH into a snare tile should halt movement at snare and apply rooted status.",relatedSkills:["DASH"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["terrain","snare","movement-restriction"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["DASH"]),e.state.hasShield=!1,e.state.tiles.set("5,4",{baseId:"STONE",position:{q:5,r:4,s:-9},traits:new Set(["WALKABLE"]),effects:[{id:"SNARE",duration:-1,potency:1}]}),e.setTile({q:6,r:4,s:-10},"floor"),e.setTile({q:7,r:4,s:-11},"floor")},run:e=>{e.useSkill("DASH",{q:7,r:4,s:-11})},verify:(e,n)=>{const s=e.player.statusEffects.some(a=>a.type==="rooted"),o={stoppedAtSnare:e.player.position.q===5&&e.player.position.r===4,rootedApplied:s,snareMessageLogged:n.some(a=>a.includes("Snared! Movement halted."))};return Object.values(o).every(a=>a===!0)}}]},SA={id:"relics",name:"Relics",description:"Passive relic behaviors using existing engine hooks only.",scenarios:[{id:"relic_ember_ward_reduces_fire_damage",title:"Relic: Ember Ward",description:"Equipping Ember Ward reduces incoming fire damage by 1.",relatedSkills:["BASIC_MOVE"],category:"passive",difficulty:"beginner",isTutorial:!1,tags:["relic","fire","passive"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.upgrades=[...e.state.upgrades||[],"RELIC_EMBER_WARD"],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:(e,n)=>{const s={hpUnchanged:e.player.hp===e.player.maxHp,relicMessageSeen:n.some(o=>o.includes("Ember Ward dampens the flames."))};return Object.values(s).every(o=>o===!0)}},{id:"relic_cinder_orb_stacks_with_absorb_fire",title:"Relic: Cinder Orb Stacking",description:"Cinder Orb adds bonus healing when fire damage is converted by Absorb Fire.",relatedSkills:["ABSORB_FIRE"],category:"passive",difficulty:"advanced",isTutorial:!1,tags:["relic","stacking","absorb-fire"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["ABSORB_FIRE"]),e.state.player={...e.state.player,hp:1,maxHp:3},e.state.upgrades=[...e.state.upgrades||[],"RELIC_CINDER_ORB"],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:(e,n)=>{const s={healedByStacking:e.player.hp===3,stackingMessageSeen:n.some(o=>o.includes("Cinder Orb amplifies the absorption."))};return Object.values(s).every(o=>o===!0)}},{id:"relic_steady_plates_end_to_end",title:"Relic: Steady Plates",description:"Steady Plates grants turn-start armor that resolves against incoming damage in the same round.",relatedSkills:["BASIC_MOVE"],category:"passive",difficulty:"intermediate",isTutorial:!1,tags:["relic","armor","turn-start"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.upgrades=[...e.state.upgrades||[],"RELIC_STEADY_PLATES"],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:(e,n)=>{const s={playerHpProtected:e.player.hp===e.player.maxHp,damageEventOccurred:n.some(o=>o.includes("player burns!")),armorPresentAfterCycle:e.player.temporaryArmor>=0&&e.player.temporaryArmor<=2,relicTriggerMessageSeen:n.some(o=>o.includes("Steady Plates harden your stance."))};return Object.values(s).every(o=>o===!0)}}]},vA=250,xA=700,AA=100,TA=8,EA=220,_A=260,wA=40,s0=(e,n)=>{const s=e.floor||0,o=e.player?.hp||0,a=e.turnsSpent??e.turnNumber??0,l=e.kills||0,u=e.environmentalKills||0,f=e.hazardBreaches||0,p=(n||[]).filter(h=>h.success).length*vA;return s*xA+o*AA+l*EA+u*_A-a*TA-f*wA+p},MA=e=>{if(typeof e=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const n=e instanceof Date?e:new Date,s=n.getFullYear(),o=String(n.getMonth()+1).padStart(2,"0"),a=String(n.getDate()).padStart(2,"0");return`${s}-${o}-${a}`},CA=e=>`daily:${e}`,OA=e=>{const n=18+Math.floor(Il(e,0)*8);return[{id:"TURN_LIMIT",label:`Finish within ${n} turns`,target:n},{id:"HAZARD_CONSTRAINT",label:"Take no hazard damage",target:0}]},Nl=e=>(e.runObjectives||[]).map(s=>{if(s.id==="TURN_LIMIT"){const a=e.turnsSpent||0;return{...s,value:a,success:a<=s.target}}const o=e.hazardBreaches||0;return{...s,value:o,success:o<=s.target}}),jo=e=>{const n=e.initialSeed??e.rngSeed??"0",s=Nl(e),o=e.combatScoreEvents||[],a=o.length?Number((o.reduce((u,f)=>u+f.efficiency,0)/o.length).toFixed(4)):0,l=o.filter(u=>u.riskBonusApplied).length;return{seed:n,actionLog:e.actionLog,score:s0(e,s),floor:e.floor,objectives:s,combatTelemetry:{events:o.length,avgEfficiency:a,riskBonusEvents:l}}},NA={id:"objectives",name:"Objectives",description:"Daily objective validation for turn-limit and hazard constraints.",scenarios:[{id:"objective_turn_limit_boundary",title:"Objective: Turn Limit Boundary",description:"Turn-limit objective passes at boundary and fails above boundary.",relatedSkills:["BASIC_MOVE"],category:"progression",difficulty:"intermediate",isTutorial:!1,tags:["objective","turn-limit"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.runObjectives=[{id:"TURN_LIMIT",label:"Finish within 1 turns",target:1}]},run:e=>{e.wait()},verify:e=>{const s=Nl(e)[0]?.success===!0,o=jo(e).score,a=Nl({...e,turnsSpent:(e.turnsSpent||0)+1}),l={...e,turnsSpent:(e.turnsSpent||0)+1},u=jo(l).score,f=a[0]?.success===!1,p=u<o;return s&&f&&p}},{id:"objective_hazard_constraint_fail_on_hazard",title:"Objective: Hazard Constraint",description:"Hazard objective fails after prohibited hazard interaction.",relatedSkills:["BASIC_MOVE"],category:"hazards",difficulty:"intermediate",isTutorial:!1,tags:["objective","hazard"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.runObjectives=[{id:"HAZARD_CONSTRAINT",label:"Take no hazard damage",target:0}],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:e=>{const n=Nl(e)[0];return(e.hazardBreaches||0)>0&&!!n&&n.success===!1}}]},kA={id:"necromancer",name:"Necromancer",description:"Corpse persistence and summon migration contracts.",scenarios:[{id:"necromancer_corpse_persistence",title:"Corpse Persists Until Consumed",description:"Kill an enemy, wait 5 turns, then Raise Dead succeeds from corpse tile trait.",relatedSkills:["BASIC_ATTACK","RAISE_DEAD"],category:"summon",difficulty:"intermediate",isTutorial:!1,tags:["necromancer","corpse","persistence"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["BASIC_ATTACK","RAISE_DEAD"],"VANGUARD"),e.spawnEnemy("footman",{q:5,r:4,s:-9},"dummy");const n=e.getEnemy("dummy");n&&(n.hp=1,n.maxHp=1)},run:e=>{const n={q:5,r:4,s:-9};e.useSkill("BASIC_ATTACK",n);for(let s=0;s<5;s++)e.wait();e.useSkill("RAISE_DEAD",n)},verify:e=>{const n=ce({q:5,r:4}),s=e.tiles.get(n),o=e.enemies.find(f=>f.subtype==="skeleton"&&f.factionId==="player"),a=e.companions?.find(f=>f.id===o?.id),l=new Set((o?.activeSkills||[]).map(f=>f.id)),u={corpseConsumed:!s?.traits?.has("CORPSE"),skeletonRaised:!!o,skeletonOnCorpseTile:!!o&&o.position.q===5&&o.position.r===4,companionRegistered:!!a,hasBasicLoadout:l.has("BASIC_MOVE")&&l.has("BASIC_ATTACK")};return Object.values(u).every(Boolean)}},{id:"summon_floor_transition",title:"Summon Persists Across Floor Transition",description:"Raised skeleton migrates with player to floor 2.",relatedSkills:["RAISE_DEAD"],category:"summon",difficulty:"advanced",isTutorial:!1,tags:["necromancer","summon","floor-transition"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["RAISE_DEAD"],"VANGUARD");const n={q:5,r:4,s:-9},s=ce(n),o=e.getTileAt(n);e.state.tiles.set(s,{...o,position:n,traits:new Set([...o?.traits||[],"CORPSE"])})},run:e=>{const n={q:5,r:4,s:-9};e.useSkill("RAISE_DEAD",n),e.state.player={...e.state.player,position:{...e.state.stairsPosition}},e.wait(),e.dispatchSync({type:"RESOLVE_PENDING"})},verify:e=>{const n=e.enemies.find(o=>o.subtype==="skeleton"&&o.factionId==="player"&&o.companionOf===e.player.id),s={floorAdvanced:e.floor===2,summonStillPresent:!!n,summonTracksOwner:!!n&&n.companionOf===e.player.id};return Object.values(s).every(Boolean)}},{id:"companion_does_not_block_free_move",title:"Companion Does Not Block Exploration Free Move",description:"Friendly skeleton companion should not count as hostile for BASIC_MOVE exploration range.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["necromancer","companion","movement"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"],"VANGUARD"),e.spawnEnemy("footman",{q:5,r:5,s:-10},"friendly_skeleton");const n=e.getEnemy("friendly_skeleton");n&&(n.subtype="skeleton",n.factionId="player",n.companionOf=e.state.player.id,n.activeSkills=n.activeSkills||[],e.state.companions=[...e.state.companions||[],n])},run:e=>{e.move({q:7,r:1,s:-8})},verify:e=>{const n={movedFar:e.player.position.q===7&&e.player.position.r===1,turnsAdvanced:e.turnsSpent>=1};return Object.values(n).every(Boolean)}},{id:"raise_dead_pushes_ally_from_target_hex",title:"Raise Dead Pushes Ally Occupant",description:"If corpse tile is occupied by an ally, ally is displaced and summon succeeds without overlap.",relatedSkills:["RAISE_DEAD"],category:"summon",difficulty:"advanced",isTutorial:!1,tags:["necromancer","occupancy","push"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["RAISE_DEAD"],"VANGUARD");const n={q:5,r:5,s:-10},s=ce(n),o=e.getTileAt(n);e.state.tiles.set(s,{...o,position:n,traits:new Set([...o?.traits||[],"CORPSE"])}),e.spawnEnemy("footman",n,"ally_blocker");const a=e.getEnemy("ally_blocker");a&&(a.subtype="skeleton",a.factionId="player",a.companionOf=e.state.player.id,e.state.companions=[...e.state.companions||[],a])},run:e=>{e.useSkill("RAISE_DEAD",{q:5,r:5,s:-10})},verify:e=>{const n=e.enemies.filter(f=>f.subtype==="skeleton"&&f.factionId==="player"),s=new Set;let o=!1;n.forEach(f=>{const p=ce(f.position);s.has(p)&&(o=!0),s.add(p)});const a=n.some(f=>f.position.q===5&&f.position.r===5),l=n.some(f=>f.id==="ally_blocker"&&!(f.position.q===5&&f.position.r===5));return Object.values({raisedAtCorpse:a,pushedExists:l,noOverlap:!o}).every(Boolean)}}]},RA={id:"archer_shot",name:"Archer Shot",description:"Tests for dedicated archer ranged line-shot targeting, LoS, and axial validation.",scenarios:[{id:"archer_shot_clear_lane_hit",title:"Archer Shot: Clear Lane Hit",description:"A valid axial target in clear line of sight is damaged.",relatedSkills:["ARCHER_SHOT"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["projectile","line-of-sight","axial"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["ARCHER_SHOT"]),e.spawnEnemy("footman",{q:3,r:4,s:-7},"target")},run:e=>{e.useSkill("ARCHER_SHOT",{q:3,r:4,s:-7})},verify:(e,n)=>{const s=e.enemies.find(l=>l.id==="target"),o=!s||s.hp<s.maxHp,a=n.some(l=>l.includes("Archer shot!"));return o&&a}},{id:"archer_shot_wall_blocked",title:"Archer Shot: Wall Blocks Line of Sight",description:"Archer Shot fails when a wall blocks the line to the target actor.",relatedSkills:["ARCHER_SHOT"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["projectile","line-of-sight","wall"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},["ARCHER_SHOT"]),e.spawnEnemy("footman",{q:4,r:3,s:-7},"target"),e.setTile({q:4,r:4,s:-8},"wall")},run:e=>{e.useSkill("ARCHER_SHOT",{q:4,r:3,s:-7})},verify:(e,n)=>{const s=e.enemies.find(l=>l.id==="target"),o=!!s&&s.hp===s.maxHp,a=n.some(l=>l.includes("No clear line of sight"));return o&&a}},{id:"archer_shot_rejects_non_axial",title:"Archer Shot: Non-Axial Target Rejected",description:"Archer Shot enforces axial targeting and rejects diagonal targets.",relatedSkills:["ARCHER_SHOT"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["projectile","axial","targeting"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["ARCHER_SHOT"]),e.spawnEnemy("footman",{q:4,r:4,s:-8},"target")},run:e=>{e.useSkill("ARCHER_SHOT",{q:4,r:4,s:-8})},verify:(e,n)=>{const s=e.enemies.find(l=>l.id==="target"),o=!!s&&s.hp===s.maxHp,a=n.some(l=>l.includes("Target must be axial"));return o&&a}}]};function IA(e){return{id:e.id,title:e.title,description:e.description,rationale:e.rationale,setup:e.setup,run:e.run,verify:e.verify}}const LA=[Vx,Yx,Kx,Fx,Qx,Zx,eA,tA,nA,iA,sA,lA,aA,oA,rA,cA,uA,dA,fA,mA,pA,hA,yA,gA,bA,SA,NA,kA,RA],BA=LA.flatMap(e=>e.scenarios);function HA(e){return BA.filter(n=>n.relatedSkills.includes(e))}function Ye(e){return HA(e).map(IA)}const PA={id:"ARCHER_SHOT",name:"Archer Shot",description:"Fire an arrow in a straight line at a hostile target.",slot:"offensive",icon:"",baseVariables:{range:4,cost:0,cooldown:0,damage:1},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!bt(n.position,s,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const l=En(n.position,s);if(!l.isAxial)return{effects:o,messages:["Target must be axial."],consumesTurn:!1};const u=ye(e,s);if(!u||u.id===n.id)return{effects:o,messages:["No target at location."],consumesTurn:!1};if(u.factionId===n.factionId)return{effects:o,messages:["Cannot target ally."],consumesTurn:!1};if(!Bl(e,n.position,s,u.id,n.id))return{effects:o,messages:["No clear line of sight."],consumesTurn:!1};const f=Oe(n),p=_t({attackerId:n.id,targetId:u.id,skillId:"ARCHER_SHOT",basePower:1,trinity:f,targetTrinity:Oe(u),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.2}],statusMultipliers:[]}),h=Ze(n.position,s),g=p.finalPower>=4?"high":p.finalPower>=2?"medium":"low",b=l.directionIndex>=0?wt(l.directionIndex):void 0;return o.push({type:"Juice",effect:"aimingLaser",target:s,intensity:"low",metadata:{signature:"ATK.SHOOT.PHYSICAL.ARROW",family:"attack",primitive:"shoot",phase:"anticipation",element:"physical",variant:"arrow",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},path:h,skillId:"ARCHER_SHOT",timing:{durationMs:70,ttlMs:90}}}),o.push({type:"Juice",effect:"spearTrail",path:h,target:s,intensity:g,metadata:{signature:"ATK.SHOOT.PHYSICAL.ARROW",family:"attack",primitive:"shoot",phase:"travel",element:"physical",variant:"arrow",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"ARCHER_SHOT",timing:{delayMs:50,durationMs:80,ttlMs:110}}}),o.push({type:"Juice",effect:"lightImpact",target:u.id,intensity:g,direction:b,metadata:{signature:"ATK.SHOOT.PHYSICAL.ARROW",family:"attack",primitive:"shoot",phase:"impact",element:"physical",variant:"arrow",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},contactRef:{kind:"contact_world"},contactHex:u.position,contactFromHex:n.position,contactToHex:u.position,skillId:"ARCHER_SHOT",timing:{delayMs:95,durationMs:60,ttlMs:110}}}),o.push({type:"Damage",target:u.id,amount:p.finalPower,reason:"archer_shot",scoreEvent:p.scoreEvent}),a.push("Archer shot!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>{const s=ye(e,n);return s?[e.player,...e.enemies,...e.companions||[]].filter(a=>!!a&&a.hp>0).filter(a=>a.id!==s.id&&a.factionId!==s.factionId&&bt(n,a.position,4)&&En(n,a.position).isAxial&&Bl(e,n,a.position,a.id,s.id)).map(a=>a.position).filter((a,l,u)=>u.findIndex(f=>Q(f,a))===l):[]},upgrades:{},scenarios:Ye("ARCHER_SHOT")},Vi=(e,n)=>{let s=n,o=e.temporaryArmor||0,a=e.hp;if(o>0){const l=Math.min(o,s);o-=l,s-=l}return a=Math.max(0,a-s),{...e,hp:a,temporaryArmor:o}},Ud=(e,n,s,o)=>{const l=vv[n]?.tickWindow||"END_OF_TURN",u=n.toUpperCase();if(e.statusEffects.find(h=>h.id===u))return{...e,statusEffects:e.statusEffects.map(h=>h.id===u?{...h,duration:Math.max(h.duration,s),tickWindow:l,stacks:o||h.stacks}:h)};const p={id:u,type:n,duration:s,tickWindow:l,stacks:o||1};return{...e,statusEffects:[...e.statusEffects,p]}},jA=(e,n)=>({...e,hp:Math.min(e.maxHp,e.hp+n)}),DA=(e,n,s=!0)=>{const o=e.maxHp+n,a=s?Math.min(o,e.hp+n):e.hp;return{...e,maxHp:o,hp:a}},UA=e=>{const n=[];return e.player.hp<=0&&e.gameStatus==="playing"&&n.push({type:"GameOver",reason:"PLAYER_DIED"}),n},_y=e=>e.activeSkills?{...e,activeSkills:e.activeSkills.map(n=>({...n,currentCooldown:Math.max(0,n.currentCooldown-1)}))}:e,$A=(e,n,s)=>e.activeSkills?{...e,activeSkills:e.activeSkills.map(o=>o.id===n&&!o.activeUpgrades.includes(s)?{...o,activeUpgrades:[...o.activeUpgrades,s]}:o)}:e,wy=(e,n,s)=>{const o=s.preserveInputOrder===!1?[...n]:[...n].reverse(),a=s.describe||(()=>"UNKNOWN");let l=e;const u=[];let f=s.startTick||1;for(;o.length>0;){const p=o.length,h=o.pop();l=s.apply(l,h);const g=s.getReactions?.(l,h)||[];if(g.length>0)for(let b=g.length-1;b>=0;b--)o.push(g[b]);u.push({tick:f++,effectType:a(h),depthBefore:p,depthAfter:o.length,reactionsQueued:g.length})}return{state:l,trace:u,resolvedCount:u.length}},qA={ModifyCooldown:(e,n,s)=>{const o=l=>({...l,activeSkills:l.activeSkills?.map(u=>u.id!==n.skillId?u:{...u,currentCooldown:n.setExact?n.amount:Math.max(0,u.currentCooldown+n.amount)})}),a=s.sourceId||e.player.id;return a===e.player.id?{...e,player:o(e.player)}:{...e,enemies:e.enemies.map(l=>l.id===a?o(l):l),companions:e.companions?.map(l=>l.id===a?o(l):l)}},SetStealth:(e,n)=>{const s=o=>({...o,stealthCounter:(o.stealthCounter||0)+n.amount});return n.target==="self"?{...e,player:s(e.player)}:{...e,enemies:e.enemies.map(o=>o.id===n.target?s(o):o),companions:e.companions?.map(o=>o.id===n.target?s(o):o)}},UpdateCompanionState:(e,n,s)=>{const o=n.target==="self"?s.sourceId||e.player.id:n.target,a=l=>l.id!==o?l:{...l,companionState:{...l.companionState,mode:n.mode||l.companionState?.mode,markTarget:n.markTarget!==void 0?n.markTarget:l.companionState?.markTarget,orbitStep:n.mode==="scout"?0:l.companionState?.orbitStep,apexStrikeCooldown:n.apexStrikeCooldown!==void 0?n.apexStrikeCooldown:l.companionState?.apexStrikeCooldown,healCooldown:n.healCooldown!==void 0?n.healCooldown:l.companionState?.healCooldown}};return{...e,enemies:e.enemies.map(a),companions:e.companions?.map(a)}}},zA={SpawnCorpse:(e,n,s,o)=>o.addCorpseTraitAt(e,n.position),RemoveCorpse:(e,n,s,o)=>{const a=o.removeCorpseTraitAt(e,n.position);return{...a,dyingEntities:(a.dyingEntities||[]).filter(l=>!Q(l.position,n.position))}}},VA=/^\[(INFO|VERBOSE|DEBUG|CRITICAL)\|([A-Z_]+)\]\s*/i,YA=e=>VA.test(e),sf=(e,n="INFO",s="SYSTEM")=>e?YA(e)?e:`[${n}|${s}] ${e}`:"",KA=(e,n="INFO",s="SYSTEM")=>e.map(o=>sf(o,n,s)).filter(Boolean),it=(e,n,s,o,a=50)=>{const l=sf(n,s,o),u=[...e||[]];return l&&u[u.length-1]===l?u.slice(-a):[...u,l].slice(-a)},zn=(e,n,s,o,a=50)=>{const l=[...e||[]];let u;for(const f of KA(n,s,o))f&&u===f||(l.push(f),u=f);return l.slice(-a)},FA=["lava_sink","void_sink","hazard_intercept","lava_tick","fire_damage"],WA=["fire_damage","lava_sink","burning","hazard_intercept","lava_tick","oil_explosion","void_sink"],My=(e,n)=>!!e&&n.includes(e),Mo=e=>e?.statusEffects?.some(n=>n.type==="marked_predator")?1:0,GA={Damage:(e,n,s,o)=>{let a={...e};My(n.reason,FA)&&(a=o.appendTimelineEvent(a,"HAZARD_CHECK","Damage",{reason:n.reason,amount:n.amount,target:n.target},s,!0,200)),a=o.appendTimelineEvent(a,"DAMAGE_APPLY","Damage",{reason:n.reason,amount:n.amount,target:n.target,scoreEvent:n.scoreEvent},s,!0,180);let u="",f=null,p,h,g=n.amount;typeof n.target=="string"?n.target==="targetActor"?u=s.targetId||"":n.target!=="area"&&(u=n.target):f=n.target;const b=My(n.reason,WA),S=a.upgrades?.includes("RELIC_EMBER_WARD"),T=a.upgrades?.includes("RELIC_CINDER_ORB");if(b&&u){const A=(u===a.player.id?a.player:a.enemies.find(E=>E.id===u))?.activeSkills?.some(E=>E.id==="ABSORB_FIRE");let _=n.amount;if(u===a.player.id&&S&&(_=Math.max(0,_-1),a.message=it(a.message,"Ember Ward dampens the flames.","INFO","COMBAT")),A){const E=_+(u===a.player.id&&T?1:0);return u===a.player.id&&T&&(a.message=it(a.message,"Cinder Orb amplifies the absorption.","INFO","COMBAT")),o.applyAtomicEffect(a,{type:"Heal",target:u,amount:E})}}if(u)if(u===a.player.id){const v=a.player,A=n.scoreEvent?.damageClass||"physical",_=o.scaleCombatProfileDamage(a,n.amount,s.sourceId,v,A,n.reason);let E=_.amount;E+=Mo(v),b&&S&&(E=Math.max(0,E-1)),n.scoreEvent&&(a.combatScoreEvents=[...a.combatScoreEvents||[],{...n.scoreEvent,finalPower:E,traitOutgoingMultiplier:_.outgoing,traitIncomingMultiplier:_.incoming,traitTotalMultiplier:_.total}].slice(-500)),a.player=Vi(a.player,E),p=a.player.id,h=a.player.position,g=E,b&&(a.hazardBreaches=(a.hazardBreaches||0)+1),b&&T&&(a.player=jA(a.player,1),a.message=it(a.message,"Cinder Orb restores 1 HP.","INFO","COMBAT"))}else{const v=a.enemies.find(I=>I.id===u),A=u===a.player.id?a.player.position:v?.position,_=[],E=n.scoreEvent?.damageClass||"physical",w=o.scaleCombatProfileDamage(a,n.amount,s.sourceId,v,E,n.reason),M=w.amount+Mo(v);p=u||v?.id,h=A||v?.position,g=M;const C=I=>{if(I.id===u){const k=Vi(I,M);return k.hp<=0&&(a.dyingEntities=[...a.dyingEntities||[],I],_.push(I.position)),k}return I};if(n.scoreEvent&&(a.combatScoreEvents=[...a.combatScoreEvents||[],{...n.scoreEvent,finalPower:M,traitOutgoingMultiplier:w.outgoing,traitIncomingMultiplier:w.incoming,traitTotalMultiplier:w.total}].slice(-500)),a.enemies=a.enemies.map(C).filter(I=>I.hp>0),a.companions&&(a.companions=a.companions.map(C).filter(I=>I.hp>0)),_.length>0&&(a=o.appendTimelineEvent(a,"DEATH_RESOLVE","Damage",{targetActorId:u,reason:n.reason||"damage"},{...s,targetId:u},!0,260)),_.forEach(I=>{a=o.addCorpseTraitAt(a,I)}),A&&(a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"impact",position:A}}]),u===a.player.id&&(a.player.stealthCounter||0)>0)a.player={...a.player,stealthCounter:Math.max(0,(a.player.stealthCounter||0)-1)};else if(u!==a.player.id){const I=k=>k.id===u?{...k,stealthCounter:Math.max(0,(k.stealthCounter||0)-1)}:k;a.enemies=a.enemies.map(I),a.companions&&(a.companions=a.companions.map(I))}u===a.player.id&&a.player.archetype==="HUNTER"&&n.source&&Bn(n.source,a.player.position)!==-1&&(a.message=it(a.message,"You roll away!","INFO","COMBAT")),v&&v.archetype==="HUNTER"&&n.source&&Bn(n.source,v.position)!==-1&&(a.message=it(a.message,`${v.subtype||v.id} rolls away!`,"INFO","COMBAT"))}else if(f){const v=o.resolveActorAt(a,f),A=n.scoreEvent?.damageClass||"physical",_=o.scaleCombatProfileDamage(a,n.amount,s.sourceId,v,A,n.reason),E=_.amount;p=v?.id,h=f,g=E+Mo(v||void 0),a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"impact",position:f}}],n.scoreEvent&&v&&(a.combatScoreEvents=[...a.combatScoreEvents||[],{...n.scoreEvent,targetId:v.id,finalPower:E,traitOutgoingMultiplier:_.outgoing,traitIncomingMultiplier:_.incoming,traitTotalMultiplier:_.total}].slice(-500)),Q(a.player.position,f)&&(a.player=Vi(a.player,E+Mo(a.player)),b&&(a.hazardBreaches=(a.hazardBreaches||0)+1));const w=I=>{if(Q(I.position,f)){const k=Vi(I,E+Mo(I));return k.hp<=0&&(a.dyingEntities=[...a.dyingEntities||[],I],C.push(I.id),M.push(I.position)),k}return I},M=[],C=[];a.enemies=a.enemies.map(w).filter(I=>I.hp>0),a.companions&&(a.companions=a.companions.map(w).filter(I=>I.hp>0)),C.forEach(I=>{a=o.appendTimelineEvent(a,"DEATH_RESOLVE","Damage",{targetActorId:I,reason:n.reason||"area_damage"},{...s,targetId:I},!0,260)}),M.forEach(I=>{a=o.addCorpseTraitAt(a,I)})}return g>0&&(a=o.appendSimulationEvent(a,{type:"DamageTaken",targetId:p||u||void 0,position:h,payload:{amount:g,reason:n.reason,sourceId:s.sourceId}})),a}},Ie={getNeighbors(e){return Ue(e)},isTileBlocked(e,n){return!e.occupancyMask||e.occupancyMask.length===0?!1:jd(e.occupancyMask,n)},refreshOccupancyMask(e){let n=kv(e.gridWidth,e.gridHeight);return e.tiles?.forEach(s=>{(s.baseId==="WALL"||s.traits?.has("BLOCKS_MOVEMENT"))&&(n=pd(n,s.position))}),e.player&&(n=pd(n,e.player.position)),e.enemies?.forEach(s=>{n=pd(n,s.position)}),n},getMovementRange(e,n,s){const o=new Map,a=[],l=p=>`${p.q},${p.r}`,u=ye(e,n),f=[{p:n,cost:0}];for(o.set(l(n),0);f.length;){const p=f.shift();if(!(p.cost>=s))for(const h of this.getNeighbors(p.p)){if(!this.isWithinBounds(e,h)||!Me.isWalkable(e,h))continue;const g=ye(e,h),b=g&&!Q(h,n),S=b&&u&&g.factionId===u.factionId;if(b&&!S)continue;const T=l(h),v=p.cost+1;(!o.has(T)||o.get(T)>v)&&(o.set(T,v),S||a.push(h),f.push({p:h,cost:v}))}}return a},getAxialTargets(e,n,s,o={}){const{includeWalls:a=!1,includeActors:l=!0,stopAtObstacles:u=!0}=o,f=[];for(let p=0;p<6;p++)for(let h=1;h<=s;h++){const g=Vt(n,Zd(p,h));if(!this.isWithinBounds(e,g))break;const S=Me.getTileAt(e,g)?.baseId==="WALL",T=ye(e,g);if(S){if(a&&f.push(g),u)break}else if(T){if(l&&f.push(g),u)break}else f.push(g)}return f},getAreaTargets(e,n,s){const o=[];for(let a=-s;a<=s;a++)for(let l=Math.max(-s,-a-s);l<=Math.min(s,-a+s);l++){const u=Vt(n,Ft(a,l));this.isWithinBounds(e,u)&&o.push(u)}return o},isWithinBounds(e,n){return Gi(n,e.gridWidth,e.gridHeight)},getAxialTargetsWithOptions(e,n,s,o){return this.getAxialTargets(e,n,s,o)}};class Ts{static hasFireProtection(n){return n.statusEffects.some(s=>s.type==="fire_immunity")||n.activeSkills?.some(s=>s.id==="ABSORB_FIRE")||!1}static isFireHazard(n,s){return n.baseId==="LAVA"||s.has("LAVA")||s.has("FIRE")}static mergeResults(n,s){n.effects.push(...s.effects),n.messages.push(...s.messages),s.newMomentum!==void 0&&(n.newMomentum=s.newMomentum),s.interrupt&&(n.interrupt=!0),s.modifyTile&&(n.modifyTile={...n.modifyTile,...s.modifyTile})}static processEntry(n,s,o){const a={effects:[],messages:[],interrupt:!1},l={tile:s,actor:n,state:o,isFinalDestination:!0,source:n.previousPosition},u=Me.getTraitsForTile(o,s);u.has("HAZARDOUS")&&!n.isFlying&&(this.isFireHazard(s,u)&&this.hasFireProtection(n)||(s.baseId==="LAVA"||u.has("LAVA")?this.mergeResults(a,{effects:[{type:"Damage",target:n.id,amount:99,reason:"lava_sink"},{type:"Juice",effect:"lavaSink",target:n.position}],messages:["Lava Sink! You were engulfed by lava!"],interrupt:!0}):(s.baseId==="VOID"||u.has("VOID"))&&this.mergeResults(a,{effects:[{type:"Damage",target:n.id,amount:99,reason:"void_sink"},{type:"Juice",effect:"lavaSink",target:n.position}],messages:["Void consumes your soul!"],interrupt:!0})));for(const f of s.effects){const p=sl[f.id];if(!p?.onEnter)continue;const h=p.onEnter(l);if(this.mergeResults(a,h),a.interrupt)break}return a.messages.length===0&&a.effects.some(f=>f.type==="LavaSink")&&a.messages.push("Lava Sink! You were engulfed by lava!"),a}static processTransition(n,s,o,a,l={}){const{ignoreActors:u=!1,ignoreGroundHazards:f=!1}=l,p={effects:[],messages:[],newMomentum:a!==void 0?Math.max(0,a-1):void 0,interrupt:!1},h=Me.getTraitsForTile(o,s);if(h.has("BLOCKS_MOVEMENT")||!u&&(o.enemies.find(S=>S.id!==n.id&&S.hp>0&&Q(S.position,s.position))||(n.id!==o.player.id&&Q(o.player.position,s.position)?o.player:void 0)))return p.interrupt=!0,p.newMomentum=0,p;const g={tile:s,actor:n,state:o,momentum:a,isFinalDestination:!1,source:n.previousPosition};h.has("HAZARDOUS")&&!n.isFlying&&!f?this.isFireHazard(s,h)&&this.hasFireProtection(n)?this.mergeResults(p,{effects:[{type:"Damage",target:n.id,amount:99,reason:"hazard_intercept"}],messages:["Flames surge through you."],interrupt:!1}):this.mergeResults(p,{effects:[{type:"Damage",target:n.id,amount:99,reason:"hazard_intercept"},{type:"Juice",effect:"lavaSink",target:s.position}],messages:[s.baseId==="LAVA"||h.has("LAVA")?"Sunk in Lava!":"Consumed by Void!"],interrupt:!0}):h.has("SLIPPERY")?p.newMomentum=Math.max(1,a||0):h.has("LIQUID")&&a!==void 0&&a>0&&(p.newMomentum=Math.max(0,a-1));for(const b of s.effects){const S=sl[b.id];if(!S?.onPass)continue;const T=S.onPass(g);if(this.mergeResults(p,T),p.interrupt)break}if(!p.interrupt&&!n.isFlying&&!f&&o.traps){const b=o.traps.find(S=>Q(S.position,s.position)&&S.cooldown===0&&S.ownerId!==n.id);if(b){const S=s.position.q-b.position.q||1,T=s.position.r-b.position.r||0;let v=0;S>0&&T===0?v=0:S>0&&T<0?v=1:S===0&&T<0?v=2:S<0&&T===0?v=3:S<0&&T>0?v=4:v=5;const A=3;let _=s.position;const w=(M=>[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0},{q:0,r:1,s:-1}][M%6])(v);for(let M=0;M<A;M++){const C={q:_.q+w.q,r:_.r+w.r,s:_.s+w.s};if(!Me.isWalkable(o,C))break;_=C}if(this.mergeResults(p,{effects:[{type:"SetTrapCooldown",position:b.position,ownerId:b.ownerId,cooldown:b.resetCooldown??2},{type:"Displacement",target:n.id,destination:_,source:s.position,isFling:!0},{type:"Juice",effect:"kineticWave",target:s.position,intensity:"high"},{type:"Juice",effect:"combat_text",target:s.position,text:"TRAP!"}],messages:[`${n.subtype||"Unit"} triggered a kinetic trap!`],interrupt:!0}),b.volatileCore&&this.mergeResults(p,{effects:[{type:"Damage",target:n.id,amount:1,reason:"trap_volatile_core"}],messages:["Volatile core detonates!"]}),b.chainReaction&&o.traps){const M=o.traps.filter(C=>C.ownerId===b.ownerId&&C.cooldown===0&&!Q(C.position,b.position)&&Ue(b.position).some(I=>Q(I,C.position)));for(const C of M)this.mergeResults(p,{effects:[{type:"SetTrapCooldown",position:C.position,ownerId:C.ownerId,cooldown:C.resetCooldown??2}],messages:["Chain reaction sparks nearby traps!"]}),C.volatileCore&&this.mergeResults(p,{effects:[{type:"Damage",target:n.id,amount:1,reason:"trap_chain_volatile"}],messages:["Chain blast!"]})}}}return p}static processStay(n,s,o){const a={effects:[],messages:[]},l={tile:s,actor:n,state:o,isFinalDestination:!1},u=Me.getTraitsForTile(o,s);if((s.baseId==="LAVA"||u.has("LAVA"))&&!n.isFlying&&!n.statusEffects.some(f=>f.type==="fire_immunity")){const f=n.id==="player";this.mergeResults(a,{effects:[{type:"Damage",target:n.id,amount:f?1:99,reason:"lava_tick"}],messages:["Lava Sink! You were engulfed by lava!"]})}for(const f of s.effects){const p=sl[f.id];if(!p?.onStay)continue;const h=p.onStay(l);this.mergeResults(a,h)}return a}static applyEffect(n,s,o,a,l,u){const f=sl[s];if(!f)return{effects:[],messages:[]};const p={effects:[],messages:[]};for(const h of n.effects){const g=f.interactsWith?.[h.id];if(g){const b=g({tile:n,state:l,potency:a,sourceId:u});return this.mergeResults(p,b),p}}if(f.onApply){const h=f.onApply({tile:n,state:l,potency:a,sourceId:u});this.mergeResults(p,h)}return p.modifyTile?.effects?p.modifyTile&&(n.effects=p.modifyTile.effects):n.effects.push({id:s,duration:o,potency:a,sourceId:u}),p}static processPath(n,s,o,a,l={}){let u=n.position,f=a,p={effects:[],messages:[],newMomentum:a,interrupt:!1};for(const h of s){const g=Me.getTileAt(o,h),b=Me.getTraitsForTile(o,g),S=this.processTransition(n,g,o,f,l);if(S.interrupt&&b.has("BLOCKS_MOVEMENT")){p.interrupt=!0;break}if(u=h,this.mergeResults(p,S),p.interrupt){p.interrupt=!0;break}if(f=p.newMomentum,f!==void 0&&f<=0)break}return{lastValidPos:u,result:p,interrupt:!!p.interrupt}}static getMovementCost(n,s){const o=Me.getTraitsForTile(n,s);let a=1;return o.has("HAZARDOUS")&&(a+=5),o.has("LIQUID")&&(a+=1),o.has("FIRE")&&(a+=2),a}}const XA={Displacement:(e,n,s,o)=>{let a={...e},l="";if(n.target==="self"?l=s.sourceId||a.player.id:n.target==="targetActor"?l=s.targetId||"":l=n.target,!l)return a;const u=(k,R)=>R===k.player.id?k.player:k.enemies.find($=>$.id===R),f=u(a,l);if(!f)return a;const p=n.source||f.position,h=Math.min(3200,Math.max(0,o.getBlockingTimelineDurationMs(a.timelineEvents)));let g=!1;const b=!(n.simulatePath||n.path||n.isFling);if(p&&(a=o.appendTimelineEvent(a,"MOVE_START","Displacement",{origin:p,destination:n.destination,targetActorId:l},{...s,targetId:l},!0,220)),!p)return a;const S=n.path||Ze(p,n.destination),T=n.simulatePath||n.isFling||!!n.path;let v=n.destination;if(T&&S){const k=u(a,l);if(!k)return a;const R=Ts.processPath(k,S.slice(1),a,S.length-1,{ignoreActors:n.ignoreCollision,ignoreGroundHazards:n.ignoreGroundHazards});v=R.lastValidPos,l===a.player.id?a.player={...a.player,position:v}:a.enemies=a.enemies.map(j=>j.id===l?{...j,position:v}:j),g||(a=o.appendTimelineEvent(a,"MOVE_END","Displacement",{destination:v,targetActorId:l},{...s,targetId:l},!0,260),g=!0),R.result.effects.length>0&&(a=o.appendTimelineEvent(a,"ON_PASS","TilePath",{path:S.slice(1),targetActorId:l},{...s,targetId:l},!1,80),a=o.applyEffects(a,R.result.effects,{targetId:l})),R.result.messages.length>0&&(a.message=zn(a.message,R.result.messages,"INFO","HAZARD"));const $=l===a.player.id||a.enemies.some(j=>j.id===l);if(!R.interrupt&&$){const j=Me.getTileAt(a,v);a=o.appendTimelineEvent(a,"ON_ENTER","TileEnter",{position:v,targetActorId:l,tileBaseId:j?.baseId},{...s,targetId:l},!1,80);const D=u(a,l);if(!D)return a;const q=Ts.processEntry(D,j,a);q.effects.length>0&&(a=o.applyEffects(a,q.effects,{targetId:l})),q.messages.length>0&&(a.message=zn(a.message,q.messages,"INFO","HAZARD"))}if(R.result.newMomentum&&R.result.newMomentum>0){const j=R.lastValidPos,D=S.length>1?S[S.length-2]:p,q=Bn(D,j);if(q!==-1){const se=wt(q);let ee=j,oe=5;for(;oe>0;){const F=Vt(ee,se);if(!Me.isWalkable(a,F)||(l===a.player.id?a.enemies.find(Z=>Z.hp>0&&Q(Z.position,F)):Q(a.player.position,F)?a.player:a.enemies.find(Z=>Z.id!==l&&Z.hp>0&&Q(Z.position,F))))break;const z=Me.getTileAt(a,F);if(z){const Z=Ts.processTransition(f,z,a,1);if(ee=F,Z.effects.length>0&&(a=o.applyEffects(a,Z.effects,{targetId:l})),Z.messages.length>0&&(a.message=zn(a.message,Z.messages,"INFO","HAZARD")),Z.newMomentum===0||Z.interrupt)break}else{ee=F;break}oe--}v=ee}}}const A=[...a.visualEvents||[]],_=!!(n.ignoreCollision||n.isFling),E=_?A.reduce((k,R)=>{if(R.type!=="kinetic_trace")return k;const $=R.payload;return $&&($.movementType??"slide")==="slide"?k+1:k},0):0,w=b?0:_?Math.min(640,E*90):0,M=Math.max(h,w),C={actorId:l,origin:p,path:n.path||(b?[p,v]:Ze(p,v)),destination:v,movementType:b?"teleport":"slide",durationMs:n.animationDuration??(b?180:Math.max(120,(n.path?.length||Ze(p,v).length)*110)),startDelayMs:M,wasLethal:a.tiles.get(ce(v))?.traits.has("HAZARDOUS")||!1},I=A;if(b)I.push({type:"kinetic_trace",payload:C});else{let k=!1;for(let R=I.length-1;R>=0;R--){const $=I[R];if($.type!=="kinetic_trace")continue;const j=$.payload;if(!(!j||j.actorId!==l)){if((j.movementType??"slide")==="slide"&&Q(j.destination,C.origin)){const D=j.path&&j.path.length>0?j.path:[j.origin,j.destination],q=C.path&&C.path.length>0?C.path:[C.origin,C.destination],se=[...D,...q.slice(1)];I[R]={type:"kinetic_trace",payload:{...C,origin:j.origin,path:se,durationMs:(j.durationMs||0)+(C.durationMs||0),startDelayMs:Math.min(j.startDelayMs??M,M),movementType:"slide",wasLethal:!!(j.wasLethal||C.wasLethal)}},k=!0}break}}k||I.push({type:"kinetic_trace",payload:C})}if(a.visualEvents=I,l===a.player.id)a.player={...a.player,position:v,previousPosition:b?v:a.player.position};else{const k=R=>R.id===l?{...R,position:v,previousPosition:b?v:R.position}:R;a.enemies=a.enemies.map(k),a.companions&&(a.companions=a.companions.map(k))}return a.occupancyMask=Ie.refreshOccupancyMask(a),g||(a=o.appendTimelineEvent(a,"MOVE_END","Displacement",{destination:v,targetActorId:l},{...s,targetId:l},!0,260)),a=o.appendSimulationEvent(a,{type:"UnitMoved",actorId:l,position:v,payload:{origin:p,destination:v,movementType:C.movementType}}),a}},rl=Math.sqrt(3),Cy=(e,n)=>{if(n)return e.player.id===n?e.player:e.enemies.find(s=>s.id===n)||e.companions?.find(s=>s.id===n)},Oy=e=>{if(e)return{actorId:e.id,hex:e.position}},a0=(e,n,s=X)=>{if(!e||!n||fe(e,n)!==1)return;const o=Bn(e,n);if(o<0)return;const a=Ae(e,s),u=[{x:s,y:0},{x:s/2,y:-(rl*s)/2},{x:-s/2,y:-(rl*s)/2},{x:-s,y:0},{x:-s/2,y:rl*s/2},{x:s/2,y:rl*s/2}][o];return u?{x:a.x+u.x,y:a.y+u.y}:void 0},vd=(e,n,s)=>{if(s)switch(s.kind){case"source_actor":return Oy(Cy(e,n.sourceId));case"target_actor":return Oy(Cy(e,n.targetId));case"source_hex":return n.sourceHex?{hex:n.sourceHex}:void 0;case"target_hex":return n.targetHex?{hex:n.targetHex}:void 0;case"contact_hex":return n.contactHex?{hex:n.contactHex}:void 0;case"contact_world":return!n.contactWorld&&!n.contactHex?void 0:{world:n.contactWorld,hex:n.contactHex};case"custom_hex":return{hex:s.hex};case"custom_world":return{world:s.world};default:return}},o0=(e,n)=>{const s=e.turnNumber||0,o=e.stackTrace?.length||0,a=n.sourceId||"env",l=n.skillId||"none",u=n.phase||"instant",f=n.salt?`.${n.salt}`:"";return`t${s}.k${o}.${a}.${l}.${u}${f}`},JA=e=>{const n=String(e).toLowerCase();return n.includes("fire")||n.includes("lava")||n.includes("explosion")?"fire":n.includes("kinetic")||n.includes("momentum")||n.includes("wallcrack")?"kinetic":n.includes("void")?"void":n.includes("arcane")?"arcane":n.includes("hidden")||n.includes("shadow")?"shadow":"neutral"},QA=(e,n={})=>{const s=JA(e),o={signature:`UI.SPAWN.${s.toUpperCase()}.${String(e).toUpperCase()}`,family:"ui",primitive:"spawn",phase:"instant",element:s,variant:e,intensity:"medium"};switch(e){case"impact":return{...o,signature:"ATK.STRIKE.PHYSICAL.IMPACT",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"impact",targetRef:{kind:"target_hex"},contactRef:{kind:"contact_world"}};case"flash":return{...o,signature:`ATK.BLAST.${n.color?"ARCANE":"NEUTRAL"}.FLASH`,family:"attack",primitive:"blast",phase:"impact",element:n.color?"arcane":"neutral",variant:"flash",targetRef:{kind:"target_hex"}};case"spearTrail":return{...o,signature:"ATK.SHOOT.PHYSICAL.SPEAR_TRAIL",family:"attack",primitive:"shoot",phase:"travel",element:"physical",variant:"spear",sourceRef:{kind:"source_hex"},targetRef:{kind:"target_hex"}};case"explosion_ring":return{...o,signature:"ATK.BLAST.FIRE.EXPLOSION_RING",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"explosion_ring",targetRef:{kind:"target_hex"},intensity:"high"};case"lavaRipple":return{...o,signature:"ENV.HAZARD.FIRE.LAVA_RIPPLE",family:"environment",primitive:"hazard_burst",phase:"impact",element:"fire",variant:"lava_ripple",targetRef:{kind:"target_hex"}};case"lavaSink":return{...o,signature:"ENV.HAZARD.FIRE.SINK",family:"environment",primitive:"hazard_burst",phase:"impact",element:"fire",variant:"lava_sink",targetRef:{kind:"target_hex"},intensity:"high"};case"wallCrack":return{...o,signature:"ENV.COLLISION.KINETIC.WALL_CRACK",family:"environment",primitive:"collision",phase:"impact",element:"kinetic",variant:"wall_crack",contactRef:{kind:"contact_world"},targetRef:{kind:"target_hex"},intensity:"high"};case"kineticWave":return{...o,signature:"ATK.PULSE.KINETIC.WAVE",family:"attack",primitive:"pulse",phase:"impact",element:"kinetic",variant:"kinetic_wave",targetRef:{kind:"target_hex"}};case"dashBlur":return{...o,signature:"MOVE.DASH.NEUTRAL.BLUR",family:"movement",primitive:"dash",phase:"travel",element:"neutral",variant:"dash_blur",sourceRef:{kind:"source_hex"},targetRef:{kind:"target_hex"}};case"hiddenFade":return{...o,signature:"STATE.FADE.SHADOW.HIDDEN",family:"status",primitive:"state_fade",phase:"instant",element:"shadow",variant:"hidden_fade",targetRef:{kind:"target_hex"}};case"combat_text":return{...o,signature:"UI.TEXT.NEUTRAL.POPUP",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"combat_text",targetRef:{kind:"target_hex"}};case"shake":return{...o,signature:"UI.SHAKE.NEUTRAL.CAMERA",family:"ui",primitive:"shake",phase:"instant",element:"neutral",variant:"camera_shake"};case"freeze":return{...o,signature:"UI.FREEZE.NEUTRAL.HITSTOP",family:"ui",primitive:"freeze",phase:"instant",element:"neutral",variant:"freeze"};case"stunBurst":return{...o,signature:"STATE.APPLY.NEUTRAL.STUN_BURST",family:"status",primitive:"status_apply",phase:"impact",element:"neutral",variant:"stun_burst",targetRef:{kind:"target_hex"}};default:return{...o,signature:`UI.SPAWN.${s.toUpperCase()}.${String(e).toUpperCase()}`,variant:String(e).toLowerCase()}}},ZA=(e,n)=>{const s=n.template,o=n.phase||s.phase||"instant",a=n.sequenceId||o0(e,{sourceId:n.sourceId,skillId:n.skillId,phase:o}),l=vd(e,n,s.sourceRef),u=vd(e,n,s.targetRef),f=vd(e,n,s.contactRef),p={protocol:"juice-signature/v1",signature:n.signature||s.signature,family:s.family,primitive:s.primitive,phase:o,element:n.element||s.element,variant:n.variant||s.variant,intensity:n.intensity||s.intensity,source:l,target:u,contact:f,area:n.area||s.area,direction:n.direction||s.direction,path:n.path||s.path,text:n.text||s.text,camera:n.camera||s.camera,timing:n.timing||s.timing,flags:{...s.flags||{},...n.flags||{}},meta:{turnNumber:e.turnNumber||0,stackTick:e.stackTrace?.length||0,sequenceId:a,sourceId:n.sourceId,targetId:n.targetId,skillId:n.skillId,reason:n.reason,...n.meta||{}}};return p.flags&&Object.keys(p.flags).length===0&&delete p.flags,p.meta&&Object.keys(p.meta).length===0&&delete p.meta,{type:"juice_signature",payload:p}},r0=(e,n)=>{const s=ZA(e,n);return{...e,visualEvents:[...e.visualEvents||[],s]}},eT={Impact:(e,n,s,o)=>{let a={...e};const l=n.target,u=l===a.player.id?a.player:a.enemies.find(g=>g.id===l);if(!u)return a;const f=n.direction,p=f?{q:u.position.q+f.q,r:u.position.r+f.r,s:u.position.s+f.s}:void 0,h=p?a0(u.position,p):void 0;if(a=r0(a,{template:{signature:f?"ENV.COLLISION.KINETIC.IMPACT":"ATK.STRIKE.PHYSICAL.IMPACT",family:f?"environment":"attack",primitive:f?"collision":"strike",phase:"impact",element:f?"kinetic":"physical",variant:"impact",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},contactRef:{kind:"contact_world"}},sourceId:s.sourceId,targetId:l,sourceHex:o.resolveActorById(a,s.sourceId)?.position,targetHex:u.position,contactHex:p,contactWorld:h,direction:n.direction,intensity:n.damage>1?"high":"medium",flags:{blocked:!!f},meta:{legacyJuiceId:"impact",legacyMirrored:!0,reason:"impact"}}),n.damage>0)if(l===a.player.id)a.player=Vi(a.player,n.damage);else{const g=b=>b.id===l?Vi(b,n.damage):b;a.enemies=a.enemies.map(g).filter(b=>b.hp>0),a.companions&&(a.companions=a.companions.map(g).filter(b=>b.hp>0))}return a}},tT={PickupShield:(e,n)=>{let s={...e};const o=n.position||s.shieldPosition;if(o&&s.shieldPosition&&Q(s.shieldPosition,o)){s.hasShield=!0,s.shieldPosition=void 0;const a={id:"BULWARK_CHARGE",name:"Bulwark Charge",description:"Shield Bash.",slot:"utility",cooldown:3,currentCooldown:0,range:1,upgrades:[],activeUpgrades:[]};s.player.activeSkills.some(l=>l.id==="BULWARK_CHARGE")||(s.player={...s.player,activeSkills:[...s.player.activeSkills,a]})}return s},PickupSpear:(e,n)=>{let s={...e};const o=n.position||s.spearPosition;return o&&s.spearPosition&&Q(s.spearPosition,o)&&(s.hasSpear=!0,s.spearPosition=void 0),s},SpawnItem:(e,n,s)=>{let o={...e};if(n.itemType==="spear")return o.spearPosition=n.position,s.sourceId===o.player.id&&(o.hasSpear=!1),o;if(n.itemType==="bomb"){const a=o.initialSeed??o.rngSeed??"0",l=(o.turnNumber<<16)+(o.actionLog?.length??0)+o.enemies.length,u=`bomb-${Aa(a,l,8,"bomb")}`,f=Wi({id:u,type:"enemy",subtype:"bomb",factionId:"enemy",position:n.position,speed:10,skills:["TIME_BOMB"],weightClass:"Standard"});return f.statusEffects=[{id:"TIME_BOMB",type:"time_bomb",duration:2,tickWindow:"END_OF_TURN"}],o.enemies=[...o.enemies,f],o}return n.itemType==="shield"&&(o.shieldPosition=n.position,o.hasShield=!1),o},LavaSink:(e,n,s,o)=>{let a={...e};a=o.appendTimelineEvent(a,"HAZARD_CHECK","LavaSink",{target:n.target},s,!0,240);const l=n.target,u=l===a.player.id?a.player:a.enemies.find(f=>f.id===l);return u&&(a=o.appendTimelineEvent(a,"DEATH_RESOLVE","LavaSink",{targetId:l},{...s,targetId:l},!0,280),l===a.player.id?a.player=Vi(a.player,99):(a.enemies=a.enemies.filter(f=>f.id!==l),a.dyingEntities=[...a.dyingEntities||[],u],a=o.addCorpseTraitAt(a,u.position)),a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"vaporize",position:u.position}}]),a}},nT={Juice:(e,n,s,o)=>{let a={...e};const l=n.metadata||{},u=typeof l.phase=="string"?l.phase:void 0,p={...QA(n.effect,{color:n.color,text:n.text}),...typeof l.signature=="string"?{signature:l.signature}:{},...typeof l.family=="string"?{family:l.family}:{},...typeof l.primitive=="string"?{primitive:l.primitive}:{},...typeof l.element=="string"?{element:l.element}:{},...typeof l.variant=="string"?{variant:l.variant}:{},...typeof l.sourceRef=="object"&&l.sourceRef?{sourceRef:l.sourceRef}:{},...typeof l.targetRef=="object"&&l.targetRef?{targetRef:l.targetRef}:{},...typeof l.contactRef=="object"&&l.contactRef?{contactRef:l.contactRef}:{}},h=o.resolveActorById(a,s.sourceId);let g,b;typeof n.target=="string"?(g=n.target==="targetActor"?s.targetId||void 0:n.target,b=o.resolveActorById(a,g)?.position):n.target?(b=n.target,g=o.resolveActorAt(a,n.target)?.id):s.targetId&&(g=s.targetId,b=o.resolveActorById(a,s.targetId)?.position);const S=l.contactHex&&typeof l.contactHex.q=="number"?l.contactHex:void 0;let T=l.contactWorld&&typeof l.contactWorld.x=="number"?l.contactWorld:void 0;if(!T){const v=l.contactFromHex&&typeof l.contactFromHex.q=="number"?l.contactFromHex:void 0,A=l.contactToHex&&typeof l.contactToHex.q=="number"?l.contactToHex:void 0;T=a0(v,A)}if(a=r0(a,{template:p,sourceId:s.sourceId,targetId:g,skillId:typeof l.skillId=="string"?l.skillId:void 0,reason:typeof l.reason=="string"?l.reason:void 0,sourceHex:h?.position,targetHex:b,contactHex:S,contactWorld:T,path:n.path,direction:n.direction,phase:u,sequenceId:typeof l.sequenceId=="string"?l.sequenceId:o0(a,{sourceId:s.sourceId,skillId:typeof l.skillId=="string"?l.skillId:void 0,phase:u||p.phase,salt:n.effect}),intensity:n.intensity,text:n.text?{value:n.text,tone:typeof l.textTone=="string"?l.textTone:"system",color:n.color}:void 0,timing:typeof l.timing=="object"&&l.timing?l.timing:n.duration?{durationMs:n.duration,ttlMs:n.duration}:void 0,camera:typeof l.camera=="object"&&l.camera?l.camera:n.effect==="shake"?{shake:n.intensity||"medium"}:n.effect==="freeze"?{freezeMs:Math.max(0,Number(n.duration||80))}:void 0,area:typeof l.area=="object"&&l.area?l.area:void 0,flags:typeof l.flags=="object"&&l.flags?l.flags:void 0,meta:{legacyJuiceId:n.effect,legacyMirrored:o.legacyMirroredJuiceIds.has(n.effect),...typeof l.statusId=="string"?{statusId:l.statusId}:{}}}),n.effect==="combat_text"&&n.text&&(a.message=it(a.message,n.text,"VERBOSE","SYSTEM")),n.effect==="shake"&&(a.visualEvents=[...a.visualEvents||[],{type:"shake",payload:{intensity:n.intensity||"medium",direction:n.direction}}]),n.effect==="freeze"&&(a.visualEvents=[...a.visualEvents||[],{type:"freeze",payload:{durationMs:Math.max(0,Number(n.duration||80))}}]),n.effect==="impact"&&n.target){const v=typeof n.target=="string"?n.target===a.player.id?a.player.position:a.enemies.find(A=>A.id===n.target)?.position:n.target;v&&(a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"impact",position:v}}])}if(n.effect==="flash"&&n.target){const v=typeof n.target=="string"?n.target===a.player.id?a.player.position:a.enemies.find(A=>A.id===n.target)?.position:n.target;v&&(a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"flash",position:v}}])}if(n.effect==="spearTrail"&&n.path&&(a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"spear_trail",path:n.path}}]),n.effect==="lavaSink"&&n.target){const v=typeof n.target=="string"?n.target===a.player.id?a.player.position:a.enemies.find(A=>A.id===n.target)?.position:n.target;if(v){const A=a.enemies.find(_=>Q(_.position,v));A&&(a.dyingEntities=[...a.dyingEntities||[],A],a.enemies=a.enemies.filter(_=>!Q(_.position,v)),a.companions&&(a.companions=a.companions.filter(_=>!Q(_.position,v))),a=o.addCorpseTraitAt(a,v),a.visualEvents=[...a.visualEvents||[],{type:"vfx",payload:{type:"vaporize",position:v}}])}}return a}},iT={Message:(e,n,s,o)=>{let a=e;return a.message=[...a.message,sf(n.text,"INFO","SYSTEM")].slice(-50),a=o.appendSimulationEvent(a,{type:"MessageLogged",payload:{text:n.text}}),a},GameOver:e=>({...e,gameStatus:"lost"})},sT={Heal:(e,n,s,o)=>{let a={...e};const l=h=>({...h,hp:Math.min(h.maxHp,h.hp+n.amount)}),u=n.target==="targetActor"?s.targetId:n.target;let f,p;if(u){const h=u===a.player.id?a.player:a.enemies.find(g=>g.id===u)||a.companions?.find(g=>g.id===u);if(h){const g=u===a.player.id?"You":h.subtype||h.id;if(a.message=it(a.message,`${g} recover ${n.amount} HP.`,"INFO","COMBAT"),u===a.player.id)a.player=l(a.player),f=a.player.id,p=a.player.position;else{const b=S=>S.id===u?l(S):S;a.enemies=a.enemies.map(b),a.companions&&(a.companions=a.companions.map(b)),f=h.id,p=h.position}}}return f&&(a=o.appendSimulationEvent(a,{type:"Healed",targetId:f,position:p,payload:{amount:n.amount,sourceId:s.sourceId}})),a},ApplyStatus:(e,n,s,o)=>{let a={...e};a=o.appendTimelineEvent(a,"STATUS_APPLY","ApplyStatus",{status:n.status,duration:n.duration,target:n.target},s,!0,160);let l="",u=null;typeof n.target=="string"?n.target==="targetActor"?l=s.targetId||"":l=n.target:u=n.target;let f=u;const p=s.sourceId?o.resolveActorById(a,s.sourceId):void 0,h=p?xx(n.duration,Oe(p)):n.duration;if(l){const b=l===a.player.id?a.player:a.enemies.find(S=>S.id===l)||a.companions?.find(S=>S.id===l);if(b){f=b.position;const S=l===a.player.id?"You":`${b.subtype||"enemy"}#${b.id}`,T=l===a.player.id?"are":"is";if(a.message=it(a.message,`${S} ${T} ${n.status}!`,"INFO","COMBAT"),l===a.player.id)a.player=Ud(a.player,n.status,h);else{const v=A=>A.id===l?Ud(A,n.status,h):A;a.enemies=a.enemies.map(v),a.companions&&(a.companions=a.companions.map(v))}}}n.status==="stunned"&&f&&(a.visualEvents=[...a.visualEvents||[],{type:"shake",payload:{intensity:"low"}},{type:"vfx",payload:{type:"stunBurst",position:f}},{type:"combat_text",payload:{text:"STUNNED",position:f}}]);const g=l||(f?o.resolveActorAt(a,f)?.id:void 0);return a=o.appendSimulationEvent(a,{type:"StatusApplied",targetId:g,position:f||void 0,payload:{status:n.status,duration:h,sourceId:s.sourceId}}),a}},Ny={player:100,footman:50,archer:60,shieldBearer:40,bomber:30,warlock:55,bomb:10},$d=e=>{let n=e.speed;if(n===void 0){const o=e.subtype;n=e.type==="player"?Ny.player:Ny[o]??50}return e.statusEffects?.some(o=>o.type==="stunned")&&(n-=100),n+=Ax(Oe(e)),n},Ms=e=>{const n=[];n.push({actorId:e.player.id,initiative:$d(e.player),hasActed:!1,turnStartPosition:void 0});for(const s of e.enemies)n.push({actorId:s.id,initiative:$d(s),hasActed:!1,turnStartPosition:void 0});return n.sort((s,o)=>o.initiative!==s.initiative?o.initiative-s.initiative:s.actorId==="player"?-1:o.actorId==="player"?1:s.actorId.localeCompare(o.actorId)),{entries:n,currentIndex:-1,round:1}},aT=e=>e.currentIndex<0||e.currentIndex>=e.entries.length?null:e.entries[e.currentIndex],oT=e=>{let n=e.initiativeQueue;n||(n=Ms(e));let s=n.currentIndex+1;for(;s<n.entries.length&&n.entries[s].hasActed;)s++;return s>=n.entries.length?(n=Ms(e),n.round=(e.initiativeQueue?.round??0)+1,s=0,{queue:{...n,currentIndex:s},actorId:n.entries[s]?.actorId??null,newRound:!0}):{queue:{...n,currentIndex:s},actorId:n.entries[s]?.actorId??null,newRound:!1}},rT=(e,n)=>{const s=e.initiativeQueue;if(!s)return Ms(e);const o=s.entries.map(a=>{if(a.actorId===n.id){if(a.turnStartPosition)return a;const u=Ue(n.position).map(f=>ye(e,f)?.id).filter(Boolean);return{...a,turnStartPosition:{...n.position},turnStartNeighborIds:u}}return a});return{...s,entries:o}},lT=(e,n)=>{const s=e.initiativeQueue;if(!s)return Ms(e);const o=s.entries.map(a=>a.actorId===n?{...a,hasActed:!0}:a);return{...s,entries:o}},cT=(e,n)=>{const s=e.initiativeQueue;return s?s.entries.find(a=>a.actorId===n)?.turnStartPosition??null:null},uT=(e,n)=>{const s=e.initiativeQueue;return s?s.entries.find(a=>a.actorId===n)?.turnStartNeighborIds??null:null},Do=e=>{const n=e.initiativeQueue;if(!n)return!0;if(n.currentIndex<0||n.currentIndex>=n.entries.length)return!1;const s=n.entries[n.currentIndex];return s.actorId===e.player.id&&!s.hasActed},xd=(e,n)=>{const s=e.entries.filter(l=>l.actorId!==n);let o=e.currentIndex;const a=e.entries.findIndex(l=>l.actorId===n);return a>=0&&a<=e.currentIndex&&o--,{...e,entries:s,currentIndex:Math.min(o,s.length-1)}},dT=(e,n)=>{const s={actorId:n.id,initiative:$d(n),hasActed:!0,turnStartPosition:void 0};return{...e,entries:[...e.entries,s]}},fT={UpdateComponent:(e,n,s)=>{let o={...e};const a=(l,u,f)=>{const p=new Map(l.components||[]);return p.set(u,f),{...l,components:p}};if(n.target==="self")return o.player=a(o.player,n.key,n.value),o;if(n.target==="targetActor"&&s.targetId){if(s.targetId===o.player.id)return o.player=a(o.player,n.key,n.value),o;const l=u=>u.id===s.targetId?a(u,n.key,n.value):u;o.enemies=o.enemies.map(l),o.companions&&(o.companions=o.companions.map(l))}return o},SpawnActor:(e,n)=>{let s={...e};const o=Lo(n.actor);return s.enemies=[...s.enemies,o],o.companionOf&&(s.companions=[...s.companions||[],o]),s.initiativeQueue&&(s.initiativeQueue=dT(s.initiativeQueue,o)),s},PlaceFire:(e,n,s)=>{let o={...e,tiles:new Map(e.tiles)};const a=ce(n.position);let l=o.tiles.get(a);l?l={...l,traits:new Set(l.traits),effects:[...l.effects]}:l={baseId:"STONE",position:n.position,traits:new Set(xa.STONE.defaultTraits),effects:[]},o.tiles.set(a,l);const u=Ts.applyEffect(l,"FIRE",n.duration,1,o,s.sourceId);return u.messages.length>0&&(o.message=zn(o.message,u.messages,"INFO","HAZARD")),o}},mT={PlaceTrap:(e,n)=>{const s=e.traps||[];return{...e,traps:[...s,{position:n.position,ownerId:n.ownerId,isRevealed:!1,cooldown:0,volatileCore:n.volatileCore,chainReaction:n.chainReaction,resetCooldown:n.resetCooldown}]}},RemoveTrap:(e,n)=>e.traps?{...e,traps:n.ownerId?e.traps.filter(s=>s.ownerId!==n.ownerId):e.traps.filter(s=>!Q(s.position,n.position))}:e,SetTrapCooldown:(e,n)=>e.traps?{...e,traps:e.traps.map(s=>n.ownerId&&s.ownerId!==n.ownerId||!Q(s.position,n.position)?s:{...s,cooldown:Math.max(0,n.cooldown)})}:e},pT={...iT,...zA,...GA,...XA,...tT,...mT,...qA,...sT,...eT,...nT,...fT},hT=(e,n,s,o)=>{const a=pT[n.type];return typeof a!="function"?null:a(e,n,s,o)};var ky={};const yT=(e,n)=>{const s=ce(n);let o=e;o.tiles===e.tiles&&(o={...o,tiles:new Map(o.tiles)});let a=o.tiles.get(s);return a?a={...a,traits:new Set(a.traits),effects:[...a.effects]}:a={baseId:"STONE",position:n,traits:new Set(xa.STONE.defaultTraits),effects:[]},a.traits.add("CORPSE"),o.tiles.set(s,a),o},gT=(e,n)=>{const s=ce(n),o=e.tiles.get(s);if(!o||!o.traits.has("CORPSE"))return e;let a=e;a.tiles===e.tiles&&(a={...a,tiles:new Map(a.tiles)});const l={...o,traits:new Set(o.traits),effects:[...o.effects]};return l.traits.delete("CORPSE"),a.tiles.set(s,l),a},bT=typeof process<"u"&&(ky?.HOP_ENGINE_WARN==="1"||ky?.HOP_ENGINE_DEBUG==="1"),Ry={INTENT_START:1,MOVE_START:2,MOVE_END:3,ON_PASS:4,ON_ENTER:5,HAZARD_CHECK:6,STATUS_APPLY:7,DAMAGE_APPLY:8,DEATH_RESOLVE:9,INTENT_END:10},ST=e=>{const n=e||[];let s=0;for(const o of n)o.blocking&&(s+=Number(o.suggestedDurationMs||0));return s},vT=(e,n,s,o,a,l,u)=>{const f=e.timelineEvents||[],p=f.length,h=e.turnNumber||0,g=a.sourceId||a.targetId,b=a.stepId||`${h}:${g||"system"}`,S=a.stepId||b,T=S?[...f].reverse().find(A=>(A.stepId||A.groupId)===S):void 0;if(T){const A=Ry[T.phase]||0,_=Ry[n]||0;A>_&&bT&&console.warn("[TURN_STACK] Non-monotonic timeline phase order detected.",{stepId:S,previous:T.phase,next:n})}const v=`${S}:${p}:${n}`;return{...e,timelineEvents:[...f,{id:v,turn:h,actorId:g,stepId:S,phase:n,type:s,payload:o,blocking:l,groupId:b,suggestedDurationMs:u}]}},xT=(e,n)=>{const s=e.simulationEvents||[],o=`sim:${e.turnNumber||0}:${s.length}:${n.type}`;return{...e,simulationEvents:[...s,{...n,id:o,turn:e.turnNumber||0}]}},l0=(e,n)=>{if(n)return e.player.id===n?e.player:e.enemies.find(s=>s.id===n)||e.companions?.find(s=>s.id===n)},AT=(e,n)=>{if(n)return Q(e.player.position,n)?e.player:e.enemies.find(s=>Q(s.position,n))||e.companions?.find(s=>Q(s.position,n))},TT=new Set(["lava_sink","void_sink","hazard_intercept","lava_tick","fire_damage","burning","oil_explosion"]),ET=new Set(["impact","flash","spearTrail","shake"]),_T=(e,n,s,o,a,l)=>{if(!o)return{amount:n,outgoing:1,incoming:1,total:1};if(l&&TT.has(l))return{amount:n,outgoing:1,incoming:1,total:1};const u=l0(e,s);if(!u)return{amount:n,outgoing:1,incoming:1,total:1};const f=zv(u,a),p=Vv(o,a),h=f*p;return{amount:Math.max(0,Math.floor(n*h)),outgoing:f,incoming:p,total:h}},qd=(e,n,s={})=>{const o={...e},a=hT(o,n,s,{applyAtomicEffect:qd,applyEffects:Hn,addCorpseTraitAt:yT,removeCorpseTraitAt:gT,scaleCombatProfileDamage:_T,appendSimulationEvent:xT,appendTimelineEvent:vT,getBlockingTimelineDurationMs:ST,legacyMirroredJuiceIds:ET,resolveActorAt:AT,resolveActorById:l0});return a||o},Hn=(e,n,s={})=>{const o=e.stackTrace?.length||0,a=wy(e,n,{apply:(p,h)=>qd(p,h,s),describe:p=>p.type,preserveInputOrder:!0,startTick:o+1});let l=a.state,u=[...e.stackTrace||[],...a.trace];const f=UA(l);if(f.length>0){const p=wy(l,f,{apply:(h,g)=>qd(h,g,{}),describe:h=>h.type,preserveInputOrder:!0,startTick:u.length+1});l=p.state,u=[...u,...p.trace]}return{...l,stackTrace:u}};function Ji(e){return e.statusEffects?.some(n=>n.type==="stunned")??!1}function wT(e){return e.statusEffects?.some(n=>n.type==="rooted")??!1}function Iy(e,n=1){if(!e.statusEffects||e.statusEffects.length===0)return e;const s=e.statusEffects.map(o=>({...o,duration:o.duration-n})).filter(o=>o.duration>0);return{...e,statusEffects:s}}const c0={id:"AUTO_ATTACK",name:"Auto Attack",description:"Automatically strike adjacent enemies that started the turn adjacent to you.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0,damage:1},execute:(e,n,s,o=[],a)=>{const l=[],u=[];let f=0;const p=(e.timelineEvents||[]).some(A=>A.phase==="STATUS_APPLY"&&A.type==="ApplyStatus"&&A.payload?.status==="stunned"&&(A.payload?.target===n.id||typeof A.payload?.target=="object"&&A.payload?.target&&Q(A.payload.target,n.position)));if(Ji(n)||p)return{effects:l,messages:u,kills:0};const h=Ue(n.position);let g=1;o.includes("HEAVY_HANDS")&&(g+=1);let b=0;const S=(A,_,E)=>{const w=Bn(n.position,_),M=w>=0?wt(w):void 0,C=Math.max(0,E-(A.temporaryArmor||0)),I=A.hp-C<=0,k=I?"extreme":E>=4?"high":E>=2?"medium":"low",R=b*80;b+=1,l.push({type:"Juice",effect:"lightImpact",target:A.id,intensity:"low",metadata:{signature:"ATK.STRIKE.PHYSICAL.AUTO_ATTACK",family:"attack",primitive:"strike",phase:"anticipation",element:"physical",variant:"auto_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"AUTO_ATTACK",timing:{delayMs:R,durationMs:70,ttlMs:90}}}),l.push({type:"Juice",effect:"dashBlur",target:A.id,path:[n.position,_],intensity:k==="extreme"?"high":"medium",metadata:{signature:"ATK.STRIKE.PHYSICAL.AUTO_ATTACK",family:"attack",primitive:"strike",phase:"travel",element:"physical",variant:"auto_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"AUTO_ATTACK",timing:{delayMs:R+70,durationMs:50,ttlMs:80}}}),l.push({type:"Juice",effect:"heavyImpact",target:A.id,intensity:k,direction:M,metadata:{signature:"ATK.STRIKE.PHYSICAL.AUTO_ATTACK",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"auto_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},...M?{contactRef:{kind:"contact_world"},contactHex:_,contactToHex:_,contactFromHex:n.position}:{},skillId:"AUTO_ATTACK",camera:{kick:k==="extreme"?"medium":"light",freezeMs:k==="extreme"?50:35},timing:{delayMs:R+120,durationMs:60,ttlMs:120},flags:{lethal:I}}}),l.push({type:"Juice",effect:"lightImpact",target:A.id,intensity:"low",metadata:{signature:"ATK.STRIKE.PHYSICAL.AUTO_ATTACK",family:"attack",primitive:"strike",phase:"aftermath",element:"physical",variant:"auto_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"AUTO_ATTACK",timing:{delayMs:R+180,durationMs:80,ttlMs:110}}})},T=a?.persistentTargetIds||[],v=a?.previousNeighbors||[];if(T.length===0&&v.length===0)return{effects:l,messages:u,kills:0};for(const A of h){const _=ye(e,A);if(!_||_.hp<=0||_.id===n.id||n.factionId===_.factionId)continue;if(T.length>0?T.includes(_.id):v.some(w=>Q(w,A))){const w=_t({attackerId:n.id,targetId:_.id,skillId:"AUTO_ATTACK",basePower:g,trinity:Oe(n),targetTrinity:Oe(_),damageClass:"physical",scaling:[{attribute:"body",coefficient:.4}],statusMultipliers:[]});S(_,A,w.finalPower),l.push({type:"Damage",target:A,amount:w.finalPower,reason:"auto_attack",scoreEvent:w.scoreEvent});const M=n.factionId==="player"?"You":`${n.subtype||"enemy"}#${n.id}`,C=_.factionId==="player"?"you":`${_.subtype||"enemy"}#${_.id}`;u.push(`${M} attacked ${C}!`),_.hp<=g&&f++}}if(o.includes("CLEAVE")&&l.length>0)for(const A of h){if(l.some(k=>k.type==="Damage"&&typeof k.target=="object"&&"q"in k.target&&Q(k.target,A)))continue;const E=ye(e,A);if(!E||E.id===n.id||!(n.factionId!==E.factionId))continue;const M=_t({attackerId:n.id,targetId:E.id,skillId:"AUTO_ATTACK",basePower:g,trinity:Oe(n),targetTrinity:Oe(E),damageClass:"physical",scaling:[{attribute:"body",coefficient:.4}],statusMultipliers:[]});S(E,A,M.finalPower),l.push({type:"Damage",target:A,amount:M.finalPower,reason:"auto_attack",scoreEvent:M.scoreEvent});const C=n.factionId==="player"?"You":`${n.subtype||"enemy"}#${n.id}`,I=E.factionId==="player"?"you":`${E.subtype||"enemy"}#${E.id}`;u.push(`${C} cleaved ${I}!`),E.hp<=g&&f++}return{effects:l,messages:u,kills:f}},upgrades:{HEAVY_HANDS:{id:"HEAVY_HANDS",name:"Heavy Hands",description:"Auto-attack damage +1"},CLEAVE:{id:"CLEAVE",name:"Cleave",description:"When auto-attack triggers, hit ALL adjacent enemies"}},scenarios:Ye("AUTO_ATTACK")},MT=(e,n,s,o,a,l)=>{if(!n.activeSkills?.some(S=>S.id==="AUTO_ATTACK"))return{state:e,kills:0,messages:[]};const p=n.activeSkills?.find(S=>S.id==="AUTO_ATTACK")?.activeUpgrades||[],h=new Map;if(e.initiativeQueue)for(const S of e.initiativeQueue.entries)S.turnStartPosition&&h.set(S.actorId,S.turnStartPosition);const g=c0.execute(e,n,void 0,p,{previousNeighbors:s,attackerTurnStartPosition:o,allActorsTurnStartPositions:h,persistentTargetIds:a});return{state:Hn(e,g.effects,{sourceId:n.id,targetId:void 0,stepId:l}),kills:g.kills||0,messages:g.messages}},CT={id:"BASIC_ATTACK",name:"Basic Attack",description:"Strike an adjacent enemy for 1 damage.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0,damage:1},execute:(e,n,s,o=[])=>{const a=[],l=[],u=(e.timelineEvents||[]).some(C=>C.phase==="STATUS_APPLY"&&C.type==="ApplyStatus"&&C.payload?.status==="stunned"&&(C.payload?.target===n.id||typeof C.payload?.target=="object"&&C.payload?.target&&Q(C.payload.target,n.position)));if(Ji(n)||u)return l.push("Cannot attack while stunned!"),{effects:a,messages:l,consumesTurn:!0};if(!s)return l.push("Select a target!"),{effects:a,messages:l,consumesTurn:!1};if(!bt(n.position,s,1))return l.push("Target out of range!"),{effects:a,messages:l,consumesTurn:!1};const p=ye(e,s);if(!p||p.id===n.id)return l.push("No enemy at target!"),{effects:a,messages:l,consumesTurn:!1};if(p.factionId===n.factionId)return l.push("Cannot attack friendlies!"),{effects:a,messages:l,consumesTurn:!1};if(p.subtype==="bomb")return l.push("Cannot attack a bomb!"),{effects:a,messages:l,consumesTurn:!1};let h=1;o.includes("POWER_STRIKE")&&(h+=2);const g=Q(n.previousPosition||n.position,n.position);o.includes("EXTENDED_REACH")&&g&&(h+=1);const b=_t({attackerId:n.id,targetId:p.id,skillId:"BASIC_ATTACK",basePower:h,trinity:Oe(n),targetTrinity:Oe(p),damageClass:"physical",scaling:[{attribute:"body",coefficient:.5}],statusMultipliers:[],inDangerPreviewHex:!!e.intentPreview?.dangerTiles?.some(C=>Q(C,n.position)),theoreticalMaxPower:h}),S=b.finalPower,T=Math.max(0,S-(p.temporaryArmor||0)),v=p.hp-T<=0,A=Bn(n.position,p.position),_=A>=0?wt(A):void 0,E=v?"extreme":S>=4?"high":S>=2?"medium":"low";a.push({type:"Juice",effect:"lightImpact",target:"targetActor",intensity:"low",metadata:{signature:"ATK.STRIKE.PHYSICAL.BASIC_ATTACK",family:"attack",primitive:"strike",phase:"anticipation",element:"physical",variant:"basic_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"BASIC_ATTACK",timing:{delayMs:0,durationMs:110,ttlMs:140}}}),a.push({type:"Juice",effect:"dashBlur",target:p.id,path:[n.position,p.position],intensity:E==="extreme"?"high":"medium",metadata:{signature:"ATK.STRIKE.PHYSICAL.BASIC_ATTACK",family:"attack",primitive:"strike",phase:"travel",element:"physical",variant:"basic_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"BASIC_ATTACK",timing:{delayMs:110,durationMs:70,ttlMs:100}}}),a.push({type:"Juice",effect:"heavyImpact",target:p.id,intensity:E,direction:_,metadata:{signature:"ATK.STRIKE.PHYSICAL.BASIC_ATTACK",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"basic_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},..._?{contactRef:{kind:"contact_world"},contactHex:p.position,contactToHex:p.position,contactFromHex:n.position}:{},skillId:"BASIC_ATTACK",camera:{kick:E==="extreme"?"heavy":E==="high"?"medium":"light",freezeMs:E==="extreme"?80:55},timing:{delayMs:180,durationMs:90,ttlMs:150},flags:{lethal:v,...E==="extreme"?{crit:!0}:{}}}}),a.push({type:"Damage",target:"targetActor",amount:S,reason:"basic_attack",scoreEvent:b.scoreEvent}),a.push({type:"Juice",effect:"lightImpact",target:p.id,intensity:"low",metadata:{signature:"ATK.STRIKE.PHYSICAL.BASIC_ATTACK",family:"attack",primitive:"strike",phase:"aftermath",element:"physical",variant:"basic_attack",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_actor"},skillId:"BASIC_ATTACK",timing:{delayMs:280,durationMs:130,ttlMs:170}}});const w=n.type==="player"?"You":`${n.subtype||"enemy"}#${n.id}`,M=p.type==="player"?"you":`${p.subtype||"enemy"}#${p.id}`;return l.push(`${w} attacked ${M}!`),o.includes("VAMPIRIC")&&p.hp-T<=0&&(a.push({type:"Heal",target:n.id,amount:1}),l.push("Vampiric heal!")),{effects:a,messages:l,consumesTurn:!0}},getValidTargets:(e,n)=>{const s=ye(e,n);return s?Ue(n).filter(a=>{const l=ye(e,a);return!!l&&l.subtype!=="bomb"&&l.id!==s.id&&l.factionId!==s.factionId}):[]},upgrades:{EXTENDED_REACH:{id:"EXTENDED_REACH",name:"Disciplined Stance",description:"+1 damage when attacking without moving first."},POWER_STRIKE:{id:"POWER_STRIKE",name:"Power Strike",description:"Damage +2"},VAMPIRIC:{id:"VAMPIRIC",name:"Vampiric",description:"Heal 1 HP on kill"}},scenarios:Ye("BASIC_ATTACK")},OT=e=>{if(!e||e.length===0)return e;let n=!1;const s=e.map(o=>(o.currentCooldown||0)<=0?o:(n=!0,{...o,currentCooldown:0}));return n?s:e},Ly=e=>{const n=OT(e.activeSkills),s=(e.actionCooldown||0)>0?0:e.actionCooldown;return n===e.activeSkills&&s===e.actionCooldown?e:{...e,activeSkills:n||e.activeSkills,actionCooldown:s}},af=e=>e.enemies.filter(s=>s.hp>0&&s.factionId==="enemy").length===0,NT=e=>{if(!af(e))return e;const n=Ly(e.player),s=e.companions?.map(Ly),o=e.traps?.map(u=>u.cooldown>0?{...u,cooldown:0}:u),a=!!e.companions&&s?.some((u,f)=>u!==e.companions?.[f]),l=!!e.traps&&o?.some((u,f)=>u!==e.traps?.[f]);return n===e.player&&!a&&!l?e:{...e,player:n,...a?{companions:s}:{},...l?{traps:o}:{}}},By=(e,n)=>af(e)?20:Math.max(n.speed||1,1),u0=(e,n)=>Ie.isWithinBounds(e,n)?Me.getTraitsAt(e,n).has("BLOCKS_MOVEMENT"):!0,Hy=(e,n,s,o)=>{const a=new Map,l=[],u=p=>`${p.q},${p.r}`,f=[{p:s,cost:0}];for(a.set(u(s),0);f.length>0;){const p=f.shift();if(!(p.cost>=o))for(const h of Ue(p.p)){if(!Ie.isWithinBounds(e,h)||!Me.isWalkable(e,h)||!n0(e,n,h,"BASIC_MOVE"))continue;const g=ye(e,h),b=!!g&&g.id!==n.id,S=b&&g.factionId===n.factionId;if(b&&!S)continue;const T=u(h),v=p.cost+1;a.has(T)&&a.get(T)<=v||(a.set(T,v),!S&&pi(e,n,h)&&!u0(e,h)&&l.push(h),f.push({p:h,cost:v}))}}return l},kT=(e,n,s,o,a)=>{const l=T=>`${T.q},${T.r}`,u=T=>{const[v,A]=T.split(",").map(Number);return{q:v,r:A,s:-v-A}},f=[s],p=new Map([[l(s),0]]),h=new Map([[l(s),null]]);for(;f.length>0;){const T=f.shift(),v=l(T),A=p.get(v);if(!(A>=a))for(const _ of Ue(T)){if(!Ie.isWithinBounds(e,_)||!Me.isWalkable(e,_)||!n0(e,n,_,"BASIC_MOVE"))continue;const E=ye(e,_),w=!!E&&E.id!==n.id,M=w&&E.factionId===n.factionId;if(w&&!M)continue;const C=l(_),I=A+1;p.has(C)&&p.get(C)<=I||(p.set(C,I),h.set(C,v),f.push(_))}}const g=l(o);if(!h.has(g)||u0(e,o)||!pi(e,n,o))return null;const b=[];let S=g;for(;S;)b.push(u(S)),S=h.get(S)||null;return b.reverse(),b},RT={id:"BASIC_MOVE",name:"Walk",description:"Move to an adjacent or nearby tile within your speed range.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const l=By(e,n),f=Hy(e,n,n.position,l).some(g=>Q(g,s)),p=kT(e,n,n.position,s,l);if(!f||!p||p.length<2)return a.push("Target out of reach or blocked!"),{effects:o,messages:a,consumesTurn:!1};o.push({type:"Displacement",target:"self",destination:s,source:n.position,path:p,simulatePath:!0,ignoreCollision:!0});const h=n.id===e.player.id?"You":`${n.subtype||"enemy"}#${n.id}`;return a.push(`${h} moved to (${s.q}, ${s.r}). [Range ${l}]`),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>{const s=ye(e,n);if(!s)return[];const o=By(e,s);return Hy(e,s,n,o).filter(l=>!Xi(e,l,s.id))},upgrades:{},scenarios:Ye("BASIC_MOVE")},IT={id:"BOMB_TOSS",name:"Bomb Toss",description:"Throw a bomb to a nearby tile.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:2},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!bt(n.position,s,3))return a.push("Out of range!"),{effects:o,messages:a,consumesTurn:!1};if(!Me.isWalkable(e,s))return a.push("Target blocked!"),{effects:o,messages:a,consumesTurn:!1};if(ye(e,s))return a.push("Target occupied!"),{effects:o,messages:a,consumesTurn:!1};const u=`bomb-${n.id}-${e.turnNumber}-${e.actionLog?.length??0}-${s.q}_${s.r}_${s.s}`,f=Wi({id:u,type:"enemy",subtype:"bomb",factionId:n.factionId,position:s,speed:10,skills:["TIME_BOMB"],weightClass:"Standard"});return f.statusEffects=[{id:"TIME_BOMB",type:"time_bomb",duration:2,tickWindow:"END_OF_TURN"}],o.push({type:"SpawnActor",actor:f}),a.push("Bomb tossed!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>{const o=[];for(let a=-3;a<=3;a++)for(let l=Math.max(-3,-a-3);l<=Math.min(3,-a+3);l++){const u={q:n.q+a,r:n.r+l,s:n.s-a-l};bt(n,u,3)&&Me.isWalkable(e,u)&&(ye(e,u)||o.push(u))}return o},upgrades:{}},LT={id:"BULWARK_CHARGE",name:"Bulwark Charge",description:"Charge into an adjacent enemy, pushing a chain. Wall hard-stop stuns the chain.",slot:"offensive",icon:"",baseVariables:{range:1,cost:0,cooldown:3},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(fe(n.position,s)!==1)return a.push("Target not adjacent!"),{effects:o,messages:a,consumesTurn:!1};const u=Ln(e.enemies,s);if(!u)return a.push("No target!"),{effects:o,messages:a,consumesTurn:!1};const{isAxial:f,directionIndex:p}=En(n.position,s);if(!f)return{effects:o,messages:a,consumesTurn:!1};const h=wt(p),g=[u];let b={q:u.position.q+h.q,r:u.position.r+h.r,s:u.position.s+h.s};for(;;){const v=Ln(e.enemies,b);if(v){if(g.push(v),b={q:b.q+h.q,r:b.r+h.r,s:b.s+h.s},g.length>6)break;continue}break}const S=[];for(let v=0;v<g.length;v++){const A=g[v],_=v===0?2:1,E={q:A.position.q+h.q*_,r:A.position.r+h.r*_,s:A.position.s+h.s*_};S.push({actor:A,dest:E})}let T=!1;for(const v of S){const A=e.tiles.get(ce(v.dest));if(A?.baseId==="WALL"||A?.traits.has("BLOCKS_MOVEMENT")){T=!0;break}if(e.enemies.find(E=>Q(E.position,v.dest)&&!g.some(w=>w.id===E.id))){T=!0;break}}if(T){for(const v of g)o.push({type:"ApplyStatus",target:v.position,status:"stunned",duration:1}),a.push("Chain blocked! Stunned.");return{effects:o,messages:a}}for(const v of S)o.push({type:"Displacement",target:v.actor.id,destination:v.dest});return o.push({type:"Displacement",target:"self",destination:u.position}),a.push("Bulwark Charge!"),{effects:o,messages:a}},getValidTargets:(e,n)=>[{q:n.q+1,r:n.r,s:n.s-1},{q:n.q+1,r:n.r-1,s:n.s},{q:n.q,r:n.r-1,s:n.s+1},{q:n.q-1,r:n.r,s:n.s+1},{q:n.q-1,r:n.r+1,s:n.s},{q:n.q,r:n.r+1,s:n.s-1}].filter(o=>!!Ln(e.enemies,o)),upgrades:{},scenarios:[{id:"chain_stun",title:"Chain-Stun",description:"Wall prevents chain, chain gets stunned",setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BULWARK_CHARGE"]),e.spawnEnemy("shieldBearer",{q:3,r:5,s:-8},"A"),e.spawnEnemy("shieldBearer",{q:3,r:4,s:-7},"B"),e.setTile({q:3,r:3,s:-6},"wall"),e.state.hasShield=!0},run:e=>{e.useSkill("BULWARK_CHARGE",{q:3,r:5,s:-8})},verify:(e,n)=>!0}]},BT=(e,n)=>!!e.tiles.get(ce(n))?.traits?.has("CORPSE"),HT=(e,n,s)=>{const o=[];return e.tiles.forEach(a=>{a.traits.has("CORPSE")&&fe(n,a.position)<=s&&o.push(a.position)}),o},PT={id:"CORPSE_EXPLOSION",name:"Corpse Explosion",description:"Detonate a target corpse, dealing damage in a 1-tile radius.",slot:"offensive",icon:"",baseVariables:{range:4,cost:1,cooldown:2},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!BT(e,s))return{effects:o,messages:["A corpse is required!"],consumesTurn:!1};if(!bt(n.position,s,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};o.push({type:"RemoveCorpse",position:s});const u=[s,...Ue(s)],f=Oe(n),p=!!e.intentPreview?.dangerTiles?.some(h=>Q(h,n.position));for(const h of u){const g=ye(e,h),b=_t({attackerId:n.id,targetId:g?.id||ce(h),skillId:"CORPSE_EXPLOSION",basePower:2,trinity:f,targetTrinity:g?Oe(g):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.25}],statusMultipliers:[],inDangerPreviewHex:p,theoreticalMaxPower:2});o.push({type:"Damage",target:h,amount:b.finalPower,reason:"corpse_explosion",scoreEvent:b.scoreEvent})}return o.push({type:"Juice",effect:"explosion_ring",target:s,metadata:{signature:"ATK.BLAST.VOID.CORPSE_EXPLOSION",family:"attack",primitive:"blast",phase:"impact",element:"void",variant:"corpse_explosion",targetRef:{kind:"target_hex"},skillId:"CORPSE_EXPLOSION"}}),o.push({type:"Juice",effect:"shake",intensity:"high",metadata:{signature:"UI.SHAKE.VOID.CORPSE_EXPLOSION",family:"ui",primitive:"shake",phase:"impact",element:"void",variant:"corpse_explosion_shake",skillId:"CORPSE_EXPLOSION",camera:{shake:"high"}}}),o.push({type:"Juice",effect:"combat_text",target:s,text:"BOOM!",metadata:{signature:"UI.TEXT.VOID.CORPSE_EXPLOSION",family:"ui",primitive:"text",phase:"impact",element:"void",variant:"corpse_explosion_text",targetRef:{kind:"target_hex"},skillId:"CORPSE_EXPLOSION",textTone:"damage"}}),a.push("Corpse exploded!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>HT(e,n,4),upgrades:{},scenarios:Ye("CORPSE_EXPLOSION")},hi=(e,n)=>e.type!=="Juice"?e:{...e,metadata:{...e.metadata||{},...n}},d0=e=>!!e&&typeof e.q=="number"&&typeof e.r=="number"&&typeof e.s=="number",f0=e=>d0(e)?Math.abs(e.q)+Math.abs(e.r)+Math.abs(e.s)===2:!1,m0=(e,n)=>({q:e.q-n.q,r:e.r-n.r,s:e.s-n.s}),he={shake:(e,n)=>({type:"Juice",effect:"shake",intensity:e,direction:n,metadata:{signature:"UI.SHAKE.NEUTRAL.CAMERA",family:"ui",primitive:"shake",phase:"instant",element:"neutral",variant:"camera_shake",camera:{shake:e,...n?{kick:e==="extreme"?"heavy":e==="high"?"medium":"light"}:{}}}}),flash:e=>({type:"Juice",effect:"flash",intensity:"high",color:e,metadata:{signature:"ATK.BLAST.NEUTRAL.FLASH",family:"attack",primitive:"blast",phase:"impact",element:"neutral",variant:"flash"}}),freeze:(e=80)=>({type:"Juice",effect:"freeze",duration:e,metadata:{signature:"UI.FREEZE.NEUTRAL.HITSTOP",family:"ui",primitive:"freeze",phase:"instant",element:"neutral",variant:"hitstop",camera:{freezeMs:e},timing:{durationMs:e,ttlMs:e}}}),combatText:(e,n,s)=>({type:"Juice",effect:"combat_text",text:e,target:n,color:s}),momentumTrail:(e,n)=>({type:"Juice",effect:"momentumTrail",path:e,intensity:n}),heavyImpact:(e,n)=>({type:"Juice",effect:"heavyImpact",target:e,direction:n,intensity:"extreme"}),lightImpact:e=>({type:"Juice",effect:"lightImpact",target:e,intensity:"low"}),kineticWave:(e,n,s)=>({type:"Juice",effect:"kineticWave",target:e,direction:n,intensity:s}),stunBurst:e=>({type:"Juice",effect:"stunBurst",target:e,intensity:"medium"}),lavaRipple:e=>({type:"Juice",effect:"lavaRipple",target:e,intensity:"medium"}),wallCrack:(e,n)=>({type:"Juice",effect:"wallCrack",target:e,direction:n,intensity:"high"}),explosionRing:e=>({type:"Juice",effect:"explosion_ring",target:e})};he.combatText=(e=>(n,s,o)=>hi(e(n,s,o),{signature:"UI.TEXT.NEUTRAL.POPUP",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"combat_text",targetRef:typeof s=="string"?{kind:"target_actor"}:{kind:"target_hex"},textTone:/^[-]/.test(n)?"damage":/^\+/.test(n)?"heal":"system"}))(he.combatText);he.momentumTrail=(e=>(n,s)=>hi(e(n,s),{signature:"MOVE.DASH.KINETIC.MOMENTUM_TRAIL",family:"movement",primitive:"dash",phase:"travel",element:"kinetic",variant:"momentum_trail"}))(he.momentumTrail);he.heavyImpact=(e=>(n,s)=>{const o={signature:"ATK.STRIKE.PHYSICAL.HEAVY",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"heavy_impact",sourceRef:{kind:"source_actor"}};return d0(n)?(o.targetRef={kind:"target_hex"},s&&f0(s)&&(o.contactHex=n,o.contactToHex=n,o.contactFromHex=m0(n,s),o.contactRef={kind:"contact_world"})):o.targetRef={kind:"target_actor"},hi(e(n,s),o)})(he.heavyImpact);he.lightImpact=(e=>n=>hi(e(n),{signature:"ATK.STRIKE.PHYSICAL.LIGHT",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"light_impact",sourceRef:{kind:"source_actor"},targetRef:typeof n=="string"?{kind:"target_actor"}:{kind:"target_hex"}}))(he.lightImpact);he.kineticWave=(e=>(n,s,o)=>hi(e(n,s,o),{signature:"ATK.PULSE.KINETIC.WAVE",family:"attack",primitive:"pulse",phase:"impact",element:"kinetic",variant:"kinetic_wave",targetRef:{kind:"target_hex"},sourceRef:{kind:"source_hex"}}))(he.kineticWave);he.stunBurst=(e=>n=>hi(e(n),{signature:"STATE.APPLY.NEUTRAL.STUN_BURST",family:"status",primitive:"status_apply",phase:"impact",element:"neutral",variant:"stun_burst",targetRef:typeof n=="string"?{kind:"target_actor"}:{kind:"target_hex"}}))(he.stunBurst);he.lavaRipple=(e=>n=>hi(e(n),{signature:"ENV.HAZARD.FIRE.LAVA_RIPPLE",family:"environment",primitive:"hazard_burst",phase:"impact",element:"fire",variant:"lava_ripple",targetRef:{kind:"target_hex"}}))(he.lavaRipple);he.wallCrack=(e=>(n,s)=>{const o={signature:"ENV.COLLISION.KINETIC.WALL_CRACK",family:"environment",primitive:"collision",phase:"impact",element:"kinetic",variant:"wall_crack",targetRef:{kind:"target_hex"}};return f0(s)&&(o.contactHex=n,o.contactToHex=n,o.contactFromHex=m0(n,s),o.contactRef={kind:"contact_world"}),hi(e(n,s),o)})(he.wallCrack);he.explosionRing=(e=>n=>hi(e(n),{signature:"ATK.BLAST.FIRE.EXPLOSION_RING",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"explosion_ring",targetRef:{kind:"target_hex"}}))(he.explosionRing);const ft={GRAPPLE_HOOK:{anticipation:(e,n)=>[{type:"Juice",effect:"aimingLaser",target:e,path:[e,n],intensity:"low",color:"#00ff88"}],execution:e=>[{type:"Juice",effect:"hookCable",path:e,intensity:"medium",duration:200,color:"#00ff88"},he.shake("low")],impact:(e,n)=>[{type:"Juice",effect:"grappleHookWinch",target:e,direction:n,intensity:"high",duration:150},he.shake("medium",n)],resolution:(e,n)=>[he.momentumTrail(e,n>6?"high":"medium"),he.kineticWave(e[0],e[e.length-1],"high")]},SHIELD_THROW:{anticipation:(e,n)=>[{type:"Juice",effect:"trajectory",target:e,path:[e,n],intensity:"medium",color:"#4169e1"}],execution:e=>[{type:"Juice",effect:"shieldArc",path:e,intensity:"high",duration:300,metadata:{rotation:720}},{type:"Juice",effect:"shieldSpin",path:e,intensity:"medium"}],impact:(e,n)=>[he.heavyImpact(e,n),he.shake("high",n),he.freeze(120),he.combatText("IMPACT!",e,"#ff4444")],resolution:e=>[he.kineticWave(e[0],e[e.length-1],"high"),he.momentumTrail(e,"high")]},DASH:{anticipation:(e,n)=>[{type:"Juice",effect:"chargeUp",target:e,direction:n,intensity:"medium",duration:100}],execution:e=>[{type:"Juice",effect:"dashBlur",path:e,intensity:"high",duration:150},he.momentumTrail(e,"medium")],impact:(e,n,s)=>s?[he.heavyImpact(e,n),he.shake("extreme",n),he.freeze(100),he.combatText("SHUNT!",e,"#ffaa00")]:[he.lightImpact(e)],resolution:e=>e?[he.kineticWave(e[0],e[e.length-1],"high"),he.momentumTrail(e,"high")]:[]},SPEAR_THROW:{anticipation:(e,n)=>[{type:"Juice",effect:"aimingLaser",target:e,path:[e,n],intensity:"low",color:"#ff6b6b"}],execution:e=>[{type:"Juice",effect:"spearTrail",path:e,intensity:"high",duration:150},{type:"Juice",effect:"spearWhistle",path:e,intensity:"medium",metadata:{pitch:"rising"}}],impact:(e,n)=>n?[he.heavyImpact(e),he.shake("medium"),he.freeze(60),he.combatText("LETHAL",e,"#ff0000")]:[he.lightImpact(e),he.combatText("MISS",e,"#888888")],resolution:()=>[]},VAULT:{anticipation:(e,n)=>[{type:"Juice",effect:"trajectory",target:e,path:[e,n],intensity:"low",color:"#00ddff",metadata:{arc:"high"}}],execution:e=>[{type:"Juice",effect:"vaultLeap",path:e,intensity:"medium",duration:250,metadata:{arc:"parabolic"}}],impact:(e,n)=>n?[he.heavyImpact(e),he.shake("medium"),he.stunBurst(e),he.combatText("STUN!",e,"#ffff00")]:[he.lightImpact(e)],resolution:()=>[]}},Ad={lavaSink:e=>[{type:"Juice",effect:"lavaSink",target:e,intensity:"extreme",duration:500,metadata:{particleCount:50}},he.lavaRipple(e),he.shake("high"),he.combatText("CONSUMED",e,"#ff4400")],wallImpact:(e,n,s)=>{const o=[he.wallCrack(e,n),he.shake("high",n)];return s&&(o.push(he.stunBurst(e)),o.push(he.combatText("STUNNED",e,"#ffaa00"))),o},voidConsume:e=>[{type:"Juice",effect:"voidConsume",target:e,intensity:"extreme",duration:800,color:"#000000"},he.freeze(150),he.combatText("VOID",e,"#8800ff")]};function Wl(e,n){const{origin:s,direction:o,momentum:a}=n,l=[];l.push(he.kineticWave(s,o,a>6?"high":"medium"));const u=Vt(s,{q:o.q*(a+10),r:o.r*(a+10),s:o.s*(a+10)}),f=Ze(s,u);let p=a,h=jT(e,f);for(;p>0&&h.length>0;){const g=DT(h);if(g.length===0)break;const b=g.length;if(p<b){const w=g[g.length-1],M=p;p=0;const C=[f[w.pos1D]];for(let I=0;I<M;I++){const k=w.pos1D+1,R=f[k];if(!R||!Gi(R,e.gridWidth,e.gridHeight)||Py(e,R)){l.push({type:"Impact",target:w.id,damage:M-I,direction:o});break}if(w.pos1D=k,C.push(R),jy(e,R)){l.push({type:"LavaSink",target:w.id}),l.push(...Ad.lavaSink(R));break}}C.length>1&&(l.push({type:"Displacement",target:w.id,destination:C[C.length-1],path:C,animationDuration:C.length*80}),l.push(he.momentumTrail(C,"medium")));break}const S=g[g.length-1],T=S.pos1D+1,v=f[T];if(!v||!Gi(v,e.gridWidth,e.gridHeight)||Py(e,v)){l.push({type:"ApplyStatus",target:S.id,status:"stunned",duration:1}),v&&l.push(...Ad.wallImpact(v,o,!0));break}const A=new Map;for(const w of g){const M=f[w.pos1D];w.pos1D+=1;const C=f[w.pos1D];A.set(w.id,[M,C])}const _=[...g].reverse();for(const w of _){const M=A.get(w.id);M&&l.push({type:"Displacement",target:w.id,destination:M[M.length-1],path:M,ignoreCollision:!0,animationDuration:150})}const E=Array.from(A.values()).flat();E.length>0&&l.push(he.momentumTrail(E,b>2?"high":"medium")),p-=b;for(let w=h.length-1;w>=0;w--){const M=h[w],C=f[M.pos1D];jy(e,C)&&(l.push({type:"LavaSink",target:M.id}),l.push(...Ad.lavaSink(C)),h.splice(w,1))}if(p>0){const w=g[g.length-1];h=h.filter(C=>C.pos1D>=w.pos1D);const M=h.filter(C=>C.pos1D>w.pos1D);h=[w,...M]}}return l}function jT(e,n){const s=[],o=[e.player,...e.enemies];for(const a of o){const l=n.findIndex(u=>Q(u,a.position));l!==-1&&s.push({id:a.id,pos1D:l})}return s.sort((a,l)=>a.pos1D-l.pos1D)}function DT(e){if(e.length===0)return[];const n=[];let s=e[0];n.push(s);for(let o=1;o<e.length;o++){const a=e[o];if(a.pos1D===s.pos1D||a.pos1D===s.pos1D+1)n.push(a),s=a;else break}return n}function Py(e,n){const s=Me.getTraitsAt(e,n);return s.has("BLOCKS_MOVEMENT")||s.has("BLOCKS_LOS")}function jy(e,n){const s=Me.getTraitsAt(e,n);return s.has("HAZARDOUS")||s.has("LIQUID")}const UT={id:"DASH",name:"Kinetic Dash",description:"Dash in a straight line. With a shield, slam into enemies and send them flying!",slot:"passive",icon:"",baseVariables:{range:4,cost:0,cooldown:0},execute:(e,n,s,o=[])=>{const a=[],l=[],u=o.includes("MOMENTUM_SURGE"),f=o.includes("DASH_CHAIN_REACTION")||o.includes("CHAIN_REACTION");if(!s)return{effects:a,messages:l,consumesTurn:!1};const{isAxial:p,directionIndex:h}=En(n.position,s),b=e.enemies.filter(E=>E.hp>0).length===0?20:4;if(!bt(n.position,s,b))return{effects:a,messages:["Out of range!"],consumesTurn:!1};if(!p)return{effects:a,messages:["Axial only! Dash must be in a straight line."],consumesTurn:!1};a.push(...ft.DASH.anticipation(n.position,s));const S=wt(h),T=Ze(n.position,s),v=tf(e,T.slice(1),{checkWalls:!0,checkActors:!0,checkLava:!1,excludeActorId:n.id});let A=s;if(v.obstacle){if(v.obstacle==="wall")return{effects:a,messages:["A wall blocks the way!"],consumesTurn:!1};if(v.obstacle==="lava")return{effects:a,messages:["Lava blocks the way!"],consumesTurn:!1};const E=T.findIndex(w=>Q(w,v.position));A=T[E-1]||n.position}if(v.obstacle==="actor"?v.actor:null){const E=Ze(n.position,A);a.push(...ft.DASH.execution(E));const w=[{type:"Displacement",target:"self",destination:A,path:E,simulatePath:!0,ignoreGroundHazards:!0,animationDuration:E.length*60}],M=Hn(e,w,{sourceId:n.id});if(e.hasShield){a.push(...ft.DASH.impact(A,S,!0));const C=5+(e.hasShield&&u?2:0)+(f?1:0),I=Wl(M,{origin:A,direction:S,momentum:C});return{effects:[...a,...w,...I],messages:[...l,"Shield Shunt!"],consumesTurn:!0}}else return a.push(...ft.DASH.impact(A,S,!1)),{effects:[...a,...w],messages:[...l,"Stopped by an obstacle (Need shield to shunt)."],consumesTurn:!Q(n.position,A)}}else{const E=Ze(n.position,A);a.push(...ft.DASH.execution(E));const w={type:"Displacement",target:"self",destination:A,path:E,simulatePath:!0,ignoreGroundHazards:!0,animationDuration:E.length*60};return{effects:[...a,w],messages:[...l,"Dashed!"],consumesTurn:!Q(n.position,A)}}},getValidTargets:(e,n)=>{const o=e.enemies.filter(l=>l.hp>0).length===0?20:4,a=ye(e,n);return a?Ie.getAxialTargets(e,n,o,{stopAtObstacles:!0,includeActors:!0,includeWalls:!1}).filter(l=>pi(e,a,l)):[]},upgrades:{MOMENTUM_SURGE:{id:"MOMENTUM_SURGE",name:"Momentum Surge",description:"+2 Momentum when dashing with shield"},DASH_CHAIN_REACTION:{id:"DASH_CHAIN_REACTION",name:"Chain Reaction",description:"Enemies pushed into other enemies transfer momentum"}},scenarios:Ye("DASH")},$T={id:"FALCON_APEX_STRIKE",name:"Apex Strike",description:"The falcon dives into a target for lethal damage.",slot:"passive",icon:"",baseVariables:{range:4,cost:0,cooldown:2,damage:40},execute:(e,n,s,o=[])=>{const a=[],l=[],u=n.companionOf,p=(u?u===e.player.id?e.player:e.enemies.find(S=>S.id===u):void 0)?.activeSkills?.find(S=>S.id==="FALCON_COMMAND")?.activeUpgrades||[],h=o.includes("APEX_PREDATOR")||p.includes("APEX_PREDATOR");if(!s)return{effects:a,messages:l,consumesTurn:!1};const g=ye(e,s);if(!g)return{effects:a,messages:l,consumesTurn:!1};if(n.companionState?.apexStrikeCooldown&&n.companionState.apexStrikeCooldown>0)return{effects:a,messages:l,consumesTurn:!1};const b=_t({attackerId:n.id,targetId:g.id,skillId:"FALCON_APEX_STRIKE",basePower:40,trinity:Oe(n),targetTrinity:Oe(g),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});return a.push({type:"Damage",target:g.id,amount:b.finalPower,reason:"apex_strike",scoreEvent:b.scoreEvent}),a.push({type:"Juice",effect:"impact",target:s,intensity:"high",metadata:{signature:"ATK.STRIKE.PHYSICAL.FALCON_APEX_STRIKE",family:"attack",primitive:"strike",phase:"impact",element:"physical",variant:"falcon_apex_strike",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_hex"},skillId:"FALCON_APEX_STRIKE",camera:{kick:"medium"}}}),a.push({type:"UpdateCompanionState",target:n.id,apexStrikeCooldown:h?1:2}),l.push(`Falcon executes APEX STRIKE on ${g.subtype||"enemy"}!`),{effects:a,messages:l,consumesTurn:!0}},upgrades:{},getValidTargets:(e,n)=>{const s=[];return e.enemies.forEach(o=>{fe(n,o.position)<=4&&s.push(o.position)}),s}},qT={id:"FALCON_AUTO_ROOST",name:"Auto Roost",description:"Automatically returns the falcon to roost mode when mark is lost.",slot:"passive",icon:"R",baseVariables:{range:0,cost:0,cooldown:0},execute:(e,n,s)=>({effects:[{type:"UpdateCompanionState",target:n.id,mode:"roost",markTarget:void 0}],messages:["Falcon loses prey and returns to roost mode."],consumesTurn:!0}),getValidTargets:(e,n)=>[n],upgrades:{}};function Td(e,n){return e.enemies.find(s=>s.companionOf===n&&s.subtype==="falcon")}const zT={id:"FALCON_COMMAND",name:e=>{const n=e?.player?.id;if(!n)return"Summon Falcon";const s=Td(e,n);if(!s)return"Summon Falcon";const o=s.companionState?.mode||"roost";return o==="scout"?"Falcon: Scout":o==="predator"?"Falcon: Hunt":"Falcon: Roost"},description:e=>{const n=e?.player?.id;if(!n)return"Call your Falcon companion.";const s=Td(e,n);if(!s)return"Call your Falcon companion.";const o=s.companionState?.mode||"roost";return o==="scout"?"Click tile to set patrol zone. Falcon orbits and attacks nearby enemies.":o==="predator"?"Click enemy to mark as prey. Falcon pursues and uses Apex Strike.":"Falcon returns to you. Heals and cleanses 1 debuff on arrival."},slot:"offensive",icon:"",baseVariables:{range:6,cost:0,cooldown:0},execute:(e,n,s)=>{const o=[],a=[];let l=Td(e,n.id);if(!l){const p=Jv({ownerId:n.id,position:Ue(n.position)[0]});return o.push({type:"SpawnActor",actor:p}),o.push({type:"Message",text:"Your Falcon companion awakens!"}),a.push("Falcon summoned!"),{effects:o,messages:a,consumesTurn:!0}}const u=s?ye(e,s):void 0;return!s||Q(s,n.position)||!!(u&&u.id===n.id)?(a.push("Falcon returns to roost."),o.push({type:"Juice",effect:"combat_text",target:n.position,text:"Roost",metadata:{signature:"UI.TEXT.NEUTRAL.FALCON_ROOST",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"falcon_roost",targetRef:{kind:"target_hex"},skillId:"FALCON_COMMAND",textTone:"system"}}),o.push({type:"UpdateCompanionState",target:l.id,mode:"roost"}),{effects:o,messages:a,consumesTurn:!0}):u&&u.factionId==="enemy"?(a.push(`Falcon marks ${u.subtype||"enemy"} as prey!`),o.push({type:"Juice",effect:"combat_text",target:s,text:" Marked",metadata:{signature:"UI.TEXT.NEUTRAL.FALCON_MARK",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"falcon_mark",targetRef:{kind:"target_hex"},skillId:"FALCON_COMMAND",textTone:"status"}}),o.push({type:"ApplyStatus",target:u.id,status:"marked_predator",duration:-1}),o.push({type:"UpdateCompanionState",target:l.id,mode:"predator",markTarget:u.id}),{effects:o,messages:a,consumesTurn:!0}):(a.push("Falcon set to patrol zone."),o.push({type:"Juice",effect:"combat_text",target:s,text:" Patrol",metadata:{signature:"UI.TEXT.NEUTRAL.FALCON_PATROL",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"falcon_patrol",targetRef:{kind:"target_hex"},skillId:"FALCON_COMMAND",textTone:"system"}}),o.push({type:"UpdateCompanionState",target:l.id,mode:"scout",markTarget:s}),{effects:o,messages:a,consumesTurn:!0})},getValidTargets:(e,n)=>Ie.getAreaTargets(e,n,6).filter(o=>(Q(o,n),!0)),upgrades:{KEEN_SIGHT:{id:"KEEN_SIGHT",name:"Keen Sight",description:"Falcon reveals hidden enemies within 3 tiles of its position."},FALCON_TWIN_TALONS:{id:"FALCON_TWIN_TALONS",name:"Twin Talons",description:"Basic Peck hits 2 targets instead of 1."},APEX_PREDATOR:{id:"APEX_PREDATOR",name:"Apex Predator",description:"Apex Strike cooldown reduced by 1. Marked enemies take +1 damage from all sources."}},scenarios:Ye("FALCON_COMMAND")},VT={id:"FALCON_HEAL",name:"Roost Heal",description:"The falcon roosts and restores health to its companion.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:1},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const l=ye(e,s);return l?n.companionState?.healCooldown&&n.companionState.healCooldown>0?{effects:o,messages:a,consumesTurn:!1}:(o.push({type:"Heal",target:l.id,amount:1}),o.push({type:"Juice",effect:"flash",target:l.position,color:"#00ff88",metadata:{signature:"STATE.APPLY.HOLY.FALCON_HEAL",family:"status",primitive:"status_apply",phase:"impact",element:"holy",variant:"falcon_heal",targetRef:{kind:"target_hex"},skillId:"FALCON_HEAL"}}),o.push({type:"UpdateCompanionState",target:n.id,healCooldown:1}),a.push("Falcon roosts. You feel restored."),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:a,consumesTurn:!1}},upgrades:{},getValidTargets:(e,n)=>{const s=[],o=e.player;return fe(n,o.position)<=1&&s.push(o.position),s}},YT={id:"FALCON_PECK",name:"Peck",description:"The falcon pecks an adjacent enemy for 1 damage.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0,damage:1},execute:(e,n,s,o=[])=>{const a=[],l=[],u=n.companionOf,p=(u?u===e.player.id?e.player:e.enemies.find(S=>S.id===u):void 0)?.activeSkills?.find(S=>S.id==="FALCON_COMMAND")?.activeUpgrades||[],h=o.includes("TWIN_TALONS")||p.includes("TWIN_TALONS")||p.includes("FALCON_TWIN_TALONS");if(!s)return{effects:a,messages:l,consumesTurn:!1};const g=ye(e,s);if(!g||g.factionId==="player")return{effects:a,messages:l,consumesTurn:!1};if(fe(n.position,s)>1)return{effects:a,messages:l,consumesTurn:!1};const b=[g];if(h){const S=Ue(n.position).map(T=>ye(e,T)).filter(T=>!!T&&T.id!==g.id&&T.factionId==="enemy")[0];S&&b.push(S)}for(const S of b){const T=_t({attackerId:n.id,targetId:S.id,skillId:"FALCON_PECK",basePower:1,trinity:Oe(n),targetTrinity:Oe(S),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.15}],statusMultipliers:[]});a.push({type:"Damage",target:S.id,amount:T.finalPower,reason:"falcon_peck",scoreEvent:T.scoreEvent})}return a.push({type:"Juice",effect:"combat_text",target:s,text:"Peck!",intensity:"low",metadata:{signature:"UI.TEXT.PHYSICAL.FALCON_PECK",family:"ui",primitive:"text",phase:"instant",element:"physical",variant:"falcon_peck",targetRef:{kind:"target_hex"},skillId:"FALCON_PECK",textTone:"damage"}}),l.push(h&&b.length>1?`Falcon pecked ${b.length} enemies!`:`Falcon pecked ${g.subtype||"enemy"}!`),{effects:a,messages:l,consumesTurn:!0}},getValidTargets:(e,n)=>Ue(n).filter(s=>{const o=ye(e,s);return o&&o.factionId==="enemy"}),upgrades:{TWIN_TALONS:{id:"TWIN_TALONS",name:"Twin Talons",description:"Peck hits 2 adjacent targets instead of 1."}},scenarios:Ye("FALCON_PECK")},KT={id:"FALCON_SCOUT",name:"Scout Orbit",description:"The actor orbits a target point in a hexagonal ring.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0},execute:(e,n,s)=>{const o=[],a=[],l=n.companionState?.markTarget;if(!l||typeof l!="object")return{effects:o,messages:a,consumesTurn:!1};const u=l,f=Ue(u);let p;if(fe(n.position,u)!==1)p=f.sort((h,g)=>fe(n.position,h)-fe(n.position,g))[0];else{const g=(f.findIndex(b=>Q(b,n.position))+1)%6;p=f[g]}return Ie.isWithinBounds(e,p)&&Me.isWalkable(e,p)&&!ye(e,p)?(o.push({type:"Displacement",target:n.id,destination:p,source:n.position,simulatePath:!0}),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:a,consumesTurn:!1}},upgrades:{},getValidTargets:(e,n)=>[]},FT=new Set(["FIREBALL","FIREWALL","FIREWALK","ABSORB_FIRE"]),p0=(e,n)=>{const s=Me.getTileAt(e,n),o=Me.getTraitsForTile(e,s),a=l=>s.effects.some(u=>u.id===l);return s.baseId==="VOID"||o.has("VOID")||o.has("PIT")?"VOID_TOUCHED":s.baseId==="ICE"||a("ICE_WALL")?"FROZEN":s.baseId==="LAVA"||o.has("LAVA")||o.has("FIRE")||a("FIRE")?"MELTED":a("WET")||a("STEAM")?"SOAKED":"STABLE"},h0=(e,n)=>FT.has(e)&&n==="MELTED"?1.15:1,WT={id:"FIREBALL",name:"Fireball",description:"Launch a sphere of flame. Range 3, Axial. Deals damage and leaves fire.",slot:"offensive",icon:"",baseVariables:{range:3,cost:1,cooldown:2},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const{isAxial:l}=En(n.position,s);if(!bt(n.position,s,3)||!l)return{effects:o,messages:["Invalid target! Range 3, Axial only."],consumesTurn:!1};const u=[s,...Ue(s)],f=Oe(n),p=!!e.intentPreview?.dangerTiles?.some(h=>Q(h,n.position));for(const h of u){const g=ye(e,h),b=p0(e,h),S=h0("FIREBALL",b),T=_t({attackerId:n.id,targetId:g?.id||ce(h),skillId:"FIREBALL",basePower:1,trinity:f,targetTrinity:g?Oe(g):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.2}],statusMultipliers:S===1?[]:[{id:`surface_${b}`,multiplier:S}],inDangerPreviewHex:p,theoreticalMaxPower:1});o.push({type:"Damage",target:h,amount:T.finalPower,reason:"fireball",scoreEvent:T.scoreEvent}),o.push({type:"PlaceFire",position:h,duration:3})}return o.push({type:"Juice",effect:"flash",target:s,color:"#ff4400",metadata:{signature:"ATK.BLAST.FIRE.FIREBALL_IMPACT",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"fireball",targetRef:{kind:"target_hex"},skillId:"FIREBALL"}}),o.push({type:"Juice",effect:"shake",intensity:"medium",metadata:{signature:"UI.SHAKE.FIRE.FIREBALL",family:"ui",primitive:"shake",phase:"impact",element:"fire",variant:"fireball_shake",skillId:"FIREBALL",camera:{shake:"medium"}}}),a.push("Fireball!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>Ie.getAxialTargets(e,n,3),upgrades:{},scenarios:Ye("FIREBALL")},GT={id:"FIREWALK",name:"Firewalk",description:"Teleport to a fire or lava tile. Grants 2 turns of Fire Immunity.",slot:"utility",icon:"",baseVariables:{range:4,cost:1,cooldown:3},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!bt(n.position,s,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const l=e.tiles.get(ce(s)),u=l?.effects.some(p=>p.id==="FIRE"),f=l?.baseId==="LAVA"||l?.traits.has("LIQUID");return!u&&!f?{effects:o,messages:["Can only teleport to Fire or Lava!"],consumesTurn:!1}:Xi(e,s,n.id)?{effects:o,messages:["Target position occupied!"],consumesTurn:!1}:(o.push({type:"Displacement",target:"self",destination:s,source:n.position,simulatePath:!1}),o.push({type:"ApplyStatus",target:"self",status:"fire_immunity",duration:2}),o.push({type:"Juice",effect:"flash",target:s,color:"#ff8800",metadata:{signature:"MOVE.BLINK.FIRE.FIREWALK",family:"movement",primitive:"blink",phase:"impact",element:"fire",variant:"firewalk",targetRef:{kind:"target_hex"},skillId:"FIREWALK"}}),a.push("Firewalk!"),{effects:o,messages:a,consumesTurn:!0})},getValidTargets:(e,n)=>{const s=[];return e.tiles.forEach(o=>{const a=fe(n,o.position);if(a>0&&a<=4){const l=o.effects.some(f=>f.id==="FIRE"),u=o.baseId==="LAVA"||o.traits.has("LIQUID");(l||u)&&s.push(o.position)}}),s},upgrades:{},scenarios:Ye("FIREWALK")},XT={id:"FIREWALL",name:"Firewall",description:"Create a wall of flames 5 tiles wide. Area denial.",slot:"utility",icon:"",baseVariables:{range:4,cost:1,cooldown:4},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const{isAxial:l,directionIndex:u}=En(n.position,s);if(!l)return{effects:o,messages:["Axial targeting only!"],consumesTurn:!1};const f=(u+2)%6,p=(u+5)%6,h=[s];let g=s;for(let S=0;S<2;S++)g=Vt(g,wt(f)),Ie.isWithinBounds(e,g)&&h.push(g);let b=s;for(let S=0;S<2;S++)b=Vt(b,wt(p)),Ie.isWithinBounds(e,b)&&h.push(b);for(const S of h)if(!Tn(e,S)){o.push({type:"PlaceFire",position:S,duration:3});const T=ye(e,S);if(T){const v=p0(e,S),A=h0("FIREWALL",v),_=_t({attackerId:n.id,targetId:T.id,skillId:"FIREWALL",basePower:1,trinity:Oe(n),targetTrinity:Oe(T),damageClass:"magical",scaling:[{attribute:"mind",coefficient:.15}],statusMultipliers:A===1?[]:[{id:`surface_${v}`,multiplier:A}]});o.push({type:"Damage",target:T.id,amount:_.finalPower,reason:"firewall_impact",scoreEvent:_.scoreEvent})}}return o.push({type:"Juice",effect:"flash",target:s,color:"#ffaa00",metadata:{signature:"ATK.BLAST.FIRE.FIREWALL",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"firewall",targetRef:{kind:"target_hex"},skillId:"FIREWALL"}}),a.push("Firewall raised!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>Ie.getAxialTargets(e,n,4),upgrades:{},scenarios:Ye("FIREWALL")};function JT(e,n,s,o){const a=fe(n.position,s);if(a<=1)return[];const l=Bn(s,n.position),u=wt(l);return Wl(e,{origin:s,direction:u,momentum:Math.min(o,a-1)})}function QT(e,n){return[{type:"Displacement",target:e.id,destination:n.position},{type:"Displacement",target:n.id,destination:e.position}]}function ZT(e,n,s,o){return Wl(e,{origin:n,direction:s,momentum:o})}const e1={id:"GRAPPLE_HOOK",name:"Grapple Hook",description:"Pull/Zip mechanism with multi-phase kinetic resolution.",slot:"offensive",icon:"",baseVariables:{range:4,cost:1,cooldown:3,momentum:4},execute:(e,n,s,o=[])=>{let a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};const{directionIndex:f}=En(n.position,s),p=wt(f);a.push(...ft.GRAPPLE_HOOK.anticipation(n.position,s));const{isValid:h,blockedBy:g}=nf(e,n.position,s,{stopAtWalls:!0,stopAtActors:!0,excludeActorId:n.id});if(!h)return l.push(`Line of sight blocked by ${g}!`),{effects:a,messages:l,consumesTurn:!1};const b=s,S=ye(e,b),T=Me.getTraitsAt(e,b),A=T.has("BLOCKS_MOVEMENT")||T.has("ANCHOR")?"Heavy":S?.weightClass||"Standard";if(A==="Heavy"||A==="Anchored"){const _=Hd(b,p);a.push(...ft.GRAPPLE_HOOK.execution(Ze(n.position,_))),a.push({type:"Displacement",target:n.id,destination:_,ignoreGroundHazards:!0});const E=Me.getTileAt(e,_);if(E){const M=Ts.processEntry(n,E,e);a.push(...M.effects),l.push(...M.messages)}const w=Ue(_);for(const M of w){const C=ye(e,M);C&&C.id!==n.id&&(a.push({type:"Impact",target:C.id,damage:0,direction:p}),a.push({type:"ApplyStatus",target:C.id,status:"stunned",duration:2}),a.push(he.stunBurst(M)))}return a.push(he.heavyImpact(_,p)),a.push(he.shake("high",p)),l.push("Zipped to anchor!"),{effects:a,messages:l,consumesTurn:!0}}else if(S){const _=fe(n.position,b),E=wt((f+3)%6),w=n.position;a.push(...ft.GRAPPLE_HOOK.execution(Ze(n.position,s)));const M=JT(e,n,b,_-1),C=Hn(e,M,{sourceId:n.id,targetId:S.id}),I=C.enemies.find(q=>q.id===S.id)||(C.player.id===S.id?C.player:null);if(!I)return l.push(`${S.subtype||"Enemy"} neutralized during pull.`),{effects:[...a,...M],messages:l,consumesTurn:!0};const k=QT(n,I),R=I.position;a.push(...ft.GRAPPLE_HOOK.impact(R,p));const $=Hn(C,k,{sourceId:n.id,targetId:S.id}),j=ZT($,w,E,4),D=Ze(w,Vt(w,Zd(f,6)));return a.push(...ft.GRAPPLE_HOOK.resolution(D,4)),{effects:[...a,...M,...k,...j],messages:["Vaulted and Flung!"],consumesTurn:!0}}else return l.push("Hook missed."),{effects:a,messages:l,consumesTurn:!1}},getValidTargets:(e,n)=>{const s=ye(e,n);return s?Ie.getAxialTargets(e,n,4,{includeWalls:!0,includeActors:!0,stopAtObstacles:!0}).filter(o=>{const{directionIndex:a}=En(n,o),l=wt(a),u=ye(e,o),f=Me.getTraitsAt(e,o),h=f.has("BLOCKS_MOVEMENT")||f.has("ANCHOR")?Hd(o,l):u?o:void 0;return h?pi(e,s,h):!1}):[]},upgrades:{},scenarios:Ye("GRAPPLE_HOOK")},t1={id:"JUMP",name:"Jump",description:"Leap to an empty tile within range. Can cross lava but not walls.",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:2},execute:(e,n,s,o=[])=>{const a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};if(!n||!n.position)return{effects:a,messages:l,consumesTurn:!1};const u=o.includes("JUMP_RANGE"),f=o.includes("STUNNING_LANDING"),p=o.includes("METEOR_IMPACT"),h=o.includes("FREE_JUMP"),g=2+(u?1:0);if(!bt(n.position,s,g))return l.push("Target out of range!"),{effects:a,messages:l,consumesTurn:!1};const b=ye(e,s),S=Tn(e,s),T=pi(e,n,s);if(S)return l.push("Cannot jump into a wall!"),{effects:a,messages:l,consumesTurn:!1};if(!T)return l.push("Cannot land on hazard!"),{effects:a,messages:l,consumesTurn:!1};if(b&&!p)return l.push("Target hex is blocked!"),{effects:a,messages:l,consumesTurn:!1};if(b&&p){const v=_t({attackerId:n.id,targetId:b.id,skillId:"JUMP",basePower:99,trinity:Oe(n),targetTrinity:Oe(b),damageClass:"physical",scaling:[{attribute:"body",coefficient:.15}],statusMultipliers:[]});a.push({type:"Damage",target:b.id,amount:v.finalPower,scoreEvent:v.scoreEvent}),l.push(`Meteor Impact killed ${b.subtype||"enemy"}!`)}if(a.push({type:"Message",text:"Jumped!"}),a.push({type:"Displacement",target:"self",destination:s,ignoreCollision:!0,ignoreGroundHazards:!0,simulatePath:!0}),f){const v=Ue(s);let A=!1;for(const _ of v){const E=ye(e,_);E&&E.id!==n.id&&(a.push({type:"ApplyStatus",target:E.id,status:"stunned",duration:1}),A=!0)}A&&l.push("Enemies stunned by landing impact!")}return a.push({type:"Juice",effect:"shake",target:s,intensity:"medium",metadata:{signature:"MOVE.LEAP.NEUTRAL.JUMP_LAND",family:"movement",primitive:"leap",phase:"impact",element:"neutral",variant:"jump_landing",targetRef:{kind:"target_hex"},skillId:"JUMP",camera:{shake:"medium",kick:"light"}}}),{effects:a,messages:l,consumesTurn:!h}},getValidTargets:(e,n)=>{const s=ye(e,n);if(!s)return[];const o=s.activeSkills?.find(f=>f.id==="JUMP"),a=new Set(o?.activeUpgrades||[]),l=2+(a.has("JUMP_RANGE")?1:0),u=a.has("METEOR_IMPACT");return Ie.getAreaTargets(e,n,l).filter(f=>{if(Q(f,n)||Tn(e,f)||!pi(e,s,f))return!1;const p=ye(e,f);return!(p&&p.id!==s.id&&!u)})},upgrades:{JUMP_RANGE:{id:"JUMP_RANGE",name:"Extended Jump",description:"Jump range +1"},JUMP_COOLDOWN:{id:"JUMP_COOLDOWN",name:"Nimble",description:"Jump cooldown -1",modifyCooldown:-1},STUNNING_LANDING:{id:"STUNNING_LANDING",name:"Stunning Landing",description:"All enemies within 1 hex of landing are stunned"},METEOR_IMPACT:{id:"METEOR_IMPACT",name:"Meteor Impact",description:"Can land on enemies to kill them"},FREE_JUMP:{id:"FREE_JUMP",name:"Free Jump",description:"Can move after jumping"}},scenarios:Ye("JUMP")},Dy=2,n1=3,i1=3,s1=2;function a1(e,n){const s=[];for(let o=0;o<6;o++){let a=e;for(let l=0;l<n;l++)a=Vt(a,wt(o));s.push(a)}return s}function o1(e,n,s){return a1(n,s).filter(a=>!(!Ie.isWithinBounds(e,a)||!Me.isWalkable(e,a)||ye(e,a)))}const r1={id:"KINETIC_TRI_TRAP",name:"Kinetic Tri-Trap",description:"Deploy 3 hidden traps on axial tiles. Triggered enemies are flung away.",slot:"defensive",icon:"",baseVariables:{range:Dy,cost:0,cooldown:i1},execute:(e,n,s,o=[])=>{const a=[],l=[];let u=e;const f=o.includes("VOLATILE_CORE"),p=o.includes("TRAP_CHAIN_REACTION")||o.includes("CHAIN_REACTION"),h=o.includes("QUICK_RELOAD"),g=o1(e,n.position,Dy);if(g.length===0)return{effects:a,messages:["No valid trap positions!"],consumesTurn:!1};const b=Math.min(n1,g.length),S=[];a.push({type:"RemoveTrap",position:{q:0,r:0,s:0},ownerId:n.id});const T=[...g];for(let v=0;v<b&&T.length!==0;v++){const{value:A,nextState:_}=In(u);u=_;const E=Math.floor(A*T.length)%T.length;S.push(T[E]),T.splice(E,1)}for(const v of S)a.push({type:"PlaceTrap",position:v,ownerId:n.id,volatileCore:f,chainReaction:p,resetCooldown:h?1:s1}),a.push({type:"Juice",effect:"flash",target:v,intensity:"low",color:"#ffaa00",metadata:{signature:"ENV.TRAP.KINETIC.DEPLOY",family:"environment",primitive:"spawn",phase:"impact",element:"kinetic",variant:"kinetic_tri_trap_deploy",targetRef:{kind:"target_hex"},skillId:"KINETIC_TRI_TRAP"}});return l.push(`${S.length} traps deployed.`),{effects:a,messages:l,consumesTurn:!0}},getValidTargets:(e,n)=>[n],upgrades:{VOLATILE_CORE:{id:"VOLATILE_CORE",name:"Volatile Core",description:"Traps deal 1 damage when triggered."},TRAP_CHAIN_REACTION:{id:"TRAP_CHAIN_REACTION",name:"Chain Reaction",description:"When a trap triggers, adjacent traps also activate."},QUICK_RELOAD:{id:"QUICK_RELOAD",name:"Quick Reload",description:"Individual trap reset cooldown reduced to 1."}},scenarios:Ye("KINETIC_TRI_TRAP")},l1={id:"MULTI_SHOOT",name:"Multi-Shoot",description:"A spread of arrows. Axial range 4. Deals damage to target and neighbors.",slot:"offensive",icon:"",baseVariables:{range:4,cost:1,cooldown:1},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const{isAxial:l}=En(n.position,s);if(!bt(n.position,s,4)||!l)return{effects:o,messages:["Invalid target! Axial range 4 only."],consumesTurn:!1};const u=[s,...Ue(s)],f=Oe(n);for(const p of u){const h=ye(e,p),g=_t({attackerId:n.id,targetId:h?.id||ce(p),skillId:"MULTI_SHOOT",basePower:1,trinity:f,targetTrinity:h?Oe(h):void 0,damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.1},{attribute:"mind",coefficient:.1}],statusMultipliers:[]});o.push({type:"Damage",target:p,amount:g.finalPower,reason:"multi_shoot",scoreEvent:g.scoreEvent})}return o.push({type:"Juice",effect:"flash",target:s,color:"#ffff00",metadata:{signature:"ATK.SHOOT.PHYSICAL.MULTI_SHOOT",family:"attack",primitive:"shoot",phase:"impact",element:"physical",variant:"multi_shoot",targetRef:{kind:"target_hex"},skillId:"MULTI_SHOOT"}}),a.push("Multi-Shoot!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>Ie.getAxialTargets(e,n,4),upgrades:{},scenarios:Ye("MULTI_SHOOT")},c1=(e,n)=>n.q>=0&&n.q<e.gridWidth&&n.r>=0&&n.r<e.gridHeight,u1=(e,n,s)=>Ue(s).filter(a=>c1(e,a)).filter(a=>Me.isWalkable(e,a)).filter(a=>!ye(e,a)).sort((a,l)=>{const u=fe(a,n.position),f=fe(l,n.position);return u!==f?u-f:a.q!==l.q?a.q-l.q:a.r-l.r})[0]||null,d1=(e,n)=>n.id!==e.id&&n.factionId===e.factionId;function Uy(e,n,s,o="fail"){const a=ye(e,s);if(!a)return{ok:!0,spawnPosition:s,effects:[],messages:[]};if(o==="push_friendly"){if(!d1(n,a))return{ok:!1,effects:[],messages:[],failureMessage:"Target tile occupied."};const l=u1(e,n,s);return l?{ok:!0,spawnPosition:s,effects:[{type:"Displacement",target:a.id,destination:l,source:a.position,simulatePath:!0}],messages:["Ally repositions to make room."]}:{ok:!1,effects:[],messages:[],failureMessage:"No space to reposition ally."}}return{ok:!1,effects:[],messages:[],failureMessage:"Target tile occupied."}}const f1=(e,n)=>!!e.tiles.get(ce(n))?.traits?.has("CORPSE"),m1=(e,n,s)=>{const o=[];return e.tiles.forEach(a=>{a.traits.has("CORPSE")&&fe(n,a.position)<=s&&o.push(a.position)}),o},p1=e=>{const n=e.initialSeed??e.rngSeed??"0",s=new Set([...e.enemies.map(l=>l.id),...(e.companions||[]).map(l=>l.id)]);let o=(e.floor<<20)+(e.turnNumber<<12)+(e.actionLog?.length??0)+(e.rngCounter??0),a=`skeleton_${Aa(n,o,8,"skeleton")}`;for(;s.has(a);)o+=1,a=`skeleton_${Aa(n,o,8,"skeleton")}`;return a},h1={id:"RAISE_DEAD",name:"Raise Dead",description:"Reanimate a target corpse into a Skeleton minion (Faction: Player).",slot:"utility",icon:"",baseVariables:{range:4,cost:1,cooldown:3},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!f1(e,s))return{effects:o,messages:["A corpse is required!"],consumesTurn:!1};if(!bt(n.position,s,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const u=Uy(e,n,s,"push_friendly");if(!u.ok)return{effects:o,messages:[u.failureMessage||"Target tile occupied."],consumesTurn:!1};o.push(...u.effects),a.push(...u.messages),o.push({type:"RemoveCorpse",position:s});const f=e0({companionType:"skeleton",ownerId:n.id,id:p1(e),position:s});return o.push({type:"SpawnActor",actor:f}),o.push({type:"Juice",effect:"flash",target:s,color:"#aaaaaa",metadata:{signature:"STATE.SPAWN.VOID.RAISE_DEAD",family:"status",primitive:"spawn",phase:"impact",element:"void",variant:"raise_dead",targetRef:{kind:"target_hex"},skillId:"RAISE_DEAD"}}),a.push("Skeleton raised!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>{const s=ye(e,n);return s?m1(e,n,4).filter(o=>Uy(e,s,o,"push_friendly").ok):[]},upgrades:{},scenarios:Ye("RAISE_DEAD")},y1={id:"SENTINEL_BLAST",name:"Sentinel Blast",description:"A massive energy surge from the Sentinel.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:0,damage:2},execute:(e,n,s)=>{if(!s)return{effects:[],messages:[]};const o=Oe(n),a=ye(e,s),l=_t({attackerId:n.id,targetId:a?.id||ce(s),skillId:"SENTINEL_BLAST",basePower:2,trinity:o,targetTrinity:a?Oe(a):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.2}],statusMultipliers:[]}),u=[{type:"Damage",target:s,amount:l.finalPower,scoreEvent:l.scoreEvent},{type:"Juice",effect:"shake",intensity:"high",metadata:{signature:"ATK.BLAST.ARCANE.SENTINEL_BLAST",family:"attack",primitive:"blast",phase:"impact",element:"arcane",variant:"sentinel_blast",targetRef:{kind:"target_hex"},skillId:"SENTINEL_BLAST",camera:{shake:"high"}}}];return Ue(s).forEach(p=>{const h=ye(e,p),g=_t({attackerId:n.id,targetId:h?.id||ce(p),skillId:"SENTINEL_BLAST",basePower:1,trinity:o,targetTrinity:h?Oe(h):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.1}],statusMultipliers:[]});u.push({type:"Damage",target:p,amount:g.finalPower,scoreEvent:g.scoreEvent})}),{effects:u,messages:["The Sentinel unleashed a massive blast!"],consumesTurn:!0}},getValidTargets:(e,n)=>Ie.getAreaTargets(e,n,3),upgrades:{},scenarios:Ye("SENTINEL_BLAST")},g1={id:"SENTINEL_TELEGRAPH",name:"Sentinel Telegraph",description:"The Sentinel marks an impact zone for a delayed blast.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:0},execute:(e,n,s)=>s?{effects:[{type:"Juice",effect:"combat_text",target:s,text:"TELEGRAPH",metadata:{signature:"UI.TEXT.ARCANE.SENTINEL_TELEGRAPH",family:"ui",primitive:"text",phase:"telegraph",element:"arcane",variant:"sentinel_telegraph",targetRef:{kind:"target_hex"},skillId:"SENTINEL_TELEGRAPH",textTone:"system"}}],messages:["The Sentinel marks the impact zone."],consumesTurn:!0}:{effects:[],messages:[],consumesTurn:!0},getValidTargets:(e,n)=>Ie.getAreaTargets(e,n,3),upgrades:{},scenarios:Ye("SENTINEL_TELEGRAPH")},b1={id:"SET_TRAP",name:"Set Trap",description:"Place a hidden trap. Roots units for 3 turns.",slot:"utility",icon:"",baseVariables:{range:1,cost:1,cooldown:2},execute:(e,n,s)=>{const o=[],a=[];return s?Tn(e,s)||ws(e,s)?{effects:o,messages:["Cannot place trap here!"],consumesTurn:!1}:(o.push({type:"PlaceTrap",position:s,ownerId:n.id}),o.push({type:"Juice",effect:"combat_text",target:s,text:"Trapped",metadata:{signature:"UI.TEXT.NEUTRAL.SET_TRAP",family:"ui",primitive:"text",phase:"instant",element:"neutral",variant:"set_trap",targetRef:{kind:"target_hex"},skillId:"SET_TRAP",textTone:"status"}}),a.push("Trap set."),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:a,consumesTurn:!1}},getValidTargets:(e,n)=>Ue(n).filter(s=>!Tn(e,s)&&!ws(e,s)),upgrades:{},scenarios:Ye("SET_TRAP")},S1={id:"SHADOW_STEP",name:"Shadow Step",description:"Teleport through the shadows. Only works while invisible. Extends stealth.",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:2},execute:(e,n,s)=>{const o=[],a=[];return s?(n.stealthCounter||0)>0?bt(n.position,s,2)?Tn(e,s)||ws(e,s)||Xi(e,s,n.id)?{effects:o,messages:["Cannot step there!"],consumesTurn:!1}:(o.push({type:"Displacement",target:"self",destination:s}),o.push({type:"SetStealth",target:"self",amount:2}),o.push({type:"Juice",effect:"hiddenFade",target:s,metadata:{signature:"MOVE.BLINK.SHADOW.SHADOW_STEP",family:"movement",primitive:"blink",phase:"instant",element:"shadow",variant:"shadow_step_arrival",targetRef:{kind:"target_hex"},skillId:"SHADOW_STEP"}}),a.push("Shadow stepped!"),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:["Too far!"],consumesTurn:!1}:{effects:o,messages:["Must be invisible to Shadow Step!"],consumesTurn:!1}:{effects:o,messages:a,consumesTurn:!1}},getValidTargets:(e,n)=>(e.player.stealthCounter||0)>0?Ie.getAreaTargets(e,n,2).filter(a=>Q(a,n)?!1:!Tn(e,a)&&!ws(e,a)&&!Xi(e,a)):[],upgrades:{},scenarios:Ye("SHADOW_STEP")},v1={id:"SHIELD_BASH",name:"Shield Bash",description:"Push an enemy 1 tile. If they hit a wall or another enemy, they are stunned.",slot:"defensive",icon:"",baseVariables:{range:1,cost:0,cooldown:2},execute:(e,n,s,o=[])=>{const a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};if(!n||!n.position)return{effects:a,messages:l,consumesTurn:!1};const u=o.includes("SHIELD_RANGE"),f=o.includes("ARC_BASH"),p=o.includes("BASH_360"),h=o.includes("WALL_SLAM"),g=1+(u?1:0);if(!bt(n.position,s,g))return l.push("Target out of range!"),{effects:a,messages:l,consumesTurn:!1};let b=[];if(p)b=Ue(n.position);else if(f){b=[s];const A=Ue(s);for(const _ of A)fe(_,n.position)===1&&b.length<3&&b.push(_)}else b=[s];const S=new Map;e.enemies.forEach(A=>S.set(A.id,A.position)),e.player&&S.set(e.player.id,e.player.position);const T=A=>{for(const[_,E]of Array.from(S.entries()))if(Q(E,A))return _===e.player.id?e.player:e.enemies.find(w=>w.id===_)},v=(A,_)=>{const E=T(_);if(!E||E.id===n.id)return;const w=Bn(A,_),M=wt(w),C=Vt(_,M),I=e.tiles.get(ce(C)),k=I?.baseId==="WALL"||I?.traits.has("BLOCKS_MOVEMENT"),R=!Ie.isWithinBounds(e,C),$=T(C);k||R||$&&$.id!==E.id?(a.push({type:"ApplyStatus",target:E.id,status:"stunned",duration:1}),l.push(`Bashed ${E.subtype||"enemy"} into obstacle!`),a.push({type:"Juice",effect:"shake",target:_,direction:M,intensity:"medium",metadata:{signature:"ENV.COLLISION.KINETIC.SHIELD_BASH",family:"environment",primitive:"collision",phase:"impact",element:"kinetic",variant:"shield_bash_collision",targetRef:{kind:"target_hex"},skillId:"SHIELD_BASH",camera:{shake:"medium",kick:"medium"}}}),$&&h&&v(_,C)):(a.push({type:"Displacement",target:E.id,destination:C,simulatePath:!0}),S.set(E.id,C),l.push(`Pushed ${E.subtype||"enemy"}!`))};for(const A of b)v(n.position,A);return{effects:a,messages:l}},getValidTargets:(e,n)=>{const s=ye(e,n);if(!s)return[];const a=1+(s.activeSkills?.find(l=>l.id==="SHIELD_BASH")?.activeUpgrades?.includes("SHIELD_RANGE")?1:0);return Ie.getAreaTargets(e,n,a).filter(l=>{const u=ye(e,l);return!!u&&u.id!==s.id&&u.factionId!==s.factionId})},upgrades:{SHIELD_RANGE:{id:"SHIELD_RANGE",name:"Extended Bash",description:"Range +1"},SHIELD_COOLDOWN:{id:"SHIELD_COOLDOWN",name:"Quick Recovery",description:"Cooldown -1",modifyCooldown:-1},ARC_BASH:{id:"ARC_BASH",name:"Arc Bash",description:"Bash hits 3-hex frontal arc (+1 cooldown)",modifyCooldown:1},BASH_360:{id:"BASH_360",name:"360 Bash",description:"Bash hits all neighbors (+1 cooldown)",modifyCooldown:1},PASSIVE_PROTECTION:{id:"PASSIVE_PROTECTION",name:"Passive Protection",description:"+1 temp armor when shield not on cooldown"},WALL_SLAM:{id:"WALL_SLAM",name:"Wall Slam",description:"Enemies bashed into obstacles trigger a cascade and stun"}},scenarios:Ye("SHIELD_BASH")},x1={id:"SHIELD_THROW",name:"Shield Throw",description:"Throw your shield to strike and push enemies. Triggers a kinetic pulse on impact.",slot:"defensive",icon:"",baseVariables:{range:4,cost:1,cooldown:3},execute:(e,n,s,o=[])=>{const a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};if(!e.hasShield)return l.push("Shield not in hand!"),{effects:a,messages:l,consumesTurn:!1};a.push(...ft.SHIELD_THROW.anticipation(n.position,s));const{isValid:u,blockedBy:f,blockedAt:p}=nf(e,n.position,s,{stopAtWalls:!0,stopAtActors:!0,excludeActorId:n.id});if(!u&&f==="wall")return l.push("Shield hit a wall mid-flight!"),a.push({type:"SpawnItem",itemType:"shield",position:p}),{effects:a,messages:l,consumesTurn:!0};const h=ye(e,s);if(!h)return l.push("Shield missed: No target at location."),a.push({type:"SpawnItem",itemType:"shield",position:s}),{effects:a,messages:l,consumesTurn:!0};const g=Ze(n.position,s);a.push(...ft.SHIELD_THROW.execution(g));const b=4,{directionIndex:S}=En(n.position,s),T=wt(S);a.push({type:"ApplyStatus",target:h.id,status:"stunned",duration:1}),a.push(...ft.SHIELD_THROW.impact(s,T));const v=Wl(e,{origin:s,direction:T,momentum:b}),A=v.filter(M=>M.type==="Displacement"&&M.target===h.id),_=A[A.length-1],E=_&&"destination"in _?_.destination:s,w=Ze(s,E);return w.length>1&&a.push(...ft.SHIELD_THROW.resolution(w)),a.push({type:"SpawnItem",itemType:"shield",position:E}),l.push("Direct hit! Shield triggered kinetic pulse."),{effects:[...a,...v],messages:l,consumesTurn:!0}},getValidTargets:(e,n)=>Ie.getAxialTargets(e,n,4),upgrades:{},scenarios:Ye("SHIELD_THROW")},A1={id:"SMOKE_SCREEN",name:"Smoke Screen",description:"Vanish into a cloud of smoke. Adds +2 to stealth counter.",slot:"utility",icon:"",baseVariables:{range:0,cost:0,cooldown:2},execute:(e,n,s)=>{const o=[],a=[];return o.push({type:"SetStealth",target:"self",amount:2}),o.push({type:"Juice",effect:"hiddenFade",target:n.position,metadata:{signature:"STATE.FADE.SHADOW.SMOKE_SCREEN",family:"status",primitive:"state_fade",phase:"instant",element:"shadow",variant:"smoke_screen",targetRef:{kind:"target_hex"},skillId:"SMOKE_SCREEN"}}),a.push("Smoke Screen!"),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>[n],upgrades:{},scenarios:Ye("SMOKE_SCREEN")},T1={id:"SNEAK_ATTACK",name:"Sneak Attack",description:"Attack an adjacent enemy. Deals massive damage if executed from stealth.",slot:"offensive",icon:"",baseVariables:{range:1,cost:0,cooldown:0},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};const l=Ln(e.enemies,s);if(!l)return{effects:o,messages:["No target!"],consumesTurn:!1};if(!bt(n.position,s,1))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const u=(n.stealthCounter||0)>0,f=u?3:1,p=_t({attackerId:n.id,targetId:l.id,skillId:"SNEAK_ATTACK",basePower:f,trinity:Oe(n),targetTrinity:Oe(l),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.25}],statusMultipliers:[]});return o.push({type:"Damage",target:l.id,amount:p.finalPower,reason:"sneak_attack",source:n.position,scoreEvent:p.scoreEvent}),u?(o.push({type:"Juice",effect:"flash",target:s,color:"#ff0000",metadata:{signature:"ATK.STRIKE.SHADOW.SNEAK_ATTACK",family:"attack",primitive:"strike",phase:"impact",element:"shadow",variant:"sneak_attack",targetRef:{kind:"target_hex"},skillId:"SNEAK_ATTACK",flags:{crit:!0}}}),a.push("SNEAK ATTACK!")):a.push("Sneak attack (No stealth bonus)."),{effects:o,messages:a,consumesTurn:!0}},getValidTargets:(e,n)=>Ue(n).filter(s=>!!Ln(e.enemies,s)),upgrades:{},scenarios:Ye("SNEAK_ATTACK")},E1={id:"SOUL_SWAP",name:"Soul Swap",description:"Instantly swap positions with a player-aligned minion.",slot:"utility",icon:"",baseVariables:{range:6,cost:0,cooldown:3},execute:(e,n,s)=>{const o=[],a=[];if(!s)return{effects:o,messages:a,consumesTurn:!1};if(!bt(n.position,s,6))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const l=ye(e,s);return!l||l.factionId!=="player"||l.id===n.id?{effects:o,messages:["Target must be a minion!"],consumesTurn:!1}:(o.push({type:"Displacement",target:n.id,destination:s}),o.push({type:"Displacement",target:l.id,destination:n.position}),o.push({type:"Juice",effect:"flash",target:s,color:"#330066",metadata:{signature:"MOVE.BLINK.ARCANE.SOUL_SWAP_ARRIVE",family:"movement",primitive:"blink",phase:"instant",element:"arcane",variant:"soul_swap_arrival",targetRef:{kind:"target_hex"},skillId:"SOUL_SWAP"}}),o.push({type:"Juice",effect:"flash",target:n.position,color:"#330066",metadata:{signature:"MOVE.BLINK.ARCANE.SOUL_SWAP_DEPART",family:"movement",primitive:"blink",phase:"instant",element:"arcane",variant:"soul_swap_departure",targetRef:{kind:"target_hex"},skillId:"SOUL_SWAP"}}),a.push("Soul Swapped!"),{effects:o,messages:a,consumesTurn:!0})},getValidTargets:(e,n)=>e.enemies.filter(s=>s.factionId==="player"&&bt(n,s.position,6)).map(s=>s.position),upgrades:{},scenarios:Ye("SOUL_SWAP")},_1={id:"SPEAR_THROW",name:e=>e.hasSpear?"Spear Throw":"Recall Spear",description:e=>e.hasSpear?"Throw your spear to instantly kill an enemy.":"Recall your spear, damaging enemies in its path.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:0,damage:1},execute:(e,n,s,o=[])=>{const a=[],l=[],u=Oe(n),f=o.includes("SPEAR_RANGE"),p=o.includes("RECALL"),h=o.includes("RECALL_DAMAGE"),g=o.includes("LUNGE"),b=o.includes("LUNGE_ARC"),S=o.includes("DEEP_BREATH"),T=o.includes("SPEAR_CLEAVE")||o.includes("CLEAVE"),v=3+(f?1:0);if(e.hasSpear){if(!s)return{effects:a,messages:l,consumesTurn:!1};if(g&&fe(n.position,s)===2){const C=ye(e,s);if(C&&C.id!==n.id){const I=_t({attackerId:n.id,targetId:C.id,skillId:"SPEAR_THROW",basePower:99,trinity:u,targetTrinity:Oe(C),damageClass:"physical",scaling:[{attribute:"body",coefficient:.1},{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});return a.push({type:"Displacement",target:"self",destination:s,simulatePath:!0}),a.push({type:"Damage",target:C.id,amount:I.finalPower,scoreEvent:I.scoreEvent}),l.push(`Lunged and killed ${C.subtype||"enemy"} !`),b&&Ue(s).forEach(k=>{const R=ye(e,k);if(R&&R.id!==n.id&&R.id!==C.id){const $=_t({attackerId:n.id,targetId:R.id,skillId:"SPEAR_THROW",basePower:1,trinity:u,targetTrinity:Oe(R),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.15}],statusMultipliers:[]});a.push({type:"Damage",target:R.id,amount:$.finalPower,scoreEvent:$.scoreEvent})}}),S&&a.push({type:"ModifyCooldown",skillId:"JUMP",amount:0,setExact:!0}),{effects:a,messages:l}}}if(!bt(n.position,s,v))return l.push("Out of range!"),{effects:a,messages:l,consumesTurn:!1};const A=Ln(e.enemies,s);if(!A)return l.push("No enemy at target."),{effects:a,messages:l,consumesTurn:!1};if(!En(n.position,s).isAxial)return l.push("Target must be axial."),{effects:a,messages:l,consumesTurn:!1};if(!Bl(e,n.position,s,A.id,n.id))return l.push("No clear line of sight to enemy."),{effects:a,messages:l,consumesTurn:!1};a.push(...ft.SPEAR_THROW.anticipation(n.position,s));const w=s,M=A;if(a.push(...ft.SPEAR_THROW.execution(Ze(n.position,w))),M){const C=_t({attackerId:n.id,targetId:M.id,skillId:"SPEAR_THROW",basePower:99,trinity:u,targetTrinity:Oe(M),damageClass:"physical",scaling:[{attribute:"body",coefficient:.1},{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});a.push(...ft.SPEAR_THROW.impact(w,!0)),a.push({type:"Damage",target:M.id,amount:C.finalPower,scoreEvent:C.scoreEvent}),l.push(`Spear killed ${M.subtype||"enemy"} !`),S&&a.push({type:"ModifyCooldown",skillId:"JUMP",amount:0,setExact:!0})}else a.push(...ft.SPEAR_THROW.impact(w,!1)),l.push("Spear thrown.");a.push({type:"SpawnItem",itemType:"spear",position:w}),p&&(a.push({type:"PickupSpear",position:w}),l.push("Spear auto-retrieved."))}else{const A=e.spearPosition;if(!A)return l.push("Spear is lost!"),{effects:a,messages:l,consumesTurn:!1};const _=Ze(A,n.position);if(h&&_.forEach(E=>{const w=Ln(e.enemies,E);if(w){const M=_t({attackerId:n.id,targetId:w.id,skillId:"SPEAR_THROW",basePower:1,trinity:u,targetTrinity:Oe(w),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.15}],statusMultipliers:[]});a.push({type:"Damage",target:w.id,amount:M.finalPower,scoreEvent:M.scoreEvent}),l.push(`Spear recall hit ${w.subtype||"enemy"} !`)}}),a.push({type:"PickupSpear",position:A}),l.push("Spear recalled."),T){for(const E of Ue(A)){const w=Ln(e.enemies,E);if(!w)continue;const M=_t({attackerId:n.id,targetId:w.id,skillId:"SPEAR_THROW",basePower:1,trinity:u,targetTrinity:Oe(w),damageClass:"physical",scaling:[{attribute:"body",coefficient:.1}],statusMultipliers:[]});a.push({type:"Damage",target:w.id,amount:M.finalPower,scoreEvent:M.scoreEvent})}l.push("Cleave triggered on pickup.")}a.push({type:"Juice",effect:"spearTrail",path:_,intensity:"medium",metadata:{signature:"ATK.SHOOT.PHYSICAL.SPEAR_RETURN",family:"attack",primitive:"shoot",phase:"travel",element:"physical",variant:"spear_return",sourceRef:{kind:"source_hex"},targetRef:{kind:"target_hex"},skillId:"SPEAR_THROW"}})}return{effects:a,messages:l}},getValidTargets:(e,n)=>{if(!e.hasSpear)return[];const s=ye(e,n);if(!s)return[];const l=3+(s.activeSkills?.find(f=>f.id==="SPEAR_THROW")?.activeUpgrades?.includes("SPEAR_RANGE")?1:0);return e.enemies.filter(f=>f.hp>0).filter(f=>{const p=f.position;return!En(n,p).isAxial||!bt(n,p,l)?!1:Bl(e,n,p,f.id,s.id)}).map(f=>f.position)},upgrades:{SPEAR_RANGE:{id:"SPEAR_RANGE",name:"Extended Reach",description:"Range +1"},RECALL:{id:"RECALL",name:"Recall",description:"Spear automatically returns (handled internally if active, or via manual recall)"},RECALL_DAMAGE:{id:"RECALL_DAMAGE",name:"Returning Edge",description:"Damage enemies in path when recalling spear"},LUNGE:{id:"LUNGE",name:"Lunge",description:"If an enemy is exactly 2 hexes away, move to them and kill"},LUNGE_ARC:{id:"LUNGE_ARC",name:"Lunge Sweeping",description:"Lunge hits neighbors of the target"},DEEP_BREATH:{id:"DEEP_BREATH",name:"Deep Breath",description:"Reset Jump cooldown on spear kill"},SPEAR_CLEAVE:{id:"SPEAR_CLEAVE",name:"Cleave",description:"Damage all neighbors when picking up spear"}},scenarios:Ye("SPEAR_THROW")},w1={id:"SWIFT_ROLL",name:"Swift Roll",description:"Quickly dodge 2 tiles. Passive: Automatically roll away from attackers when hit.",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:2},execute:(e,n,s)=>{const o=[],a=[];return s?bt(n.position,s,2)?Tn(e,s)||ws(e,s)||Xi(e,s,n.id)?{effects:o,messages:["Cannot roll there!"],consumesTurn:!1}:(o.push({type:"Displacement",target:"self",destination:s}),o.push({type:"Juice",effect:"dashBlur",target:s,path:[n.position,s],metadata:{signature:"MOVE.DASH.NEUTRAL.SWIFT_ROLL",family:"movement",primitive:"dash",phase:"travel",element:"neutral",variant:"swift_roll",sourceRef:{kind:"source_hex"},targetRef:{kind:"target_hex"},skillId:"SWIFT_ROLL"}}),a.push("Swift roll!"),{effects:o,messages:a,consumesTurn:!0}):{effects:o,messages:["Too far!"],consumesTurn:!1}:{effects:o,messages:a,consumesTurn:!1}},getValidTargets:(e,n)=>Ie.getAreaTargets(e,n,2).filter(o=>Q(o,n)?!1:!Tn(e,o)&&!ws(e,o)&&!Xi(e,o)),upgrades:{},scenarios:Ye("SWIFT_ROLL")},M1={id:"THEME_HAZARDS",name:"Theme Hazards",description:"Internal skill for testing floor themes.",slot:"passive",icon:"",baseVariables:{range:0,cost:0,cooldown:0},execute:e=>({effects:[],messages:[]}),upgrades:{},scenarios:Ye("THEME_HAZARDS")},C1={id:"TIME_BOMB",name:"Time Bomb",description:"Detonates when the fuse reaches zero.",slot:"passive",icon:"",baseVariables:{range:0,cost:0,cooldown:0,damage:1},execute:(e,n,s)=>{const o=n.statusEffects.find(f=>f.type==="time_bomb");if(o&&o.duration>1)return{effects:[],messages:[],consumesTurn:!0};const a=n.position,u=[a,...Ue(a)].map(f=>({type:"Damage",target:f,amount:1,reason:"bomb_explosion"}));return u.push({type:"Damage",target:n.id,amount:999,reason:"bomb_explosion"}),u.push({type:"Juice",effect:"explosion_ring",target:a,intensity:"high",metadata:{signature:"ATK.BLAST.FIRE.TIME_BOMB",family:"attack",primitive:"blast",phase:"impact",element:"fire",variant:"time_bomb",targetRef:{kind:"target_hex"},skillId:"TIME_BOMB"}}),{effects:u,messages:["A bomb exploded!"],consumesTurn:!0}},getValidTargets:(e,n)=>[n],upgrades:{}},O1={id:"VAULT",name:e=>e.turnNumber%2!==0?"Stun Vault":"Vault",description:e=>e.turnNumber%2!==0?"Leap to an empty tile and stun neighbors. (Odd Turn)":"Leap to an empty tile. (Even Turn)",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:0},execute:(e,n,s,o=[])=>{const a=[],l=[];if(!s)return{effects:a,messages:l,consumesTurn:!1};if(!bt(n.position,s,2))return l.push("Out of range!"),{effects:a,messages:l,consumesTurn:!1};if(Tn(e,s)||Xi(e,s))return l.push("Blocked!"),{effects:a,messages:l,consumesTurn:!1};if(!pi(e,n,s))return l.push("Blocked!"),{effects:a,messages:l,consumesTurn:!1};const u=e.turnNumber%2!==0;a.push(...ft.VAULT.anticipation(n.position,s));const f=Ze(n.position,s);if(a.push(...ft.VAULT.execution(f)),a.push({type:"Displacement",target:"self",destination:s,path:f,ignoreGroundHazards:!0,animationDuration:250}),u){l.push("Stun Vault executed!");const p=Ue(s);for(const h of p)Ln(e.enemies,h)&&a.push({type:"ApplyStatus",target:h,status:"stunned",duration:1});a.push(...ft.VAULT.impact(s,!0)),l.push("Slam landing! Neighbors stunned.")}else a.push(...ft.VAULT.impact(s,!1)),l.push("Vaulted!");return{effects:a,messages:l}},getValidTargets:(e,n)=>{const o=ye(e,n);return o?Ie.getAreaTargets(e,n,2).filter(a=>Q(a,n)?!1:!Tn(e,a)&&!Xi(e,a)&&pi(e,o,a)):[]},upgrades:{},scenarios:[{id:"vault_shift_stun",title:"Vault State-Shifting: Stun (Turn 1)",description:"Verify vault stuns on Turn 1 (Odd).",setup:e=>{e.setTurn(1),e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>{e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,n)=>n.some(s=>s.includes("Stun Vault executed!"))},{id:"vault_shift_normal",title:"Vault State-Shifting: Normal (Turn 2)",description:"Verify vault is normal on Turn 2 (Even).",setup:e=>{e.setTurn(2),e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>{e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,n)=>n.some(s=>s.includes("Vaulted!"))&&!n.some(s=>s.includes("Slam landing!"))}]},$y=1,qy=1,N1=1,y0=2,k1=2;function R1(e,n,s,o=y0){const a=Bn(s,n);if(a===-1)return null;const l=wt(a);for(let f=o;f>=N1;f--){let p=n,h=!0;for(let g=0;g<f;g++){if(p=Vt(p,l),!Ie.isWithinBounds(e,p)){h=!1;break}if(!Me.isWalkable(e,p)){h=!1;break}}if(h&&!ye(e,p))return p}const u=[(a+1)%6,(a+5)%6];for(const f of u){const p=wt(f);let h=Vt(n,p);if(Ie.isWithinBounds(e,h)&&Me.isWalkable(e,h)&&!ye(e,h))return h}return null}const I1={id:"WITHDRAWAL",name:"Withdrawal",description:"Quick shot + tactical backroll. Auto-triggers when enemies close in.",slot:"utility",icon:"",baseVariables:{range:$y,cost:0,cooldown:k1,damage:qy},execute:(e,n,s,o=[])=>{const a=[],l=[],u=o.includes("PARTING_SHOT"),f=o.includes("NIMBLE_FEET");if(!s)return{effects:a,messages:["No target!"],consumesTurn:!1};if(fe(n.position,s)>$y)return{effects:a,messages:["Target out of range!"],consumesTurn:!1};const h=ye(e,s);if(!h)return{effects:a,messages:["No enemy at target!"],consumesTurn:!1};if(h.factionId===n.factionId)return{effects:a,messages:["Cannot target allies!"],consumesTurn:!1};const g=_t({attackerId:n.id,targetId:h.id,skillId:"WITHDRAWAL",basePower:qy+(u?1:0),trinity:Oe(n),targetTrinity:Oe(h),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});a.push({type:"Damage",target:h.id,amount:g.finalPower,scoreEvent:g.scoreEvent}),a.push({type:"Juice",effect:"impact",target:s,metadata:{signature:"ATK.SHOOT.PHYSICAL.WITHDRAWAL",family:"attack",primitive:"shoot",phase:"impact",element:"physical",variant:"withdrawal_shot",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_hex"},skillId:"WITHDRAWAL"}}),l.push(`Withdrawal shot hits ${h.subtype||"enemy"}!`);const b=f?3:y0,S=R1(e,n.position,s,b);return S?(a.push({type:"Displacement",target:"self",destination:S,source:n.position}),a.push({type:"Juice",effect:"dashBlur",target:S,path:[n.position,S],metadata:{signature:"MOVE.DASH.NEUTRAL.WITHDRAWAL_BACKROLL",family:"movement",primitive:"dash",phase:"travel",element:"neutral",variant:"withdrawal_backroll",sourceRef:{kind:"source_actor"},targetRef:{kind:"target_hex"},skillId:"WITHDRAWAL"}}),l.push("Backroll!")):l.push("No safe retreat available!"),{effects:a,messages:l,consumesTurn:!0}},getValidTargets:(e,n)=>Ue(n).filter(s=>{const o=ye(e,s);return o&&o.factionId==="enemy"}),upgrades:{PARTING_SHOT:{id:"PARTING_SHOT",name:"Parting Shot",description:"Withdrawal deals +1 damage."},NIMBLE_FEET:{id:"NIMBLE_FEET",name:"Nimble Feet",description:"Backroll distance increased to 3 hexes."},HAIR_TRIGGER:{id:"HAIR_TRIGGER",name:"Hair Trigger",description:"Passive reaction does not consume cooldown."}},scenarios:Ye("WITHDRAWAL")},L1={ABSORB_FIRE:zx,ARCHER_SHOT:PA,AUTO_ATTACK:c0,BASIC_ATTACK:CT,BASIC_MOVE:RT,BOMB_TOSS:IT,BULWARK_CHARGE:LT,CORPSE_EXPLOSION:PT,DASH:UT,FALCON_APEX_STRIKE:$T,FALCON_AUTO_ROOST:qT,FALCON_COMMAND:zT,FALCON_HEAL:VT,FALCON_PECK:YT,FALCON_SCOUT:KT,FIREBALL:WT,FIREWALK:GT,FIREWALL:XT,GRAPPLE_HOOK:e1,JUMP:t1,KINETIC_TRI_TRAP:r1,MULTI_SHOOT:l1,RAISE_DEAD:h1,SENTINEL_BLAST:y1,SENTINEL_TELEGRAPH:g1,SET_TRAP:b1,SHADOW_STEP:S1,SHIELD_BASH:v1,SHIELD_THROW:x1,SMOKE_SCREEN:A1,SNEAK_ATTACK:T1,SOUL_SWAP:E1,SPEAR_THROW:_1,SWIFT_ROLL:w1,THEME_HAZARDS:M1,TIME_BOMB:C1,VAULT:O1,WITHDRAWAL:I1},Gl=L1,ll=qx(Gl);if(ll.missing.length>0||ll.invalid.length>0){const e=ll.missing.join(", "),n=ll.invalid.map(s=>`${s.skillId}: ${s.errors.join("; ")}`).join(" | ");throw new Error(`Skill intent profile validation failed. missing=[${e}] invalid=[${n}]`)}const va=()=>({...Gl,...Hx()});function zi(e){const s=va()[e];return s?{id:e,name:s.name,description:typeof s.description=="function"?s.description({}):s.description,slot:s.slot,cooldown:s.baseVariables.cooldown||0,currentCooldown:0,range:s.baseVariables.range||0,upgrades:Object.keys(s.upgrades||{}),activeUpgrades:[]}:null}function B1(){return[zi("BASIC_MOVE"),zi("BASIC_ATTACK"),zi("AUTO_ATTACK"),zi("SPEAR_THROW"),zi("SHIELD_BASH"),zi("JUMP")].filter(Boolean)}const H1={...Gl,get:e=>va()[e],getAllUpgrades:()=>{const e=va();return Object.values(e).flatMap(n=>Object.values(n.upgrades||{}).map(s=>({...s,skillId:n.id})))},getUpgrade:e=>{const n=va();for(const s of Object.values(n))if(s.upgrades?.[e])return s.upgrades[e]},getSkillForUpgrade:e=>{const n=va();for(const[s,o]of Object.entries(n))if(o.upgrades?.[e])return s},getSkillRange:(e,n)=>{const s=(e.activeSkills||[]).find(l=>l.id===n),o=va()[n];if(!o)return s?.range||0;let a=o.baseVariables.range;return s?.activeUpgrades&&s.activeUpgrades.forEach(l=>{const u=o.upgrades[l];u?.modifyRange&&(a+=u.modifyRange)}),a}},st=H1,P1=st.getSkillRange,j1=e=>st.get(e),D1={VANGUARD:{id:"VANGUARD",name:"Vanguard",description:"Direct damage, brawling, and area denial.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","AUTO_ATTACK","SPEAR_THROW","SHIELD_BASH","JUMP"]},SKIRMISHER:{id:"SKIRMISHER",name:"Skirmisher",description:"Zero direct damage. Kinetic momentum and environmental lethality.",startingUpgrades:[],startingSkills:["DASH","GRAPPLE_HOOK","SHIELD_THROW","VAULT"]},FIREMAGE:{id:"FIREMAGE",name:"Fire Mage",description:"Area control with fire and high-damage spells.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","ABSORB_FIRE","FIREBALL","FIREWALL","FIREWALK"]},NECROMANCER:{id:"NECROMANCER",name:"Necromancer",description:"Utilize death and reanimation.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","CORPSE_EXPLOSION","RAISE_DEAD","SOUL_SWAP"]},HUNTER:{id:"HUNTER",name:"Hunter",description:"Ranged precision and traps.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","FALCON_COMMAND","KINETIC_TRI_TRAP","WITHDRAWAL"]},ASSASSIN:{id:"ASSASSIN",name:"Assassin",description:"Stealth and high burst damage.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","SNEAK_ATTACK","SMOKE_SCREEN","SHADOW_STEP"]}};class U1 extends Error{issues;constructor(n){super(`Loadout validation failed:
${n.map(s=>`${s.path}: ${s.message}`).join(`
`)}`),this.name="LoadoutValidationError",this.issues=n}}const zd=e=>typeof e=="object"&&e!==null&&!Array.isArray(e),Ho=e=>typeof e=="string",mi=(e,n,s)=>e.push({path:n,message:s}),zy=(e,n,s,o={})=>{if(!Array.isArray(e)){mi(n,s,"Expected array");return}const a=new Set;e.forEach((l,u)=>{if(!Ho(l)||l.length===0){mi(n,`${s}[${u}]`,"Expected non-empty string");return}o.unique&&(a.has(l)&&mi(n,`${s}[${u}]`,`Duplicate "${l}"`),a.add(l))})},$1=(e,n="$")=>{const s=[];return zd(e)?((!Ho(e.id)||e.id.length===0)&&mi(s,`${n}.id`,"Expected non-empty string"),(!Ho(e.name)||e.name.length===0)&&mi(s,`${n}.name`,"Expected non-empty string"),Ho(e.description)||mi(s,`${n}.description`,"Expected string"),zy(e.startingUpgrades,s,`${n}.startingUpgrades`,{unique:!0}),zy(e.startingSkills,s,`${n}.startingSkills`,{unique:!0}),s):(mi(s,n,"Expected object"),s)},q1=e=>{const n=[];if(!zd(e))return mi(n,"$","Expected loadout catalog object"),n;for(const[s,o]of Object.entries(e)){const a=$1(o,`$.${s}`);n.push(...a),zd(o)&&Ho(o.id)&&o.id!==s&&mi(n,`$.${s}.id`,`Must match catalog key "${s}"`)}return n},z1=e=>{const n=q1(e);if(n.length>0)throw new U1(n);return e},V1=e=>Object.fromEntries(Object.entries(e).map(([n,s])=>[n,{...s,startingUpgrades:[...s.startingUpgrades],startingSkills:[...s.startingSkills]}])),Y1=z1(D1),Vn=V1(Y1);let Vy=!1;const K1=(e=Vn)=>{const n=[];for(const[s,o]of Object.entries(e)){for(const a of o.startingSkills)st.get(a)||n.push({loadoutId:s,field:"startingSkills",value:a,message:`Unknown skill "${a}"`});for(const a of o.startingUpgrades)st.getUpgrade(a)||n.push({loadoutId:s,field:"startingUpgrades",value:a,message:`Unknown upgrade "${a}"`})}return n},g0=()=>{if(Vy)return Object.keys(Vn).length;const e=K1(Vn);if(e.length>0){const n=e.map(s=>`${s.loadoutId}.${s.field}: ${s.message}`).join(" | ");throw new Error(`Default loadout validation failed: ${n}`)}return Vy=!0,Object.keys(Vn).length};g0();const b0=e=>{const n=e.startingSkills.map(o=>zi(o)).filter(Boolean),s=e.id;return{upgrades:[...e.startingUpgrades],activeSkills:n,archetype:s}},F1=e=>e.some(n=>n.id==="BASIC_MOVE"||n.id==="DASH"),S0=(e=[])=>{if(F1(e))return e;const n=zi("BASIC_MOVE");return n?[n,...e]:e},of=e=>{const n=e.activeSkills||[],s=S0(n);return s===n?e:{...e,activeSkills:s}};let v0=!1;const W1=(e=Ay)=>{const n=sx(e);e===Ay&&Nv(n);const s=g0();return dx(n.units),Bx(n.skills),v0=!0,{unitsRegistered:n.units.length,skillsRegistered:n.skills.length,loadoutsValidated:s}},x0=()=>v0?{unitsRegistered:0,skillsRegistered:0,loadoutsValidated:0}:W1(),A0=(e,n="none")=>n==="floor"?Math.floor(e):n==="round"?Math.round(e):n==="ceil"?Math.ceil(e):e,T0=(e,n)=>n?Math.max(n.min,Math.min(n.max,e)):e,cl=(e,n)=>T0(A0(e,n.round),n.clamp),G1=(e,n)=>{if(e.method==="fixed")return{value:cl(e.value,e),before:-1,after:-1,usedRng:!1};if(e.method==="uniform_int"){const u=n(),f=e.max-e.min+1,p=e.min+Math.floor(u.value*f)%Math.max(1,f);return{value:cl(p,e),before:u.before,after:u.after,usedRng:!0}}if(e.method==="triangular_int"){const u=n(),f=e.min,p=e.mode,h=e.max,g=(p-f)/Math.max(1e-9,h-f),b=u.value<g?f+Math.sqrt(u.value*(h-f)*(p-f)):h-Math.sqrt((1-u.value)*(h-f)*(h-p));return{value:cl(b,e),before:u.before,after:u.after,usedRng:!0}}const s=n(),o=e.table.reduce((u,f)=>u+f.weight,0);let a=s.value*Math.max(1e-9,o),l=e.table[e.table.length-1].value;for(const u of e.table)if(a-=u.weight,a<=0){l=u.value;break}return{value:cl(l,e),before:s.before,after:s.after,usedRng:!0}},Yy=(e,n,s)=>{if(e.formula==="trinity_hp_v1")return Fl(s);const o=e.base??0,l=(e.terms||[]).reduce((f,p)=>f+(n[p.stat]??0)*p.coefficient,o),u=A0(l,e.round);return T0(u,e.clamp)},X1=(e,n)=>!n||Object.keys(n).length===0?e:{...e,activeSkills:(e.activeSkills||[]).map(s=>{const o=n[s.id];return o===void 0?s:{...s,currentCooldown:Math.max(0,o)}})},J1=e=>e.id.toLowerCase(),Q1=(e,n,s)=>{const o=n.definition,a=[];let l={rngSeed:e.rngSeed||"default",rngCounter:Math.max(0,e.rngCounter||0)},u=0;const f=`${l.rngSeed}:${o.instantiate.rngStream}:${o.instantiate.seedSalt||o.id}`,p=()=>{if(o.instantiate.counterMode==="consume_global"){const C=l.rngCounter,I=Il(l.rngSeed,C);return l={...l,rngCounter:C+1},{value:I,before:C,after:l.rngCounter}}const w=u;return{value:Il(f,u++),before:w,after:u}},h={};for(const w of n.drawOrder){const M=o.propensities[w];if(!M)continue;const C=G1(M,p);h[w]=C.value,C.usedRng&&a.push({key:w,method:M.method,value:C.value,counterBefore:C.before,counterAfter:C.after})}const g={body:h.body??0,mind:h.mind??0,instinct:h.instinct??0},b=o.derivedStats||{},S=b.maxHp?Yy(b.maxHp,h,g):Fl(g),T=h.speed??1,v=h.mass??1,A=o.runtimeDefaults?.startingHp==="explicit"?Math.max(0,o.runtimeDefaults.explicitHp??S):S,_=Wi({id:s.actorId||J1(o),type:o.actorType,subtype:s.subtype||o.subtype,position:s.position,hp:A,maxHp:S,speed:T,factionId:s.factionId||o.factionId,weightClass:o.weightClass,skills:[...n.skillIds,...n.passiveSkillIds],trinity:g});let E=X1(_,o.skillLoadout.startCooldowns);o.runtimeDefaults?.temporaryArmor!==void 0&&(E={...E,temporaryArmor:Math.max(0,o.runtimeDefaults.temporaryArmor)}),o.runtimeDefaults?.isVisible!==void 0&&(E={...E,isVisible:o.runtimeDefaults.isVisible}),h.maxHp=S,h.speed=T,h.mass=v;for(const[w,M]of Object.entries(b))w!=="maxHp"&&(h[w]=Yy(M,h,g));return{actor:E,stats:h,trinity:g,speed:T,mass:v,nextCursor:l,rollTrace:a}},Z1=(e,n,s)=>Q1(e,ax(n),s),eE=(e,n)=>{const s=Kl(n),o=Sv(Cl,Ol),a=[],l=o,u=Math.floor(Cl/2),f=Ft(u,Ol-1),p=Ft(u,0);let h;if(e%1===0){const M=l.filter(C=>!Q(C,f)&&!Q(C,p)&&fe(C,f)>=3);M.length>0&&(h=M[Math.floor(s.next()*M.length)])}const b=Math.floor(l.length*xv),S=[],T={playerStart:f,stairsPosition:p,shrinePosition:h},A=[...l.filter(M=>!Sy(M,T))].sort(()=>s.next()-.5);for(let M=0;M<b;M++)M<A.length&&S.push(A[M]);const _=l.filter(M=>!Sy(M,{playerStart:f,stairsPosition:p,shrinePosition:h})&&!a.some(C=>Q(C,M))&&!S.some(C=>Q(C,M))&&fe(M,f)>=3),E={id:"arena",type:"combat",center:Ft(Math.floor(Cl/2),Math.floor(Ol/2)),hexes:o,connections:[]},w=new Map;for(const M of o)w.set(`${M.q},${M.r}`,{baseId:"STONE",position:M,traits:new Set(xa.STONE.defaultTraits),effects:[]});for(const M of a)w.set(`${M.q},${M.r}`,{baseId:"WALL",position:M,traits:new Set(xa.WALL.defaultTraits),effects:[]});for(const M of S)w.set(`${M.q},${M.r}`,{baseId:"LAVA",position:M,traits:new Set(xa.LAVA.defaultTraits),effects:[]});return{rooms:[E],allHexes:o,stairsPosition:p,shrinePosition:h,spawnPositions:_,playerSpawn:f,tiles:w}},tE=(e,n,s)=>{x0();const o=Kl(s+":enemies"),a=Cv(e),l=a.budget,u=a.allowedSubtypes;let f={rngSeed:`${s}:enemy-propensity`,rngCounter:0};const p=[];let h=l;const g=[];for(;h>0&&g.length<n.length;){const b=u.filter(D=>{const q=Ll(D);return!!q&&q.bestiary.stats.cost<=h});if(b.length===0)break;const S=Math.floor(o.next()*b.length),T=b[S],v=Ll(T);if(!v)break;const A=v.bestiary.stats,_=n.filter(D=>!g.some(q=>Q(q,D)));if(_.length===0)break;const E=Math.floor(o.next()*_.length),w=_[E];g.push(w);const M=Math.floor(e/5),C=A.weightClass||"Standard",I=(f.rngCounter<<8)+p.length,k=`enemy_${p.length}_${Aa(s,I,6,T)}`,R=fx(T);let $;if(R){const D=Z1(f,R,{actorId:k,position:w,subtype:T,factionId:"enemy"});f=D.nextCursor,$=D.actor}else $=Xv({id:k,subtype:T,position:w,speed:A.speed||1,skills:yy(T,{source:"runtime",includePassive:!0}).length>0?yy(T,{source:"runtime",includePassive:!0}):Qv(T),weightClass:C,enemyType:A.type});const j=M>0?{...$,hp:$.hp+M,maxHp:$.maxHp+M}:$;p.push({...j,subtype:T,enemyType:A.type,actionCooldown:A.actionCooldown??j.actionCooldown,isVisible:!0}),h-=A.cost}return p},nE=e=>Av[e]||"inferno",iE=(e,n)=>{const s=n.initialSeed??n.rngSeed??"0",o=n.commandLog?.length??0;return{id:Aa(s,o,9,"cmd"),timestamp:n.turnNumber,action:e}},sE=(e,n,s)=>{const o=s.initialSeed??s.rngSeed??"0",a=s.undoStack?.length??0;return{id:Aa(o,a,9,"delta"),undoData:{player:{...e.player},enemies:[...e.enemies],turnNumber:e.turnNumber,gameStatus:e.gameStatus}}},aE=(e,n,s,o)=>{const a=(e.pendingFrames?.length??0)+1;return{id:`${e.turnNumber}:${s}:${n}:${a}`,type:n,status:s,createdTurn:e.turnNumber,blocking:!0,payload:o}},oE=(e,n,s,o)=>{const a=aE(e,s,n.status,o);return{...e,pendingStatus:n,pendingFrames:[...e.pendingFrames||[],a]}};function rE(e){let n=e;const s=[],o=[],a=new Map(n.tiles);for(const[l,u]of a.entries()){const f=[];let p=!1;for(const b of u.effects){if(b.duration===-1){f.push(b);continue}const S=b.duration-1;S>0?(f.push({...b,duration:S}),p=!0):(s.push(`The ${b.id.toLowerCase()} died down.`),p=!0)}p&&a.set(l,{...u,effects:f});const h=[n.player,...n.enemies],g=b=>`${b.q},${b.r}`;for(const b of h)if(g(b.position)===l){const S=Ts.processStay(b,u,n);o.push(...S.effects),s.push(...S.messages)}}return n={...n,tiles:a},o.length>0&&(n=Hn(n,o)),{state:n,messages:s}}const lE=e=>(Array.isArray(e.tiles)&&(e.tiles=new Map(e.tiles.map(([n,s])=>[n,{...s,traits:new Set(s.traits)}]))),e.player=of(Lo(e.player)),e.enemies=(e.enemies||[]).map(Lo),e.companions&&(e.companions=e.companions.map(Lo)),e),cE=(e,n)=>{if(!(e.pendingStatus?.shrineOptions||e.shrineOptions||[]).includes(n))return{...e,message:it(e.message,`Upgrade ${n} was not offered.`,"CRITICAL","SYSTEM")};let o=e.player,a=!1;const l=st.getUpgrade(n);if(l){const u=st.getSkillForUpgrade(n),f=!!u&&o.activeSkills.some(p=>p.id===u);if(u&&f){const p=JSON.stringify(o.activeSkills);o=$A(o,u,n),a=JSON.stringify(o.activeSkills)!==p}}else n==="EXTRA_HP"&&(o=DA(o,1,!0),a=!0);return!a&&n!=="EXTRA_HP"?{...e,message:it(e.message,`Upgrade ${n} could not be applied.`,"CRITICAL","SYSTEM")}:{...e,player:o,upgrades:e.upgrades.includes(n)?e.upgrades:[...e.upgrades,n],gameStatus:"playing",shrinePosition:void 0,shrineOptions:void 0,pendingStatus:void 0,pendingFrames:void 0,message:it(e.message,`Gained ${l?.name||n}!`,"INFO","OBJECTIVE")}},uE=(e,n)=>{const s=e.pendingFrames||[];if(s.length>1)return{...e,pendingFrames:s.slice(1)};if(!e.pendingStatus)return s.length===1?{...e,pendingFrames:[]}:e;const{status:o,shrineOptions:a,completedRun:l}=e.pendingStatus;if(o==="playing"&&e.gameStatus==="playing"){const u=e.initialSeed??e.rngSeed??"0",f=`${u}:${e.floor+1}`,p=e.enemies.filter(g=>g.hp>0&&g.factionId==="player"&&g.companionOf===e.player.id).sort((g,b)=>g.id.localeCompare(b.id)),h=n.generateInitialState(e.floor+1,f,u,{...e.player,hp:Math.min(e.player.maxHp,e.player.hp+1),upgrades:e.upgrades});if(p.length>0){const g=[h.player.position,...Ue(h.player.position)],b=[h.player,...h.enemies],S=[];for(let T=0;T<p.length;T++){const v=p[T],A=g[g.length-1]||h.player.position,_=g.find(w=>!b.some(C=>Q(C.position,w))&&Me.isWalkable(h,w))||A,E={...v,position:_,previousPosition:_};b.push(E),S.push(E)}h.enemies=[...h.enemies,...S],h.companions=[...h.companions||[],...S.filter(T=>T.companionOf===e.player.id)],h.initiativeQueue=Ms(h),h.occupancyMask=Ie.refreshOccupancyMask(h)}return{...h,actionLog:[...e.actionLog||[]],dailyRunDate:e.dailyRunDate,runObjectives:e.runObjectives,hazardBreaches:e.hazardBreaches||0,pendingFrames:void 0}}return{...e,gameStatus:o,shrineOptions:a||e.shrineOptions,completedRun:l||e.completedRun,pendingStatus:void 0,pendingFrames:void 0}},dE=(e,n,s)=>{let o=e;const a=[],l=o.player.position;if(o.spearPosition&&Q(l,o.spearPosition)){if(!!o.player.activeSkills?.find(h=>h.id==="SPEAR_THROW")?.activeUpgrades?.some(h=>h==="SPEAR_CLEAVE"||h==="CLEAVE")){const h=Ue(l).map(g=>o.enemies.find(b=>b.hp>0&&Q(b.position,g))).filter(g=>!!g&&g.factionId!==o.player.factionId);if(h.length>0){const g=h.map(b=>({type:"Damage",target:b.id,amount:1,reason:"spear_cleave_pickup"}));o=Hn(o,g,{sourceId:o.player.id,stepId:n}),a.push(`Spear cleave hit ${h.length} target(s).`)}}o={...o,hasSpear:!0,spearPosition:void 0,message:it(o.message,"Picked up your spear.","INFO","OBJECTIVE")}}const u=rE(o);if(o=u.state,a.push(...u.messages),o={...o,turnNumber:o.turnNumber+1,turnsSpent:(o.turnsSpent||0)+1},o.traps&&o.traps.length>0&&(o={...o,traps:o.traps.map(f=>({...f,cooldown:Math.max(0,f.cooldown-1)}))}),o=NT(o),Rv(o,o.player.position)){const f=o.player.activeSkills||[],p=new Set(f.map(v=>v.id)),h=new Map;for(const v of f)h.set(v.id,new Set(v.activeUpgrades||[]));const g=st.getAllUpgrades().filter(v=>p.has(v.skillId)).filter(v=>{if(o.upgrades.includes(v.id))return!1;const A=h.get(v.skillId);return!A||!A.has(v.id)}).map(v=>v.id).filter((v,A,_)=>_.indexOf(v)===A),b=[];let S={...o};for(let v=0;v<3&&g.length>0;v++){const A=In(S);S=A.nextState;const _=Math.floor(A.value*g.length);b.push(g[_]),g.splice(_,1)}const T=b.length>0?b:["EXTRA_HP"];return{state:s.withPendingFrame({...o,rngCounter:S.rngCounter,message:it(o.message,"A holy shrine! Choose an upgrade.","INFO","OBJECTIVE")},{status:"choosing_upgrade",shrineOptions:T},"SHRINE_CHOICE",{shrineOptions:T}),messages:a,haltTurnLoop:!0}}if(Iv(o,o.player.position)){if(o.floor>=10){const p=jo(o);return{state:s.withPendingFrame({...o,message:it(o.message,`Arcade Cleared! Final Score: ${p.score}`,"INFO","OBJECTIVE")},{status:"won",completedRun:p},"RUN_WON",{score:p.score??0}),messages:a,haltTurnLoop:!0}}return{state:s.withPendingFrame({...o,message:it(o.message,"Descending to the next level...","INFO","OBJECTIVE")},{status:"playing"},"STAIRS_TRANSITION",{nextFloor:o.floor+1}),messages:a,haltTurnLoop:!0}}return{state:o,messages:a,haltTurnLoop:!1}},Vd=(e,n)=>{const s={},o={},a={},l=Array.from(new Set([...Object.keys(e),...Object.keys(n)])).sort();let u=0;for(const f of l){const p=Number(e[f]||0),h=Number(n[f]||0),g=p*h;s[f]=p,o[f]=h,a[f]=g,u+=g}return{total:u,features:s,weights:o,contributions:a}};var E0={};const Ky=4.5,fE="HOP_ENEMY_AI_DYNAMIC_INTENT_BIAS_STRENGTH",Ed={offense:0,positioning:0,control:0,defense:0},kl=(e,n,s)=>Math.max(n,Math.min(s,e)),Co=(e,n,s=1)=>{e.offense+=(n.offense||0)*s,e.positioning+=(n.positioning||0)*s,e.control+=(n.control||0)*s,e.defense+=(n.defense||0)*s},mE={damage:{offense:.22,control:.02},move:{positioning:.24,offense:.04},heal:{defense:.24,control:.04},protect:{defense:.2,control:.06},control:{control:.25,positioning:.06},summon:{control:.14,defense:.08},hazard:{control:.14,offense:.1},objective:{positioning:.08,control:.12},economy:{defense:.08,control:.08},utility:{positioning:.08,control:.1}},pE=e=>{const n=String(e||"").toUpperCase(),s=new Set;return/(ATTACK|THROW|BLAST|FIREBALL|BASH|PECK|EXPLOSION|SPEAR|SHOOT|DASH)/.test(n)&&s.add("damage"),/(MOVE|DASH|JUMP|ROLL|VAULT|STEP|GRAPPLE|WITHDRAWAL|WALK|TELEPORT)/.test(n)&&s.add("move"),/(HEAL|ABSORB)/.test(n)&&s.add("heal"),/(SHIELD|PROTECT|BULWARK)/.test(n)&&s.add("protect"),/(STUN|TRAP|SMOKE|TELEGRAPH|ROOT|SWAP|SCOUT)/.test(n)&&s.add("control"),/(RAISE|SUMMON|FALCON)/.test(n)&&s.add("summon"),/(FIRE|LAVA|HAZARD|BOMB|EXPLOSION)/.test(n)&&s.add("hazard"),s.size===0&&s.add("utility"),[...s]},hE=e=>{const s=st.get(e)?.intentProfile;return s?.intentTags&&s.intentTags.length>0?s.intentTags:pE(e)},Fy=(e,n)=>{const s={offense:Math.max(0,e.offense),positioning:Math.max(0,e.positioning),control:Math.max(0,e.control),defense:Math.max(0,e.defense)},o=s.offense+s.positioning+s.control+s.defense;if(o<=n||o<=0)return s;const a=n/o;return{offense:s.offense*a,positioning:s.positioning*a,control:s.control*a,defense:s.defense*a}},Hl=()=>{if(typeof process>"u")return!1;const e=E0?.HOP_ENEMY_AI_DYNAMIC_INTENT_BIAS;return e==="1"||e==="true"},rf=()=>{if(typeof process>"u")return 1;const e=E0?.[fE];if(!e)return 1;const n=Number(e);return Number.isFinite(n)?kl(n,0,8):1},_0=(e,n)=>{if(!Hl())return{...Ed};const s=rf();if(s<=0)return{...Ed};const o={...Ed},a=Oe(e.enemy),l=kl(Number(a.body||0),0,24),u=kl(Number(a.mind||0),0,24),f=kl(Number(a.instinct||0),0,24);Co(o,{offense:l*.06+f*.015,defense:l*.018+u*.028,control:u*.06,positioning:f*.055+Math.max(0,Number(e.enemy.speed||1)-1)*.06});for(const g of e.enemy.activeSkills||[]){const b=String(g.id),S=hE(b);for(const _ of S)Co(o,mE[_]||{});const T=st.get(g.id),v=Number(T?.intentProfile?.target?.range??g.range??0);v>=3?Co(o,{positioning:.08,control:.04}):v<=1&&Co(o,{offense:.05});const A=Number(T?.intentProfile?.economy?.cooldown??g.cooldown??0);A>0&&Co(o,{defense:.02,control:.015},Math.min(3,A))}const p=Fy(o,Ky);if(s===1)return p;const h={offense:p.offense*s,positioning:p.positioning*s,control:p.control*s,defense:p.defense*s};return Fy(h,Ky*Math.max(1,s))},Wy=["offense","control","positioning","defense"],yE=e=>{const n=fe(e.enemy.position,e.playerPos);return{dist_to_player:n,adjacent_to_player:n===1?1:0,hostile_hidden:(e.state.player.stealthCounter||0)>0?1:0,enemy_hp:Number(e.enemy.hp||0),enemy_action_cooldown:Number(e.enemy.actionCooldown||0)}},w0=(e,n)=>{if(n===void 0)return 0;if(typeof n=="number")return e===n?1:0;const[s,o]=n;return e>=s&&e<=o?1:0},M0=(e,n)=>{if(n===void 0)return 0;if(typeof n=="number")return Math.abs(e-n);const[s,o]=n;return e<s?s-e:e>o?e-o:0},gE=(e,n)=>{const s=n.action.type,o=String(n.action.skillId||"").toUpperCase(),a=String(e.planned.entity.intent||"").toUpperCase();return a==="SEARCHING"||a==="PREPARING"||a==="SENTINEL_TELEGRAPH"||o==="SENTINEL_TELEGRAPH"?"control":s==="MOVE"||a==="MOVING"||a==="ADVANCING"||a==="REPOSITIONING"||a==="LUMBERING"?"positioning":s==="WAIT"||a==="WAITING"||a==="IDLE"?"defense":"offense"},bE=(e,n)=>{const s=fe(e.enemy.position,e.playerPos),o=n.subtype||e.enemy.subtype||"default",a=o==="archer"||o==="warlock"||o==="bomber",l=w0(s,n.preferredRange)===1,u=M0(s,n.preferredRange),f=Number(e.enemy.actionCooldown||0),p=(e.state.player.stealthCounter||0)>0,h=e.enemy.position.q===e.playerPos.q||e.enemy.position.r===e.playerPos.r||e.enemy.position.s===e.playerPos.s;let g=0,b=0,S=0,T=0;a?(g+=l?1.25:.55,b+=l?.35:1.15):(g+=s<=1?1.5:.6,b+=s>1?1.2:.2),b+=Math.min(3,u)*.35,f>0&&(T+=.8,S+=.3,g-=.15),p&&(S+=1.4,T+=.3,g-=.4),o==="sentinel"&&(S+=1.3,s<=3&&(g+=.6)),(o==="warlock"||o==="bomber")&&(b+=.5),(o==="raider"||o==="pouncer")&&h&&s>=2&&s<=4&&(S+=.45,g+=.45);const v=_0(e);return g+=v.offense,b+=v.positioning,S+=v.control,T+=v.defense,{offense:Math.max(0,g),positioning:Math.max(0,b),control:Math.max(0,S),defense:Math.max(0,T)}},SE=e=>{let n=Wy[0];for(const s of Wy)e[s]>e[n]&&(n=s);return n},vE=(e,n,s,o)=>{const a=yE(e),l=fe(e.enemy.position,e.playerPos),u=fe(n.planned.entity.position,e.playerPos),f=Q(n.planned.entity.position,e.enemy.position)?0:1,p=s.action.type,h=s.action.skillId||"",g=Number(n.planned.entity.actionCooldown||0)-Number(e.enemy.actionCooldown||0),b=o.subtype==="sentinel",S=b&&l<=3,T=b&&e.state.turnNumber%2===0,v=b&&!T,A=h==="SENTINEL_TELEGRAPH",_=h==="SENTINEL_BLAST",E=e.enemy.position.q===e.playerPos.q||e.enemy.position.r===e.playerPos.r||e.enemy.position.s===e.playerPos.s,w=h==="DASH",M=h==="GRAPPLE_HOOK",C=h==="ARCHER_SHOT"||h==="SPEAR_THROW",I=h==="BOMB_TOSS",k=s.action.targetHex,R=k&&fe(k,e.playerPos)===1?1:0,$=k&&Q(k,e.playerPos)?1:0,j=o.subtype;return{...a,candidate_pre_score:Number(n.preScore||0),is_wait_action:p==="WAIT"?1:0,is_move_action:p==="MOVE"?1:0,is_attack_action:p==="ATTACK"?1:0,is_skill_action:p==="USE_SKILL"?1:0,moved:f,dist_before:l,dist_after:u,dist_delta_toward_player:l-u,preferred_range_match:w0(u,o.preferredRange),has_target_hex:s.action.targetHex?1:0,target_adjacent_to_player:R,target_is_player_tile:$,uses_signature_skill:o.subtype==="sentinel"&&(h==="SENTINEL_BLAST"||h==="SENTINEL_TELEGRAPH")?1:0,raider_dash_window_match:j==="raider"&&E&&l>=2&&l<=4&&w?1:0,pouncer_hook_window_match:j==="pouncer"&&E&&l>=2&&l<=4&&M?1:0,archer_ranged_window_match:j==="archer"&&l>1&&C?1:0,archer_melee_window_match:j==="archer"&&l===1&&h==="BASIC_ATTACK"?1:0,bomber_bomb_window_match:j==="bomber"&&(e.enemy.actionCooldown??0)===0&&l>=2&&l<=3&&I?1:0,bomber_bomb_target_valid_shape:j==="bomber"&&I&&R===1&&$===0?1:0,bomber_reposition_candidate:j==="bomber"&&n.id==="bomber-reposition"?1:0,sentinel_phase_telegraph_match:S&&T&&A?1:0,sentinel_phase_execute_match:S&&v&&_?1:0,sentinel_phase_mismatch:S&&(T&&_||v&&A)?1:0,cooldown_delta_positive:g>0?1:0,rng_consumption:Number(s.rngConsumption||0),message_present:n.planned.message?1:0}},xE=(e,n,s,o)=>{const a=bE(e,o),l=gE(n,s),u=SE(a),f=fe(e.enemy.position,e.playerPos),p=M0(f,o.preferredRange),h=(e.state.player.stealthCounter||0)>0;return{intent_is_offense:l==="offense"?1:0,intent_is_positioning:l==="positioning"?1:0,intent_is_control:l==="control"?1:0,intent_is_defense:l==="defense"?1:0,intent_desire_offense:a.offense,intent_desire_positioning:a.positioning,intent_desire_control:a.control,intent_desire_defense:a.defense,intent_selected_desire:a[l],intent_dominant_match:l===u?1:0,intent_preferred_range_gap:p,intent_player_hidden:h?1:0}},Gy={id:"enemy-default-policy-v1",tags:["policy-v1"]},AE={sprinter:{id:"enemy-sprinter-policy-v1",subtype:"sprinter",preferredRange:1,tags:["policy-v1","melee"]},shieldBearer:{id:"enemy-shieldBearer-policy-v1",subtype:"shieldBearer",preferredRange:1,tags:["policy-v1","melee"]},warlock:{id:"enemy-warlock-policy-v1",subtype:"warlock",preferredRange:[2,4],tags:["policy-v1","ranged","teleport"]},sentinel:{id:"enemy-sentinel-policy-v1",subtype:"sentinel",preferredRange:3,tags:["policy-v1","playlist"]},raider:{id:"enemy-raider-policy-v1",subtype:"raider",preferredRange:[1,4],tags:["policy-v1","dash"]},pouncer:{id:"enemy-pouncer-policy-v1",subtype:"pouncer",preferredRange:[1,4],tags:["policy-v1","grapple"]},archer:{id:"enemy-archer-policy-v1",subtype:"archer",preferredRange:[2,4],tags:["policy-v1","ranged"]},bomber:{id:"enemy-bomber-policy-v1",subtype:"bomber",preferredRange:[2,3],tags:["policy-v1","ranged","aoe"]},assassin:{id:"enemy-assassin-policy-v1",subtype:"assassin",preferredRange:1,tags:["policy-v1","stealth"]},golem:{id:"enemy-golem-policy-v1",subtype:"golem",preferredRange:[1,3],tags:["policy-v1","heavy"]}},TE=e=>e?AE[e]||{...Gy,id:`enemy-${e}-policy-v1`,subtype:e}:Gy,Pl=(e,n)=>{const s=n.q-e.q,o=n.r-e.r;return s>0&&o===0?0:s>0&&o<0?1:s===0&&o<0?2:s<0&&o===0?3:s<0&&o>0?4:5},ct=(e,n,s,o=[],a)=>{if(wT(e))return{position:e.position,state:s};const l=Ie.getNeighbors(e.position);let u=[],f=a!==void 0?Math.abs(fe(e.position,n)-a):fe(e.position,n);for(const b of l){if(!Ie.isWithinBounds(s,b))continue;const S=s.tiles.get(ce(b)),T=S?.traits.has("BLOCKS_LOS")||S?.baseId==="WALL",v=o.some(w=>Q(w,b))||s.enemies.some(w=>w.id!==e.id&&Q(w.position,b))||Q(b,n);if(T||v)continue;const A=S?Ts.getMovementCost(s,S):1,E=(a!==void 0?Math.abs(fe(b,n)-a):fe(b,n))+(A-1);E<f?(f=E,u=[b]):E===f&&u.push(b)}if(u.length===0)return{position:e.position,state:s};if(u.length===1)return{position:u[0],state:s};const{value:p,nextState:h}=In(s),g=Math.floor(p*u.length)%u.length;return{position:u[g],state:h}},EE=(e,n,s)=>{if(fe(e.position,n)===1)return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...n}},nextState:s};let a=e.position,l=s;for(let f=0;f<2&&!(fe(a,n)<=1);f++){const p={...e,position:a},{position:h,state:g}=ct(p,n,l,s.occupiedCurrentTurn);a=h,l=g}const u=!Q(a,e.position);return{entity:{...e,position:a,intent:u?"Moving":"BASIC_ATTACK",intentPosition:u?void 0:{...n}},nextState:l,message:u?`${e.subtype} moves to (${a.q}, ${a.r})`:void 0}},_E=(e,n,s)=>{const o=fe(e.position,n),a=Pl(e.position,n);if(o===1)return{entity:{...e,facing:a,intent:"BASIC_ATTACK",intentPosition:{...n}},nextState:s};const{position:l,state:u}=ct(e,n,s,s.occupiedCurrentTurn),f=!Q(l,e.position);return{entity:{...e,position:l,facing:f?Pl(e.position,l):a,intent:f?"Advancing":"BASIC_ATTACK",intentPosition:f?void 0:{...n}},nextState:u,message:f?`${e.subtype} advances to (${l.q}, ${l.r})`:void 0}},wE=(e,n,s)=>{const o=fe(e.position,n);let a=s;const{value:l,nextState:u}=In(a);a=u;let f=e.position;if(o<=2||l<.3){const{value:b,nextState:S}=In(a);a=S;const{value:T,nextState:v}=In(a);a=v;const A=Math.floor(b*6),_=3+Math.floor(T*3);let E=e.position;for(let M=0;M<_;M++)E=Vt(E,wt(A));!Ie.isWithinBounds(s,E)||!Me.isWalkable(s,E)||s.occupiedCurrentTurn?.some(M=>Q(M,E))||s.enemies.some(M=>M.id!==e.id&&Q(M.position,E))||Q(E,n)||(f=E)}const p=!Q(f,e.position),h=fe(f,n),g=!p&&h>=2&&h<=4;return{entity:{...e,position:f,intent:p?"Repositioning":g?"Casting":"Preparing",intentPosition:g?{...n}:void 0},nextState:a,message:p?`${e.subtype} teleports to (${f.q}, ${f.r})`:void 0}},ME=(e,n,s)=>{const o=fe(e.position,n);if(o===1)return{entity:{...e,isVisible:!0,intent:"BASIC_ATTACK",intentPosition:{...n}},nextState:s};const{position:a,state:l}=ct(e,n,s,s.occupiedCurrentTurn),u=!Q(a,e.position);return{entity:{...e,position:a,isVisible:u?!1:o<=1,intent:u?"Moving":"BASIC_ATTACK",intentPosition:u?void 0:{...n}},nextState:l,message:u?"You hear footsteps nearby...":void 0}},CE={sentinel:{telegraphSkillId:"SENTINEL_TELEGRAPH",executeSkillId:"SENTINEL_BLAST",triggerRange:3,telegraphMessage:"The Sentinel marks the blast zone..."}},OE=(e,n,s,o)=>{const l=fe(e.position,n)<=o.triggerRange,u=s.turnNumber%2===0,f=!u;if(l&&f&&Ji(e))return{entity:{...e,intent:"Preparing",intentPosition:void 0},nextState:s,message:`${e.subtype} loses focus!`};if(l&&u)return{entity:{...e,intent:o.telegraphSkillId,intentPosition:{...n}},nextState:s,message:o.telegraphMessage};if(l&&f)return{entity:{...e,intent:o.executeSkillId,intentPosition:{...n}},nextState:s};const{position:p,state:h}=ct(e,n,s,s.occupiedCurrentTurn);return{entity:{...e,position:p,intent:"Moving",intentPosition:void 0},nextState:h}},NE=(e,n,s)=>{const o=e.actionCooldown??0;if(o>0)return{entity:{...e,actionCooldown:o-1,intent:"Charging Power"},nextState:s};const a=fe(e.position,n);if(a>=1&&a<=3)return{entity:{...e,actionCooldown:2,intent:"BASIC_ATTACK",intentPosition:{...n}},nextState:s};const{position:l,state:u}=ct(e,n,s,s.occupiedCurrentTurn),f=!Q(l,e.position);return{entity:{...e,position:l,intent:f?"Lumbering":"Waiting",actionCooldown:0},nextState:u,message:f?`${e.subtype} lumbers to (${l.q}, ${l.r})`:void 0}},kE=(e,n,s)=>{const o=fe(e.position,n);if(o>4){const{position:g,state:b}=ct(e,n,s,s.occupiedCurrentTurn),S=!Q(g,e.position);return{entity:{...e,position:g,intent:S?"Following":"Waiting"},nextState:b,message:S?`${e.subtype} follows you.`:void 0}}const a=s.enemies.filter(g=>g.factionId==="enemy").sort((g,b)=>fe(e.position,g.position)-fe(e.position,b.position))[0];if(!a){if(o>1){const{position:g,state:b}=ct(e,n,s,s.occupiedCurrentTurn);return{entity:{...e,position:g,intent:"Idle"},nextState:b}}return{entity:{...e,intent:"Idle"},nextState:s}}if(fe(e.position,a.position)===1)return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...a.position}},nextState:s};const{position:u,state:f}=ct(e,a.position,s,s.occupiedCurrentTurn),p=!Q(u,e.position),h=fe(u,a.position);return{entity:{...e,position:u,intent:p?"Advancing":h===1?"BASIC_ATTACK":"Waiting",intentPosition:p||h>1?void 0:{...a.position}},nextState:f,message:p?`${e.subtype} attacks ${a.subtype}!`:void 0}},RE=(e,n,s)=>{const o=fe(e.position,n);if((e.position.q===n.q||e.position.r===n.r||e.position.s===n.s)&&o>=2&&o<=4)return{entity:{...e,intent:"DASH",intentPosition:{...n}},nextState:s};const{position:l,state:u}=ct(e,n,s,s.occupiedCurrentTurn),f=!Q(l,e.position),p=fe(l,n);return{entity:{...e,position:l,intent:f?"Moving":p===1?"BASIC_ATTACK":"Waiting",intentPosition:f||p>1?void 0:{...n}},nextState:u,message:f?`${e.subtype} moves to (${l.q}, ${l.r})`:void 0}},IE=(e,n,s)=>{const o=fe(e.position,n);if((e.position.q===n.q||e.position.r===n.r||e.position.s===n.s)&&o>=2&&o<=4)return{entity:{...e,intent:"GRAPPLE_HOOK",intentPosition:{...n}},nextState:s};const{position:l,state:u}=ct(e,n,s,s.occupiedCurrentTurn),f=!Q(l,e.position);return{entity:{...e,position:l,intent:f?"Moving":"Waiting",intentPosition:void 0},nextState:u,message:f?`${e.subtype} moves to (${l.q}, ${l.r})`:void 0}},LE=(e,n,s)=>{const o=fe(e.position,n),a=e.activeSkills?.some(g=>g.id==="ARCHER_SHOT")?"ARCHER_SHOT":"SPEAR_THROW",l=st.get(a);if(o>1&&!!l?.getValidTargets&&l.getValidTargets(s,e.position).some(g=>Q(g,n)))return{entity:{...e,intent:a,intentPosition:{...n}},nextState:s};if(o===1&&e.activeSkills?.some(g=>g.id==="BASIC_ATTACK"))return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...n}},nextState:s};const{position:f,state:p}=ct(e,n,s,s.occupiedCurrentTurn),h=!Q(f,e.position);return{entity:{...e,position:f,intent:h?"Moving":"Idle",intentPosition:void 0},nextState:p,message:h?`${e.subtype} moves to (${f.q}, ${f.r})`:void 0}},BE=(e,n,s)=>{const o=fe(e.position,n),a=e.actionCooldown??0;if(a===0&&o>=2&&o<=3){const h=Ie.getNeighbors(n).filter(g=>{const b=!Me.isWalkable(s,g),S=s.enemies.some(T=>Q(T.position,g));return Ie.isWithinBounds(s,g)&&!b&&!S&&!Q(g,n)});if(h.length>0){const{value:g,nextState:b}=In(s),S=Math.floor(g*h.length)%h.length,T=h[S];return{entity:{...e,intent:"Bombing",intentPosition:T,actionCooldown:2},nextState:b}}}const{position:u,state:f}=ct(e,n,s,s.occupiedCurrentTurn,2.5),p=!Q(u,e.position);return{entity:{...e,position:u,intent:p?"Moving":"Waiting",intentPosition:void 0,actionCooldown:Math.max(0,a-1)},nextState:f,message:p?`${e.subtype} repositioning to (${u.q}, ${u.r})`:void 0}},HE=(e,n,s)=>{if(fe(e.position,n)===1)return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...n}},nextState:s};const{position:a,state:l}=ct(e,n,s,s.occupiedCurrentTurn),u=!Q(a,e.position),f=fe(a,n);return{entity:{...e,position:a,intent:u?"Moving":f===1?"BASIC_ATTACK":"Waiting",intentPosition:u||f>1?void 0:{...n}},nextState:l,message:u?`${e.subtype} moves to (${a.q}, ${a.r})`:void 0}},PE={sprinter:EE,shieldBearer:_E,warlock:wE,assassin:ME,golem:NE,sentinel:(e,n,s)=>OE(e,n,s,CE.sentinel),raider:RE,pouncer:IE,archer:LE,bomber:BE},Xy=e=>{const{enemy:n,playerPos:s,state:o}=e;if(n.factionId==="player")return kE(n,s,o);if((o.player.stealthCounter||0)>0)return{entity:{...n,intent:"Searching",intentPosition:void 0},nextState:o};const l=n.subtype?PE[n.subtype]:void 0;return l?l(n,s,o):HE(n,s,o)},Jy=e=>{const n=e.planned.entity;return[e.source,String(n.intent||"Waiting"),ce(n.position),n.intentPosition?ce(n.intentPosition):"none",String(n.actionCooldown??"none"),String(n.facing??"none"),String(n.isVisible??"none"),String(e.planned.nextState.rngCounter||0),String(e.planned.message||"")].join("::")},Qy=(e,n)=>e.q===n.q||e.r===n.r||e.s===n.s,vs=(e,n)=>!!e.activeSkills?.some(s=>s.id===n),jE=new Set(["sprinter","shieldBearer","warlock","assassin","golem","sentinel","raider","pouncer","archer","bomber"]),DE=(e,n={})=>{const s=[],o=n.includePolicyExact===!0,a=v=>{const A=Jy(v);s.some(_=>Jy(_)===A)||s.push(v)};if(o){const v=Xy({enemy:e.enemy,playerPos:e.playerPos,state:e.state});a({id:"policy-exact",source:"policy_exact",reasoningCode:"POLICY_EXACT",preScore:0,planned:v})}if(e.enemy.factionId==="player"){const v=Xy({enemy:e.enemy,playerPos:e.playerPos,state:e.state});return a({id:"minion-policy-shape",source:"synthetic",reasoningCode:"SYN_MINION_POLICY_SHAPE",preScore:10,planned:v}),s}a({id:"wait",source:"synthetic",reasoningCode:"SYN_WAIT",preScore:-10,planned:{entity:{...e.enemy,intent:"Waiting",intentPosition:void 0},nextState:e.state}});const l=fe(e.enemy.position,e.playerPos),u=e.enemy.subtype||"default",f=!jE.has(u),h=!!e.enemy.activeSkills?.some(v=>v.id==="BASIC_ATTACK")||f;if(l===1&&h&&a({id:"basic-attack",source:"synthetic",reasoningCode:"SYN_BASIC_ATTACK",preScore:5,planned:{entity:{...e.enemy,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}}),f&&l>1){const{position:v,state:A}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),_=!Q(v,e.enemy.position),E=fe(v,e.playerPos);a({id:"default-move",source:"synthetic",reasoningCode:"SYN_DEFAULT_MOVE",preScore:0,planned:{entity:{...e.enemy,position:v,intent:_?"Moving":E===1?"BASIC_ATTACK":"Waiting",intentPosition:_||E>1?void 0:{...e.playerPos}},nextState:A,message:_?`${e.enemy.subtype} moves to (${v.q}, ${v.r})`:void 0}})}if(u==="sprinter"&&l>1){let v=e.enemy.position,A=e.state;for(let E=0;E<2&&!(fe(v,e.playerPos)<=1);E++){const w={...e.enemy,position:v},{position:M,state:C}=ct(w,e.playerPos,A,e.state.occupiedCurrentTurn);v=M,A=C}const _=!Q(v,e.enemy.position);a({id:"sprinter-move",source:"synthetic",reasoningCode:"SYN_SPRINTER_MOVE",preScore:0,planned:{entity:{...e.enemy,position:v,intent:_?"Moving":"BASIC_ATTACK",intentPosition:_?void 0:{...e.playerPos}},nextState:A,message:_?`${e.enemy.subtype} moves to (${v.q}, ${v.r})`:void 0}})}if(u==="shieldBearer"){const v=Pl(e.enemy.position,e.playerPos);if(l===1)a({id:"shieldbearer-attack-facing",source:"synthetic",reasoningCode:"SYN_SHIELDBEARER_ATTACK",preScore:0,planned:{entity:{...e.enemy,facing:v,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}});else{const{position:A,state:_}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),E=!Q(A,e.enemy.position);a({id:"shieldbearer-advance",source:"synthetic",reasoningCode:"SYN_SHIELDBEARER_ADVANCE",preScore:0,planned:{entity:{...e.enemy,position:A,facing:E?Pl(e.enemy.position,A):v,intent:E?"Advancing":"BASIC_ATTACK",intentPosition:E?void 0:{...e.playerPos}},nextState:_,message:E?`${e.enemy.subtype} advances to (${A.q}, ${A.r})`:void 0}})}}if(u==="assassin")if(l===1)a({id:"assassin-attack",source:"synthetic",reasoningCode:"SYN_ASSASSIN_ATTACK",preScore:0,planned:{entity:{...e.enemy,isVisible:!0,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}});else{const{position:v,state:A}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),_=!Q(v,e.enemy.position);a({id:"assassin-move",source:"synthetic",reasoningCode:"SYN_ASSASSIN_MOVE",preScore:0,planned:{entity:{...e.enemy,position:v,isVisible:_?!1:l<=1,intent:_?"Moving":"BASIC_ATTACK",intentPosition:_?void 0:{...e.playerPos}},nextState:A,message:_?"You hear footsteps nearby...":void 0}})}if(u==="golem"){const v=e.enemy.actionCooldown??0;if(v>0)a({id:"golem-charging",source:"synthetic",reasoningCode:"SYN_GOLEM_CHARGING",preScore:0,planned:{entity:{...e.enemy,actionCooldown:v-1,intent:"Charging Power"},nextState:e.state}});else if(l>=1&&l<=3)a({id:"golem-attack",source:"synthetic",reasoningCode:"SYN_GOLEM_ATTACK",preScore:0,planned:{entity:{...e.enemy,actionCooldown:2,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}});else{const{position:A,state:_}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),E=!Q(A,e.enemy.position);a({id:"golem-lumbering",source:"synthetic",reasoningCode:"SYN_GOLEM_LUMBERING",preScore:0,planned:{entity:{...e.enemy,position:A,intent:E?"Lumbering":"Waiting",actionCooldown:0},nextState:_,message:E?`${e.enemy.subtype} lumbers to (${A.q}, ${A.r})`:void 0}})}}if(u==="sentinel"){const v=l<=3,A=e.state.turnNumber%2===0,_=!A;if(v&&_&&Ji(e.enemy))a({id:"sentinel-preparing-stunned",source:"synthetic",reasoningCode:"SYN_SENTINEL_STUNNED_PREPARING",preScore:0,planned:{entity:{...e.enemy,intent:"Preparing",intentPosition:void 0},nextState:e.state,message:`${e.enemy.subtype} loses focus!`}});else if(v&&A)a({id:"sentinel-telegraph",source:"synthetic",reasoningCode:"SYN_SENTINEL_TELEGRAPH",preScore:0,planned:{entity:{...e.enemy,intent:"SENTINEL_TELEGRAPH",intentPosition:{...e.playerPos}},nextState:e.state,message:"The Sentinel marks the blast zone..."}});else if(v&&_)a({id:"sentinel-blast",source:"synthetic",reasoningCode:"SYN_SENTINEL_BLAST",preScore:0,planned:{entity:{...e.enemy,intent:"SENTINEL_BLAST",intentPosition:{...e.playerPos}},nextState:e.state}});else{const{position:E,state:w}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn);a({id:"sentinel-move",source:"synthetic",reasoningCode:"SYN_SENTINEL_MOVE",preScore:0,planned:{entity:{...e.enemy,position:E,intent:"Moving",intentPosition:void 0},nextState:w}})}}if(u==="warlock"){let v=e.state;const{value:A,nextState:_}=In(v);v=_;let E=e.enemy.position;if(l<=2||A<.3){const{value:I,nextState:k}=In(v);v=k;const{value:R,nextState:$}=In(v);v=$;const j=Math.floor(I*6),D=3+Math.floor(R*3);let q=e.enemy.position;for(let ee=0;ee<D;ee++)q=Vt(q,wt(j));!Ie.isWithinBounds(e.state,q)||!Me.isWalkable(e.state,q)||e.state.occupiedCurrentTurn?.some(ee=>Q(ee,q))||e.state.enemies.some(ee=>ee.id!==e.enemy.id&&Q(ee.position,q))||Q(q,e.playerPos)||(E=q)}const w=!Q(E,e.enemy.position),M=fe(E,e.playerPos),C=!w&&M>=2&&M<=4;a({id:"warlock-policy-like",source:"synthetic",reasoningCode:"SYN_WARLOCK_POLICY",preScore:0,planned:{entity:{...e.enemy,position:E,intent:w?"Repositioning":C?"Casting":"Preparing",intentPosition:C?{...e.playerPos}:void 0},nextState:v,message:w?`${e.enemy.subtype} teleports to (${E.q}, ${E.r})`:void 0}})}const g=u==="raider"&&vs(e.enemy,"DASH")&&Qy(e.enemy.position,e.playerPos)&&l>=2&&l<=4;if(g&&a({id:"raider-dash",source:"synthetic",reasoningCode:"SYN_RAIDER_DASH_WINDOW",preScore:0,planned:{entity:{...e.enemy,intent:"DASH",intentPosition:{...e.playerPos}},nextState:e.state}}),u==="raider"&&!g){const{position:v,state:A}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),_=!Q(v,e.enemy.position),E=fe(v,e.playerPos);a({id:"raider-move",source:"synthetic",reasoningCode:"SYN_RAIDER_MOVE",preScore:0,planned:{entity:{...e.enemy,position:v,intent:_?"Moving":E===1?"BASIC_ATTACK":"Waiting",intentPosition:_||E>1?void 0:{...e.playerPos}},nextState:A,message:_?`${e.enemy.subtype} moves to (${v.q}, ${v.r})`:void 0}})}const b=u==="pouncer"&&vs(e.enemy,"GRAPPLE_HOOK")&&Qy(e.enemy.position,e.playerPos)&&l>=2&&l<=4;if(b&&a({id:"pouncer-grapple",source:"synthetic",reasoningCode:"SYN_POUNCER_HOOK_WINDOW",preScore:0,planned:{entity:{...e.enemy,intent:"GRAPPLE_HOOK",intentPosition:{...e.playerPos}},nextState:e.state}}),u==="pouncer"&&!b){const{position:v,state:A}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),_=!Q(v,e.enemy.position);a({id:"pouncer-move",source:"synthetic",reasoningCode:"SYN_POUNCER_MOVE",preScore:0,planned:{entity:{...e.enemy,position:v,intent:_?"Moving":"Waiting",intentPosition:void 0},nextState:A,message:_?`${e.enemy.subtype} moves to (${v.q}, ${v.r})`:void 0}})}if(u==="archer"){const v=vs(e.enemy,"ARCHER_SHOT")?"ARCHER_SHOT":vs(e.enemy,"SPEAR_THROW")?"SPEAR_THROW":void 0;let A=!1;if(v){const E=st.get(v);A=l>1&&!!E?.getValidTargets&&E.getValidTargets(e.state,e.enemy.position).some(w=>Q(w,e.playerPos)),A&&a({id:`archer-ranged-${v}`,source:"synthetic",reasoningCode:"SYN_ARCHER_RANGED_WINDOW",preScore:0,planned:{entity:{...e.enemy,intent:v,intentPosition:{...e.playerPos}},nextState:e.state}})}const _=l===1&&vs(e.enemy,"BASIC_ATTACK");if(l===1&&vs(e.enemy,"BASIC_ATTACK")&&a({id:"archer-melee-fallback",source:"synthetic",reasoningCode:"SYN_ARCHER_MELEE_FALLBACK",preScore:0,planned:{entity:{...e.enemy,intent:"BASIC_ATTACK",intentPosition:{...e.playerPos}},nextState:e.state}}),!A&&!_){const{position:E,state:w}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn),M=!Q(E,e.enemy.position);a({id:"archer-move",source:"synthetic",reasoningCode:"SYN_ARCHER_MOVE",preScore:0,planned:{entity:{...e.enemy,position:E,intent:M?"Moving":"Idle",intentPosition:void 0},nextState:w,message:M?`${e.enemy.subtype} moves to (${E.q}, ${E.r})`:void 0}})}}if(u==="bomber"&&vs(e.enemy,"BOMB_TOSS")){const v=e.enemy.actionCooldown??0,A=l>=2&&l<=3;if(v===0&&A){const M=Ie.getNeighbors(e.playerPos).filter(C=>{const I=!Me.isWalkable(e.state,C),k=e.state.enemies.some(R=>Q(R.position,C));return Ie.isWithinBounds(e.state,C)&&!I&&!k&&!Q(C,e.playerPos)});if(M.length>0){const{value:C,nextState:I}=In(e.state),k=Math.floor(C*M.length)%M.length,R=M[k];a({id:"bomber-bomb-window",source:"synthetic",reasoningCode:"SYN_BOMBER_BOMB_WINDOW",preScore:0,planned:{entity:{...e.enemy,intent:"Bombing",intentPosition:R,actionCooldown:2},nextState:I}})}}const{position:_,state:E}=ct(e.enemy,e.playerPos,e.state,e.state.occupiedCurrentTurn,2.5),w=!Q(_,e.enemy.position);a({id:"bomber-reposition",source:"synthetic",reasoningCode:"SYN_BOMBER_REPOSITION",preScore:0,planned:{entity:{...e.enemy,position:_,intent:w?"Moving":"Waiting",intentPosition:void 0,actionCooldown:Math.max(0,v-1)},nextState:E,message:w?`${e.enemy.subtype} repositioning to (${_.q}, ${_.r})`:void 0}})}const S={},T=e.enemy.subtype?S[e.enemy.subtype]:void 0;for(const v of e.enemy.activeSkills||[]){if(v.id==="AUTO_ATTACK"||v.id==="BASIC_MOVE"||v.id==="BASIC_ATTACK"||!T?.has(String(v.id)))continue;const A=st.get(v.id);A&&(A.getValidTargets&&!A.getValidTargets(e.state,e.enemy.position).some(_=>Q(_,e.playerPos))||a({id:`skill-${v.id}`,source:"synthetic",reasoningCode:`SYN_SKILL_${v.id}`,preScore:1,planned:{entity:{...e.enemy,intent:String(v.id),intentPosition:{...e.playerPos}},nextState:e.state}}))}return s},C0=(e,n,s)=>{if(!s)return;const o=e.player.position.q===s.q&&e.player.position.r===s.r?e.player:e.enemies.find(a=>a.position.q===s.q&&a.position.r===s.r);if(o&&o.factionId!==n.factionId)return o.id},UE=(e,n,s,o)=>{const a=n.intentPosition;return s==="Moving"||s==="Advancing"||s==="Repositioning"||s==="Lumbering"||s==="Following"?{type:"MOVE",skillId:"BASIC_MOVE",targetHex:n.position}:s==="BASIC_ATTACK"?{type:"ATTACK",skillId:"BASIC_ATTACK",targetHex:a,primaryTargetId:C0(o,e,a)}:s==="SPEAR_THROW"?{type:"USE_SKILL",skillId:"SPEAR_THROW",targetHex:a}:s==="ARCHER_SHOT"?{type:"USE_SKILL",skillId:"ARCHER_SHOT",targetHex:a}:s==="DASH"?{type:"USE_SKILL",skillId:"DASH",targetHex:a}:s==="GRAPPLE_HOOK"?{type:"USE_SKILL",skillId:"GRAPPLE_HOOK",targetHex:a}:s==="Bombing"?{type:"USE_SKILL",skillId:"BOMB_TOSS",targetHex:a}:s==="SENTINEL_BLAST"?{type:"USE_SKILL",skillId:"SENTINEL_BLAST",targetHex:a}:s==="SENTINEL_TELEGRAPH"?{type:"USE_SKILL",skillId:"SENTINEL_TELEGRAPH",targetHex:a}:{type:"WAIT",skillId:"WAIT_SKILL"}},$E=(e,n,s)=>{const o=String(s.entity.intent||"Waiting"),a=UE(e,s.entity,o,n),l=n.rngCounter||0,u=s.nextState.rngCounter||0,f={action:a,reasoningCode:o.toUpperCase().replace(/\s+/g,"_"),expectedValue:0,nextState:s.nextState,rngConsumption:Math.max(0,u-l)};return{plannedEntity:s.entity,nextState:s.nextState,message:s.message,decision:f}},qE=(e,n,s,o=10)=>{const a=e.action;let l=a.skillId||"WAIT_SKILL",u=a.type;u==="WAIT"&&(l="WAIT_SKILL"),u==="MOVE"&&(l="BASIC_MOVE"),u==="ATTACK"&&(l="BASIC_ATTACK");const f=a.targetHex;let p=a.primaryTargetId;return!p&&f&&(u==="ATTACK"||u==="USE_SKILL")&&(p=C0(s,n,f)),u==="MOVE"&&f&&Q(f,n.position)&&(u="WAIT",l="WAIT_SKILL"),{type:u,actorId:n.id,skillId:l,primaryTargetId:p,targetHex:f,priority:o,metadata:{expectedValue:e.expectedValue||0,reasoningCode:e.reasoningCode||"AI_DECISION_COMPAT",isGhost:!1,rngConsumption:e.rngConsumption||0}}},zE=(e,n,s)=>{const o=qE(e,n,s);if(o.skillId==="ARCHER_SHOT"&&!n.activeSkills?.some(l=>l.id==="ARCHER_SHOT")&&n.activeSkills?.some(l=>l.id==="SPEAR_THROW")&&(o.skillId="SPEAR_THROW"),!(o.skillId==="WAIT_SKILL"||n.activeSkills?.some(l=>l.id===o.skillId)))return o.type="WAIT",o.skillId="WAIT_SKILL",o.targetHex=void 0,o.primaryTargetId=void 0,o;if(o.skillId!=="WAIT_SKILL"&&o.targetHex){const l=st.get(o.skillId);l?.getValidTargets&&(l.getValidTargets(s,n.position).some(p=>Q(p,o.targetHex))||(o.type="WAIT",o.skillId="WAIT_SKILL",o.targetHex=void 0,o.primaryTargetId=void 0))}return o};var VE={};const YE=(e,n)=>{const s=e.enemy.subtype||"default",o=s==="archer"||s==="warlock"||s==="bomber",a=!o,l=(M,C,I)=>{if(!Hl())return 0;const k=VE?.[M];if(!k)return 0;const R=Number(k);return Number.isFinite(R)?Math.max(C,Math.min(I,R)):0},u=s==="bomber"?l("HOP_ENEMY_AI_BOMBER_BOMB_WINDOW_BONUS",-50,50):0,f=s==="bomber"?l("HOP_ENEMY_AI_BOMBER_REPOSITION_BONUS",-50,50):0,p={candidate_pre_score:1,is_wait_action:-8,is_move_action:a?1:.6,is_attack_action:a?5:2,is_skill_action:o?3:1.5,moved:.5,dist_delta_toward_player:a?1:-.2,preferred_range_match:2,has_target_hex:.4,target_adjacent_to_player:s==="bomber"?2:.2,target_is_player_tile:s==="bomber"?-4:0,uses_signature_skill:1.5,raider_dash_window_match:s==="raider"?25:0,pouncer_hook_window_match:s==="pouncer"?25:0,archer_ranged_window_match:s==="archer"?16:0,archer_melee_window_match:s==="archer"?16:0,bomber_bomb_window_match:s==="bomber"?18+u:0,bomber_bomb_target_valid_shape:s==="bomber"?12:0,bomber_reposition_candidate:s==="bomber"?f:0,sentinel_phase_telegraph_match:s==="sentinel"?40:0,sentinel_phase_execute_match:s==="sentinel"?45:0,sentinel_phase_mismatch:s==="sentinel"?-60:0,cooldown_delta_positive:o?.4:.2,rng_consumption:0,message_present:.1,dist_to_player:0,adjacent_to_player:0,hostile_hidden:0,enemy_hp:0,enemy_action_cooldown:0,dist_before:0,dist_after:0};if(!Hl())return p;const h=rf();if(h<=0)return p;const g=_0(e),b=.45*h,S=Math.max(0,Number(e.enemy.hp||0))/Math.max(1,Number(e.enemy.maxHp||1)),T=Math.max(0,1-S),v=s==="bomber",A=v?0:.4,_=v?1.35:1.1,E=v?1.5:6,w=v?.15:1;return{...p,is_wait_action:p.is_wait_action+(g.defense*1.4*b+g.defense*T*E*b),is_move_action:p.is_move_action+(g.positioning*A*b+g.defense*T*w*b),is_attack_action:p.is_attack_action+g.offense*.85*b,is_skill_action:p.is_skill_action+(g.control*_*b+g.offense*.2*b),dist_delta_toward_player:p.dist_delta_toward_player+(g.offense-g.defense)*.2*b,preferred_range_match:p.preferred_range_match+g.positioning*.2*b}},O0=()=>{if(!Hl())return 1;const e=rf();return e<=1?1:1+(e-1)*3},KE=e=>{const n=e.enemy.subtype||"default",s=n==="sentinel"||n==="warlock"||n==="raider"||n==="pouncer",o=O0(),a=n==="bomber"?1+(o-1)*.15:o;return{intent_is_offense:0,intent_is_positioning:0,intent_is_control:0,intent_is_defense:0,intent_desire_offense:0,intent_desire_positioning:0,intent_desire_control:0,intent_desire_defense:0,intent_selected_desire:.25*a,intent_dominant_match:(s?.9:.7)*a,intent_preferred_range_gap:0,intent_player_hidden:0}},FE=(e,n,s)=>({total:s,features:{...e.features,...n.features},weights:{...e.weights,...n.weights},contributions:{...e.contributions,...n.contributions}}),WE=(e,n)=>n===1?e:{total:e.total*n,features:{...e.features},weights:Object.fromEntries(Object.entries(e.weights).map(([s,o])=>[s,Number(o)*n])),contributions:Object.fromEntries(Object.entries(e.contributions).map(([s,o])=>[s,Number(o)*n]))},Zy=(e,n)=>!e&&!n?!0:!e||!n?!1:Q(e,n),GE=(e,n)=>{if(JSON.stringify(e.plannedEntity)!==JSON.stringify(n.plannedEntity))return"plannedEntity";if(!Zy(e.plannedEntity.position,n.plannedEntity.position))return"position";if(String(e.plannedEntity.intent||"")!==String(n.plannedEntity.intent||""))return"intent";if(!Zy(e.plannedEntity.intentPosition,n.plannedEntity.intentPosition))return"intentPosition";if((e.plannedEntity.actionCooldown??void 0)!==(n.plannedEntity.actionCooldown??void 0))return"actionCooldown";if((e.plannedEntity.facing??void 0)!==(n.plannedEntity.facing??void 0))return"facing";if((e.plannedEntity.isVisible??void 0)!==(n.plannedEntity.isVisible??void 0))return"isVisible";if((e.nextState.rngCounter??void 0)!==(n.nextState.rngCounter??void 0))return"rngCounter";if(String(e.message||"")!==String(n.message||""))return"message"},XE=(e,n={})=>{const s=TE(e.enemy.subtype),o={includePolicyExact:n.includePolicyExact},a=DE(e,o),l=YE(e),u=KE(e),f=O0(),p=a.map((h,g)=>{const b=$E(e.enemy,e.state,h.planned),S=vE(e,h,b.decision,s),T=xE(e,h,b.decision,s),v=Vd(S,l),A=Vd(T,u),_=WE(A,f),E=v.total+_.total+Number(h.preScore||0);return{index:g,candidate:h,result:b,tacticalBreakdown:v,intentBreakdown:_,breakdown:FE(v,_,E),total:E}});return p.sort((h,g)=>g.total!==h.total?g.total-h.total:(g.candidate.preScore||0)!==(h.candidate.preScore||0)?Number(g.candidate.preScore||0)-Number(h.candidate.preScore||0):h.index-g.index),{scored:p,weights:l,intentWeights:u}},Yd=e=>({...e.result,decision:{...e.result.decision,reasoningCode:e.candidate.reasoningCode,expectedValue:e.total,breakdown:e.breakdown}}),JE=(e,n)=>{if(e.candidate.source!=="policy_exact")return e;const s=Yd(e);for(const o of n){if(o.candidate.source==="policy_exact")continue;const a=Yd(o);if(GE(a,s)===void 0)return o}return e},QE=e=>{const n=Vd({},{});return{plannedEntity:{...e.enemy,intent:"Waiting",intentPosition:void 0},nextState:e.state,message:void 0,decision:{action:{type:"WAIT",skillId:"WAIT_SKILL"},reasoningCode:"NO_CANDIDATES_WAIT",expectedValue:Number.NEGATIVE_INFINITY,breakdown:n,rngConsumption:0}}},_d=(e,n={})=>{const s=XE(e,n);if(s.scored.length===0)return{selected:QE(e),scoredResult:s,selectedCandidate:void 0};const o=s.scored[0],a=JE(o,s.scored);return{selected:Yd(a),scoredResult:s,selectedCandidate:a}},eg=e=>({selectedSource:e.selectedCandidate?.candidate.source,selectedCandidateId:e.selectedCandidate?.candidate.id,position:e.selected.plannedEntity.position,intent:e.selected.plannedEntity.intent,intentPosition:e.selected.plannedEntity.intentPosition,actionCooldown:e.selected.plannedEntity.actionCooldown,facing:e.selected.plannedEntity.facing,isVisible:e.selected.plannedEntity.isVisible,nextRngCounter:e.selected.nextState.rngCounter,message:e.selected.message}),ZE=e=>{const n=_d(e),s=globalThis.__HOP_ENEMY_AI_TURN_TRACE_HOOK__,o=globalThis.__HOP_ENEMY_AI_RUNTIME_DECISION_CONTEXT__;if(s&&o&&o.actorId===e.enemy.id)try{const a=_d(e,{includePolicyExact:!0}),l=_d(e,{includePolicyExact:!1});s({runId:globalThis.__HOP_ENEMY_AI_TRACE_RUN_ID__,floor:o.floor??e.state.floor,turnNumber:o.turnNumber??e.state.turnNumber,rngCounter:o.rngCounter??e.state.rngCounter,enemyId:e.enemy.id,enemySubtype:e.enemy.subtype,enemyPosition:e.enemy.position,playerPosition:e.playerPos,withPolicyExact:eg(a),syntheticOnly:eg(l)})}catch{}return n.selected},e_=e=>{const n=ZE(e);return zE(n.decision,e.enemy,e.state)},t_=(e,n,s)=>e_({enemy:e,playerPos:n,state:s}),ul={weightsByIntent:{offense:{survival:2.1,lethality:6.5,position:2.4,objective:.5,status:2.5,tempo:1.6,resource:1},defense:{survival:4.8,lethality:3.6,position:3,objective:.8,status:2.2,tempo:1.6,resource:1},positioning:{survival:2.3,lethality:3.8,position:3.1,objective:6,status:1.4,tempo:1.6,resource:1},control:{survival:2.3,lethality:4.2,position:2.8,objective:.6,status:3.4,tempo:1.6,resource:1}},thresholds:{defenseHpRatio:.45,defensePressureHpRatio:.65,defensePressureAdjacentHostiles:2,controlMinHostiles:3}};({...ul.weightsByIntent,offense:{...ul.weightsByIntent.offense},control:{...ul.weightsByIntent.control}},{...ul.thresholds});class tg{getFalconIntent(n,s){const o=s.companionState?.mode||"roost",a=s.companionOf===n.player.id?n.player:n.enemies.find(u=>u.id===s.companionOf),l={expectedValue:0,reasoningCode:`FALCON_${o.toUpperCase()}`,isGhost:!1,rngConsumption:0};if(o==="scout")return{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_SCOUT",targetHex:s.position,priority:10,metadata:l};if(o==="predator"&&typeof s.companionState?.markTarget=="string"){const u=n.enemies.find(p=>p.id===s.companionState.markTarget&&p.hp>0);if(!u)return{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_AUTO_ROOST",targetHex:s.position,priority:9,metadata:{...l,reasoningCode:"FALCON_AUTO_ROOST"}};const f=fe(s.position,u.position);return f<=4?{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_APEX_STRIKE",targetHex:u.position,primaryTargetId:u.id,priority:10,metadata:l}:f<=1?{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_PECK",targetHex:u.position,primaryTargetId:u.id,priority:9,metadata:l}:{type:"MOVE",actorId:s.id,skillId:"BASIC_MOVE",targetHex:this.findStepToward(n,s,u.position),primaryTargetId:u.id,priority:7,metadata:l}}return a?fe(s.position,a.position)<=1?{type:"USE_SKILL",actorId:s.id,skillId:"FALCON_HEAL",targetHex:a.position,primaryTargetId:a.id,priority:10,metadata:l}:{type:"MOVE",actorId:s.id,skillId:"BASIC_MOVE",targetHex:this.findStepToward(n,s,a.position),primaryTargetId:a.id,priority:7,metadata:l}:{type:"WAIT",actorId:s.id,skillId:"WAIT_SKILL",priority:1,metadata:{...l,reasoningCode:"FALCON_WAIT"}}}findStepToward(n,s,o){const a=Ue(s.position).filter(l=>Ie.isWithinBounds(n,l)).filter(l=>Me.isWalkable(n,l)).filter(l=>{const u=ye(n,l);return!u||u.id===s.id});return a.length===0?s.position:a.sort((l,u)=>fe(l,o)-fe(u,o))[0]}getIntent(n,s){if(s.subtype==="falcon")return this.getFalconIntent(n,s);if(s.subtype==="bomb")return{type:"USE_SKILL",actorId:s.id,skillId:"TIME_BOMB",targetHex:s.position,priority:10,metadata:{expectedValue:0,reasoningCode:"BOMB_FUSE_TICK",isGhost:!1,rngConsumption:0}};const o=n.player.position;return t_(s,o,{...n,occupiedCurrentTurn:n.occupiedCurrentTurn})}}class Kd{inputQueue=[];resolveInput;pushIntent(n){this.inputQueue.push(n),this.resolveInput&&(this.resolveInput(n),this.resolveInput=void 0)}getIntent(n,s){return this.inputQueue.length>0?this.inputQueue.shift():new Promise(o=>{this.resolveInput=o})}}class lf{static strategies=new Map;static defaultEnemyStrategy=new tg;static defaultPlayerStrategy=new Kd;static register(n,s){this.strategies.set(n,s)}static resolve(n){return this.strategies.has(n.id)?this.strategies.get(n.id):n.type==="player"?this.defaultPlayerStrategy:this.defaultEnemyStrategy}static reset(){this.strategies.clear(),this.defaultEnemyStrategy=new tg,this.defaultPlayerStrategy=new Kd}}const n_=new Set(["MOVE","THROW_SPEAR","WAIT","USE_SKILL","JUMP","SHIELD_BASH","ATTACK","LEAP"]),wd=(e,n)=>{const s=lf.resolve(e.player);s instanceof Kd&&s.pushIntent(n)},Md={expectedValue:0,reasoningCode:"PLAYER_INPUT",isGhost:!1},i_=(e,n,s)=>{if(n_.has(n.type)&&!Do(e))return e;switch(n.type){case"SELECT_UPGRADE":return"payload"in n?cE(e,n.payload):e;case"USE_SKILL":{const{skillId:o,target:a}=n.payload;return wd(e,{type:"USE_SKILL",actorId:e.player.id,skillId:o,targetHex:a,priority:10,metadata:Md}),s.processNextTurn(e,!0)}case"MOVE":{if(!("payload"in n))return e;const o=n.payload,a=e.player.activeSkills||[],l=Ln(e.enemies,o),u=["BASIC_ATTACK","BASIC_MOVE","DASH"],f=a.filter(g=>g.slot==="passive"),p=[...f.filter(g=>u.includes(g.id)),...f.filter(g=>!u.includes(g.id))];let h;for(const g of p){const b=st.get(g.id);if(!b?.getValidTargets)continue;if(b.getValidTargets(e,e.player.position).some(T=>Q(T,o))){h=g.id;break}}if(!h){const g=a.some(S=>S.id==="BASIC_ATTACK"),b=a.some(S=>S.id==="BASIC_MOVE");if(l&&g)h="BASIC_ATTACK";else if(!l&&b)h="BASIC_MOVE";else return{...e,message:it(e.message,l?"No valid passive attack for target.":"No valid passive movement for target.","CRITICAL","SYSTEM")}}return wd(e,{type:l?"ATTACK":"MOVE",actorId:e.player.id,skillId:h,targetHex:o,primaryTargetId:l?.id,priority:10,metadata:Md}),s.processNextTurn(e,!0)}case"WAIT":return wd(e,{type:"WAIT",actorId:e.player.id,skillId:"WAIT",priority:10,metadata:Md}),s.processNextTurn(e,!0);case"APPLY_LOADOUT":{if(!("payload"in n))return e;const o=n.payload,a=b0(o);return{...e,player:{...e.player,activeSkills:a.activeSkills,archetype:a.archetype},upgrades:a.upgrades,hasSpear:o.startingSkills.includes("SPEAR_THROW"),hasShield:o.startingSkills.includes("SHIELD_THROW")||e.hasShield,selectedLoadoutId:o.id,message:it(e.message,`${o.name} selected.`,"INFO","SYSTEM")}}case"START_RUN":{const{loadoutId:o,seed:a,mode:l,date:u}=n.payload,f=Vn[o];if(!f)return e;if(l==="daily"){const p=MA(u),h=CA(p);return{...s.generateInitialState(1,a||h,void 0,void 0,f),dailyRunDate:p,runObjectives:OA(h),hazardBreaches:0}}return s.generateInitialState(1,a,void 0,void 0,f)}case"ADVANCE_TURN":return e.pendingStatus||(e.pendingFrames?.length??0)>0?(s.warnTurnStackInvariant("Ignored ADVANCE_TURN while pendingStatus is active.",{status:e.pendingStatus?.status,pendingFrames:e.pendingFrames?.length??0,turnNumber:e.turnNumber}),e):s.processNextTurn(e,!1);case"RESOLVE_PENDING":return uE(e,{generateInitialState:s.generateInitialState});case"EXIT_TO_HUB":return s.generateHubState();default:return e}},s_=(e,n,s,o)=>{let a=e;const l=[],u=s?e.enemies.filter(p=>p.id===s):e.enemies,f=[...a.enemies];return u.forEach(p=>{const h=a.enemies.find(g=>g.id===p.id);if(h){if(Ji(h)){const g=f.findIndex(b=>b.id===p.id);g!==-1&&(f[g]={...f[g],intent:void 0,intentPosition:void 0});return}if(h.intent&&h.intentPosition){let g=!1;const b=st.get(h.intent);let S=h.activeSkills?.find(T=>T.id===h.intent);if(!S&&h.intent==="ARCHER_SHOT"&&(S=h.activeSkills?.find(T=>T.id==="SPEAR_THROW")),b&&S){const v=(b.getValidTargets?b.getValidTargets(a,h.position):[]).some(E=>Q(E,a.player.position));let A=h.intentPosition;if(v)A=a.player.position;else{const E=f.findIndex(w=>w.id===p.id);E!==-1&&(f[E]={...f[E],intent:void 0,intentPosition:void 0});return}const _=b.execute(a,h,A,S.activeUpgrades);a=Hn(a,_.effects,{sourceId:h.id,targetId:a.player.id,stepId:o}),l.push(..._.messages),g=!0}else if(h.subtype!=="bomber"){if(Q(h.intentPosition,n)){a={...a,player:Vi(a.player,1)};const T=`${h.subtype||"enemy"}#${h.id}`;l.push(`${T} hit you! (HP: ${a.player.hp}/${a.player.maxHp})`),g=!0}}if(g){const T=f.findIndex(v=>v.id===p.id);T!==-1&&(f[T]={...f[T],intent:void 0,intentPosition:void 0})}}}}),a={...a,enemies:f},{state:a,messages:l}},N0=(e,n,s)=>Ji(s)?{...e,type:"WAIT",skillId:"WAIT_SKILL",priority:0,metadata:{...e.metadata,reasoningCode:"STATUS_STUNNED"}}:e;class k0{static execute(n,s,o){return this.resolveExecution(n,s,o)}static simulate(n,s,o){return this.resolveExecution(n,s,o)}static resolveExecution(n,s,o){const a=[],l=[],u=st.get(n.skillId);if(!u&&n.type!=="WAIT")return{effects:[],messages:[`Failed to execute unknown skill: ${n.skillId}`],consumesTurn:!1};if(n.type==="WAIT")return{effects:[],messages:[],consumesTurn:!0};if(!(n.skillId==="WAIT_SKILL"||s.activeSkills.some(A=>A.id===n.skillId)))return{effects:[],messages:[`Actor ${s.id} does not have skill ${n.skillId} in loadout!`],consumesTurn:!1};const p=s.activeSkills.find(A=>A.id===n.skillId),h=s.factionId==="player"&&af(o);if(!h&&p&&(p.currentCooldown||0)>0)return{effects:[],messages:[`${n.skillId} is on cooldown (${p.currentCooldown}).`],consumesTurn:s.type!=="player"};let g=n.targetHex,b=n.primaryTargetId;if(!g&&u&&(g=this.findOptimalTargetHex(n,s,o,u.baseVariables.range)),!g)return{effects:[],messages:[`No valid target found for ${n.skillId}`],consumesTurn:!1};if(g&&!b){const A=ye(o,g);A&&(b=A.id)}const S=p?.activeUpgrades||[],T=u.execute(o,s,g,S),v=[...a,...T.effects];if(T.consumesTurn!==!1&&!h){let _=u.baseVariables.cooldown||0;for(const E of S){const w=u.upgrades?.[E];typeof w?.modifyCooldown=="number"&&(_+=w.modifyCooldown)}_=Math.max(0,_),_>0&&v.push({type:"ModifyCooldown",skillId:n.skillId,amount:_+1,setExact:!0})}return{effects:v,messages:[...l,...T.messages],consumesTurn:T.consumesTurn??!0,targetId:b,kills:T.kills||0}}static findOptimalTargetHex(n,s,o,a){if(n.primaryTargetId){const l=o.enemies.find(u=>u.id===n.primaryTargetId)||(o.player.id===n.primaryTargetId?o.player:void 0);if(l&&(n.type==="ATTACK"||n.type==="USE_SKILL"))return l.position}}}const Fd=(e,n)=>e.q!==n.q?e.q-n.q:e.r!==n.r?e.r-n.r:e.s-n.s,Rl=(e,n)=>e.player.id===n?e.player:e.enemies.find(s=>s.id===n)||e.companions?.find(s=>s.id===n),a_=(e,n)=>{if(n.primaryTargetId)return Rl(e,n.primaryTargetId);if(n.targetHex)return ye(e,n.targetHex)},o_=(e,n,s)=>{const o=new Map,a=a_(e,n),l=u=>{u&&o.set(ce(u),u)};return s.forEach(u=>{u.type==="Damage"?typeof u.target=="string"&&u.target!=="targetActor"&&u.target!=="area"?l(Rl(e,u.target)?.position):u.target==="targetActor"?l(a?.position):u.target==="area"?l(u.source):typeof u.target=="object"&&"q"in u.target&&l(u.target):u.type==="Impact"||u.type==="LavaSink"?l(Rl(e,u.target)?.position):u.type==="Displacement"&&l(u.destination)}),[...o.values()].sort(Fd)},ng=e=>{const n=[];e.enemies.filter(a=>a.hp>0&&a.factionId!==e.player.factionId).forEach(a=>{const u=lf.resolve(a).getIntent(e,a);if(u instanceof Promise)return;const f=N0(u,e,a);let p=f;f.skillId==="SENTINEL_TELEGRAPH"&&(p={...f,skillId:"SENTINEL_BLAST"});const h=k0.simulate(p,a,e),g=o_(e,p,h.effects);g.length!==0&&n.push({actorId:a.id,skillId:f.skillId,targetHex:f.targetHex,dangerTiles:g})}),n.sort((a,l)=>a.actorId!==l.actorId?a.actorId.localeCompare(l.actorId):a.skillId!==l.skillId?a.skillId.localeCompare(l.skillId):!a.targetHex&&!l.targetHex?0:a.targetHex?l.targetHex?Fd(a.targetHex,l.targetHex):1:-1);const o=new Map;return n.forEach(a=>a.dangerTiles.forEach(l=>o.set(ce(l),l))),{sourceTurn:e.turnNumber,dangerTiles:[...o.values()].sort(Fd),projections:n}},r_=e=>(s,o=!1)=>{if(s.pendingStatus||(s.pendingFrames?.length??0)>0)return e.warnTurnStackInvariant("Blocked processNextTurn while pendingStatus is active.",{status:s.pendingStatus?.status,pendingFrames:s.pendingFrames?.length??0,turnNumber:s.turnNumber}),s;let a=s;const l=[],u=[];let f=0;const p=100;let h=!1;for(;f<p;){if(f++,a.player.hp<=0&&a.pendingStatus?.status!=="lost"){const F=jo(a);return e.withPendingFrame({...a,message:it(a.message,"You have fallen...","CRITICAL","COMBAT")},{status:"lost",completedRun:F},"RUN_LOST",{reason:"GLOBAL_DEATH_CHECK"})}a.occupancyMask=Ie.refreshOccupancyMask(a);let b;if((o&&f===1||h)&&a.initiativeQueue){h=!1;const F=a.initiativeQueue;F.entries.length>0&&F.currentIndex>=0&&F.currentIndex<F.entries.length&&(b=F.entries[F.currentIndex].actorId)}else{const F=oT(a);a={...a,initiativeQueue:F.queue},b=F.actorId??void 0}if(!b)break;const S=b==="player"?a.player:a.enemies.find(F=>F.id===b),T=`${a.turnNumber}:${a.initiativeQueue?.round??0}:${b}:${f}`;if(!S||S.hp<=0){a={...a,initiativeQueue:xd(a.initiativeQueue,b)};continue}if(aT(a.initiativeQueue)?.turnStartPosition||(a={...a,initiativeQueue:rT(a,S)}),!o||f>1){const F=e.executeStatusWindow(a,b,"START_OF_TURN",T);if(a=F.state,l.push(...F.messages),b==="player"&&a.upgrades?.includes("RELIC_STEADY_PLATES")){const z=Math.min(2,(a.player.temporaryArmor||0)+1);z!==(a.player.temporaryArmor||0)&&(a={...a,player:{...a.player,temporaryArmor:z}},l.push(it([],"Steady Plates harden your stance.","INFO","COMBAT")[0]))}if(b==="player"){const z=a.player.activeSkills?.find(re=>re.id==="SHIELD_BASH");if(!!z?.activeUpgrades?.includes("PASSIVE_PROTECTION")&&(z?.currentCooldown||0)===0){const re=Math.max(a.player.temporaryArmor||0,1);re!==(a.player.temporaryArmor||0)&&(a={...a,player:{...a.player,temporaryArmor:re}},l.push(it([],"Passive Protection braces your guard.","INFO","COMBAT")[0]))}}const H=s_(a,a.player.position,b,T);a=H.state,l.push(...H.messages)}const A=b==="player"?a.player:a.enemies.find(F=>F.id===b);if(!A||A.hp<=0){a={...a,initiativeQueue:xd(a.initiativeQueue,b),message:zn(a.message,l,"INFO","SYSTEM")};continue}const _=b==="player"?a.player:a.enemies.find(F=>F.id===b);if(!_||_.hp<=0)continue;let E,w=!1;if(Ji(_))w=!0,E={type:"WAIT",actorId:_.id,skillId:"WAIT_SKILL",priority:0,metadata:{expectedValue:0,reasoningCode:"STATUS_STUNNED_AUTOSKIP",isGhost:!1}},b==="player"?l.push("You are stunned and skip your turn."):l.push(`${_.subtype||"Enemy"} is stunned and skips its turn.`);else{const F=lf.resolve(_),H=b!=="player"?{actorId:_.id,floor:a.floor,turnNumber:a.turnNumber,rngCounter:a.rngCounter}:void 0;H&&(globalThis.__HOP_ENEMY_AI_RUNTIME_DECISION_CONTEXT__=H);let z;try{z=F.getIntent(a,_)}finally{H&&delete globalThis.__HOP_ENEMY_AI_RUNTIME_DECISION_CONTEXT__}if(z instanceof Promise){const Z=ng(a);return{...a,intentPreview:Z,message:zn(a.message,l,"INFO","SYSTEM"),dyingEntities:[...a.dyingEntities||[],...u]}}E=z}const M=A.activeSkills.map(F=>F.id).join(", ");e.engineDebug&&(console.log(`[ENGINE] Actor: ${b} | Loadout: [${M}] | Pos: ${JSON.stringify(A.position)}`),console.log(`[ENGINE] Intent: ${E.type} | Skill: ${E.skillId} | TargetHex: ${E.targetHex?JSON.stringify(E.targetHex):"none"} | TargetId: ${E.primaryTargetId||"none"}`)),E.metadata.rngConsumption&&(a={...a,rngCounter:(a.rngCounter||0)+E.metadata.rngConsumption}),E=N0(E,a,_);const{effects:C,messages:I,consumesTurn:k,targetId:R,kills:$}=k0.execute(E,_,a);if(e.engineDebug&&console.log(`[ENGINE] ${b} intends ${E.type} (${E.skillId}) onto ${R||(E.targetHex?JSON.stringify(E.targetHex):"self")}`),e.engineWarn&&C.length===0&&E.type!=="WAIT"){const F=`[ENGINE] WARNING: Intent ${E.type} (${E.skillId}) for actor ${b} produced ZERO effects!`;console.warn(F)}const j=a,D=Hn(a,C,{sourceId:b,targetId:R,stepId:T});if(b==="player"&&(D.kills=(D.kills||0)+($||0)),k===!1){a={...j,message:zn(a.message,I,"INFO","COMBAT")},h=!0;continue}if(a=D,l.push(...I),b!=="player"){const F=a.enemies.find(H=>H.id===b);if(F?.subtype==="bomber"){const H=E.skillId==="BOMB_TOSS"?2:Math.max(0,(F.actionCooldown??0)-1);F.actionCooldown!==H&&(a={...a,enemies:a.enemies.map(z=>z.id===b?{...z,actionCooldown:H}:z)})}}const q=b==="player"?a.player:a.enemies.find(F=>F.id===b);if(!q||q.hp<=0){if(b==="player"){const F=jo(a);return e.withPendingFrame({...a,message:it(zn(a.message,l,"INFO","SYSTEM"),"You have fallen...","CRITICAL","COMBAT")},{status:"lost",completedRun:F},"RUN_LOST",{reason:"SELF_ACTION_DEATH"})}a={...a,enemies:a.enemies.filter(F=>F.id!==b),initiativeQueue:xd(a.initiativeQueue,b),message:zn(a.message,l,"INFO","SYSTEM")};continue}const se=e.executeStatusWindow(a,b,"END_OF_TURN",T);a=se.state,l.push(...se.messages),a={...a,enemies:a.enemies.map(F=>F.id===b?_y(Iy(F)):F),player:b==="player"?_y(Iy(a.player)):a.player,initiativeQueue:lT(a,b)};const ee=b==="player"?a.player:a.enemies.find(F=>F.id===b);if(!(w||E.metadata?.reasoningCode==="STATUS_STUNNED"||E.metadata?.reasoningCode==="STATUS_STUNNED_AUTOSKIP")&&ee&&ee.hp>0){const F=cT(a,b)||ee.previousPosition||ee.position,H=uT(a,b)??void 0,z=MT(a,ee,Ue(F),F,H,T);a=z.state,l.push(...z.messages),b==="player"&&(a.kills=(a.kills||0)+z.kills)}if(b==="player"){const F=e.applyPlayerEndOfTurnRules(a,T,{withPendingFrame:e.withPendingFrame});if(a=F.state,F.haltTurnLoop)return a;l.push(...F.messages)}}const g=ng(a);return{...a,intentPreview:g,message:zn(a.message,l,"INFO","SYSTEM"),dyingEntities:[...a.dyingEntities||[],...u]}};var R0={};const I0=typeof process<"u"&&R0?.HOP_ENGINE_DEBUG==="1",L0=typeof process<"u"&&R0?.HOP_ENGINE_WARN==="1",l_=I0||L0,B0=(e,n)=>{if(l_){if(n){console.warn(`[TURN_STACK] ${e}`,n);return}console.warn(`[TURN_STACK] ${e}`)}},jl=()=>{const e=Cs();return{...e,gameStatus:"hub",message:[it([],"Welcome to the Strategic Hub. Select your loadout.","INFO","SYSTEM")[0]],player:{...e.player,activeSkills:[]},hasSpear:!1,hasShield:!1}},Cs=(e=1,n,s,o,a)=>{x0();const l=n||String(Date.now()),u=nE(e),f=eE(e,l),p=tE(e,f.spawnPositions||[],l),h=o?{hp:o.hp,maxHp:o.maxHp,speed:o.speed||hy.speed}:{speed:hy.speed},g=o?.upgrades||(a?a.startingUpgrades:[]),b=a?b0(a):{activeSkills:B1(),archetype:"VANGUARD"},S=S0(o?.activeSkills||b.activeSkills),T=o?.archetype||b.archetype,v=f.tiles||new Map,_={turnNumber:1,player:{...Wi({id:"player",type:"player",position:f.playerSpawn,hp:h.hp,maxHp:h.maxHp,speed:h.speed,factionId:"player",activeSkills:S,archetype:T,weightClass:"Standard",components:new Map}),previousPosition:f.playerSpawn},enemies:p.map(E=>({...E,previousPosition:E.position,statusEffects:E.statusEffects||[],temporaryArmor:E.temporaryArmor||0})),gridWidth:Cl,gridHeight:Ol,gameStatus:"playing",message:e===1?[it([],"Welcome to the arena. Survive.","INFO","SYSTEM")[0]]:it(o?.message||[],`Floor ${e} - ${u.charAt(0).toUpperCase()+u.slice(1)}. Be careful.`,"INFO","OBJECTIVE"),hasSpear:!0,stairsPosition:f.stairsPosition,occupancyMask:[0n],shrinePosition:f.shrinePosition,shrineOptions:void 0,hasShield:!0,floor:e,upgrades:g,rooms:f.rooms,theme:u,commandLog:[],undoStack:[],rngSeed:l,initialSeed:s??(e===1?l:void 0),rngCounter:0,actionLog:[],kills:o&&o.kills||0,environmentalKills:o&&o.environmentalKills||0,turnsSpent:o&&o.turnsSpent||0,dailyRunDate:o?.dailyRunDate,runObjectives:o?.runObjectives||[],hazardBreaches:o?.hazardBreaches||0,completedRun:void 0,combatScoreEvents:o?.combatScoreEvents||[],dyingEntities:[],visualEvents:[],timelineEvents:[],intentPreview:void 0,initiativeQueue:void 0,tiles:v};return _.initiativeQueue=Ms(_),_.occupancyMask=Ie.refreshOccupancyMask(_),_},c_=(e,n,s,o)=>{const a=n==="player"?e.player:e.enemies.find(p=>p.id===n);if(!a)return{state:e,messages:[]};const l=[],u=[];return a.statusEffects.forEach(p=>{if(p.tickWindow===s&&p.onTick){const h=p.onTick(a,e);h&&l.push(...h)}}),{state:Hn(e,l,{sourceId:n,stepId:o}),messages:u}},u_=r_({executeStatusWindow:c_,withPendingFrame:oE,applyPlayerEndOfTurnRules:dE,warnTurnStackInvariant:B0,engineDebug:I0,engineWarn:L0}),d_=(e,n)=>{const s=of(e.player),o=s===e.player?e:{...e,player:s};if(o.gameStatus!=="playing"&&n.type!=="RESET"&&n.type!=="SELECT_UPGRADE"&&n.type!=="LOAD_STATE"&&n.type!=="APPLY_LOADOUT"&&n.type!=="START_RUN"&&n.type!=="EXIT_TO_HUB")return o;const a={...o,isShaking:!1,lastSpearPath:void 0,dyingEntities:[],occupiedCurrentTurn:void 0,visualEvents:[],timelineEvents:[]};switch(n.type){case"LOAD_STATE":return lE(n.payload);case"RESET":{const S=e.player.archetype==="SKIRMISHER"?"SKIRMISHER":"VANGUARD",T=Vn[S];return Cs(1,n.payload?.seed||String(Date.now()),void 0,void 0,T)}case"EXIT_TO_HUB":return jl()}if(o.gameStatus!=="playing"&&n.type!=="SELECT_UPGRADE"&&n.type!=="APPLY_LOADOUT"&&n.type!=="START_RUN")return o;const l=iE(n,o),u=o;let f={...a,initiativeQueue:a.initiativeQueue};const h=((b,S)=>i_(b,S,{processNextTurn:u_,generateInitialState:Cs,generateHubState:jl,warnTurnStackInvariant:B0}))(f,n),g=sE(u,h,e);return l.delta=g,{...h,commandLog:[...h.commandLog||[],l],undoStack:[...h.undoStack||[],g],actionLog:[...h.actionLog||[],n]}},ig={skill:{staticWeight:.5,powerCoeff:1,reachCoeff:1,safetyCoeff:1,tempoCoeff:1,complexityCoeff:1,perSkillScalar:{}},policy:{offenseWeight:1,defenseWeight:1,positioningWeight:1,statusWeight:1,riskPenaltyWeight:1}};({...ig.policy},{...ig.skill});const f_=new Set(["MOVE","THROW_SPEAR","WAIT","USE_SKILL","JUMP","SHIELD_BASH","ATTACK","LEAP","ADVANCE_TURN","SELECT_UPGRADE","RESOLVE_PENDING"]),m_=e=>typeof e=="object"&&e!==null,H0=e=>{if(!Array.isArray(e))return{valid:!1,actions:[],errors:["Replay actions must be an array."]};const n=[],s=[];return e.forEach((o,a)=>{if(!m_(o)||typeof o.type!="string"){s.push(`Action[${a}] is not a valid action object with a "type" field.`);return}if(!f_.has(o.type)){s.push(`Action[${a}] type "${o.type}" is not replayable.`);return}n.push(o)}),{valid:s.length===0,actions:n,errors:s}},xs=e=>({q:e.q,r:e.r,s:e.s}),p_=e=>{if(e){if(e instanceof Map)return new Map(Array.from(e.entries()).map(([n,s])=>[n,typeof s=="object"&&s!==null?{...s}:s]));if(Array.isArray(e))return new Map(e);if(typeof e=="object")return new Map(Object.entries(e).map(([n,s])=>[n,typeof s=="object"&&s!==null?{...s}:s]))}},dl=e=>({...e,position:xs(e.position),previousPosition:e.previousPosition?xs(e.previousPosition):void 0,intentPosition:e.intentPosition?xs(e.intentPosition):void 0,statusEffects:e.statusEffects.map(n=>({...n})),activeSkills:e.activeSkills.map(n=>({...n,upgrades:[...n.upgrades||[]],activeUpgrades:[...n.activeUpgrades||[]]})),components:p_(e.components),companionState:e.companionState?{...e.companionState,markTarget:typeof e.companionState.markTarget=="object"&&e.companionState.markTarget?xs(e.companionState.markTarget):e.companionState.markTarget}:void 0}),h_=e=>({...e,player:dl(e.player),enemies:e.enemies.map(dl),companions:e.companions?.map(dl),dyingEntities:e.dyingEntities?.map(dl),message:[...e.message],visualEvents:[...e.visualEvents||[]],simulationEvents:[...e.simulationEvents||[]],stackTrace:e.stackTrace?e.stackTrace.map(n=>({...n})):void 0,timelineEvents:e.timelineEvents?e.timelineEvents.map(n=>({...n})):void 0,occupancyMask:[...e.occupancyMask],tiles:new Map(Array.from(e.tiles.entries()).map(([n,s])=>[n,{...s,position:xs(s.position),traits:new Set(s.traits),effects:s.effects.map(o=>({...o}))}])),traps:e.traps?.map(n=>({...n,position:xs(n.position)})),lastSpearPath:e.lastSpearPath?.map(xs),actionLog:e.actionLog?[...e.actionLog]:void 0}),sg=(e,n)=>e.player.id===n?e.player:e.enemies.find(s=>s.id===n)||e.companions?.find(s=>s.id===n),y_=(e,n)=>{if(n)return ye(e,n)?.id},g_=(e,n)=>{const s=sg(e,n.actorId);if(!s)return{ok:!1,reason:`Actor ${n.actorId} not found`,effects:[],messages:[],simulationEvents:[],stackTrace:[]};const o=st.get(n.skillId);if(!o)return{ok:!1,reason:`Skill ${n.skillId} not found`,effects:[],messages:[],simulationEvents:[],stackTrace:[]};if(n.target&&o.getValidTargets&&!o.getValidTargets(e,s.position).some(S=>ce(S)===ce(n.target)))return{ok:!1,reason:`Target ${ce(n.target)} is invalid`,effects:[],messages:[],simulationEvents:[],stackTrace:[]};const a=h_(e),l=sg(a,n.actorId),u=o.execute(a,l,n.target,n.activeUpgrades||[],n.context||{}),f=a.simulationEvents?.length||0,p=a.stackTrace?.length||0,h=y_(a,n.target),g=Hn(a,u.effects,{sourceId:l.id,targetId:h});return{ok:!0,effects:u.effects,messages:u.messages,consumesTurn:u.consumesTurn,predictedState:g,simulationEvents:(g.simulationEvents||[]).slice(f),stackTrace:(g.stackTrace||[]).slice(p)}},b_=e=>({q:e.q,r:e.r,s:e.s}),S_=e=>{const n=[e.player,...e.enemies,...e.companions||[],...e.dyingEntities||[]];return{turn:e.turnNumber||0,stackTick:e.stackTrace?.length||0,actors:n.map(s=>({id:s.id,position:b_(s.position)}))}},v_=(e,n)=>{const s=[],o=new Map(e.actors.map(l=>[l.id,l.position])),a=new Map(n.actors.map(l=>[l.id,l.position]));for(const[l,u]of o.entries()){const f=a.get(l);if(!f){s.push({actorId:l,expected:u,reason:"missing_in_ui"});continue}ce(u)!==ce(f)&&s.push({actorId:l,expected:u,actual:f,reason:"position_mismatch"})}for(const[l,u]of a.entries())o.has(l)||s.push({actorId:l,actual:u,reason:"missing_in_engine"});return{ok:s.length===0,mismatches:s}},Oo={player:{icon:"",shape:"square",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1},vanguard:{icon:"",shape:"square",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1},skirmisher:{icon:"",shape:"square",color:"#3b82f6",borderColor:"#fbbf24",isRanged:!1},firemage:{icon:"",shape:"square",color:"#ef4444",borderColor:"#fbbf24",isRanged:!0},necromancer:{icon:"",shape:"square",color:"#6b21a8",borderColor:"#9333ea",isRanged:!0},hunter:{icon:"",shape:"square",color:"#10b981",borderColor:"#ffffff",isRanged:!0},assassin_player:{icon:"",shape:"square",color:"#1f2937",borderColor:"#ffffff",isRanged:!1},footman:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#ffffff",isRanged:!1},sprinter:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#ffffff",isRanged:!1,size:.9},spear:{icon:"",shape:"circle",color:"#ffffff",borderColor:"#3b82f6",isRanged:!1,size:.8,opacity:.9},shieldBearer:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#fbbf24",isRanged:!1,showFacing:!0},golem:{icon:"",shape:"diamond",color:"#78716c",borderColor:"#ffffff",isRanged:!1,size:1.2},assassin:{icon:"",shape:"diamond",color:"#6b21a8",borderColor:"#ffffff",isRanged:!1},archer:{icon:"",shape:"triangle",color:"#ef4444",borderColor:"#ffffff",isRanged:!0},bomber:{icon:"",shape:"circle",color:"#ef4444",borderColor:"#ffffff",isRanged:!0},warlock:{icon:"",shape:"triangle",color:"#9333ea",borderColor:"#ffffff",isRanged:!0},bomb:{icon:"",shape:"circle",color:"#1f2937",borderColor:"#000000",isRanged:!1,showTimer:!0},falcon:{icon:"",shape:"circle",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1,size:.8},skeleton:{icon:"",shape:"circle",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1,size:.8},sentinel:{icon:"",shape:"diamond",color:"#dc2626",borderColor:"#fbbf24",isRanged:!0,size:1.5}};function Uo(e,n,s,o){if(e&&Oo[e])return Oo[e];if(n==="player"&&o){const a=o==="ASSASSIN"?"assassin_player":o.toLowerCase();if(Oo[a])return Oo[a]}return n==="player"?Oo.player:s==="ranged"?{icon:"",shape:"triangle",color:"#ef4444",borderColor:"#ffffff",isRanged:!0}:s==="boss"?{icon:"",shape:"diamond",color:"#dc2626",borderColor:"#fbbf24",isRanged:!1,size:1.5}:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#ffffff",isRanged:!1}}function x_(e){return e.isFlying===!0}const A_=["catacombs","inferno","throne","frozen","void"],Dl=["off","repeat","cover"],T_=["normal","multiply","overlay","soft-light","screen","color-dodge"],ag=["off","multiply","overlay","soft-light","screen","color-dodge","normal"],E_=["#8b6f4a","#8f4a2e","#5b6d41","#536e8e","#5f5977","#b79a73","#d15a3a","#3e4f3a"],__=["native","additive","custom"],w_=({settings:e,setSettings:n})=>y.jsxs("section",{className:"space-y-3",children:[y.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/75",children:"Preview"}),y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Theme"}),y.jsx("select",{value:e.theme,onChange:s=>n(o=>o&&{...o,theme:s.target.value}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:A_.map(s=>y.jsx("option",{value:s,children:s},s))}),y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Seed"}),y.jsx("input",{value:e.seed,onChange:s=>n(o=>o&&{...o,seed:s.target.value}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"}),y.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/80",children:[y.jsx("input",{type:"checkbox",checked:e.injectHazards,onChange:s=>n(o=>o&&{...o,injectHazards:s.target.checked})}),"Inject synthetic lava/fire patches for mask testing"]})]}),Ul=64,$l=192,Yi=64,Ki=512,xe=(e,n,s)=>Math.min(s,Math.max(n,e)),qe=(e,n)=>{const s=Number(e);return Number.isFinite(s)?s:n},Ta=(e,n="#8b6f4a")=>{const s=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(s))return s.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(s)){const[l,u,f]=s.slice(1).split("");return`#${l}${l}${u}${u}${f}${f}`.toLowerCase()}return n},Xl=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",$o=e=>e==="off"?"off":Xl(e),M_=({settings:e,setSettings:n,pathSets:s})=>y.jsxs("section",{className:"space-y-3",children:[y.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-cyan-200",children:"Undercurrent"}),y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Asset Path"}),y.jsx("input",{list:"sandbox-undercurrent-paths",value:e.undercurrent.path,onChange:o=>n(a=>a&&{...a,undercurrent:{...a.undercurrent,path:o.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),y.jsx("datalist",{id:"sandbox-undercurrent-paths",children:s.undercurrent.map(o=>y.jsx("option",{value:o},o))}),y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Mode"}),y.jsx("select",{value:e.undercurrent.mode,onChange:o=>n(a=>a&&{...a,undercurrent:{...a.undercurrent,mode:o.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Dl.map(o=>y.jsx("option",{value:o,children:o},o))}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scale Px"}),y.jsx("input",{type:"number",min:Ul,max:$l,step:16,value:e.undercurrent.scalePx,onChange:o=>n(a=>a&&{...a,undercurrent:{...a.undercurrent,scalePx:xe(qe(o.target.value,a.undercurrent.scalePx),Ul,$l)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Opacity"}),y.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.undercurrent.opacity,onChange:o=>n(a=>a&&{...a,undercurrent:{...a.undercurrent,opacity:xe(qe(o.target.value,a.undercurrent.opacity),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),y.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scroll X"}),y.jsx("input",{type:"number",step:5,value:e.undercurrent.scrollX,onChange:o=>n(a=>a&&{...a,undercurrent:{...a.undercurrent,scrollX:qe(o.target.value,a.undercurrent.scrollX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scroll Y"}),y.jsx("input",{type:"number",step:5,value:e.undercurrent.scrollY,onChange:o=>n(a=>a&&{...a,undercurrent:{...a.undercurrent,scrollY:qe(o.target.value,a.undercurrent.scrollY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Duration"}),y.jsx("input",{type:"number",min:1e3,step:500,value:e.undercurrent.scrollDurationMs,onChange:o=>n(a=>a&&{...a,undercurrent:{...a.undercurrent,scrollDurationMs:Math.max(1e3,qe(o.target.value,a.undercurrent.scrollDurationMs))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset X"}),y.jsx("input",{type:"number",step:4,value:e.undercurrent.offsetX,onChange:o=>n(a=>a&&{...a,undercurrent:{...a.undercurrent,offsetX:qe(o.target.value,a.undercurrent.offsetX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset Y"}),y.jsx("input",{type:"number",step:4,value:e.undercurrent.offsetY,onChange:o=>n(a=>a&&{...a,undercurrent:{...a.undercurrent,offsetY:qe(o.target.value,a.undercurrent.offsetY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]})]}),C_=({settings:e,setSettings:n,pathSets:s})=>y.jsxs("section",{className:"space-y-3",children:[y.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-amber-200",children:"Crust"}),y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Asset Path"}),y.jsx("input",{list:"sandbox-crust-paths",value:e.crust.path,onChange:o=>n(a=>a&&{...a,crust:{...a.crust,path:o.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),y.jsx("datalist",{id:"sandbox-crust-paths",children:s.crust.map(o=>y.jsx("option",{value:o},o))}),y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Mode"}),y.jsx("select",{value:e.crust.mode,onChange:o=>n(a=>a&&{...a,crust:{...a.crust,mode:o.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Dl.map(o=>y.jsx("option",{value:o,children:o},o))}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scale Px"}),y.jsx("input",{type:"number",min:64,step:16,value:e.crust.scalePx,onChange:o=>n(a=>a&&{...a,crust:{...a.crust,scalePx:Math.max(64,qe(o.target.value,a.crust.scalePx))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Opacity"}),y.jsx("input",{type:"number",min:1,max:1,step:.01,value:1,onChange:()=>n(o=>o&&{...o,crust:{...o.crust,opacity:1}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Seed Shift Budget"}),y.jsx("input",{type:"number",min:0,step:8,value:e.crust.seedShiftPx,onChange:o=>n(a=>a&&{...a,crust:{...a.crust,seedShiftPx:Math.max(0,qe(o.target.value,a.crust.seedShiftPx))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset X"}),y.jsx("input",{type:"number",step:4,value:e.crust.offsetX,onChange:o=>n(a=>a&&{...a,crust:{...a.crust,offsetX:qe(o.target.value,a.crust.offsetX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset Y"}),y.jsx("input",{type:"number",step:4,value:e.crust.offsetY,onChange:o=>n(a=>a&&{...a,crust:{...a.crust,offsetY:qe(o.target.value,a.crust.offsetY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]})]}),O_=({settings:e,setSettings:n,pathSets:s,mountainTintPickerColor:o})=>y.jsxs("section",{className:"space-y-3",children:[y.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-rose-200",children:"Walls / Mountains"}),y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Mountain Asset"}),y.jsx("input",{list:"sandbox-mountain-paths",value:e.walls.mountainPath,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainPath:a.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs",placeholder:"/assets/biomes/biome.volcano.mountain.01.webp"}),y.jsx("datalist",{id:"sandbox-mountain-paths",children:s.mountain.map(a=>y.jsx("option",{value:a},a))}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scale"}),y.jsx("input",{type:"number",min:.2,max:3,step:.01,value:e.walls.mountainScale,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainScale:xe(qe(a.target.value,l.walls.mountainScale),.2,3)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Anchor X"}),y.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.walls.mountainAnchorX,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainAnchorX:xe(qe(a.target.value,l.walls.mountainAnchorX),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset X"}),y.jsx("input",{type:"number",step:2,value:e.walls.mountainOffsetX,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainOffsetX:qe(a.target.value,l.walls.mountainOffsetX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset Y"}),y.jsx("input",{type:"number",step:2,value:e.walls.mountainOffsetY,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainOffsetY:qe(a.target.value,l.walls.mountainOffsetY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Anchor Y"}),y.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.walls.mountainAnchorY,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainAnchorY:xe(qe(a.target.value,l.walls.mountainAnchorY),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Crust Blend"}),y.jsx("select",{value:e.walls.mountainCrustBlendMode,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainCrustBlendMode:$o(a.target.value)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:ag.map(a=>y.jsx("option",{value:a,children:a},`mountain-blend-${a}`))})]}),y.jsxs("div",{children:[y.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Blend Opacity ",e.walls.mountainCrustBlendOpacity.toFixed(2)]}),y.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.walls.mountainCrustBlendOpacity,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainCrustBlendOpacity:xe(qe(a.target.value,l.walls.mountainCrustBlendOpacity),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),y.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45",children:"Mountain Tint"}),y.jsxs("div",{className:"grid grid-cols-[72px_1fr] gap-3",children:[y.jsx("input",{type:"color",value:o,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainTintColor:a.target.value}}),className:"h-10 w-full rounded-lg border border-white/15 bg-white/5 p-1 cursor-pointer","aria-label":"Mountain Tint Color Picker"}),y.jsx("input",{value:e.walls.mountainTintColor,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainTintColor:a.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",placeholder:"#8b6f4a"})]}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Tint Blend"}),y.jsx("select",{value:e.walls.mountainTintBlendMode,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainTintBlendMode:$o(a.target.value)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:ag.map(a=>y.jsx("option",{value:a,children:a},`mountain-tint-blend-${a}`))})]}),y.jsxs("div",{children:[y.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Tint Opacity ",e.walls.mountainTintOpacity.toFixed(2)]}),y.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.walls.mountainTintOpacity,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mountainTintOpacity:xe(qe(a.target.value,l.walls.mountainTintOpacity),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Wall Layout Mode"}),y.jsx("select",{value:e.walls.mode,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,mode:a.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:__.map(a=>y.jsx("option",{value:a,children:a},`wall-mode-${a}`))}),y.jsxs("div",{className:"space-y-2",children:[y.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Interior Density ",e.walls.interiorDensity.toFixed(2)]}),y.jsx("input",{type:"range",min:0,max:.45,step:.01,value:e.walls.interiorDensity,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,interiorDensity:xe(qe(a.target.value,l.walls.interiorDensity),0,.45)}}),className:"w-full"})]}),y.jsxs("div",{className:"space-y-2",children:[y.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Cluster Bias ",e.walls.clusterBias.toFixed(2)]}),y.jsx("input",{type:"range",min:0,max:1,step:.01,value:e.walls.clusterBias,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,clusterBias:xe(qe(a.target.value,l.walls.clusterBias),0,1)}}),className:"w-full"})]}),y.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/80",children:[y.jsx("input",{type:"checkbox",checked:e.walls.keepPerimeter,onChange:a=>n(l=>l&&{...l,walls:{...l.walls,keepPerimeter:a.target.checked}})}),"Keep perimeter walls (custom mode)"]})]}),N_=({settings:e,setSettings:n,pathSets:s,tintPickerColor:o})=>y.jsxs("section",{className:"space-y-3",children:[y.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-fuchsia-200",children:"Crust Materials"}),y.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45",children:"Detail A"}),y.jsx("input",{list:"sandbox-detail-paths",value:e.materials.detailA.path,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,detailA:{...l.materials.detailA,path:a.target.value}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),y.jsx("datalist",{id:"sandbox-detail-paths",children:s.detail.map(a=>y.jsx("option",{value:a},a))}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsx("select",{value:e.materials.detailA.mode,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,detailA:{...l.materials.detailA,mode:a.target.value}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Dl.map(a=>y.jsx("option",{value:a,children:a},`detail-a-${a}`))}),y.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.materials.detailA.opacity,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,detailA:{...l.materials.detailA,opacity:xe(qe(a.target.value,l.materials.detailA.opacity),0,1)}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsx("input",{type:"number",min:Yi,max:Ki,step:16,value:e.materials.detailA.scalePx,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,detailA:{...l.materials.detailA,scalePx:xe(qe(a.target.value,l.materials.detailA.scalePx),Yi,Ki)}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"}),y.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45 pt-1",children:"Detail B"}),y.jsx("input",{list:"sandbox-detail-paths",value:e.materials.detailB.path,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,detailB:{...l.materials.detailB,path:a.target.value}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsx("select",{value:e.materials.detailB.mode,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,detailB:{...l.materials.detailB,mode:a.target.value}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Dl.map(a=>y.jsx("option",{value:a,children:a},`detail-b-${a}`))}),y.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.materials.detailB.opacity,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,detailB:{...l.materials.detailB,opacity:xe(qe(a.target.value,l.materials.detailB.opacity),0,1)}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsx("input",{type:"number",min:Yi,max:Ki,step:16,value:e.materials.detailB.scalePx,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,detailB:{...l.materials.detailB,scalePx:xe(qe(a.target.value,l.materials.detailB.scalePx),Yi,Ki)}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"}),y.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45 pt-1",children:"Tint"}),y.jsxs("div",{className:"grid grid-cols-[72px_1fr] gap-3",children:[y.jsx("input",{type:"color",value:o,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,tintColor:a.target.value}}),className:"h-10 w-full rounded-lg border border-white/15 bg-white/5 p-1 cursor-pointer","aria-label":"Tint Color Picker"}),y.jsx("input",{value:e.materials.tintColor,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,tintColor:a.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",placeholder:"#8b6f4a"})]}),y.jsx("div",{className:"grid grid-cols-8 gap-2",children:E_.map(a=>y.jsx("button",{type:"button",onClick:()=>n(l=>l&&{...l,materials:{...l.materials,tintColor:a}}),className:`h-6 rounded border ${Ta(e.materials.tintColor)===Ta(a)?"border-white":"border-white/20"}`,style:{backgroundColor:a},title:a},`tint-swatch-${a}`))}),y.jsxs("div",{className:"space-y-2",children:[y.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Tint Opacity ",e.materials.tintOpacity.toFixed(2)]}),y.jsx("input",{type:"range",min:0,max:1,step:.01,value:e.materials.tintOpacity,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,tintOpacity:xe(qe(a.target.value,l.materials.tintOpacity),0,1)}}),className:"w-full"})]}),y.jsx("select",{value:e.materials.tintBlend,onChange:a=>n(l=>l&&{...l,materials:{...l.materials,tintBlend:Xl(a.target.value)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:T_.map(a=>y.jsx("option",{value:a,children:a},`blend-${a}`))})]}),k_=({settings:e,setSettings:n})=>y.jsxs("section",{className:"space-y-3 pb-8",children:[y.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-emerald-200",children:"Clutter"}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Density"}),y.jsx("input",{type:"number",min:0,max:1,step:.01,value:e.clutter.density,onChange:s=>n(o=>o&&{...o,clutter:{...o.clutter,density:xe(qe(s.target.value,o.clutter.density),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Max / Hex"}),y.jsx("input",{type:"number",min:0,max:5,step:1,value:e.clutter.maxPerHex,onChange:s=>n(o=>o&&{...o,clutter:{...o.clutter,maxPerHex:Math.max(0,Math.floor(qe(s.target.value,o.clutter.maxPerHex)))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),y.jsxs("div",{children:[y.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Bleed Max"}),y.jsx("input",{type:"number",min:1,max:2,step:.01,value:e.clutter.bleedScaleMax,onChange:s=>n(o=>o&&{...o,clutter:{...o.clutter,bleedScaleMax:xe(qe(s.target.value,o.clutter.bleedScaleMax),1,2)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]})]}),R_=({settings:e,setSettings:n,pathSets:s,copyStatus:o,onBack:a,onReset:l,onCopySettings:u,tintPickerColor:f,mountainTintPickerColor:p})=>y.jsxs("aside",{className:"w-[420px] border-r border-white/10 bg-[#02040a] overflow-y-auto",children:[y.jsxs("div",{className:"sticky top-0 z-20 border-b border-white/10 bg-[#02040a]/95 backdrop-blur p-4",children:[y.jsxs("div",{className:"flex items-center justify-between gap-3",children:[y.jsx("button",{type:"button",onClick:a,className:"px-3 py-2 rounded-lg border border-white/20 bg-white/5 hover:bg-white/10 text-[11px] font-black uppercase tracking-[0.18em]",children:"Back"}),y.jsx("button",{type:"button",onClick:l,className:"px-3 py-2 rounded-lg border border-amber-300/40 bg-amber-500/10 hover:bg-amber-500/20 text-[11px] font-black uppercase tracking-[0.18em]",children:"Reset"}),y.jsx("button",{type:"button",onClick:u,className:"px-3 py-2 rounded-lg border border-cyan-300/40 bg-cyan-500/10 hover:bg-cyan-500/20 text-[11px] font-black uppercase tracking-[0.18em]",children:"Copy JSON"})]}),y.jsxs("div",{className:"mt-3 text-[10px] uppercase tracking-[0.22em] text-white/50",children:["Hop / Biomes ",o?`* ${o}`:""]})]}),y.jsxs("div",{className:"p-4 space-y-6",children:[y.jsx(w_,{settings:e,setSettings:n}),y.jsx(M_,{settings:e,setSettings:n,pathSets:s}),y.jsx(C_,{settings:e,setSettings:n,pathSets:s}),y.jsx(O_,{settings:e,setSettings:n,pathSets:s,mountainTintPickerColor:p}),y.jsx(N_,{settings:e,setSettings:n,pathSets:s,tintPickerColor:f}),y.jsx(k_,{settings:e,setSettings:n})]})]}),I_=({presets:e,activePreset:n,onSelectPreset:s,onResetView:o})=>y.jsx("div",{className:"absolute top-2 right-2 sm:top-3 sm:right-3 z-30 flex items-center gap-1.5 pointer-events-auto",children:y.jsxs("div",{className:"flex items-center gap-1 rounded-xl border border-white/15 bg-black/35 backdrop-blur-sm p-1",children:[e.map(a=>{const l=n===a;return y.jsx("button",{type:"button",onPointerDown:u=>u.stopPropagation(),onClick:()=>s(a),className:`px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest transition-colors ${l?"bg-white text-black":"bg-white/5 text-white/70 hover:bg-white/10"}`,"aria-label":`Set zoom to ${a} tiles wide`,children:a},`zoom-${a}`)}),y.jsx("button",{type:"button",onPointerDown:a=>a.stopPropagation(),onClick:o,className:"px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest bg-white/5 text-white/70 hover:bg-white/10","aria-label":"Reset camera to player",children:"Fit"})]})}),L_=({cells:e,biomeClipId:n,biomeClipPoints:s,maskHexPoints:o,biomeCoverFrame:a,undercurrentHref:l,undercurrentMode:u,undercurrentPatternId:f,undercurrentScalePx:p,undercurrentOffset:h,undercurrentScroll:g,crustHref:b,crustMode:S,crustPatternId:T,crustScalePx:v,crustPatternShift:A,crustDetailAHref:_,crustDetailAMode:E,crustDetailAPatternId:w,crustDetailAScalePx:M,crustDetailAShift:C,crustDetailAScroll:I,crustDetailBHref:k,crustDetailBMode:R,crustDetailBPatternId:$,crustDetailBScalePx:j,crustDetailBShift:D,crustDetailBScroll:q,crustMaskEnabled:se,crustMaskId:ee,crustMaskHoles:oe})=>y.jsxs("defs",{children:[y.jsx("clipPath",{id:n,clipPathUnits:"userSpaceOnUse",children:e.map(F=>{const{x:H,y:z}=Ae(F,X);return y.jsx("polygon",{points:s,transform:`translate(${H},${z})`},`biome-clip-${ce(F)}`)})}),l&&u==="repeat"&&y.jsxs("pattern",{id:f,patternUnits:"userSpaceOnUse",width:p,height:p,patternTransform:`translate(${h.x} ${h.y})`,children:[y.jsx("image",{href:l,x:"0",y:"0",width:p,height:p,preserveAspectRatio:"xMidYMid slice"}),(g.x!==0||g.y!==0)&&y.jsx("animateTransform",{attributeName:"patternTransform",type:"translate",from:`${h.x} ${h.y}`,to:`${h.x+g.x} ${h.y+g.y}`,dur:`${g.durationMs}ms`,repeatCount:"indefinite"})]}),b&&S==="repeat"&&y.jsx("pattern",{id:T,patternUnits:"userSpaceOnUse",width:v,height:v,patternTransform:`translate(${A.x} ${A.y})`,children:y.jsx("image",{href:b,x:"0",y:"0",width:v,height:v,preserveAspectRatio:"xMidYMid slice"})}),_&&E==="repeat"&&y.jsxs("pattern",{id:w,patternUnits:"userSpaceOnUse",width:M,height:M,patternTransform:`translate(${C.x} ${C.y})`,children:[y.jsx("image",{href:_,x:"0",y:"0",width:M,height:M,preserveAspectRatio:"xMidYMid slice"}),(I.x!==0||I.y!==0)&&y.jsx("animateTransform",{attributeName:"patternTransform",type:"translate",from:`${C.x} ${C.y}`,to:`${C.x+I.x} ${C.y+I.y}`,dur:`${I.durationMs}ms`,repeatCount:"indefinite"})]}),k&&R==="repeat"&&y.jsxs("pattern",{id:$,patternUnits:"userSpaceOnUse",width:j,height:j,patternTransform:`translate(${D.x} ${D.y})`,children:[y.jsx("image",{href:k,x:"0",y:"0",width:j,height:j,preserveAspectRatio:"xMidYMid slice"}),(q.x!==0||q.y!==0)&&y.jsx("animateTransform",{attributeName:"patternTransform",type:"translate",from:`${D.x} ${D.y}`,to:`${D.x+q.x} ${D.y+q.y}`,dur:`${q.durationMs}ms`,repeatCount:"indefinite"})]}),se&&y.jsxs("mask",{id:ee,maskUnits:"userSpaceOnUse",maskContentUnits:"userSpaceOnUse",x:a.x,y:a.y,width:a.width,height:a.height,children:[y.jsx("rect",{x:a.x,y:a.y,width:a.width,height:a.height,fill:"white"}),oe.map(F=>y.jsx("polygon",{points:o,transform:`translate(${F.x},${F.y})`,fill:"black",opacity:1},`hole-${F.key}`))]})]}),B_=({biomeClipId:e,biomeFrame:n,biomeCoverFrame:s,undercurrentHref:o,undercurrentMode:a,undercurrentPatternId:l,undercurrentOffset:u,undercurrentOpacity:f,crustHref:p,crustMode:h,crustPatternId:g,crustPatternShift:b,crustOpacity:S,crustDetailAHref:T,crustDetailAMode:v,crustDetailAPatternId:A,crustDetailAShift:_,crustDetailAOpacity:E,crustDetailBHref:w,crustDetailBMode:M,crustDetailBPatternId:C,crustDetailBShift:I,crustDetailBOpacity:k,crustMaskId:R,crustTintActive:$,crustTintColor:j,crustTintOpacity:D,crustTintBlendMode:q})=>y.jsxs(y.Fragment,{children:[y.jsxs("g",{"data-layer":"biome-undercurrent",pointerEvents:"none",clipPath:`url(#${e})`,children:[o&&a==="repeat"&&y.jsx("rect",{x:n.x,y:n.y,width:n.width,height:n.height,fill:`url(#${l})`,opacity:f}),o&&a==="cover"&&y.jsx("image",{href:o,x:s.x+u.x,y:s.y+u.y,width:s.width,height:s.height,preserveAspectRatio:"xMidYMid slice",opacity:f})]}),y.jsxs("g",{"data-layer":"biome-crust",pointerEvents:"none",clipPath:`url(#${e})`,children:[p&&h==="repeat"&&y.jsx("rect",{x:n.x,y:n.y,width:n.width,height:n.height,fill:`url(#${g})`,opacity:S,mask:`url(#${R})`}),p&&h==="cover"&&y.jsx("image",{href:p,x:s.x+b.x,y:s.y+b.y,width:s.width,height:s.height,preserveAspectRatio:"xMidYMid slice",opacity:S,mask:`url(#${R})`}),T&&v==="repeat"&&E>0&&y.jsx("rect",{x:n.x,y:n.y,width:n.width,height:n.height,fill:`url(#${A})`,opacity:E,mask:`url(#${R})`}),T&&v==="cover"&&E>0&&y.jsx("image",{href:T,x:s.x+_.x,y:s.y+_.y,width:s.width,height:s.height,preserveAspectRatio:"xMidYMid slice",opacity:E,mask:`url(#${R})`}),w&&M==="repeat"&&k>0&&y.jsx("rect",{x:n.x,y:n.y,width:n.width,height:n.height,fill:`url(#${C})`,opacity:k,mask:`url(#${R})`}),w&&M==="cover"&&k>0&&y.jsx("image",{href:w,x:s.x+I.x,y:s.y+I.y,width:s.width,height:s.height,preserveAspectRatio:"xMidYMid slice",opacity:k,mask:`url(#${R})`}),$&&j&&y.jsx("rect",{x:n.x,y:n.y,width:n.width,height:n.height,fill:j,opacity:D,mask:`url(#${R})`,style:q!=="normal"?{mixBlendMode:q}:void 0})]})]}),H_=({cells:e,biomeClipId:n,biomeClipPoints:s,maskHexPoints:o,biomeFrame:a,biomeCoverFrame:l,undercurrentHref:u,undercurrentMode:f,undercurrentPatternId:p,undercurrentScalePx:h,undercurrentOffset:g,undercurrentScroll:b,undercurrentOpacity:S,crustHref:T,crustMode:v,crustPatternId:A,crustScalePx:_,crustPatternShift:E,crustOpacity:w,crustDetailAHref:M,crustDetailAMode:C,crustDetailAPatternId:I,crustDetailAScalePx:k,crustDetailAShift:R,crustDetailAScroll:$,crustDetailAOpacity:j,crustDetailBHref:D,crustDetailBMode:q,crustDetailBPatternId:se,crustDetailBScalePx:ee,crustDetailBShift:oe,crustDetailBScroll:F,crustDetailBOpacity:H,crustMaskEnabled:z,crustMaskId:Z,crustMaskHoles:re,crustTintActive:pe,crustTintColor:B,crustTintOpacity:W,crustTintBlendMode:G})=>y.jsxs(y.Fragment,{children:[y.jsx(L_,{cells:e,biomeClipId:n,biomeClipPoints:s,maskHexPoints:o,biomeCoverFrame:l,undercurrentHref:u,undercurrentMode:f,undercurrentPatternId:p,undercurrentScalePx:h,undercurrentOffset:g,undercurrentScroll:b,crustHref:T,crustMode:v,crustPatternId:A,crustScalePx:_,crustPatternShift:E,crustDetailAHref:M,crustDetailAMode:C,crustDetailAPatternId:I,crustDetailAScalePx:k,crustDetailAShift:R,crustDetailAScroll:$,crustDetailBHref:D,crustDetailBMode:q,crustDetailBPatternId:se,crustDetailBScalePx:ee,crustDetailBShift:oe,crustDetailBScroll:F,crustMaskEnabled:z,crustMaskId:Z,crustMaskHoles:re}),y.jsx(B_,{biomeClipId:n,biomeFrame:a,biomeCoverFrame:l,undercurrentHref:u,undercurrentMode:f,undercurrentPatternId:p,undercurrentOffset:g,undercurrentOpacity:S,crustHref:T,crustMode:v,crustPatternId:A,crustPatternShift:E,crustOpacity:w,crustDetailAHref:M,crustDetailAMode:C,crustDetailAPatternId:I,crustDetailAShift:R,crustDetailAOpacity:j,crustDetailBHref:D,crustDetailBMode:q,crustDetailBPatternId:se,crustDetailBShift:oe,crustDetailBOpacity:H,crustMaskId:Z,crustTintActive:pe,crustTintColor:B,crustTintOpacity:W,crustTintBlendMode:G})]}),Cd=e=>{const n=[];for(let s=0;s<6;s++){const o=60*s,a=Math.PI/180*o,l=e*Math.cos(a),u=e*Math.sin(a);n.push(`${l},${u}`)}return n.join(" ")},P_=()=>typeof window>"u"?!1:!!window.__HOP_DEBUG_HEX_COORDS,j_=[{cx:-8,cy:-6,r:3,delay:0},{cx:6,cy:2,r:2.5,delay:.3},{cx:-3,cy:8,r:2,delay:.6}],D_=e=>{const n=[[-.6,.42],[-.5,.15],[-.34,-.18],[-.16,-.36],[0,-.62],[.12,-.42],[.3,-.2],[.48,.1],[.6,.4],[.4,.48],[-.48,.48]],s=[[-.48,.48],[-.6,.42],[-.34,-.18],[-.18,-.24],[-.28,.28]],o=[[.6,.4],[.4,.48],[.2,.28],[.3,-.2],[.48,.1]],a=[[-.34,-.18],[-.16,-.36],[0,-.62],[.12,-.42],[.3,-.2]],l=[[-.46,.1],[-.3,-.12],[-.1,-.24],[0,-.4]],u=f=>f.map(([p,h])=>`${(p*e).toFixed(2)},${(h*e).toFixed(2)}`).join(" ");return{body:u(n),leftFace:u(s),rightFace:u(o),ridgeA:u(a),ridgeB:u(l)}},U_=({hex:e,onClick:n,isValidMove:s,isTargeted:o,isStairs:a,isLava:l,isShrine:u,isWall:f,isFire:p,onMouseEnter:h,assetHref:g,interactionOnly:b})=>{const[S,T]=N.useState(!1);N.useEffect(()=>{T(!1)},[g]);const{x:v,y:A}=Ae(e,X),_=P_(),E=Cd(X-2),w=D_(X-2),M=`hex-clip-${e.q}-${e.r}-${e.s}`;let C=il.floor,I="rgba(0,0,0,0.2)",k="default";f?(C=il.wall,I="#1f2937"):l?(C="#7f1d1d",I="#7f1d1d"):p?(C="#7c2d12",I="#ea580c"):a?(C=il.portal,I="#000000"):u&&(C=il.shrine,I="#c2410c"),b&&(C="transparent",I="rgba(255,255,255,0.10)"),s&&(I="rgba(255,255,255,0.78)",k="pointer"),o&&(I="#f97316");const R=!!g&&!b&&!S;return y.jsxs("g",{transform:`translate(${v},${A})`,onClick:()=>n(e),onMouseEnter:()=>h?.(e),style:{cursor:k},className:"hex-tile transition-colors duration-200",children:[f&&R&&y.jsx("polygon",{points:Cd(X-2),fill:"#111827",transform:"translate(0, 4)"}),!R&&(f?y.jsxs("g",{"data-wall-fallback":"relief",children:[y.jsx("ellipse",{cx:"0",cy:X*.56,rx:X*.56,ry:X*.18,fill:"rgba(3,7,18,0.55)"}),y.jsx("polygon",{points:E,fill:"#0f172a",transform:"translate(0, 5)",opacity:"0.92"}),y.jsx("polygon",{points:E,fill:"#1f2937",transform:"translate(0, 2)",opacity:"0.98"}),y.jsx("polygon",{points:E,fill:"#273447"}),y.jsx("polygon",{points:w.body,fill:"#4b5563",opacity:"0.96"}),y.jsx("polygon",{points:w.leftFace,fill:"#6b7280",opacity:"0.9"}),y.jsx("polygon",{points:w.rightFace,fill:"#374151",opacity:"0.95"}),y.jsx("polyline",{points:w.ridgeA,fill:"none",stroke:"rgba(229,231,235,0.55)",strokeWidth:"1.1",strokeLinecap:"round",strokeLinejoin:"round"}),y.jsx("polyline",{points:w.ridgeB,fill:"none",stroke:"rgba(17,24,39,0.58)",strokeWidth:"1",strokeLinecap:"round",strokeLinejoin:"round"}),y.jsx("polygon",{points:E,fill:"none",stroke:I,strokeWidth:o||s?"2":"1"})]}):y.jsx("polygon",{points:E,fill:C,stroke:I,strokeWidth:o||s?"2":"1"})),R&&y.jsxs(y.Fragment,{children:[y.jsx("defs",{children:y.jsx("clipPath",{id:M,children:y.jsx("polygon",{points:E})})}),y.jsx("image",{href:g,x:-X,y:-31.176,width:X*2,height:X*1.732,preserveAspectRatio:"xMidYMid slice",clipPath:`url(#${M})`,onError:()=>T(!0)}),y.jsx("polygon",{points:E,fill:"none",stroke:I,strokeWidth:o||s?"2":"1"})]}),l&&!b&&y.jsxs("g",{className:"lava-bubbles",children:[j_.map(($,j)=>y.jsx("circle",{cx:$.cx,cy:$.cy,r:$.r,fill:"#fbbf24",opacity:"0.7",style:{animation:`lavaBubble 2s ease-in-out ${$.delay}s infinite`}},j)),y.jsx("polygon",{points:Cd(X-4),fill:"none",stroke:"#f97316",strokeWidth:"1",opacity:"0.35"})]}),p&&!b&&y.jsxs("g",{className:"fire-embers",children:[y.jsx("circle",{cx:"-6",cy:"4",r:"2",fill:"#fbbf24",opacity:"0.75",style:{animation:"lavaBubble 1.6s ease-in-out 0s infinite"}}),y.jsx("circle",{cx:"4",cy:"-6",r:"1.5",fill:"#fcd34d",opacity:"0.75",style:{animation:"lavaBubble 1.4s ease-in-out 0.5s infinite"}})]}),_&&y.jsx("text",{x:"0",y:"0",textAnchor:"middle",fill:"rgba(0,0,0,0.15)",fontSize:"8",dy:".3em",pointerEvents:"none",children:`${e.q},${e.r}`})]})},$_=kn.memo(U_,(e,n)=>e.hex.q===n.hex.q&&e.hex.r===n.hex.r&&e.hex.s===n.hex.s&&e.onClick===n.onClick&&e.onMouseEnter===n.onMouseEnter&&e.isCenter===n.isCenter&&e.isSelected===n.isSelected&&e.isValidMove===n.isValidMove&&e.isTargeted===n.isTargeted&&e.isStairs===n.isStairs&&e.isLava===n.isLava&&e.isShrine===n.isShrine&&e.isWall===n.isWall&&e.isFire===n.isFire&&e.assetHref===n.assetHref&&e.interactionOnly===n.interactionOnly),q_=({gameState:e,selectedSkillId:n,showMovementRange:s,hoveredTile:o,enginePreviewGhost:a})=>{const l=e.player.position,u=N.useMemo(()=>{const S=new Set;for(const T of e.enemies)T.hp>0&&S.add(ce(T.position));return S},[e.enemies]),f=N.useMemo(()=>{if(!s||n)return[];const S=new Set(e.player.activeSkills.map(_=>_.id)),T=["BASIC_MOVE","DASH"],v=new Set,A=[];return T.forEach(_=>{if(S.has(_)){const E=st.get(_);E?.getValidTargets&&E.getValidTargets(e,l).forEach(M=>{const C=ce(M);v.has(C)||(v.add(C),A.push(M))})}}),A.length===0?[{q:l.q+1,r:l.r,s:l.s-1},{q:l.q+1,r:l.r-1,s:l.s},{q:l.q,r:l.r-1,s:l.s+1},{q:l.q-1,r:l.r,s:l.s+1},{q:l.q-1,r:l.r+1,s:l.s},{q:l.q,r:l.r+1,s:l.s-1}].filter(E=>Gi(E,e.gridWidth,e.gridHeight)):A},[e,s,n,l]),p=N.useMemo(()=>{const S=new Set;for(const T of f)S.add(ce(T));return S},[f]),h=N.useMemo(()=>{if(!n)return[];const S=st.get(n),T=P1(e.player,n)||S?.baseVariables?.range||0,v=S?.getValidTargets?S.getValidTargets(e,l):[],A=new Set(v.map(ce)),_=[];if(n==="DASH"||n==="SPEAR_THROW"||n==="SHIELD_THROW"||n==="GRAPPLE_HOOK")for(let w=0;w<6;w++)for(let M=1;M<=T;M++){const C=Vt(l,Zd(w,M));if(!Gi(C,e.gridWidth,e.gridHeight))break;const I=Me.isLosBlocking(e,C),k=u.has(ce(C)),j=Ze(l,C).slice(1,-1).some(q=>Me.isLosBlocking(e,q)||u.has(ce(q))),D=A.has(ce(C));if(_.push({p:C,isValidTarget:D,isBlocked:j,isWall:I,isEnemy:k}),I||k)break}else v.forEach(w=>{const M=Me.isLosBlocking(e,w),C=u.has(ce(w));_.push({p:w,isValidTarget:!0,isBlocked:!1,isWall:M,isEnemy:C})});return _},[e,n,l,u]),g=N.useMemo(()=>{const S=new Map;for(const T of h)S.set(ce(T.p),T);return S},[h]),b=N.useMemo(()=>{if(a)return a;if(s&&o&&!n&&p.has(ce(o)))return{path:Ze(l,o),aoe:[],hasEnemy:!1,target:o};if(!n||!o)return null;const S=g.get(ce(o));if(!S||!S.isValidTarget||S.isBlocked)return null;const T=Ze(l,o),v=Lv(e,n,l,o),A=S.isEnemy;return{path:T,aoe:v,hasEnemy:A,target:o}},[a,e,n,o,g,p,s,l]);return y.jsx("g",{pointerEvents:"none",children:b&&y.jsxs("g",{children:[(()=>{const S=b.path.map(w=>Ae(w,X)),T=S.map((w,M)=>`${M===0?"M":"L"} ${w.x} ${w.y}`).join(" "),v=S[S.length-1],A=S[S.length-2]||{x:v.x-1,y:v.y},_=Math.atan2(v.y-A.y,v.x-A.x),E=8;return y.jsxs("g",{children:[y.jsx("path",{d:T,stroke:"rgba(255,255,255,0.9)",strokeWidth:"2.25",fill:"none",opacity:"0.85",style:{filter:"drop-shadow(0 0 4px rgba(255,255,255,0.22))"}}),y.jsx("path",{d:`M ${v.x} ${v.y} L ${v.x-E*Math.cos(_-Math.PI/6)} ${v.y-E*Math.sin(_-Math.PI/6)} M ${v.x} ${v.y} L ${v.x-E*Math.cos(_+Math.PI/6)} ${v.y-E*Math.sin(_+Math.PI/6)}`,stroke:"rgba(255,255,255,0.95)",strokeWidth:"2",opacity:"0.9"})]})})(),b.hasEnemy&&(()=>{const{x:S,y:T}=Ae(b.target,X),v=X*.7;return y.jsxs("g",{children:[y.jsx("circle",{cx:S,cy:T,r:v,fill:"none",stroke:"#ef4444",strokeWidth:"2",strokeDasharray:"4 2"}),y.jsx("line",{x1:S-v,y1:T,x2:S+v,y2:T,stroke:"#ef4444",strokeWidth:"1"}),y.jsx("line",{x1:S,y1:T-v,x2:S,y2:T+v,stroke:"#ef4444",strokeWidth:"1"})]})})(),!b.hasEnemy&&(()=>{const{x:S,y:T}=Ae(b.target,X);return y.jsx("circle",{cx:S,cy:T,r:X*.36,fill:"rgba(255,255,255,0.14)",stroke:"rgba(255,255,255,0.65)",strokeWidth:1.5})})(),Array.from(new Map(b.aoe.map(S=>[ce(S),S])).values()).map(S=>{const{x:T,y:v}=Ae(S,X);return y.jsx("circle",{cx:T,cy:v,r:X*.6,fill:"rgba(239, 68, 68, 0.2)",stroke:"rgba(239, 68, 68, 0.5)",strokeWidth:2,strokeDasharray:"4 2"},`aoe-${S.q}-${S.r}`)})]})})},z_=["white","blue","black","red","green"],og={white:{label:"Plains / Mesa",floorAssetId:"tile.catacombs.floor.01",hazardAssetId:"tile.catacombs.lava.01"},blue:{label:"Islands / Coast",floorAssetId:"tile.frozen.floor.01",hazardAssetId:"tile.catacombs.lava.01"},black:{label:"Swamp / Wastes",floorAssetId:"tile.void.floor.01",hazardAssetId:"tile.catacombs.lava.01"},red:{label:"Mountains / Volcanic",floorAssetId:"tile.inferno.floor.01",hazardAssetId:"tile.inferno.lava.01"},green:{label:"Forest / Jungle",floorAssetId:"tile.throne.floor.01",hazardAssetId:"tile.catacombs.lava.01"}},V_={catacombs:"white",frozen:"blue",void:"black",inferno:"red",throne:"green"},Y_=e=>{if(typeof e!="string")return;const n=e.toLowerCase();return z_.includes(n)?n:void 0},K_=()=>{if(!(typeof window>"u"))return Y_(window.__HOP_FORCE_BIOME)},F_=e=>{const n=K_();if(n)return n;const s=String(e||"").toLowerCase();return V_[s]||"white"},W_=e=>{const n=F_(e.theme);return e.isWall?"tile.catacombs.wall.01":e.isLava?og[n].hazardAssetId:e.isFire?"tile.catacombs.fire.01":og[n].floorAssetId},rg=e=>{if(e.isStairs)return"prop.core.stairs.01";if(e.isShrine)return"prop.core.shrine.01"},Fi=e=>{if(e.type==="player")switch(e.archetype){case"FIREMAGE":return"unit.player.firemage.04";case"SKIRMISHER":return"unit.player.skirmisher.01";case"HUNTER":return"unit.player.hunter.01";case"NECROMANCER":return"unit.player.necromancer.01";case"ASSASSIN":return"unit.player.assassin.01";default:return"unit.player.vanguard.01"}switch(e.subtype){case"footman":return"unit.enemy.footman.01";case"shield_bearer":return"unit.enemy.shield_bearer.01";case"archer":return"unit.enemy.archer.01";case"warlock":return"unit.enemy.warlock.01";case"bomber":return"unit.enemy.bomber.01";case"bomb":return"unit.enemy.bomb.01";default:return e.enemyType==="boss"?"unit.enemy.boss.01":"unit.enemy.footman.01"}},lg="/Hop",cg=(e,n)=>`${e.endsWith("/")?e:`${e}/`}${n.replace(/^\/+/,"")}`,G_=e=>/^(?:[a-z]+:)?\/\//i.test(e)||e.startsWith("data:")?e:e.startsWith("/")?e.startsWith("/assets/")?cg(lg,e.slice(1)):e:cg(lg,e),X_={"unit.player.vanguard.01":"/assets/units/unit.player.vanguard.01.svg","unit.player.firemage.04":"/assets/units/unit.player.firemage.02.svg","unit.player.skirmisher.01":"/assets/units/unit.player.skirmisher.01.svg","unit.player.hunter.01":"/assets/units/unit.player.skirmisher.01.svg","unit.player.necromancer.01":"/assets/units/unit.player.vanguard.01.svg","unit.player.assassin.01":"/assets/units/unit.player.skirmisher.01.svg","unit.enemy.footman.01":"/assets/units/unit.enemy.footman.01.svg","unit.enemy.shield_bearer.01":"/assets/units/unit.enemy.shield_bearer.01.svg","unit.enemy.archer.01":"/assets/units/unit.enemy.archer.01.svg","unit.enemy.warlock.01":"/assets/units/unit.enemy.warlock.01.svg","unit.enemy.bomber.01":"/assets/units/unit.enemy.bomber.01.svg","unit.enemy.bomb.01":"/assets/units/unit.enemy.bomb.01.svg","unit.enemy.boss.01":"/assets/units/unit.enemy.boss.01.svg"},As=e=>{const n=Fi(e),s=X_[n];return s?G_(s):void 0},J_=e=>{if(e==="impact")return"fx.core.impact.01";if(e==="vaporize")return"fx.core.vaporize.01";if(e==="lava_ripple")return"fx.core.lava_ripple.01";if(e==="explosion_ring")return"fx.core.explosion_ring.01"},Q_=()=>"ui.core.hp_frame.01",Z_=()=>"decal.combat.blood.01",ew=({gameState:e,selectedSkillId:n,showMovementRange:s,hoveredTile:o,enginePreviewGhost:a,cells:l,tileVisualFlags:u,movementTargetSet:f,hasPrimaryMovementSkills:p,fallbackNeighborSet:h,selectedSkillTargetSet:g,stairsKey:b,shrineKey:S,mountainCoveredWallKeys:T,hybridInteractionLayerEnabled:v,assetById:A,onTileClick:_,onTileHover:E,decals:w})=>y.jsxs(y.Fragment,{children:[y.jsx("g",{"data-layer":"interaction-preview",children:y.jsx(q_,{gameState:e,selectedSkillId:n,showMovementRange:s,hoveredTile:o,enginePreviewGhost:a})}),y.jsxs("g",{"data-layer":"interaction-tiles",children:[l.map(M=>{const C=ce(M),I=u.get(C)||{isWall:!1,isLava:!1,isFire:!1},k=I.isWall,R=I.isLava,$=I.isFire,j=s&&!n&&f.has(C)||s&&!n&&!p&&h.has(C)&&!k,q=!!n&&g.has(C)||j,se=C===b,ee=S?C===S:!1,oe=k&&!T.has(C),F=v&&!oe,H=W_({isWall:oe,isLava:R,isFire:$,theme:e.theme}),z=F?void 0:A.get(H)?.path;return y.jsx($_,{hex:M,onClick:_,isValidMove:q,isTargeted:!1,isStairs:se,isLava:R,isFire:$,isShrine:ee,isWall:oe,onMouseEnter:E,assetHref:z,interactionOnly:F},C)}),y.jsx("g",{children:w.map(M=>{const{x:C,y:I}=Ae(M.position,X),k=Date.now()-M.createdAt,R=Math.max(.18,.75-k/12e3*.57);return y.jsx("image",{href:M.href,x:C-X*.7,y:I-X*.7,width:X*1.4,height:X*1.4,preserveAspectRatio:"xMidYMid meet",opacity:R},M.id)})})]})]}),tw=e=>e.replace(/[^a-zA-Z0-9_-]/g,"-"),nw=(e,n,s)=>y.jsxs("g",{transform:`translate(${n},${s})`,children:[y.jsx("polygon",{points:"0,-18 8,-4 5,12 -5,12 -8,-4",fill:"#f97316",stroke:"#fff",strokeWidth:"1",opacity:"0.9"}),y.jsx("polygon",{points:"-2,-14 2,-14 1,-2 -1,-2",fill:"rgba(255,255,255,0.6)"}),y.jsx("circle",{cx:"0",cy:"0",r:"14",fill:"none",stroke:"#fdba74",strokeWidth:"2",opacity:"0.4",style:{animation:"shrineGlow 2s ease-in-out infinite"}})]},e.id),iw=(e,n,s)=>y.jsxs("g",{transform:`translate(${n},${s})`,children:[y.jsx("rect",{x:"-12",y:"6",width:"8",height:"4",fill:"#1f2937",rx:"1"}),y.jsx("rect",{x:"-6",y:"2",width:"8",height:"4",fill:"#374151",rx:"1"}),y.jsx("rect",{x:"0",y:"-2",width:"8",height:"4",fill:"#4b5563",rx:"1"}),y.jsx("rect",{x:"6",y:"-6",width:"8",height:"4",fill:"#6b7280",rx:"1"}),y.jsx("path",{d:"M 2 -14 L 2 -20 L -4 -20 L 2 -26 L 8 -20 L 2 -20",fill:"#22c55e",stroke:"#16a34a",strokeWidth:"1"})]},e.id),sw=(e,n,s,o,a,l,u)=>{const f=e.asset;if(!f?.path)return null;const p=Math.min(1,Math.max(0,f.anchor?.x??.5)),h=Math.min(1,Math.max(0,f.anchor?.y??.5)),g=e.kind==="mountain",b=g?l.get(f.id)||u(f):null,S=b?b.anchorX:p,T=b?b.anchorY:h,v=s+(b?b.offsetX:0),A=o+(b?b.offsetY:0),_=Math.max(8,f.width*a*e.renderScale),E=Math.max(8,f.height*a*e.renderScale),w=e.kind==="shrine",M=e.kind==="stairs",C=w||M,I=w?"rgba(251,146,60,0.25)":"rgba(74,222,128,0.22)",k=w?"#fdba74":"#86efac",R=s,$=o-E*T+E*.84,j=Math.max(14,_*.32),D=Math.max(8,E*.14),q=C?w?"drop-shadow(0 4px 6px rgba(0,0,0,0.55)) drop-shadow(0 0 4px rgba(251,146,60,0.45)) saturate(1.08) contrast(1.06)":"drop-shadow(0 4px 6px rgba(0,0,0,0.55)) drop-shadow(0 0 4px rgba(74,222,128,0.42)) saturate(1.08) contrast(1.06)":g?"drop-shadow(0 7px 10px rgba(0,0,0,0.56)) saturate(1.04) contrast(1.08)":"drop-shadow(0 5px 8px rgba(0,0,0,0.48)) saturate(0.98) contrast(1.04)",se=C?.99:g?.96:.9,ee=!!(b&&b.crustBlendMode!=="off"&&b.crustBlendOpacity>0),oe=!!(b&&b.tintBlendMode!=="off"&&b.tintOpacity>0),F=b?.crustBlendMode!=="off"?b?.crustBlendMode:void 0,H=b?.tintBlendMode!=="off"?b?.tintBlendMode:void 0,z=v-_*S,Z=A-E*T,re=tw(e.id),pe=`mountain-ground-gradient-${n}-${re}`,B=`mountain-ground-mask-${n}-${re}`,W=`mountain-tint-filter-${n}-${re}`;return y.jsxs("g",{children:[C&&y.jsxs(y.Fragment,{children:[y.jsx("ellipse",{cx:R,cy:$,rx:j,ry:D,fill:I,opacity:.95}),y.jsx("ellipse",{cx:R,cy:$,rx:j*1.14,ry:D*1.14,fill:"none",stroke:k,strokeWidth:2,opacity:.72,style:{animation:`shrineGlow ${w?1.8:2.4}s ease-in-out infinite`}})]}),(ee||oe)&&y.jsxs("defs",{children:[ee&&y.jsxs(y.Fragment,{children:[y.jsxs("linearGradient",{id:pe,x1:"0",y1:"0",x2:"0",y2:"1",children:[y.jsx("stop",{offset:"0%",stopColor:"#ffffff",stopOpacity:"0"}),y.jsx("stop",{offset:"42%",stopColor:"#ffffff",stopOpacity:"0.04"}),y.jsx("stop",{offset:"64%",stopColor:"#ffffff",stopOpacity:"0.42"}),y.jsx("stop",{offset:"82%",stopColor:"#ffffff",stopOpacity:"0.82"}),y.jsx("stop",{offset:"100%",stopColor:"#ffffff",stopOpacity:"1"})]}),y.jsx("mask",{id:B,maskUnits:"userSpaceOnUse",maskContentUnits:"userSpaceOnUse",children:y.jsx("rect",{x:z,y:Z,width:_,height:E,fill:`url(#${pe})`})})]}),oe&&y.jsx("filter",{id:W,x:"-10%",y:"-10%",width:"120%",height:"120%",children:y.jsx("feColorMatrix",{type:"matrix",values:b?.tintMatrixValues})})]}),y.jsx("image",{href:f.path,x:z,y:Z,width:_,height:E,preserveAspectRatio:"xMidYMid meet",opacity:se,style:{filter:q}}),ee&&y.jsx("image",{href:f.path,x:z,y:Z,width:_,height:E,preserveAspectRatio:"xMidYMid meet",opacity:Math.min(.9,b?.crustBlendOpacity||0),mask:`url(#${B})`,style:{mixBlendMode:F,filter:"brightness(0.92) saturate(0.76) contrast(1.03)"}}),oe&&y.jsx("image",{href:f.path,x:z,y:Z,width:_,height:E,preserveAspectRatio:"xMidYMid meet",opacity:Math.min(.95,b?.tintOpacity||0),filter:`url(#${W})`,style:{mixBlendMode:H}})]},e.id)},aw=({sprite:e,floor:n,manifestUnitToBoardScale:s,mountainSettingsByAssetId:o,resolveMountainSettings:a})=>{const{x:l,y:u}=Ae(e.position,X);return e.asset?.path?sw(e,n,l,u,s,o,a):e.fallback==="shrine"?nw(e,l,u):iw(e,l,u)},ow=({sprites:e,floor:n,manifestUnitToBoardScale:s,mountainSettingsByAssetId:o,resolveMountainSettings:a})=>y.jsx("g",{"data-layer":"clutter-obstacles",pointerEvents:"none",children:e.map(l=>aw({sprite:l,floor:n,manifestUnitToBoardScale:s,mountainSettingsByAssetId:o,resolveMountainSettings:a}))}),rw={catacombs:.2,inferno:.16,throne:.24,frozen:.45,void:.08},lw=(e,n)=>{const s=Math.max(e,n),o=Math.min(e,n);return(s+.05)/(o+.05)},cw=e=>{const n=String(e||"").toLowerCase(),s=rw[n]??.22;return lw(s,.86)<4.5?1.22:1.06},uw=(e,n,s=24,o,a,l=1)=>{const u=Uo(e.subtype,e.type,e.enemyType,e.archetype),{icon:f,shape:p,color:h,borderColor:g,size:b=1}=u,S=s*b,T=e.statusEffects?.find(E=>E.type==="time_bomb"),v=T?Math.max(0,T.duration):e.actionCooldown??0,A=`contrast(${l.toFixed(2)}) brightness(${(l>1?1.12:1.04).toFixed(2)})`,_=n?`drop-shadow(0 3px 4px rgba(0,0,0,0.45)) drop-shadow(0 0 2px rgba(255,255,255,0.5)) saturate(1.08) ${A}`:`drop-shadow(0 3px 4px rgba(0,0,0,0.50)) drop-shadow(0 0 2px rgba(255,255,255,0.35)) saturate(1.0) ${A}`;return y.jsxs("g",{children:[y.jsx("title",{children:n?"Player":`${e.subtype||"Enemy"}`}),o&&y.jsx("image",{href:o,x:-S,y:-S,width:S*2,height:S*2,preserveAspectRatio:"xMidYMid meet",onError:a,style:{filter:_,opacity:n?1:.97}}),!o&&p==="square"&&y.jsx("rect",{x:-S*.8,y:-S*.8,width:S*1.6,height:S*1.6,fill:h,stroke:g,strokeWidth:2}),!o&&p==="diamond"&&y.jsx("path",{d:`M0 ${-S*.8} L${S*.6} 0 L0 ${S*.8} L${-S*.6} 0 Z`,fill:h,stroke:g,strokeWidth:1}),!o&&p==="triangle"&&y.jsx("path",{d:`M0 ${-S*.8} L${S*.7} ${S*.5} L${-S*.7} ${S*.5} Z`,fill:h,stroke:g,strokeWidth:1}),!o&&p==="circle"&&y.jsx("circle",{r:S*.7,fill:h,stroke:g,strokeWidth:1}),e.subtype==="bomb"&&y.jsx("text",{y:S*.2,textAnchor:"middle",fill:"#fff",fontSize:"10",fontWeight:"bold",children:v}),!o&&!n&&e.subtype!=="bomb"&&y.jsx("text",{x:"0",y:"0",textAnchor:"middle",dy:".3em",fontSize:S*.8,opacity:.8,children:f}),!o&&n&&y.jsx("path",{d:`M0 ${-S*.4} L0 ${S*.4} M${-S*.15} ${-S*.2} L0 ${-S*.5} L${S*.15} ${-S*.2}`,stroke:g,strokeWidth:2,fill:"none"})]})},ug=e=>{if(!e)return"";const n=(e.path||[]).map(s=>`${s.q},${s.r},${s.s}`).join(";");return`${e.actorId}|${e.movementType||""}|${e.destination?.q??""},${e.destination?.r??""},${e.destination?.s??""}|${n}|${e.durationMs??""}|${e.startDelayMs??0}|${e.wasLethal?1:0}`},dg=(e=[])=>e.map(n=>`${n.id}:${n.duration??""}:${n.stacks??""}`).join("|"),dw=(e,n)=>{const s=e.entity,o=n.entity;return e.isSpear===n.isSpear&&e.isDying===n.isDying&&e.waapiControlled===n.waapiControlled&&e.assetHref===n.assetHref&&e.fallbackAssetHref===n.fallbackAssetHref&&e.floorTheme===n.floorTheme&&(e.visualPose?.offsetX??0)===(n.visualPose?.offsetX??0)&&(e.visualPose?.offsetY??0)===(n.visualPose?.offsetY??0)&&(e.visualPose?.scaleX??1)===(n.visualPose?.scaleX??1)&&(e.visualPose?.scaleY??1)===(n.visualPose?.scaleY??1)&&ug(e.movementTrace)===ug(n.movementTrace)&&s.id===o.id&&s.hp===o.hp&&s.maxHp===o.maxHp&&s.facing===o.facing&&s.intent===o.intent&&s.isVisible===o.isVisible&&s.position.q===o.position.q&&s.position.r===o.position.r&&s.position.s===o.position.s&&(s.previousPosition?.q??0)===(o.previousPosition?.q??0)&&(s.previousPosition?.r??0)===(o.previousPosition?.r??0)&&(s.previousPosition?.s??0)===(o.previousPosition?.s??0)&&(s.intentPosition?.q??0)===(o.intentPosition?.q??0)&&(s.intentPosition?.r??0)===(o.intentPosition?.r??0)&&(s.intentPosition?.s??0)===(o.intentPosition?.s??0)&&dg(s.statusEffects)===dg(o.statusEffects)},fw=({stunned:e,showFacing:n,facing:s,borderColor:o})=>y.jsxs(y.Fragment,{children:[e&&y.jsxs("g",{transform:`translate(0, -${X*.8})`,className:"stun-icon",children:[y.jsx("text",{fontSize:"14",textAnchor:"middle",children:"*"}),y.jsx("text",{fontSize:"8",textAnchor:"middle",dy:"-3",dx:"6",children:"+"})]}),n&&s!==void 0&&!e&&y.jsx("line",{x1:0,y1:0,x2:Math.cos((s*60-90)*Math.PI/180)*X*.5,y2:Math.sin((s*60-90)*Math.PI/180)*X*.5,stroke:o,strokeWidth:3,strokeLinecap:"round"})]}),mw=({isPlayer:e,isFlying:n})=>{const s=e?"#22e7ff":"rgba(255,120,120,0.7)",o=e?"rgba(34,231,255,0.20)":"rgba(239,68,68,0.16)",a=e?"rgba(34,231,255,0.36)":"rgba(255,90,90,0.28)",l=e?X*.48:X*.42,u=e?X*.17:X*.145,f=e?X*.32:X*.3;return y.jsxs(y.Fragment,{children:[y.jsxs("g",{transform:`translate(0,${f})`,children:[y.jsx("ellipse",{cx:0,cy:0,rx:l,ry:u,fill:o,stroke:s,strokeWidth:2,opacity:.95,style:{filter:`drop-shadow(0 0 5px ${a})`}}),y.jsx("ellipse",{cx:0,cy:0,rx:l*1.14,ry:u*1.14,fill:"none",stroke:s,strokeWidth:e?1.8:1.6,opacity:e?.62:.54})]}),n&&y.jsx("ellipse",{cx:0,cy:X*.3,rx:X*.4,ry:X*.15,fill:"black",opacity:.2})]})},pw=({entity:e,x:n,y:s,waapiControlled:o,segmentDurationMs:a,segmentEasing:l,isDying:u,poseTransform:f,stretchTransform:p,isFlashing:h,teleportPhase:g,isInvisible:b,visualOpacity:S,isPlayer:T,isFlying:v,unitIconYOffset:A,unitIconScale:_,unitIconSize:E,resolvedAssetHref:w,handleAssetError:M,contrastBoost:C,stunned:I,showFacing:k,borderColor:R})=>y.jsx("g",{style:{pointerEvents:"none"},children:y.jsx("g",{"data-actor-node":e.id,style:{transition:o?"none":`transform ${a}ms ${l}`,transform:`translate(${n}px, ${s}px)`},className:u?"animate-lava-sink":"",children:y.jsx("g",{transform:f,children:y.jsxs("g",{transform:p,className:`${h?"entity-damaged":""} ${!u&&!I?"animate-idle":""} ${g==="out"?"entity-teleport-out":""} ${g==="in"?"entity-teleport-in":""}`,opacity:b?.3:S,style:{filter:b?"blur(1px)":"none"},children:[y.jsx(mw,{isPlayer:T,isFlying:v}),y.jsx("g",{transform:`translate(0,${A}) scale(${_})`,children:uw(e,T,E,w,M,C)}),y.jsx(fw,{stunned:I,showFacing:k,facing:e.facing,borderColor:R}),y.jsx("title",{children:`${e.subtype||e.type} - HP ${e.hp}/${e.maxHp}${e.intent?` - ${e.intent}`:""}`})]})})})}),hw=({x:e,y:n,icon:s})=>y.jsx("g",{style:{pointerEvents:"none"},children:y.jsx("g",{transform:`translate(${e},${n})`,children:y.jsx("text",{x:"0",y:"0",textAnchor:"middle",dy:".3em",fontSize:"20",style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.5))"},children:s})})}),yw=(e,n,s)=>!!(e&&e.actorId===n&&e.destination&&Q(e.destination,s)&&Array.isArray(e.path)&&e.path.length>0),gw=e=>{const{rawPath:n,movementTraceOrigin:s,hasMatchingTrace:o}=e;return!o||!s||n.length<=1?n:Q(n[n.length-1],s)&&!Q(n[0],s)?[...n].reverse():n},bw=({entity:e,movementTrace:n,waapiControlled:s,movementDebugEnabled:o})=>{const[a,l]=N.useState(e.position),[u,f]=N.useState(()=>Ae(e.position,X)),[p,h]=N.useState(e.previousPosition),[g,b]=N.useState(220),[S,T]=N.useState("cubic-bezier(0.22, 1, 0.36, 1)"),[v,A]=N.useState("none"),_=N.useRef(!1),E=N.useRef(e.position),w=N.useRef([]),M=N.useRef(null);return N.useEffect(()=>{const C=()=>{for(const I of w.current)clearTimeout(I);w.current=[],M.current!==null&&(cancelAnimationFrame(M.current),M.current=null)};if(s){C(),_.current=!1;const I=!!(n&&n.actorId===e.id&&n.destination&&Q(n.destination,e.position)),k=!Q(e.position,E.current);E.current=e.position,k&&!I&&(l(e.position),h(e.previousPosition),f(Ae(e.position,X))),A("none"),b(0),T("linear");return}if(!Q(e.position,E.current)){E.current=e.position;const I=yw(n,e.id,e.position),k=I?n:void 0,R=k?.path,$=k?.movementType,j=k?Math.max(0,k.startDelayMs??0):0;if(o){const se=e.previousPosition?Ze(e.previousPosition,e.position).length:0;console.log("[HOP_MOVE]",{actorId:e.id,movementType:$||"fallback",usedEngineTrace:I,tracePathLength:R?.length||0,tracePath:R||[],startDelayMs:j,fallbackPathLength:se,origin:n?.origin||e.previousPosition,destination:e.position})}if($==="teleport"&&k?.origin){C(),_.current=!0;const se=k.durationMs??180,ee=Math.max(80,Math.floor(se/2)),oe=()=>{b(0),T("linear"),h(k.origin),l(k.origin),f(Ae(k.origin,X)),A("out");const F=window.setTimeout(()=>{l(e.position),h(e.position),f(Ae(e.position,X)),A("in")},ee),H=window.setTimeout(()=>{A("none"),_.current=!1},ee*2);w.current.push(F,H)};if(j>0){const F=window.setTimeout(oe,j);w.current.push(F)}else oe();return()=>{C(),_.current=!1}}const D=!!(e.previousPosition&&!Q(e.position,e.previousPosition));if(!!(R&&R.length>1)||D){const se=R||(e.previousPosition?Ze(e.previousPosition,e.position):[]),ee=gw({rawPath:se,movementTraceOrigin:k?.origin,hasMatchingTrace:I});if(ee.length>1){C(),_.current=!0;const oe=Math.max(1,ee.length-1),F=k?.durationMs?k.durationMs/oe:0,H=Math.max(90,Math.min(130,F||112)),z=H*oe,Z=ee.map(G=>Ae(G,X)),re=performance.now(),pe=G=>G<.5?4*G*G*G:1-Math.pow(-2*G+2,3)/2;A("none"),b(0),T("linear"),l(ee[0]),h(ee[0]),f(Z[0]);let B=-1;const W=G=>{const ae=Math.max(0,G-re),le=Math.min(oe-1,Math.floor(ae/H)),ue=le*H,be=ae-ue,$e=Math.max(0,Math.min(1,be/H)),Ee=pe($e);le!==B&&(h(ee[le]),l(ee[Math.min(ee.length-1,le+1)]),B=le);const at=Z[le],ot=Z[Math.min(Z.length-1,le+1)];if(f({x:at.x+(ot.x-at.x)*Ee,y:at.y+(ot.y-at.y)*Ee}),ae<z){M.current=requestAnimationFrame(W);return}_.current=!1,l(e.position),h(e.previousPosition),f(Z[Z.length-1]),M.current=null};if(j>0){const G=window.setTimeout(()=>{M.current=requestAnimationFrame(W)},j);w.current.push(G)}else M.current=requestAnimationFrame(W);return()=>{C(),_.current=!1}}}A("none"),b(220),T("cubic-bezier(0.22, 1, 0.36, 1)"),l(e.position),h(e.previousPosition),f(Ae(e.position,X))}},[e.position,e.previousPosition,n,e.id,s,o]),{displayPos:a,displayPixel:u,animationPrevPos:p,segmentDurationMs:g,segmentEasing:S,teleportPhase:v}},Sw=e=>{const{entity:n,assetHref:s,fallbackAssetHref:o}=e,[a,l]=N.useState(s||o),[u,f]=N.useState(!1),[p,h]=N.useState(!1),g=N.useRef(n.hp);N.useEffect(()=>{l(s||o),f(!1)},[s,o,n.id]);const b=()=>{if(!u&&o&&a!==o){l(o),f(!0);return}l(void 0)};return N.useEffect(()=>{if(n.hp<g.current){h(!0);const S=setTimeout(()=>h(!1),150);return()=>clearTimeout(S)}g.current=n.hp},[n.hp]),{resolvedAssetHref:a,handleAssetError:b,isFlashing:p}},vw=({entity:e,isSpear:n,isDying:s,movementTrace:o,waapiControlled:a=!1,assetHref:l,fallbackAssetHref:u,floorTheme:f,visualPose:p})=>{const h=e.type==="player",g=typeof window<"u"&&!!window.__HOP_DEBUG_MOVEMENT,{displayPos:b,displayPixel:S,animationPrevPos:T,segmentDurationMs:v,segmentEasing:A,teleportPhase:_}=bw({entity:e,movementTrace:o,waapiControlled:a,movementDebugEnabled:g}),{resolvedAssetHref:E,handleAssetError:w,isFlashing:M}=Sw({entity:e,assetHref:l,fallbackAssetHref:u}),{x:C,y:I}=S||Ae(b,X);let k="";const R=T;if(R&&!Q(b,R)){const W=Bn(R,b);if(W!==-1){const G=W*60;k=`rotate(${G}) scale(1.15, 0.85) rotate(${-G})`}}const $=e.isVisible===!1,j=Ji(e);if(n){const W=Uo("spear","enemy");return y.jsx(hw,{x:C,y:I,icon:W.icon})}const D=Uo(e.subtype,e.type,e.enemyType,e.archetype),q=x_(e),se=h?1.34:.92,ee=h?-9:-2,oe=h?24:18,F=cw(f),H=p?.offsetX??0,z=p?.offsetY??0,Z=p?.scaleX??1,re=p?.scaleY??1,B=Math.abs(H)>.01||Math.abs(z)>.01||Math.abs(Z-1)>.01||Math.abs(re-1)>.01?`translate(${H},${z}) scale(${Z},${re})`:void 0;return y.jsx(pw,{entity:e,x:C,y:I,waapiControlled:a,segmentDurationMs:v,segmentEasing:A,isDying:s,poseTransform:B,stretchTransform:k,isFlashing:M,teleportPhase:_,isInvisible:$,visualOpacity:D.opacity||1,isPlayer:h,isFlying:q,unitIconYOffset:ee,unitIconScale:se,unitIconSize:oe,resolvedAssetHref:E,handleAssetError:w,contrastBoost:F,stunned:j,showFacing:!!D.showFacing,borderColor:D.borderColor})},fl=kn.memo(vw,dw),xw=({effect:e,x:n,y:s,fxAssetHref:o,frameAssetHref:a})=>{if(e.type==="melee_lunge"||e.type==="arrow_shot"||e.type==="arcane_bolt"||e.type==="generic_line"){const l=e.payload?.source;if(!l)return null;const u=Ae(l,X),f=n-u.x,p=s-u.y,h=Math.max(1,Math.hypot(f,p)),g=f/h,b=p/h,S=n-g*Math.min(h*.18,14),T=s-b*Math.min(h*.18,14),v=e.type==="arrow_shot"?7:5,A=n-g*v-b*(v*.55),_=s-b*v+g*(v*.55),E=n-g*v+b*(v*.55),w=s-b*v-g*(v*.55);if(e.type==="melee_lunge")return y.jsxs("g",{className:"animate-melee-lunge",children:[y.jsx("line",{x1:u.x,y1:u.y,x2:S,y2:T,stroke:"rgba(255,255,255,0.35)",strokeWidth:5,strokeLinecap:"round"}),y.jsx("line",{x1:S,y1:T,x2:n,y2:s,stroke:"rgba(255,255,255,0.85)",strokeWidth:3,strokeLinecap:"round"})]},e.id);if(e.type==="arrow_shot"||e.type==="generic_line"){const M=e.type==="generic_line"?"rgba(255,255,255,0.85)":"rgba(253,230,138,0.9)",C=e.type==="generic_line"?"rgba(255,255,255,0.9)":"rgba(254,243,199,0.95)";return y.jsxs("g",{className:e.type==="generic_line"?"animate-melee-lunge":"animate-arrow-shot",children:[y.jsx("line",{x1:u.x,y1:u.y,x2:n,y2:s,stroke:M,strokeWidth:e.type==="generic_line"?2:2.5,strokeLinecap:"round",strokeDasharray:e.type==="generic_line"?"6 6":"10 8"}),y.jsx("path",{d:`M ${n} ${s} L ${A} ${_} M ${n} ${s} L ${E} ${w}`,stroke:C,strokeWidth:2,strokeLinecap:"round"})]},e.id)}return y.jsxs("g",{className:"animate-arcane-bolt",children:[y.jsx("line",{x1:u.x,y1:u.y,x2:n,y2:s,stroke:"rgba(34,211,238,0.92)",strokeWidth:4,strokeLinecap:"round",strokeDasharray:"12 10"}),y.jsx("line",{x1:u.x,y1:u.y,x2:n,y2:s,stroke:"rgba(207,250,254,0.85)",strokeWidth:1.8,strokeLinecap:"round"}),y.jsx("circle",{cx:n,cy:s,r:X*.22,fill:"rgba(34,211,238,0.35)"})]},e.id)}if(e.type==="kinetic_wave"||e.type==="generic_ring"){const l=e.type==="kinetic_wave"?"rgba(125,211,252,0.9)":"rgba(255,255,255,0.7)",u=e.type==="kinetic_wave"?"rgba(56,189,248,0.14)":"rgba(255,255,255,0.08)";return y.jsx("g",{className:"animate-explosion-ring",children:y.jsx("circle",{cx:n,cy:s,r:X*(e.type==="kinetic_wave"?1.5:1.1),fill:u,stroke:l,strokeWidth:e.type==="kinetic_wave"?3:2,strokeDasharray:e.type==="kinetic_wave"?"10 6":"6 4"})},e.id)}if(e.type==="wall_crack"){const l=e.payload||{},u=l.source,f=l.target,p=u&&f?Math.atan2(Ae(f,X).y-Ae(u,X).y,Ae(f,X).x-Ae(u,X).x):0,h=X*.32,g=p+Math.PI/2,b=n-Math.cos(p)*h,S=s-Math.sin(p)*h,T=n+Math.cos(p)*h,v=s+Math.sin(p)*h;return y.jsxs("g",{className:"animate-impact",children:[y.jsx("line",{x1:b,y1:S,x2:T,y2:v,stroke:"rgba(255,255,255,0.95)",strokeWidth:2.2,strokeLinecap:"round"}),y.jsx("line",{x1:n-Math.cos(g)*h*.8,y1:s-Math.sin(g)*h*.8,x2:n+Math.cos(g)*h*.8,y2:s+Math.sin(g)*h*.8,stroke:"rgba(147,197,253,0.9)",strokeWidth:1.7,strokeLinecap:"round"}),y.jsx("circle",{cx:n,cy:s,r:3.5,fill:"rgba(255,255,255,0.9)"})]},e.id)}if(e.type==="dash_blur"){const l=e.payload?.path;if(!l||l.length<2)return null;const u=l.map(f=>{const p=Ae(f,X);return`${p.x},${p.y}`}).join(" ");return y.jsx("polyline",{points:u,fill:"none",stroke:"rgba(255,255,255,0.4)",strokeWidth:"8",strokeLinecap:"round",strokeLinejoin:"round",className:"animate-arrow-shot",opacity:.6},e.id)}if(e.type==="hidden_fade")return y.jsxs("g",{className:"animate-flash",children:[y.jsx("circle",{cx:n,cy:s,r:X*.78,fill:"rgba(168,85,247,0.16)",stroke:"rgba(196,181,253,0.75)",strokeWidth:2}),y.jsx("circle",{cx:n,cy:s,r:X*.34,fill:"rgba(30,27,75,0.35)"})]},e.id);if(e.type==="impact")return o?y.jsx("image",{href:o,x:n-X*.75,y:s-X*.75,width:X*1.5,height:X*1.5,preserveAspectRatio:"xMidYMid meet",className:"animate-impact",opacity:"0.9"},e.id):y.jsx("circle",{cx:n,cy:s,r:X*.5,fill:"none",stroke:"#ffffff",strokeWidth:"2",className:"animate-impact"},e.id);if(e.type==="combat_text"){const l=String(e.payload.text||""),u=e.payload.color||(l.startsWith("-")?"#fb7185":"#86efac");return y.jsxs("g",{transform:`translate(${n}, ${s-10})`,children:[a&&y.jsx("image",{href:a,x:-46,y:-24,width:92,height:24,preserveAspectRatio:"xMidYMid meet",opacity:"0.78"}),y.jsx("text",{textAnchor:"middle",fill:u,fontSize:"16",fontWeight:"black",className:"animate-float-up",style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.8))",paintOrder:"stroke",stroke:"#000",strokeWidth:"4px"},children:l})]},e.id)}if(e.type==="flash")return y.jsx("circle",{cx:n,cy:s,r:X*2,fill:"#ffffff",className:"animate-flash"},e.id);if(e.type==="spear_trail"){const u=e.payload.path.map(f=>{const p=Ae(f,X);return`${p.x},${p.y}`}).join(" ");return y.jsx("polyline",{points:u,fill:"none",stroke:"#ffffff",strokeWidth:"4",strokeLinecap:"round",className:"animate-spear-trail"},e.id)}return e.type==="vaporize"?o?y.jsx("image",{href:o,x:n-X*.95,y:s-X*.95,width:X*1.9,height:X*1.9,preserveAspectRatio:"xMidYMid meet",className:"animate-vaporize",opacity:"0.9"},e.id):y.jsxs("g",{children:[y.jsx("circle",{cx:n,cy:s,r:X*.6,fill:"#f97316",className:"animate-vaporize",opacity:"0.8"}),y.jsx("circle",{cx:n,cy:s,r:X*1.2,fill:"none",stroke:"#f97316",strokeWidth:"2",className:"animate-ping"})]},e.id):e.type==="lava_ripple"?o?y.jsx("image",{href:o,x:n-X,y:s-X,width:X*2,height:X*2,preserveAspectRatio:"xMidYMid meet",className:"animate-ping",opacity:"0.85"},e.id):y.jsx("circle",{cx:n,cy:s,r:X*.8,fill:"none",stroke:"#ea580c",strokeWidth:"3",className:"animate-ping"},e.id):e.type==="explosion_ring"?o?y.jsx("image",{href:o,x:n-X*1.35,y:s-X*1.35,width:X*2.7,height:X*2.7,preserveAspectRatio:"xMidYMid meet",className:"animate-explosion-ring",opacity:"0.88"},e.id):y.jsx("circle",{cx:n,cy:s,r:X*2.5,fill:"rgba(255, 120, 0, 0.2)",stroke:"#ffaa00",strokeWidth:"4",className:"animate-explosion-ring"},e.id):null},Aw=({effect:e,x:n,y:s})=>{const o=e.payload||{},a=o.source,l=o.target,u=String(o.phase||"impact");if(!a||!l)return null;const f=Ae(a,X),p=o.contactWorld&&typeof o.contactWorld.x=="number"&&typeof o.contactWorld.y=="number"?o.contactWorld:{x:n,y:s},h=p.x-f.x,g=p.y-f.y,b=Math.max(1,Math.hypot(h,g)),S=h/b,T=g/b,v=String(o.intensity||"medium"),A=Math.max(120,Math.min(360,Number(e.ttlMs||180))),_=`${Math.round(A*.85)}ms`,E=v==="extreme"?X*.34:v==="high"?X*.28:X*.22;if(u!=="impact")return null;const w=v==="extreme"?"rgba(253,224,71,0.98)":v==="high"?"rgba(255,255,255,0.96)":"rgba(226,232,240,0.95)",M=v==="extreme"?"rgba(251,191,36,0.9)":"rgba(255,255,255,0.92)";return y.jsx("g",{children:y.jsxs("g",{className:"juice-basic-strike-spark",style:{animationDuration:_},children:[y.jsx("circle",{cx:p.x,cy:p.y,r:E*1.65,fill:"rgba(255,255,255,0.16)",stroke:"rgba(255,255,255,0.55)",strokeWidth:1.4}),y.jsx("circle",{cx:p.x,cy:p.y,r:E*.62,fill:M}),y.jsx("circle",{cx:p.x,cy:p.y,r:E*1.2,fill:"none",stroke:w,strokeWidth:2.4}),y.jsx("path",{d:`M ${p.x-S*E*1.6} ${p.y-T*E*1.6} L ${p.x+S*E*1.6} ${p.y+T*E*1.6}`,stroke:w,strokeWidth:2.1,strokeLinecap:"round"}),y.jsx("path",{d:`M ${p.x-T*E*1.35} ${p.y+S*E*1.35} L ${p.x+T*E*1.35} ${p.y-S*E*1.35}`,stroke:"rgba(255,255,255,0.9)",strokeWidth:1.8,strokeLinecap:"round"})]})},e.id)},Tw=({effect:e,x:n,y:s})=>{const o=e.payload||{},a=o.source,l=o.target,u=String(o.phase||"travel");if(!a||!l)return null;const f=Ae(a,X),p=Ae(l,X),h=o.contactWorld&&typeof o.contactWorld.x=="number"&&typeof o.contactWorld.y=="number"?o.contactWorld:{x:n,y:s},g=u==="impact"?h:p,b=g.x-f.x,S=g.y-f.y,T=Math.max(1,Math.hypot(b,S)),v=b/T,A=S/T,_=String(o.intensity||"medium");if(u==="anticipation")return y.jsxs("g",{className:"animate-arrow-shot",opacity:.95,children:[y.jsx("line",{x1:f.x,y1:f.y,x2:p.x,y2:p.y,stroke:"rgba(248,113,113,0.75)",strokeWidth:1.5,strokeDasharray:"4 5",strokeLinecap:"round"}),y.jsx("circle",{cx:p.x,cy:p.y,r:X*.18,fill:"none",stroke:"rgba(254,202,202,0.9)",strokeWidth:1.5})]},e.id);if(u==="travel"){const w=Math.min(T*.22,X*.75),M=g.x-v*w,C=g.y-A*w,I=7.5,k=g.x-v*I-A*(I*.52),R=g.y-A*I+v*(I*.52),$=g.x-v*I+A*(I*.52),j=g.y-A*I-v*(I*.52);return y.jsxs("g",{className:"animate-arrow-shot",children:[y.jsx("line",{x1:f.x,y1:f.y,x2:g.x,y2:g.y,stroke:"rgba(180,83,9,0.38)",strokeWidth:3.2,strokeLinecap:"round",strokeDasharray:"8 9"}),y.jsx("line",{x1:M,y1:C,x2:g.x,y2:g.y,stroke:"rgba(254,240,138,0.98)",strokeWidth:2.2,strokeLinecap:"round"}),y.jsx("path",{d:`M ${g.x} ${g.y} L ${k} ${R} M ${g.x} ${g.y} L ${$} ${j}`,stroke:"rgba(255,251,235,0.98)",strokeWidth:1.9,strokeLinecap:"round"}),y.jsx("circle",{cx:f.x,cy:f.y,r:X*.08,fill:"rgba(251,191,36,0.55)"})]},e.id)}const E=_==="extreme"||_==="high"?X*.24:X*.19;return y.jsxs("g",{className:"animate-impact",children:[y.jsx("circle",{cx:h.x,cy:h.y,r:E*1.35,fill:"rgba(251,191,36,0.14)",stroke:"rgba(254,243,199,0.72)",strokeWidth:1.4}),y.jsx("line",{x1:h.x-v*E*1.6,y1:h.y-A*E*1.6,x2:h.x+v*E*1.25,y2:h.y+A*E*1.25,stroke:"rgba(255,251,235,0.95)",strokeWidth:2,strokeLinecap:"round"}),y.jsx("path",{d:`M ${h.x+v*E*1.2} ${h.y+A*E*1.2} L ${h.x+v*E*1.75-A*E*.45} ${h.y+A*E*1.75+v*E*.45} M ${h.x+v*E*1.2} ${h.y+A*E*1.2} L ${h.x+v*E*1.75+A*E*.45} ${h.y+A*E*1.75-v*E*.45}`,stroke:"rgba(254,240,138,0.9)",strokeWidth:1.5,strokeLinecap:"round"})]},e.id)},Ew=e=>e.effect.type==="basic_attack_strike"?Aw(e):e.effect.type==="archer_shot_signature"?Tw(e):null,_w=new Set(["impact","flash","combat_text","spear_trail","vaporize","lava_ripple","explosion_ring"]),ww=({effect:e,assetById:n,frameAssetHref:s,nowMs:o})=>{if(o<e.startTime||!e.position&&!e.worldPosition)return null;const a=e.position?Ae(e.position,X):{x:0,y:0},l=e.worldPosition?.x??a.x,u=e.worldPosition?.y??a.y,f=_w.has(e.type)?J_(e.type):void 0,p=f?n.get(f)?.path:void 0;return e.type==="basic_attack_strike"||e.type==="archer_shot_signature"?Ew({effect:e,x:l,y:u}):xw({effect:e,x:l,y:u,fxAssetHref:p,frameAssetHref:s})},Mw=({effects:e,assetById:n})=>{const s=n.get(Q_())?.path,o=Date.now();return y.jsx("g",{style:{pointerEvents:"none"},children:e.map(a=>ww({effect:a,assetById:n,frameAssetHref:s,nowMs:o}))})},Cw={"ATK.STRIKE.PHYSICAL.BASIC_ATTACK|anticipation":{rendererId:"basic_attack_strike",ttlMs:130},"ATK.STRIKE.PHYSICAL.BASIC_ATTACK|travel":{rendererId:"basic_attack_strike",ttlMs:110},"ATK.STRIKE.PHYSICAL.BASIC_ATTACK|impact":{rendererId:"basic_attack_strike",ttlMs:180},"ATK.STRIKE.PHYSICAL.BASIC_ATTACK|aftermath":{rendererId:"basic_attack_strike",ttlMs:190},"ATK.STRIKE.PHYSICAL.AUTO_ATTACK|anticipation":{rendererId:"basic_attack_strike",ttlMs:100},"ATK.STRIKE.PHYSICAL.AUTO_ATTACK|travel":{rendererId:"basic_attack_strike",ttlMs:90},"ATK.STRIKE.PHYSICAL.AUTO_ATTACK|impact":{rendererId:"basic_attack_strike",ttlMs:140},"ATK.STRIKE.PHYSICAL.AUTO_ATTACK|aftermath":{rendererId:"basic_attack_strike",ttlMs:120},"ATK.SHOOT.PHYSICAL.ARROW|anticipation":{rendererId:"archer_shot_signature",ttlMs:110},"ATK.SHOOT.PHYSICAL.ARROW|travel":{rendererId:"archer_shot_signature",ttlMs:160,skipIfLegacyMirrored:!0},"ATK.SHOOT.PHYSICAL.ARROW|impact":{rendererId:"archer_shot_signature",ttlMs:150}},Ow={"ATK.STRIKE.PHYSICAL.IMPACT":{rendererId:"impact",ttlMs:420,skipIfLegacyMirrored:!0},"ATK.STRIKE.PHYSICAL.HEAVY":{rendererId:"melee_lunge",ttlMs:280},"ATK.STRIKE.PHYSICAL.LIGHT":{rendererId:"impact",ttlMs:380},"ATK.SHOOT.PHYSICAL.SPEAR_TRAIL":{rendererId:"spear_trail",ttlMs:520,skipIfLegacyMirrored:!0},"ATK.SHOOT.PHYSICAL.SPEAR_RETURN":{rendererId:"spear_trail",ttlMs:520},"ATK.BLAST.FIRE.EXPLOSION_RING":{rendererId:"explosion_ring",ttlMs:980},"ATK.BLAST.FIRE.TIME_BOMB":{rendererId:"explosion_ring",ttlMs:980},"ATK.BLAST.FIRE.FIREBALL_IMPACT":{rendererId:"explosion_ring",ttlMs:740},"ATK.BLAST.VOID.CORPSE_EXPLOSION":{rendererId:"generic_ring",ttlMs:840},"ENV.HAZARD.FIRE.LAVA_RIPPLE":{rendererId:"lava_ripple",ttlMs:820},"ENV.COLLISION.KINETIC.WALL_CRACK":{rendererId:"wall_crack",ttlMs:700},"ENV.COLLISION.KINETIC.IMPACT":{rendererId:"wall_crack",ttlMs:520},"ATK.PULSE.KINETIC.WAVE":{rendererId:"kinetic_wave",ttlMs:540},"MOVE.DASH.NEUTRAL.BLUR":{rendererId:"dash_blur",ttlMs:320},"MOVE.DASH.NEUTRAL.SWIFT_ROLL":{rendererId:"dash_blur",ttlMs:320},"MOVE.DASH.KINETIC.MOMENTUM_TRAIL":{rendererId:"dash_blur",ttlMs:360},"STATE.FADE.SHADOW.HIDDEN":{rendererId:"hidden_fade",ttlMs:360},"STATE.FADE.SHADOW.SMOKE_SCREEN":{rendererId:"hidden_fade",ttlMs:420},"MOVE.BLINK.SHADOW.SHADOW_STEP":{rendererId:"hidden_fade",ttlMs:380},"MOVE.BLINK.ARCANE.SOUL_SWAP_ARRIVE":{rendererId:"flash",ttlMs:280},"MOVE.BLINK.ARCANE.SOUL_SWAP_DEPART":{rendererId:"flash",ttlMs:280},"STATE.APPLY.NEUTRAL.STUN_BURST":{rendererId:"generic_ring",ttlMs:560},"UI.TEXT.NEUTRAL.POPUP":{rendererId:"combat_text",ttlMs:1100},"UI.SHAKE.NEUTRAL.CAMERA":{rendererId:"none",ttlMs:1,skipIfLegacyMirrored:!0},"UI.FREEZE.NEUTRAL.HITSTOP":{rendererId:"none",ttlMs:1}},Nw={"attack|shoot|physical|travel":{rendererId:"arrow_shot",ttlMs:320},"attack|shoot|arcane|travel":{rendererId:"arcane_bolt",ttlMs:340},"attack|shoot|fire|travel":{rendererId:"arcane_bolt",ttlMs:340},"attack|strike|physical|impact":{rendererId:"melee_lunge",ttlMs:260},"attack|blast|fire|impact":{rendererId:"explosion_ring",ttlMs:900},"attack|pulse|kinetic|impact":{rendererId:"kinetic_wave",ttlMs:520},"environment|collision|kinetic|impact":{rendererId:"wall_crack",ttlMs:700},"status|state_fade|shadow|instant":{rendererId:"hidden_fade",ttlMs:360},"ui|text|neutral|instant":{rendererId:"combat_text",ttlMs:1e3}},kw={"attack|blast|impact":{rendererId:"generic_ring",ttlMs:680},"attack|shoot|travel":{rendererId:"generic_line",ttlMs:300},"attack|strike|impact":{rendererId:"impact",ttlMs:400},"environment|hazard_burst|impact":{rendererId:"generic_ring",ttlMs:760},"status|status_apply|impact":{rendererId:"flash",ttlMs:320},"ui|text|instant":{rendererId:"combat_text",ttlMs:1e3}},Rw={"movement|dash":{rendererId:"dash_blur",ttlMs:300},"movement|blink":{rendererId:"flash",ttlMs:260},"attack|pulse":{rendererId:"kinetic_wave",ttlMs:500},"attack|blast":{rendererId:"generic_ring",ttlMs:700},"attack|shoot":{rendererId:"generic_line",ttlMs:280},"attack|strike":{rendererId:"impact",ttlMs:380},"environment|collision":{rendererId:"wall_crack",ttlMs:650},"ui|text":{rendererId:"combat_text",ttlMs:1e3}},Iw=new Set(["impact","flash","spearTrail","shake"]),Lw=e=>{const n=`${e.signature}|${e.phase}`,s=Cw[n];if(s)return{key:`sigp:${n}`,recipe:s};const o=Ow[e.signature];if(o)return{key:`sig:${e.signature}`,recipe:o};const a=`${e.family}|${e.primitive}|${e.element||"neutral"}|${e.phase}`,l=Nw[a];if(l)return{key:`fpel:${a}`,recipe:l};const u=`${e.family}|${e.primitive}|${e.phase}`,f=kw[u];if(f)return{key:`fpp:${u}`,recipe:f};const p=`${e.family}|${e.primitive}`,h=Rw[p];return h?{key:`fp:${p}`,recipe:h}:{key:"fallback:none",recipe:{rendererId:"none",ttlMs:1}}},Bw=({payload:e,reducedMotion:n})=>{const{key:s,recipe:o}=Lw(e);if(o.skipIfLegacyMirrored&&e.meta?.legacyMirrored&&e.meta?.legacyJuiceId&&Iw.has(String(e.meta.legacyJuiceId)))return null;let a=Math.max(1,Number(e.timing?.ttlMs??e.timing?.durationMs??o.ttlMs));return n&&(a=Math.max(1,Math.floor(a*.7))),{key:s,ttlMs:a,recipe:o,payload:e}},Od=e=>{const n=e?.hex;if(n&&typeof n.q=="number"&&typeof n.r=="number"&&typeof n.s=="number")return n},Nd=e=>{const n=e?.world;if(n&&typeof n.x=="number"&&typeof n.y=="number")return n},Hw=({incoming:e,now:n,reducedMotion:s,recentSignatureImpactByTile:o})=>{const a=[];return e.forEach((l,u)=>{if(l.type!=="juice_signature")return;const f=l.payload;if(!f||f.protocol!=="juice-signature/v1")return;const p=Bw({payload:f,reducedMotion:s});if(!p||p.recipe.rendererId==="none")return;const h=Od(f.contact),g=Od(f.target),b=Od(f.source),S=Nd(f.contact),T=Nd(f.target),v=Nd(f.source),A=h||g||b,_=S||T||v,E={id:`sig-${n}-${u}`,startTime:n+Math.max(0,Number(f.timing?.delayMs||0)),ttlMs:p.ttlMs};if((f.signature==="ATK.STRIKE.PHYSICAL.BASIC_ATTACK"||f.signature==="ATK.STRIKE.PHYSICAL.AUTO_ATTACK")&&f.phase==="impact"&&g){const M=ce(g);o.set(M,{at:n,signature:f.signature})}const w=f.text?.value;switch(p.recipe.rendererId){case"basic_attack_strike":{if(!b||!g)return;a.push({...E,type:"basic_attack_strike",position:g,worldPosition:S||_,payload:{phase:f.phase,intensity:f.intensity||"medium",signature:f.signature,source:b,target:g,sourceActorId:f.source?.actorId,targetActorId:f.target?.actorId,contactWorld:S,contactHex:h,direction:f.direction,flags:f.flags||{}}});return}case"archer_shot_signature":{const M=g||h;if(!b||!M)return;a.push({...E,type:"archer_shot_signature",position:M,worldPosition:S||_,payload:{phase:f.phase,intensity:f.intensity||"medium",source:b,target:M,contactWorld:S,path:f.path||(f.area?.kind==="path"?f.area.points:void 0),signature:f.signature}});return}case"impact":case"flash":case"lava_ripple":case"explosion_ring":case"kinetic_wave":case"wall_crack":case"hidden_fade":case"generic_ring":{if(!A&&!_)return;a.push({...E,type:p.recipe.rendererId,position:A,worldPosition:_,payload:{signature:f.signature,color:f.text?.color,element:f.element,variant:f.variant,source:b,target:g}});return}case"combat_text":{if(!w||!A&&!_)return;a.push({...E,type:"combat_text",position:A,worldPosition:_,payload:{text:w,color:f.text?.color}});return}case"spear_trail":{if((!f.path||f.path.length===0)&&f.area?.kind!=="path")return;const M=f.path||(f.area?.kind==="path"?f.area.points:[]);if(!M||M.length===0)return;a.push({...E,type:"spear_trail",position:M[0],payload:{path:M}});return}case"melee_lunge":case"arrow_shot":case"arcane_bolt":case"generic_line":{const M=g||h;if(!M||!b)return;a.push({...E,type:p.recipe.rendererId,position:M,payload:{source:b,signature:f.signature,element:f.element}});return}case"dash_blur":{const M=f.path||(f.area?.kind==="path"?f.area.points:void 0);if(!M||M.length<2)return;a.push({...E,type:"dash_blur",position:M[M.length-1],payload:{path:M,source:M[0]}});return}default:return}}),a},Pw=({incoming:e,now:n})=>{const s=[];return e.forEach((o,a)=>{const l=`juice-${n}-${a}`;o.type==="vfx"&&o.payload?.type==="impact"?o.payload.position&&s.push({id:l,type:"impact",position:o.payload.position,startTime:n}):o.type==="vfx"&&o.payload?.type==="flash"?o.payload.position&&s.push({id:l,type:"flash",position:o.payload.position,startTime:n}):o.type==="vfx"&&o.payload?.type==="spear_trail"?o.payload.path&&o.payload.path.length>0&&s.push({id:l,type:"spear_trail",position:o.payload.path[0],payload:o.payload,startTime:n}):o.type==="vfx"&&o.payload?.type==="vaporize"?o.payload.position&&s.push({id:l,type:"vaporize",position:o.payload.position,startTime:n}):o.type==="vfx"&&o.payload?.type==="lava_ripple"?o.payload.position&&s.push({id:l,type:"lava_ripple",position:o.payload.position,startTime:n}):o.type==="vfx"&&o.payload?.type==="explosion_ring"&&o.payload.position&&s.push({id:l,type:"explosion_ring",position:o.payload.position,startTime:n})}),s},jw=({incoming:e,now:n,startIndex:s,actorById:o,recentSignatureImpactByTile:a,classifyDamageCueType:l})=>{const u=[];return e.forEach((f,p)=>{if(f.type!=="DamageTaken"||!f.position)return;const h=f.position,g=String(f.payload?.sourceId||""),b=g?o.get(g):void 0,S=String(f.payload?.reason||""),T=a.get(ce(h)),v=T?.signature==="ATK.STRIKE.PHYSICAL.BASIC_ATTACK"||T?.signature==="ATK.STRIKE.PHYSICAL.AUTO_ATTACK",A=!!(T&&v&&n-T.at<=260),_=S.includes("basic_attack")||S.includes("auto_attack");if(b?.position){const E=Ae(b.position,X),w=Ae(h,X),M=Math.hypot(w.x-E.x,w.y-E.y),C=A&&_?null:l(b.subtype,S,M);C&&u.push({id:`sim-cue-${n}-${s+p}`,type:C,position:h,payload:{source:b.position,sourceSubtype:b.subtype,reason:S},startTime:n})}A&&_||u.push({id:`sim-impact-${n}-${s+p}`,type:"impact",position:h,startTime:n})}),u},Dw=e=>new Promise(n=>setTimeout(n,e)),Uw=e=>{if(!e)return null;const n=e.position||e.destination||e.origin||e.target;return n&&typeof n.q=="number"&&typeof n.r=="number"&&typeof n.s=="number"?n:null},P0=e=>{if(e.ttlMs&&e.ttlMs>0)return e.ttlMs;const n=e.type;return n==="basic_attack_strike"?180:n==="archer_shot_signature"?170:n==="impact"?400:n==="combat_text"?1e3:n==="flash"?300:n==="melee_lunge"?240:n==="arrow_shot"?260:n==="arcane_bolt"?320:n==="kinetic_wave"?520:n==="wall_crack"?700:n==="dash_blur"?320:n==="hidden_fade"?360:n==="generic_ring"?700:n==="generic_line"?280:n==="spear_trail"?500:n==="vaporize"?600:n==="lava_ripple"?800:n==="explosion_ring"?1e3:2e3},fg=.72,$w=(e,n,s)=>{const o=String(e||"").toLowerCase(),a=String(n||"").toLowerCase();return a.includes("lava")||a.includes("fire")||a.includes("hazard")||a.includes("burn")||a.includes("crush")||a.includes("collision")||o==="bomber"||a.includes("bomb")||a.includes("explosion")?null:o==="warlock"||a.includes("arcane")||a.includes("force")||a.includes("spell")?"arcane_bolt":o==="archer"||a.includes("arrow")||a.includes("spear_throw")?"arrow_shot":s<=X*2.05||a.includes("basic_attack")||a.includes("melee")?"melee_lunge":null},j0=650,qw=3500,zw=(e,n)=>{const s=Uw(e.payload);if(!s)return[];const o=[],a=`${e.id}:${n}`;return e.phase==="HAZARD_CHECK"?o.push({id:`${a}:haz`,type:"combat_text",position:s,payload:{text:"!"},startTime:n}):e.phase==="DEATH_RESOLVE"&&o.push({id:`${a}:vapor`,type:"vaporize",position:s,startTime:n}),o},Vw=(e,n,s)=>{let o=e.blocking?Math.round((e.suggestedDurationMs??140)*fg):0;if(e.phase!=="MOVE_END")return o;const a=e.payload?.targetActorId;if(!a)return o;const l=n.get(a),u=l?s-l.seenAt<=2500:!1;return!l||!u||l.durationMs<=0?o:Math.max(o,Math.min(j0,Math.round(l.durationMs*fg)))},Yw=(e,n)=>e.phase==="MOVE_END"?Math.min(460,Math.max(70,n)):e.phase==="DEATH_RESOLVE"?Math.min(120,Math.max(55,n)):e.phase==="DAMAGE_APPLY"?Math.min(80,Math.max(35,n)):e.phase==="HAZARD_CHECK"?Math.min(70,Math.max(30,n)):e.blocking?Math.min(70,Math.max(0,n)):0,Kw=(e,n,s,o)=>{const a=e.phase==="MOVE_END"?n:o?Math.min(70,Math.floor(s*.5)):s;return Math.max(0,Math.min(j0,a))},Fw=(e,n)=>{let s=1/0;for(const o of e){if(o.startTime>n){const u=o.startTime-n;u>0&&u<s&&(s=u);continue}const a=n-o.startTime,l=P0(o)-a;l>0&&l<s&&(s=l)}return s},Ww=({visualEvents:e,timelineEvents:n,simulationEvents:s,actorSnapshots:o,onBusyStateChange:a})=>{const[l,u]=N.useState([]),f=N.useRef(null),p=N.useRef(null),h=N.useRef(null),g=N.useRef(0),b=N.useRef([]),S=N.useRef(!1),[T,v]=N.useState(!1),A=N.useRef(!1),_=N.useRef(new Map),E=N.useRef(null),w=N.useRef(Date.now()),M=N.useRef(new Map),C=N.useMemo(()=>{const k=new Map;for(const R of o)k.set(R.id,R);return k},[o]);N.useEffect(()=>{if(typeof window>"u"||!window.matchMedia)return;const k=window.matchMedia("(prefers-reduced-motion: reduce)"),R=()=>{A.current=k.matches};return R(),k.addEventListener?.("change",R),()=>k.removeEventListener?.("change",R)},[]),N.useEffect(()=>{if(!e.length)return;const k=new Map(_.current),R=Date.now();for(const $ of e){if($.type!=="kinetic_trace")continue;const j=$.payload;if(!j?.actorId)continue;const D=Number(j.durationMs??0);D>0&&k.set(String(j.actorId),{durationMs:D,seenAt:R})}_.current=k},[e]),N.useEffect(()=>{a?.(T)},[T,a]);const I=k=>{const R=Date.now(),$=zw(k,R);$.length>0&&u(j=>[...j,...$])};return N.useEffect(()=>{if(!n.length||f.current===n)return;f.current=n;const k=n;k.length&&(b.current.push(...k),!S.current&&(S.current=!0,v(!0),(async()=>{try{const R=Date.now();for(;b.current.length>0;){if(Date.now()-R>qw){console.warn("[HOP_JUICE] Timeline queue exceeded runtime budget; flushing remaining events.",{queued:b.current.length});break}const $=b.current.shift();I($);const j=Date.now(),D=Vw($,_.current,j),q=Yw($,D),se=Kw($,D,q,A.current);se>0&&await Dw(se)}}catch(R){console.error("[HOP_JUICE] Timeline queue processing failed; releasing busy lock.",R)}finally{b.current=[],S.current=!1,v(!1)}})()))},[n]),N.useEffect(()=>{if(h.current===e)return;h.current=e;const k=e;if(!k.length)return;const R=Date.now(),$=Hw({incoming:k,now:R,reducedMotion:A.current,recentSignatureImpactByTile:M.current});$.length>0&&u(j=>[...j,...$])},[e]),N.useEffect(()=>{if(n.length>0){p.current=e;return}if(p.current===e)return;p.current=e;const k=e;if(!k.length)return;const R=Date.now(),$=Pw({incoming:k,now:R});$.length>0&&u(j=>[...j,...$])},[e,n.length]),N.useEffect(()=>{s.length<g.current&&(g.current=0);const k=g.current;if(k>=s.length)return;const R=s.slice(k);g.current=s.length;const $=Date.now(),j=jw({incoming:R,now:$,startIndex:k,actorById:C,recentSignatureImpactByTile:M.current,classifyDamageCueType:$w});j.length>0&&u(D=>[...D,...j])},[s,C]),N.useEffect(()=>{if(E.current!==null&&(window.clearTimeout(E.current),E.current=null),l.length===0)return;const k=Date.now(),R=Fw(l,k);if(!Number.isFinite(R)){u([]);return}const $=Math.max(16,Math.min(180,Math.floor(R)));return E.current=window.setTimeout(()=>{const j=Date.now();u(D=>{const q=w.current;w.current=j;const se=D.filter(oe=>j<oe.startTime+P0(oe));return se.length!==D.length?se:D.some(oe=>q<oe.startTime&&oe.startTime<=j)?[...D]:D})},$),()=>{E.current!==null&&(window.clearTimeout(E.current),E.current=null)}},[l]),l},Gw=({visualEvents:e,timelineEvents:n=[],simulationEvents:s=[],actorSnapshots:o=[],onBusyStateChange:a,assetManifest:l})=>{const u=N.useMemo(()=>{const p=new Map;for(const h of l?.assets||[])p.set(h.id,h);return p},[l]),f=Ww({visualEvents:e,timelineEvents:n,simulationEvents:s,actorSnapshots:o,onBusyStateChange:a});return y.jsx(Mw,{effects:f,assetById:u})},Xw=({gameState:e,latestTraceByActor:n,entityVisualPoseById:s,assetById:o,biomeThemeKey:a,juiceActorSnapshots:l,assetManifest:u,onJuiceBusyStateChange:f})=>y.jsxs("g",{children:[e.lastSpearPath&&e.lastSpearPath.length>=2&&(()=>{const h=e.lastSpearPath.map(g=>Ae(g,X)).map((g,b)=>`${b===0?"M":"L"} ${g.x} ${g.y}`).join(" ");return y.jsx("path",{d:h,stroke:"rgba(255, 255, 255, 0.15)",strokeWidth:"2",fill:"none",strokeDasharray:"4 2",strokeLinecap:"round"})})(),e.spearPosition&&y.jsx(fl,{entity:{id:"spear",type:"player",subtype:"footman",position:e.spearPosition,hp:1,maxHp:1,statusEffects:[],temporaryArmor:0,activeSkills:[],speed:0,factionId:"player"},isSpear:!0}),y.jsx(fl,{entity:e.player,movementTrace:n[e.player.id],waapiControlled:!0,visualPose:s.get(e.player.id),assetHref:o.get(Fi(e.player))?.path,fallbackAssetHref:As(e.player),floorTheme:a},`player-${e.floor}`),e.enemies.map(p=>y.jsx(fl,{entity:p,movementTrace:n[p.id],waapiControlled:!0,visualPose:s.get(p.id),assetHref:o.get(Fi(p))?.path,fallbackAssetHref:As(p),floorTheme:a},`${p.id}-${e.floor}`)),e.dyingEntities?.map(p=>y.jsx(fl,{entity:p,isDying:!0,movementTrace:n[p.id],waapiControlled:!0,visualPose:s.get(p.id),assetHref:o.get(Fi(p))?.path,fallbackAssetHref:As(p),floorTheme:a},`dying-${p.id}-${e.floor}-${e.turnNumber}`)),y.jsx(Gw,{visualEvents:e.visualEvents||[],timelineEvents:e.timelineEvents||[],simulationEvents:e.simulationEvents||[],actorSnapshots:l,onBusyStateChange:f,assetManifest:u},`juice-${e.floor}`)]}),Jw=({cells:e,gridPoints:n})=>y.jsx("g",{"data-layer":"interaction-ui-grid",pointerEvents:"none",shapeRendering:"crispEdges",children:e.map(s=>{const{x:o,y:a}=Ae(s,X);return y.jsx("g",{transform:`translate(${o},${a})`,children:y.jsx("polygon",{points:n,fill:"none",stroke:"rgba(201,224,255,0.12)",strokeWidth:.9})},`grid-${ce(s)}`)})}),Qw=({boardProps:e})=>y.jsx("g",{"data-layer":"ui-objective-markers",pointerEvents:"none",children:e.map(n=>{const{x:s,y:o}=Ae(n.position,X),a=n.kind==="shrine",l=a?"#c2410c":"#15803d",u=a?"S":"E",f=s+X*.52,p=o-X*.52;return y.jsxs("g",{transform:`translate(${f},${p})`,children:[y.jsx("circle",{r:14,fill:"none",stroke:"rgba(255,255,255,0.55)",strokeWidth:2,style:{animation:`shrineGlow ${a?1.6:1.9}s ease-in-out infinite`}}),y.jsx("circle",{r:10.5,fill:l,stroke:"#ffffff",strokeWidth:2}),y.jsx("text",{x:0,y:0,textAnchor:"middle",dy:".34em",fill:"#ffffff",fontSize:10,fontWeight:900,style:{textShadow:"0 1px 2px rgba(0,0,0,0.7)"},children:u})]},`marker-${n.id}`)})}),Zw=({svgRef:e,renderedViewBox:n,cells:s,gameState:o,selectedSkillId:a,showMovementRange:l,hoveredTile:u,resolvedEnginePreviewGhost:f,tileVisualFlags:p,movementTargetSet:h,hasPrimaryMovementSkills:g,fallbackNeighborSet:b,selectedSkillTargetSet:S,stairsKey:T,shrineKey:v,mountainCoveredWallKeys:A,hybridInteractionLayerEnabled:_,assetById:E,decals:w,depthSortedSprites:M,boardProps:C,manifestUnitToBoardScale:I,mountainSettingsByAssetId:k,resolveMountainSettings:R,latestTraceByActor:$,entityVisualPoseById:j,biomeThemeKey:D,juiceActorSnapshots:q,assetManifest:se,backdropLayerProps:ee,gridPoints:oe,onTileClick:F,onTileHover:H,onMouseLeave:z,onWheel:Z,onPointerDown:re,onPointerMove:pe,onPointerUp:B,onPointerCancel:W,onJuiceBusyStateChange:G})=>y.jsxs("svg",{ref:e,width:"100%",height:"100%",viewBox:`${n.x} ${n.y} ${n.width} ${n.height}`,preserveAspectRatio:"xMidYMid meet",shapeRendering:"geometricPrecision",className:"max-h-full max-w-full",onMouseLeave:z,onWheel:Z,onPointerDown:re,onPointerMove:pe,onPointerUp:B,onPointerCancel:W,style:{touchAction:"none"},children:[y.jsx(H_,{cells:s,...ee}),y.jsx(ew,{gameState:o,selectedSkillId:a,showMovementRange:l,hoveredTile:u,enginePreviewGhost:f,cells:s,tileVisualFlags:p,movementTargetSet:h,hasPrimaryMovementSkills:g,fallbackNeighborSet:b,selectedSkillTargetSet:S,stairsKey:T,shrineKey:v,mountainCoveredWallKeys:A,hybridInteractionLayerEnabled:_,assetById:E,onTileClick:F,onTileHover:H,decals:w}),y.jsx(ow,{sprites:M,floor:o.floor,manifestUnitToBoardScale:I,mountainSettingsByAssetId:k,resolveMountainSettings:R}),y.jsx(Xw,{gameState:o,latestTraceByActor:$,entityVisualPoseById:j,assetById:E,biomeThemeKey:D,juiceActorSnapshots:q,assetManifest:se,onJuiceBusyStateChange:G}),y.jsx(Jw,{cells:s,gridPoints:oe}),y.jsx(Qw,{boardProps:C})]}),eM=({svgRef:e,onMove:n,zoomPreset:s,setHoveredTile:o,setIsCameraPanning:a,cameraPanOffsetRef:l,isCameraPanningRef:u,isPinchingRef:f,suppressTileClickUntilRef:p,activePointersRef:h,dragStateRef:g,pinchStateRef:b,animateCameraToTarget:S,updatePanFromWorldDelta:T,setZoomPresetAnimated:v})=>{const A=N.useCallback((D,q)=>{const se=e.current;if(!se||!se.getScreenCTM)return null;const ee=se.getScreenCTM();if(!ee)return null;const oe=se.createSVGPoint();oe.x=D,oe.y=q;const F=oe.matrixTransform(ee.inverse());return{x:F.x,y:F.y}},[e]),_=N.useCallback(()=>{l.current={x:0,y:0},S({panOffset:{x:0,y:0},durationMs:220})},[S,l]),E=N.useCallback(D=>{Date.now()<p.current||n(D)},[n,p]),w=N.useCallback(D=>{u.current||f.current||o(D)},[u,f,o]),M=N.useCallback(()=>Array.from(h.current.entries()),[h]),C=N.useCallback(D=>{if(D.pointerType==="mouse"&&D.button!==0)return;if(h.current.set(D.pointerId,{x:D.clientX,y:D.clientY}),D.pointerType!=="mouse")try{D.currentTarget.setPointerCapture(D.pointerId)}catch{}const q=M();if(q.length>=2){f.current=!0,u.current=!1,a(!1),g.current.didPan=!0,p.current=Date.now()+250;const[se,ee]=q,oe=se[1].x-ee[1].x,F=se[1].y-ee[1].y;b.current={startDistance:Math.hypot(oe,F),startPreset:s,appliedPreset:s};return}g.current={activePointerId:D.pointerId,startClient:{x:D.clientX,y:D.clientY},lastWorld:A(D.clientX,D.clientY),didPan:!1}},[h,A,g,M,u,f,b,a,p,s]),I=N.useCallback(D=>{if(!h.current.has(D.pointerId))return;h.current.set(D.pointerId,{x:D.clientX,y:D.clientY});const q=M();if(f.current||q.length>=2){if(q.length>=2){f.current=!0;const[re,pe]=q,B=re[1].x-pe[1].x,W=re[1].y-pe[1].y,G=Math.max(1,Math.hypot(B,W));if(!b.current)b.current={startDistance:G,startPreset:s,appliedPreset:s};else{const ae=G/Math.max(1,b.current.startDistance);let le=b.current.startPreset;ae>1.08&&(le=7),ae<.92&&(le=11),le!==b.current.appliedPreset&&(b.current.appliedPreset=le,v(le))}p.current=Date.now()+250,D.preventDefault()}return}const se=g.current;if(!se.startClient||se.activePointerId!==D.pointerId)return;const ee=D.clientX-se.startClient.x,oe=D.clientY-se.startClient.y,F=Math.hypot(ee,oe);if(!se.didPan&&F>10&&(se.didPan=!0,u.current=!0,a(!0),p.current=Date.now()+250,o(null)),!se.didPan)return;const z=A(D.clientX,D.clientY);if(!se.lastWorld||!z)return;const Z={x:se.lastWorld.x-z.x,y:se.lastWorld.y-z.y};se.lastWorld=z,T(Z),D.preventDefault()},[h,A,g,M,u,f,b,o,a,v,p,T,s]),k=N.useCallback(D=>{h.current.delete(D);const q=M();q.length<2&&(f.current=!1,b.current=null);const se=g.current;se.activePointerId===D&&(se.didPan&&(p.current=Date.now()+250),g.current={activePointerId:q[0]?.[0]??null,startClient:q[0]?{...q[0][1]}:null,lastWorld:q[0]?A(q[0][1].x,q[0][1].y):null,didPan:!1}),h.current.size===0&&(u.current=!1,a(!1))},[h,A,g,M,u,f,b,a,p]),R=N.useCallback(D=>{k(D.pointerId);try{D.currentTarget.releasePointerCapture(D.pointerId)}catch{}},[k]),$=N.useCallback(D=>{k(D.pointerId)},[k]),j=N.useCallback(D=>{if((D.ctrlKey||D.deltaY!==0)&&D.preventDefault(),Math.abs(D.deltaY)<.1)return;const q=D.deltaY<0?7:11;v(q),p.current=Date.now()+120},[v,p]);return{handleResetView:_,handleTileClick:E,handleHoverTile:w,handleBoardPointerDown:C,handleBoardPointerMove:I,handleBoardPointerUp:R,handleBoardPointerCancel:$,handleBoardWheel:j}},tM=[7,11],mg=(e,n,s)=>e<n?n:e>s?s:e,nM=e=>({top:Math.max(0,Number(e?.top??0)),right:Math.max(0,Number(e?.right??0)),bottom:Math.max(0,Number(e?.bottom??0)),left:Math.max(0,Number(e?.left??0))}),cf=e=>{const n=nM(e.insets),s=Math.max(1,Number(e.width||0)-n.left-n.right),o=Math.max(1,Number(e.height||0)-n.top-n.bottom);return{width:s,height:o,insets:n}},iM=(e,n,s=0)=>{const o=Math.max(1,n),a=1.5*o,l=2*o;return(Math.max(1,e)-1)*a+l+Math.max(0,s)*2},sM=(e,n,s,o=0)=>{const a=cf(e),l=iM(n,s,o);return a.width/Math.max(1,l)},aM=(e,n)=>{const s=cf(e),o=Math.max(1,n.width),a=Math.max(1,n.height);return Math.min(s.width/o,s.height/a)},oM=(e,n)=>({x:e.x-n,y:e.y-n,width:e.width+n*2,height:e.height+n*2}),rM=(e,n)=>{const s=Math.max(1e-6,e),o=Math.max(1e-6,n);return Math.max(s,o)},pg=(e,n)=>{const s=cf(e),o=Math.max(1e-6,n);return{width:s.width/o,height:s.height/o}},lM=(e,n,s)=>{const o=n.width/2,a=n.height/2,l=s.x+o,u=s.x+s.width-o,f=s.y+a,p=s.y+s.height-a;return{x:l>u?s.x+s.width/2:mg(e.x,l,u),y:f>p?s.y+s.height/2:mg(e.y,f,p)}},hg=(e,n)=>({x:e.x-n.width/2,y:e.y-n.height/2,width:n.width,height:n.height}),cM=(e,n)=>e.didInit?(n.floor??null)!==e.lastCameraFloor?{action:"reset-floor",nextRefs:{...e,lastCameraFloor:n.floor??null,lastBoundsSignature:n.boundsSignature,lastViewportSignature:n.viewportSignature,lastPlayerKey:n.playerKey,lastZoomPreset:n.zoomPreset}}:n.floor!==void 0&&n.boundsSignature!==e.lastBoundsSignature?{action:"reset-bounds",nextRefs:{...e,lastBoundsSignature:n.boundsSignature,lastViewportSignature:n.viewportSignature,lastPlayerKey:n.playerKey,lastZoomPreset:n.zoomPreset}}:n.viewportSignature!==e.lastViewportSignature?{action:"snap-viewport",nextRefs:{...e,lastViewportSignature:n.viewportSignature,lastBoundsSignature:n.boundsSignature}}:n.zoomPreset!==e.lastZoomPreset?{action:"animate-zoom",nextRefs:{...e,lastZoomPreset:n.zoomPreset}}:n.playerKey!==e.lastPlayerKey?{action:"animate-player",nextRefs:{...e,lastPlayerKey:n.playerKey}}:{action:"none",nextRefs:e}:{action:"init",nextRefs:{didInit:!0,lastPlayerKey:n.playerKey,lastCameraFloor:n.floor??null,lastViewportSignature:n.viewportSignature,lastBoundsSignature:n.boundsSignature,lastZoomPreset:n.zoomPreset}},uM=({baseViewBox:e,playerWorld:n,playerPosition:s,floor:o,cameraSafeInsetsPx:a})=>{const[l,u]=N.useState(11),[f,p]=N.useState({width:0,height:0}),[h,g]=N.useState(!1),b=N.useRef(null),S=N.useRef(null),T=N.useRef(null),v=N.useRef(null),A=N.useRef({x:0,y:0}),_=N.useRef(!1),E=N.useRef(!1),w=N.useRef(0),M=N.useRef(new Map),C=N.useRef({activePointerId:null,startClient:null,lastWorld:null,didPan:!1}),I=N.useRef(null),k=N.useRef(null),R=N.useRef(null),$=N.useRef(!1),j=N.useRef(""),D=N.useRef(""),q=N.useRef(11),se=N.useRef(!1),ee=N.useCallback(()=>{v.current!==null&&(window.cancelAnimationFrame(v.current),v.current=null),se.current=!1},[]),oe=N.useCallback(G=>{const ae=b.current;ae&&ae.setAttribute("viewBox",`${G.x} ${G.y} ${G.width} ${G.height}`)},[]),F=N.useCallback(G=>{T.current=G,oe(G.viewBox)},[oe]),H=N.useCallback(G=>{const ae=Math.max(1,f.width),le=Math.max(1,f.height),ue=G?.zoomPreset??l,be=G?.panOffset??A.current,Ee={width:ae,height:le,insets:a||{}},at=X*.75,ot=oM(e,at),Nt=sM(Ee,ue,X,X*.2),Mt=aM(Ee,ot),Ne=rM(Mt,Nt),et=pg(Ee,Ne),Wt={x:n.x+be.x,y:n.y+be.y},Yt=lM(Wt,et,ot),_n=hg(Yt,et);return{center:Yt,scale:Ne,viewBox:_n}},[f.width,f.height,l,a,e,n.x,n.y]),z=N.useCallback((G,ae=220)=>{const le=T.current;if(!le){F(G);return}ee();const ue=le.center,be=le.scale,$e=G.center,Ee=G.scale,at=performance.now();se.current=!0;const ot=Mt=>1-Math.pow(1-Mt,3),Nt=Mt=>{const Ne=Math.min(1,(Mt-at)/Math.max(1,ae)),et=ot(Ne),Wt=be+(Ee-be)*et,Yt={x:ue.x+($e.x-ue.x)*et,y:ue.y+($e.y-ue.y)*et},_n={width:Math.max(1,f.width),height:Math.max(1,f.height),insets:a||{}},Pn=pg(_n,Wt),jn=hg(Yt,Pn);F({center:Yt,scale:Wt,viewBox:jn}),Ne<1?v.current=window.requestAnimationFrame(Nt):(v.current=null,se.current=!1,F(G))};v.current=window.requestAnimationFrame(Nt)},[ee,F,f.width,f.height,a]),Z=N.useCallback(G=>{ee(),F(H(G))},[ee,F,H]),re=N.useCallback(G=>{const ae=H(G);z(ae,G?.durationMs??220)},[z,H]);N.useEffect(()=>{const G=S.current;if(!G)return;const ae=()=>{const ue=G.getBoundingClientRect();p(be=>{const $e=Math.round(ue.width),Ee=Math.round(ue.height);return be.width===$e&&be.height===Ee?be:{width:$e,height:Ee}})};if(ae(),typeof ResizeObserver>"u")return window.addEventListener("resize",ae),()=>window.removeEventListener("resize",ae);const le=new ResizeObserver(()=>ae());return le.observe(G),()=>le.disconnect()},[]),N.useEffect(()=>{if(f.width<=0||f.height<=0)return;const G=`${e.x}:${e.y}:${e.width}:${e.height}`,ae=`${f.width}:${f.height}:${a?.top??0}:${a?.right??0}:${a?.bottom??0}:${a?.left??0}`,le=ce(s),ue=cM({didInit:$.current,lastPlayerKey:k.current,lastCameraFloor:R.current,lastViewportSignature:j.current,lastBoundsSignature:D.current,lastZoomPreset:q.current},{floor:o,playerKey:le,boundsSignature:G,viewportSignature:ae,zoomPreset:l});if($.current=ue.nextRefs.didInit,k.current=ue.nextRefs.lastPlayerKey,R.current=ue.nextRefs.lastCameraFloor,j.current=ue.nextRefs.lastViewportSignature,D.current=ue.nextRefs.lastBoundsSignature,q.current=ue.nextRefs.lastZoomPreset,ue.action==="init"){Z({panOffset:{x:0,y:0}});return}if(ue.action==="reset-floor"||ue.action==="reset-bounds"){const be={x:0,y:0};A.current=be,Z({panOffset:be});return}if(ue.action==="snap-viewport"){Z();return}if(ue.action==="animate-zoom"){re();return}if(ue.action==="animate-player"){const be={x:0,y:0};A.current=be,re({panOffset:be,durationMs:210})}},[f.width,f.height,e.x,e.y,e.width,e.height,a,o,s,l,Z,re]),N.useEffect(()=>()=>ee(),[ee]);const pe=N.useCallback(G=>{const ae={x:A.current.x+G.x,y:A.current.y+G.y};A.current=ae,ee(),F(H({panOffset:ae}))},[ee,F,H]),B=N.useCallback(G=>{u(ae=>ae===G?ae:G)},[]),W=T.current?.viewBox||e;return{svgRef:b,boardViewportRef:S,zoomPreset:l,isCameraPanning:h,setIsCameraPanning:g,cameraPanOffsetRef:A,isCameraPanningRef:_,isPinchingRef:E,suppressTileClickUntilRef:w,activePointersRef:M,dragStateRef:C,pinchStateRef:I,cancelCameraAnimation:ee,animateCameraToTarget:re,updatePanFromWorldDelta:pe,setZoomPresetAnimated:B,renderedViewBox:W}},dM=e=>{let n=2166136261;for(let s=0;s<e.length;s++)n^=e.charCodeAt(s),n=Math.imul(n,16777619);return n>>>0},No=e=>dM(e)/4294967295,fM=e=>{const n=(e.tags||[]).map(o=>o.toLowerCase()),s=[e.id.toLowerCase(),...n];for(const o of s){const a=o.match(/(?:cluster|hex)[-_]?([123])\b/);if(a)return Number(a[1]);if(o.includes("1-hex")||o.includes("single"))return 1;if(o.includes("2-hex")||o.includes("double"))return 2;if(o.includes("3-hex")||o.includes("triple"))return 3}return 1},mM=({assetManifest:e,biomeThemeKey:n,biomeSeed:s,mountainAssetPathOverride:o,wallsMountainPath:a,wallsThemeMountainPath:l,clutterLayer:u,cells:f,tileVisualFlags:p,boardProps:h,resolveMountainSettings:g})=>{const b=N.useMemo(()=>{const M=(e?.assets||[]).filter(R=>{if(R.type!=="prop")return!1;const $=R.id.toLowerCase(),j=new Set((R.tags||[]).map(se=>se.toLowerCase()));if(!($.includes("mountain")||j.has("mountain")))return!1;if(!R.theme)return!0;const q=R.theme.toLowerCase();return q===n||q==="core"}).sort((R,$)=>R.id.localeCompare($.id)),C=String(l||a||"").trim(),I=String(o||C).trim();if(!I)return M;const k=M.find(R=>R.path===I);return k?[k]:[]},[e?.assets,n,o,a,l]),S=N.useMemo(()=>{const w=new Map;for(const M of b)w.set(M.id,g(M));return w},[b,g]),T=N.useMemo(()=>{if(!b.length)return[];const w=b.filter(I=>fM(I)===1),M=w.length?w:b,C=f.filter(I=>p.get(ce(I))?.isWall).sort((I,k)=>ce(I).localeCompare(ce(k)));return C.length?C.map(I=>{const k=ce(I),R=Math.floor(No(`${s}|mountain-tile|${k}|asset`)*M.length)%M.length,$=M[R],j=S.get($.id)||g($),{y:D}=Ae(I,X);return{id:`mountain-${k}-${$.id}`,kind:"mountain",position:I,asset:$,renderScale:j.scale,zAnchorY:D+X*.42+j.offsetY}}):[]},[b,f,p,s,S,g]),v=N.useMemo(()=>{const w=new Set((u?.tags?.length?u.tags:["clutter","obstacle"]).map(M=>M.toLowerCase()));return(e?.assets||[]).filter(M=>{if(M.type!=="prop"&&M.type!=="decal"||M.id.toLowerCase().includes("mountain"))return!1;const I=(M.tags||[]).map(k=>k.toLowerCase());return I.includes("mountain")||!I.some(k=>w.has(k))?!1:M.theme?M.theme.toLowerCase()===n||M.theme.toLowerCase()==="core":!0})},[e?.assets,u?.tags,n]),A=N.useMemo(()=>{if(!v.length)return[];const w=Math.min(.6,Math.max(0,Number(u?.density??.08))),M=Math.max(1,Math.floor(Number(u?.maxPerHex??1))),C=Math.min(2,Math.max(1,Number(u?.bleedScaleMax??2))),I=[];for(const k of f){const R=ce(k),$=p.get(R);if($?.isWall||$?.isLava||$?.isFire)continue;const{y:j}=Ae(k,X);for(let D=0;D<M;D++){if(No(`${s}|clutter|${R}|slot:${D}|roll`)>w/(D+1))continue;const se=Math.floor(No(`${s}|clutter|${R}|slot:${D}|pick`)*v.length)%v.length,ee=v[se],oe=1+No(`${s}|clutter|${R}|slot:${D}|scale`)*(C-1),F=(No(`${s}|clutter|${R}|slot:${D}|depth`)-.5)*X*.28;I.push({id:`clutter-${R}-${D}-${ee.id}`,kind:"clutter",position:k,asset:ee,renderScale:oe,zAnchorY:j+F})}}return I},[f,p,v,u?.density,u?.maxPerHex,u?.bleedScaleMax,s]),_=N.useMemo(()=>{const w=[...T,...A];for(const M of h){const{y:C}=Ae(M.position,X),I=M.kind==="shrine";w.push({id:M.id,kind:M.kind,position:M.position,asset:M.asset,renderScale:Math.min(2,I?1.5:1.42),zAnchorY:C+(I?X*.32:X*.28),fallback:M.kind})}return w.sort((M,C)=>M.zAnchorY===C.zAnchorY?M.id.localeCompare(C.id):M.zAnchorY-C.zAnchorY),w},[T,A,h]),E=N.useMemo(()=>{const w=new Set;for(const M of T)w.add(ce(M.position));return w},[T]);return{mountainSettingsByAssetId:S,depthSortedSprites:_,mountainCoveredWallKeys:E}},Wd="/Hop",D0=/^[a-z0-9]+(?:[._-][a-z0-9]+)*$/,qo=/^\/assets\/[a-z0-9/_\-.]+$/,uf=["ground","decal","prop","unit","fx","ui"],pM=["svg","webp","avif","png","jpg","jpeg"],yg=["svg","webp","avif","png"],gg=["svg","webp","avif","png","jpg","jpeg"],bg=["svg","webp","avif","png"],Sg=["svg"],Gd=(e,n)=>`${e.endsWith("/")?e:`${e}/`}${n.replace(/^\/+/,"")}`,hM=Gd(Wd,"assets/manifest.json"),Es=e=>/^(?:[a-z]+:)?\/\//i.test(e)||e.startsWith("data:")?e:e.startsWith("/")?e.startsWith("/assets/")?Gd(Wd,e.slice(1)):e:Gd(Wd,e),Ea=e=>{if(e)return{...e,default:Es(e.default),themes:Object.fromEntries(Object.entries(e.themes||{}).map(([n,s])=>[n,Es(s)]))}},vg=e=>{if(e)return{...e,scale:e.scale??e.mountainScale,offsetX:e.offsetX??e.mountainOffsetX,offsetY:e.offsetY??e.mountainOffsetY,anchorX:e.anchorX??e.mountainAnchorX,anchorY:e.anchorY??e.mountainAnchorY,crustBlendMode:e.crustBlendMode??e.mountainCrustBlendMode,crustBlendOpacity:e.crustBlendOpacity??e.mountainCrustBlendOpacity,tintColor:e.tintColor??e.mountainTintColor,tintBlendMode:e.tintBlendMode??e.mountainTintBlendMode,tintOpacity:e.tintOpacity??e.mountainTintOpacity}},yM=e=>{if(e)return{...e,themes:Object.fromEntries(Object.entries(e.themes||{}).map(([n,s])=>[n,String(s)]))}},ql=e=>{if(e)return{detailA:Ea(e.detailA),detailB:Ea(e.detailB),tint:yM(e.tint)}},Xd=e=>{if(e)return{...e}},U0=e=>{if(!e)return;const n=vg(e);return{...n,mountainPath:n?.mountainPath?Es(n.mountainPath):n?.mountainPath,themes:Object.fromEntries(Object.entries(e.themes||{}).map(([s,o])=>[s,{...vg(o),mountainPath:o?.mountainPath?Es(o.mountainPath):o?.mountainPath}]))}},gM=e=>{if(e)return{...e,biomeLayers:e.biomeLayers?{undercurrent:Ea(e.biomeLayers.undercurrent),crust:Ea(e.biomeLayers.crust),clutter:e.biomeLayers.clutter?{...e.biomeLayers.clutter,tags:[...e.biomeLayers.clutter.tags||[]]}:void 0}:void 0,biomeMaterials:e.biomeMaterials?{undercurrent:ql(e.biomeMaterials.undercurrent),crust:ql(e.biomeMaterials.crust)}:void 0,walls:U0(e.walls),assetOverrides:Object.fromEntries(Object.entries(e.assetOverrides||{}).map(([n,s])=>[n,{...s,mountainSettings:Xd(s?.mountainSettings)}]))}},bM=e=>({...e,biomeUnderlay:e.biomeUnderlay?{...e.biomeUnderlay,default:Es(e.biomeUnderlay.default),themes:Object.fromEntries(Object.entries(e.biomeUnderlay.themes||{}).map(([n,s])=>[n,Es(s)]))}:void 0,biomeLayers:e.biomeLayers?{undercurrent:Ea(e.biomeLayers.undercurrent),crust:Ea(e.biomeLayers.crust),clutter:e.biomeLayers.clutter?{...e.biomeLayers.clutter,tags:[...e.biomeLayers.clutter.tags||[]]}:void 0}:void 0,biomeMaterials:e.biomeMaterials?{undercurrent:ql(e.biomeMaterials.undercurrent),crust:ql(e.biomeMaterials.crust)}:void 0,walls:U0(e.walls),biomePresets:Object.fromEntries(Object.entries(e.biomePresets||{}).map(([n,s])=>[n,gM(s)||{}])),assets:e.assets.map(n=>({...n,path:Es(n.path),mountainSettings:Xd(n.mountainSettings),mountainSettingsByTheme:Object.fromEntries(Object.entries(n.mountainSettingsByTheme||{}).map(([s,o])=>[s,Xd(o)||{}]))}))}),xg={version:"1.0.0",gridTopology:"flat-top-hex",tileUnitPx:256,tileAspectRatio:1.154700538,layers:[...uf],assets:[]};let ml=null;const Ag=e=>typeof e=="string"&&uf.includes(e),Tg=e=>typeof e=="string"&&["tile","decal","prop","unit","fx","ui"].includes(e),Eg=e=>typeof e=="string"&&pM.includes(e),_s=(e,n,s)=>{if(!e||typeof e!="object"){s.push(`"${n}" must be an object when provided.`);return}if((typeof e.default!="string"||!qo.test(e.default))&&s.push(`"${n}.default" must be a /assets/... path.`),e.themes!==void 0)if(!e.themes||typeof e.themes!="object")s.push(`"${n}.themes" must be an object when provided.`);else for(const[o,a]of Object.entries(e.themes))(typeof o!="string"||o.trim().length===0)&&s.push(`"${n}.themes" contains an invalid theme key.`),(typeof a!="string"||!qo.test(a))&&s.push(`"${n}.themes.${o}" must be a /assets/... path.`);if(e.mode!==void 0&&e.mode!=="off"&&e.mode!=="cover"&&e.mode!=="repeat"&&s.push(`"${n}.mode" must be one of "off", "cover", or "repeat".`),e.scalePx!==void 0&&(!Number.isFinite(e.scalePx)||Number(e.scalePx)<=0)&&s.push(`"${n}.scalePx" must be > 0 when provided.`),e.opacity!==void 0&&(!Number.isFinite(e.opacity)||Number(e.opacity)<0||Number(e.opacity)>1)&&s.push(`"${n}.opacity" must be in [0, 1] when provided.`),e.seedShiftPx!==void 0&&(!Number.isFinite(e.seedShiftPx)||Number(e.seedShiftPx)<0)&&s.push(`"${n}.seedShiftPx" must be >= 0 when provided.`),e.offsetX!==void 0&&!Number.isFinite(e.offsetX)&&s.push(`"${n}.offsetX" must be a finite number when provided.`),e.offsetY!==void 0&&!Number.isFinite(e.offsetY)&&s.push(`"${n}.offsetY" must be a finite number when provided.`),e.scroll!==void 0){const o=e.scroll;!o||typeof o!="object"?s.push(`"${n}.scroll" must be an object when provided.`):(o.x!==void 0&&!Number.isFinite(o.x)&&s.push(`"${n}.scroll.x" must be a finite number.`),o.y!==void 0&&!Number.isFinite(o.y)&&s.push(`"${n}.scroll.y" must be a finite number.`),o.durationMs!==void 0&&(!Number.isFinite(o.durationMs)||Number(o.durationMs)<=0)&&s.push(`"${n}.scroll.durationMs" must be > 0 when provided.`))}},SM=(e,n,s)=>{if(!e||typeof e!="object"){s.push(`"${n}" must be an object when provided.`);return}if((typeof e.default!="string"||e.default.trim().length===0)&&s.push(`"${n}.default" must be a non-empty color string.`),e.themes!==void 0)if(!e.themes||typeof e.themes!="object")s.push(`"${n}.themes" must be an object when provided.`);else for(const[o,a]of Object.entries(e.themes))(typeof o!="string"||o.trim().length===0)&&s.push(`"${n}.themes" contains an invalid theme key.`),(typeof a!="string"||a.trim().length===0)&&s.push(`"${n}.themes.${o}" must be a non-empty color string.`);e.opacity!==void 0&&(!Number.isFinite(e.opacity)||Number(e.opacity)<0||Number(e.opacity)>1)&&s.push(`"${n}.opacity" must be in [0, 1] when provided.`),e.blendMode!==void 0&&e.blendMode!=="normal"&&e.blendMode!=="multiply"&&e.blendMode!=="overlay"&&e.blendMode!=="soft-light"&&e.blendMode!=="screen"&&e.blendMode!=="color-dodge"&&s.push(`"${n}.blendMode" must be one of "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`)},zo=(e,n,s)=>{if(!e||typeof e!="object"){s.push(`"${n}" must be an object when provided.`);return}e.scale!==void 0&&(!Number.isFinite(e.scale)||Number(e.scale)<=0)&&s.push(`"${n}.scale" must be > 0 when provided.`),e.offsetX!==void 0&&!Number.isFinite(e.offsetX)&&s.push(`"${n}.offsetX" must be a finite number when provided.`),e.offsetY!==void 0&&!Number.isFinite(e.offsetY)&&s.push(`"${n}.offsetY" must be a finite number when provided.`),e.anchorX!==void 0&&(!Number.isFinite(e.anchorX)||Number(e.anchorX)<0||Number(e.anchorX)>1)&&s.push(`"${n}.anchorX" must be in [0, 1] when provided.`),e.anchorY!==void 0&&(!Number.isFinite(e.anchorY)||Number(e.anchorY)<0||Number(e.anchorY)>1)&&s.push(`"${n}.anchorY" must be in [0, 1] when provided.`),e.crustBlendMode!==void 0&&e.crustBlendMode!=="off"&&e.crustBlendMode!=="normal"&&e.crustBlendMode!=="multiply"&&e.crustBlendMode!=="overlay"&&e.crustBlendMode!=="soft-light"&&e.crustBlendMode!=="screen"&&e.crustBlendMode!=="color-dodge"&&s.push(`"${n}.crustBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.tintBlendMode!==void 0&&e.tintBlendMode!=="off"&&e.tintBlendMode!=="normal"&&e.tintBlendMode!=="multiply"&&e.tintBlendMode!=="overlay"&&e.tintBlendMode!=="soft-light"&&e.tintBlendMode!=="screen"&&e.tintBlendMode!=="color-dodge"&&s.push(`"${n}.tintBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.crustBlendOpacity!==void 0&&(!Number.isFinite(e.crustBlendOpacity)||Number(e.crustBlendOpacity)<0||Number(e.crustBlendOpacity)>1)&&s.push(`"${n}.crustBlendOpacity" must be in [0, 1] when provided.`),e.tintOpacity!==void 0&&(!Number.isFinite(e.tintOpacity)||Number(e.tintOpacity)<0||Number(e.tintOpacity)>1)&&s.push(`"${n}.tintOpacity" must be in [0, 1] when provided.`),e.tintColor!==void 0&&(typeof e.tintColor!="string"||e.tintColor.trim().length===0)&&s.push(`"${n}.tintColor" must be a non-empty color string when provided.`)},$0=(e,n,s)=>{if(!e||typeof e!="object"){s.push(`"${n}" must be an object when provided.`);return}if(e.mode!==void 0&&e.mode!=="native"&&e.mode!=="additive"&&e.mode!=="custom"&&s.push(`"${n}.mode" must be one of "native", "additive", or "custom".`),e.interiorDensity!==void 0&&(!Number.isFinite(e.interiorDensity)||Number(e.interiorDensity)<0||Number(e.interiorDensity)>1)&&s.push(`"${n}.interiorDensity" must be in [0, 1] when provided.`),e.clusterBias!==void 0&&(!Number.isFinite(e.clusterBias)||Number(e.clusterBias)<0||Number(e.clusterBias)>1)&&s.push(`"${n}.clusterBias" must be in [0, 1] when provided.`),e.keepPerimeter!==void 0&&typeof e.keepPerimeter!="boolean"&&s.push(`"${n}.keepPerimeter" must be a boolean when provided.`),e.mountainPath!==void 0&&(typeof e.mountainPath!="string"||!qo.test(e.mountainPath))&&s.push(`"${n}.mountainPath" must be a /assets/... path when provided.`),e.mountainScale!==void 0&&(!Number.isFinite(e.mountainScale)||Number(e.mountainScale)<=0)&&s.push(`"${n}.mountainScale" must be > 0 when provided.`),e.mountainOffsetX!==void 0&&!Number.isFinite(e.mountainOffsetX)&&s.push(`"${n}.mountainOffsetX" must be a finite number when provided.`),e.mountainOffsetY!==void 0&&!Number.isFinite(e.mountainOffsetY)&&s.push(`"${n}.mountainOffsetY" must be a finite number when provided.`),e.mountainAnchorX!==void 0&&(!Number.isFinite(e.mountainAnchorX)||Number(e.mountainAnchorX)<0||Number(e.mountainAnchorX)>1)&&s.push(`"${n}.mountainAnchorX" must be in [0, 1] when provided.`),e.mountainAnchorY!==void 0&&(!Number.isFinite(e.mountainAnchorY)||Number(e.mountainAnchorY)<0||Number(e.mountainAnchorY)>1)&&s.push(`"${n}.mountainAnchorY" must be in [0, 1] when provided.`),e.mountainCrustBlendMode!==void 0&&e.mountainCrustBlendMode!=="off"&&e.mountainCrustBlendMode!=="normal"&&e.mountainCrustBlendMode!=="multiply"&&e.mountainCrustBlendMode!=="overlay"&&e.mountainCrustBlendMode!=="soft-light"&&e.mountainCrustBlendMode!=="screen"&&e.mountainCrustBlendMode!=="color-dodge"&&s.push(`"${n}.mountainCrustBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.mountainCrustBlendOpacity!==void 0&&(!Number.isFinite(e.mountainCrustBlendOpacity)||Number(e.mountainCrustBlendOpacity)<0||Number(e.mountainCrustBlendOpacity)>1)&&s.push(`"${n}.mountainCrustBlendOpacity" must be in [0, 1] when provided.`),e.mountainTintColor!==void 0&&(typeof e.mountainTintColor!="string"||e.mountainTintColor.trim().length===0)&&s.push(`"${n}.mountainTintColor" must be a non-empty color string when provided.`),e.mountainTintBlendMode!==void 0&&e.mountainTintBlendMode!=="off"&&e.mountainTintBlendMode!=="normal"&&e.mountainTintBlendMode!=="multiply"&&e.mountainTintBlendMode!=="overlay"&&e.mountainTintBlendMode!=="soft-light"&&e.mountainTintBlendMode!=="screen"&&e.mountainTintBlendMode!=="color-dodge"&&s.push(`"${n}.mountainTintBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.mountainTintOpacity!==void 0&&(!Number.isFinite(e.mountainTintOpacity)||Number(e.mountainTintOpacity)<0||Number(e.mountainTintOpacity)>1)&&s.push(`"${n}.mountainTintOpacity" must be in [0, 1] when provided.`),zo(e,n,s),e.themes!==void 0)if(!e.themes||typeof e.themes!="object")s.push(`"${n}.themes" must be an object when provided.`);else for(const[o,a]of Object.entries(e.themes)){if(typeof o!="string"||o.trim().length===0){s.push(`"${n}.themes" contains an invalid theme key.`);continue}if(!a||typeof a!="object"){s.push(`"${n}.themes.${o}" must be an object.`);continue}a.mountainPath!==void 0&&(typeof a.mountainPath!="string"||!qo.test(a.mountainPath))&&s.push(`"${n}.themes.${o}.mountainPath" must be a /assets/... path when provided.`);const l=a;l.mountainScale!==void 0&&(!Number.isFinite(l.mountainScale)||Number(l.mountainScale)<=0)&&s.push(`"${n}.themes.${o}.mountainScale" must be > 0 when provided.`),l.mountainOffsetX!==void 0&&!Number.isFinite(l.mountainOffsetX)&&s.push(`"${n}.themes.${o}.mountainOffsetX" must be a finite number when provided.`),l.mountainOffsetY!==void 0&&!Number.isFinite(l.mountainOffsetY)&&s.push(`"${n}.themes.${o}.mountainOffsetY" must be a finite number when provided.`),l.mountainAnchorX!==void 0&&(!Number.isFinite(l.mountainAnchorX)||Number(l.mountainAnchorX)<0||Number(l.mountainAnchorX)>1)&&s.push(`"${n}.themes.${o}.mountainAnchorX" must be in [0, 1] when provided.`),l.mountainAnchorY!==void 0&&(!Number.isFinite(l.mountainAnchorY)||Number(l.mountainAnchorY)<0||Number(l.mountainAnchorY)>1)&&s.push(`"${n}.themes.${o}.mountainAnchorY" must be in [0, 1] when provided.`),l.mountainCrustBlendMode!==void 0&&l.mountainCrustBlendMode!=="off"&&l.mountainCrustBlendMode!=="normal"&&l.mountainCrustBlendMode!=="multiply"&&l.mountainCrustBlendMode!=="overlay"&&l.mountainCrustBlendMode!=="soft-light"&&l.mountainCrustBlendMode!=="screen"&&l.mountainCrustBlendMode!=="color-dodge"&&s.push(`"${n}.themes.${o}.mountainCrustBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),l.mountainCrustBlendOpacity!==void 0&&(!Number.isFinite(l.mountainCrustBlendOpacity)||Number(l.mountainCrustBlendOpacity)<0||Number(l.mountainCrustBlendOpacity)>1)&&s.push(`"${n}.themes.${o}.mountainCrustBlendOpacity" must be in [0, 1] when provided.`),l.mountainTintBlendMode!==void 0&&l.mountainTintBlendMode!=="off"&&l.mountainTintBlendMode!=="normal"&&l.mountainTintBlendMode!=="multiply"&&l.mountainTintBlendMode!=="overlay"&&l.mountainTintBlendMode!=="soft-light"&&l.mountainTintBlendMode!=="screen"&&l.mountainTintBlendMode!=="color-dodge"&&s.push(`"${n}.themes.${o}.mountainTintBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),l.mountainTintOpacity!==void 0&&(!Number.isFinite(l.mountainTintOpacity)||Number(l.mountainTintOpacity)<0||Number(l.mountainTintOpacity)>1)&&s.push(`"${n}.themes.${o}.mountainTintOpacity" must be in [0, 1] when provided.`),l.mountainTintColor!==void 0&&(typeof l.mountainTintColor!="string"||l.mountainTintColor.trim().length===0)&&s.push(`"${n}.themes.${o}.mountainTintColor" must be a non-empty color string when provided.`),zo(a,`${n}.themes.${o}`,s)}},zl=(e,n,s)=>{if(!e||typeof e!="object"){s.push(`"${n}" must be an object when provided.`);return}e.detailA!==void 0&&_s(e.detailA,`${n}.detailA`,s),e.detailB!==void 0&&_s(e.detailB,`${n}.detailB`,s),e.tint!==void 0&&SM(e.tint,`${n}.tint`,s),e.detailA===void 0&&e.detailB===void 0&&e.tint===void 0&&s.push(`"${n}" must define at least one of "detailA", "detailB", or "tint".`)},vM=(e,n,s)=>{if(!e||typeof e!="object"){s.push(`"${n}" must be an object when provided.`);return}if(e.seed!==void 0&&(typeof e.seed!="string"||e.seed.trim().length===0)&&s.push(`"${n}.seed" must be a non-empty string when provided.`),e.injectHazards!==void 0&&typeof e.injectHazards!="boolean"&&s.push(`"${n}.injectHazards" must be a boolean when provided.`),e.biomeLayers!==void 0){const o=e.biomeLayers;if(!o||typeof o!="object")s.push(`"${n}.biomeLayers" must be an object when provided.`);else if(o.undercurrent!==void 0&&_s(o.undercurrent,`${n}.biomeLayers.undercurrent`,s),o.crust!==void 0&&_s(o.crust,`${n}.biomeLayers.crust`,s),o.clutter!==void 0){const a=o.clutter;!a||typeof a!="object"?s.push(`"${n}.biomeLayers.clutter" must be an object when provided.`):(a.density!==void 0&&(!Number.isFinite(a.density)||Number(a.density)<0||Number(a.density)>1)&&s.push(`"${n}.biomeLayers.clutter.density" must be in [0, 1] when provided.`),a.maxPerHex!==void 0&&(!Number.isFinite(a.maxPerHex)||Number(a.maxPerHex)<0)&&s.push(`"${n}.biomeLayers.clutter.maxPerHex" must be >= 0 when provided.`),a.bleedScaleMax!==void 0&&(!Number.isFinite(a.bleedScaleMax)||Number(a.bleedScaleMax)<1||Number(a.bleedScaleMax)>2)&&s.push(`"${n}.biomeLayers.clutter.bleedScaleMax" must be within [1, 2] when provided.`),a.tags!==void 0&&(!Array.isArray(a.tags)||!a.tags.every(l=>typeof l=="string"&&l.length>0))&&s.push(`"${n}.biomeLayers.clutter.tags" must be a string array when provided.`))}}if(e.biomeMaterials!==void 0){const o=e.biomeMaterials;!o||typeof o!="object"?s.push(`"${n}.biomeMaterials" must be an object when provided.`):(o.undercurrent!==void 0&&zl(o.undercurrent,`${n}.biomeMaterials.undercurrent`,s),o.crust!==void 0&&zl(o.crust,`${n}.biomeMaterials.crust`,s))}if(e.walls!==void 0&&$0(e.walls,`${n}.walls`,s),e.assetOverrides!==void 0)if(!e.assetOverrides||typeof e.assetOverrides!="object")s.push(`"${n}.assetOverrides" must be an object when provided.`);else for(const[o,a]of Object.entries(e.assetOverrides)){if(!D0.test(o)){s.push(`"${n}.assetOverrides" contains invalid asset id "${o}".`);continue}if(!a||typeof a!="object"){s.push(`"${n}.assetOverrides.${o}" must be an object.`);continue}a.mountainSettings!==void 0&&zo(a.mountainSettings,`${n}.assetOverrides.${o}.mountainSettings`,s)}},xM=e=>{const n=[];if(!e||typeof e!="object")return{valid:!1,errors:["Manifest is not an object."]};const s=e;if((typeof s.version!="string"||s.version.length===0)&&n.push('Missing or invalid "version".'),s.gridTopology!=="flat-top-hex"&&n.push('Only "flat-top-hex" gridTopology is supported.'),(!Number.isFinite(s.tileUnitPx)||Number(s.tileUnitPx)<=0)&&n.push('Missing or invalid "tileUnitPx".'),(!Number.isFinite(s.tileAspectRatio)||Number(s.tileAspectRatio)<=0)&&n.push('Missing or invalid "tileAspectRatio".'),s.biomeUnderlay!==void 0&&_s(s.biomeUnderlay,"biomeUnderlay",n),s.biomeLayers!==void 0){const a=s.biomeLayers;if(!a||typeof a!="object")n.push('"biomeLayers" must be an object when provided.');else if(a.undercurrent!==void 0&&_s(a.undercurrent,"biomeLayers.undercurrent",n),a.crust!==void 0&&_s(a.crust,"biomeLayers.crust",n),!a.undercurrent&&!a.crust&&n.push('"biomeLayers" must define at least one of "undercurrent" or "crust".'),a.clutter!==void 0){const l=a.clutter;!l||typeof l!="object"?n.push('"biomeLayers.clutter" must be an object when provided.'):(l.density!==void 0&&(!Number.isFinite(l.density)||Number(l.density)<0||Number(l.density)>1)&&n.push('"biomeLayers.clutter.density" must be in [0, 1] when provided.'),l.maxPerHex!==void 0&&(!Number.isFinite(l.maxPerHex)||Number(l.maxPerHex)<0)&&n.push('"biomeLayers.clutter.maxPerHex" must be >= 0 when provided.'),l.bleedScaleMax!==void 0&&(!Number.isFinite(l.bleedScaleMax)||Number(l.bleedScaleMax)<1||Number(l.bleedScaleMax)>2)&&n.push('"biomeLayers.clutter.bleedScaleMax" must be within [1, 2] when provided.'),l.tags!==void 0&&(!Array.isArray(l.tags)||!l.tags.every(u=>typeof u=="string"&&u.length>0))&&n.push('"biomeLayers.clutter.tags" must be a string array when provided.'))}}if(s.biomeMaterials!==void 0){const a=s.biomeMaterials;!a||typeof a!="object"?n.push('"biomeMaterials" must be an object when provided.'):(a.undercurrent!==void 0&&zl(a.undercurrent,"biomeMaterials.undercurrent",n),a.crust!==void 0&&zl(a.crust,"biomeMaterials.crust",n),a.undercurrent===void 0&&a.crust===void 0&&n.push('"biomeMaterials" must define at least one of "undercurrent" or "crust".'))}if(s.walls!==void 0&&$0(s.walls,"walls",n),s.biomePresets!==void 0)if(!s.biomePresets||typeof s.biomePresets!="object")n.push('"biomePresets" must be an object when provided.');else for(const[a,l]of Object.entries(s.biomePresets)){if(typeof a!="string"||a.trim().length===0){n.push('"biomePresets" contains an invalid theme key.');continue}vM(l,`biomePresets.${a}`,n)}if(!Array.isArray(s.layers)||s.layers.length===0||!s.layers.every(Ag))n.push('Missing or invalid "layers".');else for(const a of uf)s.layers.includes(a)||n.push(`Missing required layer "${a}" in "layers".`);if(!Array.isArray(s.assets))return n.push('Missing or invalid "assets".'),{valid:n.length===0,errors:n};const o=new Set;for(const[a,l]of s.assets.entries()){const u=`assets[${a}]`;if(!l||typeof l!="object"){n.push(`${u} is not an object.`);continue}const f=l;if(typeof f.id!="string"||!D0.test(f.id)?n.push(`${u}.id is invalid; expected lowercase tokenized id.`):o.has(f.id)?n.push(`${u}.id is duplicated (${f.id}).`):o.add(f.id),Tg(f.type)||n.push(`${u}.type is invalid.`),Ag(f.layer)||n.push(`${u}.layer is invalid.`),Eg(f.recommendedFormat)||n.push(`${u}.recommendedFormat is invalid.`),Tg(f.type)&&Eg(f.recommendedFormat)&&((f.type==="tile"||f.type==="decal"||f.type==="prop")&&!gg.includes(f.recommendedFormat)&&n.push(`${u}.recommendedFormat must be one of ${gg.join(", ")} for ${f.type}.`),f.type==="ui"&&!Sg.includes(f.recommendedFormat)&&n.push(`${u}.recommendedFormat must be one of ${Sg.join(", ")} for ui.`),f.type==="unit"&&!yg.includes(f.recommendedFormat)&&n.push(`${u}.recommendedFormat must be one of ${yg.join(", ")} for units.`),f.type==="fx"&&!bg.includes(f.recommendedFormat)&&n.push(`${u}.recommendedFormat must be one of ${bg.join(", ")} for fx.`)),(typeof f.path!="string"||!qo.test(f.path))&&n.push(`${u}.path is invalid; expected /assets/...`),(!Number.isFinite(f.width)||Number(f.width)<=0)&&n.push(`${u}.width must be > 0.`),(!Number.isFinite(f.height)||Number(f.height)<=0)&&n.push(`${u}.height must be > 0.`),f.mountainSettings!==void 0&&zo(f.mountainSettings,`${u}.mountainSettings`,n),f.mountainSettingsByTheme!==void 0)if(!f.mountainSettingsByTheme||typeof f.mountainSettingsByTheme!="object")n.push(`${u}.mountainSettingsByTheme must be an object when provided.`);else for(const[p,h]of Object.entries(f.mountainSettingsByTheme)){if(typeof p!="string"||p.trim().length===0){n.push(`${u}.mountainSettingsByTheme contains an invalid theme key.`);continue}zo(h,`${u}.mountainSettingsByTheme.${p}`,n)}}return{valid:n.length===0,errors:n}},AM=async()=>ml||(ml=fetch(hM).then(async e=>{if(!e.ok)throw new Error(`Asset manifest fetch failed: ${e.status}`);return e.json()}).then(e=>{const n=xM(e);return n.valid?bM(e):(console.warn("[HOP_ASSETS] Invalid manifest; using fallback.",n.errors),xg)}).catch(e=>(console.warn("[HOP_ASSETS] Failed to load manifest; using fallback.",e),xg)),ml),df=(e,n)=>{if(!e)return;const s=String(n||"").toLowerCase();if(s)return e.biomePresets?.[s]},kd=e=>{let n=2166136261;for(let s=0;s<e.length;s++)n^=e.charCodeAt(s),n=Math.imul(n,16777619);return n>>>0},pl=(e,n)=>{if(e)return n&&e.themes?.[n]?e.themes[n]:e.default},hl=e=>e?e.mode==="cover"||e.mode==="repeat"||e.mode==="off"?e.mode:"cover":"off",Rd=e=>Math.min(1,Math.max(0,Number(e?.opacity??1))),yl=(e,n,s=64,o=Number.POSITIVE_INFINITY)=>{const a=Number(e?.scalePx||n);return Math.min(o,Math.max(s,a))},_g=e=>({x:Number(e?.scroll?.x??0),y:Number(e?.scroll?.y??0),durationMs:Math.max(1e3,Number(e?.scroll?.durationMs??18e3))}),TM=(e,n)=>{if(e)return n&&e.themes?.[n]?e.themes[n]:e.default},EM=e=>Math.min(1,Math.max(0,Number(e?.opacity??0))),q0=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",z0=(e,n="#8b6f4a")=>{const s=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(s))return s.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(s)){const[l,u,f]=s.slice(1).split("");return`#${l}${l}${u}${u}${f}${f}`.toLowerCase()}return n},_M=e=>{const s=z0(e).slice(1);return{r:parseInt(s.slice(0,2),16)/255,g:parseInt(s.slice(2,4),16)/255,b:parseInt(s.slice(4,6),16)/255}},wg=(e,n)=>e==="off"?"off":e?q0(e):n,Mg=e=>{const n=[];for(let s=0;s<6;s++){const o=Math.PI/180*(60*s);n.push(`${e*Math.cos(o)},${e*Math.sin(o)}`)}return n.join(" ")},wM=({asset:e,biomeThemeKey:n,biomeDebug:s,biomeThemePreset:o,wallsProfile:a,wallsThemeOverride:l,crustTintBlendMode:u,crustTintColor:f,defaultMountainCrustBlendOpacity:p})=>{const h=e?.mountainSettings,g=e?.mountainSettingsByTheme?.[n],S=(e?o?.assetOverrides?.[e.id]:void 0)?.mountainSettings,T=Math.min(3,Math.max(.2,Number(s?.mountainScale??S?.scale??g?.scale??l?.scale??a?.scale??h?.scale??.95))),v=Number(s?.mountainOffset?.x??S?.offsetX??g?.offsetX??l?.offsetX??a?.offsetX??h?.offsetX??0),A=Number(s?.mountainOffset?.y??S?.offsetY??g?.offsetY??l?.offsetY??a?.offsetY??h?.offsetY??0),_=Math.min(1,Math.max(0,Number(s?.mountainAnchor?.x??S?.anchorX??g?.anchorX??l?.anchorX??a?.anchorX??h?.anchorX??.5))),E=Math.min(1,Math.max(0,Number(s?.mountainAnchor?.y??S?.anchorY??g?.anchorY??l?.anchorY??a?.anchorY??h?.anchorY??.78))),w=wg(s?.mountainCrustBlendMode??S?.crustBlendMode??g?.crustBlendMode??l?.crustBlendMode??a?.crustBlendMode??h?.crustBlendMode,u),M=Math.min(1,Math.max(0,Number(s?.mountainCrustBlendOpacity??S?.crustBlendOpacity??g?.crustBlendOpacity??l?.crustBlendOpacity??a?.crustBlendOpacity??h?.crustBlendOpacity??p))),C=z0(String(s?.mountainTintColor??S?.tintColor??g?.tintColor??l?.tintColor??a?.tintColor??h?.tintColor??f??"#8b6f4a")),I=wg(s?.mountainTintBlendMode??S?.tintBlendMode??g?.tintBlendMode??l?.tintBlendMode??a?.tintBlendMode??h?.tintBlendMode,"soft-light"),k=Math.min(1,Math.max(0,Number(s?.mountainTintOpacity??S?.tintOpacity??g?.tintOpacity??l?.tintOpacity??a?.tintOpacity??h?.tintOpacity??0))),R=_M(C);return{scale:T,offsetX:v,offsetY:A,anchorX:_,anchorY:E,crustBlendMode:w,crustBlendOpacity:M,tintColor:C,tintBlendMode:I,tintOpacity:k,tintMatrixValues:`0 0 0 0 ${R.r.toFixed(4)} 0 0 0 0 ${R.g.toFixed(4)} 0 0 0 0 ${R.b.toFixed(4)} 0 0 0 1 0`}},MM=({cells:e,gameState:n,bounds:s,assetManifest:o,biomeDebug:a})=>{const l=N.useMemo(()=>{const _e=new Map;for(const ht of e){const Bt=ce(ht),rt=Me.getTraitsAt(n,ht),fn=rt.has("BLOCKS_MOVEMENT")&&rt.has("BLOCKS_LOS"),sn=rt.has("LAVA")||rt.has("HAZARDOUS")&&rt.has("LIQUID"),yi=rt.has("FIRE");_e.set(Bt,{isWall:fn,isLava:!fn&&sn,isFire:!fn&&yi})}return _e},[e,n.tiles]),u=N.useMemo(()=>{const _e=new Map;for(const ht of o?.assets||[])_e.set(ht.id,ht);return _e},[o]),f=N.useMemo(()=>u.get(Z_())?.path,[u]),p=N.useMemo(()=>Math.max(1,o?.tileUnitPx||256),[o?.tileUnitPx]),h=N.useMemo(()=>X*2/p,[p]),g=N.useMemo(()=>String(n.theme||"").toLowerCase(),[n.theme]),b=N.useMemo(()=>`${n.initialSeed||n.rngSeed||n.turnNumber}:${n.floor}:${g}`,[n.initialSeed,n.rngSeed,n.turnNumber,n.floor,g]),S=N.useMemo(()=>df(o,g),[o,g]),T=N.useMemo(()=>{const _e=o?.biomeUnderlay;if(_e)return{default:_e.default,themes:_e.themes,mode:_e.mode,scalePx:_e.scalePx,opacity:_e.opacity}},[o?.biomeUnderlay]),v=N.useMemo(()=>S?.biomeLayers?.undercurrent||o?.biomeLayers?.undercurrent,[S?.biomeLayers?.undercurrent,o?.biomeLayers?.undercurrent]),A=N.useMemo(()=>S?.biomeLayers?.crust||o?.biomeLayers?.crust||T,[S?.biomeLayers?.crust,o?.biomeLayers?.crust,T]),_=N.useMemo(()=>S?.biomeLayers?.clutter||o?.biomeLayers?.clutter,[S?.biomeLayers?.clutter,o?.biomeLayers?.clutter]),E=N.useMemo(()=>pl(v,g),[v,g]),w=N.useMemo(()=>hl(v),[v]),M=N.useMemo(()=>yl(v,p,64,192),[v,p]),C=N.useMemo(()=>Rd(v),[v]),I=N.useMemo(()=>({x:Number(v?.scroll?.x??120),y:Number(v?.scroll?.y??90),durationMs:Math.max(1e3,Number(v?.scroll?.durationMs??92e3))}),[v?.scroll?.x,v?.scroll?.y,v?.scroll?.durationMs]),k=N.useMemo(()=>({x:Number(v?.offsetX??0)+Number(a?.undercurrentOffset?.x??0),y:Number(v?.offsetY??0)+Number(a?.undercurrentOffset?.y??0)}),[v?.offsetX,v?.offsetY,a?.undercurrentOffset?.x,a?.undercurrentOffset?.y]),R=N.useMemo(()=>pl(A,g),[A,g]),$=N.useMemo(()=>hl(A),[A]),j=N.useMemo(()=>yl(A,p,64),[A,p]),D=1,q=N.useMemo(()=>{const _e=Math.max(0,Number(A?.seedShiftPx??X*5));if(_e===0)return{x:0,y:0};const ht=kd(`${b}|crust-offset`),Bt=((ht&65535)/65535*2-1)*_e,rt=((ht>>>16&65535)/65535*2-1)*_e;return{x:Bt,y:rt}},[A?.seedShiftPx,b]),se=N.useMemo(()=>({x:Number(A?.offsetX??0)+Number(a?.crustOffset?.x??0),y:Number(A?.offsetY??0)+Number(a?.crustOffset?.y??0)}),[A?.offsetX,A?.offsetY,a?.crustOffset?.x,a?.crustOffset?.y]),ee=N.useMemo(()=>({x:q.x+se.x,y:q.y+se.y}),[q.x,q.y,se.x,se.y]),oe=N.useMemo(()=>o?.walls,[o?.walls]),F=N.useMemo(()=>S?.walls||oe?.themes?.[g],[S?.walls,oe?.themes,g]),H=N.useMemo(()=>S?.biomeMaterials?.crust||o?.biomeMaterials?.crust,[S?.biomeMaterials?.crust,o?.biomeMaterials?.crust]),z=N.useMemo(()=>H?.detailA,[H?.detailA]),Z=N.useMemo(()=>H?.detailB,[H?.detailB]),re=N.useMemo(()=>pl(z,g),[z,g]),pe=N.useMemo(()=>pl(Z,g),[Z,g]),B=N.useMemo(()=>hl(z),[z]),W=N.useMemo(()=>hl(Z),[Z]),G=N.useMemo(()=>yl(z,j,64),[z,j]),ae=N.useMemo(()=>yl(Z,j,64),[Z,j]),le=N.useMemo(()=>Rd(z),[z]),ue=N.useMemo(()=>Rd(Z),[Z]),be=N.useMemo(()=>_g(z),[z?.scroll?.x,z?.scroll?.y,z?.scroll?.durationMs]),$e=N.useMemo(()=>_g(Z),[Z?.scroll?.x,Z?.scroll?.y,Z?.scroll?.durationMs]),Ee=N.useMemo(()=>{const _e=X*.75,ht=kd(`${b}|crust-detail-a-offset`),Bt=((ht&65535)/65535*2-1)*_e,rt=((ht>>>16&65535)/65535*2-1)*_e;return{x:Bt,y:rt}},[b]),at=N.useMemo(()=>{const _e=X*.75,ht=kd(`${b}|crust-detail-b-offset`),Bt=((ht&65535)/65535*2-1)*_e,rt=((ht>>>16&65535)/65535*2-1)*_e;return{x:Bt,y:rt}},[b]),ot=N.useMemo(()=>({x:ee.x+Ee.x,y:ee.y+Ee.y}),[ee.x,ee.y,Ee.x,Ee.y]),Nt=N.useMemo(()=>({x:ee.x+at.x,y:ee.y+at.y}),[ee.x,ee.y,at.x,at.y]),Mt=N.useMemo(()=>H?.tint,[H?.tint]),Ne=N.useMemo(()=>TM(Mt,g),[Mt,g]),et=N.useMemo(()=>EM(Mt),[Mt?.opacity]),Wt=N.useMemo(()=>q0(Mt?.blendMode),[Mt?.blendMode]),Yt=!!(Ne&&et>0),_n=N.useMemo(()=>Yt?Math.min(.55,Math.max(.15,et*.9)):0,[Yt,et]),Pn=N.useCallback(_e=>wM({asset:_e,biomeThemeKey:g,biomeDebug:a,biomeThemePreset:S,wallsProfile:oe,wallsThemeOverride:F,crustTintBlendMode:Wt,crustTintColor:Ne,defaultMountainCrustBlendOpacity:_n}),[g,a,S?.assetOverrides,oe,F,Wt,Ne,_n]),jn=!!(re&&B!=="off"&&le>0||pe&&W!=="off"&&ue>0||Yt),Qi=!!(E&&w!=="off"||R&&$!=="off"||jn),_a=N.useMemo(()=>`biome-undercurrent-${n.floor}`,[n.floor]),Os=N.useMemo(()=>`biome-crust-${n.floor}`,[n.floor]),It=N.useMemo(()=>`biome-crust-mask-${n.floor}`,[n.floor]),wa=N.useMemo(()=>`biome-crust-detail-a-${n.floor}`,[n.floor]),Ns=N.useMemo(()=>`biome-crust-detail-b-${n.floor}`,[n.floor]),ks=!!(R&&$!=="off"||re&&B!=="off"&&le>0||pe&&W!=="off"&&ue>0||Yt),Yn=N.useMemo(()=>{const _e=[];for(const ht of e){const Bt=ce(ht),rt=l.get(Bt);if(!rt||!rt.isLava&&!rt.isFire)continue;const{x:fn,y:sn}=Ae(ht,X);_e.push({key:Bt,x:fn,y:sn})}return _e},[e,l]),Zi=N.useMemo(()=>{const _e=rg({isStairs:!0});return _e?u.get(_e):void 0},[u]),es=N.useMemo(()=>{const _e=rg({isShrine:!0});return _e?u.get(_e):void 0},[u]),Ma=N.useMemo(()=>{const _e=[];return n.stairsPosition&&_e.push({id:`stairs-${ce(n.stairsPosition)}`,kind:"stairs",position:n.stairsPosition,asset:Zi}),n.shrinePosition&&_e.push({id:`shrine-${ce(n.shrinePosition)}`,kind:"shrine",position:n.shrinePosition,asset:es}),_e},[n.stairsPosition,n.shrinePosition,Zi,es]),Ca=N.useMemo(()=>Mg(X+1),[]),Kn=N.useMemo(()=>Mg(X-2),[]),Lt=N.useMemo(()=>`biome-map-clip-${n.floor}`,[n.floor]),mt=N.useMemo(()=>({x:s.minX-X*2,y:s.minY-X*2,width:s.width+X*4,height:s.height+X*4}),[s.minX,s.minY,s.width,s.height]),pt=N.useMemo(()=>{const _e=Math.max(Math.abs(Number(k?.x??0)),Math.abs(Number(k?.y??0)),Math.abs(Number(ee?.x??0)),Math.abs(Number(ee?.y??0)),Math.abs(Number(ot?.x??0)),Math.abs(Number(ot?.y??0)),Math.abs(Number(Nt?.x??0)),Math.abs(Number(Nt?.y??0)));return Math.min(X*32,Math.max(X*8,Math.ceil(_e+X*6)))},[k?.x,k?.y,ee?.x,ee?.y,ot?.x,ot?.y,Nt?.x,Nt?.y]),Oa=N.useMemo(()=>({x:mt.x-pt,y:mt.y-pt,width:mt.width+pt*2,height:mt.height+pt*2}),[mt.x,mt.y,mt.width,mt.height,pt]);return{tileVisualFlags:l,assetById:u,deathDecalHref:f,manifestUnitToBoardScale:h,biomeThemeKey:g,biomeSeed:b,clutterLayer:_,wallsProfile:oe,wallsThemeOverride:F,boardProps:Ma,resolveMountainSettings:Pn,hybridInteractionLayerEnabled:Qi,backdropLayerProps:{biomeClipId:Lt,biomeClipPoints:Kn,maskHexPoints:Ca,biomeFrame:mt,biomeCoverFrame:Oa,undercurrentHref:E,undercurrentMode:w,undercurrentPatternId:_a,undercurrentScalePx:M,undercurrentOffset:k,undercurrentScroll:I,undercurrentOpacity:C,crustHref:R,crustMode:$,crustPatternId:Os,crustScalePx:j,crustPatternShift:ee,crustOpacity:D,crustDetailAHref:re,crustDetailAMode:B,crustDetailAPatternId:wa,crustDetailAScalePx:G,crustDetailAShift:ot,crustDetailAScroll:be,crustDetailAOpacity:le,crustDetailBHref:pe,crustDetailBMode:W,crustDetailBPatternId:Ns,crustDetailBScalePx:ae,crustDetailBShift:Nt,crustDetailBScroll:$e,crustDetailBOpacity:ue,crustMaskEnabled:ks,crustMaskId:It,crustMaskHoles:Yn,crustTintActive:Yt,crustTintColor:Ne,crustTintOpacity:et,crustTintBlendMode:Wt}}},CM=({gameState:e,playerPos:n,selectedSkillId:s,showMovementRange:o,hoveredTile:a,enginePreviewGhost:l})=>{const u=N.useMemo(()=>{const A={};for(const _ of e.visualEvents||[]){if(_.type!=="kinetic_trace")continue;const E=_.payload;E?.actorId&&(A[E.actorId]=E)}return A},[e.visualEvents]),f=N.useMemo(()=>{if(!o||s)return[];const A=["BASIC_MOVE","DASH"],_=new Set(e.player.activeSkills.map(M=>M.id)),E=new Set,w=[];for(const M of A){if(!_.has(M))continue;const C=st.get(M);if(!C?.getValidTargets)continue;const I=C.getValidTargets(e,n);for(const k of I){const R=ce(k);E.has(R)||(E.add(R),w.push(k))}}return w},[o,s,e,n]),p=N.useMemo(()=>{const A=new Set;for(const _ of f)A.add(ce(_));return A},[f]),h=N.useMemo(()=>e.player.activeSkills.some(A=>A.id==="BASIC_MOVE"||A.id==="DASH"),[e.player.activeSkills]),g=N.useMemo(()=>ce(e.stairsPosition),[e.stairsPosition]),b=N.useMemo(()=>e.shrinePosition?ce(e.shrinePosition):null,[e.shrinePosition]),S=N.useMemo(()=>{const A=[{q:n.q+1,r:n.r,s:n.s-1},{q:n.q+1,r:n.r-1,s:n.s},{q:n.q,r:n.r-1,s:n.s+1},{q:n.q-1,r:n.r,s:n.s+1},{q:n.q-1,r:n.r+1,s:n.s},{q:n.q,r:n.r+1,s:n.s-1}],_=new Set;for(const E of A)Yl(E.q,E.r,e.gridWidth,e.gridHeight)&&_.add(ce(E));return _},[n,e.gridWidth,e.gridHeight]),T=N.useMemo(()=>{const A=new Set;if(!s)return A;const _=st.get(s);if(!_?.getValidTargets)return A;const E=_.getValidTargets(e,n);for(const w of E)A.add(ce(w));return A},[s,e,n]),v=N.useMemo(()=>{if(l)return l;if(!a)return null;const A=ce(a);if(o&&!s)return p.has(A)||!h&&S.has(A)?{path:Ze(n,a),aoe:[],hasEnemy:!1,target:a}:null;if(!s)return null;const _=e.player.activeSkills.find(C=>C.id===s),E=g_(e,{actorId:e.player.id,skillId:s,target:a,activeUpgrades:_?.activeUpgrades||[]});if(!E.ok)return null;const w=new Map;for(const C of E.simulationEvents)C.position&&(C.type!=="DamageTaken"&&C.type!=="StatusApplied"&&C.type!=="UnitMoved"||w.set(ce(C.position),C.position));const M=E.simulationEvents.some(C=>(C.type==="DamageTaken"||C.type==="StatusApplied")&&!!C.targetId&&C.targetId!==e.player.id);return{path:Ze(n,a),aoe:[...w.values()],hasEnemy:M,target:a}},[l,a,o,s,p,h,S,e,n]);return{latestTraceByActor:u,movementTargetSet:p,hasPrimaryMovementSkills:h,stairsKey:g,shrineKey:b,fallbackNeighborSet:S,selectedSkillTargetSet:T,resolvedEnginePreviewGhost:v}},OM=({gameState:e,deathDecalHref:n,decals:s,setDecals:o,setEntityPoseEffects:a,setEntityPoseNowMs:l,onSimulationEvents:u})=>{const f=N.useRef(null),p=N.useRef(null),h=N.useRef(0),g=N.useRef(0),b=N.useCallback(T=>{if(!T)return null;const v=T.position||T.destination||T.origin||T.target;return v&&typeof v.q=="number"&&typeof v.r=="number"&&typeof v.s=="number"?v:null},[]);return N.useEffect(()=>{if(!n)return;const T=e.timelineEvents||[],v=e.visualEvents||[];if(f.current===T&&p.current===v)return;const A=f.current===T?[]:T;f.current=T;const _=p.current===v?[]:v;p.current=v;const E=[],w=Date.now();for(const M of A){if(M.phase!=="DEATH_RESOLVE")continue;const C=b(M.payload);C&&E.push({id:`decal-tl-${M.id}-${w}-${E.length}`,position:C,href:n,createdAt:w})}for(const M of _){if(M.type!=="vfx")continue;const C=M.payload?.type;if(C!=="vaporize"&&C!=="explosion_ring")continue;const I=b(M.payload);I&&E.push({id:`decal-vx-${C}-${w}-${E.length}`,position:I,href:n,createdAt:w})}E.length>0&&o(M=>[...M,...E].slice(-80))},[e.timelineEvents,e.visualEvents,n,b,o]),N.useEffect(()=>{const T=e.simulationEvents||[];T.length<h.current&&(h.current=0);const v=T.slice(h.current);h.current=T.length,v.length>0&&u?.(v)},[e.simulationEvents,u]),N.useEffect(()=>{const T=e.simulationEvents||[];T.length<g.current&&(g.current=0);const v=T.slice(g.current);if(g.current=T.length,v.length===0)return;const A=Date.now(),_=[e.player,...e.enemies,...e.companions||[],...e.dyingEntities||[]],E=new Map(_.map(C=>[C.id,C])),w=[],M=(C,I,k,R,$,j)=>{C&&w.push({id:`${I}:${C}:${$}`,actorId:C,startTime:$,endTime:$+Math.max(35,j),easing:"out",from:k,to:R})};for(const C of v){if(C.type!=="DamageTaken")continue;const I=String(C.targetId||""),k=I?E.get(I):void 0;if(!k)continue;const R=C.payload||{},$=String(R.reason||"").toLowerCase(),j=String(R.sourceId||"");if(!j||!$||$.includes("basic_attack"))continue;const D=E.get(j);if(!($.includes("spear")||$.includes("multi_shoot")||$.includes("withdrawal")||D?.subtype==="archer"&&!$.includes("crush")))continue;const se=D?Ae(D.position,X):void 0,ee=Ae(k.position,X);let oe=0,F=1;if(se){const Z=ee.x-se.x,re=ee.y-se.y,pe=Math.hypot(Z,re);pe>.001&&(oe=Z/pe,F=re/pe)}const H=D?.subtype==="archer"?10:8,z=100;M(k.id,"projectile-hit",{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:oe*H,offsetY:F*H,scaleX:1.02,scaleY:.95},A,z),M(k.id,"projectile-hit-return",{offsetX:oe*(H*.35),offsetY:F*(H*.35),scaleX:1.01,scaleY:.99},{offsetX:0,offsetY:0,scaleX:1,scaleY:1},A+Math.floor(z*.5),130)}w.length>0&&(l(A),a(C=>[...C,...w]))},[e.simulationEvents,e.player,e.enemies,e.companions,e.dyingEntities,a,l]),N.useEffect(()=>{if(s.length===0)return;const T=12e3,v=window.setTimeout(()=>{const A=Date.now();o(_=>_.filter(E=>A-E.createdAt<T))},1e3);return()=>window.clearTimeout(v)},[s,o]),{resetBoardEventEffects:N.useCallback(()=>{o([]),a([]),l(0),f.current=null,p.current=null,h.current=0,g.current=0},[o,a,l])}},gl=(e,n,s)=>e+(n-e)*s,NM=e=>1-Math.pow(1-e,3),kM=e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,RM=({gameState:e,assetById:n,entityPoseEffects:s,entityPoseNowMs:o,onMirrorSnapshot:a})=>{const l=N.useMemo(()=>{const p=new Map;p.set(e.player.id,e.player.position);for(const h of e.enemies)p.set(h.id,h.position);for(const h of e.companions||[])p.set(h.id,h.position);for(const h of e.dyingEntities||[])p.set(h.id,h.position);return p},[e.player.id,e.player.position,e.enemies,e.companions,e.dyingEntities]),u=N.useMemo(()=>[{id:e.player.id,position:e.player.position,subtype:e.player.subtype||"player",assetHref:n.get(Fi(e.player))?.path,fallbackAssetHref:As(e.player)},...e.enemies.map(p=>({id:p.id,position:p.position,subtype:p.subtype,assetHref:n.get(Fi(p))?.path,fallbackAssetHref:As(p)})),...(e.companions||[]).map(p=>({id:p.id,position:p.position,subtype:p.subtype,assetHref:n.get(Fi(p))?.path,fallbackAssetHref:As(p)})),...(e.dyingEntities||[]).map(p=>({id:p.id,position:p.position,subtype:p.subtype,assetHref:n.get(Fi(p))?.path,fallbackAssetHref:As(p)}))],[n,e.player,e.enemies,e.companions,e.dyingEntities]),f=N.useMemo(()=>{const p=new Map,h=o||Date.now();for(const g of s){if(h<g.startTime||h>g.endTime)continue;const b=Math.max(1,g.endTime-g.startTime),S=Math.max(0,Math.min(1,(h-g.startTime)/b)),T=g.easing==="inOut"?kM(S):NM(S),v={offsetX:gl(g.from.offsetX,g.to.offsetX,T),offsetY:gl(g.from.offsetY,g.to.offsetY,T),scaleX:gl(g.from.scaleX,g.to.scaleX,T),scaleY:gl(g.from.scaleY,g.to.scaleY,T)},A=p.get(g.actorId);if(!A){p.set(g.actorId,v);continue}p.set(g.actorId,{offsetX:(A.offsetX??0)+(v.offsetX??0),offsetY:(A.offsetY??0)+(v.offsetY??0),scaleX:(A.scaleX??1)*(v.scaleX??1),scaleY:(A.scaleY??1)*(v.scaleY??1)})}return p},[s,o]);return N.useEffect(()=>{if(!a)return;const p={turn:e.turnNumber||0,stackTick:e.stackTrace?.length||0,actors:[...l.entries()].map(([h,g])=>({id:h,position:{q:g.q,r:g.r,s:g.s}}))};a(p)},[a,e.turnNumber,e.stackTrace,l]),{actorPositionById:l,juiceActorSnapshots:u,entityVisualPoseById:f}},Vl=e=>{if(!e||typeof e.q!="number"||typeof e.r!="number"||typeof e.s!="number")return null;const{x:n,y:s}=Ae(e,X),o=Math.hypot(n,s);return!Number.isFinite(o)||o<=1e-4?null:{x:n/o,y:s/o}},bl=e=>{const n=e?.hex;if(n&&typeof n.q=="number"&&typeof n.r=="number"&&typeof n.s=="number")return n},Sl=e=>{const n=e?.world;if(n&&typeof n.x=="number"&&typeof n.y=="number")return n},IM=({gameState:e,visualEvents:n,nowMs:s})=>{const o=[],a=[e.player,...e.enemies,...e.companions||[],...e.dyingEntities||[]],l=new Map(a.map(p=>[p.id,p])),u=p=>{if(p){for(const h of a)if(Q(h.position,p))return h.id}},f=(p,h,g,b,S,T,v)=>{p&&o.push({id:`${h}:${p}:${S}`,actorId:p,startTime:S,endTime:S+Math.max(30,T),easing:v,from:g,to:b})};for(let p=0;p<n.length;p++){const h=n[p];if(h.type!=="juice_signature")continue;const g=h.payload;if(!g||g.protocol!=="juice-signature/v1"||g.signature!=="ATK.STRIKE.PHYSICAL.BASIC_ATTACK"&&g.signature!=="ATK.STRIKE.PHYSICAL.AUTO_ATTACK")continue;const b=String(g.phase||"impact"),S=bl(g.source),T=bl(g.target),v=String(g.meta?.sourceId||g.source?.actorId||"")||u(S),A=g.target?.actorId||u(T);if(!S||!T||!v)continue;const _=Ae(S,X),E=Ae(T,X),w=Sl(g.contact)||E;let M=w.x-_.x,C=w.y-_.y,I=Math.hypot(M,C);if(!Number.isFinite(I)||I<.001){const re=Vl(g.direction);if(re)M=re.x,C=re.y,I=1;else{const pe=Ae(T,X);M=pe.x-_.x,C=pe.y-_.y,I=Math.max(1,Math.hypot(M,C))}}const k=M/Math.max(1,I),R=C/Math.max(1,I),$=Math.max(0,Number(g.timing?.delayMs||0)),j=Math.max(40,Number(g.timing?.durationMs||g.timing?.ttlMs||110)),D=s+$,q=String(g.meta?.sequenceId||`strike-${s}-${p}`),se=String(g.intensity||"medium"),ee=g.signature==="ATK.STRIKE.PHYSICAL.AUTO_ATTACK",oe=se==="extreme"?16:se==="high"?13:se==="low"?8:11,F=Math.min(X*(ee?.3:.46),I*(ee?.22:.32)),H=Math.min(X*(ee?.55:.82),I*(ee?.62:.9)),z=Math.min(X*(ee?.62:.9),I*(ee?.72:.98)),Z=Math.min(X*(ee?.22:.34),I*(ee?.24:.36));if(b==="anticipation"){f(v,`${q}:anticipation`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:-k*F,offsetY:-R*F,scaleX:.92,scaleY:1.08},D,j,"out");continue}if(b==="travel"){f(v,`${q}:travel`,{offsetX:-k*F,offsetY:-R*F,scaleX:.94,scaleY:1.06},{offsetX:k*H,offsetY:R*H,scaleX:1.09,scaleY:.93},D,j,"inOut");continue}if(b==="impact"){f(v,`${q}:impact-src`,{offsetX:k*(z*.92),offsetY:R*(z*.92),scaleX:1.06,scaleY:.95},{offsetX:k*z,offsetY:R*z,scaleX:1.02,scaleY:.98},D,j,"out"),f(A,`${q}:impact-tgt`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:k*oe,offsetY:R*oe,scaleX:1.03,scaleY:.94},D,j,"out");continue}b==="aftermath"&&(f(v,`${q}:after-src`,{offsetX:k*Z,offsetY:R*Z,scaleX:1.01,scaleY:.99},{offsetX:0,offsetY:0,scaleX:1,scaleY:1},D,j,"out"),f(A,`${q}:after-tgt`,{offsetX:k*(oe*.35),offsetY:R*(oe*.35),scaleX:1.01,scaleY:.99},{offsetX:0,offsetY:0,scaleX:1,scaleY:1},D,j,"out"))}for(let p=0;p<n.length;p++){const h=n[p];if(h.type!=="juice_signature")continue;const g=h.payload;if(!g||g.protocol!=="juice-signature/v1")continue;const b=String(g.signature||"");if(String(g.phase||"impact")!=="impact")continue;const T=Math.max(0,Number(g.timing?.delayMs||0)),v=Math.max(45,Number(g.timing?.durationMs||g.timing?.ttlMs||110)),A=s+T,_=bl(g.source),E=bl(g.target),w=Sl(g.source),M=Sl(g.target),C=Sl(g.contact),I=String(g.meta?.sourceId||g.source?.actorId||""),R=(I?l.get(I):void 0)?.id||u(_),$=g.target?.actorId||u(E),D=(()=>{const q=Vl(g.direction);if(q)return q;const se=_?Ae(_,X):w,ee=C||M||(E?Ae(E,X):void 0);if(se&&ee){const oe=ee.x-se.x,F=ee.y-se.y,H=Math.hypot(oe,F);if(H>.001)return{x:oe/H,y:F/H}}return null})();if(D){if(b==="ATK.PULSE.KINETIC.WAVE"){f(R,`${g.meta?.sequenceId||b}:pulse-caster`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:-D.x*8,offsetY:-D.y*8,scaleX:.96,scaleY:1.05},A,Math.max(40,Math.floor(v*.5)),"out"),f(R,`${g.meta?.sequenceId||b}:pulse-caster-return`,{offsetX:-D.x*(8*.6),offsetY:-D.y*(8*.6),scaleX:.98,scaleY:1.02},{offsetX:0,offsetY:0,scaleX:1,scaleY:1},A+Math.floor(v*.45),Math.max(50,Math.floor(v*.65)),"out"),f($,`${g.meta?.sequenceId||b}:pulse-target`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:D.x*10,offsetY:D.y*10,scaleX:1.03,scaleY:.95},A,v,"out");continue}if(b.startsWith("ENV.COLLISION.KINETIC.")){const q=b==="ENV.COLLISION.KINETIC.SHIELD_BASH"?14:10,se=b==="ENV.COLLISION.KINETIC.SHIELD_BASH"?7:0;se>0&&f(R,`${g.meta?.sequenceId||b}:collision-source`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:D.x*se,offsetY:D.y*se,scaleX:1.03,scaleY:.97},A,Math.max(45,Math.floor(v*.55)),"out"),f($,`${g.meta?.sequenceId||b}:collision-target`,{offsetX:0,offsetY:0,scaleX:1,scaleY:1},{offsetX:D.x*q,offsetY:D.y*q,scaleX:1.02,scaleY:.92},A,v,"out");continue}}}return o},Id={low:110,medium:160,high:210,extreme:260},Cg={light:6,medium:10,heavy:14},Og={light:65,medium:85,heavy:110},LM=e=>{let n=0,s=0,o=0,a={x:0,y:0},l=0;const u=[];for(const f of e){if(f.type==="juice_signature"){const p=f.payload;if(p?.protocol==="juice-signature/v1"){const h=Math.max(0,Number(p.timing?.delayMs||0)),g=p.camera?.shake,b=Number(p.camera?.freezeMs||0),S=String(p.camera?.kick||"none"),T=S!=="none"?Vl(p.direction):null,v=Cg[S]||0,A=Og[S]||80;if(h>0&&(g||b>0||T&&v>0)){u.push({delayMs:h,shakeDurationMs:g?Id[String(g)]||160:0,freezeDurationMs:b>0?Math.min(220,b):0,kickDurationMs:T&&v>0?A:0,kickOffset:T&&v>0?{x:T.x*v,y:T.y*v}:{x:0,y:0}});continue}if(g&&(n=Math.max(n,Id[String(g)]||160)),b>0&&(s=Math.max(s,Math.min(220,b))),S!=="none"){const _=Vl(p.direction),E=Cg[S]||0;_&&E>0&&E>=l&&(l=E,a={x:_.x*E,y:_.y*E},o=Math.max(o,Og[S]||80))}continue}}if(f.type==="shake"){const p=String(f.payload?.intensity||"medium");n=Math.max(n,Id[p]||160)}else f.type==="freeze"&&(s=Math.max(s,Math.min(220,Math.max(50,Number(f.payload?.durationMs||80)))))}return{shakeDurationMs:n,freezeDurationMs:s,kickDurationMs:o,kickOffset:a,deferredCues:u}},BM=({gameState:e})=>{const[n,s]=N.useState(!1),[o,a]=N.useState(!1),[l,u]=N.useState({x:0,y:0}),[f,p]=N.useState(!1),[h,g]=N.useState([]),[b,S]=N.useState([]),[T,v]=N.useState(0),A=N.useRef(null),_=N.useRef(null),E=N.useRef(null),w=N.useRef(null);N.useRef(!1),N.useEffect(()=>{},[]),N.useEffect(()=>{const C=e.visualEvents||[];if(E.current===C)return;E.current=C;const I=C;if(I.length===0)return;const k=Date.now(),R=IM({gameState:e,visualEvents:I,nowMs:k});R.length>0&&(v(k),S($=>[...$,...R]))},[e.visualEvents,e.player,e.enemies,e.companions,e.dyingEntities]),N.useEffect(()=>{if(typeof window>"u"||b.length===0)return;let C=!1;const I=()=>{if(C)return;const k=Date.now();v(k),S(R=>{const $=R.filter(j=>k<j.endTime+16);return $.length===R.length?R:$}),w.current=window.requestAnimationFrame(I)};return w.current=window.requestAnimationFrame(I),()=>{C=!0,w.current!==null&&(window.cancelAnimationFrame(w.current),w.current=null)}},[b.length]),N.useEffect(()=>{const C=e.visualEvents||[];if(A.current===C)return;A.current=C;const I=C;if(I.length===0)return;const k=LM(I),R=[],$=q=>{q<=0||(s(!0),R.push(window.setTimeout(()=>s(!1),q)))},j=q=>{q<=0||(a(!0),R.push(window.setTimeout(()=>a(!1),q)))},D=(q,se)=>{se<=0||!q.x&&!q.y||(u(q),R.push(window.setTimeout(()=>u({x:0,y:0}),se)))};for(const q of k.deferredCues)R.push(window.setTimeout(()=>{q.shakeDurationMs>0&&$(q.shakeDurationMs),q.freezeDurationMs>0&&j(q.freezeDurationMs),q.kickDurationMs>0&&D(q.kickOffset,q.kickDurationMs)},q.delayMs));return k.shakeDurationMs>0&&$(k.shakeDurationMs),k.freezeDurationMs>0&&j(k.freezeDurationMs),k.kickDurationMs>0&&(k.kickOffset.x!==0||k.kickOffset.y!==0)&&D(k.kickOffset,k.kickDurationMs),()=>{for(const q of R)window.clearTimeout(q)}},[e.visualEvents]),N.useEffect(()=>{},[e.visualEvents,f]);const M=N.useCallback(()=>{g([]),s(!1),a(!1),u({x:0,y:0}),S([]),v(0),A.current=null,_.current=null,E.current=null,w.current!==null&&(window.cancelAnimationFrame(w.current),w.current=null)},[]);return{isShaking:n,isFrozen:o,cameraKickOffsetPx:l,juiceDebugOverlayEnabled:f,juiceDebugEntries:h,entityPoseEffects:b,entityPoseNowMs:T,setEntityPoseEffects:S,setEntityPoseNowMs:v,resetBoardJuicePresentation:M}},HM=({visualEvents:e,turnNumber:n,actorPositionById:s,svgRef:o,cancelCameraAnimation:a})=>{const[l,u]=N.useState(!1),f=N.useRef([]),p=N.useRef(!1),h=N.useRef([]),g=N.useRef(0),b=N.useRef(""),S=N.useMemo(()=>(e||[]).filter(w=>w.type==="kinetic_trace").map(w=>w.payload).filter(w=>{if(!w?.actorId||!w.origin||!w.destination)return!1;const M=s.get(w.actorId);return!!M&&ce(M)===ce(w.destination)}),[e,s]),T=N.useMemo(()=>{if(!S.length)return"";const w=n??0,M=S.map(C=>{const I=(C.path||[]).map(k=>`${k.q},${k.r},${k.s}`).join(">");return[C.actorId,`${C.origin.q},${C.origin.r},${C.origin.s}`,`${C.destination.q},${C.destination.r},${C.destination.s}`,C.movementType||"slide",C.startDelayMs||0,C.durationMs||0,I].join("|")}).join("||");return`${w}::${M}`},[S,n]),v=N.useCallback(async(w,M,C,I)=>{if(I!==g.current)return;const k=w.animate(M,{...C,fill:C.fill??"forwards"});h.current.push(k);try{await k.finished}catch{}finally{h.current=h.current.filter(R=>R!==k)}},[]),A=N.useCallback(async(w,M,C)=>{if(M!==g.current)return;const I=.76,k=o.current?.querySelector(`[data-actor-node="${w.actorId}"]`),R=Z=>{const re=Ae(Z,X);return`translate(${re.x}px, ${re.y}px)`},$=Math.max(0,w.startDelayMs||0),j=Math.max(0,performance.now()-C),D=Math.round($*I),q=Math.max(0,D-j),se=w.path&&w.path.length>1?w.path:[w.origin,w.destination],ee=Math.max(1,se.length-1),oe=Math.max(90,Math.round((w.durationMs||ee*110)*I));if(!k){const Z=Math.max(0,q+oe);Z>0&&await new Promise(re=>window.setTimeout(re,Z));return}if(q>0&&(await new Promise(Z=>window.setTimeout(Z,q)),M!==g.current))return;if((w.movementType||"slide")==="teleport"){const Z=Math.max(100,Math.round((w.durationMs||180)*I));await v(k,[{transform:R(w.origin),opacity:1,offset:0},{transform:R(w.origin),opacity:0,offset:.45},{transform:R(w.destination),opacity:0,offset:.55},{transform:R(w.destination),opacity:1,offset:1}],{duration:Z,easing:"linear"},M),M===g.current&&(k.style.transform=R(w.destination),k.style.opacity="1");return}const F=[...se],H=F[F.length-1];(!H||H.q!==w.destination.q||H.r!==w.destination.r||H.s!==w.destination.s)&&F.push(w.destination);const z=F.map((Z,re)=>({transform:R(Z),offset:F.length===1?1:re/(F.length-1)}));z[z.length-1]={...z[z.length-1],transform:R(w.destination),offset:1},await v(k,z,{duration:oe,easing:"linear"},M),M===g.current&&(k.style.transform=R(w.destination),k.style.opacity="1")},[v,o]),_=N.useCallback(async()=>{if(p.current)return;p.current=!0,u(!0);const w=++g.current,M=performance.now();try{for(;f.current.length>0&&w===g.current;){const C=f.current.shift();C&&await A(C,w,M)}}finally{w===g.current&&(p.current=!1,u(!1))}},[A]);N.useEffect(()=>{if(!T){b.current="";return}T!==b.current&&(b.current=T,f.current.push(...S),_())},[T,S,_]);const E=N.useCallback((w=!0)=>{g.current++,f.current=[],p.current=!1,h.current.forEach(M=>{try{M.cancel()}catch{}}),h.current=[],u(!1),w&&(b.current="")},[]);return N.useEffect(()=>()=>{a(),E(!1)},[a,E]),{movementBusy:l,resetMovementPlayback:E}},PM=e=>{const n=[];for(let s=0;s<6;s++){const o=Math.PI/180*(60*s);n.push(`${e*Math.cos(o)},${e*Math.sin(o)}`)}return n.join(" ")},V0=({gameState:e,onMove:n,selectedSkillId:s,showMovementRange:o,onBusyStateChange:a,assetManifest:l,biomeDebug:u,onSimulationEvents:f,onMirrorSnapshot:p,enginePreviewGhost:h,cameraSafeInsetsPx:g})=>{const[b,S]=N.useState(null),[T,v]=N.useState(!1),[A,_]=N.useState([]),E=e.player.position,w=N.useMemo(()=>{let Gt=e.rooms?.[0]?.hexes;if(!Gt||Gt.length===0){Gt=[];for(let Ht=0;Ht<e.gridWidth;Ht++)for(let wn=0;wn<e.gridHeight;wn++)Gt.push({q:Ht,r:wn,s:-Ht-wn})}return Gt.filter(Ht=>Yl(Ht.q,Ht.r,e.gridWidth,e.gridHeight))},[e.rooms,e.gridWidth,e.gridHeight]),{isShaking:M,isFrozen:C,cameraKickOffsetPx:I,entityPoseEffects:k,entityPoseNowMs:R,setEntityPoseEffects:$,setEntityPoseNowMs:j,resetBoardJuicePresentation:D}=BM({gameState:e}),q=N.useMemo(()=>{if(w.length===0)return{minX:0,minY:0,width:100,height:100};let Gt=1/0,Ht=1/0,wn=-1/0,Is=-1/0;return w.forEach(ka=>{const{x:Ls,y:Ra}=Ae(ka,X);Gt=Math.min(Gt,Ls-X),Ht=Math.min(Ht,Ra-X),wn=Math.max(wn,Ls+X),Is=Math.max(Is,Ra+X)}),{minX:Gt,minY:Ht,width:wn-Gt,height:Is-Ht}},[w]),se=N.useMemo(()=>{const{x:Gt,y:Ht}=Ae(E,X);return{x:Gt,y:Ht}},[E]),ee=N.useMemo(()=>({x:q.minX,y:q.minY,width:q.width,height:q.height}),[q.minX,q.minY,q.width,q.height]),{svgRef:oe,boardViewportRef:F,zoomPreset:H,isCameraPanning:z,setIsCameraPanning:Z,cameraPanOffsetRef:re,isCameraPanningRef:pe,isPinchingRef:B,suppressTileClickUntilRef:W,activePointersRef:G,dragStateRef:ae,pinchStateRef:le,cancelCameraAnimation:ue,animateCameraToTarget:be,updatePanFromWorldDelta:$e,setZoomPresetAnimated:Ee,renderedViewBox:at}=uM({baseViewBox:ee,playerWorld:se,playerPosition:E,floor:e.floor,cameraSafeInsetsPx:g}),{latestTraceByActor:ot,movementTargetSet:Nt,hasPrimaryMovementSkills:Mt,stairsKey:Ne,shrineKey:et,fallbackNeighborSet:Wt,selectedSkillTargetSet:Yt,resolvedEnginePreviewGhost:_n}=CM({gameState:e,playerPos:E,selectedSkillId:s,showMovementRange:o,hoveredTile:b,enginePreviewGhost:h}),{tileVisualFlags:Pn,assetById:jn,deathDecalHref:Qi,manifestUnitToBoardScale:_a,biomeThemeKey:Os,biomeSeed:It,clutterLayer:wa,wallsProfile:Ns,wallsThemeOverride:ks,boardProps:Yn,resolveMountainSettings:Zi,hybridInteractionLayerEnabled:es,backdropLayerProps:Ma}=MM({cells:w,gameState:e,bounds:q,assetManifest:l,biomeDebug:u}),{mountainSettingsByAssetId:Ca,depthSortedSprites:Kn,mountainCoveredWallKeys:Lt}=mM({assetManifest:l,biomeThemeKey:Os,biomeSeed:It,mountainAssetPathOverride:u?.mountainAssetPath,wallsMountainPath:Ns?.mountainPath,wallsThemeMountainPath:ks?.mountainPath,clutterLayer:wa,cells:w,tileVisualFlags:Pn,boardProps:Yn,resolveMountainSettings:Zi}),{resetBoardEventEffects:mt}=OM({gameState:e,deathDecalHref:Qi,decals:A,setDecals:_,setEntityPoseEffects:$,setEntityPoseNowMs:j,onSimulationEvents:f}),{handleResetView:pt,handleTileClick:Oa,handleHoverTile:_e,handleBoardPointerDown:ht,handleBoardPointerMove:Bt,handleBoardPointerUp:rt,handleBoardPointerCancel:fn,handleBoardWheel:sn}=eM({svgRef:oe,onMove:n,zoomPreset:H,setHoveredTile:S,setIsCameraPanning:Z,cameraPanOffsetRef:re,isCameraPanningRef:pe,isPinchingRef:B,suppressTileClickUntilRef:W,activePointersRef:G,dragStateRef:ae,pinchStateRef:le,animateCameraToTarget:be,updatePanFromWorldDelta:$e,setZoomPresetAnimated:Ee}),{actorPositionById:yi,juiceActorSnapshots:ts,entityVisualPoseById:Jl}=RM({gameState:e,assetById:jn,entityPoseEffects:k,entityPoseNowMs:R,onMirrorSnapshot:p}),{movementBusy:Na,resetMovementPlayback:Rs}=HM({visualEvents:e.visualEvents,turnNumber:e.turnNumber,actorPositionById:yi,svgRef:oe,cancelCameraAnimation:ue});N.useEffect(()=>{a?.(Na||T)},[Na,T,a]),N.useLayoutEffect(()=>{ue(),Rs(),mt(),D()},[e.floor,ue,Rs,mt,D]);const ns=N.useMemo(()=>PM(X-1),[]);return y.jsxs("div",{ref:F,className:`relative w-full h-full flex justify-center items-center overflow-hidden transition-transform duration-75 ${M?"animate-shake":""} ${z?"cursor-grabbing":""}`,children:[y.jsxs("div",{className:"relative w-full h-full",style:{transform:`translate3d(${I.x}px, ${I.y}px, 0)`,transition:"transform 85ms ease-out",willChange:I.x||I.y?"transform":void 0},children:[C&&y.jsx("div",{className:"absolute inset-0 z-20 pointer-events-none bg-white/10",style:{boxShadow:"inset 0 0 60px rgba(255,255,255,0.18)",animation:"flash 120ms ease-out"}}),y.jsx(Zw,{svgRef:oe,renderedViewBox:at,cells:w,gameState:e,selectedSkillId:s,showMovementRange:o,hoveredTile:b,resolvedEnginePreviewGhost:_n,tileVisualFlags:Pn,movementTargetSet:Nt,hasPrimaryMovementSkills:Mt,fallbackNeighborSet:Wt,selectedSkillTargetSet:Yt,stairsKey:Ne,shrineKey:et,mountainCoveredWallKeys:Lt,hybridInteractionLayerEnabled:es,assetById:jn,decals:A,depthSortedSprites:Kn,boardProps:Yn,manifestUnitToBoardScale:_a,mountainSettingsByAssetId:Ca,resolveMountainSettings:Zi,latestTraceByActor:ot,entityVisualPoseById:Jl,biomeThemeKey:Os,juiceActorSnapshots:ts,assetManifest:l,backdropLayerProps:Ma,gridPoints:ns,onTileClick:Oa,onTileHover:_e,onMouseLeave:()=>S(null),onWheel:sn,onPointerDown:ht,onPointerMove:Bt,onPointerUp:rt,onPointerCancel:fn,onJuiceBusyStateChange:v})]}),!1,y.jsx(I_,{presets:tM,activePreset:H,onSelectPreset:Ee,onResetView:pt})]})},jM=({theme:e,previewState:n,previewManifest:s})=>y.jsxs("main",{className:"flex-1 relative bg-[#050914] overflow-hidden",children:[y.jsxs("div",{className:"absolute top-4 right-5 z-20 px-3 py-2 rounded-lg border border-white/15 bg-black/35 text-[10px] font-black uppercase tracking-[0.2em]",children:["Theme: ",e]}),y.jsx("div",{className:"w-full h-full p-6",children:y.jsx("div",{className:"w-full h-full rounded-[28px] border border-white/10 bg-[#030712]/70 overflow-hidden",children:y.jsx(V0,{gameState:n,onMove:()=>{},selectedSkillId:null,showMovementRange:!1,assetManifest:s})})})]}),Ng="/Hop",DM=64,UM=192,kg=64,Rg=512,lt=(e,n,s)=>Math.min(s,Math.max(n,e)),Ig=(e,n)=>`${e.endsWith("/")?e:`${e}/`}${n.replace(/^\/+/,"")}`,ko=e=>{const n=e.trim();return!n||/^(?:[a-z]+:)?\/\//i.test(n)||n.startsWith("data:")?n:n.startsWith("/")?n.startsWith("/assets/")?Ig(Ng,n.slice(1)):n:Ig(Ng,n)},Lg=(e,n="#8b6f4a")=>{const s=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(s))return s.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(s)){const[l,u,f]=s.slice(1).split("");return`#${l}${l}${u}${u}${f}${f}`.toLowerCase()}return n},Y0=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",vl=e=>e==="off"?"off":Y0(e),$M=(e,n,s)=>{if(!e||!n)return null;const o=ko(n.undercurrent.path),a=ko(n.crust.path),l=ko(n.materials.detailA.path),u=ko(n.materials.detailB.path),f=df(e,s),p=f?.biomeLayers?.undercurrent??e.biomeLayers?.undercurrent,h=f?.biomeLayers?.crust??e.biomeLayers?.crust??(e.biomeUnderlay?{default:e.biomeUnderlay.default,themes:e.biomeUnderlay.themes,mode:e.biomeUnderlay.mode,scalePx:e.biomeUnderlay.scalePx,opacity:e.biomeUnderlay.opacity}:void 0),g=f?.biomeMaterials?.crust??e.biomeMaterials?.crust,b=p||o?{...p||{default:o||a||""},default:o||p?.default||"",themes:{...p?.themes||{},[s]:o||p?.default||""},mode:n.undercurrent.mode,scalePx:lt(n.undercurrent.scalePx,DM,UM),opacity:lt(n.undercurrent.opacity,0,1),offsetX:n.undercurrent.offsetX,offsetY:n.undercurrent.offsetY,scroll:{x:n.undercurrent.scrollX,y:n.undercurrent.scrollY,durationMs:Math.max(1e3,n.undercurrent.scrollDurationMs)}}:void 0,S=h||a?{...h||{default:a||o||""},default:a||h?.default||"",themes:{...h?.themes||{},[s]:a||h?.default||""},mode:n.crust.mode,scalePx:Math.max(64,n.crust.scalePx),opacity:1,seedShiftPx:Math.max(0,n.crust.seedShiftPx),offsetX:n.crust.offsetX,offsetY:n.crust.offsetY}:void 0,T=l||g?.detailA?.default||"",v={...g?.detailA?.themes||{}};T&&(v[s]=T);const A=T?{...g?.detailA||{default:T},default:T,themes:v,mode:n.materials.detailA.mode,scalePx:lt(n.materials.detailA.scalePx,kg,Rg),opacity:lt(n.materials.detailA.opacity,0,1)}:void 0,_=u||g?.detailB?.default||"",E={...g?.detailB?.themes||{}};_&&(E[s]=_);const w=_?{...g?.detailB||{default:_},default:_,themes:E,mode:n.materials.detailB.mode,scalePx:lt(n.materials.detailB.scalePx,kg,Rg),opacity:lt(n.materials.detailB.opacity,0,1)}:void 0,M=String(n.materials.tintColor||"").trim()||g?.tint?.default||"#8b6f4a",C={...g?.tint?.themes||{}};C[s]=M;const I={...g?.tint||{default:M},default:M,themes:C,opacity:lt(n.materials.tintOpacity,0,1),blendMode:Y0(n.materials.tintBlend)},k=A||w||I?{...g||{},detailA:A,detailB:w,tint:I}:void 0,R=ko(n.walls.mountainPath),$=f?.walls,j={...$||e.walls?.themes?.[s]||{},mountainPath:R,scale:lt(n.walls.mountainScale,.2,3),offsetX:n.walls.mountainOffsetX,offsetY:n.walls.mountainOffsetY,anchorX:lt(n.walls.mountainAnchorX,0,1),anchorY:lt(n.walls.mountainAnchorY,0,1),crustBlendMode:vl(n.walls.mountainCrustBlendMode),crustBlendOpacity:lt(n.walls.mountainCrustBlendOpacity,0,1),tintColor:Lg(n.walls.mountainTintColor,"#7d7d7d"),tintBlendMode:vl(n.walls.mountainTintBlendMode),tintOpacity:lt(n.walls.mountainTintOpacity,0,1),mountainScale:lt(n.walls.mountainScale,.2,3),mountainOffsetX:n.walls.mountainOffsetX,mountainOffsetY:n.walls.mountainOffsetY,mountainAnchorX:lt(n.walls.mountainAnchorX,0,1),mountainAnchorY:lt(n.walls.mountainAnchorY,0,1),mountainCrustBlendMode:vl(n.walls.mountainCrustBlendMode),mountainCrustBlendOpacity:lt(n.walls.mountainCrustBlendOpacity,0,1),mountainTintColor:Lg(n.walls.mountainTintColor,"#7d7d7d"),mountainTintBlendMode:vl(n.walls.mountainTintBlendMode),mountainTintOpacity:lt(n.walls.mountainTintOpacity,0,1)},D={...e.walls||{},...$||{},mode:n.walls.mode,interiorDensity:lt(n.walls.interiorDensity,0,.45),clusterBias:lt(n.walls.clusterBias,0,1),keepPerimeter:!!n.walls.keepPerimeter,mountainPath:R,scale:j.scale,offsetX:j.offsetX,offsetY:j.offsetY,anchorX:j.anchorX,anchorY:j.anchorY,crustBlendMode:j.crustBlendMode,crustBlendOpacity:j.crustBlendOpacity,tintColor:j.tintColor,tintBlendMode:j.tintBlendMode,tintOpacity:j.tintOpacity,mountainScale:j.mountainScale,mountainOffsetX:j.mountainOffsetX,mountainOffsetY:j.mountainOffsetY,mountainAnchorX:j.mountainAnchorX,mountainAnchorY:j.mountainAnchorY,mountainCrustBlendMode:j.mountainCrustBlendMode,mountainCrustBlendOpacity:j.mountainCrustBlendOpacity,mountainTintColor:j.mountainTintColor,mountainTintBlendMode:j.mountainTintBlendMode,mountainTintOpacity:j.mountainTintOpacity,themes:{...e.walls?.themes||{},[s]:j}},q={...f?.biomeLayers||{},undercurrent:b,crust:S,clutter:{...f?.biomeLayers?.clutter||e.biomeLayers?.clutter||{},density:lt(n.clutter.density,0,1),maxPerHex:Math.max(0,Math.floor(n.clutter.maxPerHex)),bleedScaleMax:lt(n.clutter.bleedScaleMax,1,2)}},se={...f?.biomeMaterials||{},crust:k},ee={...f||{},seed:n.seed.trim()||"biome-sandbox-seed",injectHazards:n.injectHazards,biomeLayers:q,biomeMaterials:se,walls:D};return{...e,biomeLayers:{...e.biomeLayers||{},undercurrent:b,crust:S,clutter:{...e.biomeLayers?.clutter||{},density:lt(n.clutter.density,0,1),maxPerHex:Math.max(0,Math.floor(n.clutter.maxPerHex)),bleedScaleMax:lt(n.clutter.bleedScaleMax,1,2)}},biomeMaterials:{...e.biomeMaterials||{},crust:k},walls:D,biomePresets:{...e.biomePresets||{},[s]:ee}}},qM=e=>N.useMemo(()=>{const n=new Set,s=new Set,o=new Set,a=new Set;if(!e)return{undercurrent:[],crust:[],detail:[],mountain:[]};const l=u=>{if(u){u.default&&(n.add(u.default),s.add(u.default),o.add(u.default));for(const f of Object.values(u.themes||{}))n.add(f),s.add(f),o.add(f)}};l(e.biomeLayers?.undercurrent),l(e.biomeLayers?.crust);for(const u of Object.values(e.biomePresets||{}))l(u?.biomeLayers?.undercurrent),l(u?.biomeLayers?.crust),u?.biomeMaterials?.crust?.detailA&&l(u.biomeMaterials.crust.detailA),u?.biomeMaterials?.crust?.detailB&&l(u.biomeMaterials.crust.detailB);if(e.biomeUnderlay){e.biomeUnderlay.default&&s.add(e.biomeUnderlay.default);for(const u of Object.values(e.biomeUnderlay.themes||{}))s.add(u)}e.biomeMaterials?.crust?.detailA&&l(e.biomeMaterials.crust.detailA),e.biomeMaterials?.crust?.detailB&&l(e.biomeMaterials.crust.detailB);for(const u of e.assets||[]){const f=new Set((u.tags||[]).map(h=>h.toLowerCase())),p=u.type==="prop"&&(u.id.toLowerCase().includes("mountain")||f.has("mountain"));(f.has("floor")||f.has("stone")||f.has("void")||f.has("frozen")||f.has("inferno"))&&(s.add(u.path),o.add(u.path)),(f.has("lava")||f.has("hazard")||f.has("fire")||f.has("quicksand"))&&n.add(u.path),(u.type==="decal"||u.type==="prop"||u.type==="tile")&&o.add(u.path),p&&a.add(u.path)}e.walls?.mountainPath&&a.add(e.walls.mountainPath);for(const u of Object.values(e.walls?.themes||{}))u?.mountainPath&&a.add(u.mountainPath);for(const u of Object.values(e.biomePresets||{})){u?.walls?.mountainPath&&a.add(u.walls.mountainPath);for(const f of Object.values(u?.walls?.themes||{}))f?.mountainPath&&a.add(f.mountainPath)}return{undercurrent:Array.from(n).sort((u,f)=>u.localeCompare(f)),crust:Array.from(s).sort((u,f)=>u.localeCompare(f)),detail:Array.from(o).sort((u,f)=>u.localeCompare(f)),mountain:Array.from(a).sort((u,f)=>u.localeCompare(f))}},[e]),zM=[{q:1,r:0,s:-1},{q:0,r:1,s:-1},{q:-1,r:1,s:0},{q:-1,r:0,s:1},{q:0,r:-1,s:1},{q:1,r:-1,s:0}],VM=e=>{let n=2166136261;for(let s=0;s<e.length;s++)n^=e.charCodeAt(s),n=Math.imul(n,16777619);return n>>>0},Bg=e=>VM(e)/4294967295,K0=e=>e.has("BLOCKS_MOVEMENT")&&e.has("BLOCKS_LOS"),YM=e=>e.has("LAVA")||e.has("FIRE")||e.has("HAZARDOUS")&&e.has("LIQUID"),ff=e=>zM.map(n=>ce({q:e.q+n.q,r:e.r+n.r,s:e.s+n.s})),KM=e=>{const n=new Set;for(const[s,o]of e.entries())ff(o.position).some(l=>!e.has(l))&&n.add(s);return n},FM=(e,n,s)=>{const o=new Set,a=[{point:n,depth:0}];for(;a.length>0;){const l=a.shift(),u=ce(l.point);if(!o.has(u)&&e.has(u)&&(o.add(u),!(l.depth>=s)))for(const f of ff(l.point)){const p=e.get(f);p&&a.push({point:p.position,depth:l.depth+1})}}return o},Ld=(e,n,s)=>{const o=e.get(n);if(!o)return;const a=new Set(Array.from(o.traits));s?(a.add("BLOCKS_MOVEMENT"),a.add("BLOCKS_LOS"),a.delete("LAVA"),a.delete("FIRE"),a.delete("LIQUID"),a.delete("HAZARDOUS")):(a.delete("BLOCKS_MOVEMENT"),a.delete("BLOCKS_LOS")),e.set(n,{...o,traits:a})},WM=e=>{const n=new Map;for(const[s,o]of e.tiles.entries())n.set(s,{...o,traits:new Set(o.traits),effects:Array.isArray(o.effects)?[...o.effects]:[]});return n},GM=(e,n)=>{const s=(l,u,f)=>{const h=ce({q:l,r:u}),g=e.get(h);if(!g)return;const b=new Set(Array.from(g.traits));if(!K0(b)){for(const S of f)b.add(S);e.set(h,{...g,traits:b})}},o=[[0,0],[1,0],[0,1],[-1,1],[-1,0],[0,-1],[1,-1],[2,-1],[2,0],[1,1],[-2,1],[-2,0],[-1,-1]];for(const[l,u]of o)s(n.q+l,n.r+u,["HAZARDOUS","LIQUID","LAVA"]);const a=[[3,-1],[3,0],[2,1],[-3,1],[-3,0],[-2,-1]];for(const[l,u]of a)s(n.q+l,n.r+u,["HAZARDOUS","FIRE"])},XM=(e,n,s,o)=>{const a=o.mode,l=KM(e),u=FM(e,s,2),f=Array.from(e.keys()).sort((T,v)=>T.localeCompare(v));if(a==="custom")for(const T of f){if(u.has(T)){Ld(e,T,!1);continue}const v=o.keepPerimeter&&l.has(T);Ld(e,T,v)}if(a==="native")return;const p=xe(Number(o.interiorDensity||0),0,.45),h=xe(Number(o.clusterBias||0),0,1);if(p<=0&&h<=0)return;const g=f.filter(T=>{if(l.has(T)||u.has(T))return!1;const v=e.get(T);if(!v)return!1;const A=v.traits;return!YM(A)}),b=T=>{const v=e.get(T);return v?K0(v.traits):!1},S=new Set;for(const T of g){if(b(T))continue;Bg(`${n}|sandbox-wall-seed|${T}`)<p&&S.add(T)}for(let T=0;T<2;T++)for(const v of g){if(b(v)||S.has(v))continue;const A=e.get(v);if(!A)continue;const _=ff(A.position).filter(C=>e.has(C));let E=0;for(const C of _)(b(C)||S.has(C))&&E++;if(E===0)continue;const w=h*(E/6);Bg(`${n}|sandbox-wall-grow|pass:${T}|${v}`)<w&&S.add(v)}for(const T of S)Ld(e,T,!0)},JM=e=>{switch(e){case"inferno":return 4;case"throne":return 6;case"frozen":return 8;case"void":return 10;default:return 1}},QM=(e,n,s,o)=>{const a=JM(e),l=n.trim()||"biome-sandbox-seed",u=Cs(a,l,l,void 0,Vn.VANGUARD),f=WM(u);return XM(f,l,u.player.position,o),s&&GM(f,u.player.position),{...u,floor:a,theme:e,rngSeed:l,initialSeed:l,turnNumber:1,tiles:f,visualEvents:[],timelineEvents:[],intentPreview:void 0}},xl="/Hop",Hg=64,Pg=192,Al=64,Tl=512,nt=(e,n,s)=>Math.min(s,Math.max(n,e)),ZM=(e,n)=>`${e.endsWith("/")?e:`${e}/`}${n.replace(/^\/+/,"")}`,Ro=e=>{const n=e.trim();if(!n||/^\/assets\/[a-z0-9/_\-.]+$/i.test(n))return n;const o=`${xl.endsWith("/")?xl:`${xl}/`}assets/`;return n.startsWith(o)?`/assets/${n.slice(o.length)}`:n.startsWith("/")?n:ZM(xl,n)},El=(e,n="#8b6f4a")=>{const s=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(s))return s.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(s)){const[l,u,f]=s.slice(1).split("");return`#${l}${l}${u}${u}${f}${f}`.toLowerCase()}return n},Jd=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",_l=e=>e==="off"?"off":Jd(e),eC=e=>{const n=e.theme.toLowerCase(),s=Ro(e.undercurrent.path),o=Ro(e.crust.path),a=Ro(e.materials.detailA.path),l=Ro(e.materials.detailB.path),f={mountainPath:Ro(e.walls.mountainPath),mountainScale:nt(e.walls.mountainScale,.2,3),mountainOffsetX:e.walls.mountainOffsetX,mountainOffsetY:e.walls.mountainOffsetY,mountainAnchorX:nt(e.walls.mountainAnchorX,0,1),mountainAnchorY:nt(e.walls.mountainAnchorY,0,1),mountainCrustBlendMode:_l(e.walls.mountainCrustBlendMode),mountainCrustBlendOpacity:nt(e.walls.mountainCrustBlendOpacity,0,1),mountainTintColor:El(e.walls.mountainTintColor,"#7d7d7d"),mountainTintBlendMode:_l(e.walls.mountainTintBlendMode),mountainTintOpacity:nt(e.walls.mountainTintOpacity,0,1),scale:nt(e.walls.mountainScale,.2,3),offsetX:e.walls.mountainOffsetX,offsetY:e.walls.mountainOffsetY,anchorX:nt(e.walls.mountainAnchorX,0,1),anchorY:nt(e.walls.mountainAnchorY,0,1),crustBlendMode:_l(e.walls.mountainCrustBlendMode),crustBlendOpacity:nt(e.walls.mountainCrustBlendOpacity,0,1),tintColor:El(e.walls.mountainTintColor,"#7d7d7d"),tintBlendMode:_l(e.walls.mountainTintBlendMode),tintOpacity:nt(e.walls.mountainTintOpacity,0,1)},p={seed:e.seed.trim()||"biome-sandbox-seed",injectHazards:e.injectHazards,biomeLayers:{undercurrent:{default:s,mode:e.undercurrent.mode,scalePx:nt(e.undercurrent.scalePx,Hg,Pg),opacity:nt(e.undercurrent.opacity,0,1),offsetX:e.undercurrent.offsetX,offsetY:e.undercurrent.offsetY,scroll:{x:e.undercurrent.scrollX,y:e.undercurrent.scrollY,durationMs:Math.max(1e3,e.undercurrent.scrollDurationMs)}},crust:{default:o,mode:e.crust.mode,scalePx:Math.max(64,e.crust.scalePx),opacity:1,seedShiftPx:e.crust.seedShiftPx,offsetX:e.crust.offsetX,offsetY:e.crust.offsetY},clutter:{density:e.clutter.density,maxPerHex:e.clutter.maxPerHex,bleedScaleMax:e.clutter.bleedScaleMax}},walls:{mode:e.walls.mode,interiorDensity:e.walls.interiorDensity,clusterBias:e.walls.clusterBias,keepPerimeter:e.walls.keepPerimeter,...f},biomeMaterials:{crust:{detailA:{default:a,mode:e.materials.detailA.mode,scalePx:nt(e.materials.detailA.scalePx,Al,Tl),opacity:nt(e.materials.detailA.opacity,0,1)},detailB:{default:l,mode:e.materials.detailB.mode,scalePx:nt(e.materials.detailB.scalePx,Al,Tl),opacity:nt(e.materials.detailB.opacity,0,1)},tint:{default:El(e.materials.tintColor,"#8b6f4a"),opacity:nt(e.materials.tintOpacity,0,1),blendMode:Jd(e.materials.tintBlend)}}}};return{theme:e.theme,seed:e.seed.trim()||"biome-sandbox-seed",injectHazards:e.injectHazards,biomeLayers:{undercurrent:{default:s,mode:e.undercurrent.mode,scalePx:nt(e.undercurrent.scalePx,Hg,Pg),opacity:nt(e.undercurrent.opacity,0,1),offsetX:e.undercurrent.offsetX,offsetY:e.undercurrent.offsetY,scroll:{x:e.undercurrent.scrollX,y:e.undercurrent.scrollY,durationMs:Math.max(1e3,e.undercurrent.scrollDurationMs)}},crust:{default:o,mode:e.crust.mode,scalePx:Math.max(64,e.crust.scalePx),opacity:1,seedShiftPx:e.crust.seedShiftPx,offsetX:e.crust.offsetX,offsetY:e.crust.offsetY},clutter:{density:e.clutter.density,maxPerHex:e.clutter.maxPerHex,bleedScaleMax:e.clutter.bleedScaleMax}},walls:{mode:e.walls.mode,interiorDensity:e.walls.interiorDensity,clusterBias:e.walls.clusterBias,keepPerimeter:e.walls.keepPerimeter,...f,themes:{[n]:f}},biomeMaterials:{crust:{detailA:{default:a,mode:e.materials.detailA.mode,scalePx:nt(e.materials.detailA.scalePx,Al,Tl),opacity:nt(e.materials.detailA.opacity,0,1)},detailB:{default:l,mode:e.materials.detailB.mode,scalePx:nt(e.materials.detailB.scalePx,Al,Tl),opacity:nt(e.materials.detailB.opacity,0,1)},tint:{default:El(e.materials.tintColor,"#8b6f4a"),opacity:nt(e.materials.tintOpacity,0,1),blendMode:Jd(e.materials.tintBlend)}}},biomePresets:{[n]:p}}},wl=(e,n)=>e?n&&e.themes?.[n]?e.themes[n]:e.default||"":"",Ml=e=>e?e.mode==="cover"||e.mode==="repeat"||e.mode==="off"?e.mode:"repeat":"off",tC=(e,n)=>e?n&&e.themes?.[n]?e.themes[n]:e.default||"#8b6f4a":"#8b6f4a",Bd=(e,n,s,o)=>{const a=e?.[s]??e?.[o];return a!==void 0?a:n?.[s]??n?.[o]},jg=(e,n)=>{const s=n.toLowerCase(),o=df(e,s),a=o?.biomeLayers?.undercurrent??e.biomeLayers?.undercurrent,l=o?.biomeLayers?.crust??e.biomeLayers?.crust??(e.biomeUnderlay?{default:e.biomeUnderlay.default,themes:e.biomeUnderlay.themes,mode:e.biomeUnderlay.mode,scalePx:e.biomeUnderlay.scalePx,opacity:e.biomeUnderlay.opacity}:void 0),u=o?.biomeMaterials?.crust??e.biomeMaterials?.crust,f=u?.detailA,p=u?.detailB,h=u?.tint,g=o?.walls||e.walls,b=o?.walls?o.walls:e.walls?.themes?.[s],S=(e.assets||[]).filter(k=>{if(k.type!=="prop")return!1;const R=k.id.toLowerCase(),$=new Set((k.tags||[]).map(D=>D.toLowerCase()));if(!R.includes("mountain")&&!$.has("mountain"))return!1;if(!k.theme)return!0;const j=k.theme.toLowerCase();return j===s||j==="core"}).sort((k,R)=>k.id.localeCompare(R.id)),v=String(b?.mountainPath??g?.mountainPath??"").trim()||S.find(k=>k.path.toLowerCase().includes("biome.volcano.mountain.03.webp"))?.path||S[0]?.path||"",A=S.find(k=>k.path===v)||S[0],_=A?.mountainSettings,E=A?.mountainSettingsByTheme?.[s],w=A?o?.assetOverrides?.[A.id]?.mountainSettings:void 0,M=(k,R,$)=>{const D=Bd(b,g,k,R)??w?.[k]??E?.[k]??_?.[k]??$,q=Number(D);return Number.isFinite(q)?q:$},C=(k,R,$)=>{const D=Bd(b,g,k,R)??w?.[k]??E?.[k]??_?.[k]??$;return $o(D)},I=(k,R,$)=>{const D=Bd(b,g,k,R)??w?.[k]??E?.[k]??_?.[k]??$;return Ta(String(D||""),$)};return{theme:n,seed:String(o?.seed||"biome-sandbox-seed"),injectHazards:o?.injectHazards!==void 0?!!o.injectHazards:!0,undercurrent:{path:wl(a,s),mode:Ml(a),scalePx:xe(Number(a?.scalePx??e.tileUnitPx??256),Ul,$l),opacity:xe(Number(a?.opacity??.6),0,1),scrollX:Number(a?.scroll?.x??120),scrollY:Number(a?.scroll?.y??90),scrollDurationMs:Math.max(1e3,Number(a?.scroll?.durationMs??92e3)),offsetX:Number(a?.offsetX??0),offsetY:Number(a?.offsetY??0)},crust:{path:wl(l,s),mode:Ml(l),scalePx:Math.max(64,Number(l?.scalePx??e.tileUnitPx??256)),opacity:1,seedShiftPx:Math.max(0,Number(l?.seedShiftPx??96)),offsetX:Number(l?.offsetX??0),offsetY:Number(l?.offsetY??0)},clutter:{density:xe(Number((o?.biomeLayers?.clutter??e.biomeLayers?.clutter)?.density??.14),0,1),maxPerHex:Math.max(0,Number((o?.biomeLayers?.clutter??e.biomeLayers?.clutter)?.maxPerHex??1)),bleedScaleMax:xe(Number((o?.biomeLayers?.clutter??e.biomeLayers?.clutter)?.bleedScaleMax??2),1,2)},walls:{mode:g?.mode==="native"||g?.mode==="additive"||g?.mode==="custom"?g.mode:"custom",interiorDensity:xe(Number(g?.interiorDensity??.05),0,.45),clusterBias:xe(Number(g?.clusterBias??0),0,1),keepPerimeter:g?.keepPerimeter!==void 0?!!g.keepPerimeter:!0,mountainPath:v,mountainScale:xe(M("scale","mountainScale",.53),.2,3),mountainOffsetX:M("offsetX","mountainOffsetX",0),mountainOffsetY:M("offsetY","mountainOffsetY",0),mountainAnchorX:xe(M("anchorX","mountainAnchorX",.5),0,1),mountainAnchorY:xe(M("anchorY","mountainAnchorY",.55),0,1),mountainCrustBlendMode:C("crustBlendMode","mountainCrustBlendMode","multiply"),mountainCrustBlendOpacity:xe(M("crustBlendOpacity","mountainCrustBlendOpacity",1),0,1),mountainTintColor:I("tintColor","mountainTintColor","#7d7d7d"),mountainTintBlendMode:C("tintBlendMode","mountainTintBlendMode","overlay"),mountainTintOpacity:xe(M("tintOpacity","mountainTintOpacity",1),0,1)},materials:{detailA:{path:wl(f,s),mode:Ml(f),scalePx:xe(Number(f?.scalePx??192),Yi,Ki),opacity:xe(Number(f?.opacity??0),0,1)},detailB:{path:wl(p,s),mode:Ml(p),scalePx:xe(Number(p?.scalePx??256),Yi,Ki),opacity:xe(Number(p?.opacity??0),0,1)},tintColor:tC(h,s),tintOpacity:xe(Number(h?.opacity??0),0,1),tintBlend:Xl(h?.blendMode)}}},Dg="hop_biome_sandbox_settings_v1",nC=e=>e==="native"||e==="additive"||e==="custom",iC=e=>{if(!e)return null;try{const n=JSON.parse(e);return!n||typeof n!="object"?null:n}catch{return null}},sC=(e,n)=>n?{...e,...n,undercurrent:{...e.undercurrent,...n.undercurrent||{},scalePx:xe(Number((n.undercurrent||{}).scalePx??e.undercurrent.scalePx),Ul,$l)},crust:{...e.crust,...n.crust||{},opacity:1},clutter:{...e.clutter,...n.clutter||{}},walls:{...e.walls,...n.walls||{},mode:nC((n.walls||{}).mode)?(n.walls||{}).mode:e.walls.mode,interiorDensity:xe(Number((n.walls||{}).interiorDensity??e.walls.interiorDensity),0,.45),clusterBias:xe(Number((n.walls||{}).clusterBias??e.walls.clusterBias),0,1),keepPerimeter:(n.walls||{}).keepPerimeter!==void 0?!!(n.walls||{}).keepPerimeter:e.walls.keepPerimeter,mountainPath:String((n.walls||{}).mountainPath||e.walls.mountainPath||""),mountainScale:xe(Number((n.walls||{}).mountainScale??e.walls.mountainScale),.2,3),mountainOffsetX:qe(String((n.walls||{}).mountainOffsetX??e.walls.mountainOffsetX),e.walls.mountainOffsetX),mountainOffsetY:qe(String((n.walls||{}).mountainOffsetY??e.walls.mountainOffsetY),e.walls.mountainOffsetY),mountainAnchorX:xe(Number((n.walls||{}).mountainAnchorX??e.walls.mountainAnchorX),0,1),mountainAnchorY:xe(Number((n.walls||{}).mountainAnchorY??e.walls.mountainAnchorY),0,1),mountainCrustBlendMode:$o((n.walls||{}).mountainCrustBlendMode??e.walls.mountainCrustBlendMode),mountainCrustBlendOpacity:xe(Number((n.walls||{}).mountainCrustBlendOpacity??e.walls.mountainCrustBlendOpacity),0,1),mountainTintColor:Ta(String((n.walls||{}).mountainTintColor??e.walls.mountainTintColor),e.walls.mountainTintColor),mountainTintBlendMode:$o((n.walls||{}).mountainTintBlendMode??e.walls.mountainTintBlendMode),mountainTintOpacity:xe(Number((n.walls||{}).mountainTintOpacity??e.walls.mountainTintOpacity),0,1)},materials:{...e.materials,...n.materials||{},detailA:{...e.materials.detailA,...(n.materials||{}).detailA||{},scalePx:xe(Number(((n.materials||{}).detailA||{}).scalePx??e.materials.detailA.scalePx),Yi,Ki),opacity:xe(Number(((n.materials||{}).detailA||{}).opacity??e.materials.detailA.opacity),0,1)},detailB:{...e.materials.detailB,...(n.materials||{}).detailB||{},scalePx:xe(Number(((n.materials||{}).detailB||{}).scalePx??e.materials.detailB.scalePx),Yi,Ki),opacity:xe(Number(((n.materials||{}).detailB||{}).opacity??e.materials.detailB.opacity),0,1)},tintOpacity:xe(Number((n.materials||{}).tintOpacity??e.materials.tintOpacity),0,1),tintBlend:Xl((n.materials||{}).tintBlend)}}:e,aC=e=>{const n=N.useRef(!1),[s,o]=N.useState(""),[a,l]=N.useState(null);return N.useEffect(()=>{if(!e||n.current)return;const p=jg(e,"inferno"),h=iC(localStorage.getItem(Dg));l(sC(p,h)),n.current=!0},[e]),N.useEffect(()=>{a&&localStorage.setItem(Dg,JSON.stringify(a))},[a]),{settings:a,setSettings:l,copyStatus:s,copySettings:async()=>{if(!a)return;const p=eC(a);try{await navigator.clipboard.writeText(JSON.stringify(p,null,2)),o("Copied"),window.setTimeout(()=>o(""),1600)}catch{o("Copy failed"),window.setTimeout(()=>o(""),1600)}},resetSettings:()=>{e&&l(p=>p&&jg(e,p.theme))}}},oC=({assetManifest:e,onBack:n})=>{const{settings:s,setSettings:o,copyStatus:a,copySettings:l,resetSettings:u}=aC(e),f=s?.theme?.toLowerCase()||"inferno",p=N.useMemo(()=>Ta(s?.materials.tintColor||"#8b6f4a"),[s?.materials.tintColor]),h=N.useMemo(()=>Ta(s?.walls.mountainTintColor||"#8b6f4a"),[s?.walls.mountainTintColor]),g=qM(e),b=N.useMemo(()=>$M(e,s,f),[e,s,f]),S=N.useMemo(()=>s?QM(s.theme,s.seed,s.injectHazards,s.walls):null,[s]);return!e||!s||!b||!S?y.jsxs("div",{className:"w-screen h-screen bg-[#030712] text-white flex items-center justify-center",children:[y.jsx("button",{type:"button",onClick:n,className:"absolute top-5 left-5 px-4 py-2 rounded-lg border border-white/20 bg-white/5 hover:bg-white/10 text-xs font-black uppercase tracking-[0.2em]",children:"Back"}),y.jsx("div",{className:"text-sm text-white/70 uppercase tracking-[0.25em] font-black",children:"Loading Biome Sandbox..."})]}):y.jsxs("div",{className:"w-screen h-screen bg-[#030712] text-white flex",children:[y.jsx(R_,{settings:s,setSettings:o,pathSets:g,copyStatus:a,onBack:n,onReset:u,onCopySettings:l,tintPickerColor:p,mountainTintPickerColor:h}),y.jsx(jM,{theme:s.theme,previewState:S,previewManifest:b})]})},rC=()=>{const[e,n]=N.useState(null);return N.useEffect(()=>{let s=!0;return AM().then(o=>{s&&(n(o),window.__HOP_ASSET_MANIFEST=o)}),()=>{s=!1}},[]),e},lC=e=>{N.useEffect(()=>{if(!(typeof window<"u"&&!!window.__HOP_DEBUG_PERF))return;let s=0,o=performance.now(),a=0,l=0,u=o;const f=p=>{const h=p-o;if(o=p,a++,l+=h,p-u>=2e3){const g=l/Math.max(1,a),b=1e3/Math.max(1,g);console.log("[HOP_PERF]",{fps:Number(b.toFixed(1)),avgFrameMs:Number(g.toFixed(2)),frames:a}),u=p,a=0,l=0}s=requestAnimationFrame(f)};return s=requestAnimationFrame(f),()=>cancelAnimationFrame(s)},e)},cC=(e,n)=>{N.useEffect(()=>{n&&(window.state=e,window.QUERY={tile:(s,o)=>{const l=ce({q:s,r:o});return console.log(`Checking Map for Key: "${l}"`),e.tiles.get(l)},whereAmI:()=>{const s=e.player.position,o=ce(s),a=e.tiles.get(o);return{coords:s,key:o,tileExists:!!a,tileData:a}},dumpKeys:()=>Array.from(e.tiles.keys())})},[e,n])},uC=e=>{const[n,s]=N.useState(null),o=N.useRef(null);return N.useEffect(()=>{if(e.gameStatus!=="playing"||o.current===e.floor)return;s({floor:e.floor,theme:e.theme||"Inferno"}),o.current=e.floor;const a=setTimeout(()=>s(null),3e3);return()=>clearTimeout(a)},[e.floor,e.gameStatus,e.theme]),n},dC=e=>e instanceof Map?e:Array.isArray(e)?new Map(e):e&&typeof e=="object"?new Map(Object.entries(e)):new Map,Ug=e=>{const n={...e,components:dC(e?.components)},s=Lo(n),a=(s.components??new Map).get("trinity");if(!a)return s;const l=Fl({body:Number(a.body||0),mind:Number(a.mind||0),instinct:Number(a.instinct||0)});return{...s,maxHp:l,hp:Math.min(l,Math.max(0,Number(s.hp??l)))}},fC=()=>{const e=localStorage.getItem("hop_save");if(!e)return jl();try{const n=JSON.parse(e);if(n.tiles){const s=Array.isArray(n.tiles)?n.tiles:Object.entries(n.tiles);n.tiles=new Map(s.map(([o,a])=>[o,{...a,traits:new Set(a.traits)}]))}return Array.isArray(n.occupancyMask)&&(n.occupancyMask=n.occupancyMask.map(s=>typeof s=="string"?BigInt(s):s)),n.player=of(Ug(n.player)),n.enemies=Array.isArray(n.enemies)?n.enemies.map(Ug):[],n}catch(n){return console.error("Failed to hydrate Map state:",n),jl()}},mC=()=>{const[e,n]=N.useReducer(d_,null,fC),s=N.useRef(null),o=N.useRef(""),a=e.gameStatus==="playing"||e.gameStatus==="choosing_upgrade",l=`${e.gameStatus}|${e.floor}|${e.turnNumber}|${e.player.hp}|${ce(e.player.position)}|${e.enemies.length}|${e.actionLog?.length??0}|${e.message?.length??0}`;return N.useEffect(()=>{if(s.current!==null&&(typeof window.cancelIdleCallback=="function"?window.cancelIdleCallback(s.current):window.clearTimeout(s.current),s.current=null),!a){o.current="",localStorage.removeItem("hop_save");return}if(l===o.current)return;const u=()=>{const f={...e,tiles:Array.from(e.tiles.entries()).map(([h,g])=>[h,{...g,traits:Array.from(g.traits)}])},p=h=>JSON.stringify(h,(g,b)=>typeof b=="bigint"?b.toString():b);localStorage.setItem("hop_save",p(f)),o.current=l,s.current=null};return typeof window.requestIdleCallback=="function"?s.current=window.requestIdleCallback(u,{timeout:500}):s.current=window.setTimeout(u,120),()=>{s.current!==null&&(typeof window.cancelIdleCallback=="function"?window.cancelIdleCallback(s.current):window.clearTimeout(s.current),s.current=null)}},[e,a,l]),[e,n]},pC=({dispatchWithTrace:e})=>{const[n,s]=N.useState(!1),[o,a]=N.useState([]),[l,u]=N.useState(!1),[f,p]=N.useState(null),h=N.useRef(0),g=N.useCallback(()=>{u(!1),s(!1),p(null),a([]),h.current=0},[]),b=N.useCallback(T=>{if(!T)return;const v=H0(T.actions||[]);if(!v.valid){const w=`Replay rejected: ${v.errors.slice(0,3).join(" | ")}`;p(w),console.error("[HOP_REPLAY] Invalid replay actions",{replayId:T.id,errors:v.errors});return}p(null),s(!0),a(v.actions),u(!1),h.current=0;const A=T.seed||T.id||String(Date.now()),_=T.loadoutId?Vn[T.loadoutId]:void 0,E=Cs(1,A,A,void 0,_);e({type:"LOAD_STATE",payload:E},"replay_start")},[e]),S=N.useCallback(()=>{const T=h.current;if(T>=o.length){u(!1);return}e(o[T],"replay_step"),h.current=T+1},[e,o]);return N.useEffect(()=>{if(!l||!n)return;const T=window.setInterval(S,500);return()=>window.clearInterval(T)},[l,n,S]),{isReplayMode:n,replayActions:o,replayActive:l,replayError:f,replayIndexRef:h,setReplayActive:u,resetReplayUi:g,startReplay:b,stepReplay:S}},hC=(e,n)=>{const s=new Set(e.map(f=>f.type)),o=s.has("ADVANCE_TURN"),a=s.has("RESOLVE_PENDING"),l=e.length,u=n>=5&&l<Math.max(25,n*4);return{actionCount:l,hasTurnAdvance:o,hasPendingResolve:a,suspiciouslyShort:u}},$g="hop_replays_v1",qg="hop_leaderboard_v1",yC=(e,n)=>{const s=N.useRef(null);N.useEffect(()=>{if(!n){if((e.gameStatus==="won"||e.gameStatus==="lost")&&s.current!==e.initialSeed){s.current=e.initialSeed||"default";const o=e.initialSeed??e.rngSeed??"0",a=e.completedRun?.score||(e.player.hp||0)+(e.floor||0)*100,l=H0(e.actionLog||[]);if(!l.valid){console.error("[HOP_REPLAY] Refusing to persist replay with invalid action log",{errors:l.errors});return}const u=hC(l.actions,e.floor||0),f={id:`run-${Date.now()}`,seed:o,loadoutId:e.player.archetype,actions:l.actions,score:a,floor:e.floor,date:new Date().toISOString(),replayVersion:2,diagnostics:u},p=localStorage.getItem($g),h=p?JSON.parse(p):[],g=[f,...h].slice(0,100);localStorage.setItem($g,JSON.stringify(g));const b=localStorage.getItem(qg);let S=b?JSON.parse(b):[];S.push({id:f.id,name:"Player",score:f.score,floor:f.floor,date:f.date,seed:f.seed,loadoutId:f.loadoutId,actions:f.actions,replayVersion:f.replayVersion,diagnostics:f.diagnostics}),S.sort((T,v)=>v.score-T.score),S=S.slice(0,5),localStorage.setItem(qg,JSON.stringify(S))}e.gameStatus==="hub"&&(s.current=null)}},[e.gameStatus,e.initialSeed,e.rngSeed,e.completedRun?.score,e.floor,e.player.hp,e.player.archetype,e.actionLog,n])},gC=({gameState:e,appendTurnTrace:n})=>{const s=N.useRef([]),o=N.useRef(null),a=N.useRef(""),[l,u]=N.useState([]),f=N.useCallback(g=>{const b=Date.now();u(S=>[...S,{...g,createdAt:b}].slice(-4))},[]),p=N.useCallback(g=>{if(!(!g||g.length===0)){s.current=[...s.current,...g].slice(-600),window.__HOP_SIM_EVENTS=s.current,window.dispatchEvent(new CustomEvent("hop:simulation-events",{detail:{turn:e.turnNumber,events:g}})),n("SIM_EVENTS",{count:g.length,lastType:g[g.length-1]?.type??"unknown"});for(const b of g)if(b.type==="DamageTaken"&&b.targetId===e.player.id){const S=Math.max(0,Number(b.payload?.amount||0));S>0&&f({id:`sim-toast-${b.id}`,text:`-${S} HP`,tone:"damage"})}else if(b.type==="Healed"&&b.targetId===e.player.id){const S=Math.max(0,Number(b.payload?.amount||0));S>0&&f({id:`sim-toast-${b.id}`,text:`+${S} HP`,tone:"heal"})}else if(b.type==="StatusApplied"&&b.targetId===e.player.id){const T=String(b.payload?.status||"Status").split("_").filter(Boolean).map(v=>v.charAt(0).toUpperCase()+v.slice(1)).join(" ");f({id:`sim-toast-${b.id}`,text:T,tone:"status"})}else if(b.type==="MessageLogged"){const S=String(b.payload?.text||"").trim();if(!S)continue;const T=S.toLowerCase();if(!(T.includes("stun")||T.includes("snare")||T.includes("lava")||T.includes("fire")||T.includes("burn")||T.includes("heal")||T.includes("shrine")||T.includes("stairs")||T.includes("roll away")||T.includes("ward")||T.includes("orb")))continue;const A=S.length>52?`${S.slice(0,49)}...`:S;f({id:`sim-toast-${b.id}`,text:A,tone:"system"})}}},[n,e.turnNumber,e.player.id,f]),h=N.useCallback(g=>{o.current=g,window.__HOP_UI_MIRROR=g},[]);return N.useEffect(()=>(window.__HOP_SIM_EVENTS=s.current,window.__HOP_DUMP_SIM_EVENTS=()=>[...s.current],window.__HOP_CLEAR_SIM_EVENTS=()=>{s.current=[],window.__HOP_SIM_EVENTS=[]},window.__HOP_DUMP_MIRROR=()=>window.__HOP_MIRROR_LAST,()=>{delete window.__HOP_DUMP_SIM_EVENTS,delete window.__HOP_CLEAR_SIM_EVENTS,delete window.__HOP_DUMP_MIRROR}),[]),N.useEffect(()=>{if(l.length===0)return;const g=window.setTimeout(()=>{const b=Date.now();u(S=>S.filter(T=>b-T.createdAt<2200))},180);return()=>window.clearTimeout(g)},[l]),N.useEffect(()=>{const g=S_(e);window.__HOP_ENGINE_MIRROR=g;const b=o.current;if(!b||b.turn!==g.turn||b.stackTick!==g.stackTick)return;const S=v_(g,b),T=`${g.turn}:${g.stackTick}:${S.ok?"ok":S.mismatches.length}`;T!==a.current&&(a.current=T,window.__HOP_MIRROR_LAST={engineSnapshot:g,uiSnapshot:b,result:S},S.ok||(n("MIRROR_MISMATCH",{count:S.mismatches.length}),console.warn("[HOP_MIRROR] snapshot mismatch detected",S.mismatches)))},[e,n]),{mobileToasts:l,handleSimulationEvents:p,handleUiMirrorSnapshot:h}},bC=e=>{const n=e||[],s=n.length>0?n[n.length-1]:void 0;return`${n.length}:${s?.type??"none"}`},SC=e=>{const n=e||[],s=n.length>0?n[n.length-1]:void 0;return`${n.length}:${s?.id??"none"}:${s?.phase??"none"}`},vC=({gameState:e,turnDriver:n,isBusy:s,isReplayMode:o,postCommitInputLock:a,setPostCommitInputLock:l,appendTurnTrace:u,dispatchWithTrace:f})=>{const[p,h]=N.useState(0),g=N.useRef(null),b=N.useRef(null),S=N.useRef(null),T=N.useRef(null),v=N.useRef(""),A=N.useRef(""),_=N.useRef(!1),E=N.useRef(""),w=N.useRef(""),M=N.useRef(!1),C=N.useRef(0),I=220,k=900,R=e.pendingFrames?.length??0,$=bC(e.visualEvents),j=SC(e.timelineEvents),D=`${e.pendingStatus?.status??"none"}:${R}`,q=N.useCallback((ee="unknown")=>{a&&u("LOCK_RELEASE",{reason:ee,lockTurn:g.current,expectedActionLogLength:b.current}),l(!1),g.current=null,b.current=null,S.current=null,_.current=!1,E.current="",w.current="",T.current!==null&&(window.clearTimeout(T.current),T.current=null)},[u,a,l]);return N.useEffect(()=>{if(!n.shouldAdvanceQueue)return;u("QUEUE_SCHEDULE",{delayMs:n.queueAdvanceDelayMs});const ee=window.setTimeout(()=>{f({type:"ADVANCE_TURN"},"queue_pump")},n.queueAdvanceDelayMs);return()=>window.clearTimeout(ee)},[n.shouldAdvanceQueue,n.queueAdvanceDelayMs,e.turnNumber,e.initiativeQueue,e.player.id,e.enemies,f,u]),N.useEffect(()=>{s||(v.current=$,A.current=j)},[s,$,j]),N.useEffect(()=>{M.current=!1,C.current=performance.now()},[D]),N.useEffect(()=>{(e.pendingStatus||R>0)&&s&&(M.current=!0)},[e.pendingStatus,R,s]),N.useEffect(()=>{a&&s&&(_.current=!0)},[a,s]),N.useEffect(()=>{if(!a)return;const ee=window.setTimeout(()=>{h(oe=>oe+1)},120);return()=>window.clearTimeout(ee)},[a,p]),N.useEffect(()=>{const ee=!s&&$===v.current&&j===A.current,oe=(e.timelineEvents||[]).some(G=>G.blocking),F=(e.timelineEvents||[]).filter(G=>G.blocking).reduce((G,ae)=>G+(ae.suggestedDurationMs||0),0),H=(e.visualEvents||[]).reduce((G,ae)=>{if(ae.type!=="kinetic_trace")return G;const le=ae.payload;if(!le)return G;const ue=Math.max(0,Number(le.startDelayMs||0)),be=Math.max(0,Number(le.durationMs||0));return Math.max(G,ue+be)},0),z=Math.max(F,H),Z=z>0?Math.max(160,Math.min(3200,z+40)):0,re=Math.max(0,performance.now()-C.current),pe=!oe||M.current,B=!oe||re>=Z,W=ee&&(pe||B);if(n.shouldResolvePending){if(W){u("PENDING_RESOLVE_READY",{noPendingAnimations:ee,hasBlockingTimeline:oe,movementTraceBudgetMs:H,elapsedPendingMs:re,requiredFallbackDelayMs:Z}),f({type:"RESOLVE_PENDING"},"pending_ready");return}if(!s&&oe&&!M.current){u("PENDING_RESOLVE_WAIT",{movementTraceBudgetMs:H,elapsedPendingMs:re,requiredFallbackDelayMs:Z});const G=Math.max(0,Z-re),ae=window.setTimeout(()=>{f({type:"RESOLVE_PENDING"},"pending_fallback_delay")},G);return()=>window.clearTimeout(ae)}}},[n.shouldResolvePending,e.timelineEvents,e.visualEvents,s,$,j,f,u]),N.useEffect(()=>{if(!a)return;if(o||e.gameStatus!=="playing"){q("mode_or_status_change");return}if(e.pendingStatus||(e.pendingFrames?.length??0)>0){q("pending_intercept");return}const ee=g.current,oe=b.current,F=S.current!==null?Math.max(0,performance.now()-S.current):Number.POSITIVE_INFINITY,H=ee!==null?e.turnNumber>ee:!1,z=oe!==null?(e.actionLog?.length??0)>=oe:!1,Z=F>=I,re=$!==E.current||j!==w.current,pe=!H&&!z,B=!_.current&&re&&F<k,W=e.gameStatus==="playing"&&!o&&!s&&!e.pendingStatus&&(e.pendingFrames?.length??0)===0&&Do(e);if(B){u("LOCK_WAIT_FOR_BUSY",{lockAgeMs:F,visualsChangedSinceArm:re});return}if(W&&pe&&F>450){q("no_progress_timeout");return}W&&Z&&(H||z||F>1500)&&q(H?"turn_advanced":z?"action_committed":"age_fallback")},[a,o,e.gameStatus,e.turnNumber,e.pendingStatus,e.pendingFrames,e.initiativeQueue,e.actionLog,s,e.player.id,e.enemies,u,$,j,p,q]),N.useEffect(()=>{e.gameStatus!=="playing"&&a&&q("not_playing")},[e.gameStatus,a,q]),N.useEffect(()=>{if(a)return T.current!==null&&window.clearTimeout(T.current),T.current=window.setTimeout(()=>{if(a){const ee=Array.isArray(window.__HOP_TURN_TRACE)?window.__HOP_TURN_TRACE:[];console.error("[HOP_INPUT_LOCK] Watchdog released stuck post-commit lock",{turnNumber:e.turnNumber,pendingStatus:e.pendingStatus?.status,pendingFrames:e.pendingFrames?.length??0,playerTurn:Do(e),isBusy:s,actionLogLength:e.actionLog?.length??0,traceTail:ee.slice(-40)}),u("LOCK_WATCHDOG_RELEASE"),q("watchdog")}},8e3),()=>{T.current!==null&&(window.clearTimeout(T.current),T.current=null)}},[a,e.turnNumber,e.pendingStatus,e.actionLog,s,e.initiativeQueue,e.player.id,e.enemies,u,q]),N.useEffect(()=>{if(!a)return;const ee=window.setTimeout(()=>{u("LOCK_STALL_SNAPSHOT",{lockAgeMs:S.current!==null?Math.max(0,performance.now()-S.current):null})},2500);return()=>window.clearTimeout(ee)},[a,u]),{armPostCommitLock:N.useCallback(()=>{T.current!==null&&(window.clearTimeout(T.current),T.current=null),g.current=e.turnNumber,b.current=(e.actionLog?.length??0)+1,S.current=performance.now(),_.current=!1,E.current=$,w.current=j,l(!0),u("LOCK_ARM",{lockTurn:e.turnNumber,expectedActionLogLength:(e.actionLog?.length??0)+1,eventHashAtArm:$,timelineHashAtArm:j})},[e.turnNumber,e.actionLog,$,j,l,u])}},xC=e=>{const{gameStatus:n,isReplayMode:s,isBusy:o,postCommitInputLock:a,isPlayerTurn:l,hasPendingStatus:u,pendingFrameCount:f}=e,p=u||f>0;let h="IDLE";return s?h="REPLAY":n!=="playing"?h="IDLE":p?h=o?"INTERCEPT_ANIMATING":"INTERCEPT_READY":o?h="PLAYBACK":a&&l?h="POST_COMMIT_LOCK":a&&!l?h="POST_COMMIT_QUEUE":l?h="INPUT_OPEN":h="QUEUE_ADVANCE",{phase:h,canPlayerInput:h==="INPUT_OPEN",shouldAdvanceQueue:h==="QUEUE_ADVANCE"||h==="POST_COMMIT_QUEUE",shouldResolvePending:h==="INTERCEPT_READY",queueAdvanceDelayMs:380}},AC=({gameState:e,dispatch:n,isReplayMode:s,isBusy:o,postCommitInputLock:a,dispatchWithTraceProxyRef:l,summarizeActionPayload:u})=>{const f=e.pendingFrames?.length??0,p=N.useMemo(()=>xC({gameStatus:e.gameStatus,isReplayMode:s,isBusy:o,postCommitInputLock:a,isPlayerTurn:Do(e),hasPendingStatus:!!e.pendingStatus,pendingFrameCount:f}),[e.gameStatus,s,o,a,e.pendingStatus,f,e.initiativeQueue,e.player.id,e.enemies]),h=!p.canPlayerInput,g=N.useRef([]),b=N.useRef(0),S=N.useRef(""),T=e.initiativeQueue?.entries?.[Math.max(0,e.initiativeQueue.currentIndex??0)]?.actorId??e.initiativeQueue?.entries?.[0]?.actorId??"none",v=N.useCallback((_,E)=>{const w={id:++b.current,t:Date.now(),event:_,turnNumber:e.turnNumber,phase:p.phase,gameStatus:e.gameStatus,playerTurn:Do(e),isBusy:o,postCommitInputLock:a,pendingStatus:e.pendingStatus?.status??"none",pendingFrames:e.pendingFrames?.length??0,canPlayerInput:p.canPlayerInput,shouldAdvanceQueue:p.shouldAdvanceQueue,shouldResolvePending:p.shouldResolvePending,actionLogLength:e.actionLog?.length??0,queueHead:T,details:E};g.current.push(w),g.current.length>800&&g.current.splice(0,g.current.length-800)},[e.turnNumber,e.gameStatus,e.pendingStatus,e.pendingFrames,e.actionLog,e.initiativeQueue,e.player.id,e.enemies,p.phase,p.canPlayerInput,p.shouldAdvanceQueue,p.shouldResolvePending,o,a,T]),A=N.useCallback((_,E)=>{v("DISPATCH",{source:E,actionType:_.type,payload:u(_)}),n(_)},[v,n,u]);return l&&(l.current=A),N.useEffect(()=>{const _=[p.phase,e.turnNumber,e.gameStatus,e.pendingStatus?.status??"none",e.pendingFrames?.length??0,o?1:0,a?1:0,T].join("|");_!==S.current&&(v("TURN_STATE"),S.current=_)},[p.phase,e.turnNumber,e.gameStatus,e.pendingStatus,e.pendingFrames,o,a,T,v]),N.useEffect(()=>(window.__HOP_TURN_TRACE=g.current,window.__HOP_DUMP_TURN_TRACE=()=>[...g.current],window.__HOP_PRINT_TURN_TRACE=(_=80)=>{const E=g.current.slice(-Math.max(1,Math.floor(_)));return console.table(E.map(w=>({id:w.id,event:w.event,turn:w.turnNumber,phase:w.phase,status:w.gameStatus,playerTurn:w.playerTurn,busy:w.isBusy,lock:w.postCommitInputLock,pending:`${w.pendingStatus}/${w.pendingFrames}`,queueHead:w.queueHead,actionLog:w.actionLogLength,details:w.details?JSON.stringify(w.details):""}))),E},window.__HOP_CLEAR_TURN_TRACE=()=>{g.current.length=0,b.current=0},g.current.push({id:++b.current,t:Date.now(),event:"TRACE_READY",turnNumber:0,phase:"INIT",gameStatus:"init",playerTurn:!1,isBusy:!1,postCommitInputLock:!1,pendingStatus:"none",pendingFrames:0,canPlayerInput:!1,shouldAdvanceQueue:!1,shouldResolvePending:!1,actionLogLength:0,queueHead:"none"}),()=>{delete window.__HOP_DUMP_TURN_TRACE,delete window.__HOP_PRINT_TURN_TRACE,delete window.__HOP_CLEAR_TURN_TRACE}),[]),{turnDriver:p,isInputLocked:h,appendTurnTrace:v,dispatchWithTrace:A}},TC=()=>{const[e,n]=N.useState(()=>window.location.pathname);N.useEffect(()=>{const a=()=>n(window.location.pathname);return window.addEventListener("popstate",a),()=>window.removeEventListener("popstate",a)},[]);const s=a=>{window.location.pathname!==a&&window.history.pushState({},"",a),n(a)},o=N.useMemo(()=>{const a=e.toLowerCase().startsWith("/hop")?"/Hop":"",l=`${a||""}`||"/",u=`${a}/Arcade`||"/Arcade",f=`${a}/Biomes`||"/Biomes",h=e.toLowerCase().replace(/\/+$/,""),g=h.endsWith("/arcade")||h.endsWith("/arcarde"),b=h.endsWith("/biomes");return{hubPath:l,arcadePath:u,biomesPath:f,isArcadeRoute:g,isBiomesRoute:b}},[e]);return{pathname:e,navigateTo:s,...o}},EC=({onSelect:e})=>y.jsxs("div",{className:"relative z-50 flex flex-col items-center justify-center p-8 gap-8 animate-in fade-in zoom-in duration-500",children:[y.jsxs("div",{className:"text-center space-y-2",children:[y.jsx("h1",{className:"text-4xl font-black uppercase tracking-widest text-white mb-2",children:"Select Class"}),y.jsx("p",{className:"text-white/40 text-sm uppercase tracking-wider",children:"Choose your combat doctrine"})]}),y.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl",children:Object.values(Vn).map(n=>y.jsxs("button",{onClick:()=>{console.log("Archetype Selected:",n.id),e(n)},className:"group relative flex flex-col items-start p-8 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/30 rounded-3xl transition-all hover:scale-[1.02] text-left cursor-pointer",children:[y.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity"}),y.jsxs("div",{className:"relative z-10 w-full",children:[y.jsxs("div",{className:"flex justify-between items-start mb-4",children:[y.jsx("div",{className:"p-3 bg-white/5 rounded-xl border border-white/10 group-hover:border-white/30 transition-colors",children:y.jsx("span",{className:"text-3xl",children:Uo(n.id==="ASSASSIN"?"assassin_player":n.id.toLowerCase(),"player").icon})}),y.jsx("div",{className:"px-3 py-1 bg-white/5 rounded-full border border-white/10 text-[10px] font-bold uppercase tracking-widest text-white/50",children:n.id==="VANGUARD"?"Standard":"Advanced"})]}),y.jsx("h3",{className:"text-2xl font-black uppercase tracking-wide text-white mb-2",children:n.name}),y.jsx("p",{className:"text-white/60 text-sm leading-relaxed mb-6 h-12",children:n.description}),y.jsxs("div",{className:"space-y-3",children:[y.jsx("div",{className:"text-[10px] uppercase tracking-widest text-white/30 font-bold border-b border-white/5 pb-1",children:"Starting Loadout"}),y.jsx("div",{className:"flex flex-wrap gap-2",children:n.startingSkills.map(s=>y.jsx("div",{className:"px-2 py-1 bg-black/40 rounded border border-white/10 text-[10px] text-blue-200",children:s.replace("_"," ")},s))})]})]})]},n.id))})]}),_C="hop_replays_v1",wC="hop_leaderboard_v1",zg=()=>{try{const e=localStorage.getItem(_C);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load replays",e),[]}},Vg=()=>{try{const e=localStorage.getItem(wC);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load leaderboard",e),[]}},Yg=e=>{const n=Array.isArray(e.actions)?e.actions:[],s=new Set(n.map(h=>h?.type)),o=s.has("ADVANCE_TURN"),a=s.has("RESOLVE_PENDING"),l=(e.floor||0)>=5&&n.length<Math.max(25,(e.floor||0)*4),u=(e.replayVersion??1)<2,f=n.length===0,p=f?"invalid replay":l?"truncated replay":u?"legacy replay":null;return{isLegacy:u,invalid:f,suspicious:l||e.floor>1&&!a,label:p,hasTurnAdvance:o,hasPendingResolve:a,actionCount:n.length}},Kg=({onStartReplay:e})=>{const[n,s]=N.useState(()=>zg()),[o,a]=N.useState(()=>Vg()),[l,u]=N.useState(""),[f,p]=N.useState(""),[h,g]=N.useState(""),[b,S]=N.useState(null);N.useEffect(()=>{const A=()=>{s(zg()),a(Vg())};return window.addEventListener("storage",A),()=>window.removeEventListener("storage",A)},[]);const T=()=>{S(null);try{const A=h.trim();if(!A)return S("Paste actions JSON first."),null;const _=JSON.parse(A);let E=l.trim()||void 0,w=f.trim()||void 0,M=[];return Array.isArray(_)?M=_:_&&typeof _=="object"&&(M=Array.isArray(_.actions)?_.actions:[],E=E||(typeof _.seed=="string"?_.seed:void 0),w=w||(typeof _.loadoutId=="string"?_.loadoutId:void 0)),!Array.isArray(M)||M.length===0?(S('No actions found. Provide a JSON action array or object with "actions".'),null):M.filter(k=>k&&typeof k.type=="string").length===0?(S('Actions must be objects with a "type" field.'),null):{id:`manual-${Date.now()}`,seed:E,loadoutId:w,actions:M,score:0,floor:1,date:new Date().toISOString(),replayVersion:2,diagnostics:{actionCount:M.length,hasTurnAdvance:M.some(k=>k?.type==="ADVANCE_TURN"),hasPendingResolve:M.some(k=>k?.type==="RESOLVE_PENDING"),suspiciouslyShort:!1}}}catch(A){return S(`Invalid JSON: ${A?.message||"parse error"}`),null}},v=()=>{const A=T();A&&e(A)};return y.jsxs("div",{className:"flex flex-col gap-8",children:[y.jsxs("section",{children:[y.jsxs("div",{className:"flex items-center justify-between mb-4",children:[y.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-emerald-400",children:"Manual Replay"}),y.jsx("span",{className:"text-[10px] text-white/20 font-bold uppercase tracking-widest",children:"Paste from UPA"})]}),y.jsxs("div",{className:"space-y-2 p-3 rounded-2xl border border-white/5 bg-white/[0.02]",children:[y.jsx("input",{value:l,onChange:A=>u(A.target.value),placeholder:"Seed (optional if included in JSON)",className:"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-emerald-400/40"}),y.jsx("input",{value:f,onChange:A=>p(A.target.value),placeholder:"Loadout ID (optional)",className:"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-emerald-400/40"}),y.jsx("textarea",{value:h,onChange:A=>g(A.target.value),placeholder:'Paste JSON actions array, or object: {"seed":"...","loadoutId":"...","actions":[...]}',rows:6,className:"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-emerald-400/40 font-mono"}),b&&y.jsx("div",{className:"text-[10px] text-red-400 font-bold uppercase tracking-wider",children:b}),y.jsx("button",{onClick:v,className:"w-full py-2 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-400/30 text-emerald-300 text-xs font-black uppercase tracking-widest transition-colors",children:"Start Manual Replay"})]})]}),y.jsxs("section",{children:[y.jsxs("div",{className:"flex items-center justify-between mb-4",children:[y.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400",children:"Hall of Fame"}),y.jsx("span",{className:"text-[10px] text-white/20 font-bold uppercase tracking-widest",children:"Top 5 Only"})]}),y.jsxs("div",{className:"space-y-2",children:[o.length===0&&y.jsx("div",{className:"p-4 rounded-xl border border-white/5 bg-white/[0.02] text-center",children:y.jsx("span",{className:"text-[10px] text-white/30 uppercase font-black",children:"No Champions Yet"})}),o.slice(0,5).map((A,_)=>{const E={id:A.id,seed:A.seed,loadoutId:A.loadoutId,actions:A.actions||[],score:A.score,floor:A.floor,date:A.date,replayVersion:A.replayVersion,diagnostics:A.diagnostics},w=Yg(E);return y.jsxs("button",{onClick:()=>e(E),className:"w-full group relative flex items-center gap-4 p-4 bg-white/[0.03] hover:bg-white/[0.07] border border-white/5 hover:border-indigo-500/30 rounded-2xl transition-all text-left",children:[y.jsx("div",{className:"flex-shrink-0 w-8 h-8 flex items-center justify-center bg-indigo-500/10 rounded-lg text-indigo-400 font-black text-sm border border-indigo-500/20",children:_+1}),y.jsxs("div",{className:"flex-1 min-w-0",children:[y.jsxs("div",{className:"flex justify-between items-center mb-0.5",children:[y.jsx("span",{className:"font-black text-white uppercase text-xs truncate tracking-wider",children:A.name}),y.jsx("span",{className:"text-[10px] font-black text-indigo-400 tabular-nums",children:A.score.toLocaleString()})]}),y.jsxs("div",{className:"text-[9px] text-white/30 font-bold uppercase tracking-widest",children:["Floor ",A.floor," * ",new Date(A.date).toLocaleDateString()," * ",w.actionCount," acts"]}),w.label&&y.jsx("div",{className:"text-[9px] mt-1 text-amber-400/80 font-bold uppercase tracking-widest",children:w.label})]}),y.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity text-indigo-400 text-xs",children:"Play"})]},A.id)})]})]}),y.jsxs("section",{children:[y.jsx("div",{className:"flex items-center justify-between mb-4",children:y.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-white/30",children:"Recent Simulations"})}),y.jsxs("div",{className:"space-y-1 max-h-[300px] overflow-y-auto custom-scrollbar pr-2",children:[n.length===0&&y.jsx("div",{className:"text-center py-4",children:y.jsx("span",{className:"text-[10px] text-white/10 uppercase font-bold",children:"Log Empty"})}),n.slice(0,10).map(A=>{const _=Yg(A);return y.jsxs("button",{onClick:()=>e(A),className:"w-full flex items-center justify-between p-3 hover:bg-white/[0.04] rounded-xl transition-colors text-left group",children:[y.jsxs("div",{className:"min-w-0",children:[y.jsxs("div",{className:"text-[10px] font-bold text-white/60 mb-0.5 truncate uppercase",children:["Score: ",y.jsx("span",{className:"text-white",children:A.score})," * F",A.floor," * ",_.actionCount," acts"]}),y.jsx("div",{className:"text-[9px] text-white/20 font-medium",children:new Date(A.date).toLocaleTimeString()}),_.label&&y.jsx("div",{className:"text-[9px] mt-1 text-amber-400/80 font-bold uppercase tracking-widest",children:_.label})]}),y.jsx("div",{className:"text-[10px] text-white/0 group-hover:text-white/40 font-black uppercase tracking-widest transition-all",children:"Replay"})]},A.id)})]})]})]})};class MC{state;constructor(){this.state=Cs(1,"tutorial-seed"),this.state.enemies=[],this.state.tiles=new Map}setPlayer(n,s){this.state.player={...this.state.player,position:n,previousPosition:n,activeSkills:s.map(o=>{const a=st.get(o);return{id:o,name:typeof a?.name=="function"?a.name(this.state):a?.name||o,description:a?.description||"",slot:a?.slot||"offensive",cooldown:a?.baseVariables.cooldown||0,currentCooldown:0,range:a?.baseVariables.range||0,upgrades:Object.keys(a?.upgrades||{}),activeUpgrades:[]}})}}spawnEnemy(n,s,o){const a=Ll(n)?.bestiary.stats;this.state.enemies.push({id:o,type:"enemy",subtype:n,position:s,previousPosition:s,hp:a?.hp??1,maxHp:a?.maxHp??1,enemyType:a?.type??"melee",statusEffects:[],temporaryArmor:0,activeSkills:[],speed:a?.speed??1,factionId:"enemy"})}spawnFalcon(n,s){const o={id:s,type:"enemy",subtype:"falcon",factionId:"player",speed:95,position:{...n},previousPosition:{...n},hp:1,maxHp:1,statusEffects:[],temporaryArmor:0,activeSkills:[],isFlying:!0,companionOf:"player",companionState:{mode:"roost",orbitStep:0,apexStrikeCooldown:0}};this.state.enemies.push(o),this.state.companions||(this.state.companions=[]),this.state.companions.push(o)}spawnCompanion(n,s,o){n==="falcon"&&this.spawnFalcon(s,o)}setTile(n,s){const o=s.toUpperCase(),a=ce(n),l=xa[o];if(!l){console.warn(`Attempted to set unknown tile type: ${o}`);return}this.state.tiles.set(a,{baseId:o,position:n,traits:new Set(l.defaultTraits||[]),effects:[],occupantId:void 0})}addUpgrade(n,s){this.state.player.activeSkills=(this.state.player.activeSkills||[]).map(o=>o.id===n?{...o,activeUpgrades:[...o.activeUpgrades,s]}:o)}useSkill(n,s){}wait(){}move(n){}getEnemy(n){return this.state.enemies.find(s=>s.id===n)}setTurn(n){this.state.turnNumber=n}exitToHub(){}applyStatus(n,s){const o=this.state.enemies.findIndex(a=>a.id===n);o!==-1&&(this.state.enemies[o]=Ud(this.state.enemies[o],s,1))}}const Fg=({onLoadScenario:e})=>{const n=Object.values(Gl),s=o=>{const a=new MC;o.setup(a),a.state.initiativeQueue=Ms(a.state),e(a.state,o.description)};return y.jsx("div",{className:"flex flex-col gap-4",children:n.map(o=>y.jsxs("div",{className:"flex flex-col gap-2",children:[y.jsx("h4",{className:"text-[10px] font-bold uppercase tracking-wider text-white/50",children:typeof o.name=="function"?o.name(Cs(1,"temp")):o.name}),y.jsx("div",{className:"flex flex-col gap-1",children:o.scenarios?.map(a=>y.jsx("button",{onClick:()=>s(a),className:"text-left px-3 py-2 bg-white/5 hover:bg-white/10 rounded text-xs text-white/80 transition-colors border border-transparent hover:border-white/20",children:a.title},a.id))})]},o.id))})},CC=({gameState:e,onSelectLoadout:n,onStartRun:s,onOpenArcade:o,onLoadScenario:a,onStartReplay:l})=>y.jsxs("div",{className:"w-full h-full flex flex-col bg-[#020617]",children:[y.jsx("header",{className:"border-b border-white/5 px-4 sm:px-6 lg:px-12 py-3 sm:py-4 bg-[#030712]/50 backdrop-blur-xl z-30",children:y.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[y.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[y.jsx("div",{className:"w-9 h-9 sm:w-10 sm:h-10 bg-indigo-500 rounded-lg flex items-center justify-center font-black text-lg sm:text-xl shadow-[0_0_20px_rgba(99,102,241,0.5)]",children:"H"}),y.jsxs("div",{children:[y.jsxs("h1",{className:"text-base sm:text-lg font-black uppercase tracking-tighter leading-none italic",children:["Hop ",y.jsx("span",{className:"text-indigo-500",children:"Engine"})]}),y.jsx("div",{className:"text-[9px] sm:text-[10px] font-bold text-white/30 tracking-[0.22em] sm:tracking-[0.3em] uppercase mt-1",children:"Strategic Hub v5.0"})]})]}),y.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6 lg:gap-8",children:[y.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.03] px-3 py-2 sm:bg-transparent sm:border-0 sm:p-0",children:[y.jsx("div",{className:"text-[10px] uppercase tracking-widest text-white/40 mb-1",children:"Current Loadout"}),y.jsx("div",{className:"text-sm font-bold text-indigo-400 truncate",children:e.selectedLoadoutId||"No Archetype Selected"})]}),e.selectedLoadoutId&&y.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:flex sm:items-center sm:gap-3",children:[y.jsxs("button",{onClick:()=>s("normal"),className:"px-4 sm:px-6 py-2.5 sm:py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-black uppercase text-xs sm:text-sm tracking-widest transition-all hover:scale-[1.02] active:scale-95 shadow-[0_0_30px_rgba(79,70,229,0.3)] flex flex-col items-center justify-center leading-tight",children:[y.jsx("span",{children:"Start Run"}),y.jsx("span",{className:"hidden sm:block text-[9px] opacity-50 tracking-[0.2em]",children:"10 Floors | Boss Defeat"})]}),y.jsxs("button",{onClick:()=>s("daily"),className:"px-4 sm:px-6 py-2.5 sm:py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-black uppercase text-xs sm:text-sm tracking-widest transition-all hover:scale-[1.02] active:scale-95 shadow-[0_0_30px_rgba(16,185,129,0.3)] flex flex-col items-center justify-center leading-tight",children:[y.jsx("span",{children:"Daily"}),y.jsx("span",{className:"hidden sm:block text-[9px] opacity-50 tracking-[0.2em]",children:"Seeded Challenge"})]})]})]})]})}),y.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden",children:[y.jsx("main",{className:"flex-1 overflow-y-auto p-4 sm:p-6 lg:p-12 custom-scrollbar",children:y.jsxs("div",{className:"max-w-4xl mx-auto",children:[y.jsxs("div",{className:"mb-6 sm:mb-10 lg:mb-12",children:[y.jsx("button",{onClick:o,className:"mb-4 sm:mb-5 w-full sm:w-auto px-5 sm:px-6 py-2.5 sm:py-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-200 font-black uppercase tracking-widest text-xs sm:text-sm transition-all",children:"Arcade Mode"}),y.jsxs("h2",{className:"text-xl sm:text-2xl lg:text-3xl font-black uppercase tracking-tighter mb-2 italic",children:["Select Your ",y.jsx("span",{className:"text-indigo-500",children:"Archetype"})]}),y.jsx("p",{className:"text-sm sm:text-base text-white/40 max-w-xl",children:"Choose your tactical specialty. Each archetype provides unique skills and modifies your core interaction with the engine."})]}),y.jsx(EC,{onSelect:n})]})}),y.jsxs("section",{className:"lg:hidden border-t border-white/5 bg-[#030712]/50 backdrop-blur-sm p-4 sm:p-6 space-y-4",children:[y.jsxs("details",{className:"rounded-2xl border border-white/10 bg-white/[0.02] p-3",children:[y.jsxs("summary",{className:"cursor-pointer list-none flex items-center justify-between",children:[y.jsx("span",{className:"text-[11px] font-black uppercase tracking-[0.2em] text-white/60",children:"Historical Replay"}),y.jsx("span",{className:"text-[10px] text-white/30 uppercase tracking-widest",children:"Optional"})]}),y.jsx("div",{className:"mt-3",children:y.jsx(Kg,{gameState:e,onStartReplay:l})})]}),y.jsxs("details",{className:"rounded-2xl border border-white/10 bg-white/[0.02] p-3",children:[y.jsxs("summary",{className:"cursor-pointer list-none flex items-center justify-between",children:[y.jsx("span",{className:"text-[11px] font-black uppercase tracking-[0.2em] text-white/60",children:"Training Simulations"}),y.jsx("span",{className:"text-[10px] text-white/30 uppercase tracking-widest",children:"Optional"})]}),y.jsx("div",{className:"mt-3",children:y.jsx(Fg,{onLoadScenario:a})})]})]}),y.jsx("aside",{className:"hidden lg:flex w-[450px] border-l border-white/5 bg-[#030712]/80 backdrop-blur-md flex-col z-20",children:y.jsxs("div",{className:"p-8 flex flex-col gap-12 h-full overflow-y-auto custom-scrollbar",children:[y.jsxs("section",{children:[y.jsxs("div",{className:"flex items-center justify-between mb-6",children:[y.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/30",children:"Historical Replay"}),y.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500 animate-pulse"})]}),y.jsx("div",{className:"bg-white/[0.02] border border-white/5 rounded-2xl p-4 overflow-hidden",children:y.jsx(Kg,{gameState:e,onStartReplay:l})})]}),y.jsxs("section",{children:[y.jsxs("div",{className:"flex items-center justify-between mb-6",children:[y.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/30",children:"Training Simulations"}),y.jsx("div",{className:"w-2 h-2 rounded-full bg-indigo-500 animate-pulse"})]}),y.jsx("div",{className:"bg-white/[0.02] border border-white/5 rounded-2xl p-4 overflow-hidden",children:y.jsx(Fg,{onLoadScenario:a})})]}),y.jsx("div",{className:"mt-auto pt-8 border-t border-white/5 opacity-20 hover:opacity-100 transition-opacity",children:y.jsx("div",{className:"text-[10px] font-bold uppercase tracking-[0.4em] mb-2 text-center text-white/50",children:"Engine Status: Online"})})]})})]})]}),OC={VANGUARD:"V",HUNTER:"H",FIREMAGE:"F",NECROMANCER:"N",SKIRMISHER:"S"},Wg=e=>{let n=2166136261;for(let s=0;s<e.length;s++)n^=e.charCodeAt(s),n+=(n<<1)+(n<<4)+(n<<7)+(n<<8)+(n<<24);return n>>>0},NC=(e=new Date)=>e.toISOString().slice(0,10),kC=(e,n)=>{if(e.length<2)throw new Error("Arcade mode requires at least two loadouts.");const o=Wg(`arcade-a:${n}`)%e.length,a=e[o],l=e.filter(h=>h.id!==a.id),f=Wg(`arcade-b:${n}`)%l.length,p=l[f];return[a,p]},RC=({onBack:e,onLaunchArcade:n})=>{const s=kn.useMemo(()=>Object.values(Vn),[]),o=kn.useMemo(()=>NC(),[]),[a,l]=kn.useMemo(()=>kC(s,o),[s,o]);return y.jsxs("div",{className:"w-full h-full flex flex-col bg-[#040a18]",children:[y.jsxs("header",{className:"h-20 border-b border-white/10 flex items-center justify-between px-12 bg-[#050b1f]/80 backdrop-blur-xl z-30",children:[y.jsxs("div",{children:[y.jsxs("h1",{className:"text-xl font-black uppercase tracking-tight italic",children:["Hop ",y.jsx("span",{className:"text-emerald-400",children:"Arcade"})]}),y.jsxs("div",{className:"text-[10px] uppercase tracking-[0.3em] text-white/40 mt-1",children:["Daily Draft ",o]})]}),y.jsx("button",{onClick:e,className:"px-5 py-2.5 rounded-xl border border-white/20 bg-white/5 hover:bg-white/10 text-xs font-black uppercase tracking-widest",children:"Back to Strategic Hub"})]}),y.jsx("main",{className:"flex-1 overflow-y-auto p-12",children:y.jsxs("div",{className:"max-w-5xl mx-auto",children:[y.jsxs("div",{className:"mb-10",children:[y.jsx("h2",{className:"text-4xl font-black uppercase tracking-tight italic mb-3",children:"Arcade Mode"}),y.jsx("p",{className:"text-white/60 max-w-3xl",children:"Pick one of two daily archetypes and run the seeded challenge. Both options share the same seed for fair comparison."})]}),y.jsx("div",{className:"flex flex-col gap-6",children:[a,l].map((u,f)=>{const p=f===1,h=OC[u.id]||u.id.slice(0,1);return y.jsx("button",{onClick:()=>n(u.id),className:"w-full text-left group rounded-3xl border border-white/10 bg-gradient-to-r from-white/[0.06] to-white/[0.02] hover:from-emerald-500/20 hover:to-cyan-500/10 transition-all p-6",children:y.jsxs("div",{className:`flex items-center justify-between gap-6 ${p?"flex-row-reverse":""}`,children:[y.jsxs("div",{className:"flex items-center gap-4 min-w-[200px]",children:[y.jsx("div",{className:`w-20 h-20 rounded-2xl border border-white/15 bg-[#0b1733] flex items-center justify-center text-4xl font-black text-emerald-300 shadow-[0_0_35px_rgba(16,185,129,0.25)] ${p?"-scale-x-100":""}`,children:h}),y.jsxs("div",{children:[y.jsx("div",{className:"text-[10px] uppercase tracking-[0.25em] text-white/40",children:"Daily Archetype"}),y.jsx("div",{className:"text-2xl font-black uppercase tracking-tight",children:u.name})]})]}),y.jsxs("div",{className:"flex-1",children:[y.jsx("div",{className:"text-[10px] uppercase tracking-[0.2em] text-white/40 mb-2",children:"Starting Skills"}),y.jsx("div",{className:"flex flex-wrap gap-2",children:u.startingSkills.slice(0,6).map(g=>y.jsx("span",{className:"text-[10px] px-2 py-1 rounded-full border border-white/20 bg-white/5 font-bold tracking-wide",children:g},g))})]}),y.jsxs("div",{className:"text-right min-w-[150px]",children:[y.jsx("div",{className:"text-[10px] uppercase tracking-[0.25em] text-white/40",children:"Launch"}),y.jsx("div",{className:"text-sm font-black uppercase tracking-widest text-emerald-300 group-hover:text-emerald-200",children:"Start Arcade Run"})]})]})},u.id)})})]})})]})},IC=({replayError:e})=>e?y.jsx("div",{className:"absolute top-4 right-4 z-40 max-w-xl px-4 py-3 rounded-xl border border-red-400/40 bg-red-900/70 text-red-100 text-xs font-bold tracking-wide",children:e}):null,F0=({tutorialInstructions:e,onDismiss:n})=>e?y.jsxs("div",{className:"absolute top-8 left-1/2 -translate-x-1/2 bg-blue-900/90 border border-blue-500/30 p-4 rounded-xl backdrop-blur-md shadow-xl z-30 max-w-lg text-center animate-in fade-in slide-in-from-top-4",children:[y.jsx("h4",{className:"text-blue-200 font-bold uppercase text-xs tracking-widest mb-1",children:"Simulation Objective"}),y.jsx("p",{className:"text-white text-sm",children:e}),y.jsx("button",{onClick:n,className:"absolute -top-2 -right-2 w-6 h-6 bg-blue-950 rounded-full border border-blue-500/50 flex items-center justify-center text-xs hover:bg-blue-800 transition-colors",children:"X"})]}):null,LC=({visible:e})=>e?y.jsx("div",{className:"absolute inset-0 z-40 pointer-events-auto",children:y.jsx("div",{className:"absolute top-3 sm:top-4 lg:top-6 left-1/2 -translate-x-1/2 h-10 w-10 rounded-full bg-black/55 border border-white/15 text-lg flex items-center justify-center text-white/80 animate-pulse","aria-label":"Resolving turn",title:"Resolving turn",children:"..."})}):null,BC=({mobileToasts:e})=>e.length===0?null:y.jsx("div",{className:"lg:hidden fixed left-1/2 -translate-x-1/2 top-16 z-50 pointer-events-none flex flex-col gap-2 w-[min(92vw,26rem)]",children:e.map(n=>{const s=n.tone==="damage"?"border-red-400/30 bg-red-950/75 text-red-100":n.tone==="heal"?"border-emerald-400/30 bg-emerald-950/70 text-emerald-100":n.tone==="status"?"border-cyan-300/30 bg-cyan-950/70 text-cyan-100":"border-white/15 bg-black/65 text-white/85";return y.jsx("div",{className:`rounded-xl border px-3 py-2 backdrop-blur-md shadow-[0_4px_20px_rgba(0,0,0,0.35)] text-xs font-bold tracking-wide ${s}`,children:n.text},n.id)})}),HC=({visible:e,onReset:n})=>e?y.jsxs("div",{className:"fixed inset-0 bg-red-950/90 backdrop-blur-xl flex flex-col items-center justify-center z-[200] transition-opacity duration-500",children:[y.jsx("div",{className:"text-8xl mb-8 animate-bounce",children:"X"}),y.jsx("h2",{className:"text-6xl font-black text-white mb-2 tracking-tighter italic uppercase",children:"Identity Deleted"}),y.jsx("p",{className:"text-red-200/60 mb-12 text-xl font-medium tracking-widest uppercase",children:"Simulation Terminated"}),y.jsx("button",{onClick:n,className:"px-12 py-4 bg-white text-black rounded-2xl font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-[0_0_50px_rgba(255,255,255,0.3)]",children:"Reinitialize Simulation"})]}):null,PC=({visible:e,score:n,onExitToHub:s})=>e?y.jsxs("div",{className:"fixed inset-0 bg-indigo-950/90 backdrop-blur-xl flex flex-col items-center justify-center z-[200] transition-opacity duration-500",children:[y.jsx("div",{className:"text-8xl mb-8 animate-bounce",children:"OK"}),y.jsx("h2",{className:"text-6xl font-black text-white mb-2 tracking-tighter italic uppercase",children:"Arcade Mode Cleared"}),y.jsx("p",{className:"text-indigo-200/60 mb-2 text-xl font-medium tracking-widest uppercase",children:"The Sentinel has fallen"}),y.jsxs("p",{className:"text-white/20 mb-12 text-sm font-bold uppercase tracking-[0.3em]",children:["Score: ",n]}),y.jsx("button",{onClick:s,className:"px-12 py-4 bg-white text-black rounded-2xl font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-[0_0_50px_rgba(255,255,255,0.3)]",children:"Return to Command Center"})]}):null,jC=({floorIntro:e})=>e?y.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[150] pointer-events-none animate-in fade-in duration-700",children:y.jsxs("div",{className:"text-center",children:[y.jsxs("div",{className:"text-indigo-500 font-black text-2xl uppercase tracking-[0.5em] mb-4 animate-in slide-in-from-bottom-8 duration-1000",children:["Floor ",e.floor]}),y.jsx("h2",{className:"text-8xl font-black text-white uppercase tracking-tighter italic animate-in slide-in-from-top-12 duration-1000",children:e.theme}),y.jsx("div",{className:"h-1 w-64 bg-white/20 mx-auto mt-8 rounded-full overflow-hidden",children:y.jsx("div",{className:"h-full bg-indigo-500 animate-[progress_3s_linear]"})})]})}):null,DC=({isReplayMode:e,replayIndex:n,replayLength:s,replayActive:o,onToggleReplay:a,onStepReplay:l,onCloseReplay:u})=>e?y.jsxs("div",{className:"fixed bottom-12 left-1/2 -translate-x-1/2 bg-[#030712]/90 border border-indigo-500/30 p-6 rounded-3xl backdrop-blur-2xl shadow-[0_0_50px_rgba(79,70,229,0.2)] z-[250] flex items-center gap-8 animate-in slide-in-from-bottom-8 duration-500",children:[y.jsxs("div",{className:"flex flex-col",children:[y.jsx("span",{className:"text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400 mb-1",children:"Replay System"}),y.jsxs("span",{className:"text-white font-bold text-sm",children:["Step ",n," / ",s]})]}),y.jsx("div",{className:"h-8 w-px bg-white/10"}),y.jsxs("div",{className:"flex items-center gap-4",children:[y.jsx("button",{onClick:a,className:`w-12 h-12 rounded-xl flex items-center justify-center transition-all ${o?"bg-indigo-500 text-white shadow-[0_0_20px_rgba(79,70,229,0.5)]":"bg-white/5 text-white/50 hover:bg-white/10"}`,children:o?"PAUSE":"PLAY"}),y.jsx("button",{onClick:l,disabled:o,className:"w-12 h-12 bg-white/5 hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-white/5 text-white rounded-xl flex items-center justify-center transition-all",children:"NEXT"})]}),y.jsx("div",{className:"h-8 w-px bg-white/10"}),y.jsx("button",{onClick:u,className:"px-6 py-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-xl font-bold uppercase text-xs tracking-widest transition-all",children:"Close"})]}):null,UC=({gameState:e,isArcadeRoute:n,hubPath:s,arcadePath:o,biomesPath:a,replayError:l,tutorialInstructions:u,navigateTo:f,onStartArcadeRun:p,onSelectLoadout:h,onStartRun:g,onLoadScenario:b,onStartReplay:S,onDismissTutorial:T})=>y.jsxs("div",{className:"w-screen h-screen bg-[#030712] overflow-hidden text-white font-['Inter',_sans-serif]",children:[!n&&y.jsx("button",{type:"button",onClick:()=>f(a),className:"absolute top-4 right-4 z-40 px-4 py-2 rounded-xl border border-cyan-300/35 bg-cyan-500/10 hover:bg-cyan-500/20 text-[10px] font-black uppercase tracking-[0.2em]",children:"Biome Sandbox"}),n?y.jsx(RC,{onBack:()=>f(s),onLaunchArcade:p}):y.jsx(CC,{gameState:e,onSelectLoadout:h,onStartRun:g,onOpenArcade:()=>f(o),onLoadScenario:b,onStartReplay:S}),y.jsx(IC,{replayError:l}),y.jsx(F0,{tutorialInstructions:u,onDismiss:T})]}),$C=({gameState:e})=>{const{initiativeQueue:n,player:s,enemies:o}=e;if(!n||!n.entries||n.entries.length===0)return null;const a=n.entries.map(l=>l.actorId===s.id?s:o.find(u=>u.id===l.actorId)).filter(l=>!!l);return y.jsxs("div",{className:"flex flex-col gap-2 p-4 bg-white/5 border border-white/10 rounded-2xl backdrop-blur-md",children:[y.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-1",children:"Turn Sequence"}),y.jsx("div",{className:"flex items-center gap-3 overflow-x-auto pb-2 scrollbar-none",children:a.map((l,u)=>{const f=l.id===s.id,p=u===n.currentIndex,g=n.entries.find(b=>b.actorId===l.id)?.hasActed;return y.jsxs("div",{className:`flex flex-col items-center shrink-0 transition-all duration-300 ${p?"scale-110":"opacity-60 scale-90"}`,children:[y.jsxs("div",{className:`
                                w-10 h-10 rounded-xl flex items-center justify-center border-2 transition-all relative
                                ${f?"bg-blue-500/20 border-blue-500/50":"bg-red-500/20 border-red-500/50"}
                                ${p?"shadow-[0_0_15px_rgba(255,255,255,0.2)] border-white/80":""}
                                ${g?"grayscale":""}
                            `,children:[y.jsx("span",{className:"text-xl",children:Uo(l.subtype,l.type,l.enemyType,l.archetype).icon}),p&&y.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-white rounded-full animate-ping"}),g&&!p&&y.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center border-2 border-[#030712] text-[8px]",children:""})]}),y.jsx("div",{className:"w-8 h-1 bg-white/10 rounded-full mt-2 overflow-hidden",children:y.jsx("div",{className:`h-full ${f?"bg-blue-400":"bg-red-400"}`,style:{width:`${l.hp/l.maxHp*100}%`}})}),y.jsx("span",{className:`text-[8px] font-bold uppercase mt-1 ${f?"text-blue-300":"text-red-300"} ${p?"text-white":""}`,children:f?"You":l.subtype||"Enemy"})]},`${l.id}-${u}`)})})]})},qC=({compact:e})=>y.jsxs("div",{className:"flex justify-between items-start",children:[y.jsxs("div",{children:[y.jsx("h1",{className:`${e?"text-base":"text-xl"} font-black uppercase tracking-widest text-white/90 mb-1`,children:"Hoplite"}),y.jsx("p",{className:"text-[10px] font-bold text-white/30 uppercase tracking-[0.2em]",children:"Tactical Arena"})]}),y.jsx("div",{className:`px-2 py-1 bg-white/10 rounded border border-white/20 text-[10px] font-black text-white/60 ${e?"hidden sm:block":""}`,children:"V2.1.0"})]}),zC=({hideInitiativeQueue:e,gameState:n})=>e?null:y.jsx($C,{gameState:n}),VC=({gameState:e,compact:n})=>y.jsxs("div",{className:n?"space-y-4":"space-y-6",children:[y.jsxs("div",{className:"flex flex-col",children:[y.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-2",children:"Vitality"}),y.jsxs("div",{className:"flex items-end gap-2",children:[y.jsx("span",{className:`${n?"text-3xl":"text-4xl"} font-black text-red-500 leading-none`,children:e.player.hp}),y.jsx("span",{className:"text-xl text-white/20 font-bold leading-none mb-1",children:"/"}),y.jsx("span",{className:"text-xl text-gray-500 font-bold leading-none mb-1",children:e.player.maxHp})]})]}),y.jsxs("div",{className:"flex flex-col",children:[y.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-2",children:"Guardian Plating"}),y.jsxs("div",{className:"flex items-center gap-3",children:[y.jsx("div",{className:`w-3 h-3 rounded-sm ${e.player.temporaryArmor?"bg-blue-400 rotate-45":"bg-white/5 border border-white/10"}`}),y.jsx("span",{className:"text-2xl font-black text-blue-400 leading-none",children:e.player.temporaryArmor||0})]})]}),e.enemies.filter(s=>s.subtype==="sentinel").map(s=>y.jsxs("div",{className:"pt-4 animate-in slide-in-from-right-8 duration-500",children:[y.jsxs("div",{className:"flex justify-between items-end mb-2",children:[y.jsx("span",{className:"text-xs font-black text-red-500 uppercase tracking-tighter italic",children:"Sentinel Directive"}),y.jsxs("span",{className:"text-lg font-black",children:[s.hp," ",y.jsxs("span",{className:"text-white/20 text-xs",children:["/ ",s.maxHp]})]})]}),y.jsx("div",{className:"h-4 w-full bg-red-950/30 rounded-md border border-red-500/20 overflow-hidden",children:y.jsx("div",{className:"h-full bg-gradient-to-r from-red-600 to-red-400 shadow-[0_0_20px_rgba(239,68,68,0.4)] transition-all duration-300",style:{width:`${s.hp/s.maxHp*100}%`}})})]},s.id))]}),YC=({compact:e,gameState:n,score:s})=>y.jsxs("div",{className:`${e?"py-4 space-y-4":"py-8 space-y-6"} border-y border-white/5`,children:[y.jsxs("div",{className:"flex flex-col gap-3",children:[y.jsxs("div",{className:"flex justify-between items-center",children:[y.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold",children:"Arcade Progress"}),y.jsxs("span",{className:"text-xl font-black",children:[n.floor," ",y.jsx("span",{className:"text-white/20 text-sm",children:"/ 10"})]})]}),y.jsx("div",{className:"h-1.5 w-full bg-white/5 rounded-full overflow-hidden border border-white/5",children:y.jsx("div",{className:"h-full bg-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.4)] transition-all duration-1000 ease-out",style:{width:`${n.floor/10*100}%`}})})]}),y.jsxs("div",{className:"flex justify-between items-center",children:[y.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold",children:"Current Score"}),y.jsx("span",{className:"text-xl font-black text-white",children:s.toLocaleString()})]})]}),KC=({compact:e,inputLocked:n,onWait:s,onReset:o,onExitToHub:a})=>y.jsxs("div",{className:`flex flex-col ${e?"gap-2":"gap-3"}`,children:[y.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-1",children:"Directives"}),y.jsxs("button",{disabled:n,onClick:s,className:`w-full flex justify-between items-center ${e?"px-3 py-2.5":"px-4 py-3"} border rounded-xl transition-all group ${n?"bg-white/[0.03] border-white/5 text-white/30 cursor-not-allowed opacity-50":"bg-white/5 hover:bg-white/10 border-white/10"}`,children:[y.jsx("span",{className:"text-sm font-bold text-white/70",children:"Secure & Wait"}),y.jsx("span",{className:"text-lg grayscale group-hover:grayscale-0 transition-all",children:"S"})]}),y.jsxs("button",{onClick:o,className:`w-full flex justify-between items-center ${e?"px-3 py-2.5":"px-4 py-3"} bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 rounded-xl transition-all group`,children:[y.jsx("span",{className:"text-sm font-bold text-red-400/80",children:"Reset Chronology"}),y.jsx("span",{className:"text-lg grayscale group-hover:grayscale-0 transition-all",children:"R"})]}),y.jsxs("button",{onClick:a,className:`w-full flex justify-between items-center ${e?"px-3 py-2.5":"px-4 py-3"} bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl transition-all group`,children:[y.jsx("span",{className:"text-sm font-bold text-white/70",children:"Return to Hub"}),y.jsx("span",{className:"text-lg grayscale group-hover:grayscale-0 transition-all",children:"H"})]})]}),FC=({gameState:e,onReset:n,onWait:s,onExitToHub:o,inputLocked:a=!1,compact:l=!1,hideInitiativeQueue:u=!1})=>{const f=s0(e);return y.jsxs("div",{className:`flex flex-col overflow-y-auto flex-1 min-h-0 ${l?"gap-4 p-4":"gap-8 p-8"}`,children:[y.jsx(qC,{compact:l}),y.jsx(zC,{gameState:e,hideInitiativeQueue:u}),y.jsx(VC,{gameState:e,compact:l}),y.jsx(YC,{gameState:e,compact:l,score:f}),y.jsx(KC,{compact:l,inputLocked:a,onWait:s,onReset:n,onExitToHub:o})]})},WC=(e,n)=>{const s=e||"",o=s.toLowerCase(),a=s.match(/^\[(INFO|VERBOSE|DEBUG|CRITICAL)\|([A-Z_]+)\]\s*(.*)$/i);if(a){const f=a[1].toLowerCase(),p=a[2].toLowerCase(),h=a[3]||"",g=p.includes("combat")?"combat":p.includes("hazard")?"hazard":p.includes("objective")||p.includes("score")?"objective":p.includes("ai")?"ai":"system";return{idx:n,raw:e,text:h,level:f,channel:g}}const l=/(attacked|killed|blast|stunned|damage|hit|healed|shield|bash|spear|fireball|jump|dash)/i.test(o)?"combat":/(lava|burn|hazard|void|sink|fire damage)/i.test(o)?"hazard":/(score|objective|floor|stairs|descending|arcade cleared)/i.test(o)?"objective":/(enemy|falcon|intent|telegraph|moves to|repositioning|attacks)/i.test(o)?"ai":"system",u=/(fallen|warning|error|failed|invalid|blocked|cannot)/i.test(o)?"critical":/(debug|trace|telemetry|seed|counter|rng)/i.test(o)?"debug":/(marks the impact zone|telegraph|planning|intent)/i.test(o)?"verbose":"info";return{idx:n,raw:e,text:s,level:u,channel:l}},GC=({compact:e=!1,levelFilter:n,channelFilter:s,onLevelFilterChange:o,onChannelFilterChange:a})=>y.jsxs("div",{className:`items-center gap-2 ${e?"hidden sm:flex":"flex"}`,children:[y.jsxs("select",{value:s,onChange:l=>a(l.target.value),className:"text-[10px] bg-white/5 border border-white/10 rounded px-2 py-1 text-white/80",children:[y.jsx("option",{value:"all",children:"All Channels"}),y.jsx("option",{value:"combat",children:"Combat"}),y.jsx("option",{value:"hazard",children:"Hazard"}),y.jsx("option",{value:"objective",children:"Objective"}),y.jsx("option",{value:"ai",children:"AI"}),y.jsx("option",{value:"system",children:"System"})]}),y.jsxs("select",{value:n,onChange:l=>o(l.target.value),className:"text-[10px] bg-white/5 border border-white/10 rounded px-2 py-1 text-white/80",children:[y.jsx("option",{value:"all",children:"All Levels"}),y.jsx("option",{value:"info",children:"Info"}),y.jsx("option",{value:"verbose",children:"Verbose"}),y.jsx("option",{value:"debug",children:"Debug"}),y.jsx("option",{value:"critical",children:"Critical"})]})]}),XC=e=>e==="critical"?"text-red-300 border-red-400/40 bg-red-500/10":e==="debug"?"text-cyan-300 border-cyan-400/40 bg-cyan-500/10":e==="verbose"?"text-amber-300 border-amber-400/40 bg-amber-500/10":"text-white/60 border-white/20 bg-white/5",JC=({entries:e,listRef:n})=>y.jsxs("div",{ref:n,className:"flex flex-col gap-2 bg-white/[0.02] border border-white/5 p-4 rounded-2xl overflow-y-auto max-h-[140px]",children:[e.slice(-20).map(s=>y.jsxs("div",{className:"flex gap-2 items-start",children:[y.jsxs("span",{className:"text-[10px] text-white/20 font-bold mt-1 leading-none shrink-0",children:["[",s.idx,"]"]}),y.jsx("span",{className:`text-[9px] mt-1 px-1.5 py-0.5 rounded border shrink-0 ${XC(s.level)}`,children:s.level.toUpperCase()}),y.jsx("span",{className:"text-[9px] mt-1 px-1.5 py-0.5 rounded border border-white/20 bg-white/5 text-white/60 shrink-0",children:s.channel.toUpperCase()}),y.jsx("p",{className:"text-[11px] leading-tight text-white/70 font-medium whitespace-pre-wrap",children:s.text})]},s.idx)),e.length===0&&y.jsx("div",{className:"text-[11px] text-white/40 italic",children:"No messages match current filters."})]}),QC=({messages:e,compact:n=!1})=>{const s=kn.useRef(null),[o,a]=kn.useState("all"),[l,u]=kn.useState("all"),f=kn.useMemo(()=>e.map((h,g)=>WC(h,g)),[e]),p=kn.useMemo(()=>f.filter(h=>(o==="all"||h.level===o)&&(l==="all"||h.channel===l)),[f,o,l]);return kn.useEffect(()=>{s.current&&(s.current.scrollTop=s.current.scrollHeight)},[p]),e.length===0?null:y.jsxs("div",{className:`${n?"p-4":"p-8"} border-t border-white/5 bg-[#030712]/80 backdrop-blur-sm`,children:[y.jsxs("div",{className:"flex items-center justify-between mb-3",children:[y.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold block",children:"Tactical Log"}),y.jsx(GC,{compact:n,levelFilter:o,channelFilter:l,onLevelFilterChange:a,onChannelFilterChange:u})]}),y.jsx(JC,{entries:p,listRef:s})]})},ZC=({gameState:e,onReset:n,onWait:s,onExitToHub:o,inputLocked:a=!1,compact:l=!1,hideInitiativeQueue:u=!1,hideLog:f=!1})=>{const p=Array.isArray(e.message)?e.message:[];return y.jsxs("div",{className:"flex flex-col h-full max-h-screen",children:[y.jsx(FC,{gameState:e,onReset:n,onWait:s,onExitToHub:o,inputLocked:a,compact:l,hideInitiativeQueue:u}),!f&&y.jsx(QC,{messages:p,compact:l})]})},eO=({onSelect:e,gameState:n})=>{const s=n.player,a=(n.pendingStatus?.shrineOptions||n.shrineOptions||["EXTRA_HP"]).map(l=>{if(l==="EXTRA_HP")return{id:"EXTRA_HP",label:"Extra Heart",desc:"Increases your Max HP by 1 and heals you to full.",color:"bg-red-900/40 border-red-500"};const u=st.getUpgrade(l),f=st.getSkillForUpgrade(l),p=s.activeSkills?.find(g=>g.id===f),h=p?.slot==="offensive"?"bg-orange-900/40 border-orange-500":p?.slot==="defensive"?"bg-blue-900/40 border-blue-500":"bg-green-900/40 border-green-500";return{id:l,label:u?u.name:l,desc:u?.description||"Unknown upgrade.",color:h}});return y.jsx("div",{className:"fixed inset-0 bg-slate-950/90 backdrop-blur-md flex items-center justify-center z-[100] p-4",children:y.jsxs("div",{className:"bg-gray-900 p-8 rounded-3xl border-2 border-slate-700 max-w-2xl w-full shadow-2xl relative overflow-hidden",children:[y.jsx("div",{className:"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 via-blue-500 to-green-500"}),y.jsx("h2",{className:"text-4xl font-black text-white mb-2 text-center tracking-tight",children:"SHRINE BLESSING"}),y.jsx("p",{className:"text-slate-400 mb-8 text-center text-lg",children:"The gods offer you a choice. Choose wisely."}),y.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:a.map(l=>y.jsxs("button",{onClick:()=>e(l.id),className:`
                                relative p-6 border-2 rounded-2xl text-left transition-all group overflow-hidden
                                hover:scale-[1.02] active:scale-[0.98]
                                ${l.color} hover:bg-slate-800
                            `,children:[y.jsx("h3",{className:"text-xl font-bold text-white mb-2 group-hover:text-blue-200",children:l.label}),y.jsx("p",{className:"text-sm text-slate-400 group-hover:text-slate-300 leading-relaxed",children:l.desc}),y.jsx("div",{className:"absolute -right-2 -bottom-2 opacity-0 group-hover:opacity-10 scale-0 group-hover:scale-150 transition-all font-bold text-4xl",children:"*"})]},l.id))})]})})},Gg=({skills:e,selectedSkillId:n,onSelectSkill:s,hasSpear:o,gameState:a,inputLocked:l=!1,compact:u=!1})=>{const f=["offensive","defensive","utility"];return y.jsx("div",{className:u?"grid grid-cols-3 gap-2 sm:grid-cols-4":"flex flex-col gap-4",children:f.flatMap(p=>e.filter(g=>g.slot===p).map(g=>{const b=n===g.id,S=g.currentCooldown>0,T=g.id==="SPEAR_THROW",v=l||S&&!T||T&&!o,A=j1(g.id),_=A?.name||g.name,E=typeof _=="function"?_(a):_,w=A?.icon||"";return y.jsxs("button",{disabled:v,onClick:()=>s(b?null:g.id),className:`
                            relative w-full ${u?"h-20 rounded-xl gap-0.5":"h-24 rounded-2xl gap-1"} flex flex-col items-center justify-center
                            border transition-all transform hover:translate-x-1
                            ${b?"bg-blue-600 border-white shadow-[0_0_20px_rgba(59,130,246,0.5)]":"bg-white/5 border-white/10 hover:border-blue-500/50"}
                            ${v?"opacity-40 grayscale pointer-events-none":"cursor-pointer"}
                        `,children:[y.jsx("span",{className:u?"text-2xl":"text-3xl",children:w}),y.jsx("span",{className:`${u?"text-[9px] tracking-[0.12em]":"text-[10px] tracking-widest"} uppercase font-bold text-white/50 text-center px-2 leading-tight`,children:E}),S&&!T&&y.jsx("div",{className:`absolute inset-0 flex items-center justify-center bg-black/40 ${u?"rounded-xl":"rounded-2xl"} backdrop-blur-[2px]`,children:y.jsx("span",{className:`${u?"text-2xl":"text-3xl"} font-black text-white`,children:g.currentCooldown})}),y.jsx("div",{className:`absolute ${u?"-top-1 left-2 px-1.5":"-top-2 left-4 px-2"} py-0.5 bg-[#030712] rounded-full border border-white/10 text-[8px] uppercase font-black tracking-widest text-white/40`,children:p})]},g.id)}))})},tO=({gameState:e,selectedSkillId:n,showMovementRange:s,isInputLocked:o,isReplayMode:a,replayActionsLength:l,replayIndex:u,replayActive:f,mobileToasts:p,tutorialInstructions:h,floorIntro:g,assetManifest:b,onSetBoardBusy:S,onTileClick:T,onSimulationEvents:v,onMirrorSnapshot:A,onReset:_,onWait:E,onExitToHub:w,onSelectSkill:M,onSelectUpgrade:C,onDismissTutorial:I,onToggleReplay:k,onStepReplay:R,onCloseReplay:$})=>y.jsxs("div",{className:"flex flex-col lg:flex-row w-screen h-screen bg-[#030712] overflow-hidden text-white font-['Inter',_sans-serif]",children:[y.jsx("div",{className:"lg:hidden shrink-0 border-b border-white/5 bg-[#030712]/95 backdrop-blur-sm z-20",children:y.jsxs("div",{className:"px-4 py-3 flex items-center justify-between gap-4",children:[y.jsxs("div",{className:"min-w-0",children:[y.jsx("div",{className:"text-[10px] uppercase tracking-[0.2em] text-white/35 font-bold",children:"Level"}),y.jsxs("div",{className:"text-lg font-black text-white leading-none",children:[e.floor,y.jsx("span",{className:"text-white/25 text-sm ml-1",children:"/ 10"})]})]}),y.jsxs("div",{className:"ml-auto min-w-0 text-right",children:[y.jsx("div",{className:"text-[10px] uppercase tracking-[0.2em] text-white/35 font-bold",children:"HP"}),y.jsxs("div",{className:"text-lg font-black text-red-400 leading-none",children:[e.player.hp,y.jsxs("span",{className:"text-white/25 text-sm ml-1",children:["/ ",e.player.maxHp]})]})]})]})}),y.jsx("aside",{className:"hidden lg:flex w-80 border-r border-white/5 bg-[#030712] flex-col z-20 overflow-y-auto",children:y.jsx(ZC,{gameState:e,onReset:_,onWait:E,onExitToHub:w,inputLocked:o})}),y.jsx("main",{className:"flex-1 min-h-0 relative flex items-center justify-center bg-[#020617] overflow-hidden",children:y.jsx("div",{className:"w-full h-full p-0 sm:p-3 lg:p-8 flex items-center justify-center",children:y.jsxs("div",{className:`w-full h-full relative border border-white/5 bg-[#030712]/50 rounded-none sm:rounded-3xl lg:rounded-[40px] shadow-[inset_0_0_100px_rgba(0,0,0,0.5)] flex items-center justify-center overflow-hidden ${e.isShaking?"animate-shake":""}`,children:[y.jsx(V0,{gameState:e,onMove:T,selectedSkillId:n,showMovementRange:s,onBusyStateChange:S,assetManifest:b,onSimulationEvents:v,onMirrorSnapshot:A}),y.jsx(LC,{visible:o&&e.gameStatus==="playing"})]})})}),y.jsx(BC,{mobileToasts:e.gameStatus==="playing"?p:[]}),y.jsx("aside",{className:"lg:hidden shrink-0 h-[26svh] min-h-[160px] max-h-[250px] border-t border-white/5 bg-[#030712] z-20 overflow-y-auto",children:y.jsxs("div",{className:"p-3 flex flex-col gap-3 h-full",children:[y.jsxs("div",{className:"flex items-center justify-between gap-2",children:[y.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-white/30",children:"Skills"}),y.jsxs("div",{className:"flex items-center gap-1.5",children:[y.jsx("button",{disabled:o,onClick:E,className:`px-2.5 py-1.5 rounded-lg border text-[10px] font-black uppercase tracking-widest ${o?"bg-white/[0.03] border-white/5 text-white/30 opacity-50":"bg-white/5 border-white/10 text-white/70 active:bg-white/10"}`,children:"Wait"}),y.jsx("button",{onClick:w,className:"px-2.5 py-1.5 rounded-lg border border-white/10 bg-white/5 text-[10px] font-black uppercase tracking-widest text-white/70 active:bg-white/10",children:"Hub"}),y.jsx("button",{onClick:_,className:"px-2.5 py-1.5 rounded-lg border border-red-500/20 bg-red-500/10 text-[10px] font-black uppercase tracking-widest text-red-300/90 active:bg-red-500/20",children:"Reset"})]})]}),y.jsx(Gg,{skills:e.player.activeSkills||[],selectedSkillId:n,onSelectSkill:M,hasSpear:e.hasSpear,gameState:e,inputLocked:o,compact:!0})]})}),y.jsx("aside",{className:"hidden lg:flex w-80 border-l border-white/5 bg-[#030712] flex-col z-20 overflow-y-auto",children:y.jsxs("div",{className:"p-6 flex flex-col gap-8 h-full",children:[y.jsxs("div",{className:"flex-1",children:[y.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/30 mb-6",children:"Tactical Skills"}),y.jsx(Gg,{skills:e.player.activeSkills||[],selectedSkillId:n,onSelectSkill:M,hasSpear:e.hasSpear,gameState:e,inputLocked:o})]}),y.jsx("div",{className:"pt-8 border-t border-white/5 text-center",children:y.jsx("div",{className:"text-[10px] font-bold uppercase tracking-widest text-white/20",children:"Hop Engine v5.0"})})]})}),y.jsx(F0,{tutorialInstructions:h,onDismiss:I}),e.gameStatus==="choosing_upgrade"&&y.jsx(eO,{onSelect:C,gameState:e}),y.jsx(HC,{visible:e.gameStatus==="lost",onReset:_}),y.jsx(PC,{visible:e.gameStatus==="won",score:e.completedRun?.score||0,onExitToHub:w}),y.jsx(jC,{floorIntro:g}),y.jsx(DC,{isReplayMode:a,replayIndex:u,replayLength:l,replayActive:f,onToggleReplay:k,onStepReplay:R,onCloseReplay:$})]}),nO=e=>{const n=e.payload;if(!(!n||typeof n!="object")){if("q"in n&&"r"in n)return{q:Number(n.q??0),r:Number(n.r??0),s:Number(n.s??0)};if(e.type==="USE_SKILL"){const s=n;return{skillId:s.skillId??"unknown",target:s.target?{q:s.target.q,r:s.target.r,s:s.target.s}:null}}if(e.type==="START_RUN")return{loadoutId:n.loadoutId??"unknown",mode:n.mode??"normal"};if(e.type==="LOAD_STATE"){const s=n;return{floor:s?.floor??0,gameStatus:s?.gameStatus??"unknown",turnNumber:s?.turnNumber??0,queueLength:Array.isArray(s?.initiativeQueue)?s.initiativeQueue.length:0}}return{}}};function iO(){const{hubPath:e,arcadePath:n,biomesPath:s,isArcadeRoute:o,isBiomesRoute:a,navigateTo:l}=TC(),[u,f]=mC(),p=typeof window<"u"&&!!window.__HOP_DEBUG_QUERY,h=rC();cC(u,p);const g=N.useRef(()=>{}),b=N.useCallback((Ne,et)=>{g.current(Ne,et)},[]),{isReplayMode:S,replayActions:T,replayActive:v,replayError:A,replayIndexRef:_,setReplayActive:E,resetReplayUi:w,startReplay:M,stepReplay:C}=pC({dispatchWithTrace:b});lC([u.gameStatus,S]);const[I,k]=N.useState(null),[R,$]=N.useState(!1),[j,D]=N.useState(!1),[q,se]=N.useState(!1),{turnDriver:ee,isInputLocked:oe,appendTurnTrace:F,dispatchWithTrace:H}=AC({gameState:u,dispatch:f,isReplayMode:S,isBusy:j,postCommitInputLock:q,dispatchWithTraceProxyRef:g,summarizeActionPayload:nO}),{mobileToasts:z,handleSimulationEvents:Z,handleUiMirrorSnapshot:re}=gC({gameState:u,appendTurnTrace:F}),{armPostCommitLock:pe}=vC({gameState:u,turnDriver:ee,isBusy:j,isReplayMode:S,postCommitInputLock:q,setPostCommitInputLock:se,appendTurnTrace:F,dispatchWithTrace:H}),[B,W]=N.useState(null),G=uC(u);yC(u,S);const ae=Ne=>{oe||k(Ne)},le=Ne=>{if(!oe){if(I){pe(),H({type:"USE_SKILL",payload:{skillId:I,target:Ne}},"player_use_skill"),k(null);return}if(Q(Ne,u.player.position)){$(!R);return}pe(),H({type:"MOVE",payload:Ne},"player_move"),$(!1)}},ue=Ne=>{S||j||H({type:"SELECT_UPGRADE",payload:Ne},"upgrade_select")},be=()=>{H({type:"RESET"},"reset"),k(null),w()},$e=()=>{oe||(pe(),H({type:"WAIT"},"player_wait"),k(null))},Ee=()=>{ot()},at=(Ne,et)=>{H({type:"LOAD_STATE",payload:Ne},"scenario_load"),W(et),k(null)},ot=()=>{H({type:"EXIT_TO_HUB"},"exit_to_hub"),k(null),w(),l(e)},Nt=Ne=>{const et=u.selectedLoadoutId;if(!et){console.warn("Start Run called without a selected loadout.");return}H({type:"START_RUN",payload:{loadoutId:et,mode:Ne}},"hub_start_run")},Mt=Ne=>{H({type:"START_RUN",payload:{loadoutId:Ne,mode:"daily"}},"arcade_start_run"),l(e)};return a?y.jsx(oC,{assetManifest:h,onBack:()=>l(e)}):u.gameStatus==="hub"?y.jsx(UC,{gameState:u,isArcadeRoute:o,hubPath:e,arcadePath:n,biomesPath:s,replayError:A,tutorialInstructions:B,navigateTo:l,onStartArcadeRun:Mt,onSelectLoadout:Ne=>{H({type:"APPLY_LOADOUT",payload:Ne},"hub_select_loadout")},onStartRun:Nt,onLoadScenario:at,onStartReplay:M,onDismissTutorial:()=>W(null)}):y.jsx(tO,{gameState:u,selectedSkillId:I,showMovementRange:R,isInputLocked:oe,isReplayMode:S,replayActionsLength:T.length,replayIndex:_.current,replayActive:v,mobileToasts:z,tutorialInstructions:B,floorIntro:G,assetManifest:h,onSetBoardBusy:D,onTileClick:le,onSimulationEvents:Z,onMirrorSnapshot:re,onReset:be,onWait:$e,onExitToHub:ot,onSelectSkill:ae,onSelectUpgrade:ue,onDismissTutorial:()=>W(null),onToggleReplay:()=>E(!v),onStepReplay:C,onCloseReplay:Ee})}hv.createRoot(document.getElementById("root")).render(y.jsx(N.StrictMode,{children:y.jsx(iO,{})}));
