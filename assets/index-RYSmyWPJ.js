(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))o(c);new MutationObserver(c=>{for(const r of c)if(r.type==="childList")for(const f of r.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&o(f)}).observe(document,{childList:!0,subtree:!0});function a(c){const r={};return c.integrity&&(r.integrity=c.integrity),c.referrerPolicy&&(r.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?r.credentials="include":c.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(c){if(c.ep)return;c.ep=!0;const r=a(c);fetch(c.href,r)}})();function Hb(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Gd={exports:{}},Ul={};var cg;function Pb(){if(cg)return Ul;cg=1;var e=Symbol.for("react.transitional.element"),i=Symbol.for("react.fragment");function a(o,c,r){var f=null;if(r!==void 0&&(f=""+r),c.key!==void 0&&(f=""+c.key),"key"in c){r={};for(var h in c)h!=="key"&&(r[h]=c[h])}else r=c;return c=r.ref,{$$typeof:e,type:o,key:f,ref:c!==void 0?c:null,props:r}}return Ul.Fragment=i,Ul.jsx=a,Ul.jsxs=a,Ul}var ug;function Ub(){return ug||(ug=1,Gd.exports=Pb()),Gd.exports}var m=Ub(),Wd={exports:{}},Be={};var dg;function qb(){if(dg)return Be;dg=1;var e=Symbol.for("react.transitional.element"),i=Symbol.for("react.portal"),a=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),c=Symbol.for("react.profiler"),r=Symbol.for("react.consumer"),f=Symbol.for("react.context"),h=Symbol.for("react.forward_ref"),b=Symbol.for("react.suspense"),y=Symbol.for("react.memo"),A=Symbol.for("react.lazy"),v=Symbol.for("react.activity"),S=Symbol.iterator;function _(k){return k===null||typeof k!="object"?null:(k=S&&k[S]||k["@@iterator"],typeof k=="function"?k:null)}var p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},g=Object.assign,R={};function I(k,$,J){this.props=k,this.context=$,this.refs=R,this.updater=J||p}I.prototype.isReactComponent={},I.prototype.setState=function(k,$){if(typeof k!="object"&&typeof k!="function"&&k!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,k,$,"setState")},I.prototype.forceUpdate=function(k){this.updater.enqueueForceUpdate(this,k,"forceUpdate")};function C(){}C.prototype=I.prototype;function M(k,$,J){this.props=k,this.context=$,this.refs=R,this.updater=J||p}var N=M.prototype=new C;N.constructor=M,g(N,I.prototype),N.isPureReactComponent=!0;var Y=Array.isArray;function X(){}var O={H:null,A:null,T:null,S:null},q=Object.prototype.hasOwnProperty;function K(k,$,J){var me=J.ref;return{$$typeof:e,type:k,key:$,ref:me!==void 0?me:null,props:J}}function ue(k,$){return K(k.type,$,k.props)}function W(k){return typeof k=="object"&&k!==null&&k.$$typeof===e}function _e(k){var $={"=":"=0",":":"=2"};return"$"+k.replace(/[=:]/g,function(J){return $[J]})}var oe=/\/+/g;function be(k,$){return typeof k=="object"&&k!==null&&k.key!=null?_e(""+k.key):$.toString(36)}function pe(k){switch(k.status){case"fulfilled":return k.value;case"rejected":throw k.reason;default:switch(typeof k.status=="string"?k.then(X,X):(k.status="pending",k.then(function($){k.status==="pending"&&(k.status="fulfilled",k.value=$)},function($){k.status==="pending"&&(k.status="rejected",k.reason=$)})),k.status){case"fulfilled":return k.value;case"rejected":throw k.reason}}throw k}function H(k,$,J,me,Me){var ke=typeof k;(ke==="undefined"||ke==="boolean")&&(k=null);var Ie=!1;if(k===null)Ie=!0;else switch(ke){case"bigint":case"string":case"number":Ie=!0;break;case"object":switch(k.$$typeof){case e:case i:Ie=!0;break;case A:return Ie=k._init,H(Ie(k._payload),$,J,me,Me)}}if(Ie)return Me=Me(k),Ie=me===""?"."+be(k,0):me,Y(Me)?(J="",Ie!=null&&(J=Ie.replace(oe,"$&/")+"/"),H(Me,$,J,"",function(Rt){return Rt})):Me!=null&&(W(Me)&&(Me=ue(Me,J+(Me.key==null||k&&k.key===Me.key?"":(""+Me.key).replace(oe,"$&/")+"/")+Ie)),$.push(Me)),1;Ie=0;var pt=me===""?".":me+":";if(Y(k))for(var ze=0;ze<k.length;ze++)me=k[ze],ke=pt+be(me,ze),Ie+=H(me,$,J,ke,Me);else if(ze=_(k),typeof ze=="function")for(k=ze.call(k),ze=0;!(me=k.next()).done;)me=me.value,ke=pt+be(me,ze++),Ie+=H(me,$,J,ke,Me);else if(ke==="object"){if(typeof k.then=="function")return H(pe(k),$,J,me,Me);throw $=String(k),Error("Objects are not valid as a React child (found: "+($==="[object Object]"?"object with keys {"+Object.keys(k).join(", ")+"}":$)+"). If you meant to render a collection of children, use an array instead.")}return Ie}function ee(k,$,J){if(k==null)return k;var me=[],Me=0;return H(k,me,"","",function(ke){return $.call(J,ke,Me++)}),me}function ae(k){if(k._status===-1){var $=k._result;$=$(),$.then(function(J){(k._status===0||k._status===-1)&&(k._status=1,k._result=J)},function(J){(k._status===0||k._status===-1)&&(k._status=2,k._result=J)}),k._status===-1&&(k._status=0,k._result=$)}if(k._status===1)return k._result.default;throw k._result}var Te=typeof reportError=="function"?reportError:function(k){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var $=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof k=="object"&&k!==null&&typeof k.message=="string"?String(k.message):String(k),error:k});if(!window.dispatchEvent($))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",k);return}console.error(k)},xe={map:ee,forEach:function(k,$,J){ee(k,function(){$.apply(this,arguments)},J)},count:function(k){var $=0;return ee(k,function(){$++}),$},toArray:function(k){return ee(k,function($){return $})||[]},only:function(k){if(!W(k))throw Error("React.Children.only expected to receive a single React element child.");return k}};return Be.Activity=v,Be.Children=xe,Be.Component=I,Be.Fragment=a,Be.Profiler=c,Be.PureComponent=M,Be.StrictMode=o,Be.Suspense=b,Be.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=O,Be.__COMPILER_RUNTIME={__proto__:null,c:function(k){return O.H.useMemoCache(k)}},Be.cache=function(k){return function(){return k.apply(null,arguments)}},Be.cacheSignal=function(){return null},Be.cloneElement=function(k,$,J){if(k==null)throw Error("The argument must be a React element, but you passed "+k+".");var me=g({},k.props),Me=k.key;if($!=null)for(ke in $.key!==void 0&&(Me=""+$.key),$)!q.call($,ke)||ke==="key"||ke==="__self"||ke==="__source"||ke==="ref"&&$.ref===void 0||(me[ke]=$[ke]);var ke=arguments.length-2;if(ke===1)me.children=J;else if(1<ke){for(var Ie=Array(ke),pt=0;pt<ke;pt++)Ie[pt]=arguments[pt+2];me.children=Ie}return K(k.type,Me,me)},Be.createContext=function(k){return k={$$typeof:f,_currentValue:k,_currentValue2:k,_threadCount:0,Provider:null,Consumer:null},k.Provider=k,k.Consumer={$$typeof:r,_context:k},k},Be.createElement=function(k,$,J){var me,Me={},ke=null;if($!=null)for(me in $.key!==void 0&&(ke=""+$.key),$)q.call($,me)&&me!=="key"&&me!=="__self"&&me!=="__source"&&(Me[me]=$[me]);var Ie=arguments.length-2;if(Ie===1)Me.children=J;else if(1<Ie){for(var pt=Array(Ie),ze=0;ze<Ie;ze++)pt[ze]=arguments[ze+2];Me.children=pt}if(k&&k.defaultProps)for(me in Ie=k.defaultProps,Ie)Me[me]===void 0&&(Me[me]=Ie[me]);return K(k,ke,Me)},Be.createRef=function(){return{current:null}},Be.forwardRef=function(k){return{$$typeof:h,render:k}},Be.isValidElement=W,Be.lazy=function(k){return{$$typeof:A,_payload:{_status:-1,_result:k},_init:ae}},Be.memo=function(k,$){return{$$typeof:y,type:k,compare:$===void 0?null:$}},Be.startTransition=function(k){var $=O.T,J={};O.T=J;try{var me=k(),Me=O.S;Me!==null&&Me(J,me),typeof me=="object"&&me!==null&&typeof me.then=="function"&&me.then(X,Te)}catch(ke){Te(ke)}finally{$!==null&&J.types!==null&&($.types=J.types),O.T=$}},Be.unstable_useCacheRefresh=function(){return O.H.useCacheRefresh()},Be.use=function(k){return O.H.use(k)},Be.useActionState=function(k,$,J){return O.H.useActionState(k,$,J)},Be.useCallback=function(k,$){return O.H.useCallback(k,$)},Be.useContext=function(k){return O.H.useContext(k)},Be.useDebugValue=function(){},Be.useDeferredValue=function(k,$){return O.H.useDeferredValue(k,$)},Be.useEffect=function(k,$){return O.H.useEffect(k,$)},Be.useEffectEvent=function(k){return O.H.useEffectEvent(k)},Be.useId=function(){return O.H.useId()},Be.useImperativeHandle=function(k,$,J){return O.H.useImperativeHandle(k,$,J)},Be.useInsertionEffect=function(k,$){return O.H.useInsertionEffect(k,$)},Be.useLayoutEffect=function(k,$){return O.H.useLayoutEffect(k,$)},Be.useMemo=function(k,$){return O.H.useMemo(k,$)},Be.useOptimistic=function(k,$){return O.H.useOptimistic(k,$)},Be.useReducer=function(k,$,J){return O.H.useReducer(k,$,J)},Be.useRef=function(k){return O.H.useRef(k)},Be.useState=function(k){return O.H.useState(k)},Be.useSyncExternalStore=function(k,$,J){return O.H.useSyncExternalStore(k,$,J)},Be.useTransition=function(){return O.H.useTransition()},Be.version="19.2.3",Be}var fg;function Lf(){return fg||(fg=1,Wd.exports=qb()),Wd.exports}var w=Lf();const $i=Hb(w);var Xd={exports:{}},ql={},Qd={exports:{}},Jd={};var mg;function zb(){return mg||(mg=1,(function(e){function i(H,ee){var ae=H.length;H.push(ee);e:for(;0<ae;){var Te=ae-1>>>1,xe=H[Te];if(0<c(xe,ee))H[Te]=ee,H[ae]=xe,ae=Te;else break e}}function a(H){return H.length===0?null:H[0]}function o(H){if(H.length===0)return null;var ee=H[0],ae=H.pop();if(ae!==ee){H[0]=ae;e:for(var Te=0,xe=H.length,k=xe>>>1;Te<k;){var $=2*(Te+1)-1,J=H[$],me=$+1,Me=H[me];if(0>c(J,ae))me<xe&&0>c(Me,J)?(H[Te]=Me,H[me]=ae,Te=me):(H[Te]=J,H[$]=ae,Te=$);else if(me<xe&&0>c(Me,ae))H[Te]=Me,H[me]=ae,Te=me;else break e}}return ee}function c(H,ee){var ae=H.sortIndex-ee.sortIndex;return ae!==0?ae:H.id-ee.id}if(e.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var r=performance;e.unstable_now=function(){return r.now()}}else{var f=Date,h=f.now();e.unstable_now=function(){return f.now()-h}}var b=[],y=[],A=1,v=null,S=3,_=!1,p=!1,g=!1,R=!1,I=typeof setTimeout=="function"?setTimeout:null,C=typeof clearTimeout=="function"?clearTimeout:null,M=typeof setImmediate<"u"?setImmediate:null;function N(H){for(var ee=a(y);ee!==null;){if(ee.callback===null)o(y);else if(ee.startTime<=H)o(y),ee.sortIndex=ee.expirationTime,i(b,ee);else break;ee=a(y)}}function Y(H){if(g=!1,N(H),!p)if(a(b)!==null)p=!0,X||(X=!0,_e());else{var ee=a(y);ee!==null&&pe(Y,ee.startTime-H)}}var X=!1,O=-1,q=5,K=-1;function ue(){return R?!0:!(e.unstable_now()-K<q)}function W(){if(R=!1,X){var H=e.unstable_now();K=H;var ee=!0;try{e:{p=!1,g&&(g=!1,C(O),O=-1),_=!0;var ae=S;try{t:{for(N(H),v=a(b);v!==null&&!(v.expirationTime>H&&ue());){var Te=v.callback;if(typeof Te=="function"){v.callback=null,S=v.priorityLevel;var xe=Te(v.expirationTime<=H);if(H=e.unstable_now(),typeof xe=="function"){v.callback=xe,N(H),ee=!0;break t}v===a(b)&&o(b),N(H)}else o(b);v=a(b)}if(v!==null)ee=!0;else{var k=a(y);k!==null&&pe(Y,k.startTime-H),ee=!1}}break e}finally{v=null,S=ae,_=!1}ee=void 0}}finally{ee?_e():X=!1}}}var _e;if(typeof M=="function")_e=function(){M(W)};else if(typeof MessageChannel<"u"){var oe=new MessageChannel,be=oe.port2;oe.port1.onmessage=W,_e=function(){be.postMessage(null)}}else _e=function(){I(W,0)};function pe(H,ee){O=I(function(){H(e.unstable_now())},ee)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(H){H.callback=null},e.unstable_forceFrameRate=function(H){0>H||125<H?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):q=0<H?Math.floor(1e3/H):5},e.unstable_getCurrentPriorityLevel=function(){return S},e.unstable_next=function(H){switch(S){case 1:case 2:case 3:var ee=3;break;default:ee=S}var ae=S;S=ee;try{return H()}finally{S=ae}},e.unstable_requestPaint=function(){R=!0},e.unstable_runWithPriority=function(H,ee){switch(H){case 1:case 2:case 3:case 4:case 5:break;default:H=3}var ae=S;S=H;try{return ee()}finally{S=ae}},e.unstable_scheduleCallback=function(H,ee,ae){var Te=e.unstable_now();switch(typeof ae=="object"&&ae!==null?(ae=ae.delay,ae=typeof ae=="number"&&0<ae?Te+ae:Te):ae=Te,H){case 1:var xe=-1;break;case 2:xe=250;break;case 5:xe=1073741823;break;case 4:xe=1e4;break;default:xe=5e3}return xe=ae+xe,H={id:A++,callback:ee,priorityLevel:H,startTime:ae,expirationTime:xe,sortIndex:-1},ae>Te?(H.sortIndex=ae,i(y,H),a(b)===null&&H===a(y)&&(g?(C(O),O=-1):g=!0,pe(Y,ae-Te))):(H.sortIndex=xe,i(b,H),p||_||(p=!0,X||(X=!0,_e()))),H},e.unstable_shouldYield=ue,e.unstable_wrapCallback=function(H){var ee=S;return function(){var ae=S;S=ee;try{return H.apply(this,arguments)}finally{S=ae}}}})(Jd)),Jd}var pg;function $b(){return pg||(pg=1,Qd.exports=zb()),Qd.exports}var Zd={exports:{}},Pn={};var hg;function Vb(){if(hg)return Pn;hg=1;var e=Lf();function i(b){var y="https://react.dev/errors/"+b;if(1<arguments.length){y+="?args[]="+encodeURIComponent(arguments[1]);for(var A=2;A<arguments.length;A++)y+="&args[]="+encodeURIComponent(arguments[A])}return"Minified React error #"+b+"; visit "+y+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function a(){}var o={d:{f:a,r:function(){throw Error(i(522))},D:a,C:a,L:a,m:a,X:a,S:a,M:a},p:0,findDOMNode:null},c=Symbol.for("react.portal");function r(b,y,A){var v=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:c,key:v==null?null:""+v,children:b,containerInfo:y,implementation:A}}var f=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function h(b,y){if(b==="font")return"";if(typeof y=="string")return y==="use-credentials"?y:""}return Pn.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=o,Pn.createPortal=function(b,y){var A=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!y||y.nodeType!==1&&y.nodeType!==9&&y.nodeType!==11)throw Error(i(299));return r(b,y,null,A)},Pn.flushSync=function(b){var y=f.T,A=o.p;try{if(f.T=null,o.p=2,b)return b()}finally{f.T=y,o.p=A,o.d.f()}},Pn.preconnect=function(b,y){typeof b=="string"&&(y?(y=y.crossOrigin,y=typeof y=="string"?y==="use-credentials"?y:"":void 0):y=null,o.d.C(b,y))},Pn.prefetchDNS=function(b){typeof b=="string"&&o.d.D(b)},Pn.preinit=function(b,y){if(typeof b=="string"&&y&&typeof y.as=="string"){var A=y.as,v=h(A,y.crossOrigin),S=typeof y.integrity=="string"?y.integrity:void 0,_=typeof y.fetchPriority=="string"?y.fetchPriority:void 0;A==="style"?o.d.S(b,typeof y.precedence=="string"?y.precedence:void 0,{crossOrigin:v,integrity:S,fetchPriority:_}):A==="script"&&o.d.X(b,{crossOrigin:v,integrity:S,fetchPriority:_,nonce:typeof y.nonce=="string"?y.nonce:void 0})}},Pn.preinitModule=function(b,y){if(typeof b=="string")if(typeof y=="object"&&y!==null){if(y.as==null||y.as==="script"){var A=h(y.as,y.crossOrigin);o.d.M(b,{crossOrigin:A,integrity:typeof y.integrity=="string"?y.integrity:void 0,nonce:typeof y.nonce=="string"?y.nonce:void 0})}}else y==null&&o.d.M(b)},Pn.preload=function(b,y){if(typeof b=="string"&&typeof y=="object"&&y!==null&&typeof y.as=="string"){var A=y.as,v=h(A,y.crossOrigin);o.d.L(b,A,{crossOrigin:v,integrity:typeof y.integrity=="string"?y.integrity:void 0,nonce:typeof y.nonce=="string"?y.nonce:void 0,type:typeof y.type=="string"?y.type:void 0,fetchPriority:typeof y.fetchPriority=="string"?y.fetchPriority:void 0,referrerPolicy:typeof y.referrerPolicy=="string"?y.referrerPolicy:void 0,imageSrcSet:typeof y.imageSrcSet=="string"?y.imageSrcSet:void 0,imageSizes:typeof y.imageSizes=="string"?y.imageSizes:void 0,media:typeof y.media=="string"?y.media:void 0})}},Pn.preloadModule=function(b,y){if(typeof b=="string")if(y){var A=h(y.as,y.crossOrigin);o.d.m(b,{as:typeof y.as=="string"&&y.as!=="script"?y.as:void 0,crossOrigin:A,integrity:typeof y.integrity=="string"?y.integrity:void 0})}else o.d.m(b)},Pn.requestFormReset=function(b){o.d.r(b)},Pn.unstable_batchedUpdates=function(b,y){return b(y)},Pn.useFormState=function(b,y,A){return f.H.useFormState(b,y,A)},Pn.useFormStatus=function(){return f.H.useHostTransitionStatus()},Pn.version="19.2.3",Pn}var gg;function Yb(){if(gg)return Zd.exports;gg=1;function e(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(i){console.error(i)}}return e(),Zd.exports=Vb(),Zd.exports}var yg;function Fb(){if(yg)return ql;yg=1;var e=$b(),i=Lf(),a=Yb();function o(t){var n="https://react.dev/errors/"+t;if(1<arguments.length){n+="?args[]="+encodeURIComponent(arguments[1]);for(var s=2;s<arguments.length;s++)n+="&args[]="+encodeURIComponent(arguments[s])}return"Minified React error #"+t+"; visit "+n+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function c(t){return!(!t||t.nodeType!==1&&t.nodeType!==9&&t.nodeType!==11)}function r(t){var n=t,s=t;if(t.alternate)for(;n.return;)n=n.return;else{t=n;do n=t,(n.flags&4098)!==0&&(s=n.return),t=n.return;while(t)}return n.tag===3?s:null}function f(t){if(t.tag===13){var n=t.memoizedState;if(n===null&&(t=t.alternate,t!==null&&(n=t.memoizedState)),n!==null)return n.dehydrated}return null}function h(t){if(t.tag===31){var n=t.memoizedState;if(n===null&&(t=t.alternate,t!==null&&(n=t.memoizedState)),n!==null)return n.dehydrated}return null}function b(t){if(r(t)!==t)throw Error(o(188))}function y(t){var n=t.alternate;if(!n){if(n=r(t),n===null)throw Error(o(188));return n!==t?null:t}for(var s=t,l=n;;){var u=s.return;if(u===null)break;var d=u.alternate;if(d===null){if(l=u.return,l!==null){s=l;continue}break}if(u.child===d.child){for(d=u.child;d;){if(d===s)return b(u),t;if(d===l)return b(u),n;d=d.sibling}throw Error(o(188))}if(s.return!==l.return)s=u,l=d;else{for(var x=!1,T=u.child;T;){if(T===s){x=!0,s=u,l=d;break}if(T===l){x=!0,l=u,s=d;break}T=T.sibling}if(!x){for(T=d.child;T;){if(T===s){x=!0,s=d,l=u;break}if(T===l){x=!0,l=d,s=u;break}T=T.sibling}if(!x)throw Error(o(189))}}if(s.alternate!==l)throw Error(o(190))}if(s.tag!==3)throw Error(o(188));return s.stateNode.current===s?t:n}function A(t){var n=t.tag;if(n===5||n===26||n===27||n===6)return t;for(t=t.child;t!==null;){if(n=A(t),n!==null)return n;t=t.sibling}return null}var v=Object.assign,S=Symbol.for("react.element"),_=Symbol.for("react.transitional.element"),p=Symbol.for("react.portal"),g=Symbol.for("react.fragment"),R=Symbol.for("react.strict_mode"),I=Symbol.for("react.profiler"),C=Symbol.for("react.consumer"),M=Symbol.for("react.context"),N=Symbol.for("react.forward_ref"),Y=Symbol.for("react.suspense"),X=Symbol.for("react.suspense_list"),O=Symbol.for("react.memo"),q=Symbol.for("react.lazy"),K=Symbol.for("react.activity"),ue=Symbol.for("react.memo_cache_sentinel"),W=Symbol.iterator;function _e(t){return t===null||typeof t!="object"?null:(t=W&&t[W]||t["@@iterator"],typeof t=="function"?t:null)}var oe=Symbol.for("react.client.reference");function be(t){if(t==null)return null;if(typeof t=="function")return t.$$typeof===oe?null:t.displayName||t.name||null;if(typeof t=="string")return t;switch(t){case g:return"Fragment";case I:return"Profiler";case R:return"StrictMode";case Y:return"Suspense";case X:return"SuspenseList";case K:return"Activity"}if(typeof t=="object")switch(t.$$typeof){case p:return"Portal";case M:return t.displayName||"Context";case C:return(t._context.displayName||"Context")+".Consumer";case N:var n=t.render;return t=t.displayName,t||(t=n.displayName||n.name||"",t=t!==""?"ForwardRef("+t+")":"ForwardRef"),t;case O:return n=t.displayName||null,n!==null?n:be(t.type)||"Memo";case q:n=t._payload,t=t._init;try{return be(t(n))}catch{}}return null}var pe=Array.isArray,H=i.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,ee=a.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,ae={pending:!1,data:null,method:null,action:null},Te=[],xe=-1;function k(t){return{current:t}}function $(t){0>xe||(t.current=Te[xe],Te[xe]=null,xe--)}function J(t,n){xe++,Te[xe]=t.current,t.current=n}var me=k(null),Me=k(null),ke=k(null),Ie=k(null);function pt(t,n){switch(J(ke,n),J(Me,t),J(me,null),n.nodeType){case 9:case 11:t=(t=n.documentElement)&&(t=t.namespaceURI)?kh(t):0;break;default:if(t=n.tagName,n=n.namespaceURI)n=kh(n),t=Lh(n,t);else switch(t){case"svg":t=1;break;case"math":t=2;break;default:t=0}}$(me),J(me,t)}function ze(){$(me),$(Me),$(ke)}function Rt(t){t.memoizedState!==null&&J(Ie,t);var n=me.current,s=Lh(n,t.type);n!==s&&(J(Me,t),J(me,s))}function qn(t){Me.current===t&&($(me),$(Me)),Ie.current===t&&($(Ie),jl._currentValue=ae)}var St,Gt;function _t(t){if(St===void 0)try{throw Error()}catch(s){var n=s.stack.trim().match(/\n( *(at )?)/);St=n&&n[1]||"",Gt=-1<s.stack.indexOf(`
    at`)?" (<anonymous>)":-1<s.stack.indexOf("@")?"@unknown:0:0":""}return`
`+St+t+Gt}var zn=!1;function ai(t,n){if(!t||zn)return"";zn=!0;var s=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var l={DetermineComponentFrameRoot:function(){try{if(n){var ie=function(){throw Error()};if(Object.defineProperty(ie.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(ie,[])}catch(G){var V=G}Reflect.construct(t,[],ie)}else{try{ie.call()}catch(G){V=G}t.call(ie.prototype)}}else{try{throw Error()}catch(G){V=G}(ie=t())&&typeof ie.catch=="function"&&ie.catch(function(){})}}catch(G){if(G&&V&&typeof G.stack=="string")return[G.stack,V.stack]}return[null,null]}};l.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var u=Object.getOwnPropertyDescriptor(l.DetermineComponentFrameRoot,"name");u&&u.configurable&&Object.defineProperty(l.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var d=l.DetermineComponentFrameRoot(),x=d[0],T=d[1];if(x&&T){var L=x.split(`
`),U=T.split(`
`);for(u=l=0;l<L.length&&!L[l].includes("DetermineComponentFrameRoot");)l++;for(;u<U.length&&!U[u].includes("DetermineComponentFrameRoot");)u++;if(l===L.length||u===U.length)for(l=L.length-1,u=U.length-1;1<=l&&0<=u&&L[l]!==U[u];)u--;for(;1<=l&&0<=u;l--,u--)if(L[l]!==U[u]){if(l!==1||u!==1)do if(l--,u--,0>u||L[l]!==U[u]){var Q=`
`+L[l].replace(" at new "," at ");return t.displayName&&Q.includes("<anonymous>")&&(Q=Q.replace("<anonymous>",t.displayName)),Q}while(1<=l&&0<=u);break}}}finally{zn=!1,Error.prepareStackTrace=s}return(s=t?t.displayName||t.name:"")?_t(s):""}function Ve(t,n){switch(t.tag){case 26:case 27:case 5:return _t(t.type);case 16:return _t("Lazy");case 13:return t.child!==n&&n!==null?_t("Suspense Fallback"):_t("Suspense");case 19:return _t("SuspenseList");case 0:case 15:return ai(t.type,!1);case 11:return ai(t.type.render,!1);case 1:return ai(t.type,!0);case 31:return _t("Activity");default:return""}}function De(t){try{var n="",s=null;do n+=Ve(t,s),s=t,t=t.return;while(t);return n}catch(l){return`
Error generating stack: `+l.message+`
`+l.stack}}var Ne=Object.prototype.hasOwnProperty,dt=e.unstable_scheduleCallback,Mt=e.unstable_cancelCallback,gn=e.unstable_shouldYield,$n=e.unstable_requestPaint,At=e.unstable_now,Vn=e.unstable_getCurrentPriorityLevel,bi=e.unstable_ImmediatePriority,ht=e.unstable_UserBlockingPriority,Bt=e.unstable_NormalPriority,Yn=e.unstable_LowPriority,$t=e.unstable_IdlePriority,as=e.log,Wt=e.unstable_setDisableYieldValue,In=null,Xt=null;function yn(t){if(typeof as=="function"&&Wt(t),Xt&&typeof Xt.setStrictMode=="function")try{Xt.setStrictMode(In,t)}catch{}}var Ut=Math.clz32?Math.clz32:en,An=Math.log,xi=Math.LN2;function en(t){return t>>>=0,t===0?32:31-(An(t)/xi|0)|0}var dn=256,Bn=262144,Tn=4194304;function En(t){var n=t&42;if(n!==0)return n;switch(t&-t){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return t&261888;case 262144:case 524288:case 1048576:case 2097152:return t&3932160;case 4194304:case 8388608:case 16777216:case 33554432:return t&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return t}}function Ue(t,n,s){var l=t.pendingLanes;if(l===0)return 0;var u=0,d=t.suspendedLanes,x=t.pingedLanes;t=t.warmLanes;var T=l&134217727;return T!==0?(l=T&~d,l!==0?u=En(l):(x&=T,x!==0?u=En(x):s||(s=T&~t,s!==0&&(u=En(s))))):(T=l&~d,T!==0?u=En(T):x!==0?u=En(x):s||(s=l&~t,s!==0&&(u=En(s)))),u===0?0:n!==0&&n!==u&&(n&d)===0&&(d=u&-u,s=n&-n,d>=s||d===32&&(s&4194048)!==0)?n:u}function Tt(t,n){return(t.pendingLanes&~(t.suspendedLanes&~t.pingedLanes)&n)===0}function bn(t,n){switch(t){case 1:case 2:case 4:case 8:case 64:return n+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return n+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function ks(){var t=Tn;return Tn<<=1,(Tn&62914560)===0&&(Tn=4194304),t}function jt(t){for(var n=[],s=0;31>s;s++)n.push(t);return n}function tn(t,n){t.pendingLanes|=n,n!==268435456&&(t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0)}function Fn(t,n,s,l,u,d){var x=t.pendingLanes;t.pendingLanes=s,t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0,t.expiredLanes&=s,t.entangledLanes&=s,t.errorRecoveryDisabledLanes&=s,t.shellSuspendCounter=0;var T=t.entanglements,L=t.expirationTimes,U=t.hiddenUpdates;for(s=x&~s;0<s;){var Q=31-Ut(s),ie=1<<Q;T[Q]=0,L[Q]=-1;var V=U[Q];if(V!==null)for(U[Q]=null,Q=0;Q<V.length;Q++){var G=V[Q];G!==null&&(G.lane&=-536870913)}s&=~ie}l!==0&&vi(t,l,0),d!==0&&u===0&&t.tag!==0&&(t.suspendedLanes|=d&~(x&~n))}function vi(t,n,s){t.pendingLanes|=n,t.suspendedLanes&=~n;var l=31-Ut(n);t.entangledLanes|=n,t.entanglements[l]=t.entanglements[l]|1073741824|s&261930}function os(t,n){var s=t.entangledLanes|=n;for(t=t.entanglements;s;){var l=31-Ut(s),u=1<<l;u&n|t[l]&n&&(t[l]|=n),s&=~u}}function Fi(t,n){var s=n&-n;return s=(s&42)!==0?1:Ls(s),(s&(t.suspendedLanes|n))!==0?0:s}function Ls(t){switch(t){case 2:t=1;break;case 8:t=4;break;case 32:t=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:t=128;break;case 268435456:t=134217728;break;default:t=0}return t}function Di(t){return t&=-t,2<t?8<t?(t&134217727)!==0?32:268435456:8:2}function nn(){var t=ee.p;return t!==0?t:(t=window.event,t===void 0?32:ng(t.type))}function Si(t,n){var s=ee.p;try{return ee.p=t,n()}finally{ee.p=s}}var jn=Math.random().toString(36).slice(2),F="__reactFiber$"+jn,te="__reactProps$"+jn,de="__reactContainer$"+jn,we="__reactEvents$"+jn,ve="__reactListeners$"+jn,Le="__reactHandles$"+jn,$e="__reactResources$"+jn,Ot="__reactMarker$"+jn;function lt(t){delete t[F],delete t[te],delete t[we],delete t[ve],delete t[Le]}function Ye(t){var n=t[F];if(n)return n;for(var s=t.parentNode;s;){if(n=s[de]||s[F]){if(s=n.alternate,n.child!==null||s!==null&&s.child!==null)for(t=Uh(t);t!==null;){if(s=t[F])return s;t=Uh(t)}return n}t=s,s=t.parentNode}return null}function rt(t){if(t=t[F]||t[de]){var n=t.tag;if(n===5||n===6||n===13||n===31||n===26||n===27||n===3)return t}return null}function Vt(t){var n=t.tag;if(n===5||n===26||n===27||n===6)return t.stateNode;throw Error(o(33))}function Dn(t){var n=t[$e];return n||(n=t[$e]={hoistableStyles:new Map,hoistableScripts:new Map}),n}function Ct(t){t[Ot]=!0}var ls=new Set,ga={};function Xn(t,n){oi(t,n),oi(t+"Capture",n)}function oi(t,n){for(ga[t]=n,t=0;t<n.length;t++)ls.add(n[t])}var ya=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),Is={},ba={};function Qa(t){return Ne.call(ba,t)?!0:Ne.call(Is,t)?!1:ya.test(t)?ba[t]=!0:(Is[t]=!0,!1)}function wn(t,n,s){if(Qa(n))if(s===null)t.removeAttribute(n);else{switch(typeof s){case"undefined":case"function":case"symbol":t.removeAttribute(n);return;case"boolean":var l=n.toLowerCase().slice(0,5);if(l!=="data-"&&l!=="aria-"){t.removeAttribute(n);return}}t.setAttribute(n,""+s)}}function _n(t,n,s){if(s===null)t.removeAttribute(n);else{switch(typeof s){case"undefined":case"function":case"symbol":case"boolean":t.removeAttribute(n);return}t.setAttribute(n,""+s)}}function Hn(t,n,s,l){if(l===null)t.removeAttribute(s);else{switch(typeof l){case"undefined":case"function":case"symbol":case"boolean":t.removeAttribute(s);return}t.setAttributeNS(n,s,""+l)}}function xn(t){switch(typeof t){case"bigint":case"boolean":case"number":case"string":case"undefined":return t;case"object":return t;default:return""}}function xa(t){var n=t.type;return(t=t.nodeName)&&t.toLowerCase()==="input"&&(n==="checkbox"||n==="radio")}function Ja(t,n,s){var l=Object.getOwnPropertyDescriptor(t.constructor.prototype,n);if(!t.hasOwnProperty(n)&&typeof l<"u"&&typeof l.get=="function"&&typeof l.set=="function"){var u=l.get,d=l.set;return Object.defineProperty(t,n,{configurable:!0,get:function(){return u.call(this)},set:function(x){s=""+x,d.call(this,x)}}),Object.defineProperty(t,n,{enumerable:l.enumerable}),{getValue:function(){return s},setValue:function(x){s=""+x},stopTracking:function(){t._valueTracker=null,delete t[n]}}}}function rs(t){if(!t._valueTracker){var n=xa(t)?"checked":"value";t._valueTracker=Ja(t,n,""+t[n])}}function zo(t){if(!t)return!1;var n=t._valueTracker;if(!n)return!0;var s=n.getValue(),l="";return t&&(l=xa(t)?t.checked?"true":"false":t.value),t=l,t!==s?(n.setValue(t),!0):!1}function Ki(t){if(t=t||(typeof document<"u"?document:void 0),typeof t>"u")return null;try{return t.activeElement||t.body}catch{return t.body}}var Jc=/[\n"\\]/g;function Qn(t){return t.replace(Jc,function(n){return"\\"+n.charCodeAt(0).toString(16)+" "})}function Za(t,n,s,l,u,d,x,T){t.name="",x!=null&&typeof x!="function"&&typeof x!="symbol"&&typeof x!="boolean"?t.type=x:t.removeAttribute("type"),n!=null?x==="number"?(n===0&&t.value===""||t.value!=n)&&(t.value=""+xn(n)):t.value!==""+xn(n)&&(t.value=""+xn(n)):x!=="submit"&&x!=="reset"||t.removeAttribute("value"),n!=null?Ai(t,x,xn(n)):s!=null?Ai(t,x,xn(s)):l!=null&&t.removeAttribute("value"),u==null&&d!=null&&(t.defaultChecked=!!d),u!=null&&(t.checked=u&&typeof u!="function"&&typeof u!="symbol"),T!=null&&typeof T!="function"&&typeof T!="symbol"&&typeof T!="boolean"?t.name=""+xn(T):t.removeAttribute("name")}function $o(t,n,s,l,u,d,x,T){if(d!=null&&typeof d!="function"&&typeof d!="symbol"&&typeof d!="boolean"&&(t.type=d),n!=null||s!=null){if(!(d!=="submit"&&d!=="reset"||n!=null)){rs(t);return}s=s!=null?""+xn(s):"",n=n!=null?""+xn(n):s,T||n===t.value||(t.value=n),t.defaultValue=n}l=l??u,l=typeof l!="function"&&typeof l!="symbol"&&!!l,t.checked=T?t.checked:!!l,t.defaultChecked=!!l,x!=null&&typeof x!="function"&&typeof x!="symbol"&&typeof x!="boolean"&&(t.name=x),rs(t)}function Ai(t,n,s){n==="number"&&Ki(t.ownerDocument)===t||t.defaultValue===""+s||(t.defaultValue=""+s)}function cs(t,n,s,l){if(t=t.options,n){n={};for(var u=0;u<s.length;u++)n["$"+s[u]]=!0;for(s=0;s<t.length;s++)u=n.hasOwnProperty("$"+t[s].value),t[s].selected!==u&&(t[s].selected=u),u&&l&&(t[s].defaultSelected=!0)}else{for(s=""+xn(s),n=null,u=0;u<t.length;u++){if(t[u].value===s){t[u].selected=!0,l&&(t[u].defaultSelected=!0);return}n!==null||t[u].disabled||(n=t[u])}n!==null&&(n.selected=!0)}}function Vo(t,n,s){if(n!=null&&(n=""+xn(n),n!==t.value&&(t.value=n),s==null)){t.defaultValue!==n&&(t.defaultValue=n);return}t.defaultValue=s!=null?""+xn(s):""}function cr(t,n,s,l){if(n==null){if(l!=null){if(s!=null)throw Error(o(92));if(pe(l)){if(1<l.length)throw Error(o(93));l=l[0]}s=l}s==null&&(s=""),n=s}s=xn(n),t.defaultValue=s,l=t.textContent,l===s&&l!==""&&l!==null&&(t.value=l),rs(t)}function Bs(t,n){if(n){var s=t.firstChild;if(s&&s===t.lastChild&&s.nodeType===3){s.nodeValue=n;return}}t.textContent=n}var ur=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function Yo(t,n,s){var l=n.indexOf("--")===0;s==null||typeof s=="boolean"||s===""?l?t.setProperty(n,""):n==="float"?t.cssFloat="":t[n]="":l?t.setProperty(n,s):typeof s!="number"||s===0||ur.has(n)?n==="float"?t.cssFloat=s:t[n]=(""+s).trim():t[n]=s+"px"}function eo(t,n,s){if(n!=null&&typeof n!="object")throw Error(o(62));if(t=t.style,s!=null){for(var l in s)!s.hasOwnProperty(l)||n!=null&&n.hasOwnProperty(l)||(l.indexOf("--")===0?t.setProperty(l,""):l==="float"?t.cssFloat="":t[l]="");for(var u in n)l=n[u],n.hasOwnProperty(u)&&s[u]!==l&&Yo(t,u,l)}else for(var d in n)n.hasOwnProperty(d)&&Yo(t,d,n[d])}function Gi(t){if(t.indexOf("-")===-1)return!1;switch(t){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Fo=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),to=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function Wi(t){return to.test(""+t)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":t}function Ti(){}var Ko=null;function Go(t){return t=t.target||t.srcElement||window,t.correspondingUseElement&&(t=t.correspondingUseElement),t.nodeType===3?t.parentNode:t}var Xi=null,li=null;function Wo(t){var n=rt(t);if(n&&(t=n.stateNode)){var s=t[te]||null;e:switch(t=n.stateNode,n.type){case"input":if(Za(t,s.value,s.defaultValue,s.defaultValue,s.checked,s.defaultChecked,s.type,s.name),n=s.name,s.type==="radio"&&n!=null){for(s=t;s.parentNode;)s=s.parentNode;for(s=s.querySelectorAll('input[name="'+Qn(""+n)+'"][type="radio"]'),n=0;n<s.length;n++){var l=s[n];if(l!==t&&l.form===t.form){var u=l[te]||null;if(!u)throw Error(o(90));Za(l,u.value,u.defaultValue,u.defaultValue,u.checked,u.defaultChecked,u.type,u.name)}}for(n=0;n<s.length;n++)l=s[n],l.form===t.form&&zo(l)}break e;case"textarea":Vo(t,s.value,s.defaultValue);break e;case"select":n=s.value,n!=null&&cs(t,!!s.multiple,n,!1)}}}var us=!1;function dr(t,n,s){if(us)return t(n,s);us=!0;try{var l=t(n);return l}finally{if(us=!1,(Xi!==null||li!==null)&&(ec(),Xi&&(n=Xi,t=li,li=Xi=null,Wo(n),t)))for(n=0;n<t.length;n++)Wo(t[n])}}function va(t,n){var s=t.stateNode;if(s===null)return null;var l=s[te]||null;if(l===null)return null;s=l[n];e:switch(n){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(l=!l.disabled)||(t=t.type,l=!(t==="button"||t==="input"||t==="select"||t==="textarea")),t=!l;break e;default:t=!1}if(t)return null;if(s&&typeof s!="function")throw Error(o(231,n,typeof s));return s}var Hi=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),Qi=!1;if(Hi)try{var Sa={};Object.defineProperty(Sa,"passive",{get:function(){Qi=!0}}),window.addEventListener("test",Sa,Sa),window.removeEventListener("test",Sa,Sa)}catch{Qi=!1}var Ji=null,js=null,no=null;function fr(){if(no)return no;var t,n=js,s=n.length,l,u="value"in Ji?Ji.value:Ji.textContent,d=u.length;for(t=0;t<s&&n[t]===u[t];t++);var x=s-t;for(l=1;l<=x&&n[s-l]===u[d-l];l++);return no=u.slice(t,1<l?1-l:void 0)}function io(t){var n=t.keyCode;return"charCode"in t?(t=t.charCode,t===0&&n===13&&(t=13)):t=n,t===10&&(t=13),32<=t||t===13?t:0}function ds(){return!0}function mr(){return!1}function sn(t){function n(s,l,u,d,x){this._reactName=s,this._targetInst=u,this.type=l,this.nativeEvent=d,this.target=x,this.currentTarget=null;for(var T in t)t.hasOwnProperty(T)&&(s=t[T],this[T]=s?s(d):d[T]);return this.isDefaultPrevented=(d.defaultPrevented!=null?d.defaultPrevented:d.returnValue===!1)?ds:mr,this.isPropagationStopped=mr,this}return v(n.prototype,{preventDefault:function(){this.defaultPrevented=!0;var s=this.nativeEvent;s&&(s.preventDefault?s.preventDefault():typeof s.returnValue!="unknown"&&(s.returnValue=!1),this.isDefaultPrevented=ds)},stopPropagation:function(){var s=this.nativeEvent;s&&(s.stopPropagation?s.stopPropagation():typeof s.cancelBubble!="unknown"&&(s.cancelBubble=!0),this.isPropagationStopped=ds)},persist:function(){},isPersistent:ds}),n}var Ei={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(t){return t.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Ds=sn(Ei),Hs=v({},Ei,{view:0,detail:0}),pr=sn(Hs),Xo,Qo,Aa,Ps=v({},Hs,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:nt,button:0,buttons:0,relatedTarget:function(t){return t.relatedTarget===void 0?t.fromElement===t.srcElement?t.toElement:t.fromElement:t.relatedTarget},movementX:function(t){return"movementX"in t?t.movementX:(t!==Aa&&(Aa&&t.type==="mousemove"?(Xo=t.screenX-Aa.screenX,Qo=t.screenY-Aa.screenY):Qo=Xo=0,Aa=t),Xo)},movementY:function(t){return"movementY"in t?t.movementY:Qo}}),Je=sn(Ps),Ta=v({},Ps,{dataTransfer:0}),vn=sn(Ta),E=v({},Hs,{relatedTarget:0}),B=sn(E),z=v({},Ei,{animationName:0,elapsedTime:0,pseudoElement:0}),le=sn(z),re=v({},Ei,{clipboardData:function(t){return"clipboardData"in t?t.clipboardData:window.clipboardData}}),fe=sn(re),ye=v({},Ei,{data:0}),Fe=sn(ye),Ze={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},qt={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},zt={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Et(t){var n=this.nativeEvent;return n.getModifierState?n.getModifierState(t):(t=zt[t])?!!n[t]:!1}function nt(){return Et}var gt=v({},Hs,{key:function(t){if(t.key){var n=Ze[t.key]||t.key;if(n!=="Unidentified")return n}return t.type==="keypress"?(t=io(t),t===13?"Enter":String.fromCharCode(t)):t.type==="keydown"||t.type==="keyup"?qt[t.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:nt,charCode:function(t){return t.type==="keypress"?io(t):0},keyCode:function(t){return t.type==="keydown"||t.type==="keyup"?t.keyCode:0},which:function(t){return t.type==="keypress"?io(t):t.type==="keydown"||t.type==="keyup"?t.keyCode:0}}),Qt=sn(gt),kt=v({},Ps,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Mn=sn(kt),wi=v({},Hs,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:nt}),hr=sn(wi),gr=v({},Ei,{propertyName:0,elapsedTime:0,pseudoElement:0}),yr=sn(gr),br=v({},Ps,{deltaX:function(t){return"deltaX"in t?t.deltaX:"wheelDeltaX"in t?-t.wheelDeltaX:0},deltaY:function(t){return"deltaY"in t?t.deltaY:"wheelDeltaY"in t?-t.wheelDeltaY:"wheelDelta"in t?-t.wheelDelta:0},deltaZ:0,deltaMode:0}),Zc=sn(br),eu=v({},Ei,{newState:0,oldState:0}),Jo=sn(eu),Zo=[9,13,27,32],el=Hi&&"CompositionEvent"in window,Ea=null;Hi&&"documentMode"in document&&(Ea=document.documentMode);var so=Hi&&"TextEvent"in window&&!Ea,wa=Hi&&(!el||Ea&&8<Ea&&11>=Ea),ao=" ",tl=!1;function nl(t,n){switch(t){case"keyup":return Zo.indexOf(n.keyCode)!==-1;case"keydown":return n.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function il(t){return t=t.detail,typeof t=="object"&&"data"in t?t.data:null}var oo=!1;function r0(t,n){switch(t){case"compositionend":return il(n);case"keypress":return n.which!==32?null:(tl=!0,ao);case"textInput":return t=n.data,t===ao&&tl?null:t;default:return null}}function c0(t,n){if(oo)return t==="compositionend"||!el&&nl(t,n)?(t=fr(),no=js=Ji=null,oo=!1,t):null;switch(t){case"paste":return null;case"keypress":if(!(n.ctrlKey||n.altKey||n.metaKey)||n.ctrlKey&&n.altKey){if(n.char&&1<n.char.length)return n.char;if(n.which)return String.fromCharCode(n.which)}return null;case"compositionend":return wa&&n.locale!=="ko"?null:n.data;default:return null}}var u0={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function $f(t){var n=t&&t.nodeName&&t.nodeName.toLowerCase();return n==="input"?!!u0[t.type]:n==="textarea"}function Vf(t,n,s,l){Xi?li?li.push(l):li=[l]:Xi=l,n=lc(n,"onChange"),0<n.length&&(s=new Ds("onChange","change",null,s,l),t.push({event:s,listeners:n}))}var sl=null,al=null;function d0(t){_h(t,0)}function xr(t){var n=Vt(t);if(zo(n))return t}function Yf(t,n){if(t==="change")return n}var Ff=!1;if(Hi){var tu;if(Hi){var nu="oninput"in document;if(!nu){var Kf=document.createElement("div");Kf.setAttribute("oninput","return;"),nu=typeof Kf.oninput=="function"}tu=nu}else tu=!1;Ff=tu&&(!document.documentMode||9<document.documentMode)}function Gf(){sl&&(sl.detachEvent("onpropertychange",Wf),al=sl=null)}function Wf(t){if(t.propertyName==="value"&&xr(al)){var n=[];Vf(n,al,t,Go(t)),dr(d0,n)}}function f0(t,n,s){t==="focusin"?(Gf(),sl=n,al=s,sl.attachEvent("onpropertychange",Wf)):t==="focusout"&&Gf()}function m0(t){if(t==="selectionchange"||t==="keyup"||t==="keydown")return xr(al)}function p0(t,n){if(t==="click")return xr(n)}function h0(t,n){if(t==="input"||t==="change")return xr(n)}function g0(t,n){return t===n&&(t!==0||1/t===1/n)||t!==t&&n!==n}var ri=typeof Object.is=="function"?Object.is:g0;function ol(t,n){if(ri(t,n))return!0;if(typeof t!="object"||t===null||typeof n!="object"||n===null)return!1;var s=Object.keys(t),l=Object.keys(n);if(s.length!==l.length)return!1;for(l=0;l<s.length;l++){var u=s[l];if(!Ne.call(n,u)||!ri(t[u],n[u]))return!1}return!0}function Xf(t){for(;t&&t.firstChild;)t=t.firstChild;return t}function Qf(t,n){var s=Xf(t);t=0;for(var l;s;){if(s.nodeType===3){if(l=t+s.textContent.length,t<=n&&l>=n)return{node:s,offset:n-t};t=l}e:{for(;s;){if(s.nextSibling){s=s.nextSibling;break e}s=s.parentNode}s=void 0}s=Xf(s)}}function Jf(t,n){return t&&n?t===n?!0:t&&t.nodeType===3?!1:n&&n.nodeType===3?Jf(t,n.parentNode):"contains"in t?t.contains(n):t.compareDocumentPosition?!!(t.compareDocumentPosition(n)&16):!1:!1}function Zf(t){t=t!=null&&t.ownerDocument!=null&&t.ownerDocument.defaultView!=null?t.ownerDocument.defaultView:window;for(var n=Ki(t.document);n instanceof t.HTMLIFrameElement;){try{var s=typeof n.contentWindow.location.href=="string"}catch{s=!1}if(s)t=n.contentWindow;else break;n=Ki(t.document)}return n}function iu(t){var n=t&&t.nodeName&&t.nodeName.toLowerCase();return n&&(n==="input"&&(t.type==="text"||t.type==="search"||t.type==="tel"||t.type==="url"||t.type==="password")||n==="textarea"||t.contentEditable==="true")}var y0=Hi&&"documentMode"in document&&11>=document.documentMode,lo=null,su=null,ll=null,au=!1;function em(t,n,s){var l=s.window===s?s.document:s.nodeType===9?s:s.ownerDocument;au||lo==null||lo!==Ki(l)||(l=lo,"selectionStart"in l&&iu(l)?l={start:l.selectionStart,end:l.selectionEnd}:(l=(l.ownerDocument&&l.ownerDocument.defaultView||window).getSelection(),l={anchorNode:l.anchorNode,anchorOffset:l.anchorOffset,focusNode:l.focusNode,focusOffset:l.focusOffset}),ll&&ol(ll,l)||(ll=l,l=lc(su,"onSelect"),0<l.length&&(n=new Ds("onSelect","select",null,n,s),t.push({event:n,listeners:l}),n.target=lo)))}function _a(t,n){var s={};return s[t.toLowerCase()]=n.toLowerCase(),s["Webkit"+t]="webkit"+n,s["Moz"+t]="moz"+n,s}var ro={animationend:_a("Animation","AnimationEnd"),animationiteration:_a("Animation","AnimationIteration"),animationstart:_a("Animation","AnimationStart"),transitionrun:_a("Transition","TransitionRun"),transitionstart:_a("Transition","TransitionStart"),transitioncancel:_a("Transition","TransitionCancel"),transitionend:_a("Transition","TransitionEnd")},ou={},tm={};Hi&&(tm=document.createElement("div").style,"AnimationEvent"in window||(delete ro.animationend.animation,delete ro.animationiteration.animation,delete ro.animationstart.animation),"TransitionEvent"in window||delete ro.transitionend.transition);function Ma(t){if(ou[t])return ou[t];if(!ro[t])return t;var n=ro[t],s;for(s in n)if(n.hasOwnProperty(s)&&s in tm)return ou[t]=n[s];return t}var nm=Ma("animationend"),im=Ma("animationiteration"),sm=Ma("animationstart"),b0=Ma("transitionrun"),x0=Ma("transitionstart"),v0=Ma("transitioncancel"),am=Ma("transitionend"),om=new Map,lu="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");lu.push("scrollEnd");function Pi(t,n){om.set(t,n),Xn(n,[t])}var vr=typeof reportError=="function"?reportError:function(t){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var n=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof t=="object"&&t!==null&&typeof t.message=="string"?String(t.message):String(t),error:t});if(!window.dispatchEvent(n))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",t);return}console.error(t)},_i=[],co=0,ru=0;function Sr(){for(var t=co,n=ru=co=0;n<t;){var s=_i[n];_i[n++]=null;var l=_i[n];_i[n++]=null;var u=_i[n];_i[n++]=null;var d=_i[n];if(_i[n++]=null,l!==null&&u!==null){var x=l.pending;x===null?u.next=u:(u.next=x.next,x.next=u),l.pending=u}d!==0&&lm(s,u,d)}}function Ar(t,n,s,l){_i[co++]=t,_i[co++]=n,_i[co++]=s,_i[co++]=l,ru|=l,t.lanes|=l,t=t.alternate,t!==null&&(t.lanes|=l)}function cu(t,n,s,l){return Ar(t,n,s,l),Tr(t)}function Oa(t,n){return Ar(t,null,null,n),Tr(t)}function lm(t,n,s){t.lanes|=s;var l=t.alternate;l!==null&&(l.lanes|=s);for(var u=!1,d=t.return;d!==null;)d.childLanes|=s,l=d.alternate,l!==null&&(l.childLanes|=s),d.tag===22&&(t=d.stateNode,t===null||t._visibility&1||(u=!0)),t=d,d=d.return;return t.tag===3?(d=t.stateNode,u&&n!==null&&(u=31-Ut(s),t=d.hiddenUpdates,l=t[u],l===null?t[u]=[n]:l.push(n),n.lane=s|536870912),d):null}function Tr(t){if(50<Cl)throw Cl=0,bd=null,Error(o(185));for(var n=t.return;n!==null;)t=n,n=t.return;return t.tag===3?t.stateNode:null}var uo={};function S0(t,n,s,l){this.tag=t,this.key=s,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=n,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=l,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function ci(t,n,s,l){return new S0(t,n,s,l)}function uu(t){return t=t.prototype,!(!t||!t.isReactComponent)}function fs(t,n){var s=t.alternate;return s===null?(s=ci(t.tag,n,t.key,t.mode),s.elementType=t.elementType,s.type=t.type,s.stateNode=t.stateNode,s.alternate=t,t.alternate=s):(s.pendingProps=n,s.type=t.type,s.flags=0,s.subtreeFlags=0,s.deletions=null),s.flags=t.flags&65011712,s.childLanes=t.childLanes,s.lanes=t.lanes,s.child=t.child,s.memoizedProps=t.memoizedProps,s.memoizedState=t.memoizedState,s.updateQueue=t.updateQueue,n=t.dependencies,s.dependencies=n===null?null:{lanes:n.lanes,firstContext:n.firstContext},s.sibling=t.sibling,s.index=t.index,s.ref=t.ref,s.refCleanup=t.refCleanup,s}function rm(t,n){t.flags&=65011714;var s=t.alternate;return s===null?(t.childLanes=0,t.lanes=n,t.child=null,t.subtreeFlags=0,t.memoizedProps=null,t.memoizedState=null,t.updateQueue=null,t.dependencies=null,t.stateNode=null):(t.childLanes=s.childLanes,t.lanes=s.lanes,t.child=s.child,t.subtreeFlags=0,t.deletions=null,t.memoizedProps=s.memoizedProps,t.memoizedState=s.memoizedState,t.updateQueue=s.updateQueue,t.type=s.type,n=s.dependencies,t.dependencies=n===null?null:{lanes:n.lanes,firstContext:n.firstContext}),t}function Er(t,n,s,l,u,d){var x=0;if(l=t,typeof t=="function")uu(t)&&(x=1);else if(typeof t=="string")x=_b(t,s,me.current)?26:t==="html"||t==="head"||t==="body"?27:5;else e:switch(t){case K:return t=ci(31,s,n,u),t.elementType=K,t.lanes=d,t;case g:return Ca(s.children,u,d,n);case R:x=8,u|=24;break;case I:return t=ci(12,s,n,u|2),t.elementType=I,t.lanes=d,t;case Y:return t=ci(13,s,n,u),t.elementType=Y,t.lanes=d,t;case X:return t=ci(19,s,n,u),t.elementType=X,t.lanes=d,t;default:if(typeof t=="object"&&t!==null)switch(t.$$typeof){case M:x=10;break e;case C:x=9;break e;case N:x=11;break e;case O:x=14;break e;case q:x=16,l=null;break e}x=29,s=Error(o(130,t===null?"null":typeof t,"")),l=null}return n=ci(x,s,n,u),n.elementType=t,n.type=l,n.lanes=d,n}function Ca(t,n,s,l){return t=ci(7,t,l,n),t.lanes=s,t}function du(t,n,s){return t=ci(6,t,null,n),t.lanes=s,t}function cm(t){var n=ci(18,null,null,0);return n.stateNode=t,n}function fu(t,n,s){return n=ci(4,t.children!==null?t.children:[],t.key,n),n.lanes=s,n.stateNode={containerInfo:t.containerInfo,pendingChildren:null,implementation:t.implementation},n}var um=new WeakMap;function Mi(t,n){if(typeof t=="object"&&t!==null){var s=um.get(t);return s!==void 0?s:(n={value:t,source:n,stack:De(n)},um.set(t,n),n)}return{value:t,source:n,stack:De(n)}}var fo=[],mo=0,wr=null,rl=0,Oi=[],Ci=0,Us=null,Zi=1,es="";function ms(t,n){fo[mo++]=rl,fo[mo++]=wr,wr=t,rl=n}function dm(t,n,s){Oi[Ci++]=Zi,Oi[Ci++]=es,Oi[Ci++]=Us,Us=t;var l=Zi;t=es;var u=32-Ut(l)-1;l&=~(1<<u),s+=1;var d=32-Ut(n)+u;if(30<d){var x=u-u%5;d=(l&(1<<x)-1).toString(32),l>>=x,u-=x,Zi=1<<32-Ut(n)+u|s<<u|l,es=d+t}else Zi=1<<d|s<<u|l,es=t}function mu(t){t.return!==null&&(ms(t,1),dm(t,1,0))}function pu(t){for(;t===wr;)wr=fo[--mo],fo[mo]=null,rl=fo[--mo],fo[mo]=null;for(;t===Us;)Us=Oi[--Ci],Oi[Ci]=null,es=Oi[--Ci],Oi[Ci]=null,Zi=Oi[--Ci],Oi[Ci]=null}function fm(t,n){Oi[Ci++]=Zi,Oi[Ci++]=es,Oi[Ci++]=Us,Zi=n.id,es=n.overflow,Us=t}var On=null,Lt=null,et=!1,qs=null,Ni=!1,hu=Error(o(519));function zs(t){var n=Error(o(418,1<arguments.length&&arguments[1]!==void 0&&arguments[1]?"text":"HTML",""));throw cl(Mi(n,t)),hu}function mm(t){var n=t.stateNode,s=t.type,l=t.memoizedProps;switch(n[F]=t,n[te]=l,s){case"dialog":Ge("cancel",n),Ge("close",n);break;case"iframe":case"object":case"embed":Ge("load",n);break;case"video":case"audio":for(s=0;s<Rl.length;s++)Ge(Rl[s],n);break;case"source":Ge("error",n);break;case"img":case"image":case"link":Ge("error",n),Ge("load",n);break;case"details":Ge("toggle",n);break;case"input":Ge("invalid",n),$o(n,l.value,l.defaultValue,l.checked,l.defaultChecked,l.type,l.name,!0);break;case"select":Ge("invalid",n);break;case"textarea":Ge("invalid",n),cr(n,l.value,l.defaultValue,l.children)}s=l.children,typeof s!="string"&&typeof s!="number"&&typeof s!="bigint"||n.textContent===""+s||l.suppressHydrationWarning===!0||Nh(n.textContent,s)?(l.popover!=null&&(Ge("beforetoggle",n),Ge("toggle",n)),l.onScroll!=null&&Ge("scroll",n),l.onScrollEnd!=null&&Ge("scrollend",n),l.onClick!=null&&(n.onclick=Ti),n=!0):n=!1,n||zs(t,!0)}function pm(t){for(On=t.return;On;)switch(On.tag){case 5:case 31:case 13:Ni=!1;return;case 27:case 3:Ni=!0;return;default:On=On.return}}function po(t){if(t!==On)return!1;if(!et)return pm(t),et=!0,!1;var n=t.tag,s;if((s=n!==3&&n!==27)&&((s=n===5)&&(s=t.type,s=!(s!=="form"&&s!=="button")||Ld(t.type,t.memoizedProps)),s=!s),s&&Lt&&zs(t),pm(t),n===13){if(t=t.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(o(317));Lt=Ph(t)}else if(n===31){if(t=t.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(o(317));Lt=Ph(t)}else n===27?(n=Lt,na(t.type)?(t=Hd,Hd=null,Lt=t):Lt=n):Lt=On?ki(t.stateNode.nextSibling):null;return!0}function Na(){Lt=On=null,et=!1}function gu(){var t=qs;return t!==null&&(ti===null?ti=t:ti.push.apply(ti,t),qs=null),t}function cl(t){qs===null?qs=[t]:qs.push(t)}var yu=k(null),Ra=null,ps=null;function $s(t,n,s){J(yu,n._currentValue),n._currentValue=s}function hs(t){t._currentValue=yu.current,$(yu)}function bu(t,n,s){for(;t!==null;){var l=t.alternate;if((t.childLanes&n)!==n?(t.childLanes|=n,l!==null&&(l.childLanes|=n)):l!==null&&(l.childLanes&n)!==n&&(l.childLanes|=n),t===s)break;t=t.return}}function xu(t,n,s,l){var u=t.child;for(u!==null&&(u.return=t);u!==null;){var d=u.dependencies;if(d!==null){var x=u.child;d=d.firstContext;e:for(;d!==null;){var T=d;d=u;for(var L=0;L<n.length;L++)if(T.context===n[L]){d.lanes|=s,T=d.alternate,T!==null&&(T.lanes|=s),bu(d.return,s,t),l||(x=null);break e}d=T.next}}else if(u.tag===18){if(x=u.return,x===null)throw Error(o(341));x.lanes|=s,d=x.alternate,d!==null&&(d.lanes|=s),bu(x,s,t),x=null}else x=u.child;if(x!==null)x.return=u;else for(x=u;x!==null;){if(x===t){x=null;break}if(u=x.sibling,u!==null){u.return=x.return,x=u;break}x=x.return}u=x}}function ho(t,n,s,l){t=null;for(var u=n,d=!1;u!==null;){if(!d){if((u.flags&524288)!==0)d=!0;else if((u.flags&262144)!==0)break}if(u.tag===10){var x=u.alternate;if(x===null)throw Error(o(387));if(x=x.memoizedProps,x!==null){var T=u.type;ri(u.pendingProps.value,x.value)||(t!==null?t.push(T):t=[T])}}else if(u===Ie.current){if(x=u.alternate,x===null)throw Error(o(387));x.memoizedState.memoizedState!==u.memoizedState.memoizedState&&(t!==null?t.push(jl):t=[jl])}u=u.return}t!==null&&xu(n,t,s,l),n.flags|=262144}function _r(t){for(t=t.firstContext;t!==null;){if(!ri(t.context._currentValue,t.memoizedValue))return!0;t=t.next}return!1}function ka(t){Ra=t,ps=null,t=t.dependencies,t!==null&&(t.firstContext=null)}function Cn(t){return hm(Ra,t)}function Mr(t,n){return Ra===null&&ka(t),hm(t,n)}function hm(t,n){var s=n._currentValue;if(n={context:n,memoizedValue:s,next:null},ps===null){if(t===null)throw Error(o(308));ps=n,t.dependencies={lanes:0,firstContext:n},t.flags|=524288}else ps=ps.next=n;return s}var A0=typeof AbortController<"u"?AbortController:function(){var t=[],n=this.signal={aborted:!1,addEventListener:function(s,l){t.push(l)}};this.abort=function(){n.aborted=!0,t.forEach(function(s){return s()})}},T0=e.unstable_scheduleCallback,E0=e.unstable_NormalPriority,an={$$typeof:M,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function vu(){return{controller:new A0,data:new Map,refCount:0}}function ul(t){t.refCount--,t.refCount===0&&T0(E0,function(){t.controller.abort()})}var dl=null,Su=0,go=0,yo=null;function w0(t,n){if(dl===null){var s=dl=[];Su=0,go=Ed(),yo={status:"pending",value:void 0,then:function(l){s.push(l)}}}return Su++,n.then(gm,gm),n}function gm(){if(--Su===0&&dl!==null){yo!==null&&(yo.status="fulfilled");var t=dl;dl=null,go=0,yo=null;for(var n=0;n<t.length;n++)(0,t[n])()}}function _0(t,n){var s=[],l={status:"pending",value:null,reason:null,then:function(u){s.push(u)}};return t.then(function(){l.status="fulfilled",l.value=n;for(var u=0;u<s.length;u++)(0,s[u])(n)},function(u){for(l.status="rejected",l.reason=u,u=0;u<s.length;u++)(0,s[u])(void 0)}),l}var ym=H.S;H.S=function(t,n){eh=At(),typeof n=="object"&&n!==null&&typeof n.then=="function"&&w0(t,n),ym!==null&&ym(t,n)};var La=k(null);function Au(){var t=La.current;return t!==null?t:wt.pooledCache}function Or(t,n){n===null?J(La,La.current):J(La,n.pool)}function bm(){var t=Au();return t===null?null:{parent:an._currentValue,pool:t}}var bo=Error(o(460)),Tu=Error(o(474)),Cr=Error(o(542)),Nr={then:function(){}};function xm(t){return t=t.status,t==="fulfilled"||t==="rejected"}function vm(t,n,s){switch(s=t[s],s===void 0?t.push(n):s!==n&&(n.then(Ti,Ti),n=s),n.status){case"fulfilled":return n.value;case"rejected":throw t=n.reason,Am(t),t;default:if(typeof n.status=="string")n.then(Ti,Ti);else{if(t=wt,t!==null&&100<t.shellSuspendCounter)throw Error(o(482));t=n,t.status="pending",t.then(function(l){if(n.status==="pending"){var u=n;u.status="fulfilled",u.value=l}},function(l){if(n.status==="pending"){var u=n;u.status="rejected",u.reason=l}})}switch(n.status){case"fulfilled":return n.value;case"rejected":throw t=n.reason,Am(t),t}throw Ba=n,bo}}function Ia(t){try{var n=t._init;return n(t._payload)}catch(s){throw s!==null&&typeof s=="object"&&typeof s.then=="function"?(Ba=s,bo):s}}var Ba=null;function Sm(){if(Ba===null)throw Error(o(459));var t=Ba;return Ba=null,t}function Am(t){if(t===bo||t===Cr)throw Error(o(483))}var xo=null,fl=0;function Rr(t){var n=fl;return fl+=1,xo===null&&(xo=[]),vm(xo,t,n)}function ml(t,n){n=n.props.ref,t.ref=n!==void 0?n:null}function kr(t,n){throw n.$$typeof===S?Error(o(525)):(t=Object.prototype.toString.call(n),Error(o(31,t==="[object Object]"?"object with keys {"+Object.keys(n).join(", ")+"}":t)))}function Tm(t){function n(D,j){if(t){var P=D.deletions;P===null?(D.deletions=[j],D.flags|=16):P.push(j)}}function s(D,j){if(!t)return null;for(;j!==null;)n(D,j),j=j.sibling;return null}function l(D){for(var j=new Map;D!==null;)D.key!==null?j.set(D.key,D):j.set(D.index,D),D=D.sibling;return j}function u(D,j){return D=fs(D,j),D.index=0,D.sibling=null,D}function d(D,j,P){return D.index=P,t?(P=D.alternate,P!==null?(P=P.index,P<j?(D.flags|=67108866,j):P):(D.flags|=67108866,j)):(D.flags|=1048576,j)}function x(D){return t&&D.alternate===null&&(D.flags|=67108866),D}function T(D,j,P,Z){return j===null||j.tag!==6?(j=du(P,D.mode,Z),j.return=D,j):(j=u(j,P),j.return=D,j)}function L(D,j,P,Z){var Oe=P.type;return Oe===g?Q(D,j,P.props.children,Z,P.key):j!==null&&(j.elementType===Oe||typeof Oe=="object"&&Oe!==null&&Oe.$$typeof===q&&Ia(Oe)===j.type)?(j=u(j,P.props),ml(j,P),j.return=D,j):(j=Er(P.type,P.key,P.props,null,D.mode,Z),ml(j,P),j.return=D,j)}function U(D,j,P,Z){return j===null||j.tag!==4||j.stateNode.containerInfo!==P.containerInfo||j.stateNode.implementation!==P.implementation?(j=fu(P,D.mode,Z),j.return=D,j):(j=u(j,P.children||[]),j.return=D,j)}function Q(D,j,P,Z,Oe){return j===null||j.tag!==7?(j=Ca(P,D.mode,Z,Oe),j.return=D,j):(j=u(j,P),j.return=D,j)}function ie(D,j,P){if(typeof j=="string"&&j!==""||typeof j=="number"||typeof j=="bigint")return j=du(""+j,D.mode,P),j.return=D,j;if(typeof j=="object"&&j!==null){switch(j.$$typeof){case _:return P=Er(j.type,j.key,j.props,null,D.mode,P),ml(P,j),P.return=D,P;case p:return j=fu(j,D.mode,P),j.return=D,j;case q:return j=Ia(j),ie(D,j,P)}if(pe(j)||_e(j))return j=Ca(j,D.mode,P,null),j.return=D,j;if(typeof j.then=="function")return ie(D,Rr(j),P);if(j.$$typeof===M)return ie(D,Mr(D,j),P);kr(D,j)}return null}function V(D,j,P,Z){var Oe=j!==null?j.key:null;if(typeof P=="string"&&P!==""||typeof P=="number"||typeof P=="bigint")return Oe!==null?null:T(D,j,""+P,Z);if(typeof P=="object"&&P!==null){switch(P.$$typeof){case _:return P.key===Oe?L(D,j,P,Z):null;case p:return P.key===Oe?U(D,j,P,Z):null;case q:return P=Ia(P),V(D,j,P,Z)}if(pe(P)||_e(P))return Oe!==null?null:Q(D,j,P,Z,null);if(typeof P.then=="function")return V(D,j,Rr(P),Z);if(P.$$typeof===M)return V(D,j,Mr(D,P),Z);kr(D,P)}return null}function G(D,j,P,Z,Oe){if(typeof Z=="string"&&Z!==""||typeof Z=="number"||typeof Z=="bigint")return D=D.get(P)||null,T(j,D,""+Z,Oe);if(typeof Z=="object"&&Z!==null){switch(Z.$$typeof){case _:return D=D.get(Z.key===null?P:Z.key)||null,L(j,D,Z,Oe);case p:return D=D.get(Z.key===null?P:Z.key)||null,U(j,D,Z,Oe);case q:return Z=Ia(Z),G(D,j,P,Z,Oe)}if(pe(Z)||_e(Z))return D=D.get(P)||null,Q(j,D,Z,Oe,null);if(typeof Z.then=="function")return G(D,j,P,Rr(Z),Oe);if(Z.$$typeof===M)return G(D,j,P,Mr(j,Z),Oe);kr(j,Z)}return null}function Se(D,j,P,Z){for(var Oe=null,it=null,Ae=j,Pe=j=0,Xe=null;Ae!==null&&Pe<P.length;Pe++){Ae.index>Pe?(Xe=Ae,Ae=null):Xe=Ae.sibling;var st=V(D,Ae,P[Pe],Z);if(st===null){Ae===null&&(Ae=Xe);break}t&&Ae&&st.alternate===null&&n(D,Ae),j=d(st,j,Pe),it===null?Oe=st:it.sibling=st,it=st,Ae=Xe}if(Pe===P.length)return s(D,Ae),et&&ms(D,Pe),Oe;if(Ae===null){for(;Pe<P.length;Pe++)Ae=ie(D,P[Pe],Z),Ae!==null&&(j=d(Ae,j,Pe),it===null?Oe=Ae:it.sibling=Ae,it=Ae);return et&&ms(D,Pe),Oe}for(Ae=l(Ae);Pe<P.length;Pe++)Xe=G(Ae,D,Pe,P[Pe],Z),Xe!==null&&(t&&Xe.alternate!==null&&Ae.delete(Xe.key===null?Pe:Xe.key),j=d(Xe,j,Pe),it===null?Oe=Xe:it.sibling=Xe,it=Xe);return t&&Ae.forEach(function(la){return n(D,la)}),et&&ms(D,Pe),Oe}function Re(D,j,P,Z){if(P==null)throw Error(o(151));for(var Oe=null,it=null,Ae=j,Pe=j=0,Xe=null,st=P.next();Ae!==null&&!st.done;Pe++,st=P.next()){Ae.index>Pe?(Xe=Ae,Ae=null):Xe=Ae.sibling;var la=V(D,Ae,st.value,Z);if(la===null){Ae===null&&(Ae=Xe);break}t&&Ae&&la.alternate===null&&n(D,Ae),j=d(la,j,Pe),it===null?Oe=la:it.sibling=la,it=la,Ae=Xe}if(st.done)return s(D,Ae),et&&ms(D,Pe),Oe;if(Ae===null){for(;!st.done;Pe++,st=P.next())st=ie(D,st.value,Z),st!==null&&(j=d(st,j,Pe),it===null?Oe=st:it.sibling=st,it=st);return et&&ms(D,Pe),Oe}for(Ae=l(Ae);!st.done;Pe++,st=P.next())st=G(Ae,D,Pe,st.value,Z),st!==null&&(t&&st.alternate!==null&&Ae.delete(st.key===null?Pe:st.key),j=d(st,j,Pe),it===null?Oe=st:it.sibling=st,it=st);return t&&Ae.forEach(function(Db){return n(D,Db)}),et&&ms(D,Pe),Oe}function xt(D,j,P,Z){if(typeof P=="object"&&P!==null&&P.type===g&&P.key===null&&(P=P.props.children),typeof P=="object"&&P!==null){switch(P.$$typeof){case _:e:{for(var Oe=P.key;j!==null;){if(j.key===Oe){if(Oe=P.type,Oe===g){if(j.tag===7){s(D,j.sibling),Z=u(j,P.props.children),Z.return=D,D=Z;break e}}else if(j.elementType===Oe||typeof Oe=="object"&&Oe!==null&&Oe.$$typeof===q&&Ia(Oe)===j.type){s(D,j.sibling),Z=u(j,P.props),ml(Z,P),Z.return=D,D=Z;break e}s(D,j);break}else n(D,j);j=j.sibling}P.type===g?(Z=Ca(P.props.children,D.mode,Z,P.key),Z.return=D,D=Z):(Z=Er(P.type,P.key,P.props,null,D.mode,Z),ml(Z,P),Z.return=D,D=Z)}return x(D);case p:e:{for(Oe=P.key;j!==null;){if(j.key===Oe)if(j.tag===4&&j.stateNode.containerInfo===P.containerInfo&&j.stateNode.implementation===P.implementation){s(D,j.sibling),Z=u(j,P.children||[]),Z.return=D,D=Z;break e}else{s(D,j);break}else n(D,j);j=j.sibling}Z=fu(P,D.mode,Z),Z.return=D,D=Z}return x(D);case q:return P=Ia(P),xt(D,j,P,Z)}if(pe(P))return Se(D,j,P,Z);if(_e(P)){if(Oe=_e(P),typeof Oe!="function")throw Error(o(150));return P=Oe.call(P),Re(D,j,P,Z)}if(typeof P.then=="function")return xt(D,j,Rr(P),Z);if(P.$$typeof===M)return xt(D,j,Mr(D,P),Z);kr(D,P)}return typeof P=="string"&&P!==""||typeof P=="number"||typeof P=="bigint"?(P=""+P,j!==null&&j.tag===6?(s(D,j.sibling),Z=u(j,P),Z.return=D,D=Z):(s(D,j),Z=du(P,D.mode,Z),Z.return=D,D=Z),x(D)):s(D,j)}return function(D,j,P,Z){try{fl=0;var Oe=xt(D,j,P,Z);return xo=null,Oe}catch(Ae){if(Ae===bo||Ae===Cr)throw Ae;var it=ci(29,Ae,null,D.mode);return it.lanes=Z,it.return=D,it}}}var ja=Tm(!0),Em=Tm(!1),Vs=!1;function Eu(t){t.updateQueue={baseState:t.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function wu(t,n){t=t.updateQueue,n.updateQueue===t&&(n.updateQueue={baseState:t.baseState,firstBaseUpdate:t.firstBaseUpdate,lastBaseUpdate:t.lastBaseUpdate,shared:t.shared,callbacks:null})}function Ys(t){return{lane:t,tag:0,payload:null,callback:null,next:null}}function Fs(t,n,s){var l=t.updateQueue;if(l===null)return null;if(l=l.shared,(at&2)!==0){var u=l.pending;return u===null?n.next=n:(n.next=u.next,u.next=n),l.pending=n,n=Tr(t),lm(t,null,s),n}return Ar(t,l,n,s),Tr(t)}function pl(t,n,s){if(n=n.updateQueue,n!==null&&(n=n.shared,(s&4194048)!==0)){var l=n.lanes;l&=t.pendingLanes,s|=l,n.lanes=s,os(t,s)}}function _u(t,n){var s=t.updateQueue,l=t.alternate;if(l!==null&&(l=l.updateQueue,s===l)){var u=null,d=null;if(s=s.firstBaseUpdate,s!==null){do{var x={lane:s.lane,tag:s.tag,payload:s.payload,callback:null,next:null};d===null?u=d=x:d=d.next=x,s=s.next}while(s!==null);d===null?u=d=n:d=d.next=n}else u=d=n;s={baseState:l.baseState,firstBaseUpdate:u,lastBaseUpdate:d,shared:l.shared,callbacks:l.callbacks},t.updateQueue=s;return}t=s.lastBaseUpdate,t===null?s.firstBaseUpdate=n:t.next=n,s.lastBaseUpdate=n}var Mu=!1;function hl(){if(Mu){var t=yo;if(t!==null)throw t}}function gl(t,n,s,l){Mu=!1;var u=t.updateQueue;Vs=!1;var d=u.firstBaseUpdate,x=u.lastBaseUpdate,T=u.shared.pending;if(T!==null){u.shared.pending=null;var L=T,U=L.next;L.next=null,x===null?d=U:x.next=U,x=L;var Q=t.alternate;Q!==null&&(Q=Q.updateQueue,T=Q.lastBaseUpdate,T!==x&&(T===null?Q.firstBaseUpdate=U:T.next=U,Q.lastBaseUpdate=L))}if(d!==null){var ie=u.baseState;x=0,Q=U=L=null,T=d;do{var V=T.lane&-536870913,G=V!==T.lane;if(G?(We&V)===V:(l&V)===V){V!==0&&V===go&&(Mu=!0),Q!==null&&(Q=Q.next={lane:0,tag:T.tag,payload:T.payload,callback:null,next:null});e:{var Se=t,Re=T;V=n;var xt=s;switch(Re.tag){case 1:if(Se=Re.payload,typeof Se=="function"){ie=Se.call(xt,ie,V);break e}ie=Se;break e;case 3:Se.flags=Se.flags&-65537|128;case 0:if(Se=Re.payload,V=typeof Se=="function"?Se.call(xt,ie,V):Se,V==null)break e;ie=v({},ie,V);break e;case 2:Vs=!0}}V=T.callback,V!==null&&(t.flags|=64,G&&(t.flags|=8192),G=u.callbacks,G===null?u.callbacks=[V]:G.push(V))}else G={lane:V,tag:T.tag,payload:T.payload,callback:T.callback,next:null},Q===null?(U=Q=G,L=ie):Q=Q.next=G,x|=V;if(T=T.next,T===null){if(T=u.shared.pending,T===null)break;G=T,T=G.next,G.next=null,u.lastBaseUpdate=G,u.shared.pending=null}}while(!0);Q===null&&(L=ie),u.baseState=L,u.firstBaseUpdate=U,u.lastBaseUpdate=Q,d===null&&(u.shared.lanes=0),Qs|=x,t.lanes=x,t.memoizedState=ie}}function wm(t,n){if(typeof t!="function")throw Error(o(191,t));t.call(n)}function _m(t,n){var s=t.callbacks;if(s!==null)for(t.callbacks=null,t=0;t<s.length;t++)wm(s[t],n)}var vo=k(null),Lr=k(0);function Mm(t,n){t=Es,J(Lr,t),J(vo,n),Es=t|n.baseLanes}function Ou(){J(Lr,Es),J(vo,vo.current)}function Cu(){Es=Lr.current,$(vo),$(Lr)}var ui=k(null),Ri=null;function Ks(t){var n=t.alternate;J(Jt,Jt.current&1),J(ui,t),Ri===null&&(n===null||vo.current!==null||n.memoizedState!==null)&&(Ri=t)}function Nu(t){J(Jt,Jt.current),J(ui,t),Ri===null&&(Ri=t)}function Om(t){t.tag===22?(J(Jt,Jt.current),J(ui,t),Ri===null&&(Ri=t)):Gs()}function Gs(){J(Jt,Jt.current),J(ui,ui.current)}function di(t){$(ui),Ri===t&&(Ri=null),$(Jt)}var Jt=k(0);function Ir(t){for(var n=t;n!==null;){if(n.tag===13){var s=n.memoizedState;if(s!==null&&(s=s.dehydrated,s===null||jd(s)||Dd(s)))return n}else if(n.tag===19&&(n.memoizedProps.revealOrder==="forwards"||n.memoizedProps.revealOrder==="backwards"||n.memoizedProps.revealOrder==="unstable_legacy-backwards"||n.memoizedProps.revealOrder==="together")){if((n.flags&128)!==0)return n}else if(n.child!==null){n.child.return=n,n=n.child;continue}if(n===t)break;for(;n.sibling===null;){if(n.return===null||n.return===t)return null;n=n.return}n.sibling.return=n.return,n=n.sibling}return null}var gs=0,He=null,yt=null,on=null,Br=!1,So=!1,Da=!1,jr=0,yl=0,Ao=null,M0=0;function Yt(){throw Error(o(321))}function Ru(t,n){if(n===null)return!1;for(var s=0;s<n.length&&s<t.length;s++)if(!ri(t[s],n[s]))return!1;return!0}function ku(t,n,s,l,u,d){return gs=d,He=n,n.memoizedState=null,n.updateQueue=null,n.lanes=0,H.H=t===null||t.memoizedState===null?dp:Ku,Da=!1,d=s(l,u),Da=!1,So&&(d=Nm(n,s,l,u)),Cm(t),d}function Cm(t){H.H=vl;var n=yt!==null&&yt.next!==null;if(gs=0,on=yt=He=null,Br=!1,yl=0,Ao=null,n)throw Error(o(300));t===null||ln||(t=t.dependencies,t!==null&&_r(t)&&(ln=!0))}function Nm(t,n,s,l){He=t;var u=0;do{if(So&&(Ao=null),yl=0,So=!1,25<=u)throw Error(o(301));if(u+=1,on=yt=null,t.updateQueue!=null){var d=t.updateQueue;d.lastEffect=null,d.events=null,d.stores=null,d.memoCache!=null&&(d.memoCache.index=0)}H.H=fp,d=n(s,l)}while(So);return d}function O0(){var t=H.H,n=t.useState()[0];return n=typeof n.then=="function"?bl(n):n,t=t.useState()[0],(yt!==null?yt.memoizedState:null)!==t&&(He.flags|=1024),n}function Lu(){var t=jr!==0;return jr=0,t}function Iu(t,n,s){n.updateQueue=t.updateQueue,n.flags&=-2053,t.lanes&=~s}function Bu(t){if(Br){for(t=t.memoizedState;t!==null;){var n=t.queue;n!==null&&(n.pending=null),t=t.next}Br=!1}gs=0,on=yt=He=null,So=!1,yl=jr=0,Ao=null}function Kn(){var t={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return on===null?He.memoizedState=on=t:on=on.next=t,on}function Zt(){if(yt===null){var t=He.alternate;t=t!==null?t.memoizedState:null}else t=yt.next;var n=on===null?He.memoizedState:on.next;if(n!==null)on=n,yt=t;else{if(t===null)throw He.alternate===null?Error(o(467)):Error(o(310));yt=t,t={memoizedState:yt.memoizedState,baseState:yt.baseState,baseQueue:yt.baseQueue,queue:yt.queue,next:null},on===null?He.memoizedState=on=t:on=on.next=t}return on}function Dr(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function bl(t){var n=yl;return yl+=1,Ao===null&&(Ao=[]),t=vm(Ao,t,n),n=He,(on===null?n.memoizedState:on.next)===null&&(n=n.alternate,H.H=n===null||n.memoizedState===null?dp:Ku),t}function Hr(t){if(t!==null&&typeof t=="object"){if(typeof t.then=="function")return bl(t);if(t.$$typeof===M)return Cn(t)}throw Error(o(438,String(t)))}function ju(t){var n=null,s=He.updateQueue;if(s!==null&&(n=s.memoCache),n==null){var l=He.alternate;l!==null&&(l=l.updateQueue,l!==null&&(l=l.memoCache,l!=null&&(n={data:l.data.map(function(u){return u.slice()}),index:0})))}if(n==null&&(n={data:[],index:0}),s===null&&(s=Dr(),He.updateQueue=s),s.memoCache=n,s=n.data[n.index],s===void 0)for(s=n.data[n.index]=Array(t),l=0;l<t;l++)s[l]=ue;return n.index++,s}function ys(t,n){return typeof n=="function"?n(t):n}function Pr(t){var n=Zt();return Du(n,yt,t)}function Du(t,n,s){var l=t.queue;if(l===null)throw Error(o(311));l.lastRenderedReducer=s;var u=t.baseQueue,d=l.pending;if(d!==null){if(u!==null){var x=u.next;u.next=d.next,d.next=x}n.baseQueue=u=d,l.pending=null}if(d=t.baseState,u===null)t.memoizedState=d;else{n=u.next;var T=x=null,L=null,U=n,Q=!1;do{var ie=U.lane&-536870913;if(ie!==U.lane?(We&ie)===ie:(gs&ie)===ie){var V=U.revertLane;if(V===0)L!==null&&(L=L.next={lane:0,revertLane:0,gesture:null,action:U.action,hasEagerState:U.hasEagerState,eagerState:U.eagerState,next:null}),ie===go&&(Q=!0);else if((gs&V)===V){U=U.next,V===go&&(Q=!0);continue}else ie={lane:0,revertLane:U.revertLane,gesture:null,action:U.action,hasEagerState:U.hasEagerState,eagerState:U.eagerState,next:null},L===null?(T=L=ie,x=d):L=L.next=ie,He.lanes|=V,Qs|=V;ie=U.action,Da&&s(d,ie),d=U.hasEagerState?U.eagerState:s(d,ie)}else V={lane:ie,revertLane:U.revertLane,gesture:U.gesture,action:U.action,hasEagerState:U.hasEagerState,eagerState:U.eagerState,next:null},L===null?(T=L=V,x=d):L=L.next=V,He.lanes|=ie,Qs|=ie;U=U.next}while(U!==null&&U!==n);if(L===null?x=d:L.next=T,!ri(d,t.memoizedState)&&(ln=!0,Q&&(s=yo,s!==null)))throw s;t.memoizedState=d,t.baseState=x,t.baseQueue=L,l.lastRenderedState=d}return u===null&&(l.lanes=0),[t.memoizedState,l.dispatch]}function Hu(t){var n=Zt(),s=n.queue;if(s===null)throw Error(o(311));s.lastRenderedReducer=t;var l=s.dispatch,u=s.pending,d=n.memoizedState;if(u!==null){s.pending=null;var x=u=u.next;do d=t(d,x.action),x=x.next;while(x!==u);ri(d,n.memoizedState)||(ln=!0),n.memoizedState=d,n.baseQueue===null&&(n.baseState=d),s.lastRenderedState=d}return[d,l]}function Rm(t,n,s){var l=He,u=Zt(),d=et;if(d){if(s===void 0)throw Error(o(407));s=s()}else s=n();var x=!ri((yt||u).memoizedState,s);if(x&&(u.memoizedState=s,ln=!0),u=u.queue,qu(Im.bind(null,l,u,t),[t]),u.getSnapshot!==n||x||on!==null&&on.memoizedState.tag&1){if(l.flags|=2048,To(9,{destroy:void 0},Lm.bind(null,l,u,s,n),null),wt===null)throw Error(o(349));d||(gs&127)!==0||km(l,n,s)}return s}function km(t,n,s){t.flags|=16384,t={getSnapshot:n,value:s},n=He.updateQueue,n===null?(n=Dr(),He.updateQueue=n,n.stores=[t]):(s=n.stores,s===null?n.stores=[t]:s.push(t))}function Lm(t,n,s,l){n.value=s,n.getSnapshot=l,Bm(n)&&jm(t)}function Im(t,n,s){return s(function(){Bm(n)&&jm(t)})}function Bm(t){var n=t.getSnapshot;t=t.value;try{var s=n();return!ri(t,s)}catch{return!0}}function jm(t){var n=Oa(t,2);n!==null&&ni(n,t,2)}function Pu(t){var n=Kn();if(typeof t=="function"){var s=t;if(t=s(),Da){yn(!0);try{s()}finally{yn(!1)}}}return n.memoizedState=n.baseState=t,n.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:ys,lastRenderedState:t},n}function Dm(t,n,s,l){return t.baseState=s,Du(t,yt,typeof l=="function"?l:ys)}function C0(t,n,s,l,u){if(zr(t))throw Error(o(485));if(t=n.action,t!==null){var d={payload:u,action:t,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(x){d.listeners.push(x)}};H.T!==null?s(!0):d.isTransition=!1,l(d),s=n.pending,s===null?(d.next=n.pending=d,Hm(n,d)):(d.next=s.next,n.pending=s.next=d)}}function Hm(t,n){var s=n.action,l=n.payload,u=t.state;if(n.isTransition){var d=H.T,x={};H.T=x;try{var T=s(u,l),L=H.S;L!==null&&L(x,T),Pm(t,n,T)}catch(U){Uu(t,n,U)}finally{d!==null&&x.types!==null&&(d.types=x.types),H.T=d}}else try{d=s(u,l),Pm(t,n,d)}catch(U){Uu(t,n,U)}}function Pm(t,n,s){s!==null&&typeof s=="object"&&typeof s.then=="function"?s.then(function(l){Um(t,n,l)},function(l){return Uu(t,n,l)}):Um(t,n,s)}function Um(t,n,s){n.status="fulfilled",n.value=s,qm(n),t.state=s,n=t.pending,n!==null&&(s=n.next,s===n?t.pending=null:(s=s.next,n.next=s,Hm(t,s)))}function Uu(t,n,s){var l=t.pending;if(t.pending=null,l!==null){l=l.next;do n.status="rejected",n.reason=s,qm(n),n=n.next;while(n!==l)}t.action=null}function qm(t){t=t.listeners;for(var n=0;n<t.length;n++)(0,t[n])()}function zm(t,n){return n}function $m(t,n){if(et){var s=wt.formState;if(s!==null){e:{var l=He;if(et){if(Lt){t:{for(var u=Lt,d=Ni;u.nodeType!==8;){if(!d){u=null;break t}if(u=ki(u.nextSibling),u===null){u=null;break t}}d=u.data,u=d==="F!"||d==="F"?u:null}if(u){Lt=ki(u.nextSibling),l=u.data==="F!";break e}}zs(l)}l=!1}l&&(n=s[0])}}return s=Kn(),s.memoizedState=s.baseState=n,l={pending:null,lanes:0,dispatch:null,lastRenderedReducer:zm,lastRenderedState:n},s.queue=l,s=rp.bind(null,He,l),l.dispatch=s,l=Pu(!1),d=Fu.bind(null,He,!1,l.queue),l=Kn(),u={state:n,dispatch:null,action:t,pending:null},l.queue=u,s=C0.bind(null,He,u,d,s),u.dispatch=s,l.memoizedState=t,[n,s,!1]}function Vm(t){var n=Zt();return Ym(n,yt,t)}function Ym(t,n,s){if(n=Du(t,n,zm)[0],t=Pr(ys)[0],typeof n=="object"&&n!==null&&typeof n.then=="function")try{var l=bl(n)}catch(x){throw x===bo?Cr:x}else l=n;n=Zt();var u=n.queue,d=u.dispatch;return s!==n.memoizedState&&(He.flags|=2048,To(9,{destroy:void 0},N0.bind(null,u,s),null)),[l,d,t]}function N0(t,n){t.action=n}function Fm(t){var n=Zt(),s=yt;if(s!==null)return Ym(n,s,t);Zt(),n=n.memoizedState,s=Zt();var l=s.queue.dispatch;return s.memoizedState=t,[n,l,!1]}function To(t,n,s,l){return t={tag:t,create:s,deps:l,inst:n,next:null},n=He.updateQueue,n===null&&(n=Dr(),He.updateQueue=n),s=n.lastEffect,s===null?n.lastEffect=t.next=t:(l=s.next,s.next=t,t.next=l,n.lastEffect=t),t}function Km(){return Zt().memoizedState}function Ur(t,n,s,l){var u=Kn();He.flags|=t,u.memoizedState=To(1|n,{destroy:void 0},s,l===void 0?null:l)}function qr(t,n,s,l){var u=Zt();l=l===void 0?null:l;var d=u.memoizedState.inst;yt!==null&&l!==null&&Ru(l,yt.memoizedState.deps)?u.memoizedState=To(n,d,s,l):(He.flags|=t,u.memoizedState=To(1|n,d,s,l))}function Gm(t,n){Ur(8390656,8,t,n)}function qu(t,n){qr(2048,8,t,n)}function R0(t){He.flags|=4;var n=He.updateQueue;if(n===null)n=Dr(),He.updateQueue=n,n.events=[t];else{var s=n.events;s===null?n.events=[t]:s.push(t)}}function Wm(t){var n=Zt().memoizedState;return R0({ref:n,nextImpl:t}),function(){if((at&2)!==0)throw Error(o(440));return n.impl.apply(void 0,arguments)}}function Xm(t,n){return qr(4,2,t,n)}function Qm(t,n){return qr(4,4,t,n)}function Jm(t,n){if(typeof n=="function"){t=t();var s=n(t);return function(){typeof s=="function"?s():n(null)}}if(n!=null)return t=t(),n.current=t,function(){n.current=null}}function Zm(t,n,s){s=s!=null?s.concat([t]):null,qr(4,4,Jm.bind(null,n,t),s)}function zu(){}function ep(t,n){var s=Zt();n=n===void 0?null:n;var l=s.memoizedState;return n!==null&&Ru(n,l[1])?l[0]:(s.memoizedState=[t,n],t)}function tp(t,n){var s=Zt();n=n===void 0?null:n;var l=s.memoizedState;if(n!==null&&Ru(n,l[1]))return l[0];if(l=t(),Da){yn(!0);try{t()}finally{yn(!1)}}return s.memoizedState=[l,n],l}function $u(t,n,s){return s===void 0||(gs&1073741824)!==0&&(We&261930)===0?t.memoizedState=n:(t.memoizedState=s,t=nh(),He.lanes|=t,Qs|=t,s)}function np(t,n,s,l){return ri(s,n)?s:vo.current!==null?(t=$u(t,s,l),ri(t,n)||(ln=!0),t):(gs&42)===0||(gs&1073741824)!==0&&(We&261930)===0?(ln=!0,t.memoizedState=s):(t=nh(),He.lanes|=t,Qs|=t,n)}function ip(t,n,s,l,u){var d=ee.p;ee.p=d!==0&&8>d?d:8;var x=H.T,T={};H.T=T,Fu(t,!1,n,s);try{var L=u(),U=H.S;if(U!==null&&U(T,L),L!==null&&typeof L=="object"&&typeof L.then=="function"){var Q=_0(L,l);xl(t,n,Q,pi(t))}else xl(t,n,l,pi(t))}catch(ie){xl(t,n,{then:function(){},status:"rejected",reason:ie},pi())}finally{ee.p=d,x!==null&&T.types!==null&&(x.types=T.types),H.T=x}}function k0(){}function Vu(t,n,s,l){if(t.tag!==5)throw Error(o(476));var u=sp(t).queue;ip(t,u,n,ae,s===null?k0:function(){return ap(t),s(l)})}function sp(t){var n=t.memoizedState;if(n!==null)return n;n={memoizedState:ae,baseState:ae,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:ys,lastRenderedState:ae},next:null};var s={};return n.next={memoizedState:s,baseState:s,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:ys,lastRenderedState:s},next:null},t.memoizedState=n,t=t.alternate,t!==null&&(t.memoizedState=n),n}function ap(t){var n=sp(t);n.next===null&&(n=t.alternate.memoizedState),xl(t,n.next.queue,{},pi())}function Yu(){return Cn(jl)}function op(){return Zt().memoizedState}function lp(){return Zt().memoizedState}function L0(t){for(var n=t.return;n!==null;){switch(n.tag){case 24:case 3:var s=pi();t=Ys(s);var l=Fs(n,t,s);l!==null&&(ni(l,n,s),pl(l,n,s)),n={cache:vu()},t.payload=n;return}n=n.return}}function I0(t,n,s){var l=pi();s={lane:l,revertLane:0,gesture:null,action:s,hasEagerState:!1,eagerState:null,next:null},zr(t)?cp(n,s):(s=cu(t,n,s,l),s!==null&&(ni(s,t,l),up(s,n,l)))}function rp(t,n,s){var l=pi();xl(t,n,s,l)}function xl(t,n,s,l){var u={lane:l,revertLane:0,gesture:null,action:s,hasEagerState:!1,eagerState:null,next:null};if(zr(t))cp(n,u);else{var d=t.alternate;if(t.lanes===0&&(d===null||d.lanes===0)&&(d=n.lastRenderedReducer,d!==null))try{var x=n.lastRenderedState,T=d(x,s);if(u.hasEagerState=!0,u.eagerState=T,ri(T,x))return Ar(t,n,u,0),wt===null&&Sr(),!1}catch{}if(s=cu(t,n,u,l),s!==null)return ni(s,t,l),up(s,n,l),!0}return!1}function Fu(t,n,s,l){if(l={lane:2,revertLane:Ed(),gesture:null,action:l,hasEagerState:!1,eagerState:null,next:null},zr(t)){if(n)throw Error(o(479))}else n=cu(t,s,l,2),n!==null&&ni(n,t,2)}function zr(t){var n=t.alternate;return t===He||n!==null&&n===He}function cp(t,n){So=Br=!0;var s=t.pending;s===null?n.next=n:(n.next=s.next,s.next=n),t.pending=n}function up(t,n,s){if((s&4194048)!==0){var l=n.lanes;l&=t.pendingLanes,s|=l,n.lanes=s,os(t,s)}}var vl={readContext:Cn,use:Hr,useCallback:Yt,useContext:Yt,useEffect:Yt,useImperativeHandle:Yt,useLayoutEffect:Yt,useInsertionEffect:Yt,useMemo:Yt,useReducer:Yt,useRef:Yt,useState:Yt,useDebugValue:Yt,useDeferredValue:Yt,useTransition:Yt,useSyncExternalStore:Yt,useId:Yt,useHostTransitionStatus:Yt,useFormState:Yt,useActionState:Yt,useOptimistic:Yt,useMemoCache:Yt,useCacheRefresh:Yt};vl.useEffectEvent=Yt;var dp={readContext:Cn,use:Hr,useCallback:function(t,n){return Kn().memoizedState=[t,n===void 0?null:n],t},useContext:Cn,useEffect:Gm,useImperativeHandle:function(t,n,s){s=s!=null?s.concat([t]):null,Ur(4194308,4,Jm.bind(null,n,t),s)},useLayoutEffect:function(t,n){return Ur(4194308,4,t,n)},useInsertionEffect:function(t,n){Ur(4,2,t,n)},useMemo:function(t,n){var s=Kn();n=n===void 0?null:n;var l=t();if(Da){yn(!0);try{t()}finally{yn(!1)}}return s.memoizedState=[l,n],l},useReducer:function(t,n,s){var l=Kn();if(s!==void 0){var u=s(n);if(Da){yn(!0);try{s(n)}finally{yn(!1)}}}else u=n;return l.memoizedState=l.baseState=u,t={pending:null,lanes:0,dispatch:null,lastRenderedReducer:t,lastRenderedState:u},l.queue=t,t=t.dispatch=I0.bind(null,He,t),[l.memoizedState,t]},useRef:function(t){var n=Kn();return t={current:t},n.memoizedState=t},useState:function(t){t=Pu(t);var n=t.queue,s=rp.bind(null,He,n);return n.dispatch=s,[t.memoizedState,s]},useDebugValue:zu,useDeferredValue:function(t,n){var s=Kn();return $u(s,t,n)},useTransition:function(){var t=Pu(!1);return t=ip.bind(null,He,t.queue,!0,!1),Kn().memoizedState=t,[!1,t]},useSyncExternalStore:function(t,n,s){var l=He,u=Kn();if(et){if(s===void 0)throw Error(o(407));s=s()}else{if(s=n(),wt===null)throw Error(o(349));(We&127)!==0||km(l,n,s)}u.memoizedState=s;var d={value:s,getSnapshot:n};return u.queue=d,Gm(Im.bind(null,l,d,t),[t]),l.flags|=2048,To(9,{destroy:void 0},Lm.bind(null,l,d,s,n),null),s},useId:function(){var t=Kn(),n=wt.identifierPrefix;if(et){var s=es,l=Zi;s=(l&~(1<<32-Ut(l)-1)).toString(32)+s,n="_"+n+"R_"+s,s=jr++,0<s&&(n+="H"+s.toString(32)),n+="_"}else s=M0++,n="_"+n+"r_"+s.toString(32)+"_";return t.memoizedState=n},useHostTransitionStatus:Yu,useFormState:$m,useActionState:$m,useOptimistic:function(t){var n=Kn();n.memoizedState=n.baseState=t;var s={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return n.queue=s,n=Fu.bind(null,He,!0,s),s.dispatch=n,[t,n]},useMemoCache:ju,useCacheRefresh:function(){return Kn().memoizedState=L0.bind(null,He)},useEffectEvent:function(t){var n=Kn(),s={impl:t};return n.memoizedState=s,function(){if((at&2)!==0)throw Error(o(440));return s.impl.apply(void 0,arguments)}}},Ku={readContext:Cn,use:Hr,useCallback:ep,useContext:Cn,useEffect:qu,useImperativeHandle:Zm,useInsertionEffect:Xm,useLayoutEffect:Qm,useMemo:tp,useReducer:Pr,useRef:Km,useState:function(){return Pr(ys)},useDebugValue:zu,useDeferredValue:function(t,n){var s=Zt();return np(s,yt.memoizedState,t,n)},useTransition:function(){var t=Pr(ys)[0],n=Zt().memoizedState;return[typeof t=="boolean"?t:bl(t),n]},useSyncExternalStore:Rm,useId:op,useHostTransitionStatus:Yu,useFormState:Vm,useActionState:Vm,useOptimistic:function(t,n){var s=Zt();return Dm(s,yt,t,n)},useMemoCache:ju,useCacheRefresh:lp};Ku.useEffectEvent=Wm;var fp={readContext:Cn,use:Hr,useCallback:ep,useContext:Cn,useEffect:qu,useImperativeHandle:Zm,useInsertionEffect:Xm,useLayoutEffect:Qm,useMemo:tp,useReducer:Hu,useRef:Km,useState:function(){return Hu(ys)},useDebugValue:zu,useDeferredValue:function(t,n){var s=Zt();return yt===null?$u(s,t,n):np(s,yt.memoizedState,t,n)},useTransition:function(){var t=Hu(ys)[0],n=Zt().memoizedState;return[typeof t=="boolean"?t:bl(t),n]},useSyncExternalStore:Rm,useId:op,useHostTransitionStatus:Yu,useFormState:Fm,useActionState:Fm,useOptimistic:function(t,n){var s=Zt();return yt!==null?Dm(s,yt,t,n):(s.baseState=t,[t,s.queue.dispatch])},useMemoCache:ju,useCacheRefresh:lp};fp.useEffectEvent=Wm;function Gu(t,n,s,l){n=t.memoizedState,s=s(l,n),s=s==null?n:v({},n,s),t.memoizedState=s,t.lanes===0&&(t.updateQueue.baseState=s)}var Wu={enqueueSetState:function(t,n,s){t=t._reactInternals;var l=pi(),u=Ys(l);u.payload=n,s!=null&&(u.callback=s),n=Fs(t,u,l),n!==null&&(ni(n,t,l),pl(n,t,l))},enqueueReplaceState:function(t,n,s){t=t._reactInternals;var l=pi(),u=Ys(l);u.tag=1,u.payload=n,s!=null&&(u.callback=s),n=Fs(t,u,l),n!==null&&(ni(n,t,l),pl(n,t,l))},enqueueForceUpdate:function(t,n){t=t._reactInternals;var s=pi(),l=Ys(s);l.tag=2,n!=null&&(l.callback=n),n=Fs(t,l,s),n!==null&&(ni(n,t,s),pl(n,t,s))}};function mp(t,n,s,l,u,d,x){return t=t.stateNode,typeof t.shouldComponentUpdate=="function"?t.shouldComponentUpdate(l,d,x):n.prototype&&n.prototype.isPureReactComponent?!ol(s,l)||!ol(u,d):!0}function pp(t,n,s,l){t=n.state,typeof n.componentWillReceiveProps=="function"&&n.componentWillReceiveProps(s,l),typeof n.UNSAFE_componentWillReceiveProps=="function"&&n.UNSAFE_componentWillReceiveProps(s,l),n.state!==t&&Wu.enqueueReplaceState(n,n.state,null)}function Ha(t,n){var s=n;if("ref"in n){s={};for(var l in n)l!=="ref"&&(s[l]=n[l])}if(t=t.defaultProps){s===n&&(s=v({},s));for(var u in t)s[u]===void 0&&(s[u]=t[u])}return s}function hp(t){vr(t)}function gp(t){console.error(t)}function yp(t){vr(t)}function $r(t,n){try{var s=t.onUncaughtError;s(n.value,{componentStack:n.stack})}catch(l){setTimeout(function(){throw l})}}function bp(t,n,s){try{var l=t.onCaughtError;l(s.value,{componentStack:s.stack,errorBoundary:n.tag===1?n.stateNode:null})}catch(u){setTimeout(function(){throw u})}}function Xu(t,n,s){return s=Ys(s),s.tag=3,s.payload={element:null},s.callback=function(){$r(t,n)},s}function xp(t){return t=Ys(t),t.tag=3,t}function vp(t,n,s,l){var u=s.type.getDerivedStateFromError;if(typeof u=="function"){var d=l.value;t.payload=function(){return u(d)},t.callback=function(){bp(n,s,l)}}var x=s.stateNode;x!==null&&typeof x.componentDidCatch=="function"&&(t.callback=function(){bp(n,s,l),typeof u!="function"&&(Js===null?Js=new Set([this]):Js.add(this));var T=l.stack;this.componentDidCatch(l.value,{componentStack:T!==null?T:""})})}function B0(t,n,s,l,u){if(s.flags|=32768,l!==null&&typeof l=="object"&&typeof l.then=="function"){if(n=s.alternate,n!==null&&ho(n,s,u,!0),s=ui.current,s!==null){switch(s.tag){case 31:case 13:return Ri===null?tc():s.alternate===null&&Ft===0&&(Ft=3),s.flags&=-257,s.flags|=65536,s.lanes=u,l===Nr?s.flags|=16384:(n=s.updateQueue,n===null?s.updateQueue=new Set([l]):n.add(l),Sd(t,l,u)),!1;case 22:return s.flags|=65536,l===Nr?s.flags|=16384:(n=s.updateQueue,n===null?(n={transitions:null,markerInstances:null,retryQueue:new Set([l])},s.updateQueue=n):(s=n.retryQueue,s===null?n.retryQueue=new Set([l]):s.add(l)),Sd(t,l,u)),!1}throw Error(o(435,s.tag))}return Sd(t,l,u),tc(),!1}if(et)return n=ui.current,n!==null?((n.flags&65536)===0&&(n.flags|=256),n.flags|=65536,n.lanes=u,l!==hu&&(t=Error(o(422),{cause:l}),cl(Mi(t,s)))):(l!==hu&&(n=Error(o(423),{cause:l}),cl(Mi(n,s))),t=t.current.alternate,t.flags|=65536,u&=-u,t.lanes|=u,l=Mi(l,s),u=Xu(t.stateNode,l,u),_u(t,u),Ft!==4&&(Ft=2)),!1;var d=Error(o(520),{cause:l});if(d=Mi(d,s),Ol===null?Ol=[d]:Ol.push(d),Ft!==4&&(Ft=2),n===null)return!0;l=Mi(l,s),s=n;do{switch(s.tag){case 3:return s.flags|=65536,t=u&-u,s.lanes|=t,t=Xu(s.stateNode,l,t),_u(s,t),!1;case 1:if(n=s.type,d=s.stateNode,(s.flags&128)===0&&(typeof n.getDerivedStateFromError=="function"||d!==null&&typeof d.componentDidCatch=="function"&&(Js===null||!Js.has(d))))return s.flags|=65536,u&=-u,s.lanes|=u,u=xp(u),vp(u,t,s,l),_u(s,u),!1}s=s.return}while(s!==null);return!1}var Qu=Error(o(461)),ln=!1;function Nn(t,n,s,l){n.child=t===null?Em(n,null,s,l):ja(n,t.child,s,l)}function Sp(t,n,s,l,u){s=s.render;var d=n.ref;if("ref"in l){var x={};for(var T in l)T!=="ref"&&(x[T]=l[T])}else x=l;return ka(n),l=ku(t,n,s,x,d,u),T=Lu(),t!==null&&!ln?(Iu(t,n,u),bs(t,n,u)):(et&&T&&mu(n),n.flags|=1,Nn(t,n,l,u),n.child)}function Ap(t,n,s,l,u){if(t===null){var d=s.type;return typeof d=="function"&&!uu(d)&&d.defaultProps===void 0&&s.compare===null?(n.tag=15,n.type=d,Tp(t,n,d,l,u)):(t=Er(s.type,null,l,n,n.mode,u),t.ref=n.ref,t.return=n,n.child=t)}if(d=t.child,!ad(t,u)){var x=d.memoizedProps;if(s=s.compare,s=s!==null?s:ol,s(x,l)&&t.ref===n.ref)return bs(t,n,u)}return n.flags|=1,t=fs(d,l),t.ref=n.ref,t.return=n,n.child=t}function Tp(t,n,s,l,u){if(t!==null){var d=t.memoizedProps;if(ol(d,l)&&t.ref===n.ref)if(ln=!1,n.pendingProps=l=d,ad(t,u))(t.flags&131072)!==0&&(ln=!0);else return n.lanes=t.lanes,bs(t,n,u)}return Ju(t,n,s,l,u)}function Ep(t,n,s,l){var u=l.children,d=t!==null?t.memoizedState:null;if(t===null&&n.stateNode===null&&(n.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),l.mode==="hidden"){if((n.flags&128)!==0){if(d=d!==null?d.baseLanes|s:s,t!==null){for(l=n.child=t.child,u=0;l!==null;)u=u|l.lanes|l.childLanes,l=l.sibling;l=u&~d}else l=0,n.child=null;return wp(t,n,d,s,l)}if((s&536870912)!==0)n.memoizedState={baseLanes:0,cachePool:null},t!==null&&Or(n,d!==null?d.cachePool:null),d!==null?Mm(n,d):Ou(),Om(n);else return l=n.lanes=536870912,wp(t,n,d!==null?d.baseLanes|s:s,s,l)}else d!==null?(Or(n,d.cachePool),Mm(n,d),Gs(),n.memoizedState=null):(t!==null&&Or(n,null),Ou(),Gs());return Nn(t,n,u,s),n.child}function Sl(t,n){return t!==null&&t.tag===22||n.stateNode!==null||(n.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),n.sibling}function wp(t,n,s,l,u){var d=Au();return d=d===null?null:{parent:an._currentValue,pool:d},n.memoizedState={baseLanes:s,cachePool:d},t!==null&&Or(n,null),Ou(),Om(n),t!==null&&ho(t,n,l,!0),n.childLanes=u,null}function Vr(t,n){return n=Fr({mode:n.mode,children:n.children},t.mode),n.ref=t.ref,t.child=n,n.return=t,n}function _p(t,n,s){return ja(n,t.child,null,s),t=Vr(n,n.pendingProps),t.flags|=2,di(n),n.memoizedState=null,t}function j0(t,n,s){var l=n.pendingProps,u=(n.flags&128)!==0;if(n.flags&=-129,t===null){if(et){if(l.mode==="hidden")return t=Vr(n,l),n.lanes=536870912,Sl(null,t);if(Nu(n),(t=Lt)?(t=Hh(t,Ni),t=t!==null&&t.data==="&"?t:null,t!==null&&(n.memoizedState={dehydrated:t,treeContext:Us!==null?{id:Zi,overflow:es}:null,retryLane:536870912,hydrationErrors:null},s=cm(t),s.return=n,n.child=s,On=n,Lt=null)):t=null,t===null)throw zs(n);return n.lanes=536870912,null}return Vr(n,l)}var d=t.memoizedState;if(d!==null){var x=d.dehydrated;if(Nu(n),u)if(n.flags&256)n.flags&=-257,n=_p(t,n,s);else if(n.memoizedState!==null)n.child=t.child,n.flags|=128,n=null;else throw Error(o(558));else if(ln||ho(t,n,s,!1),u=(s&t.childLanes)!==0,ln||u){if(l=wt,l!==null&&(x=Fi(l,s),x!==0&&x!==d.retryLane))throw d.retryLane=x,Oa(t,x),ni(l,t,x),Qu;tc(),n=_p(t,n,s)}else t=d.treeContext,Lt=ki(x.nextSibling),On=n,et=!0,qs=null,Ni=!1,t!==null&&fm(n,t),n=Vr(n,l),n.flags|=4096;return n}return t=fs(t.child,{mode:l.mode,children:l.children}),t.ref=n.ref,n.child=t,t.return=n,t}function Yr(t,n){var s=n.ref;if(s===null)t!==null&&t.ref!==null&&(n.flags|=4194816);else{if(typeof s!="function"&&typeof s!="object")throw Error(o(284));(t===null||t.ref!==s)&&(n.flags|=4194816)}}function Ju(t,n,s,l,u){return ka(n),s=ku(t,n,s,l,void 0,u),l=Lu(),t!==null&&!ln?(Iu(t,n,u),bs(t,n,u)):(et&&l&&mu(n),n.flags|=1,Nn(t,n,s,u),n.child)}function Mp(t,n,s,l,u,d){return ka(n),n.updateQueue=null,s=Nm(n,l,s,u),Cm(t),l=Lu(),t!==null&&!ln?(Iu(t,n,d),bs(t,n,d)):(et&&l&&mu(n),n.flags|=1,Nn(t,n,s,d),n.child)}function Op(t,n,s,l,u){if(ka(n),n.stateNode===null){var d=uo,x=s.contextType;typeof x=="object"&&x!==null&&(d=Cn(x)),d=new s(l,d),n.memoizedState=d.state!==null&&d.state!==void 0?d.state:null,d.updater=Wu,n.stateNode=d,d._reactInternals=n,d=n.stateNode,d.props=l,d.state=n.memoizedState,d.refs={},Eu(n),x=s.contextType,d.context=typeof x=="object"&&x!==null?Cn(x):uo,d.state=n.memoizedState,x=s.getDerivedStateFromProps,typeof x=="function"&&(Gu(n,s,x,l),d.state=n.memoizedState),typeof s.getDerivedStateFromProps=="function"||typeof d.getSnapshotBeforeUpdate=="function"||typeof d.UNSAFE_componentWillMount!="function"&&typeof d.componentWillMount!="function"||(x=d.state,typeof d.componentWillMount=="function"&&d.componentWillMount(),typeof d.UNSAFE_componentWillMount=="function"&&d.UNSAFE_componentWillMount(),x!==d.state&&Wu.enqueueReplaceState(d,d.state,null),gl(n,l,d,u),hl(),d.state=n.memoizedState),typeof d.componentDidMount=="function"&&(n.flags|=4194308),l=!0}else if(t===null){d=n.stateNode;var T=n.memoizedProps,L=Ha(s,T);d.props=L;var U=d.context,Q=s.contextType;x=uo,typeof Q=="object"&&Q!==null&&(x=Cn(Q));var ie=s.getDerivedStateFromProps;Q=typeof ie=="function"||typeof d.getSnapshotBeforeUpdate=="function",T=n.pendingProps!==T,Q||typeof d.UNSAFE_componentWillReceiveProps!="function"&&typeof d.componentWillReceiveProps!="function"||(T||U!==x)&&pp(n,d,l,x),Vs=!1;var V=n.memoizedState;d.state=V,gl(n,l,d,u),hl(),U=n.memoizedState,T||V!==U||Vs?(typeof ie=="function"&&(Gu(n,s,ie,l),U=n.memoizedState),(L=Vs||mp(n,s,L,l,V,U,x))?(Q||typeof d.UNSAFE_componentWillMount!="function"&&typeof d.componentWillMount!="function"||(typeof d.componentWillMount=="function"&&d.componentWillMount(),typeof d.UNSAFE_componentWillMount=="function"&&d.UNSAFE_componentWillMount()),typeof d.componentDidMount=="function"&&(n.flags|=4194308)):(typeof d.componentDidMount=="function"&&(n.flags|=4194308),n.memoizedProps=l,n.memoizedState=U),d.props=l,d.state=U,d.context=x,l=L):(typeof d.componentDidMount=="function"&&(n.flags|=4194308),l=!1)}else{d=n.stateNode,wu(t,n),x=n.memoizedProps,Q=Ha(s,x),d.props=Q,ie=n.pendingProps,V=d.context,U=s.contextType,L=uo,typeof U=="object"&&U!==null&&(L=Cn(U)),T=s.getDerivedStateFromProps,(U=typeof T=="function"||typeof d.getSnapshotBeforeUpdate=="function")||typeof d.UNSAFE_componentWillReceiveProps!="function"&&typeof d.componentWillReceiveProps!="function"||(x!==ie||V!==L)&&pp(n,d,l,L),Vs=!1,V=n.memoizedState,d.state=V,gl(n,l,d,u),hl();var G=n.memoizedState;x!==ie||V!==G||Vs||t!==null&&t.dependencies!==null&&_r(t.dependencies)?(typeof T=="function"&&(Gu(n,s,T,l),G=n.memoizedState),(Q=Vs||mp(n,s,Q,l,V,G,L)||t!==null&&t.dependencies!==null&&_r(t.dependencies))?(U||typeof d.UNSAFE_componentWillUpdate!="function"&&typeof d.componentWillUpdate!="function"||(typeof d.componentWillUpdate=="function"&&d.componentWillUpdate(l,G,L),typeof d.UNSAFE_componentWillUpdate=="function"&&d.UNSAFE_componentWillUpdate(l,G,L)),typeof d.componentDidUpdate=="function"&&(n.flags|=4),typeof d.getSnapshotBeforeUpdate=="function"&&(n.flags|=1024)):(typeof d.componentDidUpdate!="function"||x===t.memoizedProps&&V===t.memoizedState||(n.flags|=4),typeof d.getSnapshotBeforeUpdate!="function"||x===t.memoizedProps&&V===t.memoizedState||(n.flags|=1024),n.memoizedProps=l,n.memoizedState=G),d.props=l,d.state=G,d.context=L,l=Q):(typeof d.componentDidUpdate!="function"||x===t.memoizedProps&&V===t.memoizedState||(n.flags|=4),typeof d.getSnapshotBeforeUpdate!="function"||x===t.memoizedProps&&V===t.memoizedState||(n.flags|=1024),l=!1)}return d=l,Yr(t,n),l=(n.flags&128)!==0,d||l?(d=n.stateNode,s=l&&typeof s.getDerivedStateFromError!="function"?null:d.render(),n.flags|=1,t!==null&&l?(n.child=ja(n,t.child,null,u),n.child=ja(n,null,s,u)):Nn(t,n,s,u),n.memoizedState=d.state,t=n.child):t=bs(t,n,u),t}function Cp(t,n,s,l){return Na(),n.flags|=256,Nn(t,n,s,l),n.child}var Zu={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function ed(t){return{baseLanes:t,cachePool:bm()}}function td(t,n,s){return t=t!==null?t.childLanes&~s:0,n&&(t|=mi),t}function Np(t,n,s){var l=n.pendingProps,u=!1,d=(n.flags&128)!==0,x;if((x=d)||(x=t!==null&&t.memoizedState===null?!1:(Jt.current&2)!==0),x&&(u=!0,n.flags&=-129),x=(n.flags&32)!==0,n.flags&=-33,t===null){if(et){if(u?Ks(n):Gs(),(t=Lt)?(t=Hh(t,Ni),t=t!==null&&t.data!=="&"?t:null,t!==null&&(n.memoizedState={dehydrated:t,treeContext:Us!==null?{id:Zi,overflow:es}:null,retryLane:536870912,hydrationErrors:null},s=cm(t),s.return=n,n.child=s,On=n,Lt=null)):t=null,t===null)throw zs(n);return Dd(t)?n.lanes=32:n.lanes=536870912,null}var T=l.children;return l=l.fallback,u?(Gs(),u=n.mode,T=Fr({mode:"hidden",children:T},u),l=Ca(l,u,s,null),T.return=n,l.return=n,T.sibling=l,n.child=T,l=n.child,l.memoizedState=ed(s),l.childLanes=td(t,x,s),n.memoizedState=Zu,Sl(null,l)):(Ks(n),nd(n,T))}var L=t.memoizedState;if(L!==null&&(T=L.dehydrated,T!==null)){if(d)n.flags&256?(Ks(n),n.flags&=-257,n=id(t,n,s)):n.memoizedState!==null?(Gs(),n.child=t.child,n.flags|=128,n=null):(Gs(),T=l.fallback,u=n.mode,l=Fr({mode:"visible",children:l.children},u),T=Ca(T,u,s,null),T.flags|=2,l.return=n,T.return=n,l.sibling=T,n.child=l,ja(n,t.child,null,s),l=n.child,l.memoizedState=ed(s),l.childLanes=td(t,x,s),n.memoizedState=Zu,n=Sl(null,l));else if(Ks(n),Dd(T)){if(x=T.nextSibling&&T.nextSibling.dataset,x)var U=x.dgst;x=U,l=Error(o(419)),l.stack="",l.digest=x,cl({value:l,source:null,stack:null}),n=id(t,n,s)}else if(ln||ho(t,n,s,!1),x=(s&t.childLanes)!==0,ln||x){if(x=wt,x!==null&&(l=Fi(x,s),l!==0&&l!==L.retryLane))throw L.retryLane=l,Oa(t,l),ni(x,t,l),Qu;jd(T)||tc(),n=id(t,n,s)}else jd(T)?(n.flags|=192,n.child=t.child,n=null):(t=L.treeContext,Lt=ki(T.nextSibling),On=n,et=!0,qs=null,Ni=!1,t!==null&&fm(n,t),n=nd(n,l.children),n.flags|=4096);return n}return u?(Gs(),T=l.fallback,u=n.mode,L=t.child,U=L.sibling,l=fs(L,{mode:"hidden",children:l.children}),l.subtreeFlags=L.subtreeFlags&65011712,U!==null?T=fs(U,T):(T=Ca(T,u,s,null),T.flags|=2),T.return=n,l.return=n,l.sibling=T,n.child=l,Sl(null,l),l=n.child,T=t.child.memoizedState,T===null?T=ed(s):(u=T.cachePool,u!==null?(L=an._currentValue,u=u.parent!==L?{parent:L,pool:L}:u):u=bm(),T={baseLanes:T.baseLanes|s,cachePool:u}),l.memoizedState=T,l.childLanes=td(t,x,s),n.memoizedState=Zu,Sl(t.child,l)):(Ks(n),s=t.child,t=s.sibling,s=fs(s,{mode:"visible",children:l.children}),s.return=n,s.sibling=null,t!==null&&(x=n.deletions,x===null?(n.deletions=[t],n.flags|=16):x.push(t)),n.child=s,n.memoizedState=null,s)}function nd(t,n){return n=Fr({mode:"visible",children:n},t.mode),n.return=t,t.child=n}function Fr(t,n){return t=ci(22,t,null,n),t.lanes=0,t}function id(t,n,s){return ja(n,t.child,null,s),t=nd(n,n.pendingProps.children),t.flags|=2,n.memoizedState=null,t}function Rp(t,n,s){t.lanes|=n;var l=t.alternate;l!==null&&(l.lanes|=n),bu(t.return,n,s)}function sd(t,n,s,l,u,d){var x=t.memoizedState;x===null?t.memoizedState={isBackwards:n,rendering:null,renderingStartTime:0,last:l,tail:s,tailMode:u,treeForkCount:d}:(x.isBackwards=n,x.rendering=null,x.renderingStartTime=0,x.last=l,x.tail=s,x.tailMode=u,x.treeForkCount=d)}function kp(t,n,s){var l=n.pendingProps,u=l.revealOrder,d=l.tail;l=l.children;var x=Jt.current,T=(x&2)!==0;if(T?(x=x&1|2,n.flags|=128):x&=1,J(Jt,x),Nn(t,n,l,s),l=et?rl:0,!T&&t!==null&&(t.flags&128)!==0)e:for(t=n.child;t!==null;){if(t.tag===13)t.memoizedState!==null&&Rp(t,s,n);else if(t.tag===19)Rp(t,s,n);else if(t.child!==null){t.child.return=t,t=t.child;continue}if(t===n)break e;for(;t.sibling===null;){if(t.return===null||t.return===n)break e;t=t.return}t.sibling.return=t.return,t=t.sibling}switch(u){case"forwards":for(s=n.child,u=null;s!==null;)t=s.alternate,t!==null&&Ir(t)===null&&(u=s),s=s.sibling;s=u,s===null?(u=n.child,n.child=null):(u=s.sibling,s.sibling=null),sd(n,!1,u,s,d,l);break;case"backwards":case"unstable_legacy-backwards":for(s=null,u=n.child,n.child=null;u!==null;){if(t=u.alternate,t!==null&&Ir(t)===null){n.child=u;break}t=u.sibling,u.sibling=s,s=u,u=t}sd(n,!0,s,null,d,l);break;case"together":sd(n,!1,null,null,void 0,l);break;default:n.memoizedState=null}return n.child}function bs(t,n,s){if(t!==null&&(n.dependencies=t.dependencies),Qs|=n.lanes,(s&n.childLanes)===0)if(t!==null){if(ho(t,n,s,!1),(s&n.childLanes)===0)return null}else return null;if(t!==null&&n.child!==t.child)throw Error(o(153));if(n.child!==null){for(t=n.child,s=fs(t,t.pendingProps),n.child=s,s.return=n;t.sibling!==null;)t=t.sibling,s=s.sibling=fs(t,t.pendingProps),s.return=n;s.sibling=null}return n.child}function ad(t,n){return(t.lanes&n)!==0?!0:(t=t.dependencies,!!(t!==null&&_r(t)))}function D0(t,n,s){switch(n.tag){case 3:pt(n,n.stateNode.containerInfo),$s(n,an,t.memoizedState.cache),Na();break;case 27:case 5:Rt(n);break;case 4:pt(n,n.stateNode.containerInfo);break;case 10:$s(n,n.type,n.memoizedProps.value);break;case 31:if(n.memoizedState!==null)return n.flags|=128,Nu(n),null;break;case 13:var l=n.memoizedState;if(l!==null)return l.dehydrated!==null?(Ks(n),n.flags|=128,null):(s&n.child.childLanes)!==0?Np(t,n,s):(Ks(n),t=bs(t,n,s),t!==null?t.sibling:null);Ks(n);break;case 19:var u=(t.flags&128)!==0;if(l=(s&n.childLanes)!==0,l||(ho(t,n,s,!1),l=(s&n.childLanes)!==0),u){if(l)return kp(t,n,s);n.flags|=128}if(u=n.memoizedState,u!==null&&(u.rendering=null,u.tail=null,u.lastEffect=null),J(Jt,Jt.current),l)break;return null;case 22:return n.lanes=0,Ep(t,n,s,n.pendingProps);case 24:$s(n,an,t.memoizedState.cache)}return bs(t,n,s)}function Lp(t,n,s){if(t!==null)if(t.memoizedProps!==n.pendingProps)ln=!0;else{if(!ad(t,s)&&(n.flags&128)===0)return ln=!1,D0(t,n,s);ln=(t.flags&131072)!==0}else ln=!1,et&&(n.flags&1048576)!==0&&dm(n,rl,n.index);switch(n.lanes=0,n.tag){case 16:e:{var l=n.pendingProps;if(t=Ia(n.elementType),n.type=t,typeof t=="function")uu(t)?(l=Ha(t,l),n.tag=1,n=Op(null,n,t,l,s)):(n.tag=0,n=Ju(null,n,t,l,s));else{if(t!=null){var u=t.$$typeof;if(u===N){n.tag=11,n=Sp(null,n,t,l,s);break e}else if(u===O){n.tag=14,n=Ap(null,n,t,l,s);break e}}throw n=be(t)||t,Error(o(306,n,""))}}return n;case 0:return Ju(t,n,n.type,n.pendingProps,s);case 1:return l=n.type,u=Ha(l,n.pendingProps),Op(t,n,l,u,s);case 3:e:{if(pt(n,n.stateNode.containerInfo),t===null)throw Error(o(387));l=n.pendingProps;var d=n.memoizedState;u=d.element,wu(t,n),gl(n,l,null,s);var x=n.memoizedState;if(l=x.cache,$s(n,an,l),l!==d.cache&&xu(n,[an],s,!0),hl(),l=x.element,d.isDehydrated)if(d={element:l,isDehydrated:!1,cache:x.cache},n.updateQueue.baseState=d,n.memoizedState=d,n.flags&256){n=Cp(t,n,l,s);break e}else if(l!==u){u=Mi(Error(o(424)),n),cl(u),n=Cp(t,n,l,s);break e}else for(t=n.stateNode.containerInfo,t.nodeType===9?t=t.body:t=t.nodeName==="HTML"?t.ownerDocument.body:t,Lt=ki(t.firstChild),On=n,et=!0,qs=null,Ni=!0,s=Em(n,null,l,s),n.child=s;s;)s.flags=s.flags&-3|4096,s=s.sibling;else{if(Na(),l===u){n=bs(t,n,s);break e}Nn(t,n,l,s)}n=n.child}return n;case 26:return Yr(t,n),t===null?(s=Vh(n.type,null,n.pendingProps,null))?n.memoizedState=s:et||(s=n.type,t=n.pendingProps,l=rc(ke.current).createElement(s),l[F]=n,l[te]=t,Rn(l,s,t),Ct(l),n.stateNode=l):n.memoizedState=Vh(n.type,t.memoizedProps,n.pendingProps,t.memoizedState),null;case 27:return Rt(n),t===null&&et&&(l=n.stateNode=qh(n.type,n.pendingProps,ke.current),On=n,Ni=!0,u=Lt,na(n.type)?(Hd=u,Lt=ki(l.firstChild)):Lt=u),Nn(t,n,n.pendingProps.children,s),Yr(t,n),t===null&&(n.flags|=4194304),n.child;case 5:return t===null&&et&&((u=l=Lt)&&(l=mb(l,n.type,n.pendingProps,Ni),l!==null?(n.stateNode=l,On=n,Lt=ki(l.firstChild),Ni=!1,u=!0):u=!1),u||zs(n)),Rt(n),u=n.type,d=n.pendingProps,x=t!==null?t.memoizedProps:null,l=d.children,Ld(u,d)?l=null:x!==null&&Ld(u,x)&&(n.flags|=32),n.memoizedState!==null&&(u=ku(t,n,O0,null,null,s),jl._currentValue=u),Yr(t,n),Nn(t,n,l,s),n.child;case 6:return t===null&&et&&((t=s=Lt)&&(s=pb(s,n.pendingProps,Ni),s!==null?(n.stateNode=s,On=n,Lt=null,t=!0):t=!1),t||zs(n)),null;case 13:return Np(t,n,s);case 4:return pt(n,n.stateNode.containerInfo),l=n.pendingProps,t===null?n.child=ja(n,null,l,s):Nn(t,n,l,s),n.child;case 11:return Sp(t,n,n.type,n.pendingProps,s);case 7:return Nn(t,n,n.pendingProps,s),n.child;case 8:return Nn(t,n,n.pendingProps.children,s),n.child;case 12:return Nn(t,n,n.pendingProps.children,s),n.child;case 10:return l=n.pendingProps,$s(n,n.type,l.value),Nn(t,n,l.children,s),n.child;case 9:return u=n.type._context,l=n.pendingProps.children,ka(n),u=Cn(u),l=l(u),n.flags|=1,Nn(t,n,l,s),n.child;case 14:return Ap(t,n,n.type,n.pendingProps,s);case 15:return Tp(t,n,n.type,n.pendingProps,s);case 19:return kp(t,n,s);case 31:return j0(t,n,s);case 22:return Ep(t,n,s,n.pendingProps);case 24:return ka(n),l=Cn(an),t===null?(u=Au(),u===null&&(u=wt,d=vu(),u.pooledCache=d,d.refCount++,d!==null&&(u.pooledCacheLanes|=s),u=d),n.memoizedState={parent:l,cache:u},Eu(n),$s(n,an,u)):((t.lanes&s)!==0&&(wu(t,n),gl(n,null,null,s),hl()),u=t.memoizedState,d=n.memoizedState,u.parent!==l?(u={parent:l,cache:l},n.memoizedState=u,n.lanes===0&&(n.memoizedState=n.updateQueue.baseState=u),$s(n,an,l)):(l=d.cache,$s(n,an,l),l!==u.cache&&xu(n,[an],s,!0))),Nn(t,n,n.pendingProps.children,s),n.child;case 29:throw n.pendingProps}throw Error(o(156,n.tag))}function xs(t){t.flags|=4}function od(t,n,s,l,u){if((n=(t.mode&32)!==0)&&(n=!1),n){if(t.flags|=16777216,(u&335544128)===u)if(t.stateNode.complete)t.flags|=8192;else if(oh())t.flags|=8192;else throw Ba=Nr,Tu}else t.flags&=-16777217}function Ip(t,n){if(n.type!=="stylesheet"||(n.state.loading&4)!==0)t.flags&=-16777217;else if(t.flags|=16777216,!Wh(n))if(oh())t.flags|=8192;else throw Ba=Nr,Tu}function Kr(t,n){n!==null&&(t.flags|=4),t.flags&16384&&(n=t.tag!==22?ks():536870912,t.lanes|=n,Mo|=n)}function Al(t,n){if(!et)switch(t.tailMode){case"hidden":n=t.tail;for(var s=null;n!==null;)n.alternate!==null&&(s=n),n=n.sibling;s===null?t.tail=null:s.sibling=null;break;case"collapsed":s=t.tail;for(var l=null;s!==null;)s.alternate!==null&&(l=s),s=s.sibling;l===null?n||t.tail===null?t.tail=null:t.tail.sibling=null:l.sibling=null}}function It(t){var n=t.alternate!==null&&t.alternate.child===t.child,s=0,l=0;if(n)for(var u=t.child;u!==null;)s|=u.lanes|u.childLanes,l|=u.subtreeFlags&65011712,l|=u.flags&65011712,u.return=t,u=u.sibling;else for(u=t.child;u!==null;)s|=u.lanes|u.childLanes,l|=u.subtreeFlags,l|=u.flags,u.return=t,u=u.sibling;return t.subtreeFlags|=l,t.childLanes=s,n}function H0(t,n,s){var l=n.pendingProps;switch(pu(n),n.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return It(n),null;case 1:return It(n),null;case 3:return s=n.stateNode,l=null,t!==null&&(l=t.memoizedState.cache),n.memoizedState.cache!==l&&(n.flags|=2048),hs(an),ze(),s.pendingContext&&(s.context=s.pendingContext,s.pendingContext=null),(t===null||t.child===null)&&(po(n)?xs(n):t===null||t.memoizedState.isDehydrated&&(n.flags&256)===0||(n.flags|=1024,gu())),It(n),null;case 26:var u=n.type,d=n.memoizedState;return t===null?(xs(n),d!==null?(It(n),Ip(n,d)):(It(n),od(n,u,null,l,s))):d?d!==t.memoizedState?(xs(n),It(n),Ip(n,d)):(It(n),n.flags&=-16777217):(t=t.memoizedProps,t!==l&&xs(n),It(n),od(n,u,t,l,s)),null;case 27:if(qn(n),s=ke.current,u=n.type,t!==null&&n.stateNode!=null)t.memoizedProps!==l&&xs(n);else{if(!l){if(n.stateNode===null)throw Error(o(166));return It(n),null}t=me.current,po(n)?mm(n):(t=qh(u,l,s),n.stateNode=t,xs(n))}return It(n),null;case 5:if(qn(n),u=n.type,t!==null&&n.stateNode!=null)t.memoizedProps!==l&&xs(n);else{if(!l){if(n.stateNode===null)throw Error(o(166));return It(n),null}if(d=me.current,po(n))mm(n);else{var x=rc(ke.current);switch(d){case 1:d=x.createElementNS("http://www.w3.org/2000/svg",u);break;case 2:d=x.createElementNS("http://www.w3.org/1998/Math/MathML",u);break;default:switch(u){case"svg":d=x.createElementNS("http://www.w3.org/2000/svg",u);break;case"math":d=x.createElementNS("http://www.w3.org/1998/Math/MathML",u);break;case"script":d=x.createElement("div"),d.innerHTML="<script><\/script>",d=d.removeChild(d.firstChild);break;case"select":d=typeof l.is=="string"?x.createElement("select",{is:l.is}):x.createElement("select"),l.multiple?d.multiple=!0:l.size&&(d.size=l.size);break;default:d=typeof l.is=="string"?x.createElement(u,{is:l.is}):x.createElement(u)}}d[F]=n,d[te]=l;e:for(x=n.child;x!==null;){if(x.tag===5||x.tag===6)d.appendChild(x.stateNode);else if(x.tag!==4&&x.tag!==27&&x.child!==null){x.child.return=x,x=x.child;continue}if(x===n)break e;for(;x.sibling===null;){if(x.return===null||x.return===n)break e;x=x.return}x.sibling.return=x.return,x=x.sibling}n.stateNode=d;e:switch(Rn(d,u,l),u){case"button":case"input":case"select":case"textarea":l=!!l.autoFocus;break e;case"img":l=!0;break e;default:l=!1}l&&xs(n)}}return It(n),od(n,n.type,t===null?null:t.memoizedProps,n.pendingProps,s),null;case 6:if(t&&n.stateNode!=null)t.memoizedProps!==l&&xs(n);else{if(typeof l!="string"&&n.stateNode===null)throw Error(o(166));if(t=ke.current,po(n)){if(t=n.stateNode,s=n.memoizedProps,l=null,u=On,u!==null)switch(u.tag){case 27:case 5:l=u.memoizedProps}t[F]=n,t=!!(t.nodeValue===s||l!==null&&l.suppressHydrationWarning===!0||Nh(t.nodeValue,s)),t||zs(n,!0)}else t=rc(t).createTextNode(l),t[F]=n,n.stateNode=t}return It(n),null;case 31:if(s=n.memoizedState,t===null||t.memoizedState!==null){if(l=po(n),s!==null){if(t===null){if(!l)throw Error(o(318));if(t=n.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(o(557));t[F]=n}else Na(),(n.flags&128)===0&&(n.memoizedState=null),n.flags|=4;It(n),t=!1}else s=gu(),t!==null&&t.memoizedState!==null&&(t.memoizedState.hydrationErrors=s),t=!0;if(!t)return n.flags&256?(di(n),n):(di(n),null);if((n.flags&128)!==0)throw Error(o(558))}return It(n),null;case 13:if(l=n.memoizedState,t===null||t.memoizedState!==null&&t.memoizedState.dehydrated!==null){if(u=po(n),l!==null&&l.dehydrated!==null){if(t===null){if(!u)throw Error(o(318));if(u=n.memoizedState,u=u!==null?u.dehydrated:null,!u)throw Error(o(317));u[F]=n}else Na(),(n.flags&128)===0&&(n.memoizedState=null),n.flags|=4;It(n),u=!1}else u=gu(),t!==null&&t.memoizedState!==null&&(t.memoizedState.hydrationErrors=u),u=!0;if(!u)return n.flags&256?(di(n),n):(di(n),null)}return di(n),(n.flags&128)!==0?(n.lanes=s,n):(s=l!==null,t=t!==null&&t.memoizedState!==null,s&&(l=n.child,u=null,l.alternate!==null&&l.alternate.memoizedState!==null&&l.alternate.memoizedState.cachePool!==null&&(u=l.alternate.memoizedState.cachePool.pool),d=null,l.memoizedState!==null&&l.memoizedState.cachePool!==null&&(d=l.memoizedState.cachePool.pool),d!==u&&(l.flags|=2048)),s!==t&&s&&(n.child.flags|=8192),Kr(n,n.updateQueue),It(n),null);case 4:return ze(),t===null&&Od(n.stateNode.containerInfo),It(n),null;case 10:return hs(n.type),It(n),null;case 19:if($(Jt),l=n.memoizedState,l===null)return It(n),null;if(u=(n.flags&128)!==0,d=l.rendering,d===null)if(u)Al(l,!1);else{if(Ft!==0||t!==null&&(t.flags&128)!==0)for(t=n.child;t!==null;){if(d=Ir(t),d!==null){for(n.flags|=128,Al(l,!1),t=d.updateQueue,n.updateQueue=t,Kr(n,t),n.subtreeFlags=0,t=s,s=n.child;s!==null;)rm(s,t),s=s.sibling;return J(Jt,Jt.current&1|2),et&&ms(n,l.treeForkCount),n.child}t=t.sibling}l.tail!==null&&At()>Jr&&(n.flags|=128,u=!0,Al(l,!1),n.lanes=4194304)}else{if(!u)if(t=Ir(d),t!==null){if(n.flags|=128,u=!0,t=t.updateQueue,n.updateQueue=t,Kr(n,t),Al(l,!0),l.tail===null&&l.tailMode==="hidden"&&!d.alternate&&!et)return It(n),null}else 2*At()-l.renderingStartTime>Jr&&s!==536870912&&(n.flags|=128,u=!0,Al(l,!1),n.lanes=4194304);l.isBackwards?(d.sibling=n.child,n.child=d):(t=l.last,t!==null?t.sibling=d:n.child=d,l.last=d)}return l.tail!==null?(t=l.tail,l.rendering=t,l.tail=t.sibling,l.renderingStartTime=At(),t.sibling=null,s=Jt.current,J(Jt,u?s&1|2:s&1),et&&ms(n,l.treeForkCount),t):(It(n),null);case 22:case 23:return di(n),Cu(),l=n.memoizedState!==null,t!==null?t.memoizedState!==null!==l&&(n.flags|=8192):l&&(n.flags|=8192),l?(s&536870912)!==0&&(n.flags&128)===0&&(It(n),n.subtreeFlags&6&&(n.flags|=8192)):It(n),s=n.updateQueue,s!==null&&Kr(n,s.retryQueue),s=null,t!==null&&t.memoizedState!==null&&t.memoizedState.cachePool!==null&&(s=t.memoizedState.cachePool.pool),l=null,n.memoizedState!==null&&n.memoizedState.cachePool!==null&&(l=n.memoizedState.cachePool.pool),l!==s&&(n.flags|=2048),t!==null&&$(La),null;case 24:return s=null,t!==null&&(s=t.memoizedState.cache),n.memoizedState.cache!==s&&(n.flags|=2048),hs(an),It(n),null;case 25:return null;case 30:return null}throw Error(o(156,n.tag))}function P0(t,n){switch(pu(n),n.tag){case 1:return t=n.flags,t&65536?(n.flags=t&-65537|128,n):null;case 3:return hs(an),ze(),t=n.flags,(t&65536)!==0&&(t&128)===0?(n.flags=t&-65537|128,n):null;case 26:case 27:case 5:return qn(n),null;case 31:if(n.memoizedState!==null){if(di(n),n.alternate===null)throw Error(o(340));Na()}return t=n.flags,t&65536?(n.flags=t&-65537|128,n):null;case 13:if(di(n),t=n.memoizedState,t!==null&&t.dehydrated!==null){if(n.alternate===null)throw Error(o(340));Na()}return t=n.flags,t&65536?(n.flags=t&-65537|128,n):null;case 19:return $(Jt),null;case 4:return ze(),null;case 10:return hs(n.type),null;case 22:case 23:return di(n),Cu(),t!==null&&$(La),t=n.flags,t&65536?(n.flags=t&-65537|128,n):null;case 24:return hs(an),null;case 25:return null;default:return null}}function Bp(t,n){switch(pu(n),n.tag){case 3:hs(an),ze();break;case 26:case 27:case 5:qn(n);break;case 4:ze();break;case 31:n.memoizedState!==null&&di(n);break;case 13:di(n);break;case 19:$(Jt);break;case 10:hs(n.type);break;case 22:case 23:di(n),Cu(),t!==null&&$(La);break;case 24:hs(an)}}function Tl(t,n){try{var s=n.updateQueue,l=s!==null?s.lastEffect:null;if(l!==null){var u=l.next;s=u;do{if((s.tag&t)===t){l=void 0;var d=s.create,x=s.inst;l=d(),x.destroy=l}s=s.next}while(s!==u)}}catch(T){mt(n,n.return,T)}}function Ws(t,n,s){try{var l=n.updateQueue,u=l!==null?l.lastEffect:null;if(u!==null){var d=u.next;l=d;do{if((l.tag&t)===t){var x=l.inst,T=x.destroy;if(T!==void 0){x.destroy=void 0,u=n;var L=s,U=T;try{U()}catch(Q){mt(u,L,Q)}}}l=l.next}while(l!==d)}}catch(Q){mt(n,n.return,Q)}}function jp(t){var n=t.updateQueue;if(n!==null){var s=t.stateNode;try{_m(n,s)}catch(l){mt(t,t.return,l)}}}function Dp(t,n,s){s.props=Ha(t.type,t.memoizedProps),s.state=t.memoizedState;try{s.componentWillUnmount()}catch(l){mt(t,n,l)}}function El(t,n){try{var s=t.ref;if(s!==null){switch(t.tag){case 26:case 27:case 5:var l=t.stateNode;break;case 30:l=t.stateNode;break;default:l=t.stateNode}typeof s=="function"?t.refCleanup=s(l):s.current=l}}catch(u){mt(t,n,u)}}function ts(t,n){var s=t.ref,l=t.refCleanup;if(s!==null)if(typeof l=="function")try{l()}catch(u){mt(t,n,u)}finally{t.refCleanup=null,t=t.alternate,t!=null&&(t.refCleanup=null)}else if(typeof s=="function")try{s(null)}catch(u){mt(t,n,u)}else s.current=null}function Hp(t){var n=t.type,s=t.memoizedProps,l=t.stateNode;try{e:switch(n){case"button":case"input":case"select":case"textarea":s.autoFocus&&l.focus();break e;case"img":s.src?l.src=s.src:s.srcSet&&(l.srcset=s.srcSet)}}catch(u){mt(t,t.return,u)}}function ld(t,n,s){try{var l=t.stateNode;lb(l,t.type,s,n),l[te]=n}catch(u){mt(t,t.return,u)}}function Pp(t){return t.tag===5||t.tag===3||t.tag===26||t.tag===27&&na(t.type)||t.tag===4}function rd(t){e:for(;;){for(;t.sibling===null;){if(t.return===null||Pp(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;t.tag!==5&&t.tag!==6&&t.tag!==18;){if(t.tag===27&&na(t.type)||t.flags&2||t.child===null||t.tag===4)continue e;t.child.return=t,t=t.child}if(!(t.flags&2))return t.stateNode}}function cd(t,n,s){var l=t.tag;if(l===5||l===6)t=t.stateNode,n?(s.nodeType===9?s.body:s.nodeName==="HTML"?s.ownerDocument.body:s).insertBefore(t,n):(n=s.nodeType===9?s.body:s.nodeName==="HTML"?s.ownerDocument.body:s,n.appendChild(t),s=s._reactRootContainer,s!=null||n.onclick!==null||(n.onclick=Ti));else if(l!==4&&(l===27&&na(t.type)&&(s=t.stateNode,n=null),t=t.child,t!==null))for(cd(t,n,s),t=t.sibling;t!==null;)cd(t,n,s),t=t.sibling}function Gr(t,n,s){var l=t.tag;if(l===5||l===6)t=t.stateNode,n?s.insertBefore(t,n):s.appendChild(t);else if(l!==4&&(l===27&&na(t.type)&&(s=t.stateNode),t=t.child,t!==null))for(Gr(t,n,s),t=t.sibling;t!==null;)Gr(t,n,s),t=t.sibling}function Up(t){var n=t.stateNode,s=t.memoizedProps;try{for(var l=t.type,u=n.attributes;u.length;)n.removeAttributeNode(u[0]);Rn(n,l,s),n[F]=t,n[te]=s}catch(d){mt(t,t.return,d)}}var vs=!1,rn=!1,ud=!1,qp=typeof WeakSet=="function"?WeakSet:Set,Sn=null;function U0(t,n){if(t=t.containerInfo,Rd=hc,t=Zf(t),iu(t)){if("selectionStart"in t)var s={start:t.selectionStart,end:t.selectionEnd};else e:{s=(s=t.ownerDocument)&&s.defaultView||window;var l=s.getSelection&&s.getSelection();if(l&&l.rangeCount!==0){s=l.anchorNode;var u=l.anchorOffset,d=l.focusNode;l=l.focusOffset;try{s.nodeType,d.nodeType}catch{s=null;break e}var x=0,T=-1,L=-1,U=0,Q=0,ie=t,V=null;t:for(;;){for(var G;ie!==s||u!==0&&ie.nodeType!==3||(T=x+u),ie!==d||l!==0&&ie.nodeType!==3||(L=x+l),ie.nodeType===3&&(x+=ie.nodeValue.length),(G=ie.firstChild)!==null;)V=ie,ie=G;for(;;){if(ie===t)break t;if(V===s&&++U===u&&(T=x),V===d&&++Q===l&&(L=x),(G=ie.nextSibling)!==null)break;ie=V,V=ie.parentNode}ie=G}s=T===-1||L===-1?null:{start:T,end:L}}else s=null}s=s||{start:0,end:0}}else s=null;for(kd={focusedElem:t,selectionRange:s},hc=!1,Sn=n;Sn!==null;)if(n=Sn,t=n.child,(n.subtreeFlags&1028)!==0&&t!==null)t.return=n,Sn=t;else for(;Sn!==null;){switch(n=Sn,d=n.alternate,t=n.flags,n.tag){case 0:if((t&4)!==0&&(t=n.updateQueue,t=t!==null?t.events:null,t!==null))for(s=0;s<t.length;s++)u=t[s],u.ref.impl=u.nextImpl;break;case 11:case 15:break;case 1:if((t&1024)!==0&&d!==null){t=void 0,s=n,u=d.memoizedProps,d=d.memoizedState,l=s.stateNode;try{var Se=Ha(s.type,u);t=l.getSnapshotBeforeUpdate(Se,d),l.__reactInternalSnapshotBeforeUpdate=t}catch(Re){mt(s,s.return,Re)}}break;case 3:if((t&1024)!==0){if(t=n.stateNode.containerInfo,s=t.nodeType,s===9)Bd(t);else if(s===1)switch(t.nodeName){case"HEAD":case"HTML":case"BODY":Bd(t);break;default:t.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((t&1024)!==0)throw Error(o(163))}if(t=n.sibling,t!==null){t.return=n.return,Sn=t;break}Sn=n.return}}function zp(t,n,s){var l=s.flags;switch(s.tag){case 0:case 11:case 15:As(t,s),l&4&&Tl(5,s);break;case 1:if(As(t,s),l&4)if(t=s.stateNode,n===null)try{t.componentDidMount()}catch(x){mt(s,s.return,x)}else{var u=Ha(s.type,n.memoizedProps);n=n.memoizedState;try{t.componentDidUpdate(u,n,t.__reactInternalSnapshotBeforeUpdate)}catch(x){mt(s,s.return,x)}}l&64&&jp(s),l&512&&El(s,s.return);break;case 3:if(As(t,s),l&64&&(t=s.updateQueue,t!==null)){if(n=null,s.child!==null)switch(s.child.tag){case 27:case 5:n=s.child.stateNode;break;case 1:n=s.child.stateNode}try{_m(t,n)}catch(x){mt(s,s.return,x)}}break;case 27:n===null&&l&4&&Up(s);case 26:case 5:As(t,s),n===null&&l&4&&Hp(s),l&512&&El(s,s.return);break;case 12:As(t,s);break;case 31:As(t,s),l&4&&Yp(t,s);break;case 13:As(t,s),l&4&&Fp(t,s),l&64&&(t=s.memoizedState,t!==null&&(t=t.dehydrated,t!==null&&(s=W0.bind(null,s),hb(t,s))));break;case 22:if(l=s.memoizedState!==null||vs,!l){n=n!==null&&n.memoizedState!==null||rn,u=vs;var d=rn;vs=l,(rn=n)&&!d?Ts(t,s,(s.subtreeFlags&8772)!==0):As(t,s),vs=u,rn=d}break;case 30:break;default:As(t,s)}}function $p(t){var n=t.alternate;n!==null&&(t.alternate=null,$p(n)),t.child=null,t.deletions=null,t.sibling=null,t.tag===5&&(n=t.stateNode,n!==null&&lt(n)),t.stateNode=null,t.return=null,t.dependencies=null,t.memoizedProps=null,t.memoizedState=null,t.pendingProps=null,t.stateNode=null,t.updateQueue=null}var Dt=null,Jn=!1;function Ss(t,n,s){for(s=s.child;s!==null;)Vp(t,n,s),s=s.sibling}function Vp(t,n,s){if(Xt&&typeof Xt.onCommitFiberUnmount=="function")try{Xt.onCommitFiberUnmount(In,s)}catch{}switch(s.tag){case 26:rn||ts(s,n),Ss(t,n,s),s.memoizedState?s.memoizedState.count--:s.stateNode&&(s=s.stateNode,s.parentNode.removeChild(s));break;case 27:rn||ts(s,n);var l=Dt,u=Jn;na(s.type)&&(Dt=s.stateNode,Jn=!1),Ss(t,n,s),Ll(s.stateNode),Dt=l,Jn=u;break;case 5:rn||ts(s,n);case 6:if(l=Dt,u=Jn,Dt=null,Ss(t,n,s),Dt=l,Jn=u,Dt!==null)if(Jn)try{(Dt.nodeType===9?Dt.body:Dt.nodeName==="HTML"?Dt.ownerDocument.body:Dt).removeChild(s.stateNode)}catch(d){mt(s,n,d)}else try{Dt.removeChild(s.stateNode)}catch(d){mt(s,n,d)}break;case 18:Dt!==null&&(Jn?(t=Dt,jh(t.nodeType===9?t.body:t.nodeName==="HTML"?t.ownerDocument.body:t,s.stateNode),Bo(t)):jh(Dt,s.stateNode));break;case 4:l=Dt,u=Jn,Dt=s.stateNode.containerInfo,Jn=!0,Ss(t,n,s),Dt=l,Jn=u;break;case 0:case 11:case 14:case 15:Ws(2,s,n),rn||Ws(4,s,n),Ss(t,n,s);break;case 1:rn||(ts(s,n),l=s.stateNode,typeof l.componentWillUnmount=="function"&&Dp(s,n,l)),Ss(t,n,s);break;case 21:Ss(t,n,s);break;case 22:rn=(l=rn)||s.memoizedState!==null,Ss(t,n,s),rn=l;break;default:Ss(t,n,s)}}function Yp(t,n){if(n.memoizedState===null&&(t=n.alternate,t!==null&&(t=t.memoizedState,t!==null))){t=t.dehydrated;try{Bo(t)}catch(s){mt(n,n.return,s)}}}function Fp(t,n){if(n.memoizedState===null&&(t=n.alternate,t!==null&&(t=t.memoizedState,t!==null&&(t=t.dehydrated,t!==null))))try{Bo(t)}catch(s){mt(n,n.return,s)}}function q0(t){switch(t.tag){case 31:case 13:case 19:var n=t.stateNode;return n===null&&(n=t.stateNode=new qp),n;case 22:return t=t.stateNode,n=t._retryCache,n===null&&(n=t._retryCache=new qp),n;default:throw Error(o(435,t.tag))}}function Wr(t,n){var s=q0(t);n.forEach(function(l){if(!s.has(l)){s.add(l);var u=X0.bind(null,t,l);l.then(u,u)}})}function Zn(t,n){var s=n.deletions;if(s!==null)for(var l=0;l<s.length;l++){var u=s[l],d=t,x=n,T=x;e:for(;T!==null;){switch(T.tag){case 27:if(na(T.type)){Dt=T.stateNode,Jn=!1;break e}break;case 5:Dt=T.stateNode,Jn=!1;break e;case 3:case 4:Dt=T.stateNode.containerInfo,Jn=!0;break e}T=T.return}if(Dt===null)throw Error(o(160));Vp(d,x,u),Dt=null,Jn=!1,d=u.alternate,d!==null&&(d.return=null),u.return=null}if(n.subtreeFlags&13886)for(n=n.child;n!==null;)Kp(n,t),n=n.sibling}var Ui=null;function Kp(t,n){var s=t.alternate,l=t.flags;switch(t.tag){case 0:case 11:case 14:case 15:Zn(n,t),ei(t),l&4&&(Ws(3,t,t.return),Tl(3,t),Ws(5,t,t.return));break;case 1:Zn(n,t),ei(t),l&512&&(rn||s===null||ts(s,s.return)),l&64&&vs&&(t=t.updateQueue,t!==null&&(l=t.callbacks,l!==null&&(s=t.shared.hiddenCallbacks,t.shared.hiddenCallbacks=s===null?l:s.concat(l))));break;case 26:var u=Ui;if(Zn(n,t),ei(t),l&512&&(rn||s===null||ts(s,s.return)),l&4){var d=s!==null?s.memoizedState:null;if(l=t.memoizedState,s===null)if(l===null)if(t.stateNode===null){e:{l=t.type,s=t.memoizedProps,u=u.ownerDocument||u;t:switch(l){case"title":d=u.getElementsByTagName("title")[0],(!d||d[Ot]||d[F]||d.namespaceURI==="http://www.w3.org/2000/svg"||d.hasAttribute("itemprop"))&&(d=u.createElement(l),u.head.insertBefore(d,u.querySelector("head > title"))),Rn(d,l,s),d[F]=t,Ct(d),l=d;break e;case"link":var x=Kh("link","href",u).get(l+(s.href||""));if(x){for(var T=0;T<x.length;T++)if(d=x[T],d.getAttribute("href")===(s.href==null||s.href===""?null:s.href)&&d.getAttribute("rel")===(s.rel==null?null:s.rel)&&d.getAttribute("title")===(s.title==null?null:s.title)&&d.getAttribute("crossorigin")===(s.crossOrigin==null?null:s.crossOrigin)){x.splice(T,1);break t}}d=u.createElement(l),Rn(d,l,s),u.head.appendChild(d);break;case"meta":if(x=Kh("meta","content",u).get(l+(s.content||""))){for(T=0;T<x.length;T++)if(d=x[T],d.getAttribute("content")===(s.content==null?null:""+s.content)&&d.getAttribute("name")===(s.name==null?null:s.name)&&d.getAttribute("property")===(s.property==null?null:s.property)&&d.getAttribute("http-equiv")===(s.httpEquiv==null?null:s.httpEquiv)&&d.getAttribute("charset")===(s.charSet==null?null:s.charSet)){x.splice(T,1);break t}}d=u.createElement(l),Rn(d,l,s),u.head.appendChild(d);break;default:throw Error(o(468,l))}d[F]=t,Ct(d),l=d}t.stateNode=l}else Gh(u,t.type,t.stateNode);else t.stateNode=Fh(u,l,t.memoizedProps);else d!==l?(d===null?s.stateNode!==null&&(s=s.stateNode,s.parentNode.removeChild(s)):d.count--,l===null?Gh(u,t.type,t.stateNode):Fh(u,l,t.memoizedProps)):l===null&&t.stateNode!==null&&ld(t,t.memoizedProps,s.memoizedProps)}break;case 27:Zn(n,t),ei(t),l&512&&(rn||s===null||ts(s,s.return)),s!==null&&l&4&&ld(t,t.memoizedProps,s.memoizedProps);break;case 5:if(Zn(n,t),ei(t),l&512&&(rn||s===null||ts(s,s.return)),t.flags&32){u=t.stateNode;try{Bs(u,"")}catch(Se){mt(t,t.return,Se)}}l&4&&t.stateNode!=null&&(u=t.memoizedProps,ld(t,u,s!==null?s.memoizedProps:u)),l&1024&&(ud=!0);break;case 6:if(Zn(n,t),ei(t),l&4){if(t.stateNode===null)throw Error(o(162));l=t.memoizedProps,s=t.stateNode;try{s.nodeValue=l}catch(Se){mt(t,t.return,Se)}}break;case 3:if(dc=null,u=Ui,Ui=cc(n.containerInfo),Zn(n,t),Ui=u,ei(t),l&4&&s!==null&&s.memoizedState.isDehydrated)try{Bo(n.containerInfo)}catch(Se){mt(t,t.return,Se)}ud&&(ud=!1,Gp(t));break;case 4:l=Ui,Ui=cc(t.stateNode.containerInfo),Zn(n,t),ei(t),Ui=l;break;case 12:Zn(n,t),ei(t);break;case 31:Zn(n,t),ei(t),l&4&&(l=t.updateQueue,l!==null&&(t.updateQueue=null,Wr(t,l)));break;case 13:Zn(n,t),ei(t),t.child.flags&8192&&t.memoizedState!==null!=(s!==null&&s.memoizedState!==null)&&(Qr=At()),l&4&&(l=t.updateQueue,l!==null&&(t.updateQueue=null,Wr(t,l)));break;case 22:u=t.memoizedState!==null;var L=s!==null&&s.memoizedState!==null,U=vs,Q=rn;if(vs=U||u,rn=Q||L,Zn(n,t),rn=Q,vs=U,ei(t),l&8192)e:for(n=t.stateNode,n._visibility=u?n._visibility&-2:n._visibility|1,u&&(s===null||L||vs||rn||Pa(t)),s=null,n=t;;){if(n.tag===5||n.tag===26){if(s===null){L=s=n;try{if(d=L.stateNode,u)x=d.style,typeof x.setProperty=="function"?x.setProperty("display","none","important"):x.display="none";else{T=L.stateNode;var ie=L.memoizedProps.style,V=ie!=null&&ie.hasOwnProperty("display")?ie.display:null;T.style.display=V==null||typeof V=="boolean"?"":(""+V).trim()}}catch(Se){mt(L,L.return,Se)}}}else if(n.tag===6){if(s===null){L=n;try{L.stateNode.nodeValue=u?"":L.memoizedProps}catch(Se){mt(L,L.return,Se)}}}else if(n.tag===18){if(s===null){L=n;try{var G=L.stateNode;u?Dh(G,!0):Dh(L.stateNode,!1)}catch(Se){mt(L,L.return,Se)}}}else if((n.tag!==22&&n.tag!==23||n.memoizedState===null||n===t)&&n.child!==null){n.child.return=n,n=n.child;continue}if(n===t)break e;for(;n.sibling===null;){if(n.return===null||n.return===t)break e;s===n&&(s=null),n=n.return}s===n&&(s=null),n.sibling.return=n.return,n=n.sibling}l&4&&(l=t.updateQueue,l!==null&&(s=l.retryQueue,s!==null&&(l.retryQueue=null,Wr(t,s))));break;case 19:Zn(n,t),ei(t),l&4&&(l=t.updateQueue,l!==null&&(t.updateQueue=null,Wr(t,l)));break;case 30:break;case 21:break;default:Zn(n,t),ei(t)}}function ei(t){var n=t.flags;if(n&2){try{for(var s,l=t.return;l!==null;){if(Pp(l)){s=l;break}l=l.return}if(s==null)throw Error(o(160));switch(s.tag){case 27:var u=s.stateNode,d=rd(t);Gr(t,d,u);break;case 5:var x=s.stateNode;s.flags&32&&(Bs(x,""),s.flags&=-33);var T=rd(t);Gr(t,T,x);break;case 3:case 4:var L=s.stateNode.containerInfo,U=rd(t);cd(t,U,L);break;default:throw Error(o(161))}}catch(Q){mt(t,t.return,Q)}t.flags&=-3}n&4096&&(t.flags&=-4097)}function Gp(t){if(t.subtreeFlags&1024)for(t=t.child;t!==null;){var n=t;Gp(n),n.tag===5&&n.flags&1024&&n.stateNode.reset(),t=t.sibling}}function As(t,n){if(n.subtreeFlags&8772)for(n=n.child;n!==null;)zp(t,n.alternate,n),n=n.sibling}function Pa(t){for(t=t.child;t!==null;){var n=t;switch(n.tag){case 0:case 11:case 14:case 15:Ws(4,n,n.return),Pa(n);break;case 1:ts(n,n.return);var s=n.stateNode;typeof s.componentWillUnmount=="function"&&Dp(n,n.return,s),Pa(n);break;case 27:Ll(n.stateNode);case 26:case 5:ts(n,n.return),Pa(n);break;case 22:n.memoizedState===null&&Pa(n);break;case 30:Pa(n);break;default:Pa(n)}t=t.sibling}}function Ts(t,n,s){for(s=s&&(n.subtreeFlags&8772)!==0,n=n.child;n!==null;){var l=n.alternate,u=t,d=n,x=d.flags;switch(d.tag){case 0:case 11:case 15:Ts(u,d,s),Tl(4,d);break;case 1:if(Ts(u,d,s),l=d,u=l.stateNode,typeof u.componentDidMount=="function")try{u.componentDidMount()}catch(U){mt(l,l.return,U)}if(l=d,u=l.updateQueue,u!==null){var T=l.stateNode;try{var L=u.shared.hiddenCallbacks;if(L!==null)for(u.shared.hiddenCallbacks=null,u=0;u<L.length;u++)wm(L[u],T)}catch(U){mt(l,l.return,U)}}s&&x&64&&jp(d),El(d,d.return);break;case 27:Up(d);case 26:case 5:Ts(u,d,s),s&&l===null&&x&4&&Hp(d),El(d,d.return);break;case 12:Ts(u,d,s);break;case 31:Ts(u,d,s),s&&x&4&&Yp(u,d);break;case 13:Ts(u,d,s),s&&x&4&&Fp(u,d);break;case 22:d.memoizedState===null&&Ts(u,d,s),El(d,d.return);break;case 30:break;default:Ts(u,d,s)}n=n.sibling}}function dd(t,n){var s=null;t!==null&&t.memoizedState!==null&&t.memoizedState.cachePool!==null&&(s=t.memoizedState.cachePool.pool),t=null,n.memoizedState!==null&&n.memoizedState.cachePool!==null&&(t=n.memoizedState.cachePool.pool),t!==s&&(t!=null&&t.refCount++,s!=null&&ul(s))}function fd(t,n){t=null,n.alternate!==null&&(t=n.alternate.memoizedState.cache),n=n.memoizedState.cache,n!==t&&(n.refCount++,t!=null&&ul(t))}function qi(t,n,s,l){if(n.subtreeFlags&10256)for(n=n.child;n!==null;)Wp(t,n,s,l),n=n.sibling}function Wp(t,n,s,l){var u=n.flags;switch(n.tag){case 0:case 11:case 15:qi(t,n,s,l),u&2048&&Tl(9,n);break;case 1:qi(t,n,s,l);break;case 3:qi(t,n,s,l),u&2048&&(t=null,n.alternate!==null&&(t=n.alternate.memoizedState.cache),n=n.memoizedState.cache,n!==t&&(n.refCount++,t!=null&&ul(t)));break;case 12:if(u&2048){qi(t,n,s,l),t=n.stateNode;try{var d=n.memoizedProps,x=d.id,T=d.onPostCommit;typeof T=="function"&&T(x,n.alternate===null?"mount":"update",t.passiveEffectDuration,-0)}catch(L){mt(n,n.return,L)}}else qi(t,n,s,l);break;case 31:qi(t,n,s,l);break;case 13:qi(t,n,s,l);break;case 23:break;case 22:d=n.stateNode,x=n.alternate,n.memoizedState!==null?d._visibility&2?qi(t,n,s,l):wl(t,n):d._visibility&2?qi(t,n,s,l):(d._visibility|=2,Eo(t,n,s,l,(n.subtreeFlags&10256)!==0||!1)),u&2048&&dd(x,n);break;case 24:qi(t,n,s,l),u&2048&&fd(n.alternate,n);break;default:qi(t,n,s,l)}}function Eo(t,n,s,l,u){for(u=u&&((n.subtreeFlags&10256)!==0||!1),n=n.child;n!==null;){var d=t,x=n,T=s,L=l,U=x.flags;switch(x.tag){case 0:case 11:case 15:Eo(d,x,T,L,u),Tl(8,x);break;case 23:break;case 22:var Q=x.stateNode;x.memoizedState!==null?Q._visibility&2?Eo(d,x,T,L,u):wl(d,x):(Q._visibility|=2,Eo(d,x,T,L,u)),u&&U&2048&&dd(x.alternate,x);break;case 24:Eo(d,x,T,L,u),u&&U&2048&&fd(x.alternate,x);break;default:Eo(d,x,T,L,u)}n=n.sibling}}function wl(t,n){if(n.subtreeFlags&10256)for(n=n.child;n!==null;){var s=t,l=n,u=l.flags;switch(l.tag){case 22:wl(s,l),u&2048&&dd(l.alternate,l);break;case 24:wl(s,l),u&2048&&fd(l.alternate,l);break;default:wl(s,l)}n=n.sibling}}var _l=8192;function wo(t,n,s){if(t.subtreeFlags&_l)for(t=t.child;t!==null;)Xp(t,n,s),t=t.sibling}function Xp(t,n,s){switch(t.tag){case 26:wo(t,n,s),t.flags&_l&&t.memoizedState!==null&&Mb(s,Ui,t.memoizedState,t.memoizedProps);break;case 5:wo(t,n,s);break;case 3:case 4:var l=Ui;Ui=cc(t.stateNode.containerInfo),wo(t,n,s),Ui=l;break;case 22:t.memoizedState===null&&(l=t.alternate,l!==null&&l.memoizedState!==null?(l=_l,_l=16777216,wo(t,n,s),_l=l):wo(t,n,s));break;default:wo(t,n,s)}}function Qp(t){var n=t.alternate;if(n!==null&&(t=n.child,t!==null)){n.child=null;do n=t.sibling,t.sibling=null,t=n;while(t!==null)}}function Ml(t){var n=t.deletions;if((t.flags&16)!==0){if(n!==null)for(var s=0;s<n.length;s++){var l=n[s];Sn=l,Zp(l,t)}Qp(t)}if(t.subtreeFlags&10256)for(t=t.child;t!==null;)Jp(t),t=t.sibling}function Jp(t){switch(t.tag){case 0:case 11:case 15:Ml(t),t.flags&2048&&Ws(9,t,t.return);break;case 3:Ml(t);break;case 12:Ml(t);break;case 22:var n=t.stateNode;t.memoizedState!==null&&n._visibility&2&&(t.return===null||t.return.tag!==13)?(n._visibility&=-3,Xr(t)):Ml(t);break;default:Ml(t)}}function Xr(t){var n=t.deletions;if((t.flags&16)!==0){if(n!==null)for(var s=0;s<n.length;s++){var l=n[s];Sn=l,Zp(l,t)}Qp(t)}for(t=t.child;t!==null;){switch(n=t,n.tag){case 0:case 11:case 15:Ws(8,n,n.return),Xr(n);break;case 22:s=n.stateNode,s._visibility&2&&(s._visibility&=-3,Xr(n));break;default:Xr(n)}t=t.sibling}}function Zp(t,n){for(;Sn!==null;){var s=Sn;switch(s.tag){case 0:case 11:case 15:Ws(8,s,n);break;case 23:case 22:if(s.memoizedState!==null&&s.memoizedState.cachePool!==null){var l=s.memoizedState.cachePool.pool;l!=null&&l.refCount++}break;case 24:ul(s.memoizedState.cache)}if(l=s.child,l!==null)l.return=s,Sn=l;else e:for(s=t;Sn!==null;){l=Sn;var u=l.sibling,d=l.return;if($p(l),l===s){Sn=null;break e}if(u!==null){u.return=d,Sn=u;break e}Sn=d}}}var z0={getCacheForType:function(t){var n=Cn(an),s=n.data.get(t);return s===void 0&&(s=t(),n.data.set(t,s)),s},cacheSignal:function(){return Cn(an).controller.signal}},$0=typeof WeakMap=="function"?WeakMap:Map,at=0,wt=null,Ke=null,We=0,ft=0,fi=null,Xs=!1,_o=!1,md=!1,Es=0,Ft=0,Qs=0,Ua=0,pd=0,mi=0,Mo=0,Ol=null,ti=null,hd=!1,Qr=0,eh=0,Jr=1/0,Zr=null,Js=null,fn=0,Zs=null,Oo=null,ws=0,gd=0,yd=null,th=null,Cl=0,bd=null;function pi(){return(at&2)!==0&&We!==0?We&-We:H.T!==null?Ed():nn()}function nh(){if(mi===0)if((We&536870912)===0||et){var t=Bn;Bn<<=1,(Bn&3932160)===0&&(Bn=262144),mi=t}else mi=536870912;return t=ui.current,t!==null&&(t.flags|=32),mi}function ni(t,n,s){(t===wt&&(ft===2||ft===9)||t.cancelPendingCommit!==null)&&(Co(t,0),ea(t,We,mi,!1)),tn(t,s),((at&2)===0||t!==wt)&&(t===wt&&((at&2)===0&&(Ua|=s),Ft===4&&ea(t,We,mi,!1)),ns(t))}function ih(t,n,s){if((at&6)!==0)throw Error(o(327));var l=!s&&(n&127)===0&&(n&t.expiredLanes)===0||Tt(t,n),u=l?F0(t,n):vd(t,n,!0),d=l;do{if(u===0){_o&&!l&&ea(t,n,0,!1);break}else{if(s=t.current.alternate,d&&!V0(s)){u=vd(t,n,!1),d=!1;continue}if(u===2){if(d=n,t.errorRecoveryDisabledLanes&d)var x=0;else x=t.pendingLanes&-536870913,x=x!==0?x:x&536870912?536870912:0;if(x!==0){n=x;e:{var T=t;u=Ol;var L=T.current.memoizedState.isDehydrated;if(L&&(Co(T,x).flags|=256),x=vd(T,x,!1),x!==2){if(md&&!L){T.errorRecoveryDisabledLanes|=d,Ua|=d,u=4;break e}d=ti,ti=u,d!==null&&(ti===null?ti=d:ti.push.apply(ti,d))}u=x}if(d=!1,u!==2)continue}}if(u===1){Co(t,0),ea(t,n,0,!0);break}e:{switch(l=t,d=u,d){case 0:case 1:throw Error(o(345));case 4:if((n&4194048)!==n)break;case 6:ea(l,n,mi,!Xs);break e;case 2:ti=null;break;case 3:case 5:break;default:throw Error(o(329))}if((n&62914560)===n&&(u=Qr+300-At(),10<u)){if(ea(l,n,mi,!Xs),Ue(l,0,!0)!==0)break e;ws=n,l.timeoutHandle=Ih(sh.bind(null,l,s,ti,Zr,hd,n,mi,Ua,Mo,Xs,d,"Throttled",-0,0),u);break e}sh(l,s,ti,Zr,hd,n,mi,Ua,Mo,Xs,d,null,-0,0)}}break}while(!0);ns(t)}function sh(t,n,s,l,u,d,x,T,L,U,Q,ie,V,G){if(t.timeoutHandle=-1,ie=n.subtreeFlags,ie&8192||(ie&16785408)===16785408){ie={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:Ti},Xp(n,d,ie);var Se=(d&62914560)===d?Qr-At():(d&4194048)===d?eh-At():0;if(Se=Ob(ie,Se),Se!==null){ws=d,t.cancelPendingCommit=Se(fh.bind(null,t,n,d,s,l,u,x,T,L,Q,ie,null,V,G)),ea(t,d,x,!U);return}}fh(t,n,d,s,l,u,x,T,L)}function V0(t){for(var n=t;;){var s=n.tag;if((s===0||s===11||s===15)&&n.flags&16384&&(s=n.updateQueue,s!==null&&(s=s.stores,s!==null)))for(var l=0;l<s.length;l++){var u=s[l],d=u.getSnapshot;u=u.value;try{if(!ri(d(),u))return!1}catch{return!1}}if(s=n.child,n.subtreeFlags&16384&&s!==null)s.return=n,n=s;else{if(n===t)break;for(;n.sibling===null;){if(n.return===null||n.return===t)return!0;n=n.return}n.sibling.return=n.return,n=n.sibling}}return!0}function ea(t,n,s,l){n&=~pd,n&=~Ua,t.suspendedLanes|=n,t.pingedLanes&=~n,l&&(t.warmLanes|=n),l=t.expirationTimes;for(var u=n;0<u;){var d=31-Ut(u),x=1<<d;l[d]=-1,u&=~x}s!==0&&vi(t,s,n)}function ec(){return(at&6)===0?(Nl(0),!1):!0}function xd(){if(Ke!==null){if(ft===0)var t=Ke.return;else t=Ke,ps=Ra=null,Bu(t),xo=null,fl=0,t=Ke;for(;t!==null;)Bp(t.alternate,t),t=t.return;Ke=null}}function Co(t,n){var s=t.timeoutHandle;s!==-1&&(t.timeoutHandle=-1,ub(s)),s=t.cancelPendingCommit,s!==null&&(t.cancelPendingCommit=null,s()),ws=0,xd(),wt=t,Ke=s=fs(t.current,null),We=n,ft=0,fi=null,Xs=!1,_o=Tt(t,n),md=!1,Mo=mi=pd=Ua=Qs=Ft=0,ti=Ol=null,hd=!1,(n&8)!==0&&(n|=n&32);var l=t.entangledLanes;if(l!==0)for(t=t.entanglements,l&=n;0<l;){var u=31-Ut(l),d=1<<u;n|=t[u],l&=~d}return Es=n,Sr(),s}function ah(t,n){He=null,H.H=vl,n===bo||n===Cr?(n=Sm(),ft=3):n===Tu?(n=Sm(),ft=4):ft=n===Qu?8:n!==null&&typeof n=="object"&&typeof n.then=="function"?6:1,fi=n,Ke===null&&(Ft=1,$r(t,Mi(n,t.current)))}function oh(){var t=ui.current;return t===null?!0:(We&4194048)===We?Ri===null:(We&62914560)===We||(We&536870912)!==0?t===Ri:!1}function lh(){var t=H.H;return H.H=vl,t===null?vl:t}function rh(){var t=H.A;return H.A=z0,t}function tc(){Ft=4,Xs||(We&4194048)!==We&&ui.current!==null||(_o=!0),(Qs&134217727)===0&&(Ua&134217727)===0||wt===null||ea(wt,We,mi,!1)}function vd(t,n,s){var l=at;at|=2;var u=lh(),d=rh();(wt!==t||We!==n)&&(Zr=null,Co(t,n)),n=!1;var x=Ft;e:do try{if(ft!==0&&Ke!==null){var T=Ke,L=fi;switch(ft){case 8:xd(),x=6;break e;case 3:case 2:case 9:case 6:ui.current===null&&(n=!0);var U=ft;if(ft=0,fi=null,No(t,T,L,U),s&&_o){x=0;break e}break;default:U=ft,ft=0,fi=null,No(t,T,L,U)}}Y0(),x=Ft;break}catch(Q){ah(t,Q)}while(!0);return n&&t.shellSuspendCounter++,ps=Ra=null,at=l,H.H=u,H.A=d,Ke===null&&(wt=null,We=0,Sr()),x}function Y0(){for(;Ke!==null;)ch(Ke)}function F0(t,n){var s=at;at|=2;var l=lh(),u=rh();wt!==t||We!==n?(Zr=null,Jr=At()+500,Co(t,n)):_o=Tt(t,n);e:do try{if(ft!==0&&Ke!==null){n=Ke;var d=fi;t:switch(ft){case 1:ft=0,fi=null,No(t,n,d,1);break;case 2:case 9:if(xm(d)){ft=0,fi=null,uh(n);break}n=function(){ft!==2&&ft!==9||wt!==t||(ft=7),ns(t)},d.then(n,n);break e;case 3:ft=7;break e;case 4:ft=5;break e;case 7:xm(d)?(ft=0,fi=null,uh(n)):(ft=0,fi=null,No(t,n,d,7));break;case 5:var x=null;switch(Ke.tag){case 26:x=Ke.memoizedState;case 5:case 27:var T=Ke;if(x?Wh(x):T.stateNode.complete){ft=0,fi=null;var L=T.sibling;if(L!==null)Ke=L;else{var U=T.return;U!==null?(Ke=U,nc(U)):Ke=null}break t}}ft=0,fi=null,No(t,n,d,5);break;case 6:ft=0,fi=null,No(t,n,d,6);break;case 8:xd(),Ft=6;break e;default:throw Error(o(462))}}K0();break}catch(Q){ah(t,Q)}while(!0);return ps=Ra=null,H.H=l,H.A=u,at=s,Ke!==null?0:(wt=null,We=0,Sr(),Ft)}function K0(){for(;Ke!==null&&!gn();)ch(Ke)}function ch(t){var n=Lp(t.alternate,t,Es);t.memoizedProps=t.pendingProps,n===null?nc(t):Ke=n}function uh(t){var n=t,s=n.alternate;switch(n.tag){case 15:case 0:n=Mp(s,n,n.pendingProps,n.type,void 0,We);break;case 11:n=Mp(s,n,n.pendingProps,n.type.render,n.ref,We);break;case 5:Bu(n);default:Bp(s,n),n=Ke=rm(n,Es),n=Lp(s,n,Es)}t.memoizedProps=t.pendingProps,n===null?nc(t):Ke=n}function No(t,n,s,l){ps=Ra=null,Bu(n),xo=null,fl=0;var u=n.return;try{if(B0(t,u,n,s,We)){Ft=1,$r(t,Mi(s,t.current)),Ke=null;return}}catch(d){if(u!==null)throw Ke=u,d;Ft=1,$r(t,Mi(s,t.current)),Ke=null;return}n.flags&32768?(et||l===1?t=!0:_o||(We&536870912)!==0?t=!1:(Xs=t=!0,(l===2||l===9||l===3||l===6)&&(l=ui.current,l!==null&&l.tag===13&&(l.flags|=16384))),dh(n,t)):nc(n)}function nc(t){var n=t;do{if((n.flags&32768)!==0){dh(n,Xs);return}t=n.return;var s=H0(n.alternate,n,Es);if(s!==null){Ke=s;return}if(n=n.sibling,n!==null){Ke=n;return}Ke=n=t}while(n!==null);Ft===0&&(Ft=5)}function dh(t,n){do{var s=P0(t.alternate,t);if(s!==null){s.flags&=32767,Ke=s;return}if(s=t.return,s!==null&&(s.flags|=32768,s.subtreeFlags=0,s.deletions=null),!n&&(t=t.sibling,t!==null)){Ke=t;return}Ke=t=s}while(t!==null);Ft=6,Ke=null}function fh(t,n,s,l,u,d,x,T,L){t.cancelPendingCommit=null;do ic();while(fn!==0);if((at&6)!==0)throw Error(o(327));if(n!==null){if(n===t.current)throw Error(o(177));if(d=n.lanes|n.childLanes,d|=ru,Fn(t,s,d,x,T,L),t===wt&&(Ke=wt=null,We=0),Oo=n,Zs=t,ws=s,gd=d,yd=u,th=l,(n.subtreeFlags&10256)!==0||(n.flags&10256)!==0?(t.callbackNode=null,t.callbackPriority=0,Q0(Bt,function(){return yh(),null})):(t.callbackNode=null,t.callbackPriority=0),l=(n.flags&13878)!==0,(n.subtreeFlags&13878)!==0||l){l=H.T,H.T=null,u=ee.p,ee.p=2,x=at,at|=4;try{U0(t,n,s)}finally{at=x,ee.p=u,H.T=l}}fn=1,mh(),ph(),hh()}}function mh(){if(fn===1){fn=0;var t=Zs,n=Oo,s=(n.flags&13878)!==0;if((n.subtreeFlags&13878)!==0||s){s=H.T,H.T=null;var l=ee.p;ee.p=2;var u=at;at|=4;try{Kp(n,t);var d=kd,x=Zf(t.containerInfo),T=d.focusedElem,L=d.selectionRange;if(x!==T&&T&&T.ownerDocument&&Jf(T.ownerDocument.documentElement,T)){if(L!==null&&iu(T)){var U=L.start,Q=L.end;if(Q===void 0&&(Q=U),"selectionStart"in T)T.selectionStart=U,T.selectionEnd=Math.min(Q,T.value.length);else{var ie=T.ownerDocument||document,V=ie&&ie.defaultView||window;if(V.getSelection){var G=V.getSelection(),Se=T.textContent.length,Re=Math.min(L.start,Se),xt=L.end===void 0?Re:Math.min(L.end,Se);!G.extend&&Re>xt&&(x=xt,xt=Re,Re=x);var D=Qf(T,Re),j=Qf(T,xt);if(D&&j&&(G.rangeCount!==1||G.anchorNode!==D.node||G.anchorOffset!==D.offset||G.focusNode!==j.node||G.focusOffset!==j.offset)){var P=ie.createRange();P.setStart(D.node,D.offset),G.removeAllRanges(),Re>xt?(G.addRange(P),G.extend(j.node,j.offset)):(P.setEnd(j.node,j.offset),G.addRange(P))}}}}for(ie=[],G=T;G=G.parentNode;)G.nodeType===1&&ie.push({element:G,left:G.scrollLeft,top:G.scrollTop});for(typeof T.focus=="function"&&T.focus(),T=0;T<ie.length;T++){var Z=ie[T];Z.element.scrollLeft=Z.left,Z.element.scrollTop=Z.top}}hc=!!Rd,kd=Rd=null}finally{at=u,ee.p=l,H.T=s}}t.current=n,fn=2}}function ph(){if(fn===2){fn=0;var t=Zs,n=Oo,s=(n.flags&8772)!==0;if((n.subtreeFlags&8772)!==0||s){s=H.T,H.T=null;var l=ee.p;ee.p=2;var u=at;at|=4;try{zp(t,n.alternate,n)}finally{at=u,ee.p=l,H.T=s}}fn=3}}function hh(){if(fn===4||fn===3){fn=0,$n();var t=Zs,n=Oo,s=ws,l=th;(n.subtreeFlags&10256)!==0||(n.flags&10256)!==0?fn=5:(fn=0,Oo=Zs=null,gh(t,t.pendingLanes));var u=t.pendingLanes;if(u===0&&(Js=null),Di(s),n=n.stateNode,Xt&&typeof Xt.onCommitFiberRoot=="function")try{Xt.onCommitFiberRoot(In,n,void 0,(n.current.flags&128)===128)}catch{}if(l!==null){n=H.T,u=ee.p,ee.p=2,H.T=null;try{for(var d=t.onRecoverableError,x=0;x<l.length;x++){var T=l[x];d(T.value,{componentStack:T.stack})}}finally{H.T=n,ee.p=u}}(ws&3)!==0&&ic(),ns(t),u=t.pendingLanes,(s&261930)!==0&&(u&42)!==0?t===bd?Cl++:(Cl=0,bd=t):Cl=0,Nl(0)}}function gh(t,n){(t.pooledCacheLanes&=n)===0&&(n=t.pooledCache,n!=null&&(t.pooledCache=null,ul(n)))}function ic(){return mh(),ph(),hh(),yh()}function yh(){if(fn!==5)return!1;var t=Zs,n=gd;gd=0;var s=Di(ws),l=H.T,u=ee.p;try{ee.p=32>s?32:s,H.T=null,s=yd,yd=null;var d=Zs,x=ws;if(fn=0,Oo=Zs=null,ws=0,(at&6)!==0)throw Error(o(331));var T=at;if(at|=4,Jp(d.current),Wp(d,d.current,x,s),at=T,Nl(0,!1),Xt&&typeof Xt.onPostCommitFiberRoot=="function")try{Xt.onPostCommitFiberRoot(In,d)}catch{}return!0}finally{ee.p=u,H.T=l,gh(t,n)}}function bh(t,n,s){n=Mi(s,n),n=Xu(t.stateNode,n,2),t=Fs(t,n,2),t!==null&&(tn(t,2),ns(t))}function mt(t,n,s){if(t.tag===3)bh(t,t,s);else for(;n!==null;){if(n.tag===3){bh(n,t,s);break}else if(n.tag===1){var l=n.stateNode;if(typeof n.type.getDerivedStateFromError=="function"||typeof l.componentDidCatch=="function"&&(Js===null||!Js.has(l))){t=Mi(s,t),s=xp(2),l=Fs(n,s,2),l!==null&&(vp(s,l,n,t),tn(l,2),ns(l));break}}n=n.return}}function Sd(t,n,s){var l=t.pingCache;if(l===null){l=t.pingCache=new $0;var u=new Set;l.set(n,u)}else u=l.get(n),u===void 0&&(u=new Set,l.set(n,u));u.has(s)||(md=!0,u.add(s),t=G0.bind(null,t,n,s),n.then(t,t))}function G0(t,n,s){var l=t.pingCache;l!==null&&l.delete(n),t.pingedLanes|=t.suspendedLanes&s,t.warmLanes&=~s,wt===t&&(We&s)===s&&(Ft===4||Ft===3&&(We&62914560)===We&&300>At()-Qr?(at&2)===0&&Co(t,0):pd|=s,Mo===We&&(Mo=0)),ns(t)}function xh(t,n){n===0&&(n=ks()),t=Oa(t,n),t!==null&&(tn(t,n),ns(t))}function W0(t){var n=t.memoizedState,s=0;n!==null&&(s=n.retryLane),xh(t,s)}function X0(t,n){var s=0;switch(t.tag){case 31:case 13:var l=t.stateNode,u=t.memoizedState;u!==null&&(s=u.retryLane);break;case 19:l=t.stateNode;break;case 22:l=t.stateNode._retryCache;break;default:throw Error(o(314))}l!==null&&l.delete(n),xh(t,s)}function Q0(t,n){return dt(t,n)}var sc=null,Ro=null,Ad=!1,ac=!1,Td=!1,ta=0;function ns(t){t!==Ro&&t.next===null&&(Ro===null?sc=Ro=t:Ro=Ro.next=t),ac=!0,Ad||(Ad=!0,Z0())}function Nl(t,n){if(!Td&&ac){Td=!0;do for(var s=!1,l=sc;l!==null;){if(t!==0){var u=l.pendingLanes;if(u===0)var d=0;else{var x=l.suspendedLanes,T=l.pingedLanes;d=(1<<31-Ut(42|t)+1)-1,d&=u&~(x&~T),d=d&201326741?d&201326741|1:d?d|2:0}d!==0&&(s=!0,Th(l,d))}else d=We,d=Ue(l,l===wt?d:0,l.cancelPendingCommit!==null||l.timeoutHandle!==-1),(d&3)===0||Tt(l,d)||(s=!0,Th(l,d));l=l.next}while(s);Td=!1}}function J0(){vh()}function vh(){ac=Ad=!1;var t=0;ta!==0&&cb()&&(t=ta);for(var n=At(),s=null,l=sc;l!==null;){var u=l.next,d=Sh(l,n);d===0?(l.next=null,s===null?sc=u:s.next=u,u===null&&(Ro=s)):(s=l,(t!==0||(d&3)!==0)&&(ac=!0)),l=u}fn!==0&&fn!==5||Nl(t),ta!==0&&(ta=0)}function Sh(t,n){for(var s=t.suspendedLanes,l=t.pingedLanes,u=t.expirationTimes,d=t.pendingLanes&-62914561;0<d;){var x=31-Ut(d),T=1<<x,L=u[x];L===-1?((T&s)===0||(T&l)!==0)&&(u[x]=bn(T,n)):L<=n&&(t.expiredLanes|=T),d&=~T}if(n=wt,s=We,s=Ue(t,t===n?s:0,t.cancelPendingCommit!==null||t.timeoutHandle!==-1),l=t.callbackNode,s===0||t===n&&(ft===2||ft===9)||t.cancelPendingCommit!==null)return l!==null&&l!==null&&Mt(l),t.callbackNode=null,t.callbackPriority=0;if((s&3)===0||Tt(t,s)){if(n=s&-s,n===t.callbackPriority)return n;switch(l!==null&&Mt(l),Di(s)){case 2:case 8:s=ht;break;case 32:s=Bt;break;case 268435456:s=$t;break;default:s=Bt}return l=Ah.bind(null,t),s=dt(s,l),t.callbackPriority=n,t.callbackNode=s,n}return l!==null&&l!==null&&Mt(l),t.callbackPriority=2,t.callbackNode=null,2}function Ah(t,n){if(fn!==0&&fn!==5)return t.callbackNode=null,t.callbackPriority=0,null;var s=t.callbackNode;if(ic()&&t.callbackNode!==s)return null;var l=We;return l=Ue(t,t===wt?l:0,t.cancelPendingCommit!==null||t.timeoutHandle!==-1),l===0?null:(ih(t,l,n),Sh(t,At()),t.callbackNode!=null&&t.callbackNode===s?Ah.bind(null,t):null)}function Th(t,n){if(ic())return null;ih(t,n,!0)}function Z0(){db(function(){(at&6)!==0?dt(bi,J0):vh()})}function Ed(){if(ta===0){var t=go;t===0&&(t=dn,dn<<=1,(dn&261888)===0&&(dn=256)),ta=t}return ta}function Eh(t){return t==null||typeof t=="symbol"||typeof t=="boolean"?null:typeof t=="function"?t:Wi(""+t)}function wh(t,n){var s=n.ownerDocument.createElement("input");return s.name=n.name,s.value=n.value,t.id&&s.setAttribute("form",t.id),n.parentNode.insertBefore(s,n),t=new FormData(t),s.parentNode.removeChild(s),t}function eb(t,n,s,l,u){if(n==="submit"&&s&&s.stateNode===u){var d=Eh((u[te]||null).action),x=l.submitter;x&&(n=(n=x[te]||null)?Eh(n.formAction):x.getAttribute("formAction"),n!==null&&(d=n,x=null));var T=new Ds("action","action",null,l,u);t.push({event:T,listeners:[{instance:null,listener:function(){if(l.defaultPrevented){if(ta!==0){var L=x?wh(u,x):new FormData(u);Vu(s,{pending:!0,data:L,method:u.method,action:d},null,L)}}else typeof d=="function"&&(T.preventDefault(),L=x?wh(u,x):new FormData(u),Vu(s,{pending:!0,data:L,method:u.method,action:d},d,L))},currentTarget:u}]})}}for(var wd=0;wd<lu.length;wd++){var _d=lu[wd],tb=_d.toLowerCase(),nb=_d[0].toUpperCase()+_d.slice(1);Pi(tb,"on"+nb)}Pi(nm,"onAnimationEnd"),Pi(im,"onAnimationIteration"),Pi(sm,"onAnimationStart"),Pi("dblclick","onDoubleClick"),Pi("focusin","onFocus"),Pi("focusout","onBlur"),Pi(b0,"onTransitionRun"),Pi(x0,"onTransitionStart"),Pi(v0,"onTransitionCancel"),Pi(am,"onTransitionEnd"),oi("onMouseEnter",["mouseout","mouseover"]),oi("onMouseLeave",["mouseout","mouseover"]),oi("onPointerEnter",["pointerout","pointerover"]),oi("onPointerLeave",["pointerout","pointerover"]),Xn("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),Xn("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),Xn("onBeforeInput",["compositionend","keypress","textInput","paste"]),Xn("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),Xn("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),Xn("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Rl="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),ib=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(Rl));function _h(t,n){n=(n&4)!==0;for(var s=0;s<t.length;s++){var l=t[s],u=l.event;l=l.listeners;e:{var d=void 0;if(n)for(var x=l.length-1;0<=x;x--){var T=l[x],L=T.instance,U=T.currentTarget;if(T=T.listener,L!==d&&u.isPropagationStopped())break e;d=T,u.currentTarget=U;try{d(u)}catch(Q){vr(Q)}u.currentTarget=null,d=L}else for(x=0;x<l.length;x++){if(T=l[x],L=T.instance,U=T.currentTarget,T=T.listener,L!==d&&u.isPropagationStopped())break e;d=T,u.currentTarget=U;try{d(u)}catch(Q){vr(Q)}u.currentTarget=null,d=L}}}}function Ge(t,n){var s=n[we];s===void 0&&(s=n[we]=new Set);var l=t+"__bubble";s.has(l)||(Mh(n,t,2,!1),s.add(l))}function Md(t,n,s){var l=0;n&&(l|=4),Mh(s,t,l,n)}var oc="_reactListening"+Math.random().toString(36).slice(2);function Od(t){if(!t[oc]){t[oc]=!0,ls.forEach(function(s){s!=="selectionchange"&&(ib.has(s)||Md(s,!1,t),Md(s,!0,t))});var n=t.nodeType===9?t:t.ownerDocument;n===null||n[oc]||(n[oc]=!0,Md("selectionchange",!1,n))}}function Mh(t,n,s,l){switch(ng(n)){case 2:var u=Rb;break;case 8:u=kb;break;default:u=$d}s=u.bind(null,n,s,t),u=void 0,!Qi||n!=="touchstart"&&n!=="touchmove"&&n!=="wheel"||(u=!0),l?u!==void 0?t.addEventListener(n,s,{capture:!0,passive:u}):t.addEventListener(n,s,!0):u!==void 0?t.addEventListener(n,s,{passive:u}):t.addEventListener(n,s,!1)}function Cd(t,n,s,l,u){var d=l;if((n&1)===0&&(n&2)===0&&l!==null)e:for(;;){if(l===null)return;var x=l.tag;if(x===3||x===4){var T=l.stateNode.containerInfo;if(T===u)break;if(x===4)for(x=l.return;x!==null;){var L=x.tag;if((L===3||L===4)&&x.stateNode.containerInfo===u)return;x=x.return}for(;T!==null;){if(x=Ye(T),x===null)return;if(L=x.tag,L===5||L===6||L===26||L===27){l=d=x;continue e}T=T.parentNode}}l=l.return}dr(function(){var U=d,Q=Go(s),ie=[];e:{var V=om.get(t);if(V!==void 0){var G=Ds,Se=t;switch(t){case"keypress":if(io(s)===0)break e;case"keydown":case"keyup":G=Qt;break;case"focusin":Se="focus",G=B;break;case"focusout":Se="blur",G=B;break;case"beforeblur":case"afterblur":G=B;break;case"click":if(s.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":G=Je;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":G=vn;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":G=hr;break;case nm:case im:case sm:G=le;break;case am:G=yr;break;case"scroll":case"scrollend":G=pr;break;case"wheel":G=Zc;break;case"copy":case"cut":case"paste":G=fe;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":G=Mn;break;case"toggle":case"beforetoggle":G=Jo}var Re=(n&4)!==0,xt=!Re&&(t==="scroll"||t==="scrollend"),D=Re?V!==null?V+"Capture":null:V;Re=[];for(var j=U,P;j!==null;){var Z=j;if(P=Z.stateNode,Z=Z.tag,Z!==5&&Z!==26&&Z!==27||P===null||D===null||(Z=va(j,D),Z!=null&&Re.push(kl(j,Z,P))),xt)break;j=j.return}0<Re.length&&(V=new G(V,Se,null,s,Q),ie.push({event:V,listeners:Re}))}}if((n&7)===0){e:{if(V=t==="mouseover"||t==="pointerover",G=t==="mouseout"||t==="pointerout",V&&s!==Ko&&(Se=s.relatedTarget||s.fromElement)&&(Ye(Se)||Se[de]))break e;if((G||V)&&(V=Q.window===Q?Q:(V=Q.ownerDocument)?V.defaultView||V.parentWindow:window,G?(Se=s.relatedTarget||s.toElement,G=U,Se=Se?Ye(Se):null,Se!==null&&(xt=r(Se),Re=Se.tag,Se!==xt||Re!==5&&Re!==27&&Re!==6)&&(Se=null)):(G=null,Se=U),G!==Se)){if(Re=Je,Z="onMouseLeave",D="onMouseEnter",j="mouse",(t==="pointerout"||t==="pointerover")&&(Re=Mn,Z="onPointerLeave",D="onPointerEnter",j="pointer"),xt=G==null?V:Vt(G),P=Se==null?V:Vt(Se),V=new Re(Z,j+"leave",G,s,Q),V.target=xt,V.relatedTarget=P,Z=null,Ye(Q)===U&&(Re=new Re(D,j+"enter",Se,s,Q),Re.target=P,Re.relatedTarget=xt,Z=Re),xt=Z,G&&Se)t:{for(Re=sb,D=G,j=Se,P=0,Z=D;Z;Z=Re(Z))P++;Z=0;for(var Oe=j;Oe;Oe=Re(Oe))Z++;for(;0<P-Z;)D=Re(D),P--;for(;0<Z-P;)j=Re(j),Z--;for(;P--;){if(D===j||j!==null&&D===j.alternate){Re=D;break t}D=Re(D),j=Re(j)}Re=null}else Re=null;G!==null&&Oh(ie,V,G,Re,!1),Se!==null&&xt!==null&&Oh(ie,xt,Se,Re,!0)}}e:{if(V=U?Vt(U):window,G=V.nodeName&&V.nodeName.toLowerCase(),G==="select"||G==="input"&&V.type==="file")var it=Yf;else if($f(V))if(Ff)it=h0;else{it=m0;var Ae=f0}else G=V.nodeName,!G||G.toLowerCase()!=="input"||V.type!=="checkbox"&&V.type!=="radio"?U&&Gi(U.elementType)&&(it=Yf):it=p0;if(it&&(it=it(t,U))){Vf(ie,it,s,Q);break e}Ae&&Ae(t,V,U),t==="focusout"&&U&&V.type==="number"&&U.memoizedProps.value!=null&&Ai(V,"number",V.value)}switch(Ae=U?Vt(U):window,t){case"focusin":($f(Ae)||Ae.contentEditable==="true")&&(lo=Ae,su=U,ll=null);break;case"focusout":ll=su=lo=null;break;case"mousedown":au=!0;break;case"contextmenu":case"mouseup":case"dragend":au=!1,em(ie,s,Q);break;case"selectionchange":if(y0)break;case"keydown":case"keyup":em(ie,s,Q)}var Pe;if(el)e:{switch(t){case"compositionstart":var Xe="onCompositionStart";break e;case"compositionend":Xe="onCompositionEnd";break e;case"compositionupdate":Xe="onCompositionUpdate";break e}Xe=void 0}else oo?nl(t,s)&&(Xe="onCompositionEnd"):t==="keydown"&&s.keyCode===229&&(Xe="onCompositionStart");Xe&&(wa&&s.locale!=="ko"&&(oo||Xe!=="onCompositionStart"?Xe==="onCompositionEnd"&&oo&&(Pe=fr()):(Ji=Q,js="value"in Ji?Ji.value:Ji.textContent,oo=!0)),Ae=lc(U,Xe),0<Ae.length&&(Xe=new Fe(Xe,t,null,s,Q),ie.push({event:Xe,listeners:Ae}),Pe?Xe.data=Pe:(Pe=il(s),Pe!==null&&(Xe.data=Pe)))),(Pe=so?r0(t,s):c0(t,s))&&(Xe=lc(U,"onBeforeInput"),0<Xe.length&&(Ae=new Fe("onBeforeInput","beforeinput",null,s,Q),ie.push({event:Ae,listeners:Xe}),Ae.data=Pe)),eb(ie,t,U,s,Q)}_h(ie,n)})}function kl(t,n,s){return{instance:t,listener:n,currentTarget:s}}function lc(t,n){for(var s=n+"Capture",l=[];t!==null;){var u=t,d=u.stateNode;if(u=u.tag,u!==5&&u!==26&&u!==27||d===null||(u=va(t,s),u!=null&&l.unshift(kl(t,u,d)),u=va(t,n),u!=null&&l.push(kl(t,u,d))),t.tag===3)return l;t=t.return}return[]}function sb(t){if(t===null)return null;do t=t.return;while(t&&t.tag!==5&&t.tag!==27);return t||null}function Oh(t,n,s,l,u){for(var d=n._reactName,x=[];s!==null&&s!==l;){var T=s,L=T.alternate,U=T.stateNode;if(T=T.tag,L!==null&&L===l)break;T!==5&&T!==26&&T!==27||U===null||(L=U,u?(U=va(s,d),U!=null&&x.unshift(kl(s,U,L))):u||(U=va(s,d),U!=null&&x.push(kl(s,U,L)))),s=s.return}x.length!==0&&t.push({event:n,listeners:x})}var ab=/\r\n?/g,ob=/\u0000|\uFFFD/g;function Ch(t){return(typeof t=="string"?t:""+t).replace(ab,`
`).replace(ob,"")}function Nh(t,n){return n=Ch(n),Ch(t)===n}function bt(t,n,s,l,u,d){switch(s){case"children":typeof l=="string"?n==="body"||n==="textarea"&&l===""||Bs(t,l):(typeof l=="number"||typeof l=="bigint")&&n!=="body"&&Bs(t,""+l);break;case"className":_n(t,"class",l);break;case"tabIndex":_n(t,"tabindex",l);break;case"dir":case"role":case"viewBox":case"width":case"height":_n(t,s,l);break;case"style":eo(t,l,d);break;case"data":if(n!=="object"){_n(t,"data",l);break}case"src":case"href":if(l===""&&(n!=="a"||s!=="href")){t.removeAttribute(s);break}if(l==null||typeof l=="function"||typeof l=="symbol"||typeof l=="boolean"){t.removeAttribute(s);break}l=Wi(""+l),t.setAttribute(s,l);break;case"action":case"formAction":if(typeof l=="function"){t.setAttribute(s,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof d=="function"&&(s==="formAction"?(n!=="input"&&bt(t,n,"name",u.name,u,null),bt(t,n,"formEncType",u.formEncType,u,null),bt(t,n,"formMethod",u.formMethod,u,null),bt(t,n,"formTarget",u.formTarget,u,null)):(bt(t,n,"encType",u.encType,u,null),bt(t,n,"method",u.method,u,null),bt(t,n,"target",u.target,u,null)));if(l==null||typeof l=="symbol"||typeof l=="boolean"){t.removeAttribute(s);break}l=Wi(""+l),t.setAttribute(s,l);break;case"onClick":l!=null&&(t.onclick=Ti);break;case"onScroll":l!=null&&Ge("scroll",t);break;case"onScrollEnd":l!=null&&Ge("scrollend",t);break;case"dangerouslySetInnerHTML":if(l!=null){if(typeof l!="object"||!("__html"in l))throw Error(o(61));if(s=l.__html,s!=null){if(u.children!=null)throw Error(o(60));t.innerHTML=s}}break;case"multiple":t.multiple=l&&typeof l!="function"&&typeof l!="symbol";break;case"muted":t.muted=l&&typeof l!="function"&&typeof l!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(l==null||typeof l=="function"||typeof l=="boolean"||typeof l=="symbol"){t.removeAttribute("xlink:href");break}s=Wi(""+l),t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",s);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":l!=null&&typeof l!="function"&&typeof l!="symbol"?t.setAttribute(s,""+l):t.removeAttribute(s);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":l&&typeof l!="function"&&typeof l!="symbol"?t.setAttribute(s,""):t.removeAttribute(s);break;case"capture":case"download":l===!0?t.setAttribute(s,""):l!==!1&&l!=null&&typeof l!="function"&&typeof l!="symbol"?t.setAttribute(s,l):t.removeAttribute(s);break;case"cols":case"rows":case"size":case"span":l!=null&&typeof l!="function"&&typeof l!="symbol"&&!isNaN(l)&&1<=l?t.setAttribute(s,l):t.removeAttribute(s);break;case"rowSpan":case"start":l==null||typeof l=="function"||typeof l=="symbol"||isNaN(l)?t.removeAttribute(s):t.setAttribute(s,l);break;case"popover":Ge("beforetoggle",t),Ge("toggle",t),wn(t,"popover",l);break;case"xlinkActuate":Hn(t,"http://www.w3.org/1999/xlink","xlink:actuate",l);break;case"xlinkArcrole":Hn(t,"http://www.w3.org/1999/xlink","xlink:arcrole",l);break;case"xlinkRole":Hn(t,"http://www.w3.org/1999/xlink","xlink:role",l);break;case"xlinkShow":Hn(t,"http://www.w3.org/1999/xlink","xlink:show",l);break;case"xlinkTitle":Hn(t,"http://www.w3.org/1999/xlink","xlink:title",l);break;case"xlinkType":Hn(t,"http://www.w3.org/1999/xlink","xlink:type",l);break;case"xmlBase":Hn(t,"http://www.w3.org/XML/1998/namespace","xml:base",l);break;case"xmlLang":Hn(t,"http://www.w3.org/XML/1998/namespace","xml:lang",l);break;case"xmlSpace":Hn(t,"http://www.w3.org/XML/1998/namespace","xml:space",l);break;case"is":wn(t,"is",l);break;case"innerText":case"textContent":break;default:(!(2<s.length)||s[0]!=="o"&&s[0]!=="O"||s[1]!=="n"&&s[1]!=="N")&&(s=Fo.get(s)||s,wn(t,s,l))}}function Nd(t,n,s,l,u,d){switch(s){case"style":eo(t,l,d);break;case"dangerouslySetInnerHTML":if(l!=null){if(typeof l!="object"||!("__html"in l))throw Error(o(61));if(s=l.__html,s!=null){if(u.children!=null)throw Error(o(60));t.innerHTML=s}}break;case"children":typeof l=="string"?Bs(t,l):(typeof l=="number"||typeof l=="bigint")&&Bs(t,""+l);break;case"onScroll":l!=null&&Ge("scroll",t);break;case"onScrollEnd":l!=null&&Ge("scrollend",t);break;case"onClick":l!=null&&(t.onclick=Ti);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!ga.hasOwnProperty(s))e:{if(s[0]==="o"&&s[1]==="n"&&(u=s.endsWith("Capture"),n=s.slice(2,u?s.length-7:void 0),d=t[te]||null,d=d!=null?d[s]:null,typeof d=="function"&&t.removeEventListener(n,d,u),typeof l=="function")){typeof d!="function"&&d!==null&&(s in t?t[s]=null:t.hasAttribute(s)&&t.removeAttribute(s)),t.addEventListener(n,l,u);break e}s in t?t[s]=l:l===!0?t.setAttribute(s,""):wn(t,s,l)}}}function Rn(t,n,s){switch(n){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":Ge("error",t),Ge("load",t);var l=!1,u=!1,d;for(d in s)if(s.hasOwnProperty(d)){var x=s[d];if(x!=null)switch(d){case"src":l=!0;break;case"srcSet":u=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(o(137,n));default:bt(t,n,d,x,s,null)}}u&&bt(t,n,"srcSet",s.srcSet,s,null),l&&bt(t,n,"src",s.src,s,null);return;case"input":Ge("invalid",t);var T=d=x=u=null,L=null,U=null;for(l in s)if(s.hasOwnProperty(l)){var Q=s[l];if(Q!=null)switch(l){case"name":u=Q;break;case"type":x=Q;break;case"checked":L=Q;break;case"defaultChecked":U=Q;break;case"value":d=Q;break;case"defaultValue":T=Q;break;case"children":case"dangerouslySetInnerHTML":if(Q!=null)throw Error(o(137,n));break;default:bt(t,n,l,Q,s,null)}}$o(t,d,T,L,U,x,u,!1);return;case"select":Ge("invalid",t),l=x=d=null;for(u in s)if(s.hasOwnProperty(u)&&(T=s[u],T!=null))switch(u){case"value":d=T;break;case"defaultValue":x=T;break;case"multiple":l=T;default:bt(t,n,u,T,s,null)}n=d,s=x,t.multiple=!!l,n!=null?cs(t,!!l,n,!1):s!=null&&cs(t,!!l,s,!0);return;case"textarea":Ge("invalid",t),d=u=l=null;for(x in s)if(s.hasOwnProperty(x)&&(T=s[x],T!=null))switch(x){case"value":l=T;break;case"defaultValue":u=T;break;case"children":d=T;break;case"dangerouslySetInnerHTML":if(T!=null)throw Error(o(91));break;default:bt(t,n,x,T,s,null)}cr(t,l,u,d);return;case"option":for(L in s)s.hasOwnProperty(L)&&(l=s[L],l!=null)&&(L==="selected"?t.selected=l&&typeof l!="function"&&typeof l!="symbol":bt(t,n,L,l,s,null));return;case"dialog":Ge("beforetoggle",t),Ge("toggle",t),Ge("cancel",t),Ge("close",t);break;case"iframe":case"object":Ge("load",t);break;case"video":case"audio":for(l=0;l<Rl.length;l++)Ge(Rl[l],t);break;case"image":Ge("error",t),Ge("load",t);break;case"details":Ge("toggle",t);break;case"embed":case"source":case"link":Ge("error",t),Ge("load",t);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(U in s)if(s.hasOwnProperty(U)&&(l=s[U],l!=null))switch(U){case"children":case"dangerouslySetInnerHTML":throw Error(o(137,n));default:bt(t,n,U,l,s,null)}return;default:if(Gi(n)){for(Q in s)s.hasOwnProperty(Q)&&(l=s[Q],l!==void 0&&Nd(t,n,Q,l,s,void 0));return}}for(T in s)s.hasOwnProperty(T)&&(l=s[T],l!=null&&bt(t,n,T,l,s,null))}function lb(t,n,s,l){switch(n){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var u=null,d=null,x=null,T=null,L=null,U=null,Q=null;for(G in s){var ie=s[G];if(s.hasOwnProperty(G)&&ie!=null)switch(G){case"checked":break;case"value":break;case"defaultValue":L=ie;default:l.hasOwnProperty(G)||bt(t,n,G,null,l,ie)}}for(var V in l){var G=l[V];if(ie=s[V],l.hasOwnProperty(V)&&(G!=null||ie!=null))switch(V){case"type":d=G;break;case"name":u=G;break;case"checked":U=G;break;case"defaultChecked":Q=G;break;case"value":x=G;break;case"defaultValue":T=G;break;case"children":case"dangerouslySetInnerHTML":if(G!=null)throw Error(o(137,n));break;default:G!==ie&&bt(t,n,V,G,l,ie)}}Za(t,x,T,L,U,Q,d,u);return;case"select":G=x=T=V=null;for(d in s)if(L=s[d],s.hasOwnProperty(d)&&L!=null)switch(d){case"value":break;case"multiple":G=L;default:l.hasOwnProperty(d)||bt(t,n,d,null,l,L)}for(u in l)if(d=l[u],L=s[u],l.hasOwnProperty(u)&&(d!=null||L!=null))switch(u){case"value":V=d;break;case"defaultValue":T=d;break;case"multiple":x=d;default:d!==L&&bt(t,n,u,d,l,L)}n=T,s=x,l=G,V!=null?cs(t,!!s,V,!1):!!l!=!!s&&(n!=null?cs(t,!!s,n,!0):cs(t,!!s,s?[]:"",!1));return;case"textarea":G=V=null;for(T in s)if(u=s[T],s.hasOwnProperty(T)&&u!=null&&!l.hasOwnProperty(T))switch(T){case"value":break;case"children":break;default:bt(t,n,T,null,l,u)}for(x in l)if(u=l[x],d=s[x],l.hasOwnProperty(x)&&(u!=null||d!=null))switch(x){case"value":V=u;break;case"defaultValue":G=u;break;case"children":break;case"dangerouslySetInnerHTML":if(u!=null)throw Error(o(91));break;default:u!==d&&bt(t,n,x,u,l,d)}Vo(t,V,G);return;case"option":for(var Se in s)V=s[Se],s.hasOwnProperty(Se)&&V!=null&&!l.hasOwnProperty(Se)&&(Se==="selected"?t.selected=!1:bt(t,n,Se,null,l,V));for(L in l)V=l[L],G=s[L],l.hasOwnProperty(L)&&V!==G&&(V!=null||G!=null)&&(L==="selected"?t.selected=V&&typeof V!="function"&&typeof V!="symbol":bt(t,n,L,V,l,G));return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var Re in s)V=s[Re],s.hasOwnProperty(Re)&&V!=null&&!l.hasOwnProperty(Re)&&bt(t,n,Re,null,l,V);for(U in l)if(V=l[U],G=s[U],l.hasOwnProperty(U)&&V!==G&&(V!=null||G!=null))switch(U){case"children":case"dangerouslySetInnerHTML":if(V!=null)throw Error(o(137,n));break;default:bt(t,n,U,V,l,G)}return;default:if(Gi(n)){for(var xt in s)V=s[xt],s.hasOwnProperty(xt)&&V!==void 0&&!l.hasOwnProperty(xt)&&Nd(t,n,xt,void 0,l,V);for(Q in l)V=l[Q],G=s[Q],!l.hasOwnProperty(Q)||V===G||V===void 0&&G===void 0||Nd(t,n,Q,V,l,G);return}}for(var D in s)V=s[D],s.hasOwnProperty(D)&&V!=null&&!l.hasOwnProperty(D)&&bt(t,n,D,null,l,V);for(ie in l)V=l[ie],G=s[ie],!l.hasOwnProperty(ie)||V===G||V==null&&G==null||bt(t,n,ie,V,l,G)}function Rh(t){switch(t){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}function rb(){if(typeof performance.getEntriesByType=="function"){for(var t=0,n=0,s=performance.getEntriesByType("resource"),l=0;l<s.length;l++){var u=s[l],d=u.transferSize,x=u.initiatorType,T=u.duration;if(d&&T&&Rh(x)){for(x=0,T=u.responseEnd,l+=1;l<s.length;l++){var L=s[l],U=L.startTime;if(U>T)break;var Q=L.transferSize,ie=L.initiatorType;Q&&Rh(ie)&&(L=L.responseEnd,x+=Q*(L<T?1:(T-U)/(L-U)))}if(--l,n+=8*(d+x)/(u.duration/1e3),t++,10<t)break}}if(0<t)return n/t/1e6}return navigator.connection&&(t=navigator.connection.downlink,typeof t=="number")?t:5}var Rd=null,kd=null;function rc(t){return t.nodeType===9?t:t.ownerDocument}function kh(t){switch(t){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function Lh(t,n){if(t===0)switch(n){case"svg":return 1;case"math":return 2;default:return 0}return t===1&&n==="foreignObject"?0:t}function Ld(t,n){return t==="textarea"||t==="noscript"||typeof n.children=="string"||typeof n.children=="number"||typeof n.children=="bigint"||typeof n.dangerouslySetInnerHTML=="object"&&n.dangerouslySetInnerHTML!==null&&n.dangerouslySetInnerHTML.__html!=null}var Id=null;function cb(){var t=window.event;return t&&t.type==="popstate"?t===Id?!1:(Id=t,!0):(Id=null,!1)}var Ih=typeof setTimeout=="function"?setTimeout:void 0,ub=typeof clearTimeout=="function"?clearTimeout:void 0,Bh=typeof Promise=="function"?Promise:void 0,db=typeof queueMicrotask=="function"?queueMicrotask:typeof Bh<"u"?function(t){return Bh.resolve(null).then(t).catch(fb)}:Ih;function fb(t){setTimeout(function(){throw t})}function na(t){return t==="head"}function jh(t,n){var s=n,l=0;do{var u=s.nextSibling;if(t.removeChild(s),u&&u.nodeType===8)if(s=u.data,s==="/$"||s==="/&"){if(l===0){t.removeChild(u),Bo(n);return}l--}else if(s==="$"||s==="$?"||s==="$~"||s==="$!"||s==="&")l++;else if(s==="html")Ll(t.ownerDocument.documentElement);else if(s==="head"){s=t.ownerDocument.head,Ll(s);for(var d=s.firstChild;d;){var x=d.nextSibling,T=d.nodeName;d[Ot]||T==="SCRIPT"||T==="STYLE"||T==="LINK"&&d.rel.toLowerCase()==="stylesheet"||s.removeChild(d),d=x}}else s==="body"&&Ll(t.ownerDocument.body);s=u}while(s);Bo(n)}function Dh(t,n){var s=t;t=0;do{var l=s.nextSibling;if(s.nodeType===1?n?(s._stashedDisplay=s.style.display,s.style.display="none"):(s.style.display=s._stashedDisplay||"",s.getAttribute("style")===""&&s.removeAttribute("style")):s.nodeType===3&&(n?(s._stashedText=s.nodeValue,s.nodeValue=""):s.nodeValue=s._stashedText||""),l&&l.nodeType===8)if(s=l.data,s==="/$"){if(t===0)break;t--}else s!=="$"&&s!=="$?"&&s!=="$~"&&s!=="$!"||t++;s=l}while(s)}function Bd(t){var n=t.firstChild;for(n&&n.nodeType===10&&(n=n.nextSibling);n;){var s=n;switch(n=n.nextSibling,s.nodeName){case"HTML":case"HEAD":case"BODY":Bd(s),lt(s);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(s.rel.toLowerCase()==="stylesheet")continue}t.removeChild(s)}}function mb(t,n,s,l){for(;t.nodeType===1;){var u=s;if(t.nodeName.toLowerCase()!==n.toLowerCase()){if(!l&&(t.nodeName!=="INPUT"||t.type!=="hidden"))break}else if(l){if(!t[Ot])switch(n){case"meta":if(!t.hasAttribute("itemprop"))break;return t;case"link":if(d=t.getAttribute("rel"),d==="stylesheet"&&t.hasAttribute("data-precedence"))break;if(d!==u.rel||t.getAttribute("href")!==(u.href==null||u.href===""?null:u.href)||t.getAttribute("crossorigin")!==(u.crossOrigin==null?null:u.crossOrigin)||t.getAttribute("title")!==(u.title==null?null:u.title))break;return t;case"style":if(t.hasAttribute("data-precedence"))break;return t;case"script":if(d=t.getAttribute("src"),(d!==(u.src==null?null:u.src)||t.getAttribute("type")!==(u.type==null?null:u.type)||t.getAttribute("crossorigin")!==(u.crossOrigin==null?null:u.crossOrigin))&&d&&t.hasAttribute("async")&&!t.hasAttribute("itemprop"))break;return t;default:return t}}else if(n==="input"&&t.type==="hidden"){var d=u.name==null?null:""+u.name;if(u.type==="hidden"&&t.getAttribute("name")===d)return t}else return t;if(t=ki(t.nextSibling),t===null)break}return null}function pb(t,n,s){if(n==="")return null;for(;t.nodeType!==3;)if((t.nodeType!==1||t.nodeName!=="INPUT"||t.type!=="hidden")&&!s||(t=ki(t.nextSibling),t===null))return null;return t}function Hh(t,n){for(;t.nodeType!==8;)if((t.nodeType!==1||t.nodeName!=="INPUT"||t.type!=="hidden")&&!n||(t=ki(t.nextSibling),t===null))return null;return t}function jd(t){return t.data==="$?"||t.data==="$~"}function Dd(t){return t.data==="$!"||t.data==="$?"&&t.ownerDocument.readyState!=="loading"}function hb(t,n){var s=t.ownerDocument;if(t.data==="$~")t._reactRetry=n;else if(t.data!=="$?"||s.readyState!=="loading")n();else{var l=function(){n(),s.removeEventListener("DOMContentLoaded",l)};s.addEventListener("DOMContentLoaded",l),t._reactRetry=l}}function ki(t){for(;t!=null;t=t.nextSibling){var n=t.nodeType;if(n===1||n===3)break;if(n===8){if(n=t.data,n==="$"||n==="$!"||n==="$?"||n==="$~"||n==="&"||n==="F!"||n==="F")break;if(n==="/$"||n==="/&")return null}}return t}var Hd=null;function Ph(t){t=t.nextSibling;for(var n=0;t;){if(t.nodeType===8){var s=t.data;if(s==="/$"||s==="/&"){if(n===0)return ki(t.nextSibling);n--}else s!=="$"&&s!=="$!"&&s!=="$?"&&s!=="$~"&&s!=="&"||n++}t=t.nextSibling}return null}function Uh(t){t=t.previousSibling;for(var n=0;t;){if(t.nodeType===8){var s=t.data;if(s==="$"||s==="$!"||s==="$?"||s==="$~"||s==="&"){if(n===0)return t;n--}else s!=="/$"&&s!=="/&"||n++}t=t.previousSibling}return null}function qh(t,n,s){switch(n=rc(s),t){case"html":if(t=n.documentElement,!t)throw Error(o(452));return t;case"head":if(t=n.head,!t)throw Error(o(453));return t;case"body":if(t=n.body,!t)throw Error(o(454));return t;default:throw Error(o(451))}}function Ll(t){for(var n=t.attributes;n.length;)t.removeAttributeNode(n[0]);lt(t)}var Li=new Map,zh=new Set;function cc(t){return typeof t.getRootNode=="function"?t.getRootNode():t.nodeType===9?t:t.ownerDocument}var _s=ee.d;ee.d={f:gb,r:yb,D:bb,C:xb,L:vb,m:Sb,X:Tb,S:Ab,M:Eb};function gb(){var t=_s.f(),n=ec();return t||n}function yb(t){var n=rt(t);n!==null&&n.tag===5&&n.type==="form"?ap(n):_s.r(t)}var ko=typeof document>"u"?null:document;function $h(t,n,s){var l=ko;if(l&&typeof n=="string"&&n){var u=Qn(n);u='link[rel="'+t+'"][href="'+u+'"]',typeof s=="string"&&(u+='[crossorigin="'+s+'"]'),zh.has(u)||(zh.add(u),t={rel:t,crossOrigin:s,href:n},l.querySelector(u)===null&&(n=l.createElement("link"),Rn(n,"link",t),Ct(n),l.head.appendChild(n)))}}function bb(t){_s.D(t),$h("dns-prefetch",t,null)}function xb(t,n){_s.C(t,n),$h("preconnect",t,n)}function vb(t,n,s){_s.L(t,n,s);var l=ko;if(l&&t&&n){var u='link[rel="preload"][as="'+Qn(n)+'"]';n==="image"&&s&&s.imageSrcSet?(u+='[imagesrcset="'+Qn(s.imageSrcSet)+'"]',typeof s.imageSizes=="string"&&(u+='[imagesizes="'+Qn(s.imageSizes)+'"]')):u+='[href="'+Qn(t)+'"]';var d=u;switch(n){case"style":d=Lo(t);break;case"script":d=Io(t)}Li.has(d)||(t=v({rel:"preload",href:n==="image"&&s&&s.imageSrcSet?void 0:t,as:n},s),Li.set(d,t),l.querySelector(u)!==null||n==="style"&&l.querySelector(Il(d))||n==="script"&&l.querySelector(Bl(d))||(n=l.createElement("link"),Rn(n,"link",t),Ct(n),l.head.appendChild(n)))}}function Sb(t,n){_s.m(t,n);var s=ko;if(s&&t){var l=n&&typeof n.as=="string"?n.as:"script",u='link[rel="modulepreload"][as="'+Qn(l)+'"][href="'+Qn(t)+'"]',d=u;switch(l){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":d=Io(t)}if(!Li.has(d)&&(t=v({rel:"modulepreload",href:t},n),Li.set(d,t),s.querySelector(u)===null)){switch(l){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(s.querySelector(Bl(d)))return}l=s.createElement("link"),Rn(l,"link",t),Ct(l),s.head.appendChild(l)}}}function Ab(t,n,s){_s.S(t,n,s);var l=ko;if(l&&t){var u=Dn(l).hoistableStyles,d=Lo(t);n=n||"default";var x=u.get(d);if(!x){var T={loading:0,preload:null};if(x=l.querySelector(Il(d)))T.loading=5;else{t=v({rel:"stylesheet",href:t,"data-precedence":n},s),(s=Li.get(d))&&Pd(t,s);var L=x=l.createElement("link");Ct(L),Rn(L,"link",t),L._p=new Promise(function(U,Q){L.onload=U,L.onerror=Q}),L.addEventListener("load",function(){T.loading|=1}),L.addEventListener("error",function(){T.loading|=2}),T.loading|=4,uc(x,n,l)}x={type:"stylesheet",instance:x,count:1,state:T},u.set(d,x)}}}function Tb(t,n){_s.X(t,n);var s=ko;if(s&&t){var l=Dn(s).hoistableScripts,u=Io(t),d=l.get(u);d||(d=s.querySelector(Bl(u)),d||(t=v({src:t,async:!0},n),(n=Li.get(u))&&Ud(t,n),d=s.createElement("script"),Ct(d),Rn(d,"link",t),s.head.appendChild(d)),d={type:"script",instance:d,count:1,state:null},l.set(u,d))}}function Eb(t,n){_s.M(t,n);var s=ko;if(s&&t){var l=Dn(s).hoistableScripts,u=Io(t),d=l.get(u);d||(d=s.querySelector(Bl(u)),d||(t=v({src:t,async:!0,type:"module"},n),(n=Li.get(u))&&Ud(t,n),d=s.createElement("script"),Ct(d),Rn(d,"link",t),s.head.appendChild(d)),d={type:"script",instance:d,count:1,state:null},l.set(u,d))}}function Vh(t,n,s,l){var u=(u=ke.current)?cc(u):null;if(!u)throw Error(o(446));switch(t){case"meta":case"title":return null;case"style":return typeof s.precedence=="string"&&typeof s.href=="string"?(n=Lo(s.href),s=Dn(u).hoistableStyles,l=s.get(n),l||(l={type:"style",instance:null,count:0,state:null},s.set(n,l)),l):{type:"void",instance:null,count:0,state:null};case"link":if(s.rel==="stylesheet"&&typeof s.href=="string"&&typeof s.precedence=="string"){t=Lo(s.href);var d=Dn(u).hoistableStyles,x=d.get(t);if(x||(u=u.ownerDocument||u,x={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},d.set(t,x),(d=u.querySelector(Il(t)))&&!d._p&&(x.instance=d,x.state.loading=5),Li.has(t)||(s={rel:"preload",as:"style",href:s.href,crossOrigin:s.crossOrigin,integrity:s.integrity,media:s.media,hrefLang:s.hrefLang,referrerPolicy:s.referrerPolicy},Li.set(t,s),d||wb(u,t,s,x.state))),n&&l===null)throw Error(o(528,""));return x}if(n&&l!==null)throw Error(o(529,""));return null;case"script":return n=s.async,s=s.src,typeof s=="string"&&n&&typeof n!="function"&&typeof n!="symbol"?(n=Io(s),s=Dn(u).hoistableScripts,l=s.get(n),l||(l={type:"script",instance:null,count:0,state:null},s.set(n,l)),l):{type:"void",instance:null,count:0,state:null};default:throw Error(o(444,t))}}function Lo(t){return'href="'+Qn(t)+'"'}function Il(t){return'link[rel="stylesheet"]['+t+"]"}function Yh(t){return v({},t,{"data-precedence":t.precedence,precedence:null})}function wb(t,n,s,l){t.querySelector('link[rel="preload"][as="style"]['+n+"]")?l.loading=1:(n=t.createElement("link"),l.preload=n,n.addEventListener("load",function(){return l.loading|=1}),n.addEventListener("error",function(){return l.loading|=2}),Rn(n,"link",s),Ct(n),t.head.appendChild(n))}function Io(t){return'[src="'+Qn(t)+'"]'}function Bl(t){return"script[async]"+t}function Fh(t,n,s){if(n.count++,n.instance===null)switch(n.type){case"style":var l=t.querySelector('style[data-href~="'+Qn(s.href)+'"]');if(l)return n.instance=l,Ct(l),l;var u=v({},s,{"data-href":s.href,"data-precedence":s.precedence,href:null,precedence:null});return l=(t.ownerDocument||t).createElement("style"),Ct(l),Rn(l,"style",u),uc(l,s.precedence,t),n.instance=l;case"stylesheet":u=Lo(s.href);var d=t.querySelector(Il(u));if(d)return n.state.loading|=4,n.instance=d,Ct(d),d;l=Yh(s),(u=Li.get(u))&&Pd(l,u),d=(t.ownerDocument||t).createElement("link"),Ct(d);var x=d;return x._p=new Promise(function(T,L){x.onload=T,x.onerror=L}),Rn(d,"link",l),n.state.loading|=4,uc(d,s.precedence,t),n.instance=d;case"script":return d=Io(s.src),(u=t.querySelector(Bl(d)))?(n.instance=u,Ct(u),u):(l=s,(u=Li.get(d))&&(l=v({},s),Ud(l,u)),t=t.ownerDocument||t,u=t.createElement("script"),Ct(u),Rn(u,"link",l),t.head.appendChild(u),n.instance=u);case"void":return null;default:throw Error(o(443,n.type))}else n.type==="stylesheet"&&(n.state.loading&4)===0&&(l=n.instance,n.state.loading|=4,uc(l,s.precedence,t));return n.instance}function uc(t,n,s){for(var l=s.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),u=l.length?l[l.length-1]:null,d=u,x=0;x<l.length;x++){var T=l[x];if(T.dataset.precedence===n)d=T;else if(d!==u)break}d?d.parentNode.insertBefore(t,d.nextSibling):(n=s.nodeType===9?s.head:s,n.insertBefore(t,n.firstChild))}function Pd(t,n){t.crossOrigin==null&&(t.crossOrigin=n.crossOrigin),t.referrerPolicy==null&&(t.referrerPolicy=n.referrerPolicy),t.title==null&&(t.title=n.title)}function Ud(t,n){t.crossOrigin==null&&(t.crossOrigin=n.crossOrigin),t.referrerPolicy==null&&(t.referrerPolicy=n.referrerPolicy),t.integrity==null&&(t.integrity=n.integrity)}var dc=null;function Kh(t,n,s){if(dc===null){var l=new Map,u=dc=new Map;u.set(s,l)}else u=dc,l=u.get(s),l||(l=new Map,u.set(s,l));if(l.has(t))return l;for(l.set(t,null),s=s.getElementsByTagName(t),u=0;u<s.length;u++){var d=s[u];if(!(d[Ot]||d[F]||t==="link"&&d.getAttribute("rel")==="stylesheet")&&d.namespaceURI!=="http://www.w3.org/2000/svg"){var x=d.getAttribute(n)||"";x=t+x;var T=l.get(x);T?T.push(d):l.set(x,[d])}}return l}function Gh(t,n,s){t=t.ownerDocument||t,t.head.insertBefore(s,n==="title"?t.querySelector("head > title"):null)}function _b(t,n,s){if(s===1||n.itemProp!=null)return!1;switch(t){case"meta":case"title":return!0;case"style":if(typeof n.precedence!="string"||typeof n.href!="string"||n.href==="")break;return!0;case"link":if(typeof n.rel!="string"||typeof n.href!="string"||n.href===""||n.onLoad||n.onError)break;return n.rel==="stylesheet"?(t=n.disabled,typeof n.precedence=="string"&&t==null):!0;case"script":if(n.async&&typeof n.async!="function"&&typeof n.async!="symbol"&&!n.onLoad&&!n.onError&&n.src&&typeof n.src=="string")return!0}return!1}function Wh(t){return!(t.type==="stylesheet"&&(t.state.loading&3)===0)}function Mb(t,n,s,l){if(s.type==="stylesheet"&&(typeof l.media!="string"||matchMedia(l.media).matches!==!1)&&(s.state.loading&4)===0){if(s.instance===null){var u=Lo(l.href),d=n.querySelector(Il(u));if(d){n=d._p,n!==null&&typeof n=="object"&&typeof n.then=="function"&&(t.count++,t=fc.bind(t),n.then(t,t)),s.state.loading|=4,s.instance=d,Ct(d);return}d=n.ownerDocument||n,l=Yh(l),(u=Li.get(u))&&Pd(l,u),d=d.createElement("link"),Ct(d);var x=d;x._p=new Promise(function(T,L){x.onload=T,x.onerror=L}),Rn(d,"link",l),s.instance=d}t.stylesheets===null&&(t.stylesheets=new Map),t.stylesheets.set(s,n),(n=s.state.preload)&&(s.state.loading&3)===0&&(t.count++,s=fc.bind(t),n.addEventListener("load",s),n.addEventListener("error",s))}}var qd=0;function Ob(t,n){return t.stylesheets&&t.count===0&&pc(t,t.stylesheets),0<t.count||0<t.imgCount?function(s){var l=setTimeout(function(){if(t.stylesheets&&pc(t,t.stylesheets),t.unsuspend){var d=t.unsuspend;t.unsuspend=null,d()}},6e4+n);0<t.imgBytes&&qd===0&&(qd=62500*rb());var u=setTimeout(function(){if(t.waitingForImages=!1,t.count===0&&(t.stylesheets&&pc(t,t.stylesheets),t.unsuspend)){var d=t.unsuspend;t.unsuspend=null,d()}},(t.imgBytes>qd?50:800)+n);return t.unsuspend=s,function(){t.unsuspend=null,clearTimeout(l),clearTimeout(u)}}:null}function fc(){if(this.count--,this.count===0&&(this.imgCount===0||!this.waitingForImages)){if(this.stylesheets)pc(this,this.stylesheets);else if(this.unsuspend){var t=this.unsuspend;this.unsuspend=null,t()}}}var mc=null;function pc(t,n){t.stylesheets=null,t.unsuspend!==null&&(t.count++,mc=new Map,n.forEach(Cb,t),mc=null,fc.call(t))}function Cb(t,n){if(!(n.state.loading&4)){var s=mc.get(t);if(s)var l=s.get(null);else{s=new Map,mc.set(t,s);for(var u=t.querySelectorAll("link[data-precedence],style[data-precedence]"),d=0;d<u.length;d++){var x=u[d];(x.nodeName==="LINK"||x.getAttribute("media")!=="not all")&&(s.set(x.dataset.precedence,x),l=x)}l&&s.set(null,l)}u=n.instance,x=u.getAttribute("data-precedence"),d=s.get(x)||l,d===l&&s.set(null,u),s.set(x,u),this.count++,l=fc.bind(this),u.addEventListener("load",l),u.addEventListener("error",l),d?d.parentNode.insertBefore(u,d.nextSibling):(t=t.nodeType===9?t.head:t,t.insertBefore(u,t.firstChild)),n.state.loading|=4}}var jl={$$typeof:M,Provider:null,Consumer:null,_currentValue:ae,_currentValue2:ae,_threadCount:0};function Nb(t,n,s,l,u,d,x,T,L){this.tag=1,this.containerInfo=t,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=jt(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=jt(0),this.hiddenUpdates=jt(null),this.identifierPrefix=l,this.onUncaughtError=u,this.onCaughtError=d,this.onRecoverableError=x,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=L,this.incompleteTransitions=new Map}function Xh(t,n,s,l,u,d,x,T,L,U,Q,ie){return t=new Nb(t,n,s,x,L,U,Q,ie,T),n=1,d===!0&&(n|=24),d=ci(3,null,null,n),t.current=d,d.stateNode=t,n=vu(),n.refCount++,t.pooledCache=n,n.refCount++,d.memoizedState={element:l,isDehydrated:s,cache:n},Eu(d),t}function Qh(t){return t?(t=uo,t):uo}function Jh(t,n,s,l,u,d){u=Qh(u),l.context===null?l.context=u:l.pendingContext=u,l=Ys(n),l.payload={element:s},d=d===void 0?null:d,d!==null&&(l.callback=d),s=Fs(t,l,n),s!==null&&(ni(s,t,n),pl(s,t,n))}function Zh(t,n){if(t=t.memoizedState,t!==null&&t.dehydrated!==null){var s=t.retryLane;t.retryLane=s!==0&&s<n?s:n}}function zd(t,n){Zh(t,n),(t=t.alternate)&&Zh(t,n)}function eg(t){if(t.tag===13||t.tag===31){var n=Oa(t,67108864);n!==null&&ni(n,t,67108864),zd(t,67108864)}}function tg(t){if(t.tag===13||t.tag===31){var n=pi();n=Ls(n);var s=Oa(t,n);s!==null&&ni(s,t,n),zd(t,n)}}var hc=!0;function Rb(t,n,s,l){var u=H.T;H.T=null;var d=ee.p;try{ee.p=2,$d(t,n,s,l)}finally{ee.p=d,H.T=u}}function kb(t,n,s,l){var u=H.T;H.T=null;var d=ee.p;try{ee.p=8,$d(t,n,s,l)}finally{ee.p=d,H.T=u}}function $d(t,n,s,l){if(hc){var u=Vd(l);if(u===null)Cd(t,n,l,gc,s),ig(t,l);else if(Ib(u,t,n,s,l))l.stopPropagation();else if(ig(t,l),n&4&&-1<Lb.indexOf(t)){for(;u!==null;){var d=rt(u);if(d!==null)switch(d.tag){case 3:if(d=d.stateNode,d.current.memoizedState.isDehydrated){var x=En(d.pendingLanes);if(x!==0){var T=d;for(T.pendingLanes|=2,T.entangledLanes|=2;x;){var L=1<<31-Ut(x);T.entanglements[1]|=L,x&=~L}ns(d),(at&6)===0&&(Jr=At()+500,Nl(0))}}break;case 31:case 13:T=Oa(d,2),T!==null&&ni(T,d,2),ec(),zd(d,2)}if(d=Vd(l),d===null&&Cd(t,n,l,gc,s),d===u)break;u=d}u!==null&&l.stopPropagation()}else Cd(t,n,l,null,s)}}function Vd(t){return t=Go(t),Yd(t)}var gc=null;function Yd(t){if(gc=null,t=Ye(t),t!==null){var n=r(t);if(n===null)t=null;else{var s=n.tag;if(s===13){if(t=f(n),t!==null)return t;t=null}else if(s===31){if(t=h(n),t!==null)return t;t=null}else if(s===3){if(n.stateNode.current.memoizedState.isDehydrated)return n.tag===3?n.stateNode.containerInfo:null;t=null}else n!==t&&(t=null)}}return gc=t,null}function ng(t){switch(t){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(Vn()){case bi:return 2;case ht:return 8;case Bt:case Yn:return 32;case $t:return 268435456;default:return 32}default:return 32}}var Fd=!1,ia=null,sa=null,aa=null,Dl=new Map,Hl=new Map,oa=[],Lb="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function ig(t,n){switch(t){case"focusin":case"focusout":ia=null;break;case"dragenter":case"dragleave":sa=null;break;case"mouseover":case"mouseout":aa=null;break;case"pointerover":case"pointerout":Dl.delete(n.pointerId);break;case"gotpointercapture":case"lostpointercapture":Hl.delete(n.pointerId)}}function Pl(t,n,s,l,u,d){return t===null||t.nativeEvent!==d?(t={blockedOn:n,domEventName:s,eventSystemFlags:l,nativeEvent:d,targetContainers:[u]},n!==null&&(n=rt(n),n!==null&&eg(n)),t):(t.eventSystemFlags|=l,n=t.targetContainers,u!==null&&n.indexOf(u)===-1&&n.push(u),t)}function Ib(t,n,s,l,u){switch(n){case"focusin":return ia=Pl(ia,t,n,s,l,u),!0;case"dragenter":return sa=Pl(sa,t,n,s,l,u),!0;case"mouseover":return aa=Pl(aa,t,n,s,l,u),!0;case"pointerover":var d=u.pointerId;return Dl.set(d,Pl(Dl.get(d)||null,t,n,s,l,u)),!0;case"gotpointercapture":return d=u.pointerId,Hl.set(d,Pl(Hl.get(d)||null,t,n,s,l,u)),!0}return!1}function sg(t){var n=Ye(t.target);if(n!==null){var s=r(n);if(s!==null){if(n=s.tag,n===13){if(n=f(s),n!==null){t.blockedOn=n,Si(t.priority,function(){tg(s)});return}}else if(n===31){if(n=h(s),n!==null){t.blockedOn=n,Si(t.priority,function(){tg(s)});return}}else if(n===3&&s.stateNode.current.memoizedState.isDehydrated){t.blockedOn=s.tag===3?s.stateNode.containerInfo:null;return}}}t.blockedOn=null}function yc(t){if(t.blockedOn!==null)return!1;for(var n=t.targetContainers;0<n.length;){var s=Vd(t.nativeEvent);if(s===null){s=t.nativeEvent;var l=new s.constructor(s.type,s);Ko=l,s.target.dispatchEvent(l),Ko=null}else return n=rt(s),n!==null&&eg(n),t.blockedOn=s,!1;n.shift()}return!0}function ag(t,n,s){yc(t)&&s.delete(n)}function Bb(){Fd=!1,ia!==null&&yc(ia)&&(ia=null),sa!==null&&yc(sa)&&(sa=null),aa!==null&&yc(aa)&&(aa=null),Dl.forEach(ag),Hl.forEach(ag)}function bc(t,n){t.blockedOn===n&&(t.blockedOn=null,Fd||(Fd=!0,e.unstable_scheduleCallback(e.unstable_NormalPriority,Bb)))}var xc=null;function og(t){xc!==t&&(xc=t,e.unstable_scheduleCallback(e.unstable_NormalPriority,function(){xc===t&&(xc=null);for(var n=0;n<t.length;n+=3){var s=t[n],l=t[n+1],u=t[n+2];if(typeof l!="function"){if(Yd(l||s)===null)continue;break}var d=rt(s);d!==null&&(t.splice(n,3),n-=3,Vu(d,{pending:!0,data:u,method:s.method,action:l},l,u))}}))}function Bo(t){function n(L){return bc(L,t)}ia!==null&&bc(ia,t),sa!==null&&bc(sa,t),aa!==null&&bc(aa,t),Dl.forEach(n),Hl.forEach(n);for(var s=0;s<oa.length;s++){var l=oa[s];l.blockedOn===t&&(l.blockedOn=null)}for(;0<oa.length&&(s=oa[0],s.blockedOn===null);)sg(s),s.blockedOn===null&&oa.shift();if(s=(t.ownerDocument||t).$$reactFormReplay,s!=null)for(l=0;l<s.length;l+=3){var u=s[l],d=s[l+1],x=u[te]||null;if(typeof d=="function")x||og(s);else if(x){var T=null;if(d&&d.hasAttribute("formAction")){if(u=d,x=d[te]||null)T=x.formAction;else if(Yd(u)!==null)continue}else T=x.action;typeof T=="function"?s[l+1]=T:(s.splice(l,3),l-=3),og(s)}}}function lg(){function t(d){d.canIntercept&&d.info==="react-transition"&&d.intercept({handler:function(){return new Promise(function(x){return u=x})},focusReset:"manual",scroll:"manual"})}function n(){u!==null&&(u(),u=null),l||setTimeout(s,20)}function s(){if(!l&&!navigation.transition){var d=navigation.currentEntry;d&&d.url!=null&&navigation.navigate(d.url,{state:d.getState(),info:"react-transition",history:"replace"})}}if(typeof navigation=="object"){var l=!1,u=null;return navigation.addEventListener("navigate",t),navigation.addEventListener("navigatesuccess",n),navigation.addEventListener("navigateerror",n),setTimeout(s,100),function(){l=!0,navigation.removeEventListener("navigate",t),navigation.removeEventListener("navigatesuccess",n),navigation.removeEventListener("navigateerror",n),u!==null&&(u(),u=null)}}}function Kd(t){this._internalRoot=t}vc.prototype.render=Kd.prototype.render=function(t){var n=this._internalRoot;if(n===null)throw Error(o(409));var s=n.current,l=pi();Jh(s,l,t,n,null,null)},vc.prototype.unmount=Kd.prototype.unmount=function(){var t=this._internalRoot;if(t!==null){this._internalRoot=null;var n=t.containerInfo;Jh(t.current,2,null,t,null,null),ec(),n[de]=null}};function vc(t){this._internalRoot=t}vc.prototype.unstable_scheduleHydration=function(t){if(t){var n=nn();t={blockedOn:null,target:t,priority:n};for(var s=0;s<oa.length&&n!==0&&n<oa[s].priority;s++);oa.splice(s,0,t),s===0&&sg(t)}};var rg=i.version;if(rg!=="19.2.3")throw Error(o(527,rg,"19.2.3"));ee.findDOMNode=function(t){var n=t._reactInternals;if(n===void 0)throw typeof t.render=="function"?Error(o(188)):(t=Object.keys(t).join(","),Error(o(268,t)));return t=y(n),t=t!==null?A(t):null,t=t===null?null:t.stateNode,t};var jb={bundleType:0,version:"19.2.3",rendererPackageName:"react-dom",currentDispatcherRef:H,reconcilerVersion:"19.2.3"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Sc=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Sc.isDisabled&&Sc.supportsFiber)try{In=Sc.inject(jb),Xt=Sc}catch{}}return ql.createRoot=function(t,n){if(!c(t))throw Error(o(299));var s=!1,l="",u=hp,d=gp,x=yp;return n!=null&&(n.unstable_strictMode===!0&&(s=!0),n.identifierPrefix!==void 0&&(l=n.identifierPrefix),n.onUncaughtError!==void 0&&(u=n.onUncaughtError),n.onCaughtError!==void 0&&(d=n.onCaughtError),n.onRecoverableError!==void 0&&(x=n.onRecoverableError)),n=Xh(t,1,!1,null,null,s,l,null,u,d,x,lg),t[de]=n.current,Od(t),new Kd(n)},ql.hydrateRoot=function(t,n,s){if(!c(t))throw Error(o(299));var l=!1,u="",d=hp,x=gp,T=yp,L=null;return s!=null&&(s.unstable_strictMode===!0&&(l=!0),s.identifierPrefix!==void 0&&(u=s.identifierPrefix),s.onUncaughtError!==void 0&&(d=s.onUncaughtError),s.onCaughtError!==void 0&&(x=s.onCaughtError),s.onRecoverableError!==void 0&&(T=s.onRecoverableError),s.formState!==void 0&&(L=s.formState)),n=Xh(t,1,!0,n,s??null,l,u,L,d,x,T,lg),n.context=Qh(null),s=n.current,l=pi(),l=Ls(l),u=Ys(l),u.callback=null,Fs(s,u,l),s=l,n.current.lanes=s,tn(n,s),ns(n),t[de]=n.current,Od(t),new vc(n)},ql.version="19.2.3",ql}var bg;function Kb(){if(bg)return Xd.exports;bg=1;function e(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(i){console.error(i)}}return e(),Xd.exports=Fb(),Xd.exports}var Gb=Kb();const Gn=(e,i)=>({q:e,r:i,s:-e-i}),Wb=e=>`${e.q},${e.r}`,he=Wb,ne=(e,i)=>e.q===i.q&&e.r===i.r&&e.s===i.s,Wn=(e,i)=>Gn(e.q+i.q,e.r+i.r),xf=(e,i)=>Gn(e.q-i.q,e.r-i.r),Ce=(e,i)=>(Math.abs(e.q-i.q)+Math.abs(e.r-i.r)+Math.abs(e.s-i.s))/2,ut=(e,i)=>{const a=i*(1.5*e.q),o=i*Math.sqrt(3)*(e.r+e.q/2);return{x:a,y:o}},xg=e=>({q:e.q,r:e.r,s:e.s??-e.q-e.r}),Xb=e=>Gn(e.q,e.r),Qb=e=>{let i=Math.round(e.q),a=Math.round(e.r),o=Math.round(e.s);const c=Math.abs(i-e.q),r=Math.abs(a-e.r),f=Math.abs(o-e.s);return c>r&&c>f?i=-a-o:r>f?a=-i-o:o=-i-a,{q:i,r:a,s:o}},ar=[Gn(1,0),Gn(1,-1),Gn(0,-1),Gn(-1,0),Gn(-1,1),Gn(0,1)],ot=e=>ar.map(i=>Wn(e,i)),Un=e=>ar[(e%6+6)%6],ef=(e,i,a)=>e+(i-e)*a,Pt=(e,i)=>{const a=Ce(e,i),o=[],c=xg(e),r=xg(i);for(let f=0;f<=a;f++){const h=a===0?0:f/a,b={q:ef(c.q+1e-6,r.q+1e-6,h),r:ef(c.r+1e-6,r.r+1e-6,h),s:ef(c.s+1e-6,r.s+1e-6,h)};o.push(Xb(Qb(b)))}return o},fa=(e,i)=>{const a=Ce(e,i);if(a===0)return-1;const o=xf(i,e),c=o.q/a,r=o.r/a,f=(0-o.q-o.r)/a;return ar.findIndex(h=>Math.abs(h.q-c)<.01&&Math.abs(h.r-r)<.01&&Math.abs(h.s-f)<.01)};function If(e,i){const a=Un(e);return{q:a.q*i,r:a.r*i,s:-(a.q*i)-a.r*i}}const Vc=(e,i,a,o)=>{if(e<0||e>=a||i<0||i>=o)return!1;const c=e+i,r=Math.floor(a/2),f=a-1+(o-1)-r;return c>=r&&c<=f},Jb=(e,i)=>{const a=[];for(let o=0;o<e;o++)for(let c=0;c<i;c++)Vc(o,c,e,i)&&a.push(Gn(o,c));return a},pa=(e,i,a)=>Vc(e.q,e.r,i,a),Zb=e=>{let i=2166136261;for(let a=0;a<e.length;a++)i^=e.charCodeAt(a),i=Math.imul(i,16777619)>>>0;return i>>>0},ex=e=>function(){let i=(e+=1831565813)>>>0;return i=Math.imul(i^i>>>15,i|1)>>>0,i^=i+Math.imul(i^i>>>7,i|61)>>>0,((i^i>>>14)>>>0)/4294967296},Gc=e=>{const i=typeof e=="number"?e>>>0:Zb(String(e)),a=ex(i||1);return{next:()=>a(),id:(o=9)=>{const c="abcdefghijklmnopqrstuvwxyz0123456789";let r="";for(let f=0;f<o;f++){const h=Math.floor(a()*c.length)%c.length;r+=c[h]}return r}}},Po=(e,i,a=9,o="")=>{const c=`${e}:${i}:${o}`,r=Gc(c),f="abcdefghijklmnopqrstuvwxyz0123456789";let h="";for(let b=0;b<a;b++){const y=Math.floor(r.next()*f.length)%f.length;h+=f[y]}return h},Yc=(e,i)=>{const a=`${e}:${i}`;return Gc(a).next()},Fa=e=>{const i=e.rngSeed||"default",a=e.rngCounter||0;return{value:Yc(i,a),nextState:{...e,rngCounter:a+1}}};function Ns(e){return e.statusEffects?.some(i=>i.type==="stunned")??!1}function tx(e){return e.statusEffects?.some(i=>i.type==="rooted")??!1}function vg(e,i=1){if(!e.statusEffects||e.statusEffects.length===0)return e;const a=e.statusEffects.map(o=>({...o,duration:o.duration-i})).filter(o=>o.duration>0);return{...e,statusEffects:a}}const Ho={GRASS:{id:"GRASS",name:"Grass",description:"Soft grass",defaultTraits:new Set(["WALKABLE","FLAMMABLE"]),visual:{color:"#4a7c59",icon:""}},STONE:{id:"STONE",name:"Stone Floor",description:"Hard stone",defaultTraits:new Set(["WALKABLE"]),visual:{color:"#808080",icon:""}},LAVA:{id:"LAVA",name:"Lava",description:"Molten lava",defaultTraits:new Set(["LIQUID","HAZARDOUS"]),visual:{color:"#ff4400",icon:""}},WALL:{id:"WALL",name:"Wall",description:"Solid wall",defaultTraits:new Set(["BLOCKS_LOS","BLOCKS_MOVEMENT","ANCHOR"]),visual:{color:"#333333",icon:""}},ICE:{id:"ICE",name:"Ice",description:"Slippery ice",defaultTraits:new Set(["WALKABLE","SLIPPERY"]),visual:{color:"#aaddff",icon:""}},VOID:{id:"VOID",name:"Void",description:"The endless void",defaultTraits:new Set(["HAZARDOUS"]),visual:{color:"#000000",icon:""}},STAIRS:{id:"STAIRS",name:"Stairs",description:"Lead to the next floor",defaultTraits:new Set(["WALKABLE"]),visual:{color:"#ffffff",icon:""}},SHRINE:{id:"SHRINE",name:"Shrine",description:"A place of power",defaultTraits:new Set(["WALKABLE","ANCHOR"]),visual:{color:"#ffd700",icon:""}},GATE:{id:"GATE",name:"Gate",description:"A heavy gate",defaultTraits:new Set(["BLOCKS_MOVEMENT","BLOCKS_LOS"]),visual:{color:"#444444",icon:""}},BRIDGE:{id:"BRIDGE",name:"Bridge",description:"Crossing the gap",defaultTraits:new Set(["WALKABLE"]),visual:{color:"#8b4513",icon:""}}},Ac={FIRE:{id:"FIRE",name:"Fire",description:"Burning flames",onStay:e=>({effects:[{type:"Damage",target:e.actor.id,amount:1,reason:"fire_damage"}],messages:[`${e.actor.subtype||e.actor.type} burns!`]}),interactsWith:{WET:e=>({effects:[{type:"Juice",effect:"flash",target:e.tile.position,color:"#aaaaaa"}],messages:["Steam rises!"],modifyTile:{effects:e.tile.effects.filter(i=>i.id!=="FIRE"&&i.id!=="WET"&&i.id!=="STEAM").concat({id:"STEAM",duration:2,potency:1})}})}},WET:{id:"WET",name:"Wet",description:"Soaked with water",onApply:e=>e.tile.effects.some(a=>a.id==="FIRE")?{effects:[],messages:["Water extinguishes the flames!"],modifyTile:{effects:e.tile.effects.filter(a=>a.id!=="FIRE")}}:{effects:[],messages:[]}},OIL:{id:"OIL",name:"Oil",description:"Slippery oil",interactsWith:{FIRE:e=>({effects:[{type:"Damage",target:"area",amount:3,reason:"oil_explosion"},{type:"Juice",effect:"explosion_ring",target:e.tile.position}],messages:["Oil explodes!"],modifyTile:{effects:e.tile.effects.filter(i=>i.id!=="OIL")}})}},STEAM:{id:"STEAM",name:"Steam",description:"Obscuring steam cloud"},BLESSED:{id:"BLESSED",name:"Blessed",description:"Holy ground"},CURSED:{id:"CURSED",name:"Cursed",description:"Unholy ground"},ICE_WALL:{id:"ICE_WALL",name:"Ice Wall",description:"A wall of ice"},SMOKE:{id:"SMOKE",name:"Smoke",description:"Thick smoke"},BOMB_TICK:{id:"BOMB_TICK",name:"Bomb Tick",description:"About to explode"},TRI_TRAP:{id:"TRI_TRAP",name:"Kinetic Trap",description:"Hidden trap that flings non-flying units outward"},SNARE:{id:"SNARE",name:"Snare",description:"Entangling roots that halt movement and root the target.",onPass:e=>e.actor.isFlying?{effects:[],messages:[]}:{effects:[{type:"ApplyStatus",target:e.actor.id,status:"rooted",duration:2}],messages:["Snared! Movement halted."],interrupt:!0,newMomentum:0}}},qe={getTileAt(e,i){const a=he(i);let o;return e.tiles&&(e.tiles instanceof Map?o=e.tiles.get(a):Array.isArray(e.tiles)?o=e.tiles.find(c=>Array.isArray(c)&&c[0]===a||c.position&&ne(c.position,i)):o=e.tiles[a]),o||{position:i,baseId:"STONE",traits:new Set(["WALKABLE"]),effects:[]}},getTraitsForTile(e,i){const a=new Set,o=i.position;return pa(o,e.gridWidth,e.gridHeight)?(i.baseId==="LAVA"&&(a.add("HAZARDOUS"),a.add("LIQUID"),a.add("LAVA")),i.baseId==="WALL"&&(a.add("BLOCKS_MOVEMENT"),a.add("BLOCKS_LOS"),a.add("ANCHOR")),i.traits.forEach(r=>a.add(r)),i.effects.forEach(r=>{r.id==="FIRE"&&(a.add("FIRE"),a.add("HAZARDOUS")),r.id==="ICE_WALL"&&(a.add("BLOCKS_MOVEMENT"),a.add("BLOCKS_LOS"),a.add("ANCHOR")),r.id==="SMOKE"&&a.add("BLOCKS_LOS")}),a):(a.add("BLOCKS_MOVEMENT"),a.add("BLOCKS_LOS"),a.add("ANCHOR"),a)},getTraitsAt(e,i){const a=this.getTileAt(e,i);return this.getTraitsForTile(e,a)},isPassable(e,i){const a=this.getTraitsAt(e,i);return!a.has("BLOCKS_MOVEMENT")&&!a.has("HAZARDOUS")},isWalkable(e,i){return!this.getTraitsAt(e,i).has("BLOCKS_MOVEMENT")},isLosBlocking(e,i){return this.getTraitsAt(e,i).has("BLOCKS_LOS")},isAnchorable(e,i){return this.getTraitsAt(e,i).has("ANCHOR")},hasTrait(e,i,a){return this.getTraitsAt(e,i).has(a)}};class Va{static hasFireProtection(i){return i.statusEffects.some(a=>a.type==="fire_immunity")||i.activeSkills?.some(a=>a.id==="ABSORB_FIRE")||!1}static isFireHazard(i,a){return i.baseId==="LAVA"||a.has("LAVA")||a.has("FIRE")}static mergeResults(i,a){i.effects.push(...a.effects),i.messages.push(...a.messages),a.newMomentum!==void 0&&(i.newMomentum=a.newMomentum),a.interrupt&&(i.interrupt=!0),a.modifyTile&&(i.modifyTile={...i.modifyTile,...a.modifyTile})}static processEntry(i,a,o){const c={effects:[],messages:[],interrupt:!1},r={tile:a,actor:i,state:o,isFinalDestination:!0,source:i.previousPosition},f=qe.getTraitsForTile(o,a);f.has("HAZARDOUS")&&!i.isFlying&&(this.isFireHazard(a,f)&&this.hasFireProtection(i)||(a.baseId==="LAVA"||f.has("LAVA")?this.mergeResults(c,{effects:[{type:"Damage",target:i.id,amount:99,reason:"lava_sink"},{type:"Juice",effect:"lavaSink",target:i.position}],messages:["Lava Sink! You were engulfed by lava!"],interrupt:!0}):(a.baseId==="VOID"||f.has("VOID"))&&this.mergeResults(c,{effects:[{type:"Damage",target:i.id,amount:99,reason:"void_sink"},{type:"Juice",effect:"lavaSink",target:i.position}],messages:["Void consumes your soul!"],interrupt:!0})));for(const h of a.effects){const b=Ac[h.id];if(!b?.onEnter)continue;const y=b.onEnter(r);if(this.mergeResults(c,y),c.interrupt)break}return c.messages.length===0&&c.effects.some(h=>h.type==="LavaSink")&&c.messages.push("Lava Sink! You were engulfed by lava!"),c}static processTransition(i,a,o,c,r={}){const{ignoreActors:f=!1,ignoreGroundHazards:h=!1}=r,b={effects:[],messages:[],newMomentum:c!==void 0?Math.max(0,c-1):void 0,interrupt:!1},y=qe.getTraitsForTile(o,a);if(y.has("BLOCKS_MOVEMENT")||!f&&(o.enemies.find(S=>S.id!==i.id&&S.hp>0&&ne(S.position,a.position))||(i.id!==o.player.id&&ne(o.player.position,a.position)?o.player:void 0)))return b.interrupt=!0,b.newMomentum=0,b;const A={tile:a,actor:i,state:o,momentum:c,isFinalDestination:!1,source:i.previousPosition};y.has("HAZARDOUS")&&!i.isFlying&&!h?this.isFireHazard(a,y)&&this.hasFireProtection(i)?this.mergeResults(b,{effects:[{type:"Damage",target:i.id,amount:99,reason:"hazard_intercept"}],messages:["Flames surge through you."],interrupt:!1}):this.mergeResults(b,{effects:[{type:"Damage",target:i.id,amount:99,reason:"hazard_intercept"},{type:"Juice",effect:"lavaSink",target:a.position}],messages:[a.baseId==="LAVA"||y.has("LAVA")?"Sunk in Lava!":"Consumed by Void!"],interrupt:!0}):y.has("SLIPPERY")?b.newMomentum=Math.max(1,c||0):y.has("LIQUID")&&c!==void 0&&c>0&&(b.newMomentum=Math.max(0,c-1));for(const v of a.effects){const S=Ac[v.id];if(!S?.onPass)continue;const _=S.onPass(A);if(this.mergeResults(b,_),b.interrupt)break}if(!b.interrupt&&!i.isFlying&&!h&&o.traps){const v=o.traps.find(S=>ne(S.position,a.position)&&S.cooldown===0&&S.ownerId!==i.id);if(v){const S=a.position.q-v.position.q||1,_=a.position.r-v.position.r||0;let p=0;S>0&&_===0?p=0:S>0&&_<0?p=1:S===0&&_<0?p=2:S<0&&_===0?p=3:S<0&&_>0?p=4:p=5;const g=3;let R=a.position;const C=(M=>[{q:1,r:0,s:-1},{q:1,r:-1,s:0},{q:0,r:-1,s:1},{q:-1,r:0,s:1},{q:-1,r:1,s:0},{q:0,r:1,s:-1}][M%6])(p);for(let M=0;M<g;M++){const N={q:R.q+C.q,r:R.r+C.r,s:R.s+C.s};if(!qe.isWalkable(o,N))break;R=N}if(this.mergeResults(b,{effects:[{type:"SetTrapCooldown",position:v.position,ownerId:v.ownerId,cooldown:v.resetCooldown??2},{type:"Displacement",target:i.id,destination:R,source:a.position,isFling:!0},{type:"Juice",effect:"kineticWave",target:a.position,intensity:"high"},{type:"Juice",effect:"combat_text",target:a.position,text:"TRAP!"}],messages:[`${i.subtype||"Unit"} triggered a kinetic trap!`],interrupt:!0}),v.volatileCore&&this.mergeResults(b,{effects:[{type:"Damage",target:i.id,amount:1,reason:"trap_volatile_core"}],messages:["Volatile core detonates!"]}),v.chainReaction&&o.traps){const M=o.traps.filter(N=>N.ownerId===v.ownerId&&N.cooldown===0&&!ne(N.position,v.position)&&ot(v.position).some(Y=>ne(Y,N.position)));for(const N of M)this.mergeResults(b,{effects:[{type:"SetTrapCooldown",position:N.position,ownerId:N.ownerId,cooldown:N.resetCooldown??2}],messages:["Chain reaction sparks nearby traps!"]}),N.volatileCore&&this.mergeResults(b,{effects:[{type:"Damage",target:i.id,amount:1,reason:"trap_chain_volatile"}],messages:["Chain blast!"]})}}}return b}static processStay(i,a,o){const c={effects:[],messages:[]},r={tile:a,actor:i,state:o,isFinalDestination:!1},f=qe.getTraitsForTile(o,a);if((a.baseId==="LAVA"||f.has("LAVA"))&&!i.isFlying&&!i.statusEffects.some(h=>h.type==="fire_immunity")){const h=i.id==="player";this.mergeResults(c,{effects:[{type:"Damage",target:i.id,amount:h?1:99,reason:"lava_tick"}],messages:["Lava Sink! You were engulfed by lava!"]})}for(const h of a.effects){const b=Ac[h.id];if(!b?.onStay)continue;const y=b.onStay(r);this.mergeResults(c,y)}return c}static applyEffect(i,a,o,c,r,f){const h=Ac[a];if(!h)return{effects:[],messages:[]};const b={effects:[],messages:[]};for(const y of i.effects){const A=h.interactsWith?.[y.id];if(A){const v=A({tile:i,state:r,potency:c,sourceId:f});return this.mergeResults(b,v),b}}if(h.onApply){const y=h.onApply({tile:i,state:r,potency:c,sourceId:f});this.mergeResults(b,y)}return b.modifyTile?.effects?b.modifyTile&&(i.effects=b.modifyTile.effects):i.effects.push({id:a,duration:o,potency:c,sourceId:f}),b}static processPath(i,a,o,c,r={}){let f=i.position,h=c,b={effects:[],messages:[],newMomentum:c,interrupt:!1};for(const y of a){const A=qe.getTileAt(o,y),v=qe.getTraitsForTile(o,A),S=this.processTransition(i,A,o,h,r);if(S.interrupt&&v.has("BLOCKS_MOVEMENT")){b.interrupt=!0;break}if(f=y,this.mergeResults(b,S),b.interrupt){b.interrupt=!0;break}if(h=b.newMomentum,h!==void 0&&h<=0)break}return{lastValidPos:f,result:b,interrupt:!!b.interrupt}}static getMovementCost(i,a){const o=qe.getTraitsForTile(i,a);let c=1;return o.has("HAZARDOUS")&&(c+=5),o.has("LIQUID")&&(c+=1),o.has("FIRE")&&(c+=2),c}}const nx=(e,i)=>Array(i).fill(0n),tf=(e,i,a)=>{if(!Number.isInteger(i.q)||!Number.isInteger(i.r))return[...e];if(i.r<0||i.r>=e.length||i.q<0)return[...e];const o=[...e];return o[i.r]|=1n<<BigInt(i.q),o},vf=(e,i)=>i.r<0||i.r>=e.length?!0:(e[i.r]&1n<<BigInt(i.q))!==0n,Sg=(e,i)=>{if(i.playerStart&&ne(e,i.playerStart)||i.stairsPosition&&ne(e,i.stairsPosition)||i.shrinePosition&&ne(e,i.shrinePosition))return!0;if(i.tiles){const a=qe.getTraitsAt(i,e);if(a.has("HAZARDOUS")||a.has("BLOCKS_MOVEMENT"))return!0}return!1},Yi=(e,i)=>{if(e)return e.find(a=>a&&a.position&&ne(a.position,i))},Ee=(e,i)=>ne(e.player.position,i)?e.player:Yi(e.enemies,i),ix=(e,i)=>!!e.shrinePosition&&ne(i,e.shrinePosition),sx=(e,i)=>!(!ne(i,e.stairsPosition)||e.enemies.some(o=>o.subtype==="sentinel"&&o.hp>0)),ax=(e,i,a,o)=>{const c=Ce(a,o);if(c===0)return[];const r=(o.q-a.q)/c,f=(o.r-a.r)/c,h=(o.s-a.s)/c,b=[],y=new Set,A=2;for(let v=1;v<=A;v++){const S={q:o.q+Math.round(r*v),r:o.r+Math.round(f*v),s:o.s+Math.round(h*v)};if(pa(S,e.gridWidth,e.gridHeight)){const _=`${S.q},${S.r}`;y.has(_)||(y.add(_),b.push(S))}}return b},tt={getNeighbors(e){return ot(e)},isTileBlocked(e,i){return!e.occupancyMask||e.occupancyMask.length===0?!1:vf(e.occupancyMask,i)},refreshOccupancyMask(e){let i=nx(e.gridWidth,e.gridHeight);return e.tiles?.forEach(a=>{(a.baseId==="WALL"||a.traits?.has("BLOCKS_MOVEMENT"))&&(i=tf(i,a.position))}),e.player&&(i=tf(i,e.player.position)),e.enemies?.forEach(a=>{i=tf(i,a.position)}),i},getMovementRange(e,i,a){const o=new Map,c=[],r=b=>`${b.q},${b.r}`,f=Ee(e,i),h=[{p:i,cost:0}];for(o.set(r(i),0);h.length;){const b=h.shift();if(!(b.cost>=a))for(const y of this.getNeighbors(b.p)){if(!this.isWithinBounds(e,y)||!qe.isWalkable(e,y))continue;const A=Ee(e,y),v=A&&!ne(y,i),S=v&&f&&A.factionId===f.factionId;if(v&&!S)continue;const _=r(y),p=b.cost+1;(!o.has(_)||o.get(_)>p)&&(o.set(_,p),S||c.push(y),h.push({p:y,cost:p}))}}return c},getAxialTargets(e,i,a,o={}){const{includeWalls:c=!1,includeActors:r=!0,stopAtObstacles:f=!0}=o,h=[];for(let b=0;b<6;b++)for(let y=1;y<=a;y++){const A=Wn(i,If(b,y));if(!this.isWithinBounds(e,A))break;const S=qe.getTileAt(e,A)?.baseId==="WALL",_=Ee(e,A);if(S){if(c&&h.push(A),f)break}else if(_){if(r&&h.push(A),f)break}else h.push(A)}return h},getAreaTargets(e,i,a){const o=[];for(let c=-a;c<=a;c++)for(let r=Math.max(-a,-c-a);r<=Math.min(a,-c+a);r++){const f=Wn(i,Gn(c,r));this.isWithinBounds(e,f)&&o.push(f)}return o},isWithinBounds(e,i){return pa(i,e.gridWidth,e.gridHeight)},getAxialTargetsWithOptions(e,i,a,o){return this.getAxialTargets(e,i,a,o)}},Ag=(e,i)=>{const a=i.q-e.q,o=i.r-e.r;return a>0&&o===0?0:a>0&&o<0?1:a===0&&o<0?2:a<0&&o===0?3:a<0&&o>0?4:5},gi=(e,i,a,o=[],c)=>{if(tx(e))return{position:e.position,state:a};const r=tt.getNeighbors(e.position);let f=[],h=c!==void 0?Math.abs(Ce(e.position,i)-c):Ce(e.position,i);for(const v of r){if(!tt.isWithinBounds(a,v))continue;const S=a.tiles.get(he(v)),_=S?.traits.has("BLOCKS_LOS")||S?.baseId==="WALL",p=o.some(C=>ne(C,v))||a.enemies.some(C=>C.id!==e.id&&ne(C.position,v))||ne(v,i);if(_||p)continue;const g=S?Va.getMovementCost(a,S):1,I=(c!==void 0?Math.abs(Ce(v,i)-c):Ce(v,i))+(g-1);I<h?(h=I,f=[v]):I===h&&f.push(v)}if(f.length===0)return{position:e.position,state:a};if(f.length===1)return{position:f[0],state:a};const{value:b,nextState:y}=Fa(a),A=Math.floor(b*f.length)%f.length;return{position:f[A],state:y}},ox=(e,i,a)=>{if(Ce(e.position,i)===1)return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...i}},nextState:a};let c=e.position,r=a;for(let h=0;h<2&&!(Ce(c,i)<=1);h++){const b={...e,position:c},{position:y,state:A}=gi(b,i,r,a.occupiedCurrentTurn);c=y,r=A}const f=!ne(c,e.position);return{entity:{...e,position:c,intent:f?"Moving":"BASIC_ATTACK",intentPosition:f?void 0:{...i}},nextState:r,message:f?`${e.subtype} moves to (${c.q}, ${c.r})`:void 0}},lx=(e,i,a)=>{const o=Ce(e.position,i),c=Ag(e.position,i);if(o===1)return{entity:{...e,facing:c,intent:"BASIC_ATTACK",intentPosition:{...i}},nextState:a};const{position:r,state:f}=gi(e,i,a,a.occupiedCurrentTurn),h=!ne(r,e.position);return{entity:{...e,position:r,facing:h?Ag(e.position,r):c,intent:h?"Advancing":"BASIC_ATTACK",intentPosition:h?void 0:{...i}},nextState:f,message:h?`${e.subtype} advances to (${r.q}, ${r.r})`:void 0}},rx=(e,i,a)=>{const o=Ce(e.position,i);let c=a;const{value:r,nextState:f}=Fa(c);c=f;let h=e.position;if(o<=2||r<.3){const{value:v,nextState:S}=Fa(c);c=S;const{value:_,nextState:p}=Fa(c);c=p;const g=Math.floor(v*6),R=3+Math.floor(_*3);let I=e.position;for(let M=0;M<R;M++)I=Wn(I,Un(g));!tt.isWithinBounds(a,I)||!qe.isWalkable(a,I)||a.occupiedCurrentTurn?.some(M=>ne(M,I))||a.enemies.some(M=>M.id!==e.id&&ne(M.position,I))||ne(I,i)||(h=I)}const b=!ne(h,e.position),y=Ce(h,i),A=!b&&y>=2&&y<=4;return{entity:{...e,position:h,intent:b?"Repositioning":A?"Casting":"Preparing",intentPosition:A?{...i}:void 0},nextState:c,message:b?`${e.subtype} teleports to (${h.q}, ${h.r})`:void 0}},cx=(e,i,a)=>{const o=Ce(e.position,i);if(o===1)return{entity:{...e,isVisible:!0,intent:"BASIC_ATTACK",intentPosition:{...i}},nextState:a};const{position:c,state:r}=gi(e,i,a,a.occupiedCurrentTurn),f=!ne(c,e.position);return{entity:{...e,position:c,isVisible:f?!1:o<=1,intent:f?"Moving":"BASIC_ATTACK",intentPosition:f?void 0:{...i}},nextState:r,message:f?"You hear footsteps nearby...":void 0}},ux={sentinel:{telegraphSkillId:"SENTINEL_TELEGRAPH",executeSkillId:"SENTINEL_BLAST",triggerRange:3,telegraphMessage:"The Sentinel marks the blast zone..."}},dx=(e,i,a,o)=>{const r=Ce(e.position,i)<=o.triggerRange,f=a.turnNumber%2===0,h=!f;if(r&&h&&Ns(e))return{entity:{...e,intent:"Preparing",intentPosition:void 0},nextState:a,message:`${e.subtype} loses focus!`};if(r&&f)return{entity:{...e,intent:o.telegraphSkillId,intentPosition:{...i}},nextState:a,message:o.telegraphMessage};if(r&&h)return{entity:{...e,intent:o.executeSkillId,intentPosition:{...i}},nextState:a};const{position:b,state:y}=gi(e,i,a,a.occupiedCurrentTurn);return{entity:{...e,position:b,intent:"Moving",intentPosition:void 0},nextState:y}},fx=(e,i,a)=>{const o=e.actionCooldown??0;if(o>0)return{entity:{...e,actionCooldown:o-1,intent:"Charging Power"},nextState:a};const c=Ce(e.position,i);if(c>=1&&c<=3)return{entity:{...e,actionCooldown:2,intent:"BASIC_ATTACK",intentPosition:{...i}},nextState:a};const{position:r,state:f}=gi(e,i,a,a.occupiedCurrentTurn),h=!ne(r,e.position);return{entity:{...e,position:r,intent:h?"Lumbering":"Waiting",actionCooldown:0},nextState:f,message:h?`${e.subtype} lumbers to (${r.q}, ${r.r})`:void 0}},mx=(e,i,a)=>{const o=Ce(e.position,i);if(o>4){const{position:A,state:v}=gi(e,i,a,a.occupiedCurrentTurn),S=!ne(A,e.position);return{entity:{...e,position:A,intent:S?"Following":"Waiting"},nextState:v,message:S?`${e.subtype} follows you.`:void 0}}const c=a.enemies.filter(A=>A.factionId==="enemy").sort((A,v)=>Ce(e.position,A.position)-Ce(e.position,v.position))[0];if(!c){if(o>1){const{position:A,state:v}=gi(e,i,a,a.occupiedCurrentTurn);return{entity:{...e,position:A,intent:"Idle"},nextState:v}}return{entity:{...e,intent:"Idle"},nextState:a}}if(Ce(e.position,c.position)===1)return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...c.position}},nextState:a};const{position:f,state:h}=gi(e,c.position,a,a.occupiedCurrentTurn),b=!ne(f,e.position),y=Ce(f,c.position);return{entity:{...e,position:f,intent:b?"Advancing":y===1?"BASIC_ATTACK":"Waiting",intentPosition:b||y>1?void 0:{...c.position}},nextState:h,message:b?`${e.subtype} attacks ${c.subtype}!`:void 0}},px=(e,i,a)=>{if(e.factionId==="player")return mx(e,i,a);if((a.player.stealthCounter||0)>0)return{entity:{...e,intent:"Searching",intentPosition:void 0},nextState:a};const c=Ce(e.position,i);switch(e.subtype){case"sprinter":return ox(e,i,a);case"shieldBearer":return lx(e,i,a);case"warlock":return rx(e,i,a);case"assassin":return cx(e,i,a);case"golem":return fx(e,i,a);case"sentinel":return dx(e,i,a,ux.sentinel);case"raider":{if((e.position.q===i.q||e.position.r===i.r||e.position.s===i.s)&&c>=2&&c<=4)return{entity:{...e,intent:"DASH",intentPosition:{...i}},nextState:a};const{position:f,state:h}=gi(e,i,a,a.occupiedCurrentTurn),b=!ne(f,e.position),y=Ce(f,i);return{entity:{...e,position:f,intent:b?"Moving":y===1?"BASIC_ATTACK":"Waiting",intentPosition:b||y>1?void 0:{...i}},nextState:h,message:b?`${e.subtype} moves to (${f.q}, ${f.r})`:void 0}}case"pouncer":{if((e.position.q===i.q||e.position.r===i.r||e.position.s===i.s)&&c>=2&&c<=4)return{entity:{...e,intent:"GRAPPLE_HOOK",intentPosition:{...i}},nextState:a};const{position:f,state:h}=gi(e,i,a,a.occupiedCurrentTurn),b=!ne(f,e.position);return{entity:{...e,position:f,intent:b?"Moving":"Waiting",intentPosition:void 0},nextState:h,message:b?`${e.subtype} moves to (${f.q}, ${f.r})`:void 0}}case"archer":{if((e.position.q===i.q||e.position.r===i.r||e.position.s===i.s)&&c>1&&c<=4)return{entity:{...e,intent:"SPEAR_THROW",intentPosition:{...i}},nextState:a};const{position:f,state:h}=gi(e,i,a,a.occupiedCurrentTurn),b=!ne(f,e.position);return{entity:{...e,position:f,intent:b?"Moving":"Idle",intentPosition:void 0},nextState:h,message:b?`${e.subtype} moves to (${f.q}, ${f.r})`:void 0}}case"bomber":{const r=e.actionCooldown??0;if(r===0&&c>=2&&c<=3){const A=tt.getNeighbors(i).filter(v=>{const S=!qe.isWalkable(a,v),_=a.enemies.some(p=>ne(p.position,v));return tt.isWithinBounds(a,v)&&!S&&!_&&!ne(v,i)});if(A.length>0){const{value:v,nextState:S}=Fa(a),_=Math.floor(v*A.length)%A.length,p=A[_];return{entity:{...e,intent:"Bombing",intentPosition:p,actionCooldown:2},nextState:S}}}const{position:h,state:b}=gi(e,i,a,a.occupiedCurrentTurn,2.5),y=!ne(h,e.position);return{entity:{...e,position:h,intent:y?"Moving":"Waiting",intentPosition:void 0,actionCooldown:Math.max(0,r-1)},nextState:b,message:y?`${e.subtype} repositioning to (${h.q}, ${h.r})`:void 0}}default:{if(c===1)return{entity:{...e,intent:"BASIC_ATTACK",intentPosition:{...i}},nextState:a};const{position:r,state:f}=gi(e,i,a,a.occupiedCurrentTurn),h=!ne(r,e.position),b=Ce(r,i);return{entity:{...e,position:r,intent:h?"Moving":b===1?"BASIC_ATTACK":"Waiting",intentPosition:h||b>1?void 0:{...i}},nextState:f,message:h?`${e.subtype} moves to (${r.q}, ${r.r})`:void 0}}}},Hc=7,Pc=9,se=36,Tg={speed:1},hx={stunned:{tickWindow:"START_OF_TURN"},poisoned:{tickWindow:"START_OF_TURN"},armored:{tickWindow:"END_OF_TURN"},hidden:{tickWindow:"END_OF_TURN"},time_bomb:{tickWindow:"END_OF_TURN"}},Sf={footman:{hp:1,maxHp:1,range:1,damage:1,type:"melee",cost:1,skills:["BASIC_MOVE","BASIC_ATTACK","AUTO_ATTACK"],actionCooldown:2,weightClass:"Standard",speed:1},sprinter:{hp:1,maxHp:1,range:1,damage:1,type:"melee",cost:1,skills:["BASIC_MOVE","BASIC_ATTACK"],actionCooldown:1,weightClass:"Standard",speed:2},raider:{hp:1,maxHp:1,range:4,damage:1,type:"melee",cost:2,skills:["BASIC_MOVE","BASIC_ATTACK","DASH"],actionCooldown:1,weightClass:"Standard",speed:1},pouncer:{hp:1,maxHp:1,range:4,damage:1,type:"melee",cost:2,skills:["BASIC_MOVE","BASIC_ATTACK","GRAPPLE_HOOK"],actionCooldown:1,weightClass:"Standard",speed:1},shieldBearer:{hp:2,maxHp:2,range:1,damage:1,type:"melee",cost:2,skills:["BASIC_MOVE","BASIC_ATTACK","SHIELD_BASH"],actionCooldown:2,weightClass:"Heavy",speed:1},archer:{hp:1,maxHp:1,range:4,damage:1,type:"ranged",cost:1,skills:["BASIC_MOVE","BASIC_ATTACK","SPEAR_THROW"],actionCooldown:3,weightClass:"Standard",speed:1},bomber:{hp:1,maxHp:1,range:3,damage:1,type:"ranged",cost:1,skills:["BASIC_MOVE","BASIC_ATTACK"],actionCooldown:2,weightClass:"Standard",speed:1},warlock:{hp:1,maxHp:1,range:4,damage:1,type:"ranged",cost:2,skills:["BASIC_MOVE","BASIC_ATTACK"],actionCooldown:2,weightClass:"Standard",speed:1},sentinel:{hp:30,maxHp:30,range:4,damage:2,type:"boss",cost:25,skills:["BASIC_MOVE","BASIC_ATTACK","SENTINEL_BLAST"],actionCooldown:1,weightClass:"Heavy",speed:1}},gx=.17,Eg=[0,2,3,5,7,10,12,15,18,22,0],Tc={floor:"#6b7b3c",wall:"#374151",shrine:"#f97316",portal:"#ffffff"},yx={1:"inferno",2:"inferno",3:"inferno",4:"inferno",5:"inferno",6:"inferno",7:"inferno",8:"inferno",9:"inferno",10:"inferno"},nf={1:["footman"],2:["footman","sprinter"],3:["footman","archer"],4:["footman","archer","bomber","raider"],5:["footman","archer","bomber","shieldBearer","raider"],6:["footman","archer","bomber","shieldBearer","warlock","pouncer"],7:["footman","archer","bomber","shieldBearer","warlock","sprinter","pouncer"],8:["footman","archer","bomber","shieldBearer","warlock","sprinter","pouncer"],9:["footman","archer","bomber","shieldBearer","warlock","sprinter","pouncer"],10:[]},ua=(e,i)=>{let a=i,o=e.temporaryArmor||0,c=e.hp;if(o>0){const r=Math.min(o,a);o-=r,a-=r}return c=Math.max(0,c-a),{...e,hp:c,temporaryArmor:o}},Af=(e,i,a,o)=>{const r=hx[i]?.tickWindow||"END_OF_TURN",f=i.toUpperCase();if(e.statusEffects.find(y=>y.id===f))return{...e,statusEffects:e.statusEffects.map(y=>y.id===f?{...y,duration:Math.max(y.duration,a),tickWindow:r,stacks:o||y.stacks}:y)};const b={id:f,type:i,duration:a,tickWindow:r,stacks:o||1};return{...e,statusEffects:[...e.statusEffects,b]}},bx=(e,i)=>({...e,hp:Math.min(e.maxHp,e.hp+i)}),xx=(e,i,a=!0)=>{const o=e.maxHp+i,c=a?Math.min(o,e.hp+i):e.hp;return{...e,maxHp:o,hp:c}},vx=e=>{const i=[];return e.player.hp<=0&&e.gameStatus==="playing"&&i.push({type:"GameOver",reason:"PLAYER_DIED"}),i},wg=e=>e.activeSkills?{...e,activeSkills:e.activeSkills.map(i=>({...i,currentCooldown:Math.max(0,i.currentCooldown-1)}))}:e,Sx=(e,i,a)=>e.activeSkills?{...e,activeSkills:e.activeSkills.map(o=>o.id===i&&!o.activeUpgrades.includes(a)?{...o,activeUpgrades:[...o.activeUpgrades,a]}:o)}:e;function Tf(e,i){return e?.get(i)}const sf=(e,i,a)=>Math.max(i,Math.min(a,e)),zl=e=>Math.round(e*1e3)/1e3,Bf=e=>{const i=Math.max(0,e.body),a=Math.max(0,e.mind),o=Math.max(0,e.instinct);return{bodyDamageMultiplier:zl(1+i/20),bodyMitigation:zl(sf(i*.01,0,.5)),mindStatusDurationBonus:Math.floor(a/15),mindMagicMultiplier:zl(1+a/20),instinctInitiativeBonus:o*2,instinctCriticalMultiplier:zl(1+sf(o,0,10)*.02),instinctSparkDiscountMultiplier:zl(1-sf(o,0,100)/100)}},Wc=e=>{const i=Math.max(0,e.body),a=Math.max(0,e.mind),o=Math.max(0,e.instinct),c={base:0,body:5,mind:2,instinct:3},r=Math.floor(i*c.body+a*c.mind+o*c.instinct+c.base);return Math.max(1,r)},kn=(e,i,a)=>Math.max(i,Math.min(a,e)),cn=e=>Math.round(e*1e3)/1e3,Ax=()=>globalThis?.process?.env?.HOP_COMBAT_INTERACTION_MODEL,Tx=e=>e.length===0?1:e.reduce((i,a)=>i*a.multiplier,1),Ex=e=>{let i=1;if(e.inDangerPreviewHex&&(i+=.15),typeof e.proximityDistance=="number"){const a=kn(e.proximityDistance,0,6);i+=(6-a)*.02}return i},wx=(e,i,a,o,c,r,f,h)=>{if(!i)return{multiplier:1,pressure:0,rangePressure:0,rangeMultiplier:1};const b=a==="physical"?.85+e.instinct*.015+e.body*.005:.85+e.mind*.015+e.instinct*.005,y=a==="physical"?i.instinct*.012+i.body*.004:i.instinct*.008+i.mind*.008,A=kn(b-y,.1,.99);if(typeof o!="number")return{multiplier:A,pressure:cn(b-y),rangePressure:0,rangeMultiplier:1};const v={min:kn(c??(a==="physical"?1:2),1,6),max:kn(r??(a==="physical"?2:4),1,6)};if(v.max<v.min){const X=v.min;v.min=v.max,v.max=X}const S={min:kn(f??(a==="physical"?1:2),1,6),max:kn(h??(a==="physical"?3:5),1,6)};if(S.max<S.min){const X=S.min;S.min=S.max,S.max=X}const _=kn(o,1,6),p=Math.max(0,v.min-_),g=Math.max(0,_-v.max),R=p*.06+g*.1,I=e.instinct*.015,C=(_>=S.min&&_<=S.max?.05:0)+i.instinct*.006,M=I-R-C,N=kn(1+M,.55,1.25);return{multiplier:kn(A*N,.05,.99),pressure:cn(b-y),rangePressure:cn(M),rangeMultiplier:cn(N)}},_x=(e,i)=>{if(!e)return{multiplier:1,pressure:0};const a=kn(i==="physical"?e.body*.01+e.instinct*.004:e.mind*.01+e.instinct*.004,0,.75);return{multiplier:1-a,pressure:cn(a)}},Mx=(e,i,a,o)=>{if(!i)return{multiplier:o,critPressure:0,resistancePressure:0};const c=kn(a==="physical"?.05+e.instinct*.01:.05+e.mind*.01,0,.75),r=kn(a==="physical"?i.body*.006+i.instinct*.004:i.mind*.006+i.instinct*.004,0,.7);return{multiplier:1+kn(c-r,0,.75)*(o-1),critPressure:cn(c),resistancePressure:cn(r)}},Ox=(e,i,a,o,c)=>{const r=e.scaling.filter(v=>v.attribute==="body").reduce((v,S)=>v+(e.trinity.body||0)*S.coefficient,0),f=e.scaling.filter(v=>v.attribute==="mind").reduce((v,S)=>v+(e.trinity.mind||0)*S.coefficient,0),h=e.scaling.filter(v=>v.attribute==="instinct").reduce((v,S)=>v+(e.trinity.instinct||0)*S.coefficient,0),b=e.damageClass==="physical"?Math.max(0,e.basePower*(i.bodyDamageMultiplier-1)):0,y=e.damageClass==="magical"?Math.max(0,e.basePower*(i.mindMagicMultiplier-1)):0,A=Math.max(0,(c-1)*(a+o));return{body:Math.max(0,b+r),mind:Math.max(0,y+f),instinct:Math.max(0,h+A)}},Cx=(e,i)=>{if(e<=0)return e;const a=Bf(i).mindStatusDurationBonus;return e+a},Nx=e=>Bf(e).instinctInitiativeBonus,pn=e=>{const i=Bf(e.trinity),a=e.damageClass||"physical",o=Ax()==="triangle"?"triangle":"legacy",c=e.interactionModel||o,r=a==="magical"?i.mindMagicMultiplier:i.bodyDamageMultiplier,f=e.basePower*r,h=e.scaling.reduce((O,q)=>{const K=e.trinity[q.attribute]||0;return O+K*q.coefficient},0),b=Tx(e.statusMultipliers),y=Ex(e),A=i.instinctCriticalMultiplier,v=c==="triangle"?wx(e.trinity,e.targetTrinity,a,e.engagementRange,e.optimalRangeMin,e.optimalRangeMax,e.targetOptimalRangeMin,e.targetOptimalRangeMax):{multiplier:1,pressure:0,rangePressure:0,rangeMultiplier:1},S=c==="triangle"?_x(e.targetTrinity,a):{multiplier:1,pressure:0},_=c==="triangle"?Mx(e.trinity,e.targetTrinity,a,A):{multiplier:A,critPressure:0,resistancePressure:0},p=(f+h)*b*y*v.multiplier*S.multiplier*_.multiplier*(e.attackPowerMultiplier??1)*(e.targetDamageTakenMultiplier??1),g=Math.max(0,Math.floor(p)),R=Ox(e,i,f,h,A),I=Math.max(1e-6,R.body+R.mind+R.instinct),C=cn(R.body/I),M=cn(R.mind/I),N=cn(R.instinct/I),Y=Math.max(1,e.theoreticalMaxPower??p),X=kn(g/Y,0,1);return{basePower:e.basePower,bodyScaledPower:cn(f),scalingPower:cn(h),statusMultiplier:cn(b),riskMultiplier:cn(y),criticalMultiplier:cn(A),hitMultiplier:cn(v.multiplier),rangeMultiplier:cn(v.rangeMultiplier),mitigationMultiplier:cn(S.multiplier),critExpectedMultiplier:cn(_.multiplier),finalPower:g,bodyContribution:C,mindContribution:M,instinctContribution:N,scoreEvent:{skillId:e.skillId,attackerId:e.attackerId,targetId:e.targetId,finalPower:g,efficiency:cn(X),riskBonusApplied:!!e.inDangerPreviewHex,damageClass:a,hitPressure:v.pressure,rangePressure:v.rangePressure,mitigationPressure:S.pressure,critPressure:_.critPressure,resistancePressure:_.resistancePressure,bodyContribution:C,mindContribution:M,instinctContribution:N}}},Qe=e=>{const i=Tf(e.components,"trinity");if(i)return{body:i.body,mind:i.mind,instinct:i.instinct};const a=Tf(e.components,"stats"),o=a?.strength??0,c=a?.defense??0,r=a?.evasion??0;return{body:o,mind:c,instinct:r}},_g={player:100,footman:50,archer:60,shieldBearer:40,bomber:30,warlock:55,bomb:10},Ef=e=>{let i=e.speed;if(i===void 0){const o=e.subtype;i=e.type==="player"?_g.player:_g[o]??50}return e.statusEffects?.some(o=>o.type==="stunned")&&(i-=100),i+=Nx(Qe(e)),i},Wa=e=>{const i=[];i.push({actorId:e.player.id,initiative:Ef(e.player),hasActed:!1,turnStartPosition:void 0});for(const a of e.enemies)i.push({actorId:a.id,initiative:Ef(a),hasActed:!1,turnStartPosition:void 0});return i.sort((a,o)=>o.initiative!==a.initiative?o.initiative-a.initiative:a.actorId==="player"?-1:o.actorId==="player"?1:a.actorId.localeCompare(o.actorId)),{entries:i,currentIndex:-1,round:1}},Rx=e=>e.currentIndex<0||e.currentIndex>=e.entries.length?null:e.entries[e.currentIndex],kx=e=>{let i=e.initiativeQueue;i||(i=Wa(e));let a=i.currentIndex+1;for(;a<i.entries.length&&i.entries[a].hasActed;)a++;return a>=i.entries.length?(i=Wa(e),i.round=(e.initiativeQueue?.round??0)+1,a=0,{queue:{...i,currentIndex:a},actorId:i.entries[a]?.actorId??null,newRound:!0}):{queue:{...i,currentIndex:a},actorId:i.entries[a]?.actorId??null,newRound:!1}},Lx=(e,i)=>{const a=e.initiativeQueue;if(!a)return Wa(e);const o=a.entries.map(c=>{if(c.actorId===i.id){if(c.turnStartPosition)return c;const f=ot(i.position).map(h=>Ee(e,h)?.id).filter(Boolean);return{...c,turnStartPosition:{...i.position},turnStartNeighborIds:f}}return c});return{...a,entries:o}},Ix=(e,i)=>{const a=e.initiativeQueue;if(!a)return Wa(e);const o=a.entries.map(c=>c.actorId===i?{...c,hasActed:!0}:c);return{...a,entries:o}},Bx=(e,i)=>{const a=e.initiativeQueue;return a?a.entries.find(c=>c.actorId===i)?.turnStartPosition??null:null},jx=(e,i)=>{const a=e.initiativeQueue;return a?a.entries.find(c=>c.actorId===i)?.turnStartNeighborIds??null:null},Ql=e=>{const i=e.initiativeQueue;if(!i)return!0;if(i.currentIndex<0||i.currentIndex>=i.entries.length)return!1;const a=i.entries[i.currentIndex];return a.actorId===e.player.id&&!a.hasActed},af=(e,i)=>{const a=e.entries.filter(r=>r.actorId!==i);let o=e.currentIndex;const c=e.entries.findIndex(r=>r.actorId===i);return c>=0&&c<=e.currentIndex&&o--,{...e,entries:a,currentIndex:Math.min(o,a.length-1)}},Dx=(e,i)=>{const a={actorId:i.id,initiative:Ef(i),hasActed:!0,turnStartPosition:void 0};return{...e,entries:[...e.entries,a]}},mn={body:0,mind:0,instinct:0},Hx=e=>({body:e.body,mind:e.mind,instinct:e.instinct}),jo=e=>{const i={};for(const[a,o]of Object.entries(e))i[a]=Hx(o);return i},Px={neutral:{id:"neutral",default:mn,archetype:jo({VANGUARD:mn,SKIRMISHER:mn,FIREMAGE:mn,NECROMANCER:mn,HUNTER:mn,ASSASSIN:mn}),enemySubtype:jo({footman:mn,sprinter:mn,raider:mn,pouncer:mn,shieldBearer:mn,archer:mn,bomber:mn,warlock:mn,sentinel:mn}),companionSubtype:jo({falcon:mn,skeleton:mn})},live:{id:"live",default:mn,archetype:jo({VANGUARD:{body:9,mind:4,instinct:5},SKIRMISHER:{body:7,mind:6,instinct:10},FIREMAGE:{body:2,mind:9,instinct:4},NECROMANCER:{body:5,mind:9,instinct:5},HUNTER:{body:3,mind:4,instinct:8},ASSASSIN:{body:3,mind:3,instinct:9}}),enemySubtype:jo({footman:{body:0,mind:0,instinct:0},sprinter:{body:0,mind:0,instinct:0},raider:{body:.4,mind:0,instinct:.2},pouncer:{body:.4,mind:0,instinct:.2},shieldBearer:{body:1,mind:0,instinct:.4},archer:{body:.2,mind:0,instinct:.2},bomber:{body:.4,mind:.2,instinct:.2},warlock:{body:.4,mind:.6,instinct:.2},sentinel:{body:4,mind:2,instinct:2}}),companionSubtype:jo({falcon:{body:2,mind:2,instinct:9},skeleton:{body:15,mind:1,instinct:4}})}},Ux=e=>e?.toLowerCase()==="neutral"?"neutral":"live",qx=()=>globalThis?.process?.env?.HOP_TRINITY_PROFILE,zx=e=>Px[Ux(qx())],Vi={outgoingPhysical:1,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},$x={VANGUARD:Vi,SKIRMISHER:Vi,FIREMAGE:Vi,NECROMANCER:Vi,HUNTER:Vi,ASSASSIN:Vi},Vx={footman:{outgoingPhysical:3,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},sprinter:{outgoingPhysical:2.8,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},raider:{outgoingPhysical:3.2,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},pouncer:{outgoingPhysical:3.2,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},shieldBearer:{outgoingPhysical:3.5,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},archer:{outgoingPhysical:2.6,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},bomber:{outgoingPhysical:2.8,outgoingMagical:3,incomingPhysical:1,incomingMagical:1},warlock:{outgoingPhysical:1.5,outgoingMagical:3.5,incomingPhysical:1,incomingMagical:1},sentinel:{outgoingPhysical:4,outgoingMagical:4,incomingPhysical:1,incomingMagical:1}},Yx={falcon:{outgoingPhysical:1.2,outgoingMagical:1,incomingPhysical:1,incomingMagical:1},skeleton:{outgoingPhysical:1.1,outgoingMagical:1,incomingPhysical:1,incomingMagical:1}},Jl=e=>({outgoingPhysical:e.outgoingPhysical,outgoingMagical:e.outgoingMagical,incomingPhysical:e.incomingPhysical,incomingMagical:e.incomingMagical}),Ry=e=>e.type==="player"?Jl($x[(e.archetype||"VANGUARD").toUpperCase()]||Vi):e.companionOf&&e.subtype?Jl(Yx[e.subtype]||Vi):e.subtype?Jl(Vx[e.subtype]||Vi):Jl(Vi),ky=e=>{const i=Tf(e.components,"combat_profile");return i?{outgoingPhysical:Number.isFinite(i.outgoingPhysical)?i.outgoingPhysical:1,outgoingMagical:Number.isFinite(i.outgoingMagical)?i.outgoingMagical:1,incomingPhysical:Number.isFinite(i.incomingPhysical)?i.incomingPhysical:1,incomingMagical:Number.isFinite(i.incomingMagical)?i.incomingMagical:1}:Jl(Vi)},Fx=(e,i)=>{const a=ky(e);return i==="magical"?a.outgoingMagical:a.outgoingPhysical},Kx=(e,i)=>{const a=ky(e);return i==="magical"?a.incomingMagical:a.incomingPhysical},$l=e=>({body:e.body,mind:e.mind,instinct:e.instinct}),Ly=e=>{if(e.trinity)return $l(e.trinity);const i=zx(),a=i.default;if(e.type==="player"){const o=(e.archetype||"VANGUARD").toUpperCase();return $l(i.archetype[o]||a)}if(e.companionOf&&e.subtype){const o=e.subtype;if(i.companionSubtype[o])return $l(i.companionSubtype[o])}return e.subtype?$l(i.enemySubtype[e.subtype]||a):$l(a)},Zl=e=>{const i=new Map(e.components||[]),a=i.has("trinity"),o=i.has("combat_profile");if(a&&o)return e;const c=Ly({id:e.id,type:e.type,subtype:e.subtype,position:e.position,hp:e.hp,maxHp:e.maxHp,speed:e.speed,factionId:e.factionId,archetype:e.archetype,companionOf:e.companionOf}),r=Ry({type:e.type,archetype:e.archetype,subtype:e.subtype,companionOf:e.companionOf});return a||i.set("trinity",{type:"trinity",...c}),o||i.set("combat_profile",{type:"combat_profile",...r}),{...e,components:i}};function Gx(e){return e.map(i=>({id:i,name:String(i),description:String(i),slot:"utility",cooldown:0,currentCooldown:0,range:0,upgrades:[],activeUpgrades:[]}))}function ma(e){const i=e.activeSkills?[...e.activeSkills]:Gx(e.skills||[]),a=new Map(e.components||[]),o=Ly(e),c=e.combatProfile||Ry(e);a.has("trinity")||a.set("trinity",{type:"trinity",...o}),a.has("combat_profile")||a.set("combat_profile",{type:"combat_profile",...c});const r=Wc(o),f=Math.max(1,e.maxHp??r),h=Math.min(f,Math.max(0,e.hp??f));return e.weightClass&&a.set("physics",{type:"physics",weightClass:e.weightClass}),e.archetype&&a.set("archetype",{type:"archetype",archetype:e.archetype}),{id:e.id,type:e.type,subtype:e.subtype,position:e.position,hp:h,maxHp:f,speed:e.speed,factionId:e.factionId,initiative:e.initiative,statusEffects:[],temporaryArmor:0,activeSkills:i,weightClass:e.weightClass,archetype:e.archetype,components:a,isFlying:e.isFlying,companionOf:e.companionOf,isVisible:!0}}function Wx(e){const i=ma({id:e.id,type:"enemy",subtype:e.subtype,position:e.position,hp:e.hp,maxHp:e.maxHp,speed:e.speed,factionId:"enemy",skills:e.skills,weightClass:e.weightClass||"Standard",trinity:e.trinity});return i.enemyType=e.enemyType,i}function Iy(e){if(e.companionType==="falcon"){const i=ma({id:e.id||`falcon-${e.ownerId}`,type:"enemy",subtype:"falcon",position:e.position,speed:95,factionId:"player",skills:["BASIC_MOVE","FALCON_PECK","FALCON_APEX_STRIKE","FALCON_HEAL","FALCON_SCOUT","FALCON_AUTO_ROOST"],weightClass:"Light",isFlying:!0,companionOf:e.ownerId,trinity:e.trinity});return i.companionState={mode:"roost",orbitStep:0},i}return e.companionType==="skeleton"?ma({id:e.id||`${e.companionType}-${e.ownerId}`,type:"enemy",subtype:"skeleton",position:e.position,hp:2,maxHp:2,speed:50,factionId:"player",skills:["BASIC_MOVE","BASIC_ATTACK","AUTO_ATTACK"],companionOf:e.ownerId,weightClass:"Standard",trinity:e.trinity}):ma({id:e.id||`${e.companionType}-${e.ownerId}`,type:"enemy",subtype:e.companionType,position:e.position,speed:80,factionId:"player",skills:["BASIC_MOVE","BASIC_ATTACK"],companionOf:e.ownerId,weightClass:"Standard",trinity:e.trinity})}function Xx(e){return Iy({companionType:"falcon",ownerId:e.ownerId,position:e.position})}function Qx(e){const i=["BASIC_MOVE","BASIC_ATTACK"],a={footman:["AUTO_ATTACK"],sprinter:[],raider:["DASH"],pouncer:["GRAPPLE_HOOK"],shieldBearer:["SHIELD_BASH"],archer:["SPEAR_THROW"],bomber:["BOMB_TOSS"],warlock:[],sentinel:["SENTINEL_TELEGRAPH","SENTINEL_BLAST"]};return[...i,...a[e]||[]]}const Jx=/^\[(INFO|VERBOSE|DEBUG|CRITICAL)\|([A-Z_]+)\]\s*/i,Zx=e=>Jx.test(e),jf=(e,i="INFO",a="SYSTEM")=>e?Zx(e)?e:`[${i}|${a}] ${e}`:"",ev=(e,i="INFO",a="SYSTEM")=>e.map(o=>jf(o,i,a)).filter(Boolean),Ht=(e,i,a,o,c=50)=>{const r=jf(i,a,o),f=[...e||[]];return r&&f[f.length-1]===r?f.slice(-c):[...f,r].slice(-c)},is=(e,i,a,o,c=50)=>{const r=[...e||[]];let f;for(const h of ev(i,a,o))h&&f===h||(r.push(h),f=h);return r.slice(-c)},Mg=(e,i,a)=>{const o=a.preserveInputOrder===!1?[...i]:[...i].reverse(),c=a.describe||(()=>"UNKNOWN");let r=e;const f=[];let h=a.startTick||1;for(;o.length>0;){const b=o.length,y=o.pop();r=a.apply(r,y);const A=a.getReactions?.(r,y)||[];if(A.length>0)for(let v=A.length-1;v>=0;v--)o.push(A[v]);f.push({tick:h++,effectType:c(y),depthBefore:b,depthAfter:o.length,reactionsQueued:A.length})}return{state:r,trace:f,resolvedCount:f.length}};var Og={};const Vl=(e,i)=>{const a=he(i);let o=e;o.tiles===e.tiles&&(o={...o,tiles:new Map(o.tiles)});let c=o.tiles.get(a);return c?c={...c,traits:new Set(c.traits),effects:[...c.effects]}:c={baseId:"STONE",position:i,traits:new Set(Ho.STONE.defaultTraits),effects:[]},c.traits.add("CORPSE"),o.tiles.set(a,c),o},tv=(e,i)=>{const a=he(i),o=e.tiles.get(a);if(!o||!o.traits.has("CORPSE"))return e;let c=e;c.tiles===e.tiles&&(c={...c,tiles:new Map(c.tiles)});const r={...o,traits:new Set(o.traits),effects:[...o.effects]};return r.traits.delete("CORPSE"),c.tiles.set(a,r),c},nv=typeof process<"u"&&(Og?.HOP_ENGINE_WARN==="1"||Og?.HOP_ENGINE_DEBUG==="1"),Cg={INTENT_START:1,MOVE_START:2,MOVE_END:3,ON_PASS:4,ON_ENTER:5,HAZARD_CHECK:6,STATUS_APPLY:7,DAMAGE_APPLY:8,DEATH_RESOLVE:9,INTENT_END:10},iv=e=>{const i=e||[];let a=0;for(const o of i)o.blocking&&(a+=Number(o.suggestedDurationMs||0));return a},Ii=(e,i,a,o,c,r,f)=>{const h=e.timelineEvents||[],b=h.length,y=e.turnNumber||0,A=c.sourceId||c.targetId,v=c.stepId||`${y}:${A||"system"}`,S=c.stepId||v,_=S?[...h].reverse().find(g=>(g.stepId||g.groupId)===S):void 0;if(_){const g=Cg[_.phase]||0,R=Cg[i]||0;g>R&&nv&&console.warn("[TURN_STACK] Non-monotonic timeline phase order detected.",{stepId:S,previous:_.phase,next:i})}const p=`${S}:${b}:${i}`;return{...e,timelineEvents:[...h,{id:p,turn:y,actorId:A,stepId:S,phase:i,type:a,payload:o,blocking:r,groupId:v,suggestedDurationMs:f}]}},Yl=(e,i)=>{const a=e.simulationEvents||[],o=`sim:${e.turnNumber||0}:${a.length}:${i.type}`;return{...e,simulationEvents:[...a,{...i,id:o,turn:e.turnNumber||0}]}},sv=(e,i)=>{if(i)return e.player.id===i?e.player:e.enemies.find(a=>a.id===i)||e.companions?.find(a=>a.id===i)},Ng=(e,i)=>{if(i)return ne(e.player.position,i)?e.player:e.enemies.find(a=>ne(a.position,i))||e.companions?.find(a=>ne(a.position,i))},av=new Set(["lava_sink","void_sink","hazard_intercept","lava_tick","fire_damage","burning","oil_explosion"]),of=(e,i,a,o,c,r)=>{if(!o)return{amount:i,outgoing:1,incoming:1,total:1};if(r&&av.has(r))return{amount:i,outgoing:1,incoming:1,total:1};const f=sv(e,a);if(!f)return{amount:i,outgoing:1,incoming:1,total:1};const h=Fx(f,c),b=Kx(o,c),y=h*b;return{amount:Math.max(0,Math.floor(i*y)),outgoing:h,incoming:b,total:y}},wf=(e,i,a={})=>{let o={...e};const c=()=>{o.tiles===e.tiles&&(o={...o,tiles:new Map(o.tiles)})};switch(i.type){case"Displacement":{let r="";if(i.target==="self"?r=a.sourceId||o.player.id:i.target==="targetActor"?r=a.targetId||"":r=i.target,!r)break;const f=(S,_)=>_===S.player.id?S.player:S.enemies.find(p=>p.id===_),h=f(o,r);if(!h)break;const b=i.source||h?.position,y=Math.min(3200,Math.max(0,iv(o.timelineEvents)));let A=!1;const v=!(i.simulatePath||i.path||i.isFling);if(b&&(o=Ii(o,"MOVE_START","Displacement",{origin:b,destination:i.destination,targetActorId:r},{...a,targetId:r},!0,220)),b){const S=i.path||(b?Pt(b,i.destination):void 0),_=i.simulatePath||i.isFling||!!i.path;let p=i.destination;if(_&&S){const X=f(o,r);if(!X)break;const O=Va.processPath(X,S.slice(1),o,S.length-1,{ignoreActors:i.ignoreCollision,ignoreGroundHazards:i.ignoreGroundHazards});p=O.lastValidPos,r===o.player.id?o.player={...o.player,position:p}:o.enemies=o.enemies.map(K=>K.id===r?{...K,position:p}:K),A||(o=Ii(o,"MOVE_END","Displacement",{destination:p,targetActorId:r},{...a,targetId:r},!0,260),A=!0),O.result.effects.length>0&&(o=Ii(o,"ON_PASS","TilePath",{path:S.slice(1),targetActorId:r},{...a,targetId:r},!1,80),o=yi(o,O.result.effects,{targetId:r})),O.result.messages.length>0&&(o.message=is(o.message,O.result.messages,"INFO","HAZARD"));const q=r===o.player.id||o.enemies.some(K=>K.id===r);if(!O.interrupt&&q){const K=qe.getTileAt(o,p);o=Ii(o,"ON_ENTER","TileEnter",{position:p,targetActorId:r,tileBaseId:K?.baseId},{...a,targetId:r},!1,80);const ue=f(o,r);if(!ue)break;const W=Va.processEntry(ue,K,o);W.effects.length>0&&(o=yi(o,W.effects,{targetId:r})),W.messages.length>0&&(o.message=is(o.message,W.messages,"INFO","HAZARD"))}if(O.result.newMomentum&&O.result.newMomentum>0){const K=O.lastValidPos,ue=S.length>1?S[S.length-2]:b,W=fa(ue,K);if(W!==-1){const _e=Un(W);let oe=K,be=5;for(;be>0;){const pe=Wn(oe,_e);if(!qe.isWalkable(o,pe)||(r===o.player.id?o.enemies.find(ae=>ae.hp>0&&ne(ae.position,pe)):ne(o.player.position,pe)?o.player:o.enemies.find(ae=>ae.id!==r&&ae.hp>0&&ne(ae.position,pe))))break;const ee=qe.getTileAt(o,pe);if(ee){const ae=Va.processTransition(h,ee,o,1);if(oe=pe,ae.effects.length>0&&(o=yi(o,ae.effects,{targetId:r})),ae.messages.length>0&&(o.message=is(o.message,ae.messages,"INFO","HAZARD")),ae.newMomentum===0||ae.interrupt)break}else{oe=pe;break}be--}p=oe}}}const g=[...o.visualEvents||[]],R=!!(i.ignoreCollision||i.isFling),I=R?g.reduce((X,O)=>{if(O.type!=="kinetic_trace")return X;const q=O.payload;return q&&(q.movementType??"slide")==="slide"?X+1:X},0):0,C=v?0:R?Math.min(640,I*90):0,M=Math.max(y,C),N={actorId:r,origin:b,path:i.path||(v?[b,p]:Pt(b,p)),destination:p,movementType:v?"teleport":"slide",durationMs:i.animationDuration??(v?180:Math.max(120,(i.path?.length||Pt(b,p).length)*110)),startDelayMs:M,wasLethal:o.tiles.get(he(p))?.traits.has("HAZARDOUS")||!1},Y=g;if(v)Y.push({type:"kinetic_trace",payload:N});else{let X=!1;for(let O=Y.length-1;O>=0;O--){const q=Y[O];if(q.type!=="kinetic_trace")continue;const K=q.payload;if(!(!K||K.actorId!==r)){if((K.movementType??"slide")==="slide"&&ne(K.destination,N.origin)){const ue=K.path&&K.path.length>0?K.path:[K.origin,K.destination],W=N.path&&N.path.length>0?N.path:[N.origin,N.destination],_e=[...ue,...W.slice(1)];Y[O]={type:"kinetic_trace",payload:{...N,origin:K.origin,path:_e,durationMs:(K.durationMs||0)+(N.durationMs||0),startDelayMs:Math.min(K.startDelayMs??M,M),movementType:"slide",wasLethal:!!(K.wasLethal||N.wasLethal)}},X=!0}break}}X||Y.push({type:"kinetic_trace",payload:N})}if(o.visualEvents=Y,r===o.player.id)o.player={...o.player,position:p,previousPosition:v?p:o.player.position};else{const X=O=>O.id===r?{...O,position:p,previousPosition:v?p:O.position}:O;o.enemies=o.enemies.map(X),o.companions&&(o.companions=o.companions.map(X))}o.occupancyMask=tt.refreshOccupancyMask(o),A||(o=Ii(o,"MOVE_END","Displacement",{destination:p,targetActorId:r},{...a,targetId:r},!0,260)),o=Yl(o,{type:"UnitMoved",actorId:r,position:p,payload:{origin:b,destination:p,movementType:N.movementType}})}break}case"Damage":{const r=!!i.reason&&["lava_sink","void_sink","hazard_intercept","lava_tick","fire_damage"].includes(i.reason),f=R=>R?.statusEffects?.some(I=>I.type==="marked_predator")?1:0;r&&(o=Ii(o,"HAZARD_CHECK","Damage",{reason:i.reason,amount:i.amount,target:i.target},a,!0,200)),o=Ii(o,"DAMAGE_APPLY","Damage",{reason:i.reason,amount:i.amount,target:i.target,scoreEvent:i.scoreEvent},a,!0,180);let h="",b=null,y,A,v=i.amount;typeof i.target=="string"?i.target==="targetActor"?h=a.targetId||"":i.target!=="area"&&(h=i.target):b=i.target;const S=["fire_damage","lava_sink","burning","hazard_intercept","lava_tick","oil_explosion","void_sink"],_=i.reason&&S.includes(i.reason),p=o.upgrades?.includes("RELIC_EMBER_WARD"),g=o.upgrades?.includes("RELIC_CINDER_ORB");if(_&&h){const I=(h===o.player.id?o.player:o.enemies.find(M=>M.id===h))?.activeSkills?.some(M=>M.id==="ABSORB_FIRE");let C=i.amount;if(h===o.player.id&&p&&(C=Math.max(0,C-1),o.message=Ht(o.message,"Ember Ward dampens the flames.","INFO","COMBAT")),I){const M=C+(h===o.player.id&&g?1:0);return h===o.player.id&&g&&(o.message=Ht(o.message,"Cinder Orb amplifies the absorption.","INFO","COMBAT")),wf(o,{type:"Heal",target:h,amount:M})}}if(h)if(h===o.player.id){const R=o.player,I=i.scoreEvent?.damageClass||"physical",C=of(o,i.amount,a.sourceId,R,I,i.reason);let M=C.amount;M+=f(R),_&&p&&(M=Math.max(0,M-1)),i.scoreEvent&&(o.combatScoreEvents=[...o.combatScoreEvents||[],{...i.scoreEvent,finalPower:M,traitOutgoingMultiplier:C.outgoing,traitIncomingMultiplier:C.incoming,traitTotalMultiplier:C.total}].slice(-500)),o.player=ua(o.player,M),y=o.player.id,A=o.player.position,v=M,_&&(o.hazardBreaches=(o.hazardBreaches||0)+1),_&&g&&(o.player=bx(o.player,1),o.message=Ht(o.message,"Cinder Orb restores 1 HP.","INFO","COMBAT"))}else{const R=o.enemies.find(O=>O.id===h),I=h===o.player.id?o.player.position:R?.position,C=[],M=i.scoreEvent?.damageClass||"physical",N=of(o,i.amount,a.sourceId,R,M,i.reason),Y=N.amount+f(R);y=h||R?.id,A=I||R?.position,v=Y;const X=O=>{if(O.id===h){const q=ua(O,Y);return q.hp<=0&&(o.dyingEntities=[...o.dyingEntities||[],O],C.push(O.position)),q}return O};if(i.scoreEvent&&(o.combatScoreEvents=[...o.combatScoreEvents||[],{...i.scoreEvent,finalPower:Y,traitOutgoingMultiplier:N.outgoing,traitIncomingMultiplier:N.incoming,traitTotalMultiplier:N.total}].slice(-500)),o.enemies=o.enemies.map(X).filter(O=>O.hp>0),o.companions&&(o.companions=o.companions.map(X).filter(O=>O.hp>0)),C.length>0&&(o=Ii(o,"DEATH_RESOLVE","Damage",{targetActorId:h,reason:i.reason||"damage"},{...a,targetId:h},!0,260)),C.forEach(O=>{o=Vl(o,O)}),I&&(o.visualEvents=[...o.visualEvents||[],{type:"vfx",payload:{type:"impact",position:I}}]),h===o.player.id&&(o.player.stealthCounter||0)>0)o.player={...o.player,stealthCounter:Math.max(0,(o.player.stealthCounter||0)-1)};else if(h!==o.player.id){const O=q=>q.id===h?{...q,stealthCounter:Math.max(0,(q.stealthCounter||0)-1)}:q;o.enemies=o.enemies.map(O),o.companions&&(o.companions=o.companions.map(O))}h===o.player.id&&o.player.archetype==="HUNTER"&&i.source&&fa(i.source,o.player.position)!==-1&&(o.message=Ht(o.message,"You roll away!","INFO","COMBAT")),R&&R.archetype==="HUNTER"&&i.source&&fa(i.source,R.position)!==-1&&(o.message=Ht(o.message,`${R.subtype||R.id} rolls away!`,"INFO","COMBAT"))}else if(b){const R=Ng(o,b),I=i.scoreEvent?.damageClass||"physical",C=of(o,i.amount,a.sourceId,R,I,i.reason),M=C.amount;y=R?.id,A=b,v=M+f(R||void 0),o.visualEvents=[...o.visualEvents||[],{type:"vfx",payload:{type:"impact",position:b}}],i.scoreEvent&&R&&(o.combatScoreEvents=[...o.combatScoreEvents||[],{...i.scoreEvent,targetId:R.id,finalPower:M,traitOutgoingMultiplier:C.outgoing,traitIncomingMultiplier:C.incoming,traitTotalMultiplier:C.total}].slice(-500)),ne(o.player.position,b)&&(o.player=ua(o.player,M+f(o.player)),_&&(o.hazardBreaches=(o.hazardBreaches||0)+1),o.player.hp<=0);const N=O=>{if(ne(O.position,b)){const q=ua(O,M+f(O));return q.hp<=0&&(o.dyingEntities=[...o.dyingEntities||[],O],X.push(O.id),Y.push(O.position)),q}return O},Y=[],X=[];o.enemies=o.enemies.map(N).filter(O=>O.hp>0),o.companions&&(o.companions=o.companions.map(N).filter(O=>O.hp>0)),X.forEach(O=>{o=Ii(o,"DEATH_RESOLVE","Damage",{targetActorId:O,reason:i.reason||"area_damage"},{...a,targetId:O},!0,260)}),Y.forEach(O=>{o=Vl(o,O)})}v>0&&(o=Yl(o,{type:"DamageTaken",targetId:y||h||void 0,position:A,payload:{amount:v,reason:i.reason,sourceId:a.sourceId}}));break}case"Heal":{const r=y=>({...y,hp:Math.min(y.maxHp,y.hp+i.amount)}),f=i.target==="targetActor"?a.targetId:i.target;let h,b;if(f){const y=f===o.player.id?o.player:o.enemies.find(A=>A.id===f)||o.companions?.find(A=>A.id===f);if(y){const A=f===o.player.id?"You":y.subtype||y.id;if(o.message=Ht(o.message,`${A} recover ${i.amount} HP.`,"INFO","COMBAT"),f===o.player.id)o.player=r(o.player),h=o.player.id,b=o.player.position;else{const v=S=>S.id===f?r(S):S;o.enemies=o.enemies.map(v),o.companions&&(o.companions=o.companions.map(v)),h=y.id,b=y.position}}}h&&(o=Yl(o,{type:"Healed",targetId:h,position:b,payload:{amount:i.amount,sourceId:a.sourceId}}));break}case"ApplyStatus":{o=Ii(o,"STATUS_APPLY","ApplyStatus",{status:i.status,duration:i.duration,target:i.target},a,!0,160);let r="",f=null;typeof i.target=="string"?i.target==="targetActor"?r=a.targetId||"":r=i.target:f=i.target;let h=f;const b=a.sourceId?a.sourceId===o.player.id?o.player:o.enemies.find(v=>v.id===a.sourceId):void 0,y=b?Cx(i.duration,Qe(b)):i.duration;if(r){const v=r===o.player.id?o.player:o.enemies.find(S=>S.id===r)||o.companions?.find(S=>S.id===r);if(v){h=v.position;const S=r===o.player.id?"You":`${v.subtype||"enemy"}#${v.id}`,_=r===o.player.id?"are":"is";if(o.message=Ht(o.message,`${S} ${_} ${i.status}!`,"INFO","COMBAT"),r===o.player.id)o.player=Af(o.player,i.status,y);else{const p=g=>g.id===r?Af(g,i.status,y):g;o.enemies=o.enemies.map(p),o.companions&&(o.companions=o.companions.map(p))}}}i.status==="stunned"&&h&&(o.visualEvents=[...o.visualEvents||[],{type:"shake",payload:{intensity:"low"}},{type:"vfx",payload:{type:"stunBurst",position:h}},{type:"combat_text",payload:{text:"STUNNED",position:h}}]);const A=r||(h?Ng(o,h)?.id:void 0);o=Yl(o,{type:"StatusApplied",targetId:A,position:h||void 0,payload:{status:i.status,duration:y,sourceId:a.sourceId}});break}case"PickupShield":{const r=i.position||o.shieldPosition;if(r&&o.shieldPosition&&ne(o.shieldPosition,r)){o.hasShield=!0,o.shieldPosition=void 0;const f={id:"BULWARK_CHARGE",name:"Bulwark Charge",description:"Shield Bash.",slot:"utility",cooldown:3,currentCooldown:0,range:1,upgrades:[],activeUpgrades:[]};o.player.activeSkills.some(h=>h.id==="BULWARK_CHARGE")||(o.player={...o.player,activeSkills:[...o.player.activeSkills,f]})}break}case"PickupSpear":{const r=i.position||o.spearPosition;r&&o.spearPosition&&ne(o.spearPosition,r)&&(o.hasSpear=!0,o.spearPosition=void 0);break}case"SpawnItem":{if(i.itemType==="spear")o.spearPosition=i.position,a.sourceId===o.player.id&&(o.hasSpear=!1);else if(i.itemType==="bomb"){const r=o.initialSeed??o.rngSeed??"0",f=(o.turnNumber<<16)+(o.actionLog?.length??0)+o.enemies.length,h=`bomb-${Po(r,f,8,"bomb")}`,b=ma({id:h,type:"enemy",subtype:"bomb",factionId:"enemy",position:i.position,speed:10,skills:["TIME_BOMB"],weightClass:"Standard"});b.statusEffects=[{id:"TIME_BOMB",type:"time_bomb",duration:2,tickWindow:"END_OF_TURN"}],o.enemies=[...o.enemies,b]}else i.itemType==="shield"&&(o.shieldPosition=i.position,o.hasShield=!1);break}case"LavaSink":{o=Ii(o,"HAZARD_CHECK","LavaSink",{target:i.target},a,!0,240);const r=i.target,f=r===o.player.id?o.player:o.enemies.find(h=>h.id===r);f&&(o=Ii(o,"DEATH_RESOLVE","LavaSink",{targetId:r},{...a,targetId:r},!0,280),r===o.player.id?o.player=ua(o.player,99):(o.enemies=o.enemies.filter(h=>h.id!==r),o.dyingEntities=[...o.dyingEntities||[],f],o=Vl(o,f.position)),o.visualEvents=[...o.visualEvents||[],{type:"vfx",payload:{type:"vaporize",position:f.position}}]);break}case"Impact":{const r=i.target,f=r===o.player.id?o.player:o.enemies.find(h=>h.id===r);if(f&&(o.visualEvents=[...o.visualEvents||[],{type:"vfx",payload:{type:"impact",position:f.position}}],i.damage>0))if(r===o.player.id)o.player=ua(o.player,i.damage);else{const h=b=>b.id===r?ua(b,i.damage):b;o.enemies=o.enemies.map(h).filter(b=>b.hp>0),o.companions&&(o.companions=o.companions.map(h).filter(b=>b.hp>0))}break}case"Message":{o.message=[...o.message,jf(i.text,"INFO","SYSTEM")].slice(-50),o=Yl(o,{type:"MessageLogged",payload:{text:i.text}});break}case"Juice":{if(i.effect==="combat_text"&&i.text&&(o.message=Ht(o.message,i.text,"VERBOSE","SYSTEM")),i.effect==="impact"&&i.target){const r=typeof i.target=="string"?i.target===o.player.id?o.player.position:o.enemies.find(f=>f.id===i.target)?.position:i.target;r&&(o.visualEvents=[...o.visualEvents||[],{type:"vfx",payload:{type:"impact",position:r}}])}if(i.effect==="flash"&&i.target){const r=typeof i.target=="string"?i.target===o.player.id?o.player.position:o.enemies.find(f=>f.id===i.target)?.position:i.target;r&&(o.visualEvents=[...o.visualEvents||[],{type:"vfx",payload:{type:"flash",position:r}}])}if(i.effect==="spearTrail"&&i.path&&(o.visualEvents=[...o.visualEvents||[],{type:"vfx",payload:{type:"spear_trail",path:i.path}}]),i.effect==="lavaSink"&&i.target){const r=typeof i.target=="string"?i.target===o.player.id?o.player.position:o.enemies.find(f=>f.id===i.target)?.position:i.target;if(r){const f=o.enemies.find(h=>ne(h.position,r));f&&(o.dyingEntities=[...o.dyingEntities||[],f],o.enemies=o.enemies.filter(h=>!ne(h.position,r)),o.companions&&(o.companions=o.companions.filter(h=>!ne(h.position,r))),o=Vl(o,r),o.visualEvents=[...o.visualEvents||[],{type:"vfx",payload:{type:"vaporize",position:r}}])}}break}case"UpdateComponent":{const r=(f,h,b)=>{const y=new Map(f.components||[]);return y.set(h,b),{...f,components:y}};if(i.target==="self")o.player=r(o.player,i.key,i.value);else if(i.target==="targetActor"&&a.targetId)if(a.targetId===o.player.id)o.player=r(o.player,i.key,i.value);else{const f=h=>h.id===a.targetId?r(h,i.key,i.value):h;o.enemies=o.enemies.map(f),o.companions&&(o.companions=o.companions.map(f))}break}case"ModifyCooldown":{const r=h=>({...h,activeSkills:h.activeSkills?.map(b=>b.id!==i.skillId?b:{...b,currentCooldown:i.setExact?i.amount:Math.max(0,b.currentCooldown+i.amount)})}),f=a.sourceId||o.player.id;f===o.player.id?o.player=r(o.player):(o.enemies=o.enemies.map(h=>h.id===f?r(h):h),o.companions&&(o.companions=o.companions.map(h=>h.id===f?r(h):h)));break}case"SpawnCorpse":{o=Vl(o,i.position);break}case"RemoveCorpse":{o=tv(o,i.position),o.dyingEntities=(o.dyingEntities||[]).filter(r=>!ne(r.position,i.position));break}case"SpawnActor":{const r=Zl(i.actor);o.enemies=[...o.enemies,r],r.companionOf&&(o.companions=[...o.companions||[],r]),o.initiativeQueue&&(o.initiativeQueue=Dx(o.initiativeQueue,r));break}case"PlaceFire":{const r=he(i.position);c();let f=o.tiles.get(r);f?f={...f,traits:new Set(f.traits),effects:[...f.effects]}:f={baseId:"STONE",position:i.position,traits:new Set(Ho.STONE.defaultTraits),effects:[]},o.tiles.set(r,f);const h=Va.applyEffect(f,"FIRE",i.duration,1,o,a.sourceId);h.messages.length>0&&(o.message=is(o.message,h.messages,"INFO","HAZARD"));break}case"PlaceTrap":{o.traps||(o.traps=[]),o.traps=[...o.traps,{position:i.position,ownerId:i.ownerId,isRevealed:!1,cooldown:0,volatileCore:i.volatileCore,chainReaction:i.chainReaction,resetCooldown:i.resetCooldown}];break}case"RemoveTrap":{o.traps&&(i.ownerId?o.traps=o.traps.filter(r=>r.ownerId!==i.ownerId):o.traps=o.traps.filter(r=>!ne(r.position,i.position)));break}case"SetTrapCooldown":{o.traps&&(o.traps=o.traps.map(r=>i.ownerId&&r.ownerId!==i.ownerId||!ne(r.position,i.position)?r:{...r,cooldown:Math.max(0,i.cooldown)}));break}case"SetStealth":{const r=f=>({...f,stealthCounter:(f.stealthCounter||0)+i.amount});i.target==="self"?o.player=r(o.player):(o.enemies=o.enemies.map(f=>f.id===i.target?r(f):f),o.companions&&(o.companions=o.companions.map(f=>f.id===i.target?r(f):f)));break}case"UpdateCompanionState":{const r=i.target==="self"?a.sourceId||o.player.id:i.target,f=h=>h.id!==r?h:{...h,companionState:{...h.companionState,mode:i.mode||h.companionState?.mode,markTarget:i.markTarget!==void 0?i.markTarget:h.companionState?.markTarget,orbitStep:i.mode==="scout"?0:h.companionState?.orbitStep,apexStrikeCooldown:i.apexStrikeCooldown!==void 0?i.apexStrikeCooldown:h.companionState?.apexStrikeCooldown,healCooldown:i.healCooldown!==void 0?i.healCooldown:h.companionState?.healCooldown}};o.enemies=o.enemies.map(f),o.companions&&(o.companions=o.companions.map(f));break}case"GameOver":{o.gameStatus="lost";break}}return o},yi=(e,i,a={})=>{const o=e.stackTrace?.length||0,c=Mg(e,i,{apply:(b,y)=>wf(b,y,a),describe:b=>b.type,preserveInputOrder:!0,startTick:o+1});let r=c.state,f=[...e.stackTrace||[],...c.trace];const h=vx(r);if(h.length>0){const b=Mg(r,h,{apply:(y,A)=>wf(y,A,{}),describe:y=>y.type,preserveInputOrder:!0,startTick:f.length+1});r=b.state,f=[...f,...b.trace]}return{...r,stackTrace:f}},ov={id:"grapple_hook",name:"Grapple Hook",description:"Tests for grapple hook mechanics including LoS, lava sinking, and weight-based behavior",scenarios:[{id:"hook_lava_intercept",title:"Lava Interceptor & LoS",description:"Verify LoS blocking and Lava killing targets.",relatedSkills:["GRAPPLE_HOOK"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["lava","line-of-sight","displacement"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},["GRAPPLE_HOOK"]),e.spawnEnemy("footman",{q:4,r:4,s:-8},"target1"),e.spawnEnemy("footman",{q:7,r:3,s:-10},"hidden"),e.setTile({q:6,r:4,s:-10},"wall"),e.setTile({q:4,r:5,s:-9},"lava")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:7,r:3,s:-10}),e.useSkill("GRAPPLE_HOOK",{q:4,r:4,s:-8}),e.wait(),e.wait()},verify:(e,i)=>{const a=e.player,o=e.enemies.find(r=>r.id==="target1"),c={playerInOriginalPosition:a.position.q===4&&a.position.r===6&&a.position.s===-10,target1Dead:!o,losWarning:i.some(r=>r.includes("Line of sight"))};return Object.values(c).some(r=>r===!1)&&(console.log(" Scenario Failed Details:",c),console.log("Logs:",i)),Object.values(c).every(r=>r===!0)}},{id:"hook_wall_anchor_zip",title:"Heavy Zip to Wall",description:"Verify zipping to a wall and stunning nearby enemies.",relatedSkills:["GRAPPLE_HOOK"],category:"movement",difficulty:"beginner",isTutorial:!0,tags:["wall","displacement","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["GRAPPLE_HOOK"]),e.setTile({q:6,r:3,s:-9},"wall"),e.spawnEnemy("footman",{q:5,r:4,s:-9},"blocker"),e.setTile({q:6,r:6,s:-12},"wall"),e.setTile({q:5,r:6,s:-11},"lava"),e.spawnEnemy("footman",{q:6,r:5,s:-11},"stunMe"),e.spawnEnemy("footman",{q:7,r:5,s:-12},"noStun")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:6,r:3,s:-9}),e.useSkill("GRAPPLE_HOOK",{q:6,r:6,s:-12})},verify:(e,i)=>{const a=e.enemies.find(r=>r.id==="stunMe"),o=e.enemies.find(r=>r.id==="noStun"),c={stunnedEnemy:!!(a&&a.statusEffects.some(r=>r.type==="stunned")),safeEnemy:!!(o&&!o.statusEffects.some(r=>r.type==="stunned")),zipLog:i.some(r=>r.includes("Zipped")),lavaSinkLog:i.some(r=>r.includes("Lava Sink"))};return Object.values(c).some(r=>r===!1)&&(console.log(" Scenario Failed Details:",c),console.log("Player Pos:",e.player.position),console.log("Victim Status:",a?.statusEffects)),Object.values(c).every(r=>r===!0)}}]},lv={id:"shield_throw",name:"Shield Throw",description:"Tests for shield throw mechanics including push, stun, and collision behavior",scenarios:[{id:"shield_stun_push",title:"Standard Push",description:"Verify 4-tile push in a straight line.",relatedSkills:["SHIELD_THROW"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["push","displacement","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_THROW"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>e.useSkill("SHIELD_THROW",{q:3,r:5,s:-8}),verify:(e,i)=>{const a=e.enemies.find(c=>c.id==="victim"),o={victimAt1:a?.position.r===1,victimStunned:i?.some(c=>c.includes("stunned"))};return Object.values(o).some(c=>c===!1)&&(console.log(" Shield Throw Failed:",o),console.log("Enemy Pos:",a?.position),console.log("Logs:",i)),Object.values(o).every(c=>c===!0)}},{id:"shield_unit_collision",title:"Unit Collision",description:"Verify push stops when hitting another unit.",relatedSkills:["SHIELD_THROW"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["collision","lava","push","environmental-kill"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_THROW"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim"),e.spawnEnemy("shieldbearer",{q:3,r:3,s:-6},"obstacle"),e.setTile({q:3,r:1,s:-4},"lava")},run:e=>e.useSkill("SHIELD_THROW",{q:3,r:5,s:-8}),verify:(e,i)=>{const a=e.enemies.find(r=>r.id==="victim"),o=e.enemies.find(r=>r.id==="obstacle"),c={victimPushed:(a?.position.r??5)===3,obstacleDead:!o};return Object.values(c).some(r=>r===!1)&&(console.log(" Shield Throw Failed:",c),console.log("Victim Pushed:",c.victimPushed),console.log("Victim Pos:",a?.position),console.log("Obstacle Dead:",c.obstacleDead),console.log("Logs:",i)),Object.values(c).every(r=>r===!0)}}]},rv={id:"auto_attack",name:"Auto Attack",description:"Tests for auto-attack passive skill including turn-start memory and friendly fire logic",scenarios:[{id:"auto_attack_persistence_stress_test",title:"Persistence: Three-Point Validation",description:"Verifies that Auto-Attack only hits units that were adjacent at BOTH start and end.",relatedSkills:["AUTO_ATTACK","BASIC_MOVE"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["passive","spatial-memory","edge-case"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["AUTO_ATTACK","BASIC_MOVE"]),e.spawnEnemy("footman",{q:5,r:5,s:-10},"persistent_foe"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"new_neighbor"),e.spawnEnemy("footman",{q:5,r:4,s:-9},"former_neighbor"),e.state.player.previousPosition={q:4,r:5,s:-9}},run:e=>{e.move({q:4,r:6,s:-10})},verify:(e,i)=>{const a=e.enemies.find(f=>f.id==="persistent_foe"),o=e.enemies.find(f=>f.id==="new_neighbor"),c=e.enemies.find(f=>f.id==="former_neighbor"),r={persistentDead:!a||a.hp<a.maxHp,ignoredNew:o&&o.hp===o.maxHp,ignoredFormer:c&&c.hp===c.maxHp,logFound:i.some(f=>f.includes("attacked footman"))};return Object.values(r).some(f=>f===!1)&&(console.log(" Scenario Failed Details:",r),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",i)),Object.values(r).every(f=>f===!0)}},{id:"enemy_auto_attack_no_friendly_fire",title:"Enemy Auto-Attack: Team Alignment",description:"Ensures enemy passives only target the player and not their own allies.",relatedSkills:["AUTO_ATTACK"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["passive","alignment","friendly-fire"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},[]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"enemy_attacker");const i=e.state.enemies.find(a=>a.id==="enemy_attacker");i&&(i.activeSkills=[{id:"AUTO_ATTACK",range:1}],i.previousPosition={q:3,r:5,s:-8}),e.spawnEnemy("shieldBearer",{q:2,r:6,s:-8},"enemy_ally"),i.previousPosition={q:3,r:5,s:-8},e.state.player.previousPosition={q:3,r:6,s:-9}},run:e=>{e.wait()},verify:(e,i)=>{const a=e.player,o=e.enemies.find(r=>r.id==="enemy_ally"),c={playerHit:a.hp<a.maxHp,allySafe:o&&o.hp===o.maxHp,hitPlayerLog:i.some(r=>r.includes("attacked you")),hitAllyLog:!i.some(r=>r.includes("attacked enemy_ally"))};return Object.values(c).some(r=>r===!1)&&(console.log(" Scenario Failed Details:",c),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",i)),Object.values(c).every(r=>r===!0)}}]},cv={id:"integration",name:"Integration Tests",description:"Multi-skill integration scenarios testing complex interactions",scenarios:[{id:"environmental_chain_reaction",title:"Environmental Chain Reaction",description:"Test complex environmental interactions with multiple hazards",relatedSkills:["GRAPPLE_HOOK","SHIELD_THROW"],category:"hazards",difficulty:"advanced",isTutorial:!1,tags:["lava","wall","environmental-kill","chain-reaction"],setup:e=>{e.setPlayer({q:5,r:4,s:-9},["GRAPPLE_HOOK","SHIELD_THROW"]),e.spawnEnemy("shieldbearer",{q:5,r:2,s:-7},"victim1"),e.spawnEnemy("footman",{q:5,r:6,s:-11},"victim2"),e.spawnEnemy("footman",{q:5,r:7,s:-12},"victim3"),e.setTile({q:5,r:8,s:-13},"lava")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:5,r:2,s:-7}),e.useSkill("SHIELD_THROW",{q:5,r:5,s:-10})},verify:(e,i)=>{const a=e.player.position.q===5&&e.player.position.r===3,o=!e.enemies.find(y=>y.id==="victim3")||!!e.dyingEntities?.find(y=>y.id==="victim3"),c=!e.enemies.find(y=>y.id==="victim2")||!!e.dyingEntities?.find(y=>y.id==="victim2"),r=e.enemies.find(y=>y.id==="victim1"),f=r&&i.some(y=>y.includes("stunned")),h=r&&r.position.q===5&&r.position.r===6,b=[a,o,c,f,h];return Object.values(b).some(y=>y===!1)&&(console.log(" Environmental Chain Reaction Failed:",b),console.log("Player at 5,3:",a),console.log("Player Pos:",e.player.position),console.log("Logs found:",i),console.log("Victim1 at 5,6:",h),console.log("Victim1 Pos:",r?.position),console.log("Victim1 Stunned:",f),console.log("Victim2 Dead:",c),console.log("Victim3 Dead:",o)),Object.values(b).every(y=>y===!0)}},{id:"auto_attack_after_grapple",title:"Auto-Attack After Grapple",description:"Verify auto-attack triggers correctly after grapple displacement",relatedSkills:["GRAPPLE_HOOK","AUTO_ATTACK"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["passive","displacement","integration"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["GRAPPLE_HOOK","AUTO_ATTACK"]),e.state.player.previousPosition={q:4,r:6,s:-10},e.spawnEnemy("footman",{q:7,r:6,s:-13},"grappleHookTarget"),e.spawnEnemy("footman",{q:3,r:5,s:-8},"safe"),e.spawnEnemy("footman",{q:4,r:5,s:-9},"auto-attacked"),e.spawnEnemy("footman",{q:5,r:5,s:-10},"safe2")},run:e=>{e.useSkill("GRAPPLE_HOOK",{q:7,r:6,s:-13})},verify:(e,i)=>{const a=e.enemies.find(h=>h.id==="grappleHookTarget"),o=e.enemies.find(h=>h.id==="auto-attacked"),c=e.enemies.find(h=>h.id==="safe"),r=e.enemies.find(h=>h.id==="safe2"),f={targetPulled:!!(a&&a.position.q<7),targetNotHit:!!(a&&a.hp===a.maxHp),safeNotHit:!!(c&&c.hp===c.maxHp),safe2NotHit:!!(r&&r.hp===r.maxHp),autoattackedDead:!o||o.hp<=0};return Object.values(f).some(h=>h===!1)&&(console.log(" Scenario Failed Details:",f),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",i),console.log("target Pos:",a?.position.q),console.log("target Pulled:",f.targetPulled),console.log("target Not Hit:",f.targetNotHit),console.log("safe Not Hit:",f.safeNotHit),console.log("safe2 Not Hit:",f.safe2NotHit),console.log("autoattacked Dead:",f.autoattackedDead)),Object.values(f).every(h=>h===!0)}}]},uv="modulepreload",dv=function(e){return"/Hop/"+e},Rg={},fv=function(i,a,o){let c=Promise.resolve();if(a&&a.length>0){let y=function(A){return Promise.all(A.map(v=>Promise.resolve(v).then(S=>({status:"fulfilled",value:S}),S=>({status:"rejected",reason:S}))))};var f=y;document.getElementsByTagName("link");const h=document.querySelector("meta[property=csp-nonce]"),b=h?.nonce||h?.getAttribute("nonce");c=y(a.map(A=>{if(A=dv(A),A in Rg)return;Rg[A]=!0;const v=A.endsWith(".css"),S=v?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${A}"]${S}`))return;const _=document.createElement("link");if(_.rel=v?"stylesheet":uv,v||(_.as="script"),_.crossOrigin="",_.href=A,b&&_.setAttribute("nonce",b),document.head.appendChild(_),v)return new Promise((p,g)=>{_.addEventListener("load",p),_.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${A}`)))})}))}function r(h){const b=new Event("vite:preloadError",{cancelable:!0});if(b.payload=h,window.dispatchEvent(b),!b.defaultPrevented)throw h}return c.then(h=>{for(const b of h||[])b.status==="rejected"&&r(b.reason);return i().catch(r)})},mv=async(e,i)=>{if(typeof window>"u")try{(await fv(()=>import("./__vite-browser-external-BIHI7g3E.js"),[])).appendFileSync(e,i)}catch(a){console.warn(`Failed to persist log to ${e}:`,a)}},pv={id:"basic_attack",name:"Basic Attack",description:"Tests for basic melee attack mechanics including range and move-to-attack logic",scenarios:[{id:"basic_attack_player_mechanics",title:"Player Basic Attack: Range & Bump",description:"Validates range enforcement, turn accounting, and bump-attack redirection.",relatedSkills:["BASIC_ATTACK"],category:"combat",tags:["melee","targeting","bump-attack"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BASIC_ATTACK"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"adj_victim"),e.spawnEnemy("footman",{q:3,r:4,s:-7},"far_victim")},run:e=>{e.useSkill("BASIC_ATTACK",{q:3,r:4,s:-7}),e.move({q:3,r:5,s:-8})},verify:(e,i)=>{const a=e.enemies.find(r=>r.id==="adj_victim"),o=e.enemies.find(r=>r.id==="far_victim"),c={farStaysAlive:o&&o.hp===o.maxHp,rangeError:i.some(r=>r.includes("out of range")),adjTookDamage:!a||a.hp<=a.maxHp,playerPositionHeld:ne(e.player.position,{q:3,r:6,s:-9}),oneTurnConsumed:e.turnsSpent===1};if(Object.values(c).some(r=>r===!1)){const r=` Basic Attack Failed: ${JSON.stringify(c)}
Current Player Pos: ${JSON.stringify(e.player.position)}
Logs: ${JSON.stringify(i)}
`;console.log(r),mv("integration_debug.txt",r)}return Object.values(c).every(r=>r===!0)}}]},hv={id:"spear_throw",name:"Spear Throw",description:"Tests for spear throw mechanics including range, LoS, and spear retrieval",scenarios:[{id:"spear_kill",title:"Spear Kill",description:"Throw spear to kill an enemy and verify item spawn.",relatedSkills:["SPEAR_THROW"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["projectile","combat","item-spawn"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SPEAR_THROW"]),e.spawnEnemy("footman",{q:3,r:4,s:-7},"target"),e.state.hasSpear=!0},run:e=>{e.useSkill("SPEAR_THROW",{q:3,r:4,s:-7})},verify:(e,i)=>{const a=!e.enemies.find(r=>r.id==="target"),o=!!e.spearPosition&&e.spearPosition.q===3&&e.spearPosition.r===4,c=i.some(r=>r.includes("Spear killed"));return a&&o&&c}},{id:"spear_miss_spawn",title:"Spear Rejects Empty Tile",description:"Enemy-only contract: empty tiles are invalid targets and do not spawn spear.",relatedSkills:["SPEAR_THROW"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["projectile","item-spawn"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SPEAR_THROW"]),e.state.hasSpear=!0},run:e=>{e.useSkill("SPEAR_THROW",{q:3,r:4,s:-7})},verify:(e,i)=>{const a=i.some(c=>c.includes("No enemy at target.")),o=e.hasSpear===!0&&!e.spearPosition;return a&&o}},{id:"spear_wall_block",title:"Spear Wall Block",description:"Spear throw is blocked by walls.",relatedSkills:["SPEAR_THROW"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["projectile","wall","boundary"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["SPEAR_THROW"]),e.spawnEnemy("footman",{q:4,r:3,s:-7},"target"),e.setTile({q:4,r:4,s:-8},"wall"),e.state.hasSpear=!0},run:e=>{e.useSkill("SPEAR_THROW",{q:4,r:3,s:-7})},verify:(e,i)=>{const a=i.some(r=>r.includes("No clear line of sight to enemy.")),o=!!e.enemies.find(r=>r.id==="target"),c=e.hasSpear===!0&&!e.spearPosition;return a&&o&&c}}]},gv={id:"dash",name:"Dash",description:"Tests for dash mechanics including path validation and shield-based enemy shunting",scenarios:[{id:"dash_shunt_lava",title:"Shunt into Lava",description:"Shunt an enemy into lava for an environmental kill.",relatedSkills:["DASH"],category:"hazards",difficulty:"intermediate",isTutorial:!1,tags:["lava","push","environmental-kill"],setup:e=>{e.setPlayer({q:3,r:5,s:-8},["DASH"]),e.spawnEnemy("footman",{q:5,r:5,s:-10},"victim"),e.setTile({q:7,r:5,s:-12},"lava"),e.state.hasShield=!0},run:e=>{e.useSkill("DASH",{q:5,r:5,s:-10})},verify:(e,i)=>{const a=e.enemies.find(c=>c.id==="victim"),o={playerPosition:e.player.position.q===5&&e.player.position.r===5,victimDead:!a};return Object.values(o).some(c=>c===!1)&&(console.log(" Dash Shunt Lava Failed:",o),console.log("Final State:",e.player.position),console.log("Victim Pos:",a?.position),console.log("Logs:",i)),Object.values(o).every(c=>c===!0)}},{id:"dash_comprehensive_validation",title:"Dash: Constraints & Shunt Physics",description:"Validates range limits, wall blocking, and Shield Shunt displacement in one sequence.",relatedSkills:["DASH"],category:"movement",difficulty:"advanced",isTutorial:!1,tags:["stress-test","collision","range"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["DASH"]),e.state.hasShield=!0,e.setTile({q:4,r:4,s:-8},"wall"),e.setTile({q:6,r:5,s:-11},"wall"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"victim")},run:e=>{e.useSkill("DASH",{q:4,r:7,s:-11}),e.useSkill("DASH",{q:7,r:4,s:-11}),e.useSkill("DASH",{q:6,r:6,s:-12}),e.useSkill("DASH",{q:4,r:5,s:-9})},verify:(e,i)=>{const a=e.enemies.find(c=>c.id==="victim"),o={finalPositionCorrect:e.player.position.q===4&&e.player.position.r===6,victimPushed:!!(a&&a.position.q===4&&a.position.r===5),wallErrorFound:i.some(c=>c.includes("wall blocks")),axialRangeErrorFound:i.some(c=>c.includes("Axial only!")),shuntSuccess:i.some(c=>c.includes("Shield Shunt")),twoTurnSpent:e.turnsSpent===2};return Object.values(o).some(c=>c===!1)&&(console.log(" Dash Stress Test Failed:",o),console.log("Final State:",e.player.position),console.log("Victim Pos:",a?.position),console.log("Logs:",i)),Object.values(o).every(c=>c===!0)}}]},yv={id:"jump",name:"Jump",description:"Tests for jump mechanics including range validation and stunning landing",scenarios:[{id:"jump_basic",title:"Basic Jump",description:"Jump to a tile.",relatedSkills:["JUMP"],category:"movement",difficulty:"beginner",isTutorial:!0,tags:["movement","leap"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["JUMP"]),e.setTile({q:3,r:5,s:-8},"lava")},run:e=>{e.useSkill("JUMP",{q:3,r:4,s:-7})},verify:(e,i)=>{const a=ne(e.player.position,{q:3,r:4,s:-7}),o=vf(e.occupancyMask,{q:3,r:4}),c=!vf(e.occupancyMask,{q:3,r:6}),r={playerInPosition:a,spatialMaskRefreshed:o&&c,noLavaDamage:e.player.hp===e.player.maxHp,jumpedSuccessfully:i.some(f=>f.includes("Jumped"))};return Object.values(r).some(f=>f===!1)&&(console.error(" Jump Basic Failed:",r),console.error("Final State:",e.player.position),console.error("Logs:",i)),Object.values(r).every(f=>f===!0)}},{id:"jump_stunning_landing",title:"Stunning Landing",description:"Jump into a group of enemies and ensure neighbors are stunned.",relatedSkills:["JUMP"],category:"movement",difficulty:"intermediate",isTutorial:!0,tags:["movement","stun","aoe"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["JUMP"]),e.addUpgrade("JUMP","STUNNING_LANDING"),e.spawnEnemy("footman",{q:3,r:7,s:-10},"neighbor_1"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"neighbor_2"),e.spawnEnemy("footman",{q:3,r:5,s:-8},"distant_enemy")},run:e=>{e.useSkill("JUMP",{q:3,r:8,s:-11})},verify:(e,i,a=[])=>{const o={n1StunnedMessage:i.some(c=>c.includes("stunned by landing impact")),hasShakeJuice:a.some(c=>c.type==="shake"),hasStunBurstVFX:a.some(c=>c.type==="vfx"&&c.payload.type==="stunBurst"),hasStunnedCombatText:a.some(c=>c.type==="combat_text"&&c.payload.text==="STUNNED"),playerAtTarget:ne(e.player.position,{q:3,r:8,s:-11}),oneTurnSpent:e.turnsSpent===1};return Object.values(o).some(c=>c===!1)&&(console.error(" Jump Stunning Landing Failed:",o),console.error("Final State:",e.player.position),console.error("turnsSpent:",e.turnsSpent),console.error("Logs:",i)),Object.values(o).every(c=>c===!0)}}]},bv={id:"shield_bash",name:"Shield Bash",description:"Tests for shield bash mechanics including push, stun, and collision behavior",scenarios:[{id:"bash_push",title:"Shield Push",description:"Push an enemy into lava.",relatedSkills:["SHIELD_BASH"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["push","displacement","lava"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_BASH"]),e.setTile({q:3,r:4,s:-7},"lava"),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>{e.useSkill("SHIELD_BASH",{q:3,r:5,s:-8})},verify:(e,i)=>{const a={enemyGone:e.enemies.length===0,messageOk:i.some(o=>o.includes("Lava"))};return Object.values(a).some(o=>o===!1)&&(console.log(" Scenario Failed Details:",a),console.log("Current Player Pos:",e.player.position),console.log("Logs found:",i)),Object.values(a).every(o=>o===!0)}},{id:"bash_wall_stun",title:"Wall Slam Stun",description:"Bash enemy into wall to cause a stun.",relatedSkills:["SHIELD_BASH"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["collision","wall","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SHIELD_BASH"]),e.spawnEnemy("shieldBearer",{q:3,r:5,s:-8},"victim"),e.setTile({q:3,r:4,s:-7},"wall")},run:e=>{e.useSkill("SHIELD_BASH",{q:3,r:5,s:-8})},verify:(e,i)=>{const a=e.enemies.find(r=>r.id==="victim");if(!a)return!1;const o=ne(a.position,{q:3,r:5,s:-8}),c=i.some(r=>r.includes("into obstacle"));return o&&c}}]},xv={id:"bulwark_charge",name:"Bulwark Charge",description:"Tests for bulwark charge mechanics including chain pushing and wall slamming",scenarios:[{id:"chain_stun",title:"The Chain-Stun",description:"Wall prevents chain movement, causing all members to be stunned.",relatedSkills:["BULWARK_CHARGE"],category:"combat",difficulty:"intermediate",isTutorial:!0,tags:["chain","wall","stun"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BULWARK_CHARGE"]),e.spawnEnemy("shieldBearer",{q:3,r:5,s:-8},"A"),e.spawnEnemy("shieldBearer",{q:3,r:4,s:-7},"B"),e.setTile({q:3,r:3,s:-6},"wall"),e.state.hasShield=!0},run:e=>{e.useSkill("BULWARK_CHARGE",{q:3,r:5,s:-8})},verify:(e,i)=>!0},{id:"bulwark_chain_push",title:"Bulwark Chain Push",description:"Push a chain of enemies successfully.",relatedSkills:["BULWARK_CHARGE"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["chain","push","displacement"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BULWARK_CHARGE"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"A"),e.spawnEnemy("footman",{q:3,r:4,s:-7},"B"),e.state.hasShield=!0},run:e=>{e.useSkill("BULWARK_CHARGE",{q:3,r:5,s:-8})},verify:(e,i)=>!0}]},vv={id:"vault",name:"Vault",description:"Tests for vault mechanics including state-shifting behavior between odd and even turns",scenarios:[{id:"vault_shift_stun",title:"Vault Stun (Odd Turn)",description:"Verify vault stuns neighbors on Turn 1.",relatedSkills:["VAULT"],category:"movement",difficulty:"intermediate",isTutorial:!0,tags:["state-shift","stun","movement"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.setTile({q:3,r:5,s:-8},"lava"),e.spawnEnemy("footman",{q:4,r:4,s:-8},"victim")},run:e=>{e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,i)=>{const a={stunned:i.some(o=>o.includes("Stun Vault executed!"))};return Object.values(a).some(o=>o===!1)&&(console.log(" Vault Stun Failed:",a),console.log("Logs:",i)),Object.values(a).every(o=>o===!0)}},{id:"vault_shift_normal",title:"Vault Normal (Even Turn)",description:"Verify vault is normal on Turn 2.",relatedSkills:["VAULT"],category:"movement",difficulty:"intermediate",isTutorial:!0,tags:["state-shift","movement"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.setTile({q:3,r:5,s:-8},"lava"),e.spawnEnemy("footman",{q:4,r:3,s:-7},"victim")},run:e=>{e.wait(),e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,i)=>{const a={vaulted:i.some(o=>o.includes("Vaulted!"))};return Object.values(a).some(o=>o===!1)&&(console.log(" Vault Normal Failed:",a),console.log("Logs:",i)),Object.values(a).every(o=>o===!0)}}]},Sv={id:"basic_move",name:"Basic Move",description:"Fundamental movement mechanics",scenarios:[{id:"walk_to_tile",title:"Movement 101",description:"Move your character from the center to an adjacent tile.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"beginner",isTutorial:!0,tags:["movement","basics"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"]),e.setTile({q:4,r:6,s:-10},"wall")},run:e=>{e.move({q:4,r:6,s:-10}),e.move({q:4,r:4,s:-8})},verify:(e,i)=>{const a={positionCorrect:ne(e.player.position,{q:4,r:4,s:-8}),logFound:i.some(o=>o.includes("blocked")),oneTurnSpent:e.turnsSpent===1};return Object.values(a).some(o=>o===!1)&&(console.log(" Scenario Failed Details:",a),console.log("Final Position:",e.player.position),console.log("Logs found:",i)),Object.values(a).every(o=>o===!0)}},{id:"free_move_out_of_combat",title:"Exploration Mode",description:"Verify that movement range expands only when no enemies are present.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"beginner",isTutorial:!1,tags:["movement","exploration","free-move"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE","BASIC_ATTACK"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"adj_victim")},run:e=>{e.move({q:7,r:1,s:-8}),e.useSkill("BASIC_ATTACK",{q:3,r:5,s:-8}),e.move({q:7,r:1,s:-8})},verify:(e,i)=>{const a=i.filter(r=>r.toLowerCase().includes("out of reach")).length,o=i.some(r=>r.toLowerCase().includes("you attacked")),c={wasBlockedInitially:a===1,attackLogs:o,reachedDistantHex:ne(e.player.position,{q:7,r:1,s:-8})};return Object.values(c).some(r=>r===!1)&&(console.log(" Free Move Scenario Failed:",c),console.log("Final Position:",e.player.position),console.log("Logs found:",i)),Object.values(c).every(r=>r===!0)}},{id:"invalid_enemy_move_intent_is_rejected_pre_execution",title:"Move Intent Rejected Before Execution",description:"Enemy AI may decide to move, but execution must not run a skill the actor does not own.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["movement","validation","intent"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:7,r:5,s:-12},"attacker_without_move");const i=e.getEnemy("attacker_without_move");i&&(i.activeSkills=(i.activeSkills||[]).filter(a=>a.id!=="BASIC_MOVE"))},run:e=>{e.wait()},verify:(e,i)=>{const a=e.enemies.find(c=>c.id==="attacker_without_move"),o={enemyDidNotMove:!!a&&ne(a.position,{q:7,r:5,s:-12}),noMissingSkillRuntimeError:!i.some(c=>c.includes("does not have skill BASIC_MOVE"))};return Object.values(o).some(c=>c===!1)&&(console.log("Invalid Enemy Move Intent Rejection Failed:",o),console.log("Enemy:",a),console.log("Logs:",i)),Object.values(o).every(c=>c===!0)}},{id:"single_enemy_single_action_per_turn",title:"Single Action Per Actor Turn",description:"Each actor resolves exactly one action per turn in normal flow.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["turn-loop","movement","integrity"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:7,r:5,s:-12},"single_actor")},run:e=>{e.wait()},verify:(e,i)=>{const a={q:7,r:5,s:-12},o=e.enemies.find(f=>f.id==="single_actor"),c=o?Ce(a,o.position):-1,r={enemyExists:!!o,movedExactlyOneTile:c===1,noZeroEffectMoveWarning:!i.some(f=>f.includes("produced ZERO effects"))};return Object.values(r).some(f=>f===!1)&&(console.log("Single Action Per Actor Turn Failed:",r),console.log("Enemy:",o),console.log("Logs:",i)),Object.values(r).every(f=>f===!0)}}]},ra=e=>{const a={BASIC_MOVE:{slot:"passive",range:1,cooldown:0,name:"Walk",description:"Move to adjacent tile."},BASIC_ATTACK:{slot:"passive",range:1,cooldown:0,name:"Basic Attack",description:"Strike adjacent target."},SENTINEL_TELEGRAPH:{slot:"offensive",range:3,cooldown:0,name:"Sentinel Telegraph",description:"Marks blast zone."},SENTINEL_BLAST:{slot:"offensive",range:3,cooldown:0,name:"Sentinel Blast",description:"Massive area blast."}}[e]||{slot:"offensive",range:1,cooldown:0,name:e,description:e};return{id:e,name:a.name,description:a.description,slot:a.slot,cooldown:a.cooldown,currentCooldown:0,range:a.range,upgrades:[],activeUpgrades:[]}},Av={id:"sentinel_blast",name:"Sentinel Blast",description:"Sentinel unique area-of-effect attack",scenarios:[{id:"blast_aoe",title:"Blast Away",description:"Use Sentinel Blast to hit multiple enemies.",relatedSkills:["SENTINEL_BLAST"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["aoe","damage","sentinel"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["SENTINEL_BLAST"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"center"),e.spawnEnemy("footman",{q:4,r:4,s:-8},"side")},run:e=>{e.useSkill("SENTINEL_BLAST",{q:3,r:5,s:-8})},verify:(e,i)=>i.some(a=>a.includes("massive blast"))},{id:"sentinel_playlist_two_turn_timing",title:"Playlist: Telegraph then Execute",description:"Boss uses a 2-turn skill playlist: telegraph first, blast on next turn.",relatedSkills:["SENTINEL_TELEGRAPH","SENTINEL_BLAST"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["boss","playlist","telegraph"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("sentinel",{q:4,r:2,s:-6},"boss");const i=e.getEnemy("boss");i&&(i.activeSkills=[ra("BASIC_MOVE"),ra("BASIC_ATTACK"),ra("SENTINEL_TELEGRAPH"),ra("SENTINEL_BLAST")])},run:e=>{e.wait(),e.logs.push(`HP_AFTER_TELEGRAPH=${e.state.player.hp}`),e.wait()},verify:(e,i)=>{const a=i.find(r=>r.startsWith("HP_AFTER_TELEGRAPH=")),o=a?Number(a.split("=")[1]):-1,c={telegraphEmitted:i.some(r=>r.includes("marks the impact zone")),executeEmitted:i.some(r=>r.includes("massive blast")),noDamageOnTelegraphTurn:o===e.player.maxHp,damageOnExecuteTurn:e.player.hp<e.player.maxHp};return Object.values(c).some(r=>r===!1)&&(console.log("Sentinel Playlist Timing Failed:",c),console.log("Logs:",i),console.log("Player HP:",e.player.hp,"/",e.player.maxHp)),Object.values(c).every(r=>r===!0)}},{id:"sentinel_playlist_interruption_by_stun",title:"Playlist: Interruption Cancels Execute",description:"Stunning the boss during telegraph cancels the follow-up execute turn.",relatedSkills:["SENTINEL_TELEGRAPH","SENTINEL_BLAST"],category:"combat",difficulty:"advanced",isTutorial:!1,tags:["boss","playlist","interruption","stun"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("sentinel",{q:4,r:2,s:-6},"boss");const i=e.getEnemy("boss");i&&(i.activeSkills=[ra("BASIC_MOVE"),ra("BASIC_ATTACK"),ra("SENTINEL_TELEGRAPH"),ra("SENTINEL_BLAST")])},run:e=>{e.wait(),e.applyStatus("boss","stunned",1),e.wait()},verify:(e,i)=>{const a=e.enemies.find(c=>c.id==="boss"),o={telegraphEmitted:i.some(c=>c.includes("marks the impact zone")),executeCancelled:!i.some(c=>c.includes("massive blast")),playerUnharmed:e.player.hp===e.player.maxHp,bossStillExists:!!a};return Object.values(o).some(c=>c===!1)&&(console.log("Sentinel Playlist Interruption Failed:",o),console.log("Logs:",i),console.log("Player HP:",e.player.hp,"/",e.player.maxHp),console.log("Boss:",a)),Object.values(o).every(c=>c===!0)}}]},Tv={id:"fireball",name:"Fireball",description:"Validates axial targeting, AoE damage, and environmental fire placement.",scenarios:[{id:"fireball_axial_aoe",title:"Axial Alignment & AoE Spread",description:"Verify the skill only fires axially and damages all neighbors at the impact site.",relatedSkills:["FIREBALL"],category:"combat",difficulty:"beginner",isTutorial:!1,tags:["aoe","axial","fire"],setup:e=>{e.setPlayer({q:3,r:6,s:-9},["FIREBALL"]),e.spawnEnemy("footman",{q:5,r:4,s:-9},"primary_target"),e.spawnEnemy("footman",{q:6,r:4,s:-10},"neighbor_target"),e.spawnEnemy("footman",{q:6,r:5,s:-11},"diagonal_enemy"),e.setTile({q:6,r:3,s:-9},"wall"),e.setTile({q:6,r:6,s:-12},"wall"),e.setTile({q:5,r:6,s:-11},"lava")},run:e=>{e.useSkill("FIREBALL",{q:7,r:5,s:-12}),e.useSkill("FIREBALL",{q:5,r:4,s:-9})},verify:()=>!0},{id:"fireball_max_range_edge",title:"Max Range & Fire Duration",description:"Verify fireball at exactly range 3 and check fire duration persistence.",relatedSkills:["FIREBALL"],category:"balancing",difficulty:"intermediate",isTutorial:!1,tags:["range","persistence"],setup:e=>{e.setPlayer({q:0,r:0,s:0},["FIREBALL"]),e.setTile({q:0,r:3,s:-3},"grass")},run:e=>{e.useSkill("FIREBALL",{q:0,r:3,s:-3}),e.wait(),e.wait()},verify:()=>!0}]},Ev={id:"hazards_v1",name:"Hazard Consolidation",description:"Verifies centralized hazard logic and flight immunity",scenarios:[{id:"Jump Over Lava",title:"Jump Over Lava",description:"Jumping over lava should not result in damage.",relatedSkills:["JUMP"],category:"hazards",tags:["lava","jump"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["JUMP"]),e.state.tiles.set("4,8",{baseId:"LAVA",position:{q:4,r:8,s:-12},traits:new Set(["HAZARDOUS","LAVA","LIQUID"]),effects:[]})},run:e=>{e.useSkill("JUMP",{q:4,r:7,s:-11})},verify:e=>{const i=e.player,a={playerPos:ne(i.position,{q:4,r:7,s:-11}),isAlive:i.hp===i.maxHp};return Object.values(a).every(o=>o===!0)}},{id:"Walk Into Lava",title:"Walk Into Lava",description:"Walking into lava should be invalid unless the mover is hazard-safe.",relatedSkills:["BASIC_MOVE"],category:"hazards",tags:["lava","walk"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["BASIC_MOVE"]),e.state.tiles.set("4,8",{baseId:"LAVA",position:{q:4,r:8,s:-12},traits:new Set(["HAZARDOUS","LAVA","LIQUID"]),effects:[]})},run:e=>{e.useSkill("BASIC_MOVE",{q:4,r:8,s:-12})},verify:e=>{const i=e.player,a={playerPos:ne(i.position,{q:4,r:9,s:-13}),hpUnchanged:i.hp===i.maxHp};return Object.values(a).every(o=>o===!0)}},{id:"Falcon Flying Over Lava",title:"Falcon Flying Over Lava",description:"Flying units (Falcon) should ignore lava during transit and stay.",relatedSkills:["FALCON_COMMAND"],category:"hazards",tags:["lava","falcon","flight"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.spawnFalcon({q:4,r:8,s:-12},"my-falcon"),e.state.tiles.set("4,8",{baseId:"LAVA",position:{q:4,r:8,s:-12},traits:new Set(["HAZARDOUS","LAVA","LIQUID"]),effects:[]})},run:e=>{e.wait()},verify:e=>{const i=e.enemies.find(o=>o.id==="my-falcon"),a={falconExists:!!i,falconAlive:(i?.hp||0)>0,falconPos:ne(i?.position,{q:4,r:8,s:-12})};return Object.values(a).every(o=>o===!0)}}]},wv={id:"falcon_command_v2",name:"Falcon's Command",description:"Validates Predator/Scout mode transitions and spatial orbit logic.",scenarios:[{id:"falcon_predator_strike_path",title:"Predator Mode: Apex Strike Geometry",description:`
                Tests the Falcon's flight path from its current position to the Target.
                Layout:
                   (F)  <- Falcon Start (6, 5, -11)
                      .
                         (T) <- Target/Prey (8, 5, -13)
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"beginner",isTutorial:!0,tags:["falcon","summon","companion"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.spawnFalcon({q:3,r:9,s:-12},"my-falcon"),e.spawnEnemy("footman",{q:4,r:2,s:-6},"prey")},run:e=>{e.useSkill("FALCON_COMMAND",{q:4,r:2,s:-6}),e.wait()},verify:(e,i)=>{const a=e.companions?.find(r=>r.id==="my-falcon"),o=e.enemies.find(r=>r.id==="prey"),c={modeSet:a?.companionState?.mode==="predator",targetLocked:a?.companionState?.markTarget==="prey",movedCloser:a&&Ce(a.position,{q:4,r:2,s:-6})<7,preyHealthy:o?.hp===o?.maxHp,turnSpent:e.turnsSpent===2};return Object.values(c).some(r=>r===!1)&&(console.log(" Scenario Falcon Predator Strike Failed:",c),console.log("Falcon:",a)),Object.values(c).every(r=>r===!0)}},{id:"falcon_scout_orbit",title:"Scout Mode: Hex Ring Orbit",description:`
                Ensures that in Scout mode, the Falcon rotates around the mark 
                on the flat-top hex ring.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"beginner",isTutorial:!0,tags:["falcon","summon","companion"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.spawnFalcon({q:3,r:9,s:-12},"my-falcon")},run:e=>{e.useSkill("FALCON_COMMAND",{q:3,r:6,s:-9}),e.wait(),e.wait()},verify:(e,i)=>{const a=e.companions?.find(r=>r.id==="my-falcon"),o={q:3,r:6,s:-9},c={isScout:a?.companionState?.mode==="scout",onOrbitRing:a&&Ce(a.position,o)===1,hasRotated:a&&!!a.previousPosition&&!ne(a.position,a.previousPosition),turnSpent:e.turnsSpent===3};return Object.values(c).some(r=>r===!1)&&(console.log(" Scenario Falcon Scout Orbit Failed:",c),console.log("Falcon:",a)),Object.values(c).every(r=>r===!0)}},{id:"falcon_roost_mode",title:"Roost Mode: Return and Heal",description:`
                Ensures that when targeting self, the Falcon returns to the Hunter
                and provides a heal on arrival.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"beginner",isTutorial:!0,tags:["falcon","roost","heal"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.state.player.hp=2,e.spawnFalcon({q:3,r:6,s:-9},"my-falcon")},run:e=>{e.useSkill("FALCON_COMMAND",{q:4,r:9,s:-13}),e.wait(),e.wait()},verify:(e,i)=>{const a=e.companions?.find(r=>r.id==="my-falcon"),o=e.player,c={modeRoost:a?.companionState?.mode==="roost",healed:o.hp>2,closeToHunter:a&&Ce(a.position,o.position)<=1};return Object.values(c).some(r=>r===!1)&&console.log(" Scenario Falcon Roost Heal Failed:",c),Object.values(c).every(r=>r===!0)}},{id:"falcon_predator_auto_return",title:"Predator Mode: Auto-Roost on Kill",description:`
                Ensures that if a marked predator target dies, the Falcon
                automatically reverts to Roost mode.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"intermediate",isTutorial:!0,tags:["falcon","predator","cleanup"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.state.player.hp=1,e.spawnFalcon({q:4,r:8,s:-12},"my-falcon"),e.spawnEnemy("footman",{q:4,r:7,s:-11},"prey")},run:e=>{e.useSkill("FALCON_COMMAND",{q:4,r:7,s:-11}),e.wait(),e.wait(),e.wait()},verify:(e,i)=>{const a=e.companions?.find(f=>f.id==="my-falcon"),o=e.enemies.find(f=>f.id==="prey"),c=e.player,r={preyDead:!o,autoRoost:a?.companionState?.mode==="roost",healed:c.hp>1};return Object.values(r).some(f=>f===!1),Object.values(r).every(f=>f===!0)}},{id:"falcon_command_metadata_null_safety",title:"Command Metadata Null-Safety",description:`
                Ensures FALCON_COMMAND name/description resolution is safe
                when player context is remapped in harness-like states.
            `,relatedSkills:["FALCON_COMMAND"],category:"summon",difficulty:"intermediate",isTutorial:!1,tags:["falcon","null-safety","metadata"],setup:e=>{e.setPlayer({q:4,r:9,s:-13},["FALCON_COMMAND"]),e.state.player.id="hunter_remapped"},run:e=>{e.wait()},verify:(e,i)=>{const a={playerIdRemapped:e.player.id==="hunter_remapped",noRuntimeReferenceError:!i.some(o=>o.toLowerCase().includes("cannot read properties"))};return Object.values(a).some(o=>o===!1)&&console.log("Falcon Command Metadata Null-Safety Failed:",a),Object.values(a).every(o=>o===!0)}}]},_v={id:"kinetic_tri_trap",name:"Kinetic Tri-Trap",description:"Tests for trap deployment and fling mechanics",scenarios:[{id:"tri_trap_basic_deployment",title:"Trap Deployment",description:"Deploy 3 traps on axial tiles at range 2.",relatedSkills:["KINETIC_TRI_TRAP"],category:"deployment",difficulty:"beginner",isTutorial:!0,tags:["trap","deployment"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["KINETIC_TRI_TRAP"]),e.state.player.archetype="HUNTER"},run:e=>{e.useSkill("KINETIC_TRI_TRAP",{q:5,r:5,s:-10})},verify:(e,i)=>{const a=e.player.position,o=e.traps||[],c={countIsThree:o.length===3,isAtRangeTwo:o.every(r=>Ce(r.position,a)===2),isAxialToPlayer:o.every(r=>r.position.q===a.q||r.position.r===a.r||r.position.s===a.s),trapsHidden:o.every(r=>!r.isRevealed)};return Object.values(c).some(r=>r===!1)&&(console.log(" Scenario Tri-Trap Deployment Failed:",c),console.log("Traps:",e.traps),console.log("Logs:",i)),Object.values(c).every(r=>r===!0)}},{id:"tri_trap_state_tracking",title:"Trap State Tracking",description:"Traps are tracked with correct owner and hidden state.",relatedSkills:["KINETIC_TRI_TRAP"],category:"state",difficulty:"intermediate",isTutorial:!1,tags:["trap","state"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["KINETIC_TRI_TRAP"]),e.state.player.archetype="HUNTER"},run:e=>{e.useSkill("KINETIC_TRI_TRAP",{q:5,r:5,s:-10}),e.useSkill("KINETIC_TRI_TRAP",{q:5,r:5,s:-10})},verify:(e,i)=>{const a=e.traps,o={trapsExist:a&&a.length>0,allHidden:a?.every(c=>!c.isRevealed)??!1,allZeroCooldown:a?.every(c=>c.cooldown===0)??!1,deployMessage:i.some(c=>c.includes("trap")||c.includes("Trap")),trapsCount:a?.length===3};return Object.values(o).some(c=>c===!1)&&(console.log(" Trap State Failed:",o),console.log("Traps:",e.traps)),Object.values(o).every(c=>c===!0)}}]},Mv={id:"withdrawal",name:"Withdrawal",description:"Tests for shot + backroll mechanics and passive reaction",scenarios:[{id:"withdrawal_basic",title:"Shot and Backroll",description:"Shoot adjacent enemy and backroll to safety.",relatedSkills:["WITHDRAWAL"],category:"combat",difficulty:"beginner",isTutorial:!0,tags:["shot","backroll","displacement"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["WITHDRAWAL"]),e.state.player.archetype="HUNTER",e.spawnEnemy("footman",{q:6,r:5,s:-11},"target")},run:e=>{e.useSkill("WITHDRAWAL",{q:6,r:5,s:-11})},verify:(e,i)=>{const a=e.enemies.find(c=>c.id==="target"),o={enemyDamagedOrDead:!a||a.hp<a.maxHp,playerMoved:e.player.position.q!==5||e.player.position.r!==5,playerBackrolled:e.player.position.q<5,shotFired:i.some(c=>c.includes("Withdrawal")||c.includes("shot"))};return Object.values(o).some(c=>c===!1)&&(console.log(" Withdrawal Failed:",o),console.log("Player:",e.player.position),console.log("Target HP:",a?.hp)),Object.values(o).every(c=>c===!0)}},{id:"withdrawal_wall_block",title:"Backroll Blocked by Wall",description:"Backroll finds alternate safe spot when wall blocks retreat.",relatedSkills:["WITHDRAWAL"],category:"collision",difficulty:"intermediate",isTutorial:!1,tags:["backroll","wall","pathfinding"],setup:e=>{e.setPlayer({q:5,r:5,s:-10},["WITHDRAWAL"]),e.state.player.archetype="HUNTER",e.setTile({q:4,r:5,s:-9},"wall"),e.setTile({q:3,r:5,s:-8},"wall"),e.spawnEnemy("footman",{q:6,r:5,s:-11},"target")},run:e=>{e.useSkill("WITHDRAWAL",{q:6,r:5,s:-11})},verify:(e,i)=>{const a={playerNotOnWall:!ne(e.player.position,{q:4,r:5,s:-9}),playerMoved:e.player.position.q!==5||e.player.position.r!==5};return Object.values(a).some(o=>o===!1)&&(console.log(" Wall Block Failed:",a),console.log("Player:",e.player.position)),Object.values(a).every(o=>o===!0)}}]},Ov={id:"absorb_fire",name:"Absorb Fire Passive",description:"Verifies that fire damage is converted to healing.",scenarios:[{id:"Absorb Fire Damage",title:"Stand on Fire",description:"Player with Absorb Fire should be healed when standing on fire.",relatedSkills:["ABSORB_FIRE"],category:"passive",tags:["fire","healing"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["ABSORB_FIRE"]),e.state.player.hp=1,e.setTile({q:4,r:5,s:-9},"stone");const i={q:4,r:5,s:-9},a=e.getTileAt(i);a&&a.effects.push({id:"FIRE",duration:3,potency:1})},run:e=>{e.wait()},verify:e=>{const i=e.player;return i.hp<=1&&console.log("Stand on Fire Failed: HP did not increase",i.hp),i.hp>1}},{id:"Absorb Lava Damage",title:"Walk into Lava",description:"Player with Absorb Fire should be healed when walking into lava.",relatedSkills:["ABSORB_FIRE","BASIC_MOVE"],category:"passive",tags:["lava","healing"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["ABSORB_FIRE","BASIC_MOVE"]),e.state.player.hp=1,e.setTile({q:4,r:6,s:-10},"lava")},run:e=>{e.useSkill("BASIC_MOVE",{q:4,r:6,s:-10})},verify:e=>{const i=e.player,a={alive:i.hp>0,healed:i.hp===i.maxHp,onLava:ne(i.position,{q:4,r:6,s:-10})};return(!a.alive||!a.healed||!a.onLava)&&(console.log("Walk into Lava Failed:",a,"HP:",i.hp,"MaxHP:",i.maxHp),console.log("Player Pos:",i.position)),Object.values(a).every(o=>o===!0)}}]},Cv={id:"tile_interactions",name:"Tile Interactions",description:"Verifies interactions with special tiles like Shrines and Stairs.",scenarios:[{id:"shrine_interaction",title:"Shrine Interaction",description:"Moving onto a shrine should trigger an upgrade choice.",relatedSkills:["BASIC_MOVE"],category:"progression",tags:["shrine","upgrade"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"]),e.state.shrinePosition={q:4,r:6,s:-10},e.state.tiles.set("4,6",{baseId:"SHRINE",position:{q:4,r:6,s:-10},traits:new Set(["INTERACTABLE","SHRINE"]),effects:[]})},run:e=>{e.move({q:4,r:6,s:-10})},verify:e=>{const i={playerOnShrine:ne(e.player.position,{q:4,r:6,s:-10}),isChoosingUpgrade:e.pendingStatus?.status==="choosing_upgrade",hasOptions:e.pendingStatus?.shrineOptions?.length>0};return Object.values(i).every(a=>a===!0)}},{id:"stairs_interaction",title:"Stairs Interaction",description:"Moving onto stairs should trigger level transition.",relatedSkills:["BASIC_MOVE"],category:"progression",tags:["stairs","portal"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"]),e.state.stairsPosition={q:4,r:6,s:-10},e.state.tiles.set("4,6",{baseId:"STAIRS",position:{q:4,r:6,s:-10},traits:new Set(["INTERACTABLE","STAIRS"]),effects:[]})},run:e=>{e.move({q:4,r:6,s:-10})},verify:e=>{const i={playerOnStairs:ne(e.player.position,{q:4,r:6,s:-10}),isTransitioning:e.pendingStatus?.status==="playing"||e.pendingStatus?.status==="won",messageFound:e.message.some(a=>a.includes("Descending")||a.includes("Cleared"))};return Object.values(i).every(a=>a===!0)}}]},Nv={id:"telegraph_projection",name:"Telegraph Projection",description:"Deterministic intent previews for next-turn danger tiles.",scenarios:[{id:"telegraph_projection_is_deterministic",title:"Projection Determinism",description:"Same state should always produce the same danger projection.",relatedSkills:["BASIC_ATTACK"],category:"telegraph",difficulty:"intermediate",isTutorial:!1,tags:["projection","determinism"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:7,r:5,s:-12},"threat")},run:e=>{e.wait()},verify:e=>{const i=e.intentPreview,a=i?.dangerTiles||[],o=i?.projections||[],c=a.map(A=>`${A.q},${A.r},${A.s}`),r=new Set(c),f=c.every((A,v)=>v===0||c[v-1].localeCompare(A)<=0),h=o.map(A=>`${A.actorId}|${A.skillId}|${A.targetHex?`${A.targetHex.q},${A.targetHex.r},${A.targetHex.s}`:"none"}`),b=h.every((A,v)=>v===0||h[v-1].localeCompare(A)<=0),y={hasEnginePreview:!!i,noDuplicateTiles:r.size===c.length,tilesAreSorted:f,projectionsAreSorted:b};return Object.values(y).some(A=>A===!1)&&(console.log("Telegraph Projection Determinism Failed:",y),console.log("Engine Preview:",i)),Object.values(y).every(A=>A===!0)}},{id:"telegraph_projection_matches_execute_footprint",title:"Projection Matches Execute Footprint",description:"Projected danger tiles should include the tile actually damaged on execution.",relatedSkills:["BASIC_ATTACK"],category:"telegraph",difficulty:"intermediate",isTutorial:!1,tags:["projection","parity","combat"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},[]),e.spawnEnemy("footman",{q:4,r:2,s:-6},"threat")},run:e=>{e.wait();const o=e.state.intentPreview?.projections?.find(c=>c.actorId==="threat")?.dangerTiles?.[0];o?e.logs.push(`PREVIEW_TILE=${o.q},${o.r},${o.s}`):e.logs.push("PREVIEW_TILE=none"),e.wait()},verify:(e,i)=>{const a=e.enemies.find(h=>h.id==="threat"),c=i.find(h=>h.startsWith("PREVIEW_TILE="))?.split("=")[1]||"none",r=c==="none"?void 0:(()=>{const[h,b,y]=c.split(",").map(A=>Number(A));return{q:h,r:b,s:y}})(),f={previewProducedTile:!!r,projectedTileMatchesExecute:!!r&&!!a&&ne(a.position,r)};return Object.values(f).some(h=>h===!1)&&(console.log("Telegraph Projection Parity Failed:",f),console.log("Logs:",i),console.log("Player HP:",e.player.hp,"/",e.player.maxHp)),Object.values(f).every(h=>h===!0)}}]},lf=e=>{const a={BASIC_MOVE:{slot:"passive",range:1,cooldown:0,name:"Walk",description:"Move to adjacent tile."},BASIC_ATTACK:{slot:"passive",range:1,cooldown:0,name:"Basic Attack",description:"Strike adjacent target."},DASH:{slot:"passive",range:4,cooldown:0,name:"Kinetic Dash",description:"Dash in a straight line."}}[e]||{slot:"offensive",range:1,cooldown:0,name:e,description:e};return{id:e,name:a.name,description:a.description,slot:a.slot,cooldown:a.cooldown,currentCooldown:0,range:a.range,upgrades:[],activeUpgrades:[]}},Rv={id:"raider_dash",name:"Raider Dash",description:"Parity checks for enemy Raider reusing the player DASH contract.",scenarios:[{id:"player_dash_stops_before_adjacent_enemy",title:"Parity Baseline: Player Dash Stops Before Blocker",description:"Player DASH should stop on the tile before an occupied target.",relatedSkills:["DASH"],category:"movement",difficulty:"beginner",isTutorial:!1,tags:["parity","dash","reuse"],setup:e=>{e.setPlayer({q:4,r:2,s:-6},["DASH"]),e.spawnEnemy("footman",{q:4,r:6,s:-10},"blocker"),e.state.hasShield=!1},run:e=>{e.useSkill("DASH",{q:4,r:6,s:-10})},verify:(e,i)=>{const a={playerStoppedBeforeBlocker:e.player.position.q===4&&e.player.position.r===5,dashResolved:i.some(o=>o.includes("Stopped by an obstacle")||o.includes("Dashed!")||o.includes("Shield Shunt"))};return Object.values(a).every(o=>o===!0)}},{id:"raider_ai_uses_dash_with_player_contract",title:"Parity: Raider Uses Same Dash Stop Rule",description:"Raider AI selects DASH and lands on the same stop tile as player-owned DASH in mirrored geometry.",relatedSkills:["DASH"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["parity","enemy-ai","dash"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},[]),e.spawnEnemy("raider",{q:4,r:2,s:-6},"raider"),e.state.hasShield=!1;const i=e.getEnemy("raider");i&&(i.activeSkills=[lf("BASIC_MOVE"),lf("BASIC_ATTACK"),lf("DASH")])},run:e=>{e.wait()},verify:(e,i)=>{const a=e.enemies.find(c=>c.id==="raider"),o={raiderStillAlive:!!a,raiderStoppedBeforePlayer:!!a&&a.position.q===4&&a.position.r===5,playerUnharmed:e.player.hp===e.player.maxHp,dashResolved:i.some(c=>c.includes("Stopped by an obstacle")||c.includes("Dashed!")||c.includes("Shield Shunt"))};return Object.values(o).every(c=>c===!0)}}]},rf=e=>{const a={BASIC_MOVE:{slot:"passive",range:1,cooldown:0,name:"Walk",description:"Move to adjacent tile."},BASIC_ATTACK:{slot:"passive",range:1,cooldown:0,name:"Basic Attack",description:"Strike adjacent target."},GRAPPLE_HOOK:{slot:"offensive",range:4,cooldown:0,name:"Grapple Hook",description:"Pull and swap with target."}}[e]||{slot:"offensive",range:1,cooldown:0,name:e,description:e};return{id:e,name:a.name,description:a.description,slot:a.slot,cooldown:a.cooldown,currentCooldown:0,range:a.range,upgrades:[],activeUpgrades:[]}},kv={id:"pouncer_hook",name:"Pouncer Hook",description:"Second archetype reuse: enemy uses player GRAPPLE_HOOK via normal skill execution.",scenarios:[{id:"pouncer_uses_grapple_hook_deterministically",title:"Pouncer Uses Grapple Hook Through Skill Pipeline",description:"Pouncer selects GRAPPLE_HOOK from AI and resolves via standard USE_SKILL execution.",relatedSkills:["GRAPPLE_HOOK"],category:"combat",difficulty:"intermediate",isTutorial:!1,tags:["parity","enemy-ai","determinism"],setup:e=>{e.setPlayer({q:4,r:6,s:-10},[]),e.spawnEnemy("pouncer",{q:4,r:2,s:-6},"pouncer");const i=e.getEnemy("pouncer");i&&(i.activeSkills=[rf("BASIC_MOVE"),rf("BASIC_ATTACK"),rf("GRAPPLE_HOOK")])},run:e=>{e.wait()},verify:(e,i)=>{const o={pouncerStillAlive:!!e.enemies.find(c=>c.id==="pouncer"),grappleExecuted:i.filter(c=>c.includes("Vaulted and Flung!")).length>=1,deterministicStatus:i.filter(c=>c.includes("You are stunned!")).length===1,noZeroEffectWarning:!i.some(c=>c.includes("produced ZERO effects"))};return Object.values(o).every(c=>c===!0)}}]},Lv={id:"ice",name:"Ice Terrain",description:"ICE/SLIPPERY terrain behavior for pass-through momentum and landing slide.",scenarios:[{id:"ice_pass_preserves_dash_momentum",title:"Ice Pass: Dash Carries Momentum",description:"Passing through ICE during DASH should preserve momentum and carry movement beyond nominal target.",relatedSkills:["DASH"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["terrain","ice","momentum","pass"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["DASH"]),e.state.hasShield=!1,e.setTile({q:5,r:4,s:-9},"slippery"),e.setTile({q:6,r:4,s:-10},"floor"),e.setTile({q:7,r:4,s:-11},"floor")},run:e=>{e.useSkill("DASH",{q:6,r:4,s:-10})},verify:e=>e.player.position.q>6},{id:"ice_land_slides_after_basic_move",title:"Ice Land: Basic Move Slides Forward",description:"Landing on ICE with BASIC_MOVE should slide one hex in the move direction when the next tile is walkable.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"beginner",isTutorial:!1,tags:["terrain","ice","slide","land"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["BASIC_MOVE"]),e.setTile({q:5,r:4,s:-9},"slippery"),e.setTile({q:6,r:4,s:-10},"floor")},run:e=>{e.move({q:5,r:4,s:-9})},verify:e=>e.player.position.q===6&&e.player.position.r===4}]},Iv={id:"snare",name:"Snare Terrain",description:"Snare tile effect movement restriction and status interaction.",scenarios:[{id:"snare_interrupts_dash_and_roots_actor",title:"Snare Interrupts Dash",description:"DASH into a snare tile should halt movement at snare and apply rooted status.",relatedSkills:["DASH"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["terrain","snare","movement-restriction"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["DASH"]),e.state.hasShield=!1,e.state.tiles.set("5,4",{baseId:"STONE",position:{q:5,r:4,s:-9},traits:new Set(["WALKABLE"]),effects:[{id:"SNARE",duration:-1,potency:1}]}),e.setTile({q:6,r:4,s:-10},"floor"),e.setTile({q:7,r:4,s:-11},"floor")},run:e=>{e.useSkill("DASH",{q:7,r:4,s:-11})},verify:(e,i)=>{const a=e.player.statusEffects.some(c=>c.type==="rooted"),o={stoppedAtSnare:e.player.position.q===5&&e.player.position.r===4,rootedApplied:a,snareMessageLogged:i.some(c=>c.includes("Snared! Movement halted."))};return Object.values(o).every(c=>c===!0)}}]},Bv={id:"relics",name:"Relics",description:"Passive relic behaviors using existing engine hooks only.",scenarios:[{id:"relic_ember_ward_reduces_fire_damage",title:"Relic: Ember Ward",description:"Equipping Ember Ward reduces incoming fire damage by 1.",relatedSkills:["BASIC_MOVE"],category:"passive",difficulty:"beginner",isTutorial:!1,tags:["relic","fire","passive"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.upgrades=[...e.state.upgrades||[],"RELIC_EMBER_WARD"],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:(e,i)=>{const a={hpUnchanged:e.player.hp===e.player.maxHp,relicMessageSeen:i.some(o=>o.includes("Ember Ward dampens the flames."))};return Object.values(a).every(o=>o===!0)}},{id:"relic_cinder_orb_stacks_with_absorb_fire",title:"Relic: Cinder Orb Stacking",description:"Cinder Orb adds bonus healing when fire damage is converted by Absorb Fire.",relatedSkills:["ABSORB_FIRE"],category:"passive",difficulty:"advanced",isTutorial:!1,tags:["relic","stacking","absorb-fire"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["ABSORB_FIRE"]),e.state.player={...e.state.player,hp:1,maxHp:3},e.state.upgrades=[...e.state.upgrades||[],"RELIC_CINDER_ORB"],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:(e,i)=>{const a={healedByStacking:e.player.hp===3,stackingMessageSeen:i.some(o=>o.includes("Cinder Orb amplifies the absorption."))};return Object.values(a).every(o=>o===!0)}},{id:"relic_steady_plates_end_to_end",title:"Relic: Steady Plates",description:"Steady Plates grants turn-start armor that resolves against incoming damage in the same round.",relatedSkills:["BASIC_MOVE"],category:"passive",difficulty:"intermediate",isTutorial:!1,tags:["relic","armor","turn-start"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.upgrades=[...e.state.upgrades||[],"RELIC_STEADY_PLATES"],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:(e,i)=>{const a={playerHpProtected:e.player.hp===e.player.maxHp,damageEventOccurred:i.some(o=>o.includes("player burns!")),armorPresentAfterCycle:e.player.temporaryArmor>=0&&e.player.temporaryArmor<=2,relicTriggerMessageSeen:i.some(o=>o.includes("Steady Plates harden your stance."))};return Object.values(a).every(o=>o===!0)}}]},jv=250,Dv=700,Hv=100,Pv=8,Uv=220,qv=260,zv=40,By=(e,i)=>{const a=e.floor||0,o=e.player?.hp||0,c=e.turnsSpent??e.turnNumber??0,r=e.kills||0,f=e.environmentalKills||0,h=e.hazardBreaches||0,b=(i||[]).filter(y=>y.success).length*jv;return a*Dv+o*Hv+r*Uv+f*qv-c*Pv-h*zv+b},$v=e=>{if(typeof e=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const i=e instanceof Date?e:new Date,a=i.getFullYear(),o=String(i.getMonth()+1).padStart(2,"0"),c=String(i.getDate()).padStart(2,"0");return`${a}-${o}-${c}`},Vv=e=>`daily:${e}`,Yv=e=>{const i=18+Math.floor(Yc(e,0)*8);return[{id:"TURN_LIMIT",label:`Finish within ${i} turns`,target:i},{id:"HAZARD_CONSTRAINT",label:"Take no hazard damage",target:0}]},Uc=e=>(e.runObjectives||[]).map(a=>{if(a.id==="TURN_LIMIT"){const c=e.turnsSpent||0;return{...a,value:c,success:c<=a.target}}const o=e.hazardBreaches||0;return{...a,value:o,success:o<=a.target}}),er=e=>{const i=e.initialSeed??e.rngSeed??"0",a=Uc(e),o=e.combatScoreEvents||[],c=o.length?Number((o.reduce((f,h)=>f+h.efficiency,0)/o.length).toFixed(4)):0,r=o.filter(f=>f.riskBonusApplied).length;return{seed:i,actionLog:e.actionLog,score:By(e,a),floor:e.floor,objectives:a,combatTelemetry:{events:o.length,avgEfficiency:c,riskBonusEvents:r}}},Fv={id:"objectives",name:"Objectives",description:"Daily objective validation for turn-limit and hazard constraints.",scenarios:[{id:"objective_turn_limit_boundary",title:"Objective: Turn Limit Boundary",description:"Turn-limit objective passes at boundary and fails above boundary.",relatedSkills:["BASIC_MOVE"],category:"progression",difficulty:"intermediate",isTutorial:!1,tags:["objective","turn-limit"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.runObjectives=[{id:"TURN_LIMIT",label:"Finish within 1 turns",target:1}]},run:e=>{e.wait()},verify:e=>{const a=Uc(e)[0]?.success===!0,o=er(e).score,c=Uc({...e,turnsSpent:(e.turnsSpent||0)+1}),r={...e,turnsSpent:(e.turnsSpent||0)+1},f=er(r).score,h=c[0]?.success===!1,b=f<o;return a&&h&&b}},{id:"objective_hazard_constraint_fail_on_hazard",title:"Objective: Hazard Constraint",description:"Hazard objective fails after prohibited hazard interaction.",relatedSkills:["BASIC_MOVE"],category:"hazards",difficulty:"intermediate",isTutorial:!1,tags:["objective","hazard"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},[]),e.state.runObjectives=[{id:"HAZARD_CONSTRAINT",label:"Take no hazard damage",target:0}],e.state.tiles.set("4,4",{baseId:"STONE",position:{q:4,r:4,s:-8},traits:new Set(["WALKABLE"]),effects:[{id:"FIRE",duration:-1,potency:1}]})},run:e=>{e.wait()},verify:e=>{const i=Uc(e)[0];return(e.hazardBreaches||0)>0&&!!i&&i.success===!1}}]},Kv={id:"necromancer",name:"Necromancer",description:"Corpse persistence and summon migration contracts.",scenarios:[{id:"necromancer_corpse_persistence",title:"Corpse Persists Until Consumed",description:"Kill an enemy, wait 5 turns, then Raise Dead succeeds from corpse tile trait.",relatedSkills:["BASIC_ATTACK","RAISE_DEAD"],category:"summon",difficulty:"intermediate",isTutorial:!1,tags:["necromancer","corpse","persistence"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["BASIC_ATTACK","RAISE_DEAD"],"VANGUARD"),e.spawnEnemy("footman",{q:5,r:4,s:-9},"dummy");const i=e.getEnemy("dummy");i&&(i.hp=1,i.maxHp=1)},run:e=>{const i={q:5,r:4,s:-9};e.useSkill("BASIC_ATTACK",i);for(let a=0;a<5;a++)e.wait();e.useSkill("RAISE_DEAD",i)},verify:e=>{const i=he({q:5,r:4}),a=e.tiles.get(i),o=e.enemies.find(h=>h.subtype==="skeleton"&&h.factionId==="player"),c=e.companions?.find(h=>h.id===o?.id),r=new Set((o?.activeSkills||[]).map(h=>h.id)),f={corpseConsumed:!a?.traits?.has("CORPSE"),skeletonRaised:!!o,skeletonOnCorpseTile:!!o&&o.position.q===5&&o.position.r===4,companionRegistered:!!c,hasBasicLoadout:r.has("BASIC_MOVE")&&r.has("BASIC_ATTACK")};return Object.values(f).every(Boolean)}},{id:"summon_floor_transition",title:"Summon Persists Across Floor Transition",description:"Raised skeleton migrates with player to floor 2.",relatedSkills:["RAISE_DEAD"],category:"summon",difficulty:"advanced",isTutorial:!1,tags:["necromancer","summon","floor-transition"],setup:e=>{e.setPlayer({q:4,r:4,s:-8},["RAISE_DEAD"],"VANGUARD");const i={q:5,r:4,s:-9},a=he(i),o=e.getTileAt(i);e.state.tiles.set(a,{...o,position:i,traits:new Set([...o?.traits||[],"CORPSE"])})},run:e=>{const i={q:5,r:4,s:-9};e.useSkill("RAISE_DEAD",i),e.state.player={...e.state.player,position:{...e.state.stairsPosition}},e.wait(),e.dispatchSync({type:"RESOLVE_PENDING"})},verify:e=>{const i=e.enemies.find(o=>o.subtype==="skeleton"&&o.factionId==="player"&&o.companionOf===e.player.id),a={floorAdvanced:e.floor===2,summonStillPresent:!!i,summonTracksOwner:!!i&&i.companionOf===e.player.id};return Object.values(a).every(Boolean)}},{id:"companion_does_not_block_free_move",title:"Companion Does Not Block Exploration Free Move",description:"Friendly skeleton companion should not count as hostile for BASIC_MOVE exploration range.",relatedSkills:["BASIC_MOVE"],category:"movement",difficulty:"intermediate",isTutorial:!1,tags:["necromancer","companion","movement"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["BASIC_MOVE"],"VANGUARD"),e.spawnEnemy("footman",{q:5,r:5,s:-10},"friendly_skeleton");const i=e.getEnemy("friendly_skeleton");i&&(i.subtype="skeleton",i.factionId="player",i.companionOf=e.state.player.id,i.activeSkills=i.activeSkills||[],e.state.companions=[...e.state.companions||[],i])},run:e=>{e.move({q:7,r:1,s:-8})},verify:e=>{const i={movedFar:e.player.position.q===7&&e.player.position.r===1,turnsAdvanced:e.turnsSpent>=1};return Object.values(i).every(Boolean)}},{id:"raise_dead_pushes_ally_from_target_hex",title:"Raise Dead Pushes Ally Occupant",description:"If corpse tile is occupied by an ally, ally is displaced and summon succeeds without overlap.",relatedSkills:["RAISE_DEAD"],category:"summon",difficulty:"advanced",isTutorial:!1,tags:["necromancer","occupancy","push"],setup:e=>{e.setPlayer({q:4,r:5,s:-9},["RAISE_DEAD"],"VANGUARD");const i={q:5,r:5,s:-10},a=he(i),o=e.getTileAt(i);e.state.tiles.set(a,{...o,position:i,traits:new Set([...o?.traits||[],"CORPSE"])}),e.spawnEnemy("footman",i,"ally_blocker");const c=e.getEnemy("ally_blocker");c&&(c.subtype="skeleton",c.factionId="player",c.companionOf=e.state.player.id,e.state.companions=[...e.state.companions||[],c])},run:e=>{e.useSkill("RAISE_DEAD",{q:5,r:5,s:-10})},verify:e=>{const i=e.enemies.filter(h=>h.subtype==="skeleton"&&h.factionId==="player"),a=new Set;let o=!1;i.forEach(h=>{const b=he(h.position);a.has(b)&&(o=!0),a.add(b)});const c=i.some(h=>h.position.q===5&&h.position.r===5),r=i.some(h=>h.id==="ally_blocker"&&!(h.position.q===5&&h.position.r===5));return Object.values({raisedAtCorpse:c,pushedExists:r,noOverlap:!o}).every(Boolean)}}]};function Gv(e){return{id:e.id,title:e.title,description:e.description,rationale:e.rationale,setup:e.setup,run:e.run,verify:e.verify}}const Wv=[ov,lv,rv,cv,pv,hv,gv,yv,bv,xv,vv,Ev,Sv,Av,Tv,wv,_v,Mv,Ov,Cv,Nv,Rv,kv,Lv,Iv,Bv,Fv,Kv],Xv=Wv.flatMap(e=>e.scenarios);function Qv(e){return Xv.filter(i=>i.relatedSkills.includes(e))}function vt(e){return Qv(e).map(Gv)}const jy={id:"AUTO_ATTACK",name:"Auto Attack",description:"Automatically strike adjacent enemies that started the turn adjacent to you.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0,damage:1},execute:(e,i,a,o=[],c)=>{const r=[],f=[];let h=0;const b=(e.timelineEvents||[]).some(_=>_.phase==="STATUS_APPLY"&&_.type==="ApplyStatus"&&_.payload?.status==="stunned"&&(_.payload?.target===i.id||typeof _.payload?.target=="object"&&_.payload?.target&&ne(_.payload.target,i.position)));if(Ns(i)||b)return{effects:r,messages:f,kills:0};const y=ot(i.position);let A=1;o.includes("HEAVY_HANDS")&&(A+=1);const v=c?.persistentTargetIds||[],S=c?.previousNeighbors||[];if(v.length===0&&S.length===0)return{effects:r,messages:f,kills:0};for(const _ of y){const p=Ee(e,_);if(!p||p.hp<=0||p.id===i.id||i.factionId===p.factionId)continue;if(v.length>0?v.includes(p.id):S.some(R=>ne(R,_))){const R=pn({attackerId:i.id,targetId:p.id,skillId:"AUTO_ATTACK",basePower:A,trinity:Qe(i),targetTrinity:Qe(p),damageClass:"physical",scaling:[{attribute:"body",coefficient:.4}],statusMultipliers:[]});r.push({type:"Damage",target:_,amount:R.finalPower,scoreEvent:R.scoreEvent});const I=i.factionId==="player"?"You":`${i.subtype||"enemy"}#${i.id}`,C=p.factionId==="player"?"you":`${p.subtype||"enemy"}#${p.id}`;f.push(`${I} attacked ${C}!`),p.hp<=A&&h++}}if(o.includes("CLEAVE")&&r.length>0)for(const _ of y){if(r.some(N=>N.type==="Damage"&&typeof N.target=="object"&&"q"in N.target&&ne(N.target,_)))continue;const g=Ee(e,_);if(!g||g.id===i.id||!(i.factionId!==g.factionId))continue;const I=pn({attackerId:i.id,targetId:g.id,skillId:"AUTO_ATTACK",basePower:A,trinity:Qe(i),targetTrinity:Qe(g),damageClass:"physical",scaling:[{attribute:"body",coefficient:.4}],statusMultipliers:[]});r.push({type:"Damage",target:_,amount:I.finalPower,scoreEvent:I.scoreEvent});const C=i.factionId==="player"?"You":`${i.subtype||"enemy"}#${i.id}`,M=g.factionId==="player"?"you":`${g.subtype||"enemy"}#${g.id}`;f.push(`${C} cleaved ${M}!`),g.hp<=A&&h++}return{effects:r,messages:f,kills:h}},upgrades:{HEAVY_HANDS:{id:"HEAVY_HANDS",name:"Heavy Hands",description:"Auto-attack damage +1"},CLEAVE:{id:"CLEAVE",name:"Cleave",description:"When auto-attack triggers, hit ALL adjacent enemies"}},scenarios:vt("AUTO_ATTACK")},Jv=(e,i,a,o,c,r)=>{if(!i.activeSkills?.some(S=>S.id==="AUTO_ATTACK"))return{state:e,kills:0,messages:[]};const b=i.activeSkills?.find(S=>S.id==="AUTO_ATTACK")?.activeUpgrades||[],y=new Map;if(e.initiativeQueue)for(const S of e.initiativeQueue.entries)S.turnStartPosition&&y.set(S.actorId,S.turnStartPosition);const A=jy.execute(e,i,void 0,b,{previousNeighbors:a,attackerTurnStartPosition:o,allActorsTurnStartPositions:y,persistentTargetIds:c});return{state:yi(e,A.effects,{sourceId:i.id,targetId:void 0,stepId:r}),kills:A.kills||0,messages:A.messages}},je={shake:(e,i)=>({type:"Juice",effect:"shake",intensity:e,direction:i}),flash:e=>({type:"Juice",effect:"flash",intensity:"high",color:e}),freeze:(e=80)=>({type:"Juice",effect:"freeze",duration:e}),combatText:(e,i,a)=>({type:"Juice",effect:"combat_text",text:e,target:i,color:a}),momentumTrail:(e,i)=>({type:"Juice",effect:"momentumTrail",path:e,intensity:i}),heavyImpact:(e,i)=>({type:"Juice",effect:"heavyImpact",target:e,direction:i,intensity:"extreme"}),lightImpact:e=>({type:"Juice",effect:"lightImpact",target:e,intensity:"low"}),kineticWave:(e,i,a)=>({type:"Juice",effect:"kineticWave",target:e,direction:i,intensity:a}),stunBurst:e=>({type:"Juice",effect:"stunBurst",target:e,intensity:"medium"}),lavaRipple:e=>({type:"Juice",effect:"lavaRipple",target:e,intensity:"medium"}),wallCrack:(e,i)=>({type:"Juice",effect:"wallCrack",target:e,direction:i,intensity:"high"}),explosionRing:e=>({type:"Juice",effect:"explosion_ring",target:e})},Kt={GRAPPLE_HOOK:{anticipation:(e,i)=>[{type:"Juice",effect:"aimingLaser",target:e,path:[e,i],intensity:"low",color:"#00ff88"}],execution:e=>[{type:"Juice",effect:"hookCable",path:e,intensity:"medium",duration:200,color:"#00ff88"},je.shake("low")],impact:(e,i)=>[{type:"Juice",effect:"grappleHookWinch",target:e,direction:i,intensity:"high",duration:150},je.shake("medium",i)],resolution:(e,i)=>[je.momentumTrail(e,i>6?"high":"medium"),je.kineticWave(e[0],e[e.length-1],"high")]},SHIELD_THROW:{anticipation:(e,i)=>[{type:"Juice",effect:"trajectory",target:e,path:[e,i],intensity:"medium",color:"#4169e1"}],execution:e=>[{type:"Juice",effect:"shieldArc",path:e,intensity:"high",duration:300,metadata:{rotation:720}},{type:"Juice",effect:"shieldSpin",path:e,intensity:"medium"}],impact:(e,i)=>[je.heavyImpact(e,i),je.shake("high",i),je.freeze(120),je.combatText("IMPACT!",e,"#ff4444")],resolution:e=>[je.kineticWave(e[0],e[e.length-1],"high"),je.momentumTrail(e,"high")]},DASH:{anticipation:(e,i)=>[{type:"Juice",effect:"chargeUp",target:e,direction:i,intensity:"medium",duration:100}],execution:e=>[{type:"Juice",effect:"dashBlur",path:e,intensity:"high",duration:150},je.momentumTrail(e,"medium")],impact:(e,i,a)=>a?[je.heavyImpact(e,i),je.shake("extreme",i),je.freeze(100),je.combatText("SHUNT!",e,"#ffaa00")]:[je.lightImpact(e)],resolution:e=>e?[je.kineticWave(e[0],e[e.length-1],"high"),je.momentumTrail(e,"high")]:[]},SPEAR_THROW:{anticipation:(e,i)=>[{type:"Juice",effect:"aimingLaser",target:e,path:[e,i],intensity:"low",color:"#ff6b6b"}],execution:e=>[{type:"Juice",effect:"spearTrail",path:e,intensity:"high",duration:150},{type:"Juice",effect:"spearWhistle",path:e,intensity:"medium",metadata:{pitch:"rising"}}],impact:(e,i)=>i?[je.heavyImpact(e),je.shake("medium"),je.freeze(60),je.combatText("LETHAL",e,"#ff0000")]:[je.lightImpact(e),je.combatText("MISS",e,"#888888")],resolution:()=>[]},VAULT:{anticipation:(e,i)=>[{type:"Juice",effect:"trajectory",target:e,path:[e,i],intensity:"low",color:"#00ddff",metadata:{arc:"high"}}],execution:e=>[{type:"Juice",effect:"vaultLeap",path:e,intensity:"medium",duration:250,metadata:{arc:"parabolic"}}],impact:(e,i)=>i?[je.heavyImpact(e),je.shake("medium"),je.stunBurst(e),je.combatText("STUN!",e,"#ffff00")]:[je.lightImpact(e)],resolution:()=>[]}},cf={lavaSink:e=>[{type:"Juice",effect:"lavaSink",target:e,intensity:"extreme",duration:500,metadata:{particleCount:50}},je.lavaRipple(e),je.shake("high"),je.combatText("CONSUMED",e,"#ff4400")],wallImpact:(e,i,a)=>{const o=[je.wallCrack(e,i),je.shake("high",i)];return a&&(o.push(je.stunBurst(e)),o.push(je.combatText("STUNNED",e,"#ffaa00"))),o},voidConsume:e=>[{type:"Juice",effect:"voidConsume",target:e,intensity:"extreme",duration:800,color:"#000000"},je.freeze(150),je.combatText("VOID",e,"#8800ff")]};function Xc(e,i){const{origin:a,direction:o,momentum:c}=i,r=[];r.push(je.kineticWave(a,o,c>6?"high":"medium"));const f=Wn(a,{q:o.q*(c+10),r:o.r*(c+10),s:o.s*(c+10)}),h=Pt(a,f);let b=c,y=Zv(e,h);for(;b>0&&y.length>0;){const A=eS(y);if(A.length===0)break;const v=A.length;if(b<v){const C=A[A.length-1],M=b;b=0;const N=[h[C.pos1D]];for(let Y=0;Y<M;Y++){const X=C.pos1D+1,O=h[X];if(!O||!pa(O,e.gridWidth,e.gridHeight)||kg(e,O)){r.push({type:"Impact",target:C.id,damage:M-Y,direction:o});break}if(C.pos1D=X,N.push(O),Lg(e,O)){r.push({type:"LavaSink",target:C.id}),r.push(...cf.lavaSink(O));break}}N.length>1&&(r.push({type:"Displacement",target:C.id,destination:N[N.length-1],path:N,animationDuration:N.length*80}),r.push(je.momentumTrail(N,"medium")));break}const S=A[A.length-1],_=S.pos1D+1,p=h[_];if(!p||!pa(p,e.gridWidth,e.gridHeight)||kg(e,p)){r.push({type:"ApplyStatus",target:S.id,status:"stunned",duration:1}),p&&r.push(...cf.wallImpact(p,o,!0));break}const g=new Map;for(const C of A){const M=h[C.pos1D];C.pos1D+=1;const N=h[C.pos1D];g.set(C.id,[M,N])}const R=[...A].reverse();for(const C of R){const M=g.get(C.id);M&&r.push({type:"Displacement",target:C.id,destination:M[M.length-1],path:M,ignoreCollision:!0,animationDuration:150})}const I=Array.from(g.values()).flat();I.length>0&&r.push(je.momentumTrail(I,v>2?"high":"medium")),b-=v;for(let C=y.length-1;C>=0;C--){const M=y[C],N=h[M.pos1D];Lg(e,N)&&(r.push({type:"LavaSink",target:M.id}),r.push(...cf.lavaSink(N)),y.splice(C,1))}if(b>0){const C=A[A.length-1];y=y.filter(N=>N.pos1D>=C.pos1D);const M=y.filter(N=>N.pos1D>C.pos1D);y=[C,...M]}}return r}function Zv(e,i){const a=[],o=[e.player,...e.enemies];for(const c of o){const r=i.findIndex(f=>ne(f,c.position));r!==-1&&a.push({id:c.id,pos1D:r})}return a.sort((c,r)=>c.pos1D-r.pos1D)}function eS(e){if(e.length===0)return[];const i=[];let a=e[0];i.push(a);for(let o=1;o<e.length;o++){const c=e[o];if(c.pos1D===a.pos1D||c.pos1D===a.pos1D+1)i.push(c),a=c;else break}return i}function kg(e,i){const a=qe.getTraitsAt(e,i);return a.has("BLOCKS_MOVEMENT")||a.has("BLOCKS_LOS")}function Lg(e,i){const a=qe.getTraitsAt(e,i);return a.has("HAZARDOUS")||a.has("LIQUID")}function tS(e,i,a,o){const c=Ce(i.position,a);if(c<=1)return[];const r=fa(a,i.position),f=Un(r);return Xc(e,{origin:a,direction:f,momentum:Math.min(o,c-1)})}function nS(e,i){return[{type:"Displacement",target:e.id,destination:i.position},{type:"Displacement",target:i.id,destination:e.position}]}function iS(e,i,a,o){return Xc(e,{origin:i,direction:a,momentum:o})}function ji(e,i){const a=e.tiles.get(he(i));return!!(a?.traits.has("BLOCKS_LOS")||a?.baseId==="WALL")}function Xa(e,i){const a=e.tiles.get(he(i));return a?.baseId==="LAVA"||a?.traits.has("LIQUID")||!1}function ha(e,i,a){const o=Ee(e,i);return!!o&&o.id!==a}function hn(e,i,a){const o=Ce(e,i);return o>=1&&o<=a}function ss(e,i){const a=fa(e,i);return{isAxial:a!==-1,directionIndex:a}}function Df(e,i,a={}){const{checkWalls:o=!0,checkActors:c=!0,checkLava:r=!1,excludeActorId:f}=a;for(const h of i){if(o&&ji(e,h))return{obstacle:"wall",position:h};if(r&&Xa(e,h))return{obstacle:"lava",position:h};if(c){const b=Ee(e,h);if(b&&b.id!==f)return{obstacle:"actor",position:h,actor:b}}}return{}}function Hf(e,i,a,o={}){const r=Pt(i,a).slice(1),{stopAtWalls:f=!0,stopAtActors:h=!0,stopAtLava:b=!1,excludeActorId:y}=o,A=Df(e,r,{checkWalls:f,checkActors:h,checkLava:b,excludeActorId:y});return A.obstacle&&A.position&&!ne(A.position,a)?{isValid:!1,blockedBy:A.obstacle,blockedAt:A.position}:{isValid:!0}}function Ig(e,i,a,o,c){const f=Pt(i,a).slice(1),h=Df(e,f,{checkWalls:!0,checkActors:!0,checkLava:!1,excludeActorId:c});return h.obstacle==="actor"&&h.actor?.id===o&&!!h.position&&ne(h.position,a)}function sS(e,i){const a=qe.getTraitsAt(e,i),o=a.has("HAZARDOUS")||a.has("LAVA")||a.has("FIRE")||a.has("VOID"),c=a.has("LAVA")||a.has("FIRE");return{isHazard:o,isFireHazard:c}}function Rs(e,i,a){const{isHazard:o,isFireHazard:c}=sS(e,a);return!!(!o||i.isFlying||(i.activeSkills?.some(f=>f.id==="ABSORB_FIRE")||i.statusEffects?.some(f=>f.type==="fire_immunity"))&&c)}function Dy(e,i,a,o){return Rs(e,i,a)?!0:new Set(["JUMP","VAULT","GRAPPLE_HOOK","DASH"]).has(o)}const aS={id:"GRAPPLE_HOOK",name:"Grapple Hook",description:"Pull/Zip mechanism with multi-phase kinetic resolution.",slot:"offensive",icon:"",baseVariables:{range:4,cost:1,cooldown:3,momentum:4},execute:(e,i,a,o=[])=>{let c=[],r=[];if(!a)return{effects:c,messages:r,consumesTurn:!1};const{directionIndex:h}=ss(i.position,a),b=Un(h);c.push(...Kt.GRAPPLE_HOOK.anticipation(i.position,a));const{isValid:y,blockedBy:A}=Hf(e,i.position,a,{stopAtWalls:!0,stopAtActors:!0,excludeActorId:i.id});if(!y)return r.push(`Line of sight blocked by ${A}!`),{effects:c,messages:r,consumesTurn:!1};const v=a,S=Ee(e,v),_=qe.getTraitsAt(e,v),g=_.has("BLOCKS_MOVEMENT")||_.has("ANCHOR")?"Heavy":S?.weightClass||"Standard";if(g==="Heavy"||g==="Anchored"){const R=xf(v,b);c.push(...Kt.GRAPPLE_HOOK.execution(Pt(i.position,R))),c.push({type:"Displacement",target:i.id,destination:R,ignoreGroundHazards:!0});const I=qe.getTileAt(e,R);if(I){const M=Va.processEntry(i,I,e);c.push(...M.effects),r.push(...M.messages)}const C=ot(R);for(const M of C){const N=Ee(e,M);N&&N.id!==i.id&&(c.push({type:"Impact",target:N.id,damage:0,direction:b}),c.push({type:"ApplyStatus",target:N.id,status:"stunned",duration:2}),c.push(je.stunBurst(M)))}return c.push(je.heavyImpact(R,b)),c.push(je.shake("high",b)),r.push("Zipped to anchor!"),{effects:c,messages:r,consumesTurn:!0}}else if(S){const R=Ce(i.position,v),I=Un((h+3)%6),C=i.position;c.push(...Kt.GRAPPLE_HOOK.execution(Pt(i.position,a)));const M=tS(e,i,v,R-1),N=yi(e,M,{sourceId:i.id,targetId:S.id}),Y=N.enemies.find(W=>W.id===S.id)||(N.player.id===S.id?N.player:null);if(!Y)return r.push(`${S.subtype||"Enemy"} neutralized during pull.`),{effects:[...c,...M],messages:r,consumesTurn:!0};const X=nS(i,Y),O=Y.position;c.push(...Kt.GRAPPLE_HOOK.impact(O,b));const q=yi(N,X,{sourceId:i.id,targetId:S.id}),K=iS(q,C,I,4),ue=Pt(C,Wn(C,If(h,6)));return c.push(...Kt.GRAPPLE_HOOK.resolution(ue,4)),{effects:[...c,...M,...X,...K],messages:["Vaulted and Flung!"],consumesTurn:!0}}else return r.push("Hook missed."),{effects:c,messages:r,consumesTurn:!1}},getValidTargets:(e,i)=>{const a=Ee(e,i);return a?tt.getAxialTargets(e,i,4,{includeWalls:!0,includeActors:!0,stopAtObstacles:!0}).filter(o=>{const{directionIndex:c}=ss(i,o),r=Un(c),f=Ee(e,o),h=qe.getTraitsAt(e,o),y=h.has("BLOCKS_MOVEMENT")||h.has("ANCHOR")?xf(o,r):f?o:void 0;return y?Rs(e,a,y):!1}):[]},upgrades:{},scenarios:vt("GRAPPLE_HOOK")},oS={id:"SPEAR_THROW",name:e=>e.hasSpear?"Spear Throw":"Recall Spear",description:e=>e.hasSpear?"Throw your spear to instantly kill an enemy.":"Recall your spear, damaging enemies in its path.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:0,damage:1},execute:(e,i,a,o=[])=>{const c=[],r=[],f=Qe(i),h=o.includes("SPEAR_RANGE"),b=o.includes("RECALL"),y=o.includes("RECALL_DAMAGE"),A=o.includes("LUNGE"),v=o.includes("LUNGE_ARC"),S=o.includes("DEEP_BREATH"),_=o.includes("SPEAR_CLEAVE")||o.includes("CLEAVE"),p=3+(h?1:0);if(e.hasSpear){if(!a)return{effects:c,messages:r,consumesTurn:!1};if(A&&Ce(i.position,a)===2){const N=Ee(e,a);if(N&&N.id!==i.id){const Y=pn({attackerId:i.id,targetId:N.id,skillId:"SPEAR_THROW",basePower:99,trinity:f,targetTrinity:Qe(N),damageClass:"physical",scaling:[{attribute:"body",coefficient:.1},{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});return c.push({type:"Displacement",target:"self",destination:a,simulatePath:!0}),c.push({type:"Damage",target:N.id,amount:Y.finalPower,scoreEvent:Y.scoreEvent}),r.push(`Lunged and killed ${N.subtype||"enemy"} !`),v&&ot(a).forEach(X=>{const O=Ee(e,X);if(O&&O.id!==i.id&&O.id!==N.id){const q=pn({attackerId:i.id,targetId:O.id,skillId:"SPEAR_THROW",basePower:1,trinity:f,targetTrinity:Qe(O),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.15}],statusMultipliers:[]});c.push({type:"Damage",target:O.id,amount:q.finalPower,scoreEvent:q.scoreEvent})}}),S&&c.push({type:"ModifyCooldown",skillId:"JUMP",amount:0,setExact:!0}),{effects:c,messages:r}}}if(!hn(i.position,a,p))return r.push("Out of range!"),{effects:c,messages:r,consumesTurn:!1};const g=Yi(e.enemies,a);if(!g)return r.push("No enemy at target."),{effects:c,messages:r,consumesTurn:!1};if(!ss(i.position,a).isAxial)return r.push("Target must be axial."),{effects:c,messages:r,consumesTurn:!1};if(!Ig(e,i.position,a,g.id,i.id))return r.push("No clear line of sight to enemy."),{effects:c,messages:r,consumesTurn:!1};c.push(...Kt.SPEAR_THROW.anticipation(i.position,a));const C=a,M=g;if(c.push(...Kt.SPEAR_THROW.execution(Pt(i.position,C))),M){const N=pn({attackerId:i.id,targetId:M.id,skillId:"SPEAR_THROW",basePower:99,trinity:f,targetTrinity:Qe(M),damageClass:"physical",scaling:[{attribute:"body",coefficient:.1},{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});c.push(...Kt.SPEAR_THROW.impact(C,!0)),c.push({type:"Damage",target:M.id,amount:N.finalPower,scoreEvent:N.scoreEvent}),r.push(`Spear killed ${M.subtype||"enemy"} !`),S&&c.push({type:"ModifyCooldown",skillId:"JUMP",amount:0,setExact:!0})}else c.push(...Kt.SPEAR_THROW.impact(C,!1)),r.push("Spear thrown.");c.push({type:"SpawnItem",itemType:"spear",position:C}),b&&(c.push({type:"PickupSpear",position:C}),r.push("Spear auto-retrieved."))}else{const g=e.spearPosition;if(!g)return r.push("Spear is lost!"),{effects:c,messages:r,consumesTurn:!1};const R=Pt(g,i.position);if(y&&R.forEach(I=>{const C=Yi(e.enemies,I);if(C){const M=pn({attackerId:i.id,targetId:C.id,skillId:"SPEAR_THROW",basePower:1,trinity:f,targetTrinity:Qe(C),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.15}],statusMultipliers:[]});c.push({type:"Damage",target:C.id,amount:M.finalPower,scoreEvent:M.scoreEvent}),r.push(`Spear recall hit ${C.subtype||"enemy"} !`)}}),c.push({type:"PickupSpear",position:g}),r.push("Spear recalled."),_){for(const I of ot(g)){const C=Yi(e.enemies,I);if(!C)continue;const M=pn({attackerId:i.id,targetId:C.id,skillId:"SPEAR_THROW",basePower:1,trinity:f,targetTrinity:Qe(C),damageClass:"physical",scaling:[{attribute:"body",coefficient:.1}],statusMultipliers:[]});c.push({type:"Damage",target:C.id,amount:M.finalPower,scoreEvent:M.scoreEvent})}r.push("Cleave triggered on pickup.")}c.push({type:"Juice",effect:"spearTrail",path:R,intensity:"medium"})}return{effects:c,messages:r}},getValidTargets:(e,i)=>{if(!e.hasSpear)return[];const a=Ee(e,i);if(!a)return[];const r=3+(a.activeSkills?.find(h=>h.id==="SPEAR_THROW")?.activeUpgrades?.includes("SPEAR_RANGE")?1:0);return e.enemies.filter(h=>h.hp>0).filter(h=>{const b=h.position;return!ss(i,b).isAxial||!hn(i,b,r)?!1:Ig(e,i,b,h.id,a.id)}).map(h=>h.position)},upgrades:{SPEAR_RANGE:{id:"SPEAR_RANGE",name:"Extended Reach",description:"Range +1"},RECALL:{id:"RECALL",name:"Recall",description:"Spear automatically returns (handled internally if active, or via manual recall)"},RECALL_DAMAGE:{id:"RECALL_DAMAGE",name:"Returning Edge",description:"Damage enemies in path when recalling spear"},LUNGE:{id:"LUNGE",name:"Lunge",description:"If an enemy is exactly 2 hexes away, move to them and kill"},LUNGE_ARC:{id:"LUNGE_ARC",name:"Lunge Sweeping",description:"Lunge hits neighbors of the target"},DEEP_BREATH:{id:"DEEP_BREATH",name:"Deep Breath",description:"Reset Jump cooldown on spear kill"},SPEAR_CLEAVE:{id:"SPEAR_CLEAVE",name:"Cleave",description:"Damage all neighbors when picking up spear"}},scenarios:vt("SPEAR_THROW")},lS={id:"SHIELD_BASH",name:"Shield Bash",description:"Push an enemy 1 tile. If they hit a wall or another enemy, they are stunned.",slot:"defensive",icon:"",baseVariables:{range:1,cost:0,cooldown:2},execute:(e,i,a,o=[])=>{const c=[],r=[];if(!a)return{effects:c,messages:r,consumesTurn:!1};if(!i||!i.position)return{effects:c,messages:r,consumesTurn:!1};const f=o.includes("SHIELD_RANGE"),h=o.includes("ARC_BASH"),b=o.includes("BASH_360"),y=o.includes("WALL_SLAM"),A=1+(f?1:0);if(!hn(i.position,a,A))return r.push("Target out of range!"),{effects:c,messages:r,consumesTurn:!1};let v=[];if(b)v=ot(i.position);else if(h){v=[a];const g=ot(a);for(const R of g)Ce(R,i.position)===1&&v.length<3&&v.push(R)}else v=[a];const S=new Map;e.enemies.forEach(g=>S.set(g.id,g.position)),e.player&&S.set(e.player.id,e.player.position);const _=g=>{for(const[R,I]of Array.from(S.entries()))if(ne(I,g))return R===e.player.id?e.player:e.enemies.find(C=>C.id===R)},p=(g,R)=>{const I=_(R);if(!I||I.id===i.id)return;const C=fa(g,R),M=Un(C),N=Wn(R,M),Y=e.tiles.get(he(N)),X=Y?.baseId==="WALL"||Y?.traits.has("BLOCKS_MOVEMENT"),O=!tt.isWithinBounds(e,N),q=_(N);X||O||q&&q.id!==I.id?(c.push({type:"ApplyStatus",target:I.id,status:"stunned",duration:1}),r.push(`Bashed ${I.subtype||"enemy"} into obstacle!`),c.push({type:"Juice",effect:"shake"}),q&&y&&p(R,N)):(c.push({type:"Displacement",target:I.id,destination:N,simulatePath:!0}),S.set(I.id,N),r.push(`Pushed ${I.subtype||"enemy"}!`))};for(const g of v)p(i.position,g);return{effects:c,messages:r}},getValidTargets:(e,i)=>{const a=Ee(e,i);if(!a)return[];const c=1+(a.activeSkills?.find(r=>r.id==="SHIELD_BASH")?.activeUpgrades?.includes("SHIELD_RANGE")?1:0);return tt.getAreaTargets(e,i,c).filter(r=>{const f=Ee(e,r);return!!f&&f.id!==a.id&&f.factionId!==a.factionId})},upgrades:{SHIELD_RANGE:{id:"SHIELD_RANGE",name:"Extended Bash",description:"Range +1"},SHIELD_COOLDOWN:{id:"SHIELD_COOLDOWN",name:"Quick Recovery",description:"Cooldown -1",modifyCooldown:-1},ARC_BASH:{id:"ARC_BASH",name:"Arc Bash",description:"Bash hits 3-hex frontal arc (+1 cooldown)",modifyCooldown:1},BASH_360:{id:"BASH_360",name:"360 Bash",description:"Bash hits all neighbors (+1 cooldown)",modifyCooldown:1},PASSIVE_PROTECTION:{id:"PASSIVE_PROTECTION",name:"Passive Protection",description:"+1 temp armor when shield not on cooldown"},WALL_SLAM:{id:"WALL_SLAM",name:"Wall Slam",description:"Enemies bashed into obstacles trigger a cascade and stun"}},scenarios:vt("SHIELD_BASH")},rS={id:"JUMP",name:"Jump",description:"Leap to an empty tile within range. Can cross lava but not walls.",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:2},execute:(e,i,a,o=[])=>{const c=[],r=[];if(!a)return{effects:c,messages:r,consumesTurn:!1};if(!i||!i.position)return{effects:c,messages:r,consumesTurn:!1};const f=o.includes("JUMP_RANGE"),h=o.includes("STUNNING_LANDING"),b=o.includes("METEOR_IMPACT"),y=o.includes("FREE_JUMP"),A=2+(f?1:0);if(!hn(i.position,a,A))return r.push("Target out of range!"),{effects:c,messages:r,consumesTurn:!1};const v=Ee(e,a),S=ji(e,a),_=Rs(e,i,a);if(S)return r.push("Cannot jump into a wall!"),{effects:c,messages:r,consumesTurn:!1};if(!_)return r.push("Cannot land on hazard!"),{effects:c,messages:r,consumesTurn:!1};if(v&&!b)return r.push("Target hex is blocked!"),{effects:c,messages:r,consumesTurn:!1};if(v&&b){const p=pn({attackerId:i.id,targetId:v.id,skillId:"JUMP",basePower:99,trinity:Qe(i),targetTrinity:Qe(v),damageClass:"physical",scaling:[{attribute:"body",coefficient:.15}],statusMultipliers:[]});c.push({type:"Damage",target:v.id,amount:p.finalPower,scoreEvent:p.scoreEvent}),r.push(`Meteor Impact killed ${v.subtype||"enemy"}!`)}if(c.push({type:"Message",text:"Jumped!"}),c.push({type:"Displacement",target:"self",destination:a,ignoreCollision:!0,ignoreGroundHazards:!0,simulatePath:!0}),h){const p=ot(a);let g=!1;for(const R of p){const I=Ee(e,R);I&&I.id!==i.id&&(c.push({type:"ApplyStatus",target:I.id,status:"stunned",duration:1}),g=!0)}g&&r.push("Enemies stunned by landing impact!")}return c.push({type:"Juice",effect:"shake",target:a,intensity:"medium"}),{effects:c,messages:r,consumesTurn:!y}},getValidTargets:(e,i)=>{const a=Ee(e,i);if(!a)return[];const o=a.activeSkills?.find(h=>h.id==="JUMP"),c=new Set(o?.activeUpgrades||[]),r=2+(c.has("JUMP_RANGE")?1:0),f=c.has("METEOR_IMPACT");return tt.getAreaTargets(e,i,r).filter(h=>{if(ne(h,i)||ji(e,h)||!Rs(e,a,h))return!1;const b=Ee(e,h);return!(b&&b.id!==a.id&&!f)})},upgrades:{JUMP_RANGE:{id:"JUMP_RANGE",name:"Extended Jump",description:"Jump range +1"},JUMP_COOLDOWN:{id:"JUMP_COOLDOWN",name:"Nimble",description:"Jump cooldown -1",modifyCooldown:-1},STUNNING_LANDING:{id:"STUNNING_LANDING",name:"Stunning Landing",description:"All enemies within 1 hex of landing are stunned"},METEOR_IMPACT:{id:"METEOR_IMPACT",name:"Meteor Impact",description:"Can land on enemies to kill them"},FREE_JUMP:{id:"FREE_JUMP",name:"Free Jump",description:"Can move after jumping"}},scenarios:vt("JUMP")},cS={id:"BULWARK_CHARGE",name:"Bulwark Charge",description:"Charge into an adjacent enemy, pushing a chain. Wall hard-stop stuns the chain.",slot:"offensive",icon:"",baseVariables:{range:1,cost:0,cooldown:3},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};if(Ce(i.position,a)!==1)return c.push("Target not adjacent!"),{effects:o,messages:c,consumesTurn:!1};const f=Yi(e.enemies,a);if(!f)return c.push("No target!"),{effects:o,messages:c,consumesTurn:!1};const{isAxial:h,directionIndex:b}=ss(i.position,a);if(!h)return{effects:o,messages:c,consumesTurn:!1};const y=Un(b),A=[f];let v={q:f.position.q+y.q,r:f.position.r+y.r,s:f.position.s+y.s};for(;;){const p=Yi(e.enemies,v);if(p){if(A.push(p),v={q:v.q+y.q,r:v.r+y.r,s:v.s+y.s},A.length>6)break;continue}break}const S=[];for(let p=0;p<A.length;p++){const g=A[p],R=p===0?2:1,I={q:g.position.q+y.q*R,r:g.position.r+y.r*R,s:g.position.s+y.s*R};S.push({actor:g,dest:I})}let _=!1;for(const p of S){const g=e.tiles.get(he(p.dest));if(g?.baseId==="WALL"||g?.traits.has("BLOCKS_MOVEMENT")){_=!0;break}if(e.enemies.find(I=>ne(I.position,p.dest)&&!A.some(C=>C.id===I.id))){_=!0;break}}if(_){for(const p of A)o.push({type:"ApplyStatus",target:p.position,status:"stunned",duration:1}),c.push("Chain blocked! Stunned.");return{effects:o,messages:c}}for(const p of S)o.push({type:"Displacement",target:p.actor.id,destination:p.dest});return o.push({type:"Displacement",target:"self",destination:f.position}),c.push("Bulwark Charge!"),{effects:o,messages:c}},getValidTargets:(e,i)=>[{q:i.q+1,r:i.r,s:i.s-1},{q:i.q+1,r:i.r-1,s:i.s},{q:i.q,r:i.r-1,s:i.s+1},{q:i.q-1,r:i.r,s:i.s+1},{q:i.q-1,r:i.r+1,s:i.s},{q:i.q,r:i.r+1,s:i.s-1}].filter(o=>!!Yi(e.enemies,o)),upgrades:{},scenarios:[{id:"chain_stun",title:"Chain-Stun",description:"Wall prevents chain, chain gets stunned",setup:e=>{e.setPlayer({q:3,r:6,s:-9},["BULWARK_CHARGE"]),e.spawnEnemy("shieldBearer",{q:3,r:5,s:-8},"A"),e.spawnEnemy("shieldBearer",{q:3,r:4,s:-7},"B"),e.setTile({q:3,r:3,s:-6},"wall"),e.state.hasShield=!0},run:e=>{e.useSkill("BULWARK_CHARGE",{q:3,r:5,s:-8})},verify:(e,i)=>!0}]},uS={id:"BASIC_ATTACK",name:"Basic Attack",description:"Strike an adjacent enemy for 1 damage.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0,damage:1},execute:(e,i,a,o=[])=>{const c=[],r=[],f=(e.timelineEvents||[]).some(g=>g.phase==="STATUS_APPLY"&&g.type==="ApplyStatus"&&g.payload?.status==="stunned"&&(g.payload?.target===i.id||typeof g.payload?.target=="object"&&g.payload?.target&&ne(g.payload.target,i.position)));if(Ns(i)||f)return r.push("Cannot attack while stunned!"),{effects:c,messages:r,consumesTurn:!0};if(!a)return r.push("Select a target!"),{effects:c,messages:r,consumesTurn:!1};if(!hn(i.position,a,1))return r.push("Target out of range!"),{effects:c,messages:r,consumesTurn:!1};const b=Ee(e,a);if(!b||b.id===i.id)return r.push("No enemy at target!"),{effects:c,messages:r,consumesTurn:!1};if(b.factionId===i.factionId)return r.push("Cannot attack friendlies!"),{effects:c,messages:r,consumesTurn:!1};if(b.subtype==="bomb")return r.push("Cannot attack a bomb!"),{effects:c,messages:r,consumesTurn:!1};let y=1;o.includes("POWER_STRIKE")&&(y+=2);const A=ne(i.previousPosition||i.position,i.position);o.includes("EXTENDED_REACH")&&A&&(y+=1);const v=pn({attackerId:i.id,targetId:b.id,skillId:"BASIC_ATTACK",basePower:y,trinity:Qe(i),targetTrinity:Qe(b),damageClass:"physical",scaling:[{attribute:"body",coefficient:.5}],statusMultipliers:[],inDangerPreviewHex:!!e.intentPreview?.dangerTiles?.some(g=>ne(g,i.position)),theoreticalMaxPower:y}),S=v.finalPower;c.push({type:"Damage",target:"targetActor",amount:S,scoreEvent:v.scoreEvent});const _=i.type==="player"?"You":`${i.subtype||"enemy"}#${i.id}`,p=b.type==="player"?"you":`${b.subtype||"enemy"}#${b.id}`;if(r.push(`${_} attacked ${p}!`),o.includes("VAMPIRIC")){const g=Math.max(0,S-(b.temporaryArmor||0));b.hp-g<=0&&(c.push({type:"Heal",target:i.id,amount:1}),r.push("Vampiric heal!"))}return{effects:c,messages:r,consumesTurn:!0}},getValidTargets:(e,i)=>{const a=Ee(e,i);return a?ot(i).filter(c=>{const r=Ee(e,c);return!!r&&r.subtype!=="bomb"&&r.id!==a.id&&r.factionId!==a.factionId}):[]},upgrades:{EXTENDED_REACH:{id:"EXTENDED_REACH",name:"Disciplined Stance",description:"+1 damage when attacking without moving first."},POWER_STRIKE:{id:"POWER_STRIKE",name:"Power Strike",description:"Damage +2"},VAMPIRIC:{id:"VAMPIRIC",name:"Vampiric",description:"Heal 1 HP on kill"}},scenarios:vt("BASIC_ATTACK")},dS={id:"SENTINEL_TELEGRAPH",name:"Sentinel Telegraph",description:"The Sentinel marks an impact zone for a delayed blast.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:0},execute:(e,i,a)=>a?{effects:[{type:"Juice",effect:"combat_text",target:a,text:"TELEGRAPH"}],messages:["The Sentinel marks the impact zone."],consumesTurn:!0}:{effects:[],messages:[],consumesTurn:!0},getValidTargets:(e,i)=>tt.getAreaTargets(e,i,3),upgrades:{},scenarios:vt("SENTINEL_TELEGRAPH")},fS={id:"SENTINEL_BLAST",name:"Sentinel Blast",description:"A massive energy surge from the Sentinel.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:0,damage:2},execute:(e,i,a)=>{if(!a)return{effects:[],messages:[]};const o=Qe(i),c=Ee(e,a),r=pn({attackerId:i.id,targetId:c?.id||he(a),skillId:"SENTINEL_BLAST",basePower:2,trinity:o,targetTrinity:c?Qe(c):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.2}],statusMultipliers:[]}),f=[{type:"Damage",target:a,amount:r.finalPower,scoreEvent:r.scoreEvent},{type:"Juice",effect:"shake",intensity:"high"}];return ot(a).forEach(b=>{const y=Ee(e,b),A=pn({attackerId:i.id,targetId:y?.id||he(b),skillId:"SENTINEL_BLAST",basePower:1,trinity:o,targetTrinity:y?Qe(y):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.1}],statusMultipliers:[]});f.push({type:"Damage",target:b,amount:A.finalPower,scoreEvent:A.scoreEvent})}),{effects:f,messages:["The Sentinel unleashed a massive blast!"],consumesTurn:!0}},getValidTargets:(e,i)=>tt.getAreaTargets(e,i,3),upgrades:{},scenarios:vt("SENTINEL_BLAST")},mS={id:"THEME_HAZARDS",name:"Theme Hazards",description:"Internal skill for testing floor themes.",slot:"passive",icon:"",baseVariables:{range:0,cost:0,cooldown:0},execute:e=>({effects:[],messages:[]}),upgrades:{},scenarios:vt("THEME_HAZARDS")},pS={id:"SHIELD_THROW",name:"Shield Throw",description:"Throw your shield to strike and push enemies. Triggers a kinetic pulse on impact.",slot:"defensive",icon:"",baseVariables:{range:4,cost:1,cooldown:3},execute:(e,i,a,o=[])=>{const c=[],r=[];if(!a)return{effects:c,messages:r,consumesTurn:!1};if(!e.hasShield)return r.push("Shield not in hand!"),{effects:c,messages:r,consumesTurn:!1};c.push(...Kt.SHIELD_THROW.anticipation(i.position,a));const{isValid:f,blockedBy:h,blockedAt:b}=Hf(e,i.position,a,{stopAtWalls:!0,stopAtActors:!0,excludeActorId:i.id});if(!f&&h==="wall")return r.push("Shield hit a wall mid-flight!"),c.push({type:"SpawnItem",itemType:"shield",position:b}),{effects:c,messages:r,consumesTurn:!0};const y=Ee(e,a);if(!y)return r.push("Shield missed: No target at location."),c.push({type:"SpawnItem",itemType:"shield",position:a}),{effects:c,messages:r,consumesTurn:!0};const A=Pt(i.position,a);c.push(...Kt.SHIELD_THROW.execution(A));const v=4,{directionIndex:S}=ss(i.position,a),_=Un(S);c.push({type:"ApplyStatus",target:y.id,status:"stunned",duration:1}),c.push(...Kt.SHIELD_THROW.impact(a,_));const p=Xc(e,{origin:a,direction:_,momentum:v}),g=p.filter(M=>M.type==="Displacement"&&M.target===y.id),R=g[g.length-1],I=R&&"destination"in R?R.destination:a,C=Pt(a,I);return C.length>1&&c.push(...Kt.SHIELD_THROW.resolution(C)),c.push({type:"SpawnItem",itemType:"shield",position:I}),r.push("Direct hit! Shield triggered kinetic pulse."),{effects:[...c,...p],messages:r,consumesTurn:!0}},getValidTargets:(e,i)=>tt.getAxialTargets(e,i,4),upgrades:{},scenarios:vt("SHIELD_THROW")},hS={id:"VAULT",name:e=>e.turnNumber%2!==0?"Stun Vault":"Vault",description:e=>e.turnNumber%2!==0?"Leap to an empty tile and stun neighbors. (Odd Turn)":"Leap to an empty tile. (Even Turn)",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:0},execute:(e,i,a,o=[])=>{const c=[],r=[];if(!a)return{effects:c,messages:r,consumesTurn:!1};if(!hn(i.position,a,2))return r.push("Out of range!"),{effects:c,messages:r,consumesTurn:!1};if(ji(e,a)||ha(e,a))return r.push("Blocked!"),{effects:c,messages:r,consumesTurn:!1};if(!Rs(e,i,a))return r.push("Blocked!"),{effects:c,messages:r,consumesTurn:!1};const f=e.turnNumber%2!==0;c.push(...Kt.VAULT.anticipation(i.position,a));const h=Pt(i.position,a);if(c.push(...Kt.VAULT.execution(h)),c.push({type:"Displacement",target:"self",destination:a,path:h,ignoreGroundHazards:!0,animationDuration:250}),f){r.push("Stun Vault executed!");const b=ot(a);for(const y of b)Yi(e.enemies,y)&&c.push({type:"ApplyStatus",target:y,status:"stunned",duration:1});c.push(...Kt.VAULT.impact(a,!0)),r.push("Slam landing! Neighbors stunned.")}else c.push(...Kt.VAULT.impact(a,!1)),r.push("Vaulted!");return{effects:c,messages:r}},getValidTargets:(e,i)=>{const o=Ee(e,i);return o?tt.getAreaTargets(e,i,2).filter(c=>ne(c,i)?!1:!ji(e,c)&&!ha(e,c)&&Rs(e,o,c)):[]},upgrades:{},scenarios:[{id:"vault_shift_stun",title:"Vault State-Shifting: Stun (Turn 1)",description:"Verify vault stuns on Turn 1 (Odd).",setup:e=>{e.setTurn(1),e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>{e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,i)=>i.some(a=>a.includes("Stun Vault executed!"))},{id:"vault_shift_normal",title:"Vault State-Shifting: Normal (Turn 2)",description:"Verify vault is normal on Turn 2 (Even).",setup:e=>{e.setTurn(2),e.setPlayer({q:3,r:6,s:-9},["VAULT"]),e.spawnEnemy("footman",{q:3,r:5,s:-8},"victim")},run:e=>{e.useSkill("VAULT",{q:3,r:4,s:-7})},verify:(e,i)=>i.some(a=>a.includes("Vaulted!"))&&!i.some(a=>a.includes("Slam landing!"))}]},Bg=(e,i)=>e.enemies.filter(o=>o.hp>0&&o.factionId==="enemy").length===0?20:Math.max(i.speed||1,1),Hy=(e,i)=>tt.isWithinBounds(e,i)?qe.getTraitsAt(e,i).has("BLOCKS_MOVEMENT"):!0,jg=(e,i,a,o)=>{const c=new Map,r=[],f=b=>`${b.q},${b.r}`,h=[{p:a,cost:0}];for(c.set(f(a),0);h.length>0;){const b=h.shift();if(!(b.cost>=o))for(const y of ot(b.p)){if(!tt.isWithinBounds(e,y)||!qe.isWalkable(e,y)||!Dy(e,i,y,"BASIC_MOVE"))continue;const A=Ee(e,y),v=!!A&&A.id!==i.id,S=v&&A.factionId===i.factionId;if(v&&!S)continue;const _=f(y),p=b.cost+1;c.has(_)&&c.get(_)<=p||(c.set(_,p),!S&&Rs(e,i,y)&&!Hy(e,y)&&r.push(y),h.push({p:y,cost:p}))}}return r},gS=(e,i,a,o,c)=>{const r=_=>`${_.q},${_.r}`,f=_=>{const[p,g]=_.split(",").map(Number);return{q:p,r:g,s:-p-g}},h=[a],b=new Map([[r(a),0]]),y=new Map([[r(a),null]]);for(;h.length>0;){const _=h.shift(),p=r(_),g=b.get(p);if(!(g>=c))for(const R of ot(_)){if(!tt.isWithinBounds(e,R)||!qe.isWalkable(e,R)||!Dy(e,i,R,"BASIC_MOVE"))continue;const I=Ee(e,R),C=!!I&&I.id!==i.id,M=C&&I.factionId===i.factionId;if(C&&!M)continue;const N=r(R),Y=g+1;b.has(N)&&b.get(N)<=Y||(b.set(N,Y),y.set(N,p),h.push(R))}}const A=r(o);if(!y.has(A)||Hy(e,o)||!Rs(e,i,o))return null;const v=[];let S=A;for(;S;)v.push(f(S)),S=y.get(S)||null;return v.reverse(),v},yS={id:"BASIC_MOVE",name:"Walk",description:"Move to an adjacent or nearby tile within your speed range.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};const r=Bg(e,i),h=jg(e,i,i.position,r).some(A=>ne(A,a)),b=gS(e,i,i.position,a,r);if(!h||!b||b.length<2)return c.push("Target out of reach or blocked!"),{effects:o,messages:c,consumesTurn:!1};o.push({type:"Displacement",target:"self",destination:a,source:i.position,path:b,simulatePath:!0,ignoreCollision:!0});const y=i.id===e.player.id?"You":`${i.subtype||"enemy"}#${i.id}`;return c.push(`${y} moved to (${a.q}, ${a.r}). [Range ${r}]`),{effects:o,messages:c,consumesTurn:!0}},getValidTargets:(e,i)=>{const a=Ee(e,i);if(!a)return[];const o=Bg(e,a);return jg(e,a,i,o).filter(r=>!ha(e,r,a.id))},upgrades:{},scenarios:vt("BASIC_MOVE")},bS={id:"DASH",name:"Kinetic Dash",description:"Dash in a straight line. With a shield, slam into enemies and send them flying!",slot:"passive",icon:"",baseVariables:{range:4,cost:0,cooldown:0},execute:(e,i,a,o=[])=>{const c=[],r=[],f=o.includes("MOMENTUM_SURGE"),h=o.includes("DASH_CHAIN_REACTION")||o.includes("CHAIN_REACTION");if(!a)return{effects:c,messages:r,consumesTurn:!1};const{isAxial:b,directionIndex:y}=ss(i.position,a),v=e.enemies.filter(I=>I.hp>0).length===0?20:4;if(!hn(i.position,a,v))return{effects:c,messages:["Out of range!"],consumesTurn:!1};if(!b)return{effects:c,messages:["Axial only! Dash must be in a straight line."],consumesTurn:!1};c.push(...Kt.DASH.anticipation(i.position,a));const S=Un(y),_=Pt(i.position,a),p=Df(e,_.slice(1),{checkWalls:!0,checkActors:!0,checkLava:!1,excludeActorId:i.id});let g=a;if(p.obstacle){if(p.obstacle==="wall")return{effects:c,messages:["A wall blocks the way!"],consumesTurn:!1};if(p.obstacle==="lava")return{effects:c,messages:["Lava blocks the way!"],consumesTurn:!1};const I=_.findIndex(C=>ne(C,p.position));g=_[I-1]||i.position}if(p.obstacle==="actor"?p.actor:null){const I=Pt(i.position,g);c.push(...Kt.DASH.execution(I));const C=[{type:"Displacement",target:"self",destination:g,path:I,simulatePath:!0,ignoreGroundHazards:!0,animationDuration:I.length*60}],M=yi(e,C,{sourceId:i.id});if(e.hasShield){c.push(...Kt.DASH.impact(g,S,!0));const N=5+(e.hasShield&&f?2:0)+(h?1:0),Y=Xc(M,{origin:g,direction:S,momentum:N});return{effects:[...c,...C,...Y],messages:[...r,"Shield Shunt!"],consumesTurn:!0}}else return c.push(...Kt.DASH.impact(g,S,!1)),{effects:[...c,...C],messages:[...r,"Stopped by an obstacle (Need shield to shunt)."],consumesTurn:!ne(i.position,g)}}else{const I=Pt(i.position,g);c.push(...Kt.DASH.execution(I));const C={type:"Displacement",target:"self",destination:g,path:I,simulatePath:!0,ignoreGroundHazards:!0,animationDuration:I.length*60};return{effects:[...c,C],messages:[...r,"Dashed!"],consumesTurn:!ne(i.position,g)}}},getValidTargets:(e,i)=>{const o=e.enemies.filter(r=>r.hp>0).length===0?20:4,c=Ee(e,i);return c?tt.getAxialTargets(e,i,o,{stopAtObstacles:!0,includeActors:!0,includeWalls:!1}).filter(r=>Rs(e,c,r)):[]},upgrades:{MOMENTUM_SURGE:{id:"MOMENTUM_SURGE",name:"Momentum Surge",description:"+2 Momentum when dashing with shield"},DASH_CHAIN_REACTION:{id:"DASH_CHAIN_REACTION",name:"Chain Reaction",description:"Enemies pushed into other enemies transfer momentum"}},scenarios:vt("DASH")},xS=new Set(["FIREBALL","FIREWALL","FIREWALK","ABSORB_FIRE"]),Py=(e,i)=>{const a=qe.getTileAt(e,i),o=qe.getTraitsForTile(e,a),c=r=>a.effects.some(f=>f.id===r);return a.baseId==="VOID"||o.has("VOID")||o.has("PIT")?"VOID_TOUCHED":a.baseId==="ICE"||c("ICE_WALL")?"FROZEN":a.baseId==="LAVA"||o.has("LAVA")||o.has("FIRE")||c("FIRE")?"MELTED":c("WET")||c("STEAM")?"SOAKED":"STABLE"},Uy=(e,i)=>xS.has(e)&&i==="MELTED"?1.15:1,vS={id:"FIREBALL",name:"Fireball",description:"Launch a sphere of flame. Range 3, Axial. Deals damage and leaves fire.",slot:"offensive",icon:"",baseVariables:{range:3,cost:1,cooldown:2},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};const{isAxial:r}=ss(i.position,a);if(!hn(i.position,a,3)||!r)return{effects:o,messages:["Invalid target! Range 3, Axial only."],consumesTurn:!1};const f=[a,...ot(a)],h=Qe(i),b=!!e.intentPreview?.dangerTiles?.some(y=>ne(y,i.position));for(const y of f){const A=Ee(e,y),v=Py(e,y),S=Uy("FIREBALL",v),_=pn({attackerId:i.id,targetId:A?.id||he(y),skillId:"FIREBALL",basePower:1,trinity:h,targetTrinity:A?Qe(A):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.2}],statusMultipliers:S===1?[]:[{id:`surface_${v}`,multiplier:S}],inDangerPreviewHex:b,theoreticalMaxPower:1});o.push({type:"Damage",target:y,amount:_.finalPower,reason:"fireball",scoreEvent:_.scoreEvent}),o.push({type:"PlaceFire",position:y,duration:3})}return o.push({type:"Juice",effect:"flash",target:a,color:"#ff4400"}),o.push({type:"Juice",effect:"shake",intensity:"medium"}),c.push("Fireball!"),{effects:o,messages:c,consumesTurn:!0}},getValidTargets:(e,i)=>tt.getAxialTargets(e,i,3),upgrades:{},scenarios:vt("FIREBALL")},SS={id:"FIREWALL",name:"Firewall",description:"Create a wall of flames 5 tiles wide. Area denial.",slot:"utility",icon:"",baseVariables:{range:4,cost:1,cooldown:4},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};const{isAxial:r,directionIndex:f}=ss(i.position,a);if(!r)return{effects:o,messages:["Axial targeting only!"],consumesTurn:!1};const h=(f+2)%6,b=(f+5)%6,y=[a];let A=a;for(let S=0;S<2;S++)A=Wn(A,Un(h)),tt.isWithinBounds(e,A)&&y.push(A);let v=a;for(let S=0;S<2;S++)v=Wn(v,Un(b)),tt.isWithinBounds(e,v)&&y.push(v);for(const S of y)if(!ji(e,S)){o.push({type:"PlaceFire",position:S,duration:3});const _=Ee(e,S);if(_){const p=Py(e,S),g=Uy("FIREWALL",p),R=pn({attackerId:i.id,targetId:_.id,skillId:"FIREWALL",basePower:1,trinity:Qe(i),targetTrinity:Qe(_),damageClass:"magical",scaling:[{attribute:"mind",coefficient:.15}],statusMultipliers:g===1?[]:[{id:`surface_${p}`,multiplier:g}]});o.push({type:"Damage",target:_.id,amount:R.finalPower,reason:"firewall_impact",scoreEvent:R.scoreEvent})}}return o.push({type:"Juice",effect:"flash",target:a,color:"#ffaa00"}),c.push("Firewall raised!"),{effects:o,messages:c,consumesTurn:!0}},getValidTargets:(e,i)=>tt.getAxialTargets(e,i,4),upgrades:{},scenarios:vt("FIREWALL")},AS={id:"FIREWALK",name:"Firewalk",description:"Teleport to a fire or lava tile. Grants 2 turns of Fire Immunity.",slot:"utility",icon:"",baseVariables:{range:4,cost:1,cooldown:3},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};if(!hn(i.position,a,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const r=e.tiles.get(he(a)),f=r?.effects.some(b=>b.id==="FIRE"),h=r?.baseId==="LAVA"||r?.traits.has("LIQUID");return!f&&!h?{effects:o,messages:["Can only teleport to Fire or Lava!"],consumesTurn:!1}:ha(e,a,i.id)?{effects:o,messages:["Target position occupied!"],consumesTurn:!1}:(o.push({type:"Displacement",target:"self",destination:a,source:i.position,simulatePath:!1}),o.push({type:"ApplyStatus",target:"self",status:"fire_immunity",duration:2}),o.push({type:"Juice",effect:"flash",target:a,color:"#ff8800"}),c.push("Firewalk!"),{effects:o,messages:c,consumesTurn:!0})},getValidTargets:(e,i)=>{const a=[];return e.tiles.forEach(o=>{const c=Ce(i,o.position);if(c>0&&c<=4){const r=o.effects.some(h=>h.id==="FIRE"),f=o.baseId==="LAVA"||o.traits.has("LIQUID");(r||f)&&a.push(o.position)}}),a},upgrades:{},scenarios:vt("FIREWALK")},TS={id:"BOMB_TOSS",name:"Bomb Toss",description:"Throw a bomb to a nearby tile.",slot:"offensive",icon:"",baseVariables:{range:3,cost:0,cooldown:2},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};if(!hn(i.position,a,3))return c.push("Out of range!"),{effects:o,messages:c,consumesTurn:!1};if(!qe.isWalkable(e,a))return c.push("Target blocked!"),{effects:o,messages:c,consumesTurn:!1};if(Ee(e,a))return c.push("Target occupied!"),{effects:o,messages:c,consumesTurn:!1};const f=`bomb-${i.id}-${e.turnNumber}-${e.actionLog?.length??0}-${a.q}_${a.r}_${a.s}`,h=ma({id:f,type:"enemy",subtype:"bomb",factionId:i.factionId,position:a,speed:10,skills:["TIME_BOMB"],weightClass:"Standard"});return h.statusEffects=[{id:"TIME_BOMB",type:"time_bomb",duration:2,tickWindow:"END_OF_TURN"}],o.push({type:"SpawnActor",actor:h}),c.push("Bomb tossed!"),{effects:o,messages:c,consumesTurn:!0}},getValidTargets:(e,i)=>{const o=[];for(let c=-3;c<=3;c++)for(let r=Math.max(-3,-c-3);r<=Math.min(3,-c+3);r++){const f={q:i.q+c,r:i.r+r,s:i.s-c-r};hn(i,f,3)&&qe.isWalkable(e,f)&&(Ee(e,f)||o.push(f))}return o},upgrades:{}},ES={id:"TIME_BOMB",name:"Time Bomb",description:"Detonates when the fuse reaches zero.",slot:"passive",icon:"",baseVariables:{range:0,cost:0,cooldown:0,damage:1},execute:(e,i,a)=>{const o=i.statusEffects.find(h=>h.type==="time_bomb");if(o&&o.duration>1)return{effects:[],messages:[],consumesTurn:!0};const c=i.position,f=[c,...ot(c)].map(h=>({type:"Damage",target:h,amount:1,reason:"bomb_explosion"}));return f.push({type:"Damage",target:i.id,amount:999,reason:"bomb_explosion"}),f.push({type:"Juice",effect:"explosion_ring",target:c,intensity:"high"}),{effects:f,messages:["A bomb exploded!"],consumesTurn:!0}},getValidTargets:(e,i)=>[i],upgrades:{}},wS=(e,i)=>!!e.tiles.get(he(i))?.traits?.has("CORPSE"),_S=(e,i,a)=>{const o=[];return e.tiles.forEach(c=>{c.traits.has("CORPSE")&&Ce(i,c.position)<=a&&o.push(c.position)}),o},MS={id:"CORPSE_EXPLOSION",name:"Corpse Explosion",description:"Detonate a target corpse, dealing damage in a 1-tile radius.",slot:"offensive",icon:"",baseVariables:{range:4,cost:1,cooldown:2},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};if(!wS(e,a))return{effects:o,messages:["A corpse is required!"],consumesTurn:!1};if(!hn(i.position,a,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};o.push({type:"RemoveCorpse",position:a});const f=[a,...ot(a)],h=Qe(i),b=!!e.intentPreview?.dangerTiles?.some(y=>ne(y,i.position));for(const y of f){const A=Ee(e,y),v=pn({attackerId:i.id,targetId:A?.id||he(y),skillId:"CORPSE_EXPLOSION",basePower:2,trinity:h,targetTrinity:A?Qe(A):void 0,damageClass:"magical",scaling:[{attribute:"mind",coefficient:.25}],statusMultipliers:[],inDangerPreviewHex:b,theoreticalMaxPower:2});o.push({type:"Damage",target:y,amount:v.finalPower,reason:"corpse_explosion",scoreEvent:v.scoreEvent})}return o.push({type:"Juice",effect:"explosion_ring",target:a}),o.push({type:"Juice",effect:"shake",intensity:"high"}),o.push({type:"Juice",effect:"combat_text",target:a,text:"BOOM!"}),c.push("Corpse exploded!"),{effects:o,messages:c,consumesTurn:!0}},getValidTargets:(e,i)=>_S(e,i,4),upgrades:{},scenarios:vt("CORPSE_EXPLOSION")},OS=(e,i)=>i.q>=0&&i.q<e.gridWidth&&i.r>=0&&i.r<e.gridHeight,CS=(e,i,a)=>ot(a).filter(c=>OS(e,c)).filter(c=>qe.isWalkable(e,c)).filter(c=>!Ee(e,c)).sort((c,r)=>{const f=Ce(c,i.position),h=Ce(r,i.position);return f!==h?f-h:c.q!==r.q?c.q-r.q:c.r-r.r})[0]||null,NS=(e,i)=>i.id!==e.id&&i.factionId===e.factionId;function Dg(e,i,a,o="fail"){const c=Ee(e,a);if(!c)return{ok:!0,spawnPosition:a,effects:[],messages:[]};if(o==="push_friendly"){if(!NS(i,c))return{ok:!1,effects:[],messages:[],failureMessage:"Target tile occupied."};const r=CS(e,i,a);return r?{ok:!0,spawnPosition:a,effects:[{type:"Displacement",target:c.id,destination:r,source:c.position,simulatePath:!0}],messages:["Ally repositions to make room."]}:{ok:!1,effects:[],messages:[],failureMessage:"No space to reposition ally."}}return{ok:!1,effects:[],messages:[],failureMessage:"Target tile occupied."}}const RS=(e,i)=>!!e.tiles.get(he(i))?.traits?.has("CORPSE"),kS=(e,i,a)=>{const o=[];return e.tiles.forEach(c=>{c.traits.has("CORPSE")&&Ce(i,c.position)<=a&&o.push(c.position)}),o},LS=e=>{const i=e.initialSeed??e.rngSeed??"0",a=new Set([...e.enemies.map(r=>r.id),...(e.companions||[]).map(r=>r.id)]);let o=(e.floor<<20)+(e.turnNumber<<12)+(e.actionLog?.length??0)+(e.rngCounter??0),c=`skeleton_${Po(i,o,8,"skeleton")}`;for(;a.has(c);)o+=1,c=`skeleton_${Po(i,o,8,"skeleton")}`;return c},IS={id:"RAISE_DEAD",name:"Raise Dead",description:"Reanimate a target corpse into a Skeleton minion (Faction: Player).",slot:"utility",icon:"",baseVariables:{range:4,cost:1,cooldown:3},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};if(!RS(e,a))return{effects:o,messages:["A corpse is required!"],consumesTurn:!1};if(!hn(i.position,a,4))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const f=Dg(e,i,a,"push_friendly");if(!f.ok)return{effects:o,messages:[f.failureMessage||"Target tile occupied."],consumesTurn:!1};o.push(...f.effects),c.push(...f.messages),o.push({type:"RemoveCorpse",position:a});const h=Iy({companionType:"skeleton",ownerId:i.id,id:LS(e),position:a});return o.push({type:"SpawnActor",actor:h}),o.push({type:"Juice",effect:"flash",target:a,color:"#aaaaaa"}),c.push("Skeleton raised!"),{effects:o,messages:c,consumesTurn:!0}},getValidTargets:(e,i)=>{const a=Ee(e,i);return a?kS(e,i,4).filter(o=>Dg(e,a,o,"push_friendly").ok):[]},upgrades:{},scenarios:vt("RAISE_DEAD")},BS={id:"SOUL_SWAP",name:"Soul Swap",description:"Instantly swap positions with a player-aligned minion.",slot:"utility",icon:"",baseVariables:{range:6,cost:0,cooldown:3},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};if(!hn(i.position,a,6))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const r=Ee(e,a);return!r||r.factionId!=="player"||r.id===i.id?{effects:o,messages:["Target must be a minion!"],consumesTurn:!1}:(o.push({type:"Displacement",target:i.id,destination:a}),o.push({type:"Displacement",target:r.id,destination:i.position}),o.push({type:"Juice",effect:"flash",target:a,color:"#330066"}),o.push({type:"Juice",effect:"flash",target:i.position,color:"#330066"}),c.push("Soul Swapped!"),{effects:o,messages:c,consumesTurn:!0})},getValidTargets:(e,i)=>e.enemies.filter(a=>a.factionId==="player"&&hn(i,a.position,6)).map(a=>a.position),upgrades:{},scenarios:vt("SOUL_SWAP")},jS={id:"MULTI_SHOOT",name:"Multi-Shoot",description:"A spread of arrows. Axial range 4. Deals damage to target and neighbors.",slot:"offensive",icon:"",baseVariables:{range:4,cost:1,cooldown:1},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};const{isAxial:r}=ss(i.position,a);if(!hn(i.position,a,4)||!r)return{effects:o,messages:["Invalid target! Axial range 4 only."],consumesTurn:!1};const f=[a,...ot(a)],h=Qe(i);for(const b of f){const y=Ee(e,b),A=pn({attackerId:i.id,targetId:y?.id||he(b),skillId:"MULTI_SHOOT",basePower:1,trinity:h,targetTrinity:y?Qe(y):void 0,damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.1},{attribute:"mind",coefficient:.1}],statusMultipliers:[]});o.push({type:"Damage",target:b,amount:A.finalPower,reason:"multi_shoot",scoreEvent:A.scoreEvent})}return o.push({type:"Juice",effect:"flash",target:a,color:"#ffff00"}),c.push("Multi-Shoot!"),{effects:o,messages:c,consumesTurn:!0}},getValidTargets:(e,i)=>tt.getAxialTargets(e,i,4),upgrades:{},scenarios:vt("MULTI_SHOOT")},DS={id:"SET_TRAP",name:"Set Trap",description:"Place a hidden trap. Roots units for 3 turns.",slot:"utility",icon:"",baseVariables:{range:1,cost:1,cooldown:2},execute:(e,i,a)=>{const o=[],c=[];return a?ji(e,a)||Xa(e,a)?{effects:o,messages:["Cannot place trap here!"],consumesTurn:!1}:(o.push({type:"PlaceTrap",position:a,ownerId:i.id}),o.push({type:"Juice",effect:"combat_text",target:a,text:"Trapped"}),c.push("Trap set."),{effects:o,messages:c,consumesTurn:!0}):{effects:o,messages:c,consumesTurn:!1}},getValidTargets:(e,i)=>ot(i).filter(a=>!ji(e,a)&&!Xa(e,a)),upgrades:{},scenarios:vt("SET_TRAP")},HS={id:"SWIFT_ROLL",name:"Swift Roll",description:"Quickly dodge 2 tiles. Passive: Automatically roll away from attackers when hit.",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:2},execute:(e,i,a)=>{const o=[],c=[];return a?hn(i.position,a,2)?ji(e,a)||Xa(e,a)||ha(e,a,i.id)?{effects:o,messages:["Cannot roll there!"],consumesTurn:!1}:(o.push({type:"Displacement",target:"self",destination:a}),o.push({type:"Juice",effect:"dashBlur",target:a,path:[i.position,a]}),c.push("Swift roll!"),{effects:o,messages:c,consumesTurn:!0}):{effects:o,messages:["Too far!"],consumesTurn:!1}:{effects:o,messages:c,consumesTurn:!1}},getValidTargets:(e,i)=>tt.getAreaTargets(e,i,2).filter(o=>ne(o,i)?!1:!ji(e,o)&&!Xa(e,o)&&!ha(e,o)),upgrades:{},scenarios:vt("SWIFT_ROLL")},PS={id:"SNEAK_ATTACK",name:"Sneak Attack",description:"Attack an adjacent enemy. Deals massive damage if executed from stealth.",slot:"offensive",icon:"",baseVariables:{range:1,cost:0,cooldown:0},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};const r=Yi(e.enemies,a);if(!r)return{effects:o,messages:["No target!"],consumesTurn:!1};if(!hn(i.position,a,1))return{effects:o,messages:["Out of range!"],consumesTurn:!1};const f=(i.stealthCounter||0)>0,h=f?3:1,b=pn({attackerId:i.id,targetId:r.id,skillId:"SNEAK_ATTACK",basePower:h,trinity:Qe(i),targetTrinity:Qe(r),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.25}],statusMultipliers:[]});return o.push({type:"Damage",target:r.id,amount:b.finalPower,reason:"sneak_attack",source:i.position,scoreEvent:b.scoreEvent}),f?(o.push({type:"Juice",effect:"flash",target:a,color:"#ff0000"}),c.push("SNEAK ATTACK!")):c.push("Sneak attack (No stealth bonus)."),{effects:o,messages:c,consumesTurn:!0}},getValidTargets:(e,i)=>ot(i).filter(a=>!!Yi(e.enemies,a)),upgrades:{},scenarios:vt("SNEAK_ATTACK")},US={id:"SMOKE_SCREEN",name:"Smoke Screen",description:"Vanish into a cloud of smoke. Adds +2 to stealth counter.",slot:"utility",icon:"",baseVariables:{range:0,cost:0,cooldown:2},execute:(e,i,a)=>{const o=[],c=[];return o.push({type:"SetStealth",target:"self",amount:2}),o.push({type:"Juice",effect:"hiddenFade",target:i.position}),c.push("Smoke Screen!"),{effects:o,messages:c,consumesTurn:!0}},getValidTargets:(e,i)=>[i],upgrades:{},scenarios:vt("SMOKE_SCREEN")},qS={id:"SHADOW_STEP",name:"Shadow Step",description:"Teleport through the shadows. Only works while invisible. Extends stealth.",slot:"utility",icon:"",baseVariables:{range:2,cost:0,cooldown:2},execute:(e,i,a)=>{const o=[],c=[];return a?(i.stealthCounter||0)>0?hn(i.position,a,2)?ji(e,a)||Xa(e,a)||ha(e,a,i.id)?{effects:o,messages:["Cannot step there!"],consumesTurn:!1}:(o.push({type:"Displacement",target:"self",destination:a}),o.push({type:"SetStealth",target:"self",amount:2}),o.push({type:"Juice",effect:"hiddenFade",target:a}),c.push("Shadow stepped!"),{effects:o,messages:c,consumesTurn:!0}):{effects:o,messages:["Too far!"],consumesTurn:!1}:{effects:o,messages:["Must be invisible to Shadow Step!"],consumesTurn:!1}:{effects:o,messages:c,consumesTurn:!1}},getValidTargets:(e,i)=>(e.player.stealthCounter||0)>0?tt.getAreaTargets(e,i,2).filter(c=>ne(c,i)?!1:!ji(e,c)&&!Xa(e,c)&&!ha(e,c)):[],upgrades:{},scenarios:vt("SHADOW_STEP")};function uf(e,i){return e.enemies.find(a=>a.companionOf===i&&a.subtype==="falcon")}const zS={id:"FALCON_COMMAND",name:e=>{const i=e?.player?.id;if(!i)return"Summon Falcon";const a=uf(e,i);if(!a)return"Summon Falcon";const o=a.companionState?.mode||"roost";return o==="scout"?"Falcon: Scout":o==="predator"?"Falcon: Hunt":"Falcon: Roost"},description:e=>{const i=e?.player?.id;if(!i)return"Call your Falcon companion.";const a=uf(e,i);if(!a)return"Call your Falcon companion.";const o=a.companionState?.mode||"roost";return o==="scout"?"Click tile to set patrol zone. Falcon orbits and attacks nearby enemies.":o==="predator"?"Click enemy to mark as prey. Falcon pursues and uses Apex Strike.":"Falcon returns to you. Heals and cleanses 1 debuff on arrival."},slot:"offensive",icon:"",baseVariables:{range:6,cost:0,cooldown:0},execute:(e,i,a)=>{const o=[],c=[];let r=uf(e,i.id);if(!r){const b=Xx({ownerId:i.id,position:ot(i.position)[0]});return o.push({type:"SpawnActor",actor:b}),o.push({type:"Message",text:"Your Falcon companion awakens!"}),c.push("Falcon summoned!"),{effects:o,messages:c,consumesTurn:!0}}const f=a?Ee(e,a):void 0;return!a||ne(a,i.position)||!!(f&&f.id===i.id)?(c.push("Falcon returns to roost."),o.push({type:"Juice",effect:"combat_text",target:i.position,text:"Roost"}),o.push({type:"UpdateCompanionState",target:r.id,mode:"roost"}),{effects:o,messages:c,consumesTurn:!0}):f&&f.factionId==="enemy"?(c.push(`Falcon marks ${f.subtype||"enemy"} as prey!`),o.push({type:"Juice",effect:"combat_text",target:a,text:" Marked"}),o.push({type:"ApplyStatus",target:f.id,status:"marked_predator",duration:-1}),o.push({type:"UpdateCompanionState",target:r.id,mode:"predator",markTarget:f.id}),{effects:o,messages:c,consumesTurn:!0}):(c.push("Falcon set to patrol zone."),o.push({type:"Juice",effect:"combat_text",target:a,text:" Patrol"}),o.push({type:"UpdateCompanionState",target:r.id,mode:"scout",markTarget:a}),{effects:o,messages:c,consumesTurn:!0})},getValidTargets:(e,i)=>tt.getAreaTargets(e,i,6).filter(o=>(ne(o,i),!0)),upgrades:{KEEN_SIGHT:{id:"KEEN_SIGHT",name:"Keen Sight",description:"Falcon reveals hidden enemies within 3 tiles of its position."},FALCON_TWIN_TALONS:{id:"FALCON_TWIN_TALONS",name:"Twin Talons",description:"Basic Peck hits 2 targets instead of 1."},APEX_PREDATOR:{id:"APEX_PREDATOR",name:"Apex Predator",description:"Apex Strike cooldown reduced by 1. Marked enemies take +1 damage from all sources."}},scenarios:vt("FALCON_COMMAND")},$S={id:"FALCON_PECK",name:"Peck",description:"The falcon pecks an adjacent enemy for 1 damage.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0,damage:1},execute:(e,i,a,o=[])=>{const c=[],r=[],f=i.companionOf,b=(f?f===e.player.id?e.player:e.enemies.find(S=>S.id===f):void 0)?.activeSkills?.find(S=>S.id==="FALCON_COMMAND")?.activeUpgrades||[],y=o.includes("TWIN_TALONS")||b.includes("TWIN_TALONS")||b.includes("FALCON_TWIN_TALONS");if(!a)return{effects:c,messages:r,consumesTurn:!1};const A=Ee(e,a);if(!A||A.factionId==="player")return{effects:c,messages:r,consumesTurn:!1};if(Ce(i.position,a)>1)return{effects:c,messages:r,consumesTurn:!1};const v=[A];if(y){const S=ot(i.position).map(_=>Ee(e,_)).filter(_=>!!_&&_.id!==A.id&&_.factionId==="enemy")[0];S&&v.push(S)}for(const S of v){const _=pn({attackerId:i.id,targetId:S.id,skillId:"FALCON_PECK",basePower:1,trinity:Qe(i),targetTrinity:Qe(S),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.15}],statusMultipliers:[]});c.push({type:"Damage",target:S.id,amount:_.finalPower,reason:"falcon_peck",scoreEvent:_.scoreEvent})}return c.push({type:"Juice",effect:"combat_text",target:a,text:"Peck!",intensity:"low"}),r.push(y&&v.length>1?`Falcon pecked ${v.length} enemies!`:`Falcon pecked ${A.subtype||"enemy"}!`),{effects:c,messages:r,consumesTurn:!0}},getValidTargets:(e,i)=>ot(i).filter(a=>{const o=Ee(e,a);return o&&o.factionId==="enemy"}),upgrades:{TWIN_TALONS:{id:"TWIN_TALONS",name:"Twin Talons",description:"Peck hits 2 adjacent targets instead of 1."}},scenarios:vt("FALCON_PECK")},VS={id:"FALCON_APEX_STRIKE",name:"Apex Strike",description:"The falcon dives into a target for lethal damage.",slot:"passive",icon:"",baseVariables:{range:4,cost:0,cooldown:2,damage:40},execute:(e,i,a,o=[])=>{const c=[],r=[],f=i.companionOf,b=(f?f===e.player.id?e.player:e.enemies.find(S=>S.id===f):void 0)?.activeSkills?.find(S=>S.id==="FALCON_COMMAND")?.activeUpgrades||[],y=o.includes("APEX_PREDATOR")||b.includes("APEX_PREDATOR");if(!a)return{effects:c,messages:r,consumesTurn:!1};const A=Ee(e,a);if(!A)return{effects:c,messages:r,consumesTurn:!1};if(i.companionState?.apexStrikeCooldown&&i.companionState.apexStrikeCooldown>0)return{effects:c,messages:r,consumesTurn:!1};const v=pn({attackerId:i.id,targetId:A.id,skillId:"FALCON_APEX_STRIKE",basePower:40,trinity:Qe(i),targetTrinity:Qe(A),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});return c.push({type:"Damage",target:A.id,amount:v.finalPower,reason:"apex_strike",scoreEvent:v.scoreEvent}),c.push({type:"Juice",effect:"impact",target:a,intensity:"high"}),c.push({type:"UpdateCompanionState",target:i.id,apexStrikeCooldown:y?1:2}),r.push(`Falcon executes APEX STRIKE on ${A.subtype||"enemy"}!`),{effects:c,messages:r,consumesTurn:!0}},upgrades:{},getValidTargets:(e,i)=>{const a=[];return e.enemies.forEach(o=>{Ce(i,o.position)<=4&&a.push(o.position)}),a}},YS={id:"FALCON_HEAL",name:"Roost Heal",description:"The falcon roosts and restores health to its companion.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:1},execute:(e,i,a)=>{const o=[],c=[];if(!a)return{effects:o,messages:c,consumesTurn:!1};const r=Ee(e,a);return r?i.companionState?.healCooldown&&i.companionState.healCooldown>0?{effects:o,messages:c,consumesTurn:!1}:(o.push({type:"Heal",target:r.id,amount:1}),o.push({type:"Juice",effect:"flash",target:r.position,color:"#00ff88"}),o.push({type:"UpdateCompanionState",target:i.id,healCooldown:1}),c.push("Falcon roosts. You feel restored."),{effects:o,messages:c,consumesTurn:!0}):{effects:o,messages:c,consumesTurn:!1}},upgrades:{},getValidTargets:(e,i)=>{const a=[],o=e.player;return Ce(i,o.position)<=1&&a.push(o.position),a}},FS={id:"FALCON_SCOUT",name:"Scout Orbit",description:"The actor orbits a target point in a hexagonal ring.",slot:"passive",icon:"",baseVariables:{range:1,cost:0,cooldown:0},execute:(e,i,a)=>{const o=[],c=[],r=i.companionState?.markTarget;if(!r||typeof r!="object")return{effects:o,messages:c,consumesTurn:!1};const f=r,h=ot(f);let b;if(Ce(i.position,f)!==1)b=h.sort((y,A)=>Ce(i.position,y)-Ce(i.position,A))[0];else{const A=(h.findIndex(v=>ne(v,i.position))+1)%6;b=h[A]}return tt.isWithinBounds(e,b)&&qe.isWalkable(e,b)&&!Ee(e,b)?(o.push({type:"Displacement",target:i.id,destination:b,source:i.position,simulatePath:!0}),{effects:o,messages:c,consumesTurn:!0}):{effects:o,messages:c,consumesTurn:!1}},upgrades:{},getValidTargets:(e,i)=>[]},KS={id:"FALCON_AUTO_ROOST",name:"Auto Roost",description:"Automatically returns the falcon to roost mode when mark is lost.",slot:"passive",icon:"R",baseVariables:{range:0,cost:0,cooldown:0},execute:(e,i,a)=>({effects:[{type:"UpdateCompanionState",target:i.id,mode:"roost",markTarget:void 0}],messages:["Falcon loses prey and returns to roost mode."],consumesTurn:!0}),getValidTargets:(e,i)=>[i],upgrades:{}},Hg=2,GS=3,WS=3,XS=2;function QS(e,i){const a=[];for(let o=0;o<6;o++){let c=e;for(let r=0;r<i;r++)c=Wn(c,Un(o));a.push(c)}return a}function JS(e,i,a){return QS(i,a).filter(c=>!(!tt.isWithinBounds(e,c)||!qe.isWalkable(e,c)||Ee(e,c)))}const ZS={id:"KINETIC_TRI_TRAP",name:"Kinetic Tri-Trap",description:"Deploy 3 hidden traps on axial tiles. Triggered enemies are flung away.",slot:"defensive",icon:"",baseVariables:{range:Hg,cost:0,cooldown:WS},execute:(e,i,a,o=[])=>{const c=[],r=[];let f=e;const h=o.includes("VOLATILE_CORE"),b=o.includes("TRAP_CHAIN_REACTION")||o.includes("CHAIN_REACTION"),y=o.includes("QUICK_RELOAD"),A=JS(e,i.position,Hg);if(A.length===0)return{effects:c,messages:["No valid trap positions!"],consumesTurn:!1};const v=Math.min(GS,A.length),S=[];c.push({type:"RemoveTrap",position:{q:0,r:0,s:0},ownerId:i.id});const _=[...A];for(let p=0;p<v&&_.length!==0;p++){const{value:g,nextState:R}=Fa(f);f=R;const I=Math.floor(g*_.length)%_.length;S.push(_[I]),_.splice(I,1)}for(const p of S)c.push({type:"PlaceTrap",position:p,ownerId:i.id,volatileCore:h,chainReaction:b,resetCooldown:y?1:XS}),c.push({type:"Juice",effect:"flash",target:p,intensity:"low",color:"#ffaa00"});return r.push(`${S.length} traps deployed.`),{effects:c,messages:r,consumesTurn:!0}},getValidTargets:(e,i)=>[i],upgrades:{VOLATILE_CORE:{id:"VOLATILE_CORE",name:"Volatile Core",description:"Traps deal 1 damage when triggered."},TRAP_CHAIN_REACTION:{id:"TRAP_CHAIN_REACTION",name:"Chain Reaction",description:"When a trap triggers, adjacent traps also activate."},QUICK_RELOAD:{id:"QUICK_RELOAD",name:"Quick Reload",description:"Individual trap reset cooldown reduced to 1."}},scenarios:vt("KINETIC_TRI_TRAP")},Pg=1,Ug=1,e1=1,qy=2,t1=2;function n1(e,i,a,o=qy){const c=fa(a,i);if(c===-1)return null;const r=Un(c);for(let h=o;h>=e1;h--){let b=i,y=!0;for(let A=0;A<h;A++){if(b=Wn(b,r),!tt.isWithinBounds(e,b)){y=!1;break}if(!qe.isWalkable(e,b)){y=!1;break}}if(y&&!Ee(e,b))return b}const f=[(c+1)%6,(c+5)%6];for(const h of f){const b=Un(h);let y=Wn(i,b);if(tt.isWithinBounds(e,y)&&qe.isWalkable(e,y)&&!Ee(e,y))return y}return null}const i1={id:"WITHDRAWAL",name:"Withdrawal",description:"Quick shot + tactical backroll. Auto-triggers when enemies close in.",slot:"utility",icon:"",baseVariables:{range:Pg,cost:0,cooldown:t1,damage:Ug},execute:(e,i,a,o=[])=>{const c=[],r=[],f=o.includes("PARTING_SHOT"),h=o.includes("NIMBLE_FEET");if(!a)return{effects:c,messages:["No target!"],consumesTurn:!1};if(Ce(i.position,a)>Pg)return{effects:c,messages:["Target out of range!"],consumesTurn:!1};const y=Ee(e,a);if(!y)return{effects:c,messages:["No enemy at target!"],consumesTurn:!1};if(y.factionId===i.factionId)return{effects:c,messages:["Cannot target allies!"],consumesTurn:!1};const A=pn({attackerId:i.id,targetId:y.id,skillId:"WITHDRAWAL",basePower:Ug+(f?1:0),trinity:Qe(i),targetTrinity:Qe(y),damageClass:"physical",scaling:[{attribute:"instinct",coefficient:.2}],statusMultipliers:[]});c.push({type:"Damage",target:y.id,amount:A.finalPower,scoreEvent:A.scoreEvent}),c.push({type:"Juice",effect:"impact",target:a}),r.push(`Withdrawal shot hits ${y.subtype||"enemy"}!`);const v=h?3:qy,S=n1(e,i.position,a,v);return S?(c.push({type:"Displacement",target:"self",destination:S,source:i.position}),c.push({type:"Juice",effect:"dashBlur",target:S,path:[i.position,S]}),r.push("Backroll!")):r.push("No safe retreat available!"),{effects:c,messages:r,consumesTurn:!0}},getValidTargets:(e,i)=>ot(i).filter(a=>{const o=Ee(e,a);return o&&o.factionId==="enemy"}),upgrades:{PARTING_SHOT:{id:"PARTING_SHOT",name:"Parting Shot",description:"Withdrawal deals +1 damage."},NIMBLE_FEET:{id:"NIMBLE_FEET",name:"Nimble Feet",description:"Backroll distance increased to 3 hexes."},HAIR_TRIGGER:{id:"HAIR_TRIGGER",name:"Hair Trigger",description:"Passive reaction does not consume cooldown."}},scenarios:vt("WITHDRAWAL")},s1={id:"ABSORB_FIRE",name:"Absorb Fire",description:"Fire heals you instead of harming you.",slot:"passive",icon:"",baseVariables:{cost:0,cooldown:0,range:0},execute:(e,i,a)=>({effects:[],messages:[]}),getValidTargets:()=>[],upgrades:{}},ca=(e,i)=>e.includes(i),a1=e=>{const i=new Set,a=e.id;return((e.baseVariables.damage||0)>0||/(ATTACK|THROW|BLAST|FIREBALL|BASH|PECK|EXPLOSION|SPEAR|SHOOT)/.test(a))&&i.add("damage"),/(MOVE|DASH|JUMP|ROLL|VAULT|STEP|GRAPPLE|WITHDRAWAL|WALK)/.test(a)&&i.add("move"),/(HEAL|ABSORB)/.test(a)&&i.add("heal"),/(SHIELD|PROTECT|BULWARK)/.test(a)&&i.add("protect"),/(STUN|TRAP|SMOKE|TELEGRAPH|ROOT|SWAP|SCOUT)/.test(a)&&i.add("control"),/(RAISE|FALCON|SUMMON)/.test(a)&&i.add("summon"),/(FIRE|LAVA|HAZARD|TRAP)/.test(a)&&i.add("hazard"),e.slot==="offensive"&&i.add("damage"),e.slot==="defensive"&&i.add("protect"),e.slot==="utility"&&i.add("utility"),(e.baseVariables.cooldown>0||e.baseVariables.cost>0)&&i.add("economy"),i.size||i.add("utility"),[...i]},o1={BASIC_MOVE:{intentTags:["move","objective","utility"],target:{pattern:"single"},estimates:{movement:1}},BASIC_ATTACK:{intentTags:["damage"],target:{pattern:"single"},estimates:{damage:4}},AUTO_ATTACK:{intentTags:["damage","utility"],target:{pattern:"single"},estimates:{damage:2}},DASH:{intentTags:["move","damage","utility"],target:{pattern:"line"},estimates:{movement:2,damage:2},risk:{noProgressCastPenalty:5}},JUMP:{intentTags:["move","utility"],target:{pattern:"single"},estimates:{movement:2},risk:{noProgressCastPenalty:6}},SHIELD_BASH:{intentTags:["damage","control","protect"],target:{pattern:"single"},estimates:{damage:3,control:2},risk:{requireEnemyContact:!0,noContactPenalty:5,noProgressCastPenalty:7}},BULWARK_CHARGE:{intentTags:["move","protect","damage"],target:{pattern:"line"},estimates:{movement:2,damage:4,shielding:2}},VAULT:{intentTags:["move","utility","control"],target:{pattern:"single"},estimates:{movement:3,control:2}},GRAPPLE_HOOK:{intentTags:["move","control"],target:{pattern:"line"},estimates:{movement:3,control:2}},SHIELD_THROW:{intentTags:["damage","control"],target:{pattern:"line"},estimates:{damage:6,control:2}},SPEAR_THROW:{intentTags:["damage"],target:{pattern:"line"},estimates:{damage:5},risk:{requireEnemyContact:!0,noContactPenalty:4,noProgressCastPenalty:5}},FIREBALL:{intentTags:["damage","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{damage:5,control:1}},FIREWALL:{intentTags:["hazard","control","damage"],target:{pattern:"radius",aoeRadius:2},estimates:{damage:5,control:3}},FIREWALK:{intentTags:["move","hazard","utility"],target:{pattern:"single"},estimates:{movement:3},risk:{noProgressCastPenalty:8}},ABSORB_FIRE:{intentTags:["heal","hazard","utility"],target:{pattern:"self"},estimates:{healing:6},risk:{noProgressCastPenalty:2}},BOMB_TOSS:{intentTags:["damage","control","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{damage:6,control:2}},TIME_BOMB:{intentTags:["damage","hazard","utility"],target:{pattern:"self"},estimates:{damage:6,control:1}},CORPSE_EXPLOSION:{intentTags:["damage","control","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{damage:6,control:1}},RAISE_DEAD:{intentTags:["summon","control","utility"],target:{pattern:"single"},estimates:{summon:5}},SOUL_SWAP:{intentTags:["move","control","utility"],target:{pattern:"single"},estimates:{movement:2,control:2}},MULTI_SHOOT:{intentTags:["damage"],target:{pattern:"line"},estimates:{damage:5}},SET_TRAP:{intentTags:["control","hazard"],target:{pattern:"single"},estimates:{control:3}},SWIFT_ROLL:{intentTags:["move","utility"],target:{pattern:"single"},estimates:{movement:2}},SNEAK_ATTACK:{intentTags:["damage","move"],target:{pattern:"single"},estimates:{damage:8,movement:2},risk:{requireEnemyContact:!0,noContactPenalty:3,noProgressCastPenalty:4}},SMOKE_SCREEN:{intentTags:["control","protect","utility"],target:{pattern:"radius",aoeRadius:1},estimates:{control:4,shielding:4}},SHADOW_STEP:{intentTags:["move","damage","utility"],target:{pattern:"single"},estimates:{movement:3,damage:3}},FALCON_COMMAND:{intentTags:["summon","control","utility"],target:{pattern:"single"},estimates:{summon:4,control:2}},FALCON_PECK:{intentTags:["damage"],target:{pattern:"single"},estimates:{damage:3}},FALCON_APEX_STRIKE:{intentTags:["damage","control"],target:{pattern:"single"},estimates:{damage:5,control:1}},FALCON_HEAL:{intentTags:["heal","utility"],target:{pattern:"single"},estimates:{healing:4}},FALCON_SCOUT:{intentTags:["control","utility"],target:{pattern:"self"},estimates:{control:3}},FALCON_AUTO_ROOST:{intentTags:["summon","utility"],target:{pattern:"self"},estimates:{summon:2}},KINETIC_TRI_TRAP:{intentTags:["control","hazard"],target:{pattern:"radius",aoeRadius:1},estimates:{control:5,damage:4}},WITHDRAWAL:{intentTags:["move","control","utility"],target:{pattern:"single"},estimates:{movement:2,control:1}},SENTINEL_TELEGRAPH:{intentTags:["control","objective"],target:{pattern:"radius",aoeRadius:2},estimates:{control:3}},SENTINEL_BLAST:{intentTags:["damage","hazard"],target:{pattern:"radius",aoeRadius:2},estimates:{damage:7}},THEME_HAZARDS:{intentTags:["hazard","control"],target:{pattern:"global"},estimates:{control:2}}},l1=(e,i)=>i?{...e,...i,target:{...e.target,...i.target||{}},estimates:{...e.estimates,...i.estimates||{}},economy:{...e.economy,...i.economy||{}},risk:{...e.risk,...i.risk||{}}}:e,r1=e=>{const i=a1(e),a=(ca(i,"move"),"single"),o={id:e.id,intentTags:i,target:{range:Math.max(0,e.baseVariables.range||0),pattern:a},estimates:{damage:Math.max(0,e.baseVariables.damage||0),movement:ca(i,"move")?Math.max(1,Math.min(3,e.baseVariables.range||1)):0,healing:ca(i,"heal")?2:0,shielding:ca(i,"protect")?1:0,control:ca(i,"control")?1:0,summon:ca(i,"summon")?1:0},economy:{cost:Math.max(0,e.baseVariables.cost||0),cooldown:Math.max(0,e.baseVariables.cooldown||0),consumesTurn:!0},risk:{selfExposure:ca(i,"move")?.5:0,hazardAffinity:ca(i,"hazard")?.5:0},complexity:1};return l1(o,o1[e.id])},c1=e=>{const i=[];return(!e.intentTags||e.intentTags.length===0)&&i.push("intentTags must not be empty"),(!Number.isFinite(e.target.range)||e.target.range<0)&&i.push("target.range must be >= 0"),e.target.pattern||i.push("target.pattern is required"),(!Number.isFinite(e.economy.cooldown)||e.economy.cooldown<0)&&i.push("economy.cooldown must be >= 0"),(!Number.isFinite(e.economy.cost)||e.economy.cost<0)&&i.push("economy.cost must be >= 0"),(!Number.isFinite(e.complexity)||e.complexity<0)&&i.push("complexity must be >= 0"),i},u1=e=>{const i=[],a=[];for(const[o,c]of Object.entries(e)){const r=c.intentProfile||r1(c);c.intentProfile=r;const f=c1(r);f.length>0&&a.push({skillId:o,errors:f}),r||i.push(o)}return{missing:i,invalid:a}},d1=(e,i)=>e.player.id===i?e.player:e.enemies.find(a=>a.id===i)||e.companions?.find(a=>a.id===i),f1=(e,i,a)=>!!(e.player.id!==a&&ne(e.player.position,i)||e.enemies.some(o=>o.id!==a&&o.hp>0&&ne(o.position,i))||e.companions?.some(o=>o.id!==a&&o.hp>0&&ne(o.position,i))),qg=(e,i)=>{const a={q:i.q-e.q,r:i.r-e.r,s:i.s-e.s};let o=ar[0],c=Number.NEGATIVE_INFINITY;for(const r of ar){const f=r.q*a.q+r.r*a.r+r.s*a.s;f>c&&(c=f,o=r)}return o},m1=(e,i)=>{const a=d1(e,i.targetActorId);if(!a)return{effects:[],destination:null,collided:!1};const o=Math.max(0,Math.min(i.maxDistance,Math.floor(i.magnitude)));if(o<=0)return{effects:[],destination:a.position,collided:!1};const c=a.position,r=i.mode==="push"?qg(i.source,c):qg(c,i.source),f=[c];let h=c,b=!1;for(let A=0;A<o;A++){const v=Wn(h,r);if(!qe.isWalkable(e,v)||f1(e,v,a.id)){b=!0;break}f.push(v),h=v}const y=[];return ne(h,c)||y.push({type:"Displacement",target:a.id,destination:h,path:f,simulatePath:!0}),b&&i.collision.onBlocked==="crush_damage"&&y.push({type:"Damage",target:a.id,amount:Math.max(0,Math.floor(i.collision.crushDamage??0)),reason:i.damageReason||"crush"}),{effects:y,destination:h,collided:b}},Ec=e=>JSON.parse(JSON.stringify(e)),p1=(e,i)=>i==="floor"?Math.floor(e):i==="round"?Math.round(e):i==="ceil"?Math.ceil(e):e,df=(e,i)=>{let a=e.base;for(const o of e.scaling||[])a+=(i[o.stat]??0)*o.coefficient;return a=p1(a,e.round),e.min!==void 0&&(a=Math.max(e.min,a)),e.max!==void 0&&(a=Math.min(e.max,a)),a},h1=(e,i,a,o)=>{const c=i.split(".");let r=e;for(let b=0;b<c.length-1;b++){const y=c[b],A=r[y];if(!A||typeof A!="object")return;r=A}const f=c[c.length-1],h=Number(r[f]);Number.isFinite(h)&&(a==="set"&&(r[f]=o),a==="add"&&(r[f]=h+o),a==="multiply"&&(r[f]=h*o))},g1=(e,i,a)=>{let o=Ec(e.baseAction.effects);const c=Ec(e.reactivePassives||[]),r=new Set(e.keywords),f={};for(const h of e.upgrades)f[h.id]=h;for(const h of i){const b=f[h];if(b)for(const y of b.modifiers){if(y.op==="add_effect"&&o.push(Ec(y.effect)),y.op==="remove_effect_by_tag"&&(o=o.filter(A=>!A.tags.includes(y.tag))),y.op==="modify_number"){const A=o.find(v=>v.id===y.effectId);A&&h1(A,y.field,y.mode,y.value)}y.op==="add_keyword"&&r.add(y.keyword),y.op==="remove_keyword"&&r.delete(y.keyword),y.op==="add_reaction"&&c.push(Ec(y.reaction))}}return e.inhibit?.filterMode==="exclude_matching_tags"&&a.size>0&&(o=o.filter(h=>!h.tags.some(b=>a.has(b)))),{effects:o,reactions:c,keywords:r}},y1=(e,i)=>{const a=Qe(e),o=Number(i?.momentum??0),c=Number(i?.mass??1);return{body:a.body,mind:a.mind,instinct:a.instinct,mass:Number.isFinite(c)?c:1,speed:e.speed||1,momentum:Number.isFinite(o)?o:0}},ff=(e,i)=>i?Ee(e,i)?.id:void 0,b1=(e,i,a,o,c)=>{if(o.kind==="MESSAGE")return[{type:"Message",text:o.text}];if(o.kind==="DEAL_DAMAGE"){const b=Math.max(0,Math.floor(df(o.amount,c))),y=ff(e,a);return[{type:"Damage",target:o.target.selector==="targetActor"?y||"targetActor":o.target.selector==="self"?i.id:a||"targetActor",amount:b,reason:o.reason}]}if(o.kind==="APPLY_STATUS"){const b=ff(e,a);return[{type:"ApplyStatus",target:o.target.selector==="targetActor"?b||"targetActor":o.target.selector==="self"?i.id:a||"targetActor",status:o.statusId,duration:o.duration}]}const r=ff(e,a);if(!r)return[];const f=df(o.force.magnitude,c),h=o.force.collision.crushDamage?df(o.force.collision.crushDamage,c):0;return m1(e,{source:i.position,targetActorId:r,mode:o.force.mode,magnitude:f,maxDistance:o.force.maxDistance,collision:{onBlocked:o.force.collision.onBlocked,crushDamage:h}}).effects},x1=(e,i,a,o)=>{const c=[];for(let r=0;r<e.gridWidth;r++)for(let f=0;f<e.gridHeight;f++){const h=Gn(r,f);pa(h,e.gridWidth,e.gridHeight)&&Ce(i,h)<=a&&c.push(h)}return c.sort((r,f)=>{if(o==="q_then_r")return r.q===f.q?r.r-f.r:r.q-f.q;if(o==="r_then_q")return r.r===f.r?r.q-f.q:r.r-f.r;const h=Ce(i,r),b=Ce(i,f);return h!==b?h-b:r.q===f.q?r.r-f.r:r.q-f.q}),c},v1=e=>{const i=e.baseAction.effects.find(c=>c.kind==="DEAL_DAMAGE"),a=e.baseAction.effects.find(c=>c.kind==="APPLY_FORCE"),o={};return e.upgrades.forEach(c=>{o[c.id]={id:c.id,name:c.name,description:c.description||c.name}}),{id:e.id,name:e.name,description:e.description||e.name,slot:e.slot,icon:"data-driven",baseVariables:{range:e.targeting.range,cost:e.baseAction.costs.energy,cooldown:e.baseAction.costs.cooldown,damage:i?.amount?.base,momentum:a?.force?.magnitude?.base},execute:(c,r,f,h=[],b={})=>{const y=new Set(b.inhibitTags||[]),A=g1(e,h,y),v=y1(r,b),_=[...(A.reactions||[]).filter(g=>g.trigger==="ON_DECLARE").flatMap(g=>g.effects),...A.effects],p=[];for(const g of _)p.push(...b1(c,r,f,g,v));return{effects:p,messages:[],consumesTurn:e.baseAction.costs.consumesTurn}},getValidTargets:(c,r)=>{if(e.targeting.mode==="self")return[r];let f=x1(c,r,e.targeting.range,e.targeting.deterministicSort);return(e.targeting.mode==="single"||e.targeting.mode==="radius"||e.targeting.mode==="line")&&(e.targeting.requiresLos&&(f=f.filter(h=>Hf(c,r,h).isValid)),e.targeting.allowOccupied||(f=f.filter(h=>!Ee(c,h)))),f},upgrades:o}},S1=new Map,zy=new Map,A1=e=>{const i=v1(e);return S1.set(e.id,e),zy.set(e.id,i),i},T1=e=>e.map(A1),E1=()=>{const e={};for(const[i,a]of zy.entries())e[i]=a;return e},Qc={GRAPPLE_HOOK:aS,SPEAR_THROW:oS,SHIELD_BASH:lS,SHIELD_THROW:pS,VAULT:hS,JUMP:rS,BULWARK_CHARGE:cS,BASIC_ATTACK:uS,AUTO_ATTACK:jy,SENTINEL_TELEGRAPH:dS,SENTINEL_BLAST:fS,THEME_HAZARDS:mS,BASIC_MOVE:yS,DASH:bS,FIREBALL:vS,FIREWALL:SS,FIREWALK:AS,BOMB_TOSS:TS,TIME_BOMB:ES,CORPSE_EXPLOSION:MS,RAISE_DEAD:IS,SOUL_SWAP:BS,MULTI_SHOOT:jS,SET_TRAP:DS,SWIFT_ROLL:HS,SNEAK_ATTACK:PS,SMOKE_SCREEN:US,SHADOW_STEP:qS,FALCON_COMMAND:zS,FALCON_PECK:$S,FALCON_APEX_STRIKE:VS,FALCON_HEAL:YS,FALCON_SCOUT:FS,FALCON_AUTO_ROOST:KS,KINETIC_TRI_TRAP:ZS,WITHDRAWAL:i1,ABSORB_FIRE:s1},wc=u1(Qc);if(wc.missing.length>0||wc.invalid.length>0){const e=wc.missing.join(", "),i=wc.invalid.map(a=>`${a.skillId}: ${a.errors.join("; ")}`).join(" | ");throw new Error(`Skill intent profile validation failed. missing=[${e}] invalid=[${i}]`)}const Do=()=>({...Qc,...E1()});function da(e){const a=Do()[e];return a?{id:e,name:a.name,description:typeof a.description=="function"?a.description({}):a.description,slot:a.slot,cooldown:a.baseVariables.cooldown||0,currentCooldown:0,range:a.baseVariables.range||0,upgrades:Object.keys(a.upgrades||{}),activeUpgrades:[]}:null}function w1(){return[da("BASIC_MOVE"),da("BASIC_ATTACK"),da("AUTO_ATTACK"),da("SPEAR_THROW"),da("SHIELD_BASH"),da("JUMP")].filter(Boolean)}const _1={...Qc,get:e=>Do()[e],getAllUpgrades:()=>{const e=Do();return Object.values(e).flatMap(i=>Object.values(i.upgrades||{}).map(a=>({...a,skillId:i.id})))},getUpgrade:e=>{const i=Do();for(const a of Object.values(i))if(a.upgrades?.[e])return a.upgrades[e]},getSkillForUpgrade:e=>{const i=Do();for(const[a,o]of Object.entries(i))if(o.upgrades?.[e])return a},getSkillRange:(e,i)=>{const a=(e.activeSkills||[]).find(r=>r.id===i),o=Do()[i];if(!o)return a?.range||0;let c=o.baseVariables.range;return a?.activeUpgrades&&a.activeUpgrades.forEach(r=>{const f=o.upgrades[r];f?.modifyRange&&(c+=f.modifyRange)}),c}},Ln=_1,M1=Ln.getSkillRange,O1=e=>Ln.get(e),C1=(e,i,a,o)=>{let c=e;const r=[],f=a?e.enemies.filter(b=>b.id===a):e.enemies,h=[...c.enemies];return f.forEach(b=>{const y=c.enemies.find(A=>A.id===b.id);if(y){if(Ns(y)){const A=h.findIndex(v=>v.id===b.id);A!==-1&&(h[A]={...h[A],intent:void 0,intentPosition:void 0});return}if(y.intent&&y.intentPosition){let A=!1;const v=Ln.get(y.intent),S=y.activeSkills?.find(_=>_.id===y.intent);if(v&&S){const p=(v.getValidTargets?v.getValidTargets(c,y.position):[]).some(I=>ne(I,c.player.position));let g=y.intentPosition;if(p)g=c.player.position;else{const I=h.findIndex(C=>C.id===b.id);I!==-1&&(h[I]={...h[I],intent:void 0,intentPosition:void 0});return}const R=v.execute(c,y,g,S.activeUpgrades);c=yi(c,R.effects,{sourceId:y.id,targetId:c.player.id,stepId:o}),r.push(...R.messages),A=!0}else if(y.subtype!=="bomber"){if(ne(y.intentPosition,i)){c={...c,player:ua(c.player,1)};const _=`${y.subtype||"enemy"}#${y.id}`;r.push(`${_} hit you! (HP: ${c.player.hp}/${c.player.maxHp})`),A=!0}}if(A){const _=h.findIndex(p=>p.id===b.id);_!==-1&&(h[_]={...h[_],intent:void 0,intentPosition:void 0})}}}}),c={...c,enemies:h},{state:c,messages:r}};class zg extends Error{issues;constructor(i,a){super(`${i} validation failed:
${a.map(o=>`${o.path}: ${o.message}`).join(`
`)}`),this.name="ContractValidationError",this.issues=a}}const un=e=>typeof e=="object"&&e!==null&&!Array.isArray(e),Os=e=>typeof e=="number"&&Number.isFinite(e),zi=e=>Number.isInteger(e),Nt=e=>typeof e=="string",ge=(e,i,a)=>e.push({path:i,message:a}),N1=e=>{if(!Nt(e))return e;try{return JSON.parse(e)}catch(i){throw new Error(`Invalid JSON: ${i.message}`)}},tr=(e,i,a,o={})=>{if(!Array.isArray(e))return ge(i,a,"Expected array");const c=new Set;o.nonEmpty&&e.length===0&&ge(i,a,"Must not be empty"),e.forEach((r,f)=>{if(!Nt(r)||r.length===0)return ge(i,`${a}[${f}]`,"Expected non-empty string");o.unique&&(c.has(r)&&ge(i,`${a}[${f}]`,`Duplicate "${r}"`),c.add(r))})},$g=(e,i,a)=>{if(!un(e))return ge(i,a,"Expected object");Os(e.base)||ge(i,`${a}.base`,"Expected number"),e.min!==void 0&&!Os(e.min)&&ge(i,`${a}.min`,"Expected number"),e.max!==void 0&&!Os(e.max)&&ge(i,`${a}.max`,"Expected number"),Os(e.min)&&Os(e.max)&&e.min>e.max&&ge(i,a,"min must be <= max")},R1=(e,i,a)=>un(e)?((!Nt(e.id)||e.id.length===0)&&ge(i,`${a}.id`,"Expected non-empty string"),tr(e.tags,i,`${a}.tags`,{nonEmpty:!0,unique:!0}),Nt(e.kind)?e.kind==="DEAL_DAMAGE"?($g(e.amount,i,`${a}.amount`),(!un(e.target)||!Nt(e.target.selector))&&ge(i,`${a}.target`,"Expected selector"),!0):e.kind==="APPLY_STATUS"?((!Nt(e.statusId)||e.statusId.length===0)&&ge(i,`${a}.statusId`,"Expected statusId"),(!zi(e.duration)||e.duration<0)&&ge(i,`${a}.duration`,"Expected integer >= 0"),(!un(e.target)||!Nt(e.target.selector))&&ge(i,`${a}.target`,"Expected selector"),!0):e.kind==="APPLY_FORCE"?un(e.force)?((!Nt(e.force.mode)||!new Set(["push","pull"]).has(e.force.mode))&&ge(i,`${a}.force.mode`,"Expected push|pull"),(!Nt(e.force.direction)||!new Set(["source_to_target","target_to_source"]).has(e.force.direction))&&ge(i,`${a}.force.direction`,"Invalid direction"),(!zi(e.force.maxDistance)||e.force.maxDistance<0)&&ge(i,`${a}.force.maxDistance`,"Expected integer >= 0"),$g(e.force.magnitude,i,`${a}.force.magnitude`),un(e.force.collision)||ge(i,`${a}.force.collision`,"Expected object"),!0):(ge(i,`${a}.force`,"Expected object"),!0):e.kind==="MESSAGE"?((!Nt(e.text)||e.text.length===0)&&ge(i,`${a}.text`,"Expected non-empty string"),!0):(ge(i,`${a}.kind`,"Unknown kind"),!1):(ge(i,`${a}.kind`,"Expected kind"),!1)):(ge(i,a,"Expected object"),!1),k1=(e,i,a)=>{if(!un(e))return ge(i,a,"Expected object");if(!Nt(e.method))return ge(i,`${a}.method`,"Expected method");if(e.method==="fixed"){Os(e.value)||ge(i,`${a}.value`,"Expected number");return}if(e.method==="uniform_int"){zi(e.min)||ge(i,`${a}.min`,"Expected integer"),zi(e.max)||ge(i,`${a}.max`,"Expected integer"),zi(e.min)&&zi(e.max)&&e.min>e.max&&ge(i,a,"min must be <= max");return}if(e.method==="triangular_int"){zi(e.min)||ge(i,`${a}.min`,"Expected integer"),zi(e.mode)||ge(i,`${a}.mode`,"Expected integer"),zi(e.max)||ge(i,`${a}.max`,"Expected integer");return}if(e.method==="weighted_table"){if(!Array.isArray(e.table)||e.table.length===0)return ge(i,`${a}.table`,"Expected non-empty array");e.table.forEach((o,c)=>{if(!un(o))return ge(i,`${a}.table[${c}]`,"Expected object");Os(o.value)||ge(i,`${a}.table[${c}].value`,"Expected number"),(!Os(o.weight)||o.weight<=0)&&ge(i,`${a}.table[${c}].weight`,"Expected number > 0")});return}ge(i,`${a}.method`,"Unknown propensity method")},L1=e=>{const i=[];if(!un(e))return ge(i,"$","Expected object"),i;if((!Nt(e.version)||!/^1\./.test(e.version))&&ge(i,"$.version","Expected v1.x"),(!Nt(e.id)||!/^[A-Z0-9_]+$/.test(e.id))&&ge(i,"$.id","Expected uppercase id"),(!Nt(e.name)||e.name.length===0)&&ge(i,"$.name","Expected non-empty string"),(!Nt(e.actorType)||!new Set(["player","enemy"]).has(e.actorType))&&ge(i,"$.actorType","Expected player|enemy"),(!Nt(e.factionId)||e.factionId.length===0)&&ge(i,"$.factionId","Expected non-empty string"),(!un(e.coordSpace)||e.coordSpace.system!=="cube-axial"||e.coordSpace.pointFormat!=="qrs")&&ge(i,"$.coordSpace","Expected {system:cube-axial,pointFormat:qrs}"),un(e.instantiate)?((!Nt(e.instantiate.rngStream)||e.instantiate.rngStream.length===0)&&ge(i,"$.instantiate.rngStream","Expected non-empty string"),(!Nt(e.instantiate.counterMode)||!new Set(["consume_global","stateless"]).has(e.instantiate.counterMode))&&ge(i,"$.instantiate.counterMode","Expected consume_global|stateless"),tr(e.instantiate.drawOrder,i,"$.instantiate.drawOrder",{nonEmpty:!0,unique:!0})):ge(i,"$.instantiate","Expected object"),!un(e.propensities))ge(i,"$.propensities","Expected object");else{const a=e.propensities;["body","mind","instinct","speed","mass"].forEach(o=>{o in a||ge(i,`$.propensities.${o}`,"Missing required propensity")}),Object.entries(a).forEach(([o,c])=>k1(c,i,`$.propensities.${o}`))}return un(e.skillLoadout)?(tr(e.skillLoadout.baseSkillIds,i,"$.skillLoadout.baseSkillIds",{nonEmpty:!0,unique:!0}),e.skillLoadout.passiveSkillIds!==void 0&&tr(e.skillLoadout.passiveSkillIds,i,"$.skillLoadout.passiveSkillIds",{unique:!0})):ge(i,"$.skillLoadout","Expected object"),i},I1=e=>{const i=[];return un(e)?((!Nt(e.version)||!/^1\./.test(e.version))&&ge(i,"$.version","Expected v1.x"),(!Nt(e.id)||!/^[A-Z0-9_]+$/.test(e.id))&&ge(i,"$.id","Expected uppercase id"),(!Nt(e.name)||e.name.length===0)&&ge(i,"$.name","Expected non-empty string"),(!Nt(e.slot)||!new Set(["offensive","defensive","utility","passive"]).has(e.slot))&&ge(i,"$.slot","Invalid slot"),tr(e.keywords,i,"$.keywords",{unique:!0}),un(e.targeting)?((!Nt(e.targeting.mode)||!new Set(["self","single","line","radius","global"]).has(e.targeting.mode))&&ge(i,"$.targeting.mode","Invalid mode"),(!zi(e.targeting.range)||e.targeting.range<0)&&ge(i,"$.targeting.range","Expected integer >= 0"),typeof e.targeting.requiresLos!="boolean"&&ge(i,"$.targeting.requiresLos","Expected boolean"),typeof e.targeting.allowOccupied!="boolean"&&ge(i,"$.targeting.allowOccupied","Expected boolean")):ge(i,"$.targeting","Expected object"),(!un(e.stackPolicy)||e.stackPolicy.resolveOrder!=="LIFO")&&ge(i,"$.stackPolicy.resolveOrder","MVP requires LIFO"),un(e.baseAction)?(un(e.baseAction.costs)?((!Os(e.baseAction.costs.energy)||e.baseAction.costs.energy<0)&&ge(i,"$.baseAction.costs.energy","Expected number >= 0"),(!zi(e.baseAction.costs.cooldown)||e.baseAction.costs.cooldown<0)&&ge(i,"$.baseAction.costs.cooldown","Expected integer >= 0"),typeof e.baseAction.costs.consumesTurn!="boolean"&&ge(i,"$.baseAction.costs.consumesTurn","Expected boolean")):ge(i,"$.baseAction.costs","Expected object"),!Array.isArray(e.baseAction.effects)||e.baseAction.effects.length===0?ge(i,"$.baseAction.effects","Expected non-empty array"):e.baseAction.effects.forEach((a,o)=>R1(a,i,`$.baseAction.effects[${o}]`))):ge(i,"$.baseAction","Expected object"),Array.isArray(e.upgrades)?e.upgrades.forEach((a,o)=>{if(!un(a))return ge(i,`$.upgrades[${o}]`,"Expected object");(!Nt(a.id)||!/^[A-Z0-9_]+$/.test(a.id))&&ge(i,`$.upgrades[${o}].id`,"Expected uppercase id"),(!Nt(a.name)||a.name.length===0)&&ge(i,`$.upgrades[${o}].name`,"Expected non-empty string"),Array.isArray(a.modifiers)||ge(i,`$.upgrades[${o}].modifiers`,"Expected array")}):ge(i,"$.upgrades","Expected array"),i):(ge(i,"$","Expected object"),i)},B1=e=>{const i=N1(e),a=[];if(!un(i))throw new zg("TacticalDataPack",[{path:"$",message:"Expected pack object"}]);if((!Nt(i.version)||!/^1\./.test(i.version))&&a.push({path:"$.version",message:"Expected v1.x string"}),Array.isArray(i.units)?i.units.forEach((o,c)=>{L1(o).forEach(f=>a.push({path:`$.units[${c}]${f.path.slice(1)}`,message:f.message}))}):a.push({path:"$.units",message:"Expected array"}),Array.isArray(i.skills)?i.skills.forEach((o,c)=>{I1(o).forEach(f=>a.push({path:`$.skills[${c}]${f.path.slice(1)}`,message:f.message}))}):a.push({path:"$.skills",message:"Expected array"}),a.length>0)throw new zg("TacticalDataPack",a);return i},j1=e=>({definition:e,drawOrder:[...e.instantiate.drawOrder],skillIds:[...e.skillLoadout.baseSkillIds],passiveSkillIds:[...e.skillLoadout.passiveSkillIds||[]]}),D1={Light:3,Standard:5,Heavy:8,Anchored:12,OuterWall:20},Ms=e=>({version:"1.0.0",id:e.id,name:e.name,actorType:"enemy",subtype:e.subtype,factionId:"enemy",weightClass:e.weightClass,coordSpace:{system:"cube-axial",pointFormat:"qrs"},instantiate:{rngStream:"enemy.instantiate",seedSalt:e.subtype,counterMode:"consume_global",drawOrder:["body","mind","instinct","speed","mass"],includeRollTrace:!1},propensities:{body:{method:"fixed",value:e.trinity.body},mind:{method:"fixed",value:e.trinity.mind},instinct:{method:"fixed",value:e.trinity.instinct},speed:{method:"fixed",value:e.speed},mass:{method:"fixed",value:D1[e.weightClass]}},derivedStats:{maxHp:{formula:"trinity_hp_v1"}},physics:{collisionPolicy:"crush_damage",crushModel:{baseDamage:0,impulseMultiplier:1,massDivider:1,minDamage:1}},skillLoadout:{baseSkillIds:e.baseSkills,passiveSkillIds:e.passiveSkills||[]},runtimeDefaults:{startingHp:"maxHp",temporaryArmor:0,isVisible:!0}}),H1={version:"1.0.0",id:"SHIELD_BASH_V1",name:"Shield Bash V1",description:"Data-driven migration variant of shield bash.",slot:"offensive",keywords:["Momentum"],intentTags:["damage","control","move"],targeting:{mode:"single",range:1,requiresLos:!0,allowOccupied:!0,deterministicSort:"distance_then_q_then_r"},stackPolicy:{resolveOrder:"LIFO",reactionWindow:"automated",playerPriority:!1,emitTickEvents:!0},baseAction:{costs:{energy:0,cooldown:2,consumesTurn:!0},effects:[{id:"shield_bash_v1_force",kind:"APPLY_FORCE",tags:["movement","momentum"],target:{selector:"targetActor"},force:{mode:"push",direction:"source_to_target",magnitude:{base:2,scaling:[{stat:"body",coefficient:.2}],min:1,round:"floor"},maxDistance:3,collision:{onBlocked:"crush_damage",crushDamage:{base:1,scaling:[{stat:"momentum",coefficient:1}],min:1,round:"floor"}}}},{id:"shield_bash_v1_damage",kind:"DEAL_DAMAGE",tags:["damage","physical"],target:{selector:"targetActor"},amount:{base:2,scaling:[{stat:"body",coefficient:.4}],min:1,round:"floor"},damageClass:"physical",reason:"shield_bash_v1"}]},reactivePassives:[],upgrades:[],inhibit:{filterMode:"exclude_matching_tags",removableTags:["movement","momentum"]},preview:{dryRunEnabled:!0,eventMap:{APPLY_FORCE:"UnitMoved",DEAL_DAMAGE:"DamageTaken"}}},P1={version:"1.0.0",units:[Ms({id:"ENEMY_FOOTMAN_V1",name:"Footman",subtype:"footman",weightClass:"Standard",speed:1,trinity:{body:0,mind:0,instinct:0},baseSkills:["BASIC_MOVE","BASIC_ATTACK"],passiveSkills:["AUTO_ATTACK"]}),Ms({id:"ENEMY_SPRINTER_V1",name:"Sprinter",subtype:"sprinter",weightClass:"Standard",speed:2,trinity:{body:0,mind:0,instinct:0},baseSkills:["BASIC_MOVE","BASIC_ATTACK"]}),Ms({id:"ENEMY_RAIDER_V1",name:"Raider",subtype:"raider",weightClass:"Standard",speed:1,trinity:{body:.4,mind:0,instinct:.2},baseSkills:["BASIC_MOVE","BASIC_ATTACK","DASH"],passiveSkills:["AUTO_ATTACK"]}),Ms({id:"ENEMY_POUNCER_V1",name:"Pouncer",subtype:"pouncer",weightClass:"Standard",speed:1,trinity:{body:.4,mind:0,instinct:.2},baseSkills:["BASIC_MOVE","BASIC_ATTACK","GRAPPLE_HOOK"],passiveSkills:["AUTO_ATTACK"]}),Ms({id:"ENEMY_SHIELDBEARER_V1",name:"Shield Bearer",subtype:"shieldBearer",weightClass:"Heavy",speed:1,trinity:{body:1,mind:0,instinct:.4},baseSkills:["BASIC_MOVE","BASIC_ATTACK","SHIELD_BASH"],passiveSkills:["AUTO_ATTACK"]}),Ms({id:"ENEMY_ARCHER_V1",name:"Archer",subtype:"archer",weightClass:"Standard",speed:1,trinity:{body:.2,mind:0,instinct:.2},baseSkills:["BASIC_MOVE","BASIC_ATTACK","SPEAR_THROW"],passiveSkills:["AUTO_ATTACK"]}),Ms({id:"ENEMY_BOMBER_V1",name:"Bomber",subtype:"bomber",weightClass:"Standard",speed:1,trinity:{body:.4,mind:.2,instinct:.2},baseSkills:["BASIC_MOVE","BASIC_ATTACK","BOMB_TOSS"],passiveSkills:["AUTO_ATTACK"]}),Ms({id:"ENEMY_WARLOCK_V1",name:"Warlock",subtype:"warlock",weightClass:"Standard",speed:1,trinity:{body:.4,mind:.6,instinct:.2},baseSkills:["BASIC_MOVE","BASIC_ATTACK"],passiveSkills:["AUTO_ATTACK"]}),Ms({id:"ENEMY_SENTINEL_V1",name:"Sentinel",subtype:"sentinel",weightClass:"Heavy",speed:1,trinity:{body:4,mind:2,instinct:2},baseSkills:["BASIC_MOVE","BASIC_ATTACK","SENTINEL_TELEGRAPH","SENTINEL_BLAST"],passiveSkills:["AUTO_ATTACK"]})],skills:[H1]},U1=new Map,$y=new Map,q1=e=>(U1.set(e.id,e),e.subtype&&$y.set(e.subtype,e),e),z1=e=>e.map(q1),$1=e=>$y.get(e);let Vy=!1;const V1=(e=P1)=>{const i=B1(e);return z1(i.units),T1(i.skills),Vy=!0,{unitsRegistered:i.units.length,skillsRegistered:i.skills.length}},Yy=()=>Vy?{unitsRegistered:0,skillsRegistered:0}:V1(),Fy=(e,i="none")=>i==="floor"?Math.floor(e):i==="round"?Math.round(e):i==="ceil"?Math.ceil(e):e,Ky=(e,i)=>i?Math.max(i.min,Math.min(i.max,e)):e,_c=(e,i)=>Ky(Fy(e,i.round),i.clamp),Y1=(e,i)=>{if(e.method==="fixed")return{value:_c(e.value,e),before:-1,after:-1,usedRng:!1};if(e.method==="uniform_int"){const f=i(),h=e.max-e.min+1,b=e.min+Math.floor(f.value*h)%Math.max(1,h);return{value:_c(b,e),before:f.before,after:f.after,usedRng:!0}}if(e.method==="triangular_int"){const f=i(),h=e.min,b=e.mode,y=e.max,A=(b-h)/Math.max(1e-9,y-h),v=f.value<A?h+Math.sqrt(f.value*(y-h)*(b-h)):y-Math.sqrt((1-f.value)*(y-h)*(y-b));return{value:_c(v,e),before:f.before,after:f.after,usedRng:!0}}const a=i(),o=e.table.reduce((f,h)=>f+h.weight,0);let c=a.value*Math.max(1e-9,o),r=e.table[e.table.length-1].value;for(const f of e.table)if(c-=f.weight,c<=0){r=f.value;break}return{value:_c(r,e),before:a.before,after:a.after,usedRng:!0}},Vg=(e,i,a)=>{if(e.formula==="trinity_hp_v1")return Wc(a);const o=e.base??0,r=(e.terms||[]).reduce((h,b)=>h+(i[b.stat]??0)*b.coefficient,o),f=Fy(r,e.round);return Ky(f,e.clamp)},F1=(e,i)=>!i||Object.keys(i).length===0?e:{...e,activeSkills:(e.activeSkills||[]).map(a=>{const o=i[a.id];return o===void 0?a:{...a,currentCooldown:Math.max(0,o)}})},K1=e=>e.id.toLowerCase(),G1=(e,i,a)=>{const o=i.definition,c=[];let r={rngSeed:e.rngSeed||"default",rngCounter:Math.max(0,e.rngCounter||0)},f=0;const h=`${r.rngSeed}:${o.instantiate.rngStream}:${o.instantiate.seedSalt||o.id}`,b=()=>{if(o.instantiate.counterMode==="consume_global"){const N=r.rngCounter,Y=Yc(r.rngSeed,N);return r={...r,rngCounter:N+1},{value:Y,before:N,after:r.rngCounter}}const C=f;return{value:Yc(h,f++),before:C,after:f}},y={};for(const C of i.drawOrder){const M=o.propensities[C];if(!M)continue;const N=Y1(M,b);y[C]=N.value,N.usedRng&&c.push({key:C,method:M.method,value:N.value,counterBefore:N.before,counterAfter:N.after})}const A={body:y.body??0,mind:y.mind??0,instinct:y.instinct??0},v=o.derivedStats||{},S=v.maxHp?Vg(v.maxHp,y,A):Wc(A),_=y.speed??1,p=y.mass??1,g=o.runtimeDefaults?.startingHp==="explicit"?Math.max(0,o.runtimeDefaults.explicitHp??S):S,R=ma({id:a.actorId||K1(o),type:o.actorType,subtype:a.subtype||o.subtype,position:a.position,hp:g,maxHp:S,speed:_,factionId:a.factionId||o.factionId,weightClass:o.weightClass,skills:[...i.skillIds,...i.passiveSkillIds],trinity:A});let I=F1(R,o.skillLoadout.startCooldowns);o.runtimeDefaults?.temporaryArmor!==void 0&&(I={...I,temporaryArmor:Math.max(0,o.runtimeDefaults.temporaryArmor)}),o.runtimeDefaults?.isVisible!==void 0&&(I={...I,isVisible:o.runtimeDefaults.isVisible}),y.maxHp=S,y.speed=_,y.mass=p;for(const[C,M]of Object.entries(v))C!=="maxHp"&&(y[C]=Vg(M,y,A));return{actor:I,stats:y,trinity:A,speed:_,mass:p,nextCursor:r,rollTrace:c}},W1=(e,i,a)=>G1(e,j1(i),a),X1=(e,i)=>{const a=Gc(i),o=Jb(Hc,Pc),c=[],r=o,f=Math.floor(Hc/2),h=Gn(f,Pc-1),b=Gn(f,0);let y;if(e%1===0){const M=r.filter(N=>!ne(N,h)&&!ne(N,b)&&Ce(N,h)>=3);M.length>0&&(y=M[Math.floor(a.next()*M.length)])}const v=Math.floor(r.length*gx),S=[],_={playerStart:h,stairsPosition:b,shrinePosition:y},g=[...r.filter(M=>!Sg(M,_))].sort(()=>a.next()-.5);for(let M=0;M<v;M++)M<g.length&&S.push(g[M]);const R=r.filter(M=>!Sg(M,{playerStart:h,stairsPosition:b,shrinePosition:y})&&!c.some(N=>ne(N,M))&&!S.some(N=>ne(N,M))&&Ce(M,h)>=3),I={id:"arena",type:"combat",center:Gn(Math.floor(Hc/2),Math.floor(Pc/2)),hexes:o,connections:[]},C=new Map;for(const M of o)C.set(`${M.q},${M.r}`,{baseId:"STONE",position:M,traits:new Set(Ho.STONE.defaultTraits),effects:[]});for(const M of c)C.set(`${M.q},${M.r}`,{baseId:"WALL",position:M,traits:new Set(Ho.WALL.defaultTraits),effects:[]});for(const M of S)C.set(`${M.q},${M.r}`,{baseId:"LAVA",position:M,traits:new Set(Ho.LAVA.defaultTraits),effects:[]});return{rooms:[I],allHexes:o,stairsPosition:b,shrinePosition:y,spawnPositions:R,playerSpawn:h,tiles:C}},Q1=(e,i,a)=>{Yy();const o=Gc(a+":enemies"),c=Eg[Math.min(e,Eg.length-1)],r=nf[e]||nf[Math.max(...Object.keys(nf).map(Number))];let f={rngSeed:`${a}:enemy-propensity`,rngCounter:0};const h=[];let b=c;const y=[];for(;b>0&&y.length<i.length;){const A=r.filter(q=>{const K=Sf[q];return K&&K.cost<=b});if(A.length===0)break;const v=Math.floor(o.next()*A.length),S=A[v],_=Sf[S],p=i.filter(q=>!y.some(K=>ne(K,q)));if(p.length===0)break;const g=Math.floor(o.next()*p.length),R=p[g];y.push(R);const I=Math.floor(e/5),C=_.weightClass||"Standard",M=(f.rngCounter<<8)+h.length,N=`enemy_${h.length}_${Po(a,M,6,S)}`,Y=$1(S);let X;if(Y){const q=W1(f,Y,{actorId:N,position:R,subtype:S,factionId:"enemy"});f=q.nextCursor,X=q.actor}else X=Wx({id:N,subtype:S,position:R,speed:_.speed||50,skills:Qx(S),weightClass:C,enemyType:_.type});const O=I>0?{...X,hp:X.hp+I,maxHp:X.maxHp+I}:X;h.push({...O,subtype:S,enemyType:_.type,actionCooldown:_.actionCooldown??O.actionCooldown,isVisible:!0}),b-=_.cost}return h},J1=e=>yx[e]||"inferno",Z1=(e,i)=>{const a=i.initialSeed??i.rngSeed??"0",o=i.commandLog?.length??0;return{id:Po(a,o,9,"cmd"),timestamp:i.turnNumber,action:e}},eA=(e,i,a)=>{const o=a.initialSeed??a.rngSeed??"0",c=a.undoStack?.length??0;return{id:Po(o,c,9,"delta"),undoData:{player:{...e.player},enemies:[...e.enemies],turnNumber:e.turnNumber,gameStatus:e.gameStatus}}},Uo={VANGUARD:{id:"VANGUARD",name:"Vanguard",description:"Direct damage, brawling, and area denial.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","AUTO_ATTACK","SPEAR_THROW","SHIELD_BASH","JUMP"]},SKIRMISHER:{id:"SKIRMISHER",name:"Skirmisher",description:"Zero direct damage. Kinetic momentum and environmental lethality.",startingUpgrades:[],startingSkills:["DASH","GRAPPLE_HOOK","SHIELD_THROW","VAULT"]},FIREMAGE:{id:"FIREMAGE",name:"Fire Mage",description:"Area control with fire and high-damage spells.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","ABSORB_FIRE","FIREBALL","FIREWALL","FIREWALK"]},NECROMANCER:{id:"NECROMANCER",name:"Necromancer",description:"Utilize death and reanimation.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","CORPSE_EXPLOSION","RAISE_DEAD","SOUL_SWAP"]},HUNTER:{id:"HUNTER",name:"Hunter",description:"Ranged precision and traps.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","FALCON_COMMAND","KINETIC_TRI_TRAP","WITHDRAWAL"]},ASSASSIN:{id:"ASSASSIN",name:"Assassin",description:"Stealth and high burst damage.",startingUpgrades:[],startingSkills:["BASIC_MOVE","BASIC_ATTACK","SNEAK_ATTACK","SMOKE_SCREEN","SHADOW_STEP"]}},Gy=e=>{const i=e.startingSkills.map(o=>da(o)).filter(Boolean),a=e.id;return{upgrades:[...e.startingUpgrades],activeSkills:i,archetype:a}},tA=e=>e.some(i=>i.id==="BASIC_MOVE"||i.id==="DASH"),Wy=(e=[])=>{if(tA(e))return e;const i=da("BASIC_MOVE");return i?[i,...e]:e},_f=e=>{const i=e.activeSkills||[],a=Wy(i);return a===i?e:{...e,activeSkills:a}};function nA(e){let i=e;const a=[],o=[],c=new Map(i.tiles);for(const[r,f]of c.entries()){const h=[];let b=!1;for(const v of f.effects){if(v.duration===-1){h.push(v);continue}const S=v.duration-1;S>0?(h.push({...v,duration:S}),b=!0):(a.push(`The ${v.id.toLowerCase()} died down.`),b=!0)}b&&c.set(r,{...f,effects:h});const y=[i.player,...i.enemies],A=v=>`${v.q},${v.r}`;for(const v of y)if(A(v.position)===r){const S=Va.processStay(v,f,i);o.push(...S.effects),a.push(...S.messages)}}return i={...i,tiles:c},o.length>0&&(i=yi(i,o)),{state:i,messages:a}}class Yg{getFalconIntent(i,a){const o=a.companionState?.mode||"roost",c=a.companionOf===i.player.id?i.player:i.enemies.find(f=>f.id===a.companionOf),r={expectedValue:0,reasoningCode:`FALCON_${o.toUpperCase()}`,isGhost:!1,rngConsumption:0};if(o==="scout")return{type:"USE_SKILL",actorId:a.id,skillId:"FALCON_SCOUT",targetHex:a.position,priority:10,metadata:r};if(o==="predator"&&typeof a.companionState?.markTarget=="string"){const f=i.enemies.find(b=>b.id===a.companionState.markTarget&&b.hp>0);if(!f)return{type:"USE_SKILL",actorId:a.id,skillId:"FALCON_AUTO_ROOST",targetHex:a.position,priority:9,metadata:{...r,reasoningCode:"FALCON_AUTO_ROOST"}};const h=Ce(a.position,f.position);return h<=4?{type:"USE_SKILL",actorId:a.id,skillId:"FALCON_APEX_STRIKE",targetHex:f.position,primaryTargetId:f.id,priority:10,metadata:r}:h<=1?{type:"USE_SKILL",actorId:a.id,skillId:"FALCON_PECK",targetHex:f.position,primaryTargetId:f.id,priority:9,metadata:r}:{type:"MOVE",actorId:a.id,skillId:"BASIC_MOVE",targetHex:this.findStepToward(i,a,f.position),primaryTargetId:f.id,priority:7,metadata:r}}return c?Ce(a.position,c.position)<=1?{type:"USE_SKILL",actorId:a.id,skillId:"FALCON_HEAL",targetHex:c.position,primaryTargetId:c.id,priority:10,metadata:r}:{type:"MOVE",actorId:a.id,skillId:"BASIC_MOVE",targetHex:this.findStepToward(i,a,c.position),primaryTargetId:c.id,priority:7,metadata:r}:{type:"WAIT",actorId:a.id,skillId:"WAIT_SKILL",priority:1,metadata:{...r,reasoningCode:"FALCON_WAIT"}}}findStepToward(i,a,o){const c=ot(a.position).filter(r=>tt.isWithinBounds(i,r)).filter(r=>qe.isWalkable(i,r)).filter(r=>{const f=Ee(i,r);return!f||f.id===a.id});return c.length===0?a.position:c.sort((r,f)=>Ce(r,o)-Ce(f,o))[0]}getIntent(i,a){if(a.subtype==="falcon")return this.getFalconIntent(i,a);if(a.subtype==="bomb")return{type:"USE_SKILL",actorId:a.id,skillId:"TIME_BOMB",targetHex:a.position,priority:10,metadata:{expectedValue:0,reasoningCode:"BOMB_FUSE_TICK",isGhost:!1,rngConsumption:0}};const o=i.player.position,c=px(a,o,{...i,occupiedCurrentTurn:i.occupiedCurrentTurn}),{entity:r,message:f}=c;let h="WAIT",b="WAIT_SKILL",y,A,v=10;const S=r.intent||"Waiting";if(S==="Moving"||S==="Advancing"||S==="Repositioning"||S==="Lumbering")h="MOVE",b="BASIC_MOVE",y=r.position;else if(S==="BASIC_ATTACK"){if(h="ATTACK",b="BASIC_ATTACK",y=r.intentPosition,y){const p=i.player.position.q===y.q&&i.player.position.r===y.r?i.player:i.enemies.find(g=>g.position.q===y?.q&&g.position.r===y?.r);p&&p.factionId!==a.factionId&&(A=p.id)}}else S==="SPEAR_THROW"?(h="USE_SKILL",b="SPEAR_THROW",y=r.intentPosition):S==="DASH"?(h="USE_SKILL",b="DASH",y=r.intentPosition):S==="GRAPPLE_HOOK"?(h="USE_SKILL",b="GRAPPLE_HOOK",y=r.intentPosition):S==="Bombing"?(h="USE_SKILL",b="BOMB_TOSS",y=r.intentPosition):S==="SENTINEL_BLAST"?(h="USE_SKILL",b="SENTINEL_BLAST",y=r.intentPosition):S==="SENTINEL_TELEGRAPH"?(h="USE_SKILL",b="SENTINEL_TELEGRAPH",y=r.intentPosition):(S==="Charging Power"||S==="Preparing")&&(h="WAIT",b="WAIT_SKILL");if(!(b==="WAIT_SKILL"||a.activeSkills?.some(p=>p.id===b)))h="WAIT",b="WAIT_SKILL",y=void 0,A=void 0;else if(b!=="WAIT_SKILL"){const p=Ln.get(b);p?.getValidTargets&&y&&(p.getValidTargets(i,a.position).some(I=>ne(I,y))||(h="WAIT",b="WAIT_SKILL",y=void 0,A=void 0))}return{type:h,actorId:a.id,skillId:b,primaryTargetId:A,targetHex:y,priority:v,metadata:{expectedValue:0,reasoningCode:S.toUpperCase().replace(" ","_"),isGhost:!1,rngConsumption:(f?.includes("teleports")||f?.includes("Bombing"),(c.nextState.rngCounter||0)-(i.rngCounter||0))}}}}class nr{inputQueue=[];resolveInput;pushIntent(i){this.inputQueue.push(i),this.resolveInput&&(this.resolveInput(i),this.resolveInput=void 0)}getIntent(i,a){return this.inputQueue.length>0?this.inputQueue.shift():new Promise(o=>{this.resolveInput=o})}}class ir{static strategies=new Map;static defaultEnemyStrategy=new Yg;static defaultPlayerStrategy=new nr;static register(i,a){this.strategies.set(i,a)}static resolve(i){return this.strategies.has(i.id)?this.strategies.get(i.id):i.type==="player"?this.defaultPlayerStrategy:this.defaultEnemyStrategy}static reset(){this.strategies.clear(),this.defaultEnemyStrategy=new Yg,this.defaultPlayerStrategy=new nr}}const Xy=(e,i,a)=>Ns(a)?{...e,type:"WAIT",skillId:"WAIT_SKILL",priority:0,metadata:{...e.metadata,reasoningCode:"STATUS_STUNNED"}}:e;class Qy{static execute(i,a,o){return this.resolveExecution(i,a,o)}static simulate(i,a,o){return this.resolveExecution(i,a,o)}static resolveExecution(i,a,o){const c=[],r=[],f=Ln.get(i.skillId);if(!f&&i.type!=="WAIT")return{effects:[],messages:[`Failed to execute unknown skill: ${i.skillId}`],consumesTurn:!1};if(i.type==="WAIT")return{effects:[],messages:[],consumesTurn:!0};if(!(i.skillId==="WAIT_SKILL"||a.activeSkills.some(p=>p.id===i.skillId)))return{effects:[],messages:[`Actor ${a.id} does not have skill ${i.skillId} in loadout!`],consumesTurn:!1};const b=a.activeSkills.find(p=>p.id===i.skillId);if(b&&(b.currentCooldown||0)>0)return{effects:[],messages:[`${i.skillId} is on cooldown (${b.currentCooldown}).`],consumesTurn:a.type!=="player"};let y=i.targetHex,A=i.primaryTargetId;if(!y&&f&&(y=this.findOptimalTargetHex(i,a,o,f.baseVariables.range)),!y)return{effects:[],messages:[`No valid target found for ${i.skillId}`],consumesTurn:!1};if(y&&!A){const p=Ee(o,y);p&&(A=p.id)}const v=b?.activeUpgrades||[],S=f.execute(o,a,y,v),_=[...c,...S.effects];if(S.consumesTurn!==!1){let g=f.baseVariables.cooldown||0;for(const R of v){const I=f.upgrades?.[R];typeof I?.modifyCooldown=="number"&&(g+=I.modifyCooldown)}g=Math.max(0,g),g>0&&_.push({type:"ModifyCooldown",skillId:i.skillId,amount:g+1,setExact:!0})}return{effects:_,messages:[...r,...S.messages],consumesTurn:S.consumesTurn??!0,targetId:A,kills:S.kills||0}}static findOptimalTargetHex(i,a,o,c){if(i.primaryTargetId){const r=o.enemies.find(f=>f.id===i.primaryTargetId)||(o.player.id===i.primaryTargetId?o.player:void 0);if(r&&(i.type==="ATTACK"||i.type==="USE_SKILL"))return r.position}}}const Mf=(e,i)=>e.q!==i.q?e.q-i.q:e.r!==i.r?e.r-i.r:e.s-i.s,qc=(e,i)=>e.player.id===i?e.player:e.enemies.find(a=>a.id===i)||e.companions?.find(a=>a.id===i),iA=(e,i)=>{if(i.primaryTargetId)return qc(e,i.primaryTargetId);if(i.targetHex)return Ee(e,i.targetHex)},sA=(e,i,a)=>{const o=new Map,c=iA(e,i),r=f=>{f&&o.set(he(f),f)};return a.forEach(f=>{f.type==="Damage"?typeof f.target=="string"&&f.target!=="targetActor"&&f.target!=="area"?r(qc(e,f.target)?.position):f.target==="targetActor"?r(c?.position):f.target==="area"?r(f.source):typeof f.target=="object"&&"q"in f.target&&r(f.target):f.type==="Impact"||f.type==="LavaSink"?r(qc(e,f.target)?.position):f.type==="Displacement"&&r(f.destination)}),[...o.values()].sort(Mf)},Fg=e=>{const i=[];e.enemies.filter(c=>c.hp>0&&c.factionId!==e.player.factionId).forEach(c=>{const f=ir.resolve(c).getIntent(e,c);if(f instanceof Promise)return;const h=Xy(f,e,c);let b=h;h.skillId==="SENTINEL_TELEGRAPH"&&(b={...h,skillId:"SENTINEL_BLAST"});const y=Qy.simulate(b,c,e),A=sA(e,b,y.effects);A.length!==0&&i.push({actorId:c.id,skillId:h.skillId,targetHex:h.targetHex,dangerTiles:A})}),i.sort((c,r)=>c.actorId!==r.actorId?c.actorId.localeCompare(r.actorId):c.skillId!==r.skillId?c.skillId.localeCompare(r.skillId):!c.targetHex&&!r.targetHex?0:c.targetHex?r.targetHex?Mf(c.targetHex,r.targetHex):1:-1);const o=new Map;return i.forEach(c=>c.dangerTiles.forEach(r=>o.set(he(r),r))),{sourceTurn:e.turnNumber,dangerTiles:[...o.values()].sort(Mf),projections:i}};var Jy={};const Of=typeof process<"u"&&Jy?.HOP_ENGINE_DEBUG==="1",Zy=typeof process<"u"&&Jy?.HOP_ENGINE_WARN==="1",aA=Of||Zy,e0=(e,i)=>{if(aA){if(i){console.warn(`[TURN_STACK] ${e}`,i);return}console.warn(`[TURN_STACK] ${e}`)}},oA=(e,i,a,o)=>{const c=(e.pendingFrames?.length??0)+1;return{id:`${e.turnNumber}:${a}:${i}:${c}`,type:i,status:a,createdTurn:e.turnNumber,blocking:!0,payload:o}},Fl=(e,i,a,o)=>{const c=oA(e,a,i.status,o);return{...e,pendingStatus:i,pendingFrames:[...e.pendingFrames||[],c]}},Cf=()=>{const e=Cs();return{...e,gameStatus:"hub",message:[Ht([],"Welcome to the Strategic Hub. Select your loadout.","INFO","SYSTEM")[0]],player:{...e.player,activeSkills:[]},hasSpear:!1,hasShield:!1}},Cs=(e=1,i,a,o,c)=>{Yy();const r=i||String(Date.now()),f=J1(e),h=X1(e,r),b=Q1(e,h.spawnPositions||[],r),y=o?{hp:o.hp,maxHp:o.maxHp,speed:o.speed||Tg.speed}:{speed:Tg.speed},A=o?.upgrades||(c?c.startingUpgrades:[]),v=c?Gy(c):{activeSkills:w1(),archetype:"VANGUARD"},S=Wy(o?.activeSkills||v.activeSkills),_=o?.archetype||v.archetype,p=h.tiles||new Map,R={turnNumber:1,player:{...ma({id:"player",type:"player",position:h.playerSpawn,hp:y.hp,maxHp:y.maxHp,speed:y.speed,factionId:"player",activeSkills:S,archetype:_,weightClass:"Standard",components:new Map}),previousPosition:h.playerSpawn},enemies:b.map(I=>({...I,previousPosition:I.position,statusEffects:I.statusEffects||[],temporaryArmor:I.temporaryArmor||0})),gridWidth:Hc,gridHeight:Pc,gameStatus:"playing",message:e===1?[Ht([],"Welcome to the arena. Survive.","INFO","SYSTEM")[0]]:Ht(o?.message||[],`Floor ${e} - ${f.charAt(0).toUpperCase()+f.slice(1)}. Be careful.`,"INFO","OBJECTIVE"),hasSpear:!0,stairsPosition:h.stairsPosition,occupancyMask:[0n],shrinePosition:h.shrinePosition,shrineOptions:void 0,hasShield:!0,floor:e,upgrades:A,rooms:h.rooms,theme:f,commandLog:[],undoStack:[],rngSeed:r,initialSeed:a??(e===1?r:void 0),rngCounter:0,actionLog:[],kills:o&&o.kills||0,environmentalKills:o&&o.environmentalKills||0,turnsSpent:o&&o.turnsSpent||0,dailyRunDate:o?.dailyRunDate,runObjectives:o?.runObjectives||[],hazardBreaches:o?.hazardBreaches||0,completedRun:void 0,combatScoreEvents:o?.combatScoreEvents||[],dyingEntities:[],visualEvents:[],timelineEvents:[],intentPreview:void 0,initiativeQueue:void 0,tiles:p};return R.initiativeQueue=Wa(R),R.occupancyMask=tt.refreshOccupancyMask(R),R},Kg=(e,i,a,o)=>{const c=i==="player"?e.player:e.enemies.find(b=>b.id===i);if(!c)return{state:e,messages:[]};const r=[],f=[];return c.statusEffects.forEach(b=>{if(b.tickWindow===a&&b.onTick){const y=b.onTick(c,e);y&&r.push(...y)}}),{state:yi(e,r,{sourceId:i,stepId:o}),messages:f}},Mc=(e,i=!1)=>{if(e.pendingStatus||(e.pendingFrames?.length??0)>0)return e0("Blocked processNextTurn while pendingStatus is active.",{status:e.pendingStatus?.status,pendingFrames:e.pendingFrames?.length??0,turnNumber:e.turnNumber}),e;let a=e;const o=[],c=[];let r=0;const f=100;let h=!1;for(;r<f;){if(r++,a.player.hp<=0&&a.pendingStatus?.status!=="lost"){const oe=er(a);return Fl({...a,message:Ht(a.message,"You have fallen...","CRITICAL","COMBAT")},{status:"lost",completedRun:oe},"RUN_LOST",{reason:"GLOBAL_DEATH_CHECK"})}a.occupancyMask=tt.refreshOccupancyMask(a);let y;if((i&&r===1||h)&&a.initiativeQueue){h=!1;const oe=a.initiativeQueue;oe.entries.length>0&&oe.currentIndex>=0&&oe.currentIndex<oe.entries.length&&(y=oe.entries[oe.currentIndex].actorId)}else{const oe=kx(a);a={...a,initiativeQueue:oe.queue},y=oe.actorId??void 0}if(!y)break;const A=y==="player"?a.player:a.enemies.find(oe=>oe.id===y),v=`${a.turnNumber}:${a.initiativeQueue?.round??0}:${y}:${r}`;if(!A||A.hp<=0){a={...a,initiativeQueue:af(a.initiativeQueue,y)};continue}if(Rx(a.initiativeQueue)?.turnStartPosition||(a={...a,initiativeQueue:Lx(a,A)}),!i||r>1){const oe=Kg(a,y,"START_OF_TURN",v);if(a=oe.state,o.push(...oe.messages),y==="player"&&a.upgrades?.includes("RELIC_STEADY_PLATES")){const pe=Math.min(2,(a.player.temporaryArmor||0)+1);pe!==(a.player.temporaryArmor||0)&&(a={...a,player:{...a.player,temporaryArmor:pe}},o.push(Ht([],"Steady Plates harden your stance.","INFO","COMBAT")[0]))}if(y==="player"){const pe=a.player.activeSkills?.find(ee=>ee.id==="SHIELD_BASH");if(!!pe?.activeUpgrades?.includes("PASSIVE_PROTECTION")&&(pe?.currentCooldown||0)===0){const ee=Math.max(a.player.temporaryArmor||0,1);ee!==(a.player.temporaryArmor||0)&&(a={...a,player:{...a.player,temporaryArmor:ee}},o.push(Ht([],"Passive Protection braces your guard.","INFO","COMBAT")[0]))}}const be=C1(a,a.player.position,y,v);a=be.state,o.push(...be.messages)}const _=y==="player"?a.player:a.enemies.find(oe=>oe.id===y);if(!_||_.hp<=0){a={...a,initiativeQueue:af(a.initiativeQueue,y),message:is(a.message,o,"INFO","SYSTEM")};continue}const p=y==="player"?a.player:a.enemies.find(oe=>oe.id===y);if(!p||p.hp<=0)continue;let g,R=!1;if(Ns(p))R=!0,g={type:"WAIT",actorId:p.id,skillId:"WAIT_SKILL",priority:0,metadata:{expectedValue:0,reasoningCode:"STATUS_STUNNED_AUTOSKIP",isGhost:!1}},y==="player"?o.push("You are stunned and skip your turn."):o.push(`${p.subtype||"Enemy"} is stunned and skips its turn.`);else{const be=ir.resolve(p).getIntent(a,p);if(be instanceof Promise){const pe=Fg(a);return{...a,intentPreview:pe,message:is(a.message,o,"INFO","SYSTEM"),dyingEntities:[...a.dyingEntities||[],...c]}}g=be}const I=_.activeSkills.map(oe=>oe.id).join(", ");Of&&(console.log(`[ENGINE] Actor: ${y} | Loadout: [${I}] | Pos: ${JSON.stringify(_.position)}`),console.log(`[ENGINE] Intent: ${g.type} | Skill: ${g.skillId} | TargetHex: ${g.targetHex?JSON.stringify(g.targetHex):"none"} | TargetId: ${g.primaryTargetId||"none"}`)),g.metadata.rngConsumption&&(a={...a,rngCounter:(a.rngCounter||0)+g.metadata.rngConsumption}),g=Xy(g,a,p);const{effects:C,messages:M,consumesTurn:N,targetId:Y,kills:X}=Qy.execute(g,p,a);if(Of&&console.log(`[ENGINE] ${y} intends ${g.type} (${g.skillId}) onto ${Y||(g.targetHex?JSON.stringify(g.targetHex):"self")}`),Zy&&C.length===0&&g.type!=="WAIT"){const oe=`[ENGINE] WARNING: Intent ${g.type} (${g.skillId}) for actor ${y} produced ZERO effects!`;console.warn(oe)}const O=a,q=yi(a,C,{sourceId:y,targetId:Y,stepId:v});if(y==="player"&&(q.kills=(q.kills||0)+(X||0)),N===!1){a={...O,message:is(a.message,M,"INFO","COMBAT")},h=!0;continue}if(a=q,o.push(...M),y!=="player"){const oe=a.enemies.find(be=>be.id===y);if(oe?.subtype==="bomber"){const be=g.skillId==="BOMB_TOSS"?2:Math.max(0,(oe.actionCooldown??0)-1);oe.actionCooldown!==be&&(a={...a,enemies:a.enemies.map(pe=>pe.id===y?{...pe,actionCooldown:be}:pe)})}}const K=y==="player"?a.player:a.enemies.find(oe=>oe.id===y);if(!K||K.hp<=0){if(y==="player"){const oe=er(a);return Fl({...a,message:Ht(is(a.message,o,"INFO","SYSTEM"),"You have fallen...","CRITICAL","COMBAT")},{status:"lost",completedRun:oe},"RUN_LOST",{reason:"SELF_ACTION_DEATH"})}a={...a,enemies:a.enemies.filter(oe=>oe.id!==y),initiativeQueue:af(a.initiativeQueue,y),message:is(a.message,o,"INFO","SYSTEM")};continue}const ue=Kg(a,y,"END_OF_TURN",v);a=ue.state,o.push(...ue.messages),a={...a,enemies:a.enemies.map(oe=>oe.id===y?wg(vg(oe)):oe),player:y==="player"?wg(vg(a.player)):a.player,initiativeQueue:Ix(a,y)};const W=y==="player"?a.player:a.enemies.find(oe=>oe.id===y);if(!(R||g.metadata?.reasoningCode==="STATUS_STUNNED"||g.metadata?.reasoningCode==="STATUS_STUNNED_AUTOSKIP")&&W&&W.hp>0){const oe=Bx(a,y)||W.previousPosition||W.position,be=jx(a,y)??void 0,pe=Jv(a,W,ot(oe),oe,be,v);a=pe.state,o.push(...pe.messages),y==="player"&&(a.kills=(a.kills||0)+pe.kills)}if(y==="player"){const oe=a.player.position;if(a.spearPosition&&ne(oe,a.spearPosition)){if(!!a.player.activeSkills?.find(ee=>ee.id==="SPEAR_THROW")?.activeUpgrades?.some(ee=>ee==="SPEAR_CLEAVE"||ee==="CLEAVE")){const ee=ot(oe).map(ae=>a.enemies.find(Te=>Te.hp>0&&ne(Te.position,ae))).filter(ae=>!!ae&&ae.factionId!==a.player.factionId);if(ee.length>0){const ae=ee.map(Te=>({type:"Damage",target:Te.id,amount:1,reason:"spear_cleave_pickup"}));a=yi(a,ae,{sourceId:a.player.id,stepId:v}),o.push(`Spear cleave hit ${ee.length} target(s).`)}}a={...a,hasSpear:!0,spearPosition:void 0,message:Ht(a.message,"Picked up your spear.","INFO","OBJECTIVE")}}const be=nA(a);if(a=be.state,o.push(...be.messages),a={...a,turnNumber:a.turnNumber+1,turnsSpent:(a.turnsSpent||0)+1},a.traps&&a.traps.length>0&&(a={...a,traps:a.traps.map(pe=>({...pe,cooldown:Math.max(0,pe.cooldown-1)}))}),ix(a,a.player.position)){const pe=a.player.activeSkills||[],H=new Set(pe.map($=>$.id)),ee=new Map;for(const $ of pe)ee.set($.id,new Set($.activeUpgrades||[]));const ae=Ln.getAllUpgrades().filter($=>H.has($.skillId)).filter($=>{if(a.upgrades.includes($.id))return!1;const J=ee.get($.skillId);return!J||!J.has($.id)}).map($=>$.id).filter(($,J,me)=>me.indexOf($)===J),Te=[];let xe={...a};for(let $=0;$<3&&ae.length>0;$++){const J=Fa(xe);xe=J.nextState;const me=Math.floor(J.value*ae.length);Te.push(ae[me]),ae.splice(me,1)}const k=Te.length>0?Te:["EXTRA_HP"];return Fl({...a,rngCounter:xe.rngCounter,message:Ht(a.message,"A holy shrine! Choose an upgrade.","INFO","OBJECTIVE")},{status:"choosing_upgrade",shrineOptions:k},"SHRINE_CHOICE",{shrineOptions:k})}if(sx(a,a.player.position)){if(a.floor>=10){const H=er(a);return Fl({...a,message:Ht(a.message,`Arcade Cleared! Final Score: ${H.score}`,"INFO","OBJECTIVE")},{status:"won",completedRun:H},"RUN_WON",{score:H.score??0})}return Fl({...a,message:Ht(a.message,"Descending to the next level...","INFO","OBJECTIVE")},{status:"playing"},"STAIRS_TRANSITION",{nextFloor:a.floor+1})}}}const b=Fg(a);return{...a,intentPreview:b,message:is(a.message,o,"INFO","SYSTEM"),dyingEntities:[...a.dyingEntities||[],...c]}},lA=(e,i)=>{const a=_f(e.player),o=a===e.player?e:{...e,player:a};if(o.gameStatus!=="playing"&&i.type!=="RESET"&&i.type!=="SELECT_UPGRADE"&&i.type!=="LOAD_STATE"&&i.type!=="APPLY_LOADOUT"&&i.type!=="START_RUN"&&i.type!=="EXIT_TO_HUB")return o;const c={...o,isShaking:!1,lastSpearPath:void 0,dyingEntities:[],occupiedCurrentTurn:void 0,visualEvents:[],timelineEvents:[]};switch(i.type){case"LOAD_STATE":{const v=i.payload;return Array.isArray(v.tiles)&&(v.tiles=new Map(v.tiles.map(([S,_])=>[S,{..._,traits:new Set(_.traits)}]))),v.player=_f(Zl(v.player)),v.enemies=(v.enemies||[]).map(Zl),v.companions&&(v.companions=v.companions.map(Zl)),v}case"RESET":{const S=e.player.archetype==="SKIRMISHER"?"SKIRMISHER":"VANGUARD",_=Uo[S];return Cs(1,i.payload?.seed||String(Date.now()),void 0,void 0,_)}case"EXIT_TO_HUB":return Cf()}if(o.gameStatus!=="playing"&&i.type!=="SELECT_UPGRADE"&&i.type!=="APPLY_LOADOUT"&&i.type!=="START_RUN")return o;const r=Z1(i,o),f=o;let h={...c,initiativeQueue:c.initiativeQueue};const y=((v,S)=>{if(["MOVE","THROW_SPEAR","WAIT","USE_SKILL","JUMP","SHIELD_BASH","ATTACK","LEAP"].includes(S.type)&&!Ql(v))return v;switch(S.type){case"SELECT_UPGRADE":{if(!("payload"in S))return v;const p=S.payload;if(!(v.pendingStatus?.shrineOptions||v.shrineOptions||[]).includes(p))return{...v,message:Ht(v.message,`Upgrade ${p} was not offered.`,"CRITICAL","SYSTEM")};let R=v.player,I=!1;const C=Ln.getUpgrade(p);if(C){const M=Ln.getSkillForUpgrade(p),N=!!M&&R.activeSkills.some(Y=>Y.id===M);if(M&&N){const Y=JSON.stringify(R.activeSkills);R=Sx(R,M,p),I=JSON.stringify(R.activeSkills)!==Y}}else p==="EXTRA_HP"&&(R=xx(R,1,!0),I=!0);return!I&&p!=="EXTRA_HP"?{...v,message:Ht(v.message,`Upgrade ${p} could not be applied.`,"CRITICAL","SYSTEM")}:{...v,player:R,upgrades:v.upgrades.includes(p)?v.upgrades:[...v.upgrades,p],gameStatus:"playing",shrinePosition:void 0,shrineOptions:void 0,pendingStatus:void 0,pendingFrames:void 0,message:Ht(v.message,`Gained ${C?.name||p}!`,"INFO","OBJECTIVE")}}case"USE_SKILL":{const{skillId:p,target:g}=S.payload,R=ir.resolve(v.player);return R instanceof nr&&R.pushIntent({type:"USE_SKILL",actorId:v.player.id,skillId:p,targetHex:g,priority:10,metadata:{expectedValue:0,reasoningCode:"PLAYER_INPUT",isGhost:!1}}),Mc(v,!0)}case"MOVE":{if(!("payload"in S))return v;const p=S.payload,g=v.player.activeSkills||[],R=Yi(v.enemies,p),I=["BASIC_ATTACK","BASIC_MOVE","DASH"],C=g.filter(q=>q.slot==="passive"),M=[...C.filter(q=>I.includes(q.id)),...C.filter(q=>!I.includes(q.id))];let N;for(const q of M){const K=Ln.get(q.id);if(!K?.getValidTargets)continue;if(K.getValidTargets(v,v.player.position).some(W=>ne(W,p))){N=q.id;break}}if(!N){const q=g.some(ue=>ue.id==="BASIC_ATTACK"),K=g.some(ue=>ue.id==="BASIC_MOVE");if(R&&q)N="BASIC_ATTACK";else if(!R&&K)N="BASIC_MOVE";else return{...v,message:Ht(v.message,R?"No valid passive attack for target.":"No valid passive movement for target.","CRITICAL","SYSTEM")}}const Y=R?"ATTACK":"MOVE",X=N,O=ir.resolve(v.player);return O instanceof nr&&O.pushIntent({type:Y,actorId:v.player.id,skillId:X,targetHex:p,primaryTargetId:R?.id,priority:10,metadata:{expectedValue:0,reasoningCode:"PLAYER_INPUT",isGhost:!1}}),Mc(v,!0)}case"WAIT":{const p=ir.resolve(v.player);return p instanceof nr&&p.pushIntent({type:"WAIT",actorId:v.player.id,skillId:"WAIT",priority:10,metadata:{expectedValue:0,reasoningCode:"PLAYER_INPUT",isGhost:!1}}),Mc(v,!0)}case"APPLY_LOADOUT":{if(!("payload"in S))return v;const p=S.payload,g=Gy(p);return{...v,player:{...v.player,activeSkills:g.activeSkills,archetype:g.archetype},upgrades:g.upgrades,hasSpear:p.startingSkills.includes("SPEAR_THROW"),hasShield:p.startingSkills.includes("SHIELD_THROW")||v.hasShield,selectedLoadoutId:p.id,message:Ht(v.message,`${p.name} selected.`,"INFO","SYSTEM")}}case"START_RUN":{const{loadoutId:p,seed:g,mode:R,date:I}=S.payload,C=Uo[p];if(!C)return v;if(R==="daily"){const M=$v(I),N=Vv(M);return{...Cs(1,g||N,void 0,void 0,C),dailyRunDate:M,runObjectives:Yv(N),hazardBreaches:0}}return Cs(1,g,void 0,void 0,C)}case"ADVANCE_TURN":return v.pendingStatus||(v.pendingFrames?.length??0)>0?(e0("Ignored ADVANCE_TURN while pendingStatus is active.",{status:v.pendingStatus?.status,pendingFrames:v.pendingFrames?.length??0,turnNumber:v.turnNumber}),v):Mc(v,!1);case"RESOLVE_PENDING":{const p=v.pendingFrames||[];if(p.length>1)return{...v,pendingFrames:p.slice(1)};if(!v.pendingStatus)return p.length===1?{...v,pendingFrames:[]}:v;const{status:g,shrineOptions:R,completedRun:I}=v.pendingStatus;if(g==="playing"&&v.gameStatus==="playing"){const C=v.initialSeed??v.rngSeed??"0",M=`${C}:${v.floor+1}`,N=v.enemies.filter(X=>X.hp>0&&X.factionId==="player"&&X.companionOf===v.player.id).sort((X,O)=>X.id.localeCompare(O.id)),Y=Cs(v.floor+1,M,C,{...v.player,hp:Math.min(v.player.maxHp,v.player.hp+1),upgrades:v.upgrades});if(N.length>0){const X=[Y.player.position,...ot(Y.player.position)],O=[Y.player,...Y.enemies],q=[];for(let K=0;K<N.length;K++){const ue=N[K],W=X[X.length-1]||Y.player.position,_e=X.find(be=>!O.some(H=>ne(H.position,be))&&qe.isWalkable(Y,be))||W,oe={...ue,position:_e,previousPosition:_e};O.push(oe),q.push(oe)}Y.enemies=[...Y.enemies,...q],Y.companions=[...Y.companions||[],...q.filter(K=>K.companionOf===v.player.id)],Y.initiativeQueue=Wa(Y),Y.occupancyMask=tt.refreshOccupancyMask(Y)}return{...Y,actionLog:[...v.actionLog||[]],dailyRunDate:v.dailyRunDate,runObjectives:v.runObjectives,hazardBreaches:v.hazardBreaches||0,pendingFrames:void 0}}return{...v,gameStatus:g,shrineOptions:R||v.shrineOptions,completedRun:I||v.completedRun,pendingStatus:void 0,pendingFrames:void 0}}case"EXIT_TO_HUB":return Cf();default:return v}})(h,i),A=eA(f,y,e);return r.delta=A,{...y,commandLog:[...y.commandLog||[],r],undoStack:[...y.undoStack||[],A],actionLog:[...y.actionLog||[],i]}},Oc={weightsByIntent:{offense:{survival:2.1,lethality:6.5,position:2.4,objective:.5,status:2.5,tempo:1.6,resource:1},defense:{survival:4.8,lethality:3.6,position:3,objective:.8,status:2.2,tempo:1.6,resource:1},positioning:{survival:2.3,lethality:3.8,position:3.1,objective:6,status:1.4,tempo:1.6,resource:1},control:{survival:2.3,lethality:4.2,position:2.8,objective:.6,status:3.4,tempo:1.6,resource:1}},thresholds:{defenseHpRatio:.45,defensePressureHpRatio:.65,defensePressureAdjacentHostiles:2,controlMinHostiles:3}};({...Oc.weightsByIntent,offense:{...Oc.weightsByIntent.offense},control:{...Oc.weightsByIntent.control}},{...Oc.thresholds});const Gg={skill:{staticWeight:.5,powerCoeff:1,reachCoeff:1,safetyCoeff:1,tempoCoeff:1,complexityCoeff:1,perSkillScalar:{}},policy:{offenseWeight:1,defenseWeight:1,positioningWeight:1,statusWeight:1,riskPenaltyWeight:1}};({...Gg.policy},{...Gg.skill});const rA=new Set(["MOVE","THROW_SPEAR","WAIT","USE_SKILL","JUMP","SHIELD_BASH","ATTACK","LEAP","ADVANCE_TURN","SELECT_UPGRADE","RESOLVE_PENDING"]),cA=e=>typeof e=="object"&&e!==null,Wg=e=>{if(!Array.isArray(e))return{valid:!1,actions:[],errors:["Replay actions must be an array."]};const i=[],a=[];return e.forEach((o,c)=>{if(!cA(o)||typeof o.type!="string"){a.push(`Action[${c}] is not a valid action object with a "type" field.`);return}if(!rA.has(o.type)){a.push(`Action[${c}] type "${o.type}" is not replayable.`);return}i.push(o)}),{valid:a.length===0,actions:i,errors:a}},Ya=e=>({q:e.q,r:e.r,s:e.s}),Cc=e=>({...e,position:Ya(e.position),previousPosition:e.previousPosition?Ya(e.previousPosition):void 0,intentPosition:e.intentPosition?Ya(e.intentPosition):void 0,statusEffects:e.statusEffects.map(i=>({...i})),activeSkills:e.activeSkills.map(i=>({...i,upgrades:[...i.upgrades||[]],activeUpgrades:[...i.activeUpgrades||[]]})),components:e.components?new Map(e.components):void 0,companionState:e.companionState?{...e.companionState,markTarget:typeof e.companionState.markTarget=="object"&&e.companionState.markTarget?Ya(e.companionState.markTarget):e.companionState.markTarget}:void 0}),uA=e=>({...e,player:Cc(e.player),enemies:e.enemies.map(Cc),companions:e.companions?.map(Cc),dyingEntities:e.dyingEntities?.map(Cc),message:[...e.message],visualEvents:[...e.visualEvents||[]],simulationEvents:[...e.simulationEvents||[]],stackTrace:e.stackTrace?e.stackTrace.map(i=>({...i})):void 0,timelineEvents:e.timelineEvents?e.timelineEvents.map(i=>({...i})):void 0,occupancyMask:[...e.occupancyMask],tiles:new Map(Array.from(e.tiles.entries()).map(([i,a])=>[i,{...a,position:Ya(a.position),traits:new Set(a.traits),effects:a.effects.map(o=>({...o}))}])),traps:e.traps?.map(i=>({...i,position:Ya(i.position)})),lastSpearPath:e.lastSpearPath?.map(Ya),actionLog:e.actionLog?[...e.actionLog]:void 0}),Xg=(e,i)=>e.player.id===i?e.player:e.enemies.find(a=>a.id===i)||e.companions?.find(a=>a.id===i),dA=(e,i)=>{if(i)return Ee(e,i)?.id},fA=(e,i)=>{const a=Xg(e,i.actorId);if(!a)return{ok:!1,reason:`Actor ${i.actorId} not found`,effects:[],messages:[],simulationEvents:[],stackTrace:[]};const o=Ln.get(i.skillId);if(!o)return{ok:!1,reason:`Skill ${i.skillId} not found`,effects:[],messages:[],simulationEvents:[],stackTrace:[]};if(i.target&&o.getValidTargets&&!o.getValidTargets(e,a.position).some(S=>he(S)===he(i.target)))return{ok:!1,reason:`Target ${he(i.target)} is invalid`,effects:[],messages:[],simulationEvents:[],stackTrace:[]};const c=uA(e),r=Xg(c,i.actorId),f=o.execute(c,r,i.target,i.activeUpgrades||[],i.context||{}),h=c.simulationEvents?.length||0,b=c.stackTrace?.length||0,y=dA(c,i.target),A=yi(c,f.effects,{sourceId:r.id,targetId:y});return{ok:!0,effects:f.effects,messages:f.messages,consumesTurn:f.consumesTurn,predictedState:A,simulationEvents:(A.simulationEvents||[]).slice(h),stackTrace:(A.stackTrace||[]).slice(b)}},mA=e=>({q:e.q,r:e.r,s:e.s}),pA=e=>{const i=[e.player,...e.enemies,...e.companions||[],...e.dyingEntities||[]];return{turn:e.turnNumber||0,stackTick:e.stackTrace?.length||0,actors:i.map(a=>({id:a.id,position:mA(a.position)}))}},hA=(e,i)=>{const a=[],o=new Map(e.actors.map(r=>[r.id,r.position])),c=new Map(i.actors.map(r=>[r.id,r.position]));for(const[r,f]of o.entries()){const h=c.get(r);if(!h){a.push({actorId:r,expected:f,reason:"missing_in_ui"});continue}he(f)!==he(h)&&a.push({actorId:r,expected:f,actual:h,reason:"position_mismatch"})}for(const[r,f]of c.entries())o.has(r)||a.push({actorId:r,actual:f,reason:"missing_in_engine"});return{ok:a.length===0,mismatches:a}},Kl={player:{icon:"",shape:"square",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1},vanguard:{icon:"",shape:"square",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1},skirmisher:{icon:"",shape:"square",color:"#3b82f6",borderColor:"#fbbf24",isRanged:!1},firemage:{icon:"",shape:"square",color:"#ef4444",borderColor:"#fbbf24",isRanged:!0},necromancer:{icon:"",shape:"square",color:"#6b21a8",borderColor:"#9333ea",isRanged:!0},hunter:{icon:"",shape:"square",color:"#10b981",borderColor:"#ffffff",isRanged:!0},assassin_player:{icon:"",shape:"square",color:"#1f2937",borderColor:"#ffffff",isRanged:!1},footman:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#ffffff",isRanged:!1},sprinter:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#ffffff",isRanged:!1,size:.9},spear:{icon:"",shape:"circle",color:"#ffffff",borderColor:"#3b82f6",isRanged:!1,size:.8,opacity:.9},shieldBearer:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#fbbf24",isRanged:!1,showFacing:!0},golem:{icon:"",shape:"diamond",color:"#78716c",borderColor:"#ffffff",isRanged:!1,size:1.2},assassin:{icon:"",shape:"diamond",color:"#6b21a8",borderColor:"#ffffff",isRanged:!1},archer:{icon:"",shape:"triangle",color:"#ef4444",borderColor:"#ffffff",isRanged:!0},bomber:{icon:"",shape:"circle",color:"#ef4444",borderColor:"#ffffff",isRanged:!0},warlock:{icon:"",shape:"triangle",color:"#9333ea",borderColor:"#ffffff",isRanged:!0},bomb:{icon:"",shape:"circle",color:"#1f2937",borderColor:"#000000",isRanged:!1,showTimer:!0},falcon:{icon:"",shape:"circle",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1,size:.8},skeleton:{icon:"",shape:"circle",color:"#3b82f6",borderColor:"#ffffff",isRanged:!1,size:.8},sentinel:{icon:"",shape:"diamond",color:"#dc2626",borderColor:"#fbbf24",isRanged:!0,size:1.5}};function or(e,i,a,o){if(e&&Kl[e])return Kl[e];if(i==="player"&&o){const c=o==="ASSASSIN"?"assassin_player":o.toLowerCase();if(Kl[c])return Kl[c]}return i==="player"?Kl.player:a==="ranged"?{icon:"",shape:"triangle",color:"#ef4444",borderColor:"#ffffff",isRanged:!0}:a==="boss"?{icon:"",shape:"diamond",color:"#dc2626",borderColor:"#fbbf24",isRanged:!1,size:1.5}:{icon:"",shape:"diamond",color:"#ef4444",borderColor:"#ffffff",isRanged:!1}}function gA(e){return e.isFlying===!0}const mf=e=>{const i=[];for(let a=0;a<6;a++){const o=60*a,c=Math.PI/180*o,r=e*Math.cos(c),f=e*Math.sin(c);i.push(`${r},${f}`)}return i.join(" ")},yA=()=>typeof window>"u"?!1:!!window.__HOP_DEBUG_HEX_COORDS,bA=[{cx:-8,cy:-6,r:3,delay:0},{cx:6,cy:2,r:2.5,delay:.3},{cx:-3,cy:8,r:2,delay:.6}],xA=e=>{const i=[[-.6,.42],[-.5,.15],[-.34,-.18],[-.16,-.36],[0,-.62],[.12,-.42],[.3,-.2],[.48,.1],[.6,.4],[.4,.48],[-.48,.48]],a=[[-.48,.48],[-.6,.42],[-.34,-.18],[-.18,-.24],[-.28,.28]],o=[[.6,.4],[.4,.48],[.2,.28],[.3,-.2],[.48,.1]],c=[[-.34,-.18],[-.16,-.36],[0,-.62],[.12,-.42],[.3,-.2]],r=[[-.46,.1],[-.3,-.12],[-.1,-.24],[0,-.4]],f=h=>h.map(([b,y])=>`${(b*e).toFixed(2)},${(y*e).toFixed(2)}`).join(" ");return{body:f(i),leftFace:f(a),rightFace:f(o),ridgeA:f(c),ridgeB:f(r)}},vA=({hex:e,onClick:i,isValidMove:a,isTargeted:o,isStairs:c,isLava:r,isShrine:f,isWall:h,isFire:b,onMouseEnter:y,assetHref:A,interactionOnly:v})=>{const[S,_]=w.useState(!1);w.useEffect(()=>{_(!1)},[A]);const{x:p,y:g}=ut(e,se),R=yA(),I=mf(se-2),C=xA(se-2),M=`hex-clip-${e.q}-${e.r}-${e.s}`;let N=Tc.floor,Y="rgba(0,0,0,0.2)",X="default";h?(N=Tc.wall,Y="#1f2937"):r?(N="#7f1d1d",Y="#7f1d1d"):b?(N="#7c2d12",Y="#ea580c"):c?(N=Tc.portal,Y="#000000"):f&&(N=Tc.shrine,Y="#c2410c"),v&&(N="transparent",Y="rgba(255,255,255,0.10)"),a&&(Y="rgba(255,255,255,0.78)",X="pointer"),o&&(Y="#f97316");const O=!!A&&!v&&!S;return m.jsxs("g",{transform:`translate(${p},${g})`,onClick:()=>i(e),onMouseEnter:()=>y?.(e),style:{cursor:X},className:"hex-tile transition-colors duration-200",children:[h&&O&&m.jsx("polygon",{points:mf(se-2),fill:"#111827",transform:"translate(0, 4)"}),!O&&(h?m.jsxs("g",{"data-wall-fallback":"relief",children:[m.jsx("ellipse",{cx:"0",cy:se*.56,rx:se*.56,ry:se*.18,fill:"rgba(3,7,18,0.55)"}),m.jsx("polygon",{points:I,fill:"#0f172a",transform:"translate(0, 5)",opacity:"0.92"}),m.jsx("polygon",{points:I,fill:"#1f2937",transform:"translate(0, 2)",opacity:"0.98"}),m.jsx("polygon",{points:I,fill:"#273447"}),m.jsx("polygon",{points:C.body,fill:"#4b5563",opacity:"0.96"}),m.jsx("polygon",{points:C.leftFace,fill:"#6b7280",opacity:"0.9"}),m.jsx("polygon",{points:C.rightFace,fill:"#374151",opacity:"0.95"}),m.jsx("polyline",{points:C.ridgeA,fill:"none",stroke:"rgba(229,231,235,0.55)",strokeWidth:"1.1",strokeLinecap:"round",strokeLinejoin:"round"}),m.jsx("polyline",{points:C.ridgeB,fill:"none",stroke:"rgba(17,24,39,0.58)",strokeWidth:"1",strokeLinecap:"round",strokeLinejoin:"round"}),m.jsx("polygon",{points:I,fill:"none",stroke:Y,strokeWidth:o||a?"2":"1"})]}):m.jsx("polygon",{points:I,fill:N,stroke:Y,strokeWidth:o||a?"2":"1"})),O&&m.jsxs(m.Fragment,{children:[m.jsx("defs",{children:m.jsx("clipPath",{id:M,children:m.jsx("polygon",{points:I})})}),m.jsx("image",{href:A,x:-se,y:-31.176,width:se*2,height:se*1.732,preserveAspectRatio:"xMidYMid slice",clipPath:`url(#${M})`,onError:()=>_(!0)}),m.jsx("polygon",{points:I,fill:"none",stroke:Y,strokeWidth:o||a?"2":"1"})]}),r&&!v&&m.jsxs("g",{className:"lava-bubbles",children:[bA.map((q,K)=>m.jsx("circle",{cx:q.cx,cy:q.cy,r:q.r,fill:"#fbbf24",opacity:"0.7",style:{animation:`lavaBubble 2s ease-in-out ${q.delay}s infinite`}},K)),m.jsx("polygon",{points:mf(se-4),fill:"none",stroke:"#f97316",strokeWidth:"1",opacity:"0.35"})]}),b&&!v&&m.jsxs("g",{className:"fire-embers",children:[m.jsx("circle",{cx:"-6",cy:"4",r:"2",fill:"#fbbf24",opacity:"0.75",style:{animation:"lavaBubble 1.6s ease-in-out 0s infinite"}}),m.jsx("circle",{cx:"4",cy:"-6",r:"1.5",fill:"#fcd34d",opacity:"0.75",style:{animation:"lavaBubble 1.4s ease-in-out 0.5s infinite"}})]}),R&&m.jsx("text",{x:"0",y:"0",textAnchor:"middle",fill:"rgba(0,0,0,0.15)",fontSize:"8",dy:".3em",pointerEvents:"none",children:`${e.q},${e.r}`})]})},SA=$i.memo(vA,(e,i)=>e.hex.q===i.hex.q&&e.hex.r===i.hex.r&&e.hex.s===i.hex.s&&e.onClick===i.onClick&&e.onMouseEnter===i.onMouseEnter&&e.isCenter===i.isCenter&&e.isSelected===i.isSelected&&e.isValidMove===i.isValidMove&&e.isTargeted===i.isTargeted&&e.isStairs===i.isStairs&&e.isLava===i.isLava&&e.isShrine===i.isShrine&&e.isWall===i.isWall&&e.isFire===i.isFire&&e.assetHref===i.assetHref&&e.interactionOnly===i.interactionOnly),AA={catacombs:.2,inferno:.16,throne:.24,frozen:.45,void:.08},TA=(e,i)=>{const a=Math.max(e,i),o=Math.min(e,i);return(a+.05)/(o+.05)},EA=(e,i,a=24,o,c,r=1)=>{const f=or(e.subtype,e.type,e.enemyType,e.archetype),{icon:h,shape:b,color:y,borderColor:A,size:v=1}=f,S=a*v,_=e.statusEffects?.find(I=>I.type==="time_bomb"),p=_?Math.max(0,_.duration):e.actionCooldown??0,g=`contrast(${r.toFixed(2)}) brightness(${(r>1?1.12:1.04).toFixed(2)})`,R=i?`drop-shadow(0 3px 4px rgba(0,0,0,0.45)) drop-shadow(0 0 2px rgba(255,255,255,0.5)) saturate(1.08) ${g}`:`drop-shadow(0 3px 4px rgba(0,0,0,0.50)) drop-shadow(0 0 2px rgba(255,255,255,0.35)) saturate(1.0) ${g}`;return m.jsxs("g",{children:[m.jsx("title",{children:i?"Player":`${e.subtype||"Enemy"}`}),o&&m.jsx("image",{href:o,x:-S,y:-S,width:S*2,height:S*2,preserveAspectRatio:"xMidYMid meet",onError:c,style:{filter:R,opacity:i?1:.97}}),!o&&b==="square"&&m.jsx("rect",{x:-S*.8,y:-S*.8,width:S*1.6,height:S*1.6,fill:y,stroke:A,strokeWidth:2}),!o&&b==="diamond"&&m.jsx("path",{d:`M0 ${-S*.8} L${S*.6} 0 L0 ${S*.8} L${-S*.6} 0 Z`,fill:y,stroke:A,strokeWidth:1}),!o&&b==="triangle"&&m.jsx("path",{d:`M0 ${-S*.8} L${S*.7} ${S*.5} L${-S*.7} ${S*.5} Z`,fill:y,stroke:A,strokeWidth:1}),!o&&b==="circle"&&m.jsx("circle",{r:S*.7,fill:y,stroke:A,strokeWidth:1}),e.subtype==="bomb"&&m.jsx("text",{y:S*.2,textAnchor:"middle",fill:"#fff",fontSize:"10",fontWeight:"bold",children:p}),!o&&!i&&e.subtype!=="bomb"&&m.jsx("text",{x:"0",y:"0",textAnchor:"middle",dy:".3em",fontSize:S*.8,opacity:.8,children:h}),!o&&i&&m.jsx("path",{d:`M0 ${-S*.4} L0 ${S*.4} M${-S*.15} ${-S*.2} L0 ${-S*.5} L${S*.15} ${-S*.2}`,stroke:A,strokeWidth:2,fill:"none"})]})},wA=({entity:e,isSpear:i,isDying:a,movementTrace:o,waapiControlled:c=!1,assetHref:r,fallbackAssetHref:f,floorTheme:h})=>{const[b,y]=w.useState(e.position),[A,v]=w.useState(()=>ut(e.position,se)),[S,_]=w.useState(e.previousPosition),[p,g]=w.useState(220),[R,I]=w.useState("cubic-bezier(0.22, 1, 0.36, 1)"),[C,M]=w.useState("none"),N=w.useRef(!1),Y=w.useRef(e.position),X=w.useRef([]),O=w.useRef(null),[q,K]=w.useState(!1),ue=w.useRef(e.hp),W=e.type==="player",_e=typeof window<"u"&&!!window.__HOP_DEBUG_MOVEMENT,[oe,be]=w.useState(r||f),[pe,H]=w.useState(!1);w.useEffect(()=>{be(r||f),H(!1)},[r,f,e.id]);const ee=()=>{if(!pe&&f&&oe!==f){be(f),H(!0);return}be(void 0)};w.useEffect(()=>{const Ne=()=>{for(const dt of X.current)clearTimeout(dt);X.current=[],O.current!==null&&(cancelAnimationFrame(O.current),O.current=null)};if(c){Ne(),N.current=!1;const dt=!!(o&&o.actorId===e.id&&o.destination&&ne(o.destination,e.position)),Mt=!ne(e.position,Y.current);Y.current=e.position,Mt&&!dt&&(y(e.position),_(e.previousPosition),v(ut(e.position,se))),C!=="none"&&M("none"),p!==0&&g(0),R!=="linear"&&I("linear");return}if(!ne(e.position,Y.current)){Y.current=e.position;const dt=o&&o.actorId===e.id&&o.destination&&ne(o.destination,e.position)&&Array.isArray(o.path)&&o.path.length>0,Mt=dt?o.path:void 0,gn=dt?o.movementType:void 0,$n=dt?Math.max(0,o.startDelayMs??0):0;if(_e){const bi=e.previousPosition?Pt(e.previousPosition,e.position).length:0;console.log("[HOP_MOVE]",{actorId:e.id,movementType:gn||"fallback",usedEngineTrace:dt,tracePathLength:Mt?.length||0,tracePath:Mt||[],startDelayMs:$n,fallbackPathLength:bi,origin:o?.origin||e.previousPosition,destination:e.position})}if(gn==="teleport"&&dt&&o.origin){Ne(),N.current=!0;const bi=o.durationMs??180,ht=Math.max(80,Math.floor(bi/2)),Bt=()=>{g(0),I("linear"),_(o.origin),y(o.origin),v(ut(o.origin,se)),M("out");const Yn=window.setTimeout(()=>{y(e.position),_(e.position),v(ut(e.position,se)),M("in")},ht),$t=window.setTimeout(()=>{M("none"),N.current=!1},ht*2);X.current.push(Yn,$t)};if($n>0){const Yn=window.setTimeout(Bt,$n);X.current.push(Yn)}else Bt();return()=>{Ne(),N.current=!1}}const At=!!(e.previousPosition&&!ne(e.position,e.previousPosition));if(!!(Mt&&Mt.length>1)||At){let ht=Mt||(e.previousPosition?Pt(e.previousPosition,e.position):[]);if(dt&&o?.origin&&ht.length>1&&ne(ht[ht.length-1],o.origin)&&!ne(ht[0],o.origin)&&(ht=[...ht].reverse()),ht.length>1){Ne(),N.current=!0;const Bt=Math.max(1,ht.length-1),Yn=o?.durationMs?o.durationMs/Bt:0,$t=Math.max(90,Math.min(130,Yn||112)),as=$t*Bt,Wt=ht.map(An=>ut(An,se)),In=performance.now(),Xt=An=>An<.5?4*An*An*An:1-Math.pow(-2*An+2,3)/2;M("none"),g(0),I("linear"),y(ht[0]),_(ht[0]),v(Wt[0]);let yn=-1;const Ut=An=>{const xi=Math.max(0,An-In),en=Math.min(Bt-1,Math.floor(xi/$t)),dn=en*$t,Bn=xi-dn,Tn=Math.max(0,Math.min(1,Bn/$t)),En=Xt(Tn);en!==yn&&(_(ht[en]),y(ht[Math.min(ht.length-1,en+1)]),yn=en);const Ue=Wt[en],Tt=Wt[Math.min(Wt.length-1,en+1)];if(v({x:Ue.x+(Tt.x-Ue.x)*En,y:Ue.y+(Tt.y-Ue.y)*En}),xi<as){O.current=requestAnimationFrame(Ut);return}N.current=!1,y(e.position),_(e.previousPosition),v(Wt[Wt.length-1]),O.current=null};if($n>0){const An=window.setTimeout(()=>{O.current=requestAnimationFrame(Ut)},$n);X.current.push(An)}else O.current=requestAnimationFrame(Ut);return()=>{Ne(),N.current=!1}}}M("none"),g(220),I("cubic-bezier(0.22, 1, 0.36, 1)"),y(e.position),_(e.previousPosition),v(ut(e.position,se))}},[e.position,e.previousPosition,o,e.id,c]);const{x:ae,y:Te}=A||ut(b,se);w.useEffect(()=>{if(e.hp<ue.current){K(!0);const Ne=setTimeout(()=>K(!1),150);return()=>clearTimeout(Ne)}ue.current=e.hp},[e.hp]);let xe="";const k=S;if(k&&!ne(b,k)){const Ne=fa(k,b);if(Ne!==-1){const dt=Ne*60;xe=`rotate(${dt}) scale(1.15, 0.85) rotate(${-dt})`}}const $=e.isVisible===!1;if(i){const Ne=or("spear","enemy");return m.jsx("g",{style:{pointerEvents:"none"},children:m.jsx("g",{transform:`translate(${ae},${Te})`,children:m.jsx("text",{x:"0",y:"0",textAnchor:"middle",dy:".3em",fontSize:"20",style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.5))"},children:Ne.icon})})})}const J=or(e.subtype,e.type,e.enemyType,e.archetype),me=gA(e),Me=W?1.34:.92,ke=W?-9:-2,Ie=W?24:18,pt=String(h||"").toLowerCase(),ze=AA[pt]??.22,St=TA(ze,W?.87:.82)<4.5?1.22:1.06,Gt=W?"#22e7ff":"rgba(255,120,120,0.7)",_t=W?"rgba(34,231,255,0.20)":"rgba(239,68,68,0.16)",zn=W?"rgba(34,231,255,0.36)":"rgba(255,90,90,0.28)",ai=W?se*.48:se*.42,Ve=W?se*.17:se*.145,De=W?se*.32:se*.3;return m.jsx("g",{style:{pointerEvents:"none"},children:m.jsx("g",{"data-actor-node":e.id,style:{transition:c?"none":`transform ${p}ms ${R}`,transform:`translate(${ae}px, ${Te}px)`},className:a?"animate-lava-sink":"",children:m.jsxs("g",{transform:xe,className:`${q?"entity-damaged":""} ${!a&&!Ns(e)?"animate-idle":""} ${C==="out"?"entity-teleport-out":""} ${C==="in"?"entity-teleport-in":""}`,opacity:$?.3:J.opacity||1,style:{filter:$?"blur(1px)":"none"},children:[m.jsxs("g",{transform:`translate(0,${De})`,children:[m.jsx("ellipse",{cx:0,cy:0,rx:ai,ry:Ve,fill:_t,stroke:Gt,strokeWidth:2,opacity:.95,style:{filter:`drop-shadow(0 0 5px ${zn})`}}),m.jsx("ellipse",{cx:0,cy:0,rx:ai*1.14,ry:Ve*1.14,fill:"none",stroke:Gt,strokeWidth:W?1.8:1.6,opacity:W?.62:.54})]}),me&&m.jsx("ellipse",{cx:0,cy:se*.3,rx:se*.4,ry:se*.15,fill:"black",opacity:.2}),m.jsx("g",{transform:`translate(0,${ke}) scale(${Me})`,children:EA(e,W,Ie,oe,ee,St)}),Ns(e)&&m.jsxs("g",{transform:`translate(0, -${se*.8})`,className:"stun-icon",children:[m.jsx("text",{fontSize:"14",textAnchor:"middle",children:"*"}),m.jsx("text",{fontSize:"8",textAnchor:"middle",dy:"-3",dx:"6",children:"+"})]}),J.showFacing&&e.facing!==void 0&&!Ns(e)&&m.jsx("line",{x1:0,y1:0,x2:Math.cos((e.facing*60-90)*Math.PI/180)*se*.5,y2:Math.sin((e.facing*60-90)*Math.PI/180)*se*.5,stroke:J.borderColor,strokeWidth:3,strokeLinecap:"round"}),m.jsx("title",{children:`${e.subtype||e.type} - HP ${e.hp}/${e.maxHp}${e.intent?` - ${e.intent}`:""}`})]})})})},Qg=e=>{if(!e)return"";const i=(e.path||[]).map(a=>`${a.q},${a.r},${a.s}`).join(";");return`${e.actorId}|${e.movementType||""}|${e.destination?.q??""},${e.destination?.r??""},${e.destination?.s??""}|${i}|${e.durationMs??""}|${e.startDelayMs??0}|${e.wasLethal?1:0}`},Jg=(e=[])=>e.map(i=>`${i.id}:${i.duration??""}:${i.stacks??""}`).join("|"),Nc=$i.memo(wA,(e,i)=>{const a=e.entity,o=i.entity;return e.isSpear===i.isSpear&&e.isDying===i.isDying&&e.waapiControlled===i.waapiControlled&&e.assetHref===i.assetHref&&e.fallbackAssetHref===i.fallbackAssetHref&&e.floorTheme===i.floorTheme&&Qg(e.movementTrace)===Qg(i.movementTrace)&&a.id===o.id&&a.hp===o.hp&&a.maxHp===o.maxHp&&a.facing===o.facing&&a.intent===o.intent&&a.isVisible===o.isVisible&&a.position.q===o.position.q&&a.position.r===o.position.r&&a.position.s===o.position.s&&(a.previousPosition?.q??0)===(o.previousPosition?.q??0)&&(a.previousPosition?.r??0)===(o.previousPosition?.r??0)&&(a.previousPosition?.s??0)===(o.previousPosition?.s??0)&&(a.intentPosition?.q??0)===(o.intentPosition?.q??0)&&(a.intentPosition?.r??0)===(o.intentPosition?.r??0)&&(a.intentPosition?.s??0)===(o.intentPosition?.s??0)&&Jg(a.statusEffects)===Jg(o.statusEffects)}),_A=({gameState:e,selectedSkillId:i,showMovementRange:a,hoveredTile:o,enginePreviewGhost:c})=>{const r=e.player.position,f=w.useMemo(()=>{const S=new Set;for(const _ of e.enemies)_.hp>0&&S.add(he(_.position));return S},[e.enemies]),h=w.useMemo(()=>{if(!a||i)return[];const S=new Set(e.player.activeSkills.map(R=>R.id)),_=["BASIC_MOVE","DASH"],p=new Set,g=[];return _.forEach(R=>{if(S.has(R)){const I=Ln.get(R);I?.getValidTargets&&I.getValidTargets(e,r).forEach(M=>{const N=he(M);p.has(N)||(p.add(N),g.push(M))})}}),g.length===0?[{q:r.q+1,r:r.r,s:r.s-1},{q:r.q+1,r:r.r-1,s:r.s},{q:r.q,r:r.r-1,s:r.s+1},{q:r.q-1,r:r.r,s:r.s+1},{q:r.q-1,r:r.r+1,s:r.s},{q:r.q,r:r.r+1,s:r.s-1}].filter(I=>pa(I,e.gridWidth,e.gridHeight)):g},[e,a,i,r]),b=w.useMemo(()=>{const S=new Set;for(const _ of h)S.add(he(_));return S},[h]),y=w.useMemo(()=>{if(!i)return[];const S=Ln.get(i),_=M1(e.player,i)||S?.baseVariables?.range||0,p=S?.getValidTargets?S.getValidTargets(e,r):[],g=new Set(p.map(he)),R=[];if(i==="DASH"||i==="SPEAR_THROW"||i==="SHIELD_THROW"||i==="GRAPPLE_HOOK")for(let C=0;C<6;C++)for(let M=1;M<=_;M++){const N=Wn(r,If(C,M));if(!pa(N,e.gridWidth,e.gridHeight))break;const Y=qe.isLosBlocking(e,N),X=f.has(he(N)),K=Pt(r,N).slice(1,-1).some(W=>qe.isLosBlocking(e,W)||f.has(he(W))),ue=g.has(he(N));if(R.push({p:N,isValidTarget:ue,isBlocked:K,isWall:Y,isEnemy:X}),Y||X)break}else p.forEach(C=>{const M=qe.isLosBlocking(e,C),N=f.has(he(C));R.push({p:C,isValidTarget:!0,isBlocked:!1,isWall:M,isEnemy:N})});return R},[e,i,r,f]),A=w.useMemo(()=>{const S=new Map;for(const _ of y)S.set(he(_.p),_);return S},[y]),v=w.useMemo(()=>{if(c)return c;if(a&&o&&!i&&b.has(he(o)))return{path:Pt(r,o),aoe:[],hasEnemy:!1,target:o};if(!i||!o)return null;const S=A.get(he(o));if(!S||!S.isValidTarget||S.isBlocked)return null;const _=Pt(r,o),p=ax(e,i,r,o),g=S.isEnemy;return{path:_,aoe:p,hasEnemy:g,target:o}},[c,e,i,o,A,b,a,r]);return m.jsx("g",{pointerEvents:"none",children:v&&m.jsxs("g",{children:[(()=>{const S=v.path.map(C=>ut(C,se)),_=S.map((C,M)=>`${M===0?"M":"L"} ${C.x} ${C.y}`).join(" "),p=S[S.length-1],g=S[S.length-2]||{x:p.x-1,y:p.y},R=Math.atan2(p.y-g.y,p.x-g.x),I=8;return m.jsxs("g",{children:[m.jsx("path",{d:_,stroke:"rgba(255,255,255,0.9)",strokeWidth:"2.25",fill:"none",opacity:"0.85",style:{filter:"drop-shadow(0 0 4px rgba(255,255,255,0.22))"}}),m.jsx("path",{d:`M ${p.x} ${p.y} L ${p.x-I*Math.cos(R-Math.PI/6)} ${p.y-I*Math.sin(R-Math.PI/6)} M ${p.x} ${p.y} L ${p.x-I*Math.cos(R+Math.PI/6)} ${p.y-I*Math.sin(R+Math.PI/6)}`,stroke:"rgba(255,255,255,0.95)",strokeWidth:"2",opacity:"0.9"})]})})(),v.hasEnemy&&(()=>{const{x:S,y:_}=ut(v.target,se),p=se*.7;return m.jsxs("g",{children:[m.jsx("circle",{cx:S,cy:_,r:p,fill:"none",stroke:"#ef4444",strokeWidth:"2",strokeDasharray:"4 2"}),m.jsx("line",{x1:S-p,y1:_,x2:S+p,y2:_,stroke:"#ef4444",strokeWidth:"1"}),m.jsx("line",{x1:S,y1:_-p,x2:S,y2:_+p,stroke:"#ef4444",strokeWidth:"1"})]})})(),!v.hasEnemy&&(()=>{const{x:S,y:_}=ut(v.target,se);return m.jsx("circle",{cx:S,cy:_,r:se*.36,fill:"rgba(255,255,255,0.14)",stroke:"rgba(255,255,255,0.65)",strokeWidth:1.5})})(),Array.from(new Map(v.aoe.map(S=>[he(S),S])).values()).map(S=>{const{x:_,y:p}=ut(S,se);return m.jsx("circle",{cx:_,cy:p,r:se*.6,fill:"rgba(239, 68, 68, 0.2)",stroke:"rgba(239, 68, 68, 0.5)",strokeWidth:2,strokeDasharray:"4 2"},`aoe-${S.q}-${S.r}`)})]})})},MA=["white","blue","black","red","green"],Zg={white:{label:"Plains / Mesa",floorAssetId:"tile.catacombs.floor.01",hazardAssetId:"tile.catacombs.lava.01"},blue:{label:"Islands / Coast",floorAssetId:"tile.frozen.floor.01",hazardAssetId:"tile.catacombs.lava.01"},black:{label:"Swamp / Wastes",floorAssetId:"tile.void.floor.01",hazardAssetId:"tile.catacombs.lava.01"},red:{label:"Mountains / Volcanic",floorAssetId:"tile.inferno.floor.01",hazardAssetId:"tile.inferno.lava.01"},green:{label:"Forest / Jungle",floorAssetId:"tile.throne.floor.01",hazardAssetId:"tile.catacombs.lava.01"}},OA={catacombs:"white",frozen:"blue",void:"black",inferno:"red",throne:"green"},CA=e=>{if(typeof e!="string")return;const i=e.toLowerCase();return MA.includes(i)?i:void 0},NA=()=>{if(!(typeof window>"u"))return CA(window.__HOP_FORCE_BIOME)},RA=e=>{const i=NA();if(i)return i;const a=String(e||"").toLowerCase();return OA[a]||"white"},kA=e=>{const i=RA(e.theme);return e.isWall?"tile.catacombs.wall.01":e.isLava?Zg[i].hazardAssetId:e.isFire?"tile.catacombs.fire.01":Zg[i].floorAssetId},ey=e=>{if(e.isStairs)return"prop.core.stairs.01";if(e.isShrine)return"prop.core.shrine.01"},zc=e=>{if(e.type==="player")switch(e.archetype){case"FIREMAGE":return"unit.player.firemage.04";case"SKIRMISHER":return"unit.player.skirmisher.01";case"HUNTER":return"unit.player.hunter.01";case"NECROMANCER":return"unit.player.necromancer.01";case"ASSASSIN":return"unit.player.assassin.01";default:return"unit.player.vanguard.01"}switch(e.subtype){case"footman":return"unit.enemy.footman.01";case"shield_bearer":return"unit.enemy.shield_bearer.01";case"archer":return"unit.enemy.archer.01";case"warlock":return"unit.enemy.warlock.01";case"bomber":return"unit.enemy.bomber.01";case"bomb":return"unit.enemy.bomb.01";default:return e.enemyType==="boss"?"unit.enemy.boss.01":"unit.enemy.footman.01"}},ty="/Hop",ny=(e,i)=>`${e.endsWith("/")?e:`${e}/`}${i.replace(/^\/+/,"")}`,LA=e=>/^(?:[a-z]+:)?\/\//i.test(e)||e.startsWith("data:")?e:e.startsWith("/")?e.startsWith("/assets/")?ny(ty,e.slice(1)):e:ny(ty,e),IA={"unit.player.vanguard.01":"/assets/units/unit.player.vanguard.01.svg","unit.player.firemage.04":"/assets/units/unit.player.firemage.02.svg","unit.player.skirmisher.01":"/assets/units/unit.player.skirmisher.01.svg","unit.player.hunter.01":"/assets/units/unit.player.skirmisher.01.svg","unit.player.necromancer.01":"/assets/units/unit.player.vanguard.01.svg","unit.player.assassin.01":"/assets/units/unit.player.skirmisher.01.svg","unit.enemy.footman.01":"/assets/units/unit.enemy.footman.01.svg","unit.enemy.shield_bearer.01":"/assets/units/unit.enemy.shield_bearer.01.svg","unit.enemy.archer.01":"/assets/units/unit.enemy.archer.01.svg","unit.enemy.warlock.01":"/assets/units/unit.enemy.warlock.01.svg","unit.enemy.bomber.01":"/assets/units/unit.enemy.bomber.01.svg","unit.enemy.bomb.01":"/assets/units/unit.enemy.bomb.01.svg","unit.enemy.boss.01":"/assets/units/unit.enemy.boss.01.svg"},pf=e=>{const i=zc(e),a=IA[i];return a?LA(a):void 0},BA=e=>{if(e==="impact")return"fx.core.impact.01";if(e==="vaporize")return"fx.core.vaporize.01";if(e==="lava_ripple")return"fx.core.lava_ripple.01";if(e==="explosion_ring")return"fx.core.explosion_ring.01"},jA=()=>"ui.core.hp_frame.01",DA=()=>"decal.combat.blood.01",HA=e=>new Promise(i=>setTimeout(i,e)),PA=e=>{if(!e)return null;const i=e.position||e.destination||e.origin||e.target;return i&&typeof i.q=="number"&&typeof i.r=="number"&&typeof i.s=="number"?i:null},iy=e=>e==="impact"?400:e==="combat_text"?1e3:e==="flash"?300:e==="melee_lunge"?240:e==="arrow_shot"?260:e==="arcane_bolt"?320:e==="spear_trail"?500:e==="vaporize"?600:e==="lava_ripple"?800:e==="explosion_ring"?1e3:2e3,UA=new Set(["impact","flash","combat_text","spear_trail","vaporize","lava_ripple","explosion_ring"]),sy=.72,qA=(e,i,a)=>{const o=String(e||"").toLowerCase(),c=String(i||"").toLowerCase();return c.includes("lava")||c.includes("fire")||c.includes("hazard")||c.includes("burn")||c.includes("crush")||c.includes("collision")||o==="bomber"||c.includes("bomb")||c.includes("explosion")?null:o==="warlock"||c.includes("arcane")||c.includes("force")||c.includes("spell")?"arcane_bolt":o==="archer"||c.includes("arrow")||c.includes("spear_throw")?"arrow_shot":a<=se*2.05||c.includes("basic_attack")||c.includes("melee")?"melee_lunge":null},zA=({visualEvents:e,timelineEvents:i=[],simulationEvents:a=[],actorSnapshots:o=[],onBusyStateChange:c,assetManifest:r})=>{const[f,h]=w.useState([]),b=w.useRef(0),y=w.useRef(0),A=w.useRef(0),v=w.useRef([]),S=w.useRef(!1),[_,p]=w.useState(!1),g=w.useRef(!1),R=w.useRef(new Map),I=w.useRef(null),C=650,M=3500,N=w.useMemo(()=>{const O=new Map;for(const q of r?.assets||[])O.set(q.id,q);return O},[r]),Y=w.useMemo(()=>{const O=new Map;for(const q of o)O.set(q.id,q);return O},[o]);w.useEffect(()=>{if(typeof window>"u"||!window.matchMedia)return;const O=window.matchMedia("(prefers-reduced-motion: reduce)"),q=()=>{g.current=O.matches};return q(),O.addEventListener?.("change",q),()=>O.removeEventListener?.("change",q)},[]),w.useEffect(()=>{if(!e.length)return;const O=new Map(R.current),q=Date.now();for(const K of e){if(K.type!=="kinetic_trace")continue;const ue=K.payload;if(!ue?.actorId)continue;const W=Number(ue.durationMs??0);W>0&&O.set(String(ue.actorId),{durationMs:W,seenAt:q})}R.current=O},[e]),w.useEffect(()=>{c?.(_)},[_,c]);const X=O=>{const q=Date.now(),K=PA(O.payload);if(!K)return;const ue=[],W=`${O.id}:${q}`;O.phase==="HAZARD_CHECK"?ue.push({id:`${W}:haz`,type:"combat_text",position:K,payload:{text:"!"},startTime:q}):O.phase==="DEATH_RESOLVE"&&ue.push({id:`${W}:vapor`,type:"vaporize",position:K,startTime:q}),ue.length>0&&h(_e=>[..._e,...ue])};return w.useEffect(()=>{if(!i.length)return;i.length<b.current&&(b.current=0);const O=i.slice(b.current);O.length&&(b.current=i.length,v.current.push(...O),!S.current&&(S.current=!0,p(!0),(async()=>{try{const q=Date.now();for(;v.current.length>0;){if(Date.now()-q>M){console.warn("[HOP_JUICE] Timeline queue exceeded runtime budget; flushing remaining events.",{queued:v.current.length});break}const K=v.current.shift();X(K);let ue=K.blocking?Math.round((K.suggestedDurationMs??140)*sy):0;if(K.phase==="MOVE_END"){const be=K.payload?.targetActorId;if(be){const pe=R.current.get(be),H=pe?Date.now()-pe.seenAt<=2500:!1;pe&&H&&pe.durationMs>0&&(ue=Math.max(ue,Math.min(C,Math.round(pe.durationMs*sy))))}}let W=0;K.phase==="MOVE_END"?W=Math.min(460,Math.max(70,ue)):K.phase==="DEATH_RESOLVE"?W=Math.min(120,Math.max(55,ue)):K.phase==="DAMAGE_APPLY"?W=Math.min(80,Math.max(35,ue)):K.phase==="HAZARD_CHECK"?W=Math.min(70,Math.max(30,ue)):K.blocking&&(W=Math.min(70,Math.max(0,ue)));const _e=K.phase==="MOVE_END"?ue:g.current?Math.min(70,Math.floor(W*.5)):W,oe=Math.max(0,Math.min(C,_e));oe>0&&await HA(oe)}}catch(q){console.error("[HOP_JUICE] Timeline queue processing failed; releasing busy lock.",q)}finally{v.current=[],S.current=!1,p(!1)}})()))},[i]),w.useEffect(()=>{if(i.length>0){y.current=e.length;return}e.length<y.current&&(y.current=0);const O=y.current;if(O>=e.length)return;const q=e.slice(O);y.current=e.length;const K=[],ue=Date.now();q.forEach((W,_e)=>{const oe=`juice-${ue}-${O+_e}`;W.type==="vfx"&&W.payload?.type==="impact"?W.payload.position&&K.push({id:oe,type:"impact",position:W.payload.position,startTime:ue}):W.type==="vfx"&&W.payload?.type==="flash"?W.payload.position&&K.push({id:oe,type:"flash",position:W.payload.position,startTime:ue}):W.type==="vfx"&&W.payload?.type==="spear_trail"?W.payload.path&&W.payload.path.length>0&&K.push({id:oe,type:"spear_trail",position:W.payload.path[0],payload:W.payload,startTime:ue}):W.type==="vfx"&&W.payload?.type==="vaporize"?W.payload.position&&K.push({id:oe,type:"vaporize",position:W.payload.position,startTime:ue}):W.type==="vfx"&&W.payload?.type==="lava_ripple"?W.payload.position&&K.push({id:oe,type:"lava_ripple",position:W.payload.position,startTime:ue}):W.type==="vfx"&&W.payload?.type==="explosion_ring"&&W.payload.position&&K.push({id:oe,type:"explosion_ring",position:W.payload.position,startTime:ue})}),K.length>0&&h(W=>[...W,...K])},[e,i.length]),w.useEffect(()=>{a.length<A.current&&(A.current=0);const O=A.current;if(O>=a.length)return;const q=a.slice(O);A.current=a.length;const K=Date.now(),ue=[];q.forEach((W,_e)=>{if(W.type!=="DamageTaken"||!W.position)return;const oe=W.position,be=String(W.payload?.sourceId||""),pe=be?Y.get(be):void 0,H=String(W.payload?.reason||"");if(pe?.position){const ee=ut(pe.position,se),ae=ut(oe,se),Te=Math.hypot(ae.x-ee.x,ae.y-ee.y),xe=qA(pe.subtype,H,Te);xe&&ue.push({id:`sim-cue-${K}-${O+_e}`,type:xe,position:oe,payload:{source:pe.position,sourceSubtype:pe.subtype,reason:H},startTime:K})}ue.push({id:`sim-impact-${K}-${O+_e}`,type:"impact",position:oe,startTime:K})}),ue.length>0&&h(W=>[...W,...ue])},[a,Y]),w.useEffect(()=>{if(I.current!==null&&(window.clearTimeout(I.current),I.current=null),f.length===0)return;const O=Date.now();let q=1/0;for(const ue of f){const W=O-ue.startTime,_e=iy(ue.type)-W;_e>0&&_e<q&&(q=_e)}if(!Number.isFinite(q)){h([]);return}const K=Math.max(16,Math.min(180,Math.floor(q)));return I.current=window.setTimeout(()=>{const ue=Date.now();h(W=>{const _e=W.filter(oe=>ue-oe.startTime<iy(oe.type));return _e.length===W.length?W:_e})},K),()=>{I.current!==null&&(window.clearTimeout(I.current),I.current=null)}},[f]),m.jsx("g",{style:{pointerEvents:"none"},children:f.map(O=>{if(!O.position)return null;const{x:q,y:K}=ut(O.position,se),ue=UA.has(O.type)?BA(O.type):void 0,W=ue?N.get(ue)?.path:void 0,_e=N.get(jA())?.path;if(O.type==="melee_lunge"||O.type==="arrow_shot"||O.type==="arcane_bolt"){const oe=O.payload?.source;if(!oe)return null;const be=ut(oe,se),pe=q-be.x,H=K-be.y,ee=Math.max(1,Math.hypot(pe,H)),ae=pe/ee,Te=H/ee,xe=q-ae*Math.min(ee*.18,14),k=K-Te*Math.min(ee*.18,14),$=O.type==="arrow_shot"?7:5,J=q-ae*$-Te*($*.55),me=K-Te*$+ae*($*.55),Me=q-ae*$+Te*($*.55),ke=K-Te*$-ae*($*.55);return O.type==="melee_lunge"?m.jsxs("g",{className:"animate-melee-lunge",children:[m.jsx("line",{x1:be.x,y1:be.y,x2:xe,y2:k,stroke:"rgba(255,255,255,0.35)",strokeWidth:5,strokeLinecap:"round"}),m.jsx("line",{x1:xe,y1:k,x2:q,y2:K,stroke:"rgba(255,255,255,0.85)",strokeWidth:3,strokeLinecap:"round"})]},O.id):O.type==="arrow_shot"?m.jsxs("g",{className:"animate-arrow-shot",children:[m.jsx("line",{x1:be.x,y1:be.y,x2:q,y2:K,stroke:"rgba(253,230,138,0.9)",strokeWidth:2.5,strokeLinecap:"round",strokeDasharray:"10 8"}),m.jsx("path",{d:`M ${q} ${K} L ${J} ${me} M ${q} ${K} L ${Me} ${ke}`,stroke:"rgba(254,243,199,0.95)",strokeWidth:2,strokeLinecap:"round"})]},O.id):m.jsxs("g",{className:"animate-arcane-bolt",children:[m.jsx("line",{x1:be.x,y1:be.y,x2:q,y2:K,stroke:"rgba(34,211,238,0.92)",strokeWidth:4,strokeLinecap:"round",strokeDasharray:"12 10"}),m.jsx("line",{x1:be.x,y1:be.y,x2:q,y2:K,stroke:"rgba(207,250,254,0.85)",strokeWidth:1.8,strokeLinecap:"round"}),m.jsx("circle",{cx:q,cy:K,r:se*.22,fill:"rgba(34,211,238,0.35)"})]},O.id)}if(O.type==="impact")return W?m.jsx("image",{href:W,x:q-se*.75,y:K-se*.75,width:se*1.5,height:se*1.5,preserveAspectRatio:"xMidYMid meet",className:"animate-impact",opacity:"0.9"},O.id):m.jsx("circle",{cx:q,cy:K,r:se*.5,fill:"none",stroke:"#ffffff",strokeWidth:"2",className:"animate-impact"},O.id);if(O.type==="combat_text"){const oe=O.payload.text.startsWith("-")?"#fb7185":"#86efac";return m.jsxs("g",{transform:`translate(${q}, ${K-10})`,children:[_e&&m.jsx("image",{href:_e,x:-46,y:-24,width:92,height:24,preserveAspectRatio:"xMidYMid meet",opacity:"0.78"}),m.jsx("text",{textAnchor:"middle",fill:oe,fontSize:"16",fontWeight:"black",className:"animate-float-up",style:{filter:"drop-shadow(0 2px 4px rgba(0,0,0,0.8))",paintOrder:"stroke",stroke:"#000",strokeWidth:"4px"},children:O.payload.text})]},O.id)}if(O.type==="flash")return m.jsx("circle",{cx:q,cy:K,r:se*2,fill:"#ffffff",className:"animate-flash"},O.id);if(O.type==="spear_trail"){const be=O.payload.path.map(pe=>{const H=ut(pe,se);return`${H.x},${H.y}`}).join(" ");return m.jsx("polyline",{points:be,fill:"none",stroke:"#ffffff",strokeWidth:"4",strokeLinecap:"round",className:"animate-spear-trail"},O.id)}return O.type==="vaporize"?W?m.jsx("image",{href:W,x:q-se*.95,y:K-se*.95,width:se*1.9,height:se*1.9,preserveAspectRatio:"xMidYMid meet",className:"animate-vaporize",opacity:"0.9"},O.id):m.jsxs("g",{children:[m.jsx("circle",{cx:q,cy:K,r:se*.6,fill:"#f97316",className:"animate-vaporize",opacity:"0.8"}),m.jsx("circle",{cx:q,cy:K,r:se*1.2,fill:"none",stroke:"#f97316",strokeWidth:"2",className:"animate-ping"})]},O.id):O.type==="lava_ripple"?W?m.jsx("image",{href:W,x:q-se,y:K-se,width:se*2,height:se*2,preserveAspectRatio:"xMidYMid meet",className:"animate-ping",opacity:"0.85"},O.id):m.jsx("circle",{cx:q,cy:K,r:se*.8,fill:"none",stroke:"#ea580c",strokeWidth:"3",className:"animate-ping"},O.id):O.type==="explosion_ring"?W?m.jsx("image",{href:W,x:q-se*1.35,y:K-se*1.35,width:se*2.7,height:se*2.7,preserveAspectRatio:"xMidYMid meet",className:"animate-explosion-ring",opacity:"0.88"},O.id):m.jsx("circle",{cx:q,cy:K,r:se*2.5,fill:"rgba(255, 120, 0, 0.2)",stroke:"#ffaa00",strokeWidth:"4",className:"animate-explosion-ring"},O.id):null})})},Nf="/Hop",t0=/^[a-z0-9]+(?:[._-][a-z0-9]+)*$/,lr=/^\/assets\/[a-z0-9/_\-.]+$/,Pf=["ground","decal","prop","unit","fx","ui"],$A=["svg","webp","avif","png","jpg","jpeg"],ay=["svg","webp","avif","png"],oy=["svg","webp","avif","png","jpg","jpeg"],ly=["svg","webp","avif","png"],ry=["svg"],Rf=(e,i)=>`${e.endsWith("/")?e:`${e}/`}${i.replace(/^\/+/,"")}`,VA=Rf(Nf,"assets/manifest.json"),Ka=e=>/^(?:[a-z]+:)?\/\//i.test(e)||e.startsWith("data:")?e:e.startsWith("/")?e.startsWith("/assets/")?Rf(Nf,e.slice(1)):e:Rf(Nf,e),qo=e=>{if(e)return{...e,default:Ka(e.default),themes:Object.fromEntries(Object.entries(e.themes||{}).map(([i,a])=>[i,Ka(a)]))}},cy=e=>{if(e)return{...e,scale:e.scale??e.mountainScale,offsetX:e.offsetX??e.mountainOffsetX,offsetY:e.offsetY??e.mountainOffsetY,anchorX:e.anchorX??e.mountainAnchorX,anchorY:e.anchorY??e.mountainAnchorY,crustBlendMode:e.crustBlendMode??e.mountainCrustBlendMode,crustBlendOpacity:e.crustBlendOpacity??e.mountainCrustBlendOpacity,tintColor:e.tintColor??e.mountainTintColor,tintBlendMode:e.tintBlendMode??e.mountainTintBlendMode,tintOpacity:e.tintOpacity??e.mountainTintOpacity}},YA=e=>{if(e)return{...e,themes:Object.fromEntries(Object.entries(e.themes||{}).map(([i,a])=>[i,String(a)]))}},Fc=e=>{if(e)return{detailA:qo(e.detailA),detailB:qo(e.detailB),tint:YA(e.tint)}},kf=e=>{if(e)return{...e}},n0=e=>{if(!e)return;const i=cy(e);return{...i,mountainPath:i?.mountainPath?Ka(i.mountainPath):i?.mountainPath,themes:Object.fromEntries(Object.entries(e.themes||{}).map(([a,o])=>[a,{...cy(o),mountainPath:o?.mountainPath?Ka(o.mountainPath):o?.mountainPath}]))}},FA=e=>{if(e)return{...e,biomeLayers:e.biomeLayers?{undercurrent:qo(e.biomeLayers.undercurrent),crust:qo(e.biomeLayers.crust),clutter:e.biomeLayers.clutter?{...e.biomeLayers.clutter,tags:[...e.biomeLayers.clutter.tags||[]]}:void 0}:void 0,biomeMaterials:e.biomeMaterials?{undercurrent:Fc(e.biomeMaterials.undercurrent),crust:Fc(e.biomeMaterials.crust)}:void 0,walls:n0(e.walls),assetOverrides:Object.fromEntries(Object.entries(e.assetOverrides||{}).map(([i,a])=>[i,{...a,mountainSettings:kf(a?.mountainSettings)}]))}},KA=e=>({...e,biomeUnderlay:e.biomeUnderlay?{...e.biomeUnderlay,default:Ka(e.biomeUnderlay.default),themes:Object.fromEntries(Object.entries(e.biomeUnderlay.themes||{}).map(([i,a])=>[i,Ka(a)]))}:void 0,biomeLayers:e.biomeLayers?{undercurrent:qo(e.biomeLayers.undercurrent),crust:qo(e.biomeLayers.crust),clutter:e.biomeLayers.clutter?{...e.biomeLayers.clutter,tags:[...e.biomeLayers.clutter.tags||[]]}:void 0}:void 0,biomeMaterials:e.biomeMaterials?{undercurrent:Fc(e.biomeMaterials.undercurrent),crust:Fc(e.biomeMaterials.crust)}:void 0,walls:n0(e.walls),biomePresets:Object.fromEntries(Object.entries(e.biomePresets||{}).map(([i,a])=>[i,FA(a)||{}])),assets:e.assets.map(i=>({...i,path:Ka(i.path),mountainSettings:kf(i.mountainSettings),mountainSettingsByTheme:Object.fromEntries(Object.entries(i.mountainSettingsByTheme||{}).map(([a,o])=>[a,kf(o)||{}]))}))}),uy={version:"1.0.0",gridTopology:"flat-top-hex",tileUnitPx:256,tileAspectRatio:1.154700538,layers:[...Pf],assets:[]};let Rc=null;const dy=e=>typeof e=="string"&&Pf.includes(e),fy=e=>typeof e=="string"&&["tile","decal","prop","unit","fx","ui"].includes(e),my=e=>typeof e=="string"&&$A.includes(e),Ga=(e,i,a)=>{if(!e||typeof e!="object"){a.push(`"${i}" must be an object when provided.`);return}if((typeof e.default!="string"||!lr.test(e.default))&&a.push(`"${i}.default" must be a /assets/... path.`),e.themes!==void 0)if(!e.themes||typeof e.themes!="object")a.push(`"${i}.themes" must be an object when provided.`);else for(const[o,c]of Object.entries(e.themes))(typeof o!="string"||o.trim().length===0)&&a.push(`"${i}.themes" contains an invalid theme key.`),(typeof c!="string"||!lr.test(c))&&a.push(`"${i}.themes.${o}" must be a /assets/... path.`);if(e.mode!==void 0&&e.mode!=="off"&&e.mode!=="cover"&&e.mode!=="repeat"&&a.push(`"${i}.mode" must be one of "off", "cover", or "repeat".`),e.scalePx!==void 0&&(!Number.isFinite(e.scalePx)||Number(e.scalePx)<=0)&&a.push(`"${i}.scalePx" must be > 0 when provided.`),e.opacity!==void 0&&(!Number.isFinite(e.opacity)||Number(e.opacity)<0||Number(e.opacity)>1)&&a.push(`"${i}.opacity" must be in [0, 1] when provided.`),e.seedShiftPx!==void 0&&(!Number.isFinite(e.seedShiftPx)||Number(e.seedShiftPx)<0)&&a.push(`"${i}.seedShiftPx" must be >= 0 when provided.`),e.offsetX!==void 0&&!Number.isFinite(e.offsetX)&&a.push(`"${i}.offsetX" must be a finite number when provided.`),e.offsetY!==void 0&&!Number.isFinite(e.offsetY)&&a.push(`"${i}.offsetY" must be a finite number when provided.`),e.scroll!==void 0){const o=e.scroll;!o||typeof o!="object"?a.push(`"${i}.scroll" must be an object when provided.`):(o.x!==void 0&&!Number.isFinite(o.x)&&a.push(`"${i}.scroll.x" must be a finite number.`),o.y!==void 0&&!Number.isFinite(o.y)&&a.push(`"${i}.scroll.y" must be a finite number.`),o.durationMs!==void 0&&(!Number.isFinite(o.durationMs)||Number(o.durationMs)<=0)&&a.push(`"${i}.scroll.durationMs" must be > 0 when provided.`))}},GA=(e,i,a)=>{if(!e||typeof e!="object"){a.push(`"${i}" must be an object when provided.`);return}if((typeof e.default!="string"||e.default.trim().length===0)&&a.push(`"${i}.default" must be a non-empty color string.`),e.themes!==void 0)if(!e.themes||typeof e.themes!="object")a.push(`"${i}.themes" must be an object when provided.`);else for(const[o,c]of Object.entries(e.themes))(typeof o!="string"||o.trim().length===0)&&a.push(`"${i}.themes" contains an invalid theme key.`),(typeof c!="string"||c.trim().length===0)&&a.push(`"${i}.themes.${o}" must be a non-empty color string.`);e.opacity!==void 0&&(!Number.isFinite(e.opacity)||Number(e.opacity)<0||Number(e.opacity)>1)&&a.push(`"${i}.opacity" must be in [0, 1] when provided.`),e.blendMode!==void 0&&e.blendMode!=="normal"&&e.blendMode!=="multiply"&&e.blendMode!=="overlay"&&e.blendMode!=="soft-light"&&e.blendMode!=="screen"&&e.blendMode!=="color-dodge"&&a.push(`"${i}.blendMode" must be one of "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`)},rr=(e,i,a)=>{if(!e||typeof e!="object"){a.push(`"${i}" must be an object when provided.`);return}e.scale!==void 0&&(!Number.isFinite(e.scale)||Number(e.scale)<=0)&&a.push(`"${i}.scale" must be > 0 when provided.`),e.offsetX!==void 0&&!Number.isFinite(e.offsetX)&&a.push(`"${i}.offsetX" must be a finite number when provided.`),e.offsetY!==void 0&&!Number.isFinite(e.offsetY)&&a.push(`"${i}.offsetY" must be a finite number when provided.`),e.anchorX!==void 0&&(!Number.isFinite(e.anchorX)||Number(e.anchorX)<0||Number(e.anchorX)>1)&&a.push(`"${i}.anchorX" must be in [0, 1] when provided.`),e.anchorY!==void 0&&(!Number.isFinite(e.anchorY)||Number(e.anchorY)<0||Number(e.anchorY)>1)&&a.push(`"${i}.anchorY" must be in [0, 1] when provided.`),e.crustBlendMode!==void 0&&e.crustBlendMode!=="off"&&e.crustBlendMode!=="normal"&&e.crustBlendMode!=="multiply"&&e.crustBlendMode!=="overlay"&&e.crustBlendMode!=="soft-light"&&e.crustBlendMode!=="screen"&&e.crustBlendMode!=="color-dodge"&&a.push(`"${i}.crustBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.tintBlendMode!==void 0&&e.tintBlendMode!=="off"&&e.tintBlendMode!=="normal"&&e.tintBlendMode!=="multiply"&&e.tintBlendMode!=="overlay"&&e.tintBlendMode!=="soft-light"&&e.tintBlendMode!=="screen"&&e.tintBlendMode!=="color-dodge"&&a.push(`"${i}.tintBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.crustBlendOpacity!==void 0&&(!Number.isFinite(e.crustBlendOpacity)||Number(e.crustBlendOpacity)<0||Number(e.crustBlendOpacity)>1)&&a.push(`"${i}.crustBlendOpacity" must be in [0, 1] when provided.`),e.tintOpacity!==void 0&&(!Number.isFinite(e.tintOpacity)||Number(e.tintOpacity)<0||Number(e.tintOpacity)>1)&&a.push(`"${i}.tintOpacity" must be in [0, 1] when provided.`),e.tintColor!==void 0&&(typeof e.tintColor!="string"||e.tintColor.trim().length===0)&&a.push(`"${i}.tintColor" must be a non-empty color string when provided.`)},i0=(e,i,a)=>{if(!e||typeof e!="object"){a.push(`"${i}" must be an object when provided.`);return}if(e.mode!==void 0&&e.mode!=="native"&&e.mode!=="additive"&&e.mode!=="custom"&&a.push(`"${i}.mode" must be one of "native", "additive", or "custom".`),e.interiorDensity!==void 0&&(!Number.isFinite(e.interiorDensity)||Number(e.interiorDensity)<0||Number(e.interiorDensity)>1)&&a.push(`"${i}.interiorDensity" must be in [0, 1] when provided.`),e.clusterBias!==void 0&&(!Number.isFinite(e.clusterBias)||Number(e.clusterBias)<0||Number(e.clusterBias)>1)&&a.push(`"${i}.clusterBias" must be in [0, 1] when provided.`),e.keepPerimeter!==void 0&&typeof e.keepPerimeter!="boolean"&&a.push(`"${i}.keepPerimeter" must be a boolean when provided.`),e.mountainPath!==void 0&&(typeof e.mountainPath!="string"||!lr.test(e.mountainPath))&&a.push(`"${i}.mountainPath" must be a /assets/... path when provided.`),e.mountainScale!==void 0&&(!Number.isFinite(e.mountainScale)||Number(e.mountainScale)<=0)&&a.push(`"${i}.mountainScale" must be > 0 when provided.`),e.mountainOffsetX!==void 0&&!Number.isFinite(e.mountainOffsetX)&&a.push(`"${i}.mountainOffsetX" must be a finite number when provided.`),e.mountainOffsetY!==void 0&&!Number.isFinite(e.mountainOffsetY)&&a.push(`"${i}.mountainOffsetY" must be a finite number when provided.`),e.mountainAnchorX!==void 0&&(!Number.isFinite(e.mountainAnchorX)||Number(e.mountainAnchorX)<0||Number(e.mountainAnchorX)>1)&&a.push(`"${i}.mountainAnchorX" must be in [0, 1] when provided.`),e.mountainAnchorY!==void 0&&(!Number.isFinite(e.mountainAnchorY)||Number(e.mountainAnchorY)<0||Number(e.mountainAnchorY)>1)&&a.push(`"${i}.mountainAnchorY" must be in [0, 1] when provided.`),e.mountainCrustBlendMode!==void 0&&e.mountainCrustBlendMode!=="off"&&e.mountainCrustBlendMode!=="normal"&&e.mountainCrustBlendMode!=="multiply"&&e.mountainCrustBlendMode!=="overlay"&&e.mountainCrustBlendMode!=="soft-light"&&e.mountainCrustBlendMode!=="screen"&&e.mountainCrustBlendMode!=="color-dodge"&&a.push(`"${i}.mountainCrustBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.mountainCrustBlendOpacity!==void 0&&(!Number.isFinite(e.mountainCrustBlendOpacity)||Number(e.mountainCrustBlendOpacity)<0||Number(e.mountainCrustBlendOpacity)>1)&&a.push(`"${i}.mountainCrustBlendOpacity" must be in [0, 1] when provided.`),e.mountainTintColor!==void 0&&(typeof e.mountainTintColor!="string"||e.mountainTintColor.trim().length===0)&&a.push(`"${i}.mountainTintColor" must be a non-empty color string when provided.`),e.mountainTintBlendMode!==void 0&&e.mountainTintBlendMode!=="off"&&e.mountainTintBlendMode!=="normal"&&e.mountainTintBlendMode!=="multiply"&&e.mountainTintBlendMode!=="overlay"&&e.mountainTintBlendMode!=="soft-light"&&e.mountainTintBlendMode!=="screen"&&e.mountainTintBlendMode!=="color-dodge"&&a.push(`"${i}.mountainTintBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),e.mountainTintOpacity!==void 0&&(!Number.isFinite(e.mountainTintOpacity)||Number(e.mountainTintOpacity)<0||Number(e.mountainTintOpacity)>1)&&a.push(`"${i}.mountainTintOpacity" must be in [0, 1] when provided.`),rr(e,i,a),e.themes!==void 0)if(!e.themes||typeof e.themes!="object")a.push(`"${i}.themes" must be an object when provided.`);else for(const[o,c]of Object.entries(e.themes)){if(typeof o!="string"||o.trim().length===0){a.push(`"${i}.themes" contains an invalid theme key.`);continue}if(!c||typeof c!="object"){a.push(`"${i}.themes.${o}" must be an object.`);continue}c.mountainPath!==void 0&&(typeof c.mountainPath!="string"||!lr.test(c.mountainPath))&&a.push(`"${i}.themes.${o}.mountainPath" must be a /assets/... path when provided.`);const r=c;r.mountainScale!==void 0&&(!Number.isFinite(r.mountainScale)||Number(r.mountainScale)<=0)&&a.push(`"${i}.themes.${o}.mountainScale" must be > 0 when provided.`),r.mountainOffsetX!==void 0&&!Number.isFinite(r.mountainOffsetX)&&a.push(`"${i}.themes.${o}.mountainOffsetX" must be a finite number when provided.`),r.mountainOffsetY!==void 0&&!Number.isFinite(r.mountainOffsetY)&&a.push(`"${i}.themes.${o}.mountainOffsetY" must be a finite number when provided.`),r.mountainAnchorX!==void 0&&(!Number.isFinite(r.mountainAnchorX)||Number(r.mountainAnchorX)<0||Number(r.mountainAnchorX)>1)&&a.push(`"${i}.themes.${o}.mountainAnchorX" must be in [0, 1] when provided.`),r.mountainAnchorY!==void 0&&(!Number.isFinite(r.mountainAnchorY)||Number(r.mountainAnchorY)<0||Number(r.mountainAnchorY)>1)&&a.push(`"${i}.themes.${o}.mountainAnchorY" must be in [0, 1] when provided.`),r.mountainCrustBlendMode!==void 0&&r.mountainCrustBlendMode!=="off"&&r.mountainCrustBlendMode!=="normal"&&r.mountainCrustBlendMode!=="multiply"&&r.mountainCrustBlendMode!=="overlay"&&r.mountainCrustBlendMode!=="soft-light"&&r.mountainCrustBlendMode!=="screen"&&r.mountainCrustBlendMode!=="color-dodge"&&a.push(`"${i}.themes.${o}.mountainCrustBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),r.mountainCrustBlendOpacity!==void 0&&(!Number.isFinite(r.mountainCrustBlendOpacity)||Number(r.mountainCrustBlendOpacity)<0||Number(r.mountainCrustBlendOpacity)>1)&&a.push(`"${i}.themes.${o}.mountainCrustBlendOpacity" must be in [0, 1] when provided.`),r.mountainTintBlendMode!==void 0&&r.mountainTintBlendMode!=="off"&&r.mountainTintBlendMode!=="normal"&&r.mountainTintBlendMode!=="multiply"&&r.mountainTintBlendMode!=="overlay"&&r.mountainTintBlendMode!=="soft-light"&&r.mountainTintBlendMode!=="screen"&&r.mountainTintBlendMode!=="color-dodge"&&a.push(`"${i}.themes.${o}.mountainTintBlendMode" must be one of "off", "normal", "multiply", "overlay", "soft-light", "screen", "color-dodge".`),r.mountainTintOpacity!==void 0&&(!Number.isFinite(r.mountainTintOpacity)||Number(r.mountainTintOpacity)<0||Number(r.mountainTintOpacity)>1)&&a.push(`"${i}.themes.${o}.mountainTintOpacity" must be in [0, 1] when provided.`),r.mountainTintColor!==void 0&&(typeof r.mountainTintColor!="string"||r.mountainTintColor.trim().length===0)&&a.push(`"${i}.themes.${o}.mountainTintColor" must be a non-empty color string when provided.`),rr(c,`${i}.themes.${o}`,a)}},Kc=(e,i,a)=>{if(!e||typeof e!="object"){a.push(`"${i}" must be an object when provided.`);return}e.detailA!==void 0&&Ga(e.detailA,`${i}.detailA`,a),e.detailB!==void 0&&Ga(e.detailB,`${i}.detailB`,a),e.tint!==void 0&&GA(e.tint,`${i}.tint`,a),e.detailA===void 0&&e.detailB===void 0&&e.tint===void 0&&a.push(`"${i}" must define at least one of "detailA", "detailB", or "tint".`)},WA=(e,i,a)=>{if(!e||typeof e!="object"){a.push(`"${i}" must be an object when provided.`);return}if(e.seed!==void 0&&(typeof e.seed!="string"||e.seed.trim().length===0)&&a.push(`"${i}.seed" must be a non-empty string when provided.`),e.injectHazards!==void 0&&typeof e.injectHazards!="boolean"&&a.push(`"${i}.injectHazards" must be a boolean when provided.`),e.biomeLayers!==void 0){const o=e.biomeLayers;if(!o||typeof o!="object")a.push(`"${i}.biomeLayers" must be an object when provided.`);else if(o.undercurrent!==void 0&&Ga(o.undercurrent,`${i}.biomeLayers.undercurrent`,a),o.crust!==void 0&&Ga(o.crust,`${i}.biomeLayers.crust`,a),o.clutter!==void 0){const c=o.clutter;!c||typeof c!="object"?a.push(`"${i}.biomeLayers.clutter" must be an object when provided.`):(c.density!==void 0&&(!Number.isFinite(c.density)||Number(c.density)<0||Number(c.density)>1)&&a.push(`"${i}.biomeLayers.clutter.density" must be in [0, 1] when provided.`),c.maxPerHex!==void 0&&(!Number.isFinite(c.maxPerHex)||Number(c.maxPerHex)<0)&&a.push(`"${i}.biomeLayers.clutter.maxPerHex" must be >= 0 when provided.`),c.bleedScaleMax!==void 0&&(!Number.isFinite(c.bleedScaleMax)||Number(c.bleedScaleMax)<1||Number(c.bleedScaleMax)>2)&&a.push(`"${i}.biomeLayers.clutter.bleedScaleMax" must be within [1, 2] when provided.`),c.tags!==void 0&&(!Array.isArray(c.tags)||!c.tags.every(r=>typeof r=="string"&&r.length>0))&&a.push(`"${i}.biomeLayers.clutter.tags" must be a string array when provided.`))}}if(e.biomeMaterials!==void 0){const o=e.biomeMaterials;!o||typeof o!="object"?a.push(`"${i}.biomeMaterials" must be an object when provided.`):(o.undercurrent!==void 0&&Kc(o.undercurrent,`${i}.biomeMaterials.undercurrent`,a),o.crust!==void 0&&Kc(o.crust,`${i}.biomeMaterials.crust`,a))}if(e.walls!==void 0&&i0(e.walls,`${i}.walls`,a),e.assetOverrides!==void 0)if(!e.assetOverrides||typeof e.assetOverrides!="object")a.push(`"${i}.assetOverrides" must be an object when provided.`);else for(const[o,c]of Object.entries(e.assetOverrides)){if(!t0.test(o)){a.push(`"${i}.assetOverrides" contains invalid asset id "${o}".`);continue}if(!c||typeof c!="object"){a.push(`"${i}.assetOverrides.${o}" must be an object.`);continue}c.mountainSettings!==void 0&&rr(c.mountainSettings,`${i}.assetOverrides.${o}.mountainSettings`,a)}},XA=e=>{const i=[];if(!e||typeof e!="object")return{valid:!1,errors:["Manifest is not an object."]};const a=e;if((typeof a.version!="string"||a.version.length===0)&&i.push('Missing or invalid "version".'),a.gridTopology!=="flat-top-hex"&&i.push('Only "flat-top-hex" gridTopology is supported.'),(!Number.isFinite(a.tileUnitPx)||Number(a.tileUnitPx)<=0)&&i.push('Missing or invalid "tileUnitPx".'),(!Number.isFinite(a.tileAspectRatio)||Number(a.tileAspectRatio)<=0)&&i.push('Missing or invalid "tileAspectRatio".'),a.biomeUnderlay!==void 0&&Ga(a.biomeUnderlay,"biomeUnderlay",i),a.biomeLayers!==void 0){const c=a.biomeLayers;if(!c||typeof c!="object")i.push('"biomeLayers" must be an object when provided.');else if(c.undercurrent!==void 0&&Ga(c.undercurrent,"biomeLayers.undercurrent",i),c.crust!==void 0&&Ga(c.crust,"biomeLayers.crust",i),!c.undercurrent&&!c.crust&&i.push('"biomeLayers" must define at least one of "undercurrent" or "crust".'),c.clutter!==void 0){const r=c.clutter;!r||typeof r!="object"?i.push('"biomeLayers.clutter" must be an object when provided.'):(r.density!==void 0&&(!Number.isFinite(r.density)||Number(r.density)<0||Number(r.density)>1)&&i.push('"biomeLayers.clutter.density" must be in [0, 1] when provided.'),r.maxPerHex!==void 0&&(!Number.isFinite(r.maxPerHex)||Number(r.maxPerHex)<0)&&i.push('"biomeLayers.clutter.maxPerHex" must be >= 0 when provided.'),r.bleedScaleMax!==void 0&&(!Number.isFinite(r.bleedScaleMax)||Number(r.bleedScaleMax)<1||Number(r.bleedScaleMax)>2)&&i.push('"biomeLayers.clutter.bleedScaleMax" must be within [1, 2] when provided.'),r.tags!==void 0&&(!Array.isArray(r.tags)||!r.tags.every(f=>typeof f=="string"&&f.length>0))&&i.push('"biomeLayers.clutter.tags" must be a string array when provided.'))}}if(a.biomeMaterials!==void 0){const c=a.biomeMaterials;!c||typeof c!="object"?i.push('"biomeMaterials" must be an object when provided.'):(c.undercurrent!==void 0&&Kc(c.undercurrent,"biomeMaterials.undercurrent",i),c.crust!==void 0&&Kc(c.crust,"biomeMaterials.crust",i),c.undercurrent===void 0&&c.crust===void 0&&i.push('"biomeMaterials" must define at least one of "undercurrent" or "crust".'))}if(a.walls!==void 0&&i0(a.walls,"walls",i),a.biomePresets!==void 0)if(!a.biomePresets||typeof a.biomePresets!="object")i.push('"biomePresets" must be an object when provided.');else for(const[c,r]of Object.entries(a.biomePresets)){if(typeof c!="string"||c.trim().length===0){i.push('"biomePresets" contains an invalid theme key.');continue}WA(r,`biomePresets.${c}`,i)}if(!Array.isArray(a.layers)||a.layers.length===0||!a.layers.every(dy))i.push('Missing or invalid "layers".');else for(const c of Pf)a.layers.includes(c)||i.push(`Missing required layer "${c}" in "layers".`);if(!Array.isArray(a.assets))return i.push('Missing or invalid "assets".'),{valid:i.length===0,errors:i};const o=new Set;for(const[c,r]of a.assets.entries()){const f=`assets[${c}]`;if(!r||typeof r!="object"){i.push(`${f} is not an object.`);continue}const h=r;if(typeof h.id!="string"||!t0.test(h.id)?i.push(`${f}.id is invalid; expected lowercase tokenized id.`):o.has(h.id)?i.push(`${f}.id is duplicated (${h.id}).`):o.add(h.id),fy(h.type)||i.push(`${f}.type is invalid.`),dy(h.layer)||i.push(`${f}.layer is invalid.`),my(h.recommendedFormat)||i.push(`${f}.recommendedFormat is invalid.`),fy(h.type)&&my(h.recommendedFormat)&&((h.type==="tile"||h.type==="decal"||h.type==="prop")&&!oy.includes(h.recommendedFormat)&&i.push(`${f}.recommendedFormat must be one of ${oy.join(", ")} for ${h.type}.`),h.type==="ui"&&!ry.includes(h.recommendedFormat)&&i.push(`${f}.recommendedFormat must be one of ${ry.join(", ")} for ui.`),h.type==="unit"&&!ay.includes(h.recommendedFormat)&&i.push(`${f}.recommendedFormat must be one of ${ay.join(", ")} for units.`),h.type==="fx"&&!ly.includes(h.recommendedFormat)&&i.push(`${f}.recommendedFormat must be one of ${ly.join(", ")} for fx.`)),(typeof h.path!="string"||!lr.test(h.path))&&i.push(`${f}.path is invalid; expected /assets/...`),(!Number.isFinite(h.width)||Number(h.width)<=0)&&i.push(`${f}.width must be > 0.`),(!Number.isFinite(h.height)||Number(h.height)<=0)&&i.push(`${f}.height must be > 0.`),h.mountainSettings!==void 0&&rr(h.mountainSettings,`${f}.mountainSettings`,i),h.mountainSettingsByTheme!==void 0)if(!h.mountainSettingsByTheme||typeof h.mountainSettingsByTheme!="object")i.push(`${f}.mountainSettingsByTheme must be an object when provided.`);else for(const[b,y]of Object.entries(h.mountainSettingsByTheme)){if(typeof b!="string"||b.trim().length===0){i.push(`${f}.mountainSettingsByTheme contains an invalid theme key.`);continue}rr(y,`${f}.mountainSettingsByTheme.${b}`,i)}}return{valid:i.length===0,errors:i}},QA=async()=>Rc||(Rc=fetch(VA).then(async e=>{if(!e.ok)throw new Error(`Asset manifest fetch failed: ${e.status}`);return e.json()}).then(e=>{const i=XA(e);return i.valid?KA(e):(console.warn("[HOP_ASSETS] Invalid manifest; using fallback.",i.errors),uy)}).catch(e=>(console.warn("[HOP_ASSETS] Failed to load manifest; using fallback.",e),uy)),Rc),Uf=(e,i)=>{if(!e)return;const a=String(i||"").toLowerCase();if(a)return e.biomePresets?.[a]},JA=[7,11],py=(e,i,a)=>e<i?i:e>a?a:e,ZA=e=>({top:Math.max(0,Number(e?.top??0)),right:Math.max(0,Number(e?.right??0)),bottom:Math.max(0,Number(e?.bottom??0)),left:Math.max(0,Number(e?.left??0))}),qf=e=>{const i=ZA(e.insets),a=Math.max(1,Number(e.width||0)-i.left-i.right),o=Math.max(1,Number(e.height||0)-i.top-i.bottom);return{width:a,height:o,insets:i}},eT=(e,i,a=0)=>{const o=Math.max(1,i),c=1.5*o,r=2*o;return(Math.max(1,e)-1)*c+r+Math.max(0,a)*2},tT=(e,i,a,o=0)=>{const c=qf(e),r=eT(i,a,o);return c.width/Math.max(1,r)},nT=(e,i)=>{const a=qf(e),o=Math.max(1,i.width),c=Math.max(1,i.height);return Math.min(a.width/o,a.height/c)},iT=(e,i)=>({x:e.x-i,y:e.y-i,width:e.width+i*2,height:e.height+i*2}),sT=(e,i)=>{const a=Math.max(1e-6,e),o=Math.max(1e-6,i);return Math.max(a,o)},hy=(e,i)=>{const a=qf(e),o=Math.max(1e-6,i);return{width:a.width/o,height:a.height/o}},aT=(e,i,a)=>{const o=i.width/2,c=i.height/2,r=a.x+o,f=a.x+a.width-o,h=a.y+c,b=a.y+a.height-c;return{x:r>f?a.x+a.width/2:py(e.x,r,f),y:h>b?a.y+a.height/2:py(e.y,h,b)}},gy=(e,i)=>({x:e.x-i.width/2,y:e.y-i.height/2,width:i.width,height:i.height}),$c=e=>{let i=2166136261;for(let a=0;a<e.length;a++)i^=e.charCodeAt(a),i=Math.imul(i,16777619);return i>>>0},Gl=e=>$c(e)/4294967295,oT=e=>{const i=(e.tags||[]).map(o=>o.toLowerCase()),a=[e.id.toLowerCase(),...i];for(const o of a){const c=o.match(/(?:cluster|hex)[-_]?([123])\b/);if(c)return Number(c[1]);if(o.includes("1-hex")||o.includes("single"))return 1;if(o.includes("2-hex")||o.includes("double"))return 2;if(o.includes("3-hex")||o.includes("triple"))return 3}return 1},kc=(e,i)=>{if(e)return i&&e.themes?.[i]?e.themes[i]:e.default},Lc=e=>e?e.mode==="cover"||e.mode==="repeat"||e.mode==="off"?e.mode:"cover":"off",hf=e=>Math.min(1,Math.max(0,Number(e?.opacity??1))),Ic=(e,i,a=64,o=Number.POSITIVE_INFINITY)=>{const c=Number(e?.scalePx||i);return Math.min(o,Math.max(a,c))},yy=e=>({x:Number(e?.scroll?.x??0),y:Number(e?.scroll?.y??0),durationMs:Math.max(1e3,Number(e?.scroll?.durationMs??18e3))}),lT=(e,i)=>{if(e)return i&&e.themes?.[i]?e.themes[i]:e.default},rT=e=>Math.min(1,Math.max(0,Number(e?.opacity??0))),s0=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",a0=(e,i="#8b6f4a")=>{const a=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(a))return a.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(a)){const[r,f,h]=a.slice(1).split("");return`#${r}${r}${f}${f}${h}${h}`.toLowerCase()}return i},cT=e=>{const a=a0(e).slice(1);return{r:parseInt(a.slice(0,2),16)/255,g:parseInt(a.slice(2,4),16)/255,b:parseInt(a.slice(4,6),16)/255}},uT=e=>e.replace(/[^a-zA-Z0-9_-]/g,"-"),by=(e,i)=>e==="off"?"off":e?s0(e):i,gf=e=>{const i=[];for(let a=0;a<6;a++){const o=Math.PI/180*(60*a);i.push(`${e*Math.cos(o)},${e*Math.sin(o)}`)}return i.join(" ")},o0=({gameState:e,onMove:i,selectedSkillId:a,showMovementRange:o,onBusyStateChange:c,assetManifest:r,biomeDebug:f,onSimulationEvents:h,onMirrorSnapshot:b,enginePreviewGhost:y,cameraSafeInsetsPx:A})=>{const[v,S]=w.useState(!1),[_,p]=w.useState(null),[g,R]=w.useState(!1),[I,C]=w.useState(!1),[M,N]=w.useState([]),[Y,X]=w.useState(11),[O,q]=w.useState({width:0,height:0}),[K,ue]=w.useState(!1),W=w.useRef(null),_e=w.useRef(null),oe=w.useRef([]),be=w.useRef(!1),pe=w.useRef([]),H=w.useRef(0),ee=w.useRef(""),ae=w.useRef(0),Te=w.useRef(0),xe=w.useRef(0),k=w.useRef(null),$=w.useRef(null),J=w.useRef({x:0,y:0}),me=w.useRef(!1),Me=w.useRef(!1),ke=w.useRef(0),Ie=w.useRef(new Map),pt=w.useRef({activePointerId:null,startClient:null,lastWorld:null,didPan:!1}),ze=w.useRef(null),Rt=w.useRef(null),qn=w.useRef(null),St=w.useRef(!1),Gt=w.useRef(""),_t=w.useRef(""),zn=w.useRef(11),ai=w.useRef(!1),Ve=e.player.position,De=w.useMemo(()=>{let E=e.rooms?.[0]?.hexes;if(!E||E.length===0){E=[];for(let B=0;B<e.gridWidth;B++)for(let z=0;z<e.gridHeight;z++)E.push({q:B,r:z,s:-B-z})}return E.filter(B=>Vc(B.q,B.r,e.gridWidth,e.gridHeight))},[e.rooms,e.gridWidth,e.gridHeight]);w.useEffect(()=>{if(e.visualEvents?.find(B=>B.type==="shake")){S(!0);const B=setTimeout(()=>S(!1),200);return()=>clearTimeout(B)}},[e.visualEvents]);const Ne=w.useMemo(()=>{if(De.length===0)return{minX:0,minY:0,width:100,height:100};let E=1/0,B=1/0,z=-1/0,le=-1/0;return De.forEach(re=>{const{x:fe,y:ye}=ut(re,se);E=Math.min(E,fe-se),B=Math.min(B,ye-se),z=Math.max(z,fe+se),le=Math.max(le,ye+se)}),{minX:E,minY:B,width:z-E,height:le-B}},[De]),dt=w.useMemo(()=>{const{x:E,y:B}=ut(Ve,se);return{x:E,y:B}},[Ve]),Mt=w.useMemo(()=>({x:Ne.minX,y:Ne.minY,width:Ne.width,height:Ne.height}),[Ne.minX,Ne.minY,Ne.width,Ne.height]),gn=w.useCallback(()=>{$.current!==null&&(window.cancelAnimationFrame($.current),$.current=null),ai.current=!1},[]),$n=w.useCallback(E=>{const B=W.current;B&&B.setAttribute("viewBox",`${E.x} ${E.y} ${E.width} ${E.height}`)},[]),At=w.useCallback(E=>{k.current=E,$n(E.viewBox)},[$n]),Vn=w.useCallback(E=>{const B=Math.max(1,O.width),z=Math.max(1,O.height),le=E?.zoomPreset??Y,re=E?.panOffset??J.current,ye={width:B,height:z,insets:A||{}},Fe=se*.75,Ze=iT(Mt,Fe),qt=tT(ye,le,se,se*.2),zt=nT(ye,Ze),Et=sT(zt,qt),nt=hy(ye,Et),gt={x:dt.x+re.x,y:dt.y+re.y},Qt=aT(gt,nt,Ze),kt=gy(Qt,nt);return{center:Qt,scale:Et,viewBox:kt}},[O.width,O.height,Y,A,Mt,dt.x,dt.y]),bi=w.useCallback((E,B=220)=>{const z=k.current;if(!z){At(E);return}gn();const le=z.center,re=z.scale,fe=E.center,ye=E.scale,Fe=performance.now();ai.current=!0;const Ze=zt=>1-Math.pow(1-zt,3),qt=zt=>{const Et=Math.min(1,(zt-Fe)/Math.max(1,B)),nt=Ze(Et),gt=re+(ye-re)*nt,Qt={x:le.x+(fe.x-le.x)*nt,y:le.y+(fe.y-le.y)*nt},kt={width:Math.max(1,O.width),height:Math.max(1,O.height),insets:A||{}},Mn=hy(kt,gt),wi=gy(Qt,Mn);At({center:Qt,scale:gt,viewBox:wi}),Et<1?$.current=window.requestAnimationFrame(qt):($.current=null,ai.current=!1,At(E))};$.current=window.requestAnimationFrame(qt)},[gn,At,O.width,O.height,A]),ht=w.useCallback(E=>{gn(),At(Vn(E))},[gn,At,Vn]),Bt=w.useCallback(E=>{const B=Vn(E);bi(B,E?.durationMs??220)},[bi,Vn]);w.useEffect(()=>{const E=_e.current;if(!E)return;const B=()=>{const le=E.getBoundingClientRect();q(re=>{const fe=Math.round(le.width),ye=Math.round(le.height);return re.width===fe&&re.height===ye?re:{width:fe,height:ye}})};if(B(),typeof ResizeObserver>"u")return window.addEventListener("resize",B),()=>window.removeEventListener("resize",B);const z=new ResizeObserver(()=>B());return z.observe(E),()=>z.disconnect()},[]),w.useEffect(()=>{if(O.width<=0||O.height<=0)return;const E=`${Mt.x}:${Mt.y}:${Mt.width}:${Mt.height}`,B=`${O.width}:${O.height}:${A?.top??0}:${A?.right??0}:${A?.bottom??0}:${A?.left??0}`,z=he(e.player.position);if(!St.current){St.current=!0,Rt.current=z,qn.current=e.floor??null,Gt.current=B,_t.current=E,zn.current=Y,ht({panOffset:{x:0,y:0}});return}if((e.floor??null)!==qn.current){qn.current=e.floor??null,_t.current=E,Gt.current=B,Rt.current=z,zn.current=Y,J.current={x:0,y:0},ht({panOffset:{x:0,y:0}});return}if(e.floor!==void 0&&E!==_t.current){_t.current=E,Gt.current=B,Rt.current=z,zn.current=Y,J.current={x:0,y:0},ht({panOffset:{x:0,y:0}});return}if(B!==Gt.current){Gt.current=B,_t.current=E,ht();return}if(Y!==zn.current){zn.current=Y,Bt();return}if(z!==Rt.current){Rt.current=z;const le={x:0,y:0};J.current=le,Bt({panOffset:le,durationMs:210});return}},[O.width,O.height,Mt.x,Mt.y,Mt.width,Mt.height,A,e.floor,e.player.position,Y,ht,Bt]);const Yn=k.current?.viewBox||Mt,$t=w.useMemo(()=>{const E={};for(const B of e.visualEvents||[]){if(B.type!=="kinetic_trace")continue;const z=B.payload;z?.actorId&&(E[z.actorId]=z)}return E},[e.visualEvents]),as=w.useMemo(()=>{if(!o||a)return[];const E=["BASIC_MOVE","DASH"],B=new Set(e.player.activeSkills.map(re=>re.id)),z=new Set,le=[];for(const re of E){if(!B.has(re))continue;const fe=Ln.get(re);if(!fe?.getValidTargets)continue;const ye=fe.getValidTargets(e,Ve);for(const Fe of ye){const Ze=he(Fe);z.has(Ze)||(z.add(Ze),le.push(Fe))}}return le},[o,a,e,Ve]),Wt=w.useMemo(()=>{const E=new Set;for(const B of as)E.add(he(B));return E},[as]),In=w.useMemo(()=>e.player.activeSkills.some(E=>E.id==="BASIC_MOVE"||E.id==="DASH"),[e.player.activeSkills]),Xt=w.useMemo(()=>he(e.stairsPosition),[e.stairsPosition]),yn=w.useMemo(()=>e.shrinePosition?he(e.shrinePosition):null,[e.shrinePosition]),Ut=w.useMemo(()=>{const E=[{q:Ve.q+1,r:Ve.r,s:Ve.s-1},{q:Ve.q+1,r:Ve.r-1,s:Ve.s},{q:Ve.q,r:Ve.r-1,s:Ve.s+1},{q:Ve.q-1,r:Ve.r,s:Ve.s+1},{q:Ve.q-1,r:Ve.r+1,s:Ve.s},{q:Ve.q,r:Ve.r+1,s:Ve.s-1}],B=new Set;for(const z of E)Vc(z.q,z.r,e.gridWidth,e.gridHeight)&&B.add(he(z));return B},[Ve,e.gridWidth,e.gridHeight]),An=w.useMemo(()=>{const E=new Set;if(!a)return E;const B=Ln.get(a);if(!B?.getValidTargets)return E;const z=B.getValidTargets(e,Ve);for(const le of z)E.add(he(le));return E},[a,e,Ve]),xi=w.useMemo(()=>{if(y)return y;if(!_)return null;const E=he(_);if(o&&!a)return Wt.has(E)||!In&&Ut.has(E)?{path:Pt(Ve,_),aoe:[],hasEnemy:!1,target:_}:null;if(!a)return null;const B=e.player.activeSkills.find(fe=>fe.id===a),z=fA(e,{actorId:e.player.id,skillId:a,target:_,activeUpgrades:B?.activeUpgrades||[]});if(!z.ok)return null;const le=new Map;for(const fe of z.simulationEvents)fe.position&&(fe.type!=="DamageTaken"&&fe.type!=="StatusApplied"&&fe.type!=="UnitMoved"||le.set(he(fe.position),fe.position));const re=z.simulationEvents.some(fe=>(fe.type==="DamageTaken"||fe.type==="StatusApplied")&&!!fe.targetId&&fe.targetId!==e.player.id);return{path:Pt(Ve,_),aoe:[...le.values()],hasEnemy:re,target:_}},[y,_,o,a,Wt,In,Ut,e,Ve]),en=w.useMemo(()=>{const E=new Map;for(const B of De){const z=he(B),le=qe.getTraitsAt(e,B),re=le.has("BLOCKS_MOVEMENT")&&le.has("BLOCKS_LOS"),fe=le.has("LAVA")||le.has("HAZARDOUS")&&le.has("LIQUID"),ye=le.has("FIRE");E.set(z,{isWall:re,isLava:!re&&fe,isFire:!re&&ye})}return E},[De,e.tiles]),dn=w.useMemo(()=>{const E=new Map;for(const B of r?.assets||[])E.set(B.id,B);return E},[r]),Bn=w.useMemo(()=>dn.get(DA())?.path,[dn]),Tn=w.useMemo(()=>Math.max(1,r?.tileUnitPx||256),[r?.tileUnitPx]),En=w.useMemo(()=>se*2/Tn,[Tn]),Ue=w.useMemo(()=>String(e.theme||"").toLowerCase(),[e.theme]),Tt=w.useMemo(()=>`${e.initialSeed||e.rngSeed||e.turnNumber}:${e.floor}:${Ue}`,[e.initialSeed,e.rngSeed,e.turnNumber,e.floor,Ue]),bn=w.useMemo(()=>Uf(r,Ue),[r,Ue]),ks=w.useMemo(()=>{const E=r?.biomeUnderlay;if(E)return{default:E.default,themes:E.themes,mode:E.mode,scalePx:E.scalePx,opacity:E.opacity}},[r?.biomeUnderlay]),jt=w.useMemo(()=>bn?.biomeLayers?.undercurrent||r?.biomeLayers?.undercurrent,[bn?.biomeLayers?.undercurrent,r?.biomeLayers?.undercurrent]),tn=w.useMemo(()=>bn?.biomeLayers?.crust||r?.biomeLayers?.crust||ks,[bn?.biomeLayers?.crust,r?.biomeLayers?.crust,ks]),Fn=w.useMemo(()=>bn?.biomeLayers?.clutter||r?.biomeLayers?.clutter,[bn?.biomeLayers?.clutter,r?.biomeLayers?.clutter]),vi=w.useMemo(()=>kc(jt,Ue),[jt,Ue]),os=w.useMemo(()=>Lc(jt),[jt]),Fi=w.useMemo(()=>Ic(jt,Tn,64,192),[jt,Tn]),Ls=w.useMemo(()=>hf(jt),[jt]),Di=w.useMemo(()=>({x:Number(jt?.scroll?.x??120),y:Number(jt?.scroll?.y??90),durationMs:Math.max(1e3,Number(jt?.scroll?.durationMs??92e3))}),[jt?.scroll?.x,jt?.scroll?.y,jt?.scroll?.durationMs]),nn=w.useMemo(()=>({x:Number(jt?.offsetX??0)+Number(f?.undercurrentOffset?.x??0),y:Number(jt?.offsetY??0)+Number(f?.undercurrentOffset?.y??0)}),[jt?.offsetX,jt?.offsetY,f?.undercurrentOffset?.x,f?.undercurrentOffset?.y]),Si=w.useMemo(()=>kc(tn,Ue),[tn,Ue]),jn=w.useMemo(()=>Lc(tn),[tn]),F=w.useMemo(()=>Ic(tn,Tn,64),[tn,Tn]),te=1,de=w.useMemo(()=>{const E=Math.max(0,Number(tn?.seedShiftPx??se*5));if(E===0)return{x:0,y:0};const B=$c(`${Tt}|crust-offset`),z=((B&65535)/65535*2-1)*E,le=((B>>>16&65535)/65535*2-1)*E;return{x:z,y:le}},[tn?.seedShiftPx,Tt]),we=w.useMemo(()=>({x:Number(tn?.offsetX??0)+Number(f?.crustOffset?.x??0),y:Number(tn?.offsetY??0)+Number(f?.crustOffset?.y??0)}),[tn?.offsetX,tn?.offsetY,f?.crustOffset?.x,f?.crustOffset?.y]),ve=w.useMemo(()=>({x:de.x+we.x,y:de.y+we.y}),[de.x,de.y,we.x,we.y]),Le=w.useMemo(()=>r?.walls,[r?.walls]),$e=w.useMemo(()=>bn?.walls||Le?.themes?.[Ue],[bn?.walls,Le?.themes,Ue]),Ot=w.useMemo(()=>bn?.biomeMaterials?.crust||r?.biomeMaterials?.crust,[bn?.biomeMaterials?.crust,r?.biomeMaterials?.crust]),lt=w.useMemo(()=>Ot?.detailA,[Ot?.detailA]),Ye=w.useMemo(()=>Ot?.detailB,[Ot?.detailB]),rt=w.useMemo(()=>kc(lt,Ue),[lt,Ue]),Vt=w.useMemo(()=>kc(Ye,Ue),[Ye,Ue]),Dn=w.useMemo(()=>Lc(lt),[lt]),Ct=w.useMemo(()=>Lc(Ye),[Ye]),ls=w.useMemo(()=>Ic(lt,F,64),[lt,F]),ga=w.useMemo(()=>Ic(Ye,F,64),[Ye,F]),Xn=w.useMemo(()=>hf(lt),[lt]),oi=w.useMemo(()=>hf(Ye),[Ye]),ya=w.useMemo(()=>yy(lt),[lt?.scroll?.x,lt?.scroll?.y,lt?.scroll?.durationMs]),Is=w.useMemo(()=>yy(Ye),[Ye?.scroll?.x,Ye?.scroll?.y,Ye?.scroll?.durationMs]),ba=w.useMemo(()=>{const E=se*.75,B=$c(`${Tt}|crust-detail-a-offset`),z=((B&65535)/65535*2-1)*E,le=((B>>>16&65535)/65535*2-1)*E;return{x:z,y:le}},[Tt]),Qa=w.useMemo(()=>{const E=se*.75,B=$c(`${Tt}|crust-detail-b-offset`),z=((B&65535)/65535*2-1)*E,le=((B>>>16&65535)/65535*2-1)*E;return{x:z,y:le}},[Tt]),wn=w.useMemo(()=>({x:ve.x+ba.x,y:ve.y+ba.y}),[ve.x,ve.y,ba.x,ba.y]),_n=w.useMemo(()=>({x:ve.x+Qa.x,y:ve.y+Qa.y}),[ve.x,ve.y,Qa.x,Qa.y]),Hn=w.useMemo(()=>Ot?.tint,[Ot?.tint]),xn=w.useMemo(()=>lT(Hn,Ue),[Hn,Ue]),xa=w.useMemo(()=>rT(Hn),[Hn?.opacity]),Ja=w.useMemo(()=>s0(Hn?.blendMode),[Hn?.blendMode]),rs=!!(xn&&xa>0),zo=w.useMemo(()=>rs?Math.min(.55,Math.max(.15,xa*.9)):0,[rs,xa]),Ki=w.useCallback(E=>{const B=E?.mountainSettings,z=E?.mountainSettingsByTheme?.[Ue],re=(E?bn?.assetOverrides?.[E.id]:void 0)?.mountainSettings,fe=Math.min(3,Math.max(.2,Number(f?.mountainScale??re?.scale??z?.scale??$e?.scale??Le?.scale??B?.scale??.95))),ye=Number(f?.mountainOffset?.x??re?.offsetX??z?.offsetX??$e?.offsetX??Le?.offsetX??B?.offsetX??0),Fe=Number(f?.mountainOffset?.y??re?.offsetY??z?.offsetY??$e?.offsetY??Le?.offsetY??B?.offsetY??0),Ze=Math.min(1,Math.max(0,Number(f?.mountainAnchor?.x??re?.anchorX??z?.anchorX??$e?.anchorX??Le?.anchorX??B?.anchorX??.5))),qt=Math.min(1,Math.max(0,Number(f?.mountainAnchor?.y??re?.anchorY??z?.anchorY??$e?.anchorY??Le?.anchorY??B?.anchorY??.78))),zt=by(f?.mountainCrustBlendMode??re?.crustBlendMode??z?.crustBlendMode??$e?.crustBlendMode??Le?.crustBlendMode??B?.crustBlendMode,Ja),Et=Math.min(1,Math.max(0,Number(f?.mountainCrustBlendOpacity??re?.crustBlendOpacity??z?.crustBlendOpacity??$e?.crustBlendOpacity??Le?.crustBlendOpacity??B?.crustBlendOpacity??zo))),nt=a0(String(f?.mountainTintColor??re?.tintColor??z?.tintColor??$e?.tintColor??Le?.tintColor??B?.tintColor??xn??"#8b6f4a")),gt=by(f?.mountainTintBlendMode??re?.tintBlendMode??z?.tintBlendMode??$e?.tintBlendMode??Le?.tintBlendMode??B?.tintBlendMode,"soft-light"),Qt=Math.min(1,Math.max(0,Number(f?.mountainTintOpacity??re?.tintOpacity??z?.tintOpacity??$e?.tintOpacity??Le?.tintOpacity??B?.tintOpacity??0))),kt=cT(nt);return{scale:fe,offsetX:ye,offsetY:Fe,anchorX:Ze,anchorY:qt,crustBlendMode:zt,crustBlendOpacity:Et,tintColor:nt,tintBlendMode:gt,tintOpacity:Qt,tintMatrixValues:`0 0 0 0 ${kt.r.toFixed(4)} 0 0 0 0 ${kt.g.toFixed(4)} 0 0 0 0 ${kt.b.toFixed(4)} 0 0 0 1 0`}},[Ue,f?.mountainScale,f?.mountainOffset?.x,f?.mountainOffset?.y,f?.mountainAnchor?.x,f?.mountainAnchor?.y,f?.mountainCrustBlendMode,f?.mountainCrustBlendOpacity,f?.mountainTintColor,f?.mountainTintBlendMode,f?.mountainTintOpacity,bn?.assetOverrides,Le,$e,Ja,xn,zo]),Jc=!!(rt&&Dn!=="off"&&Xn>0||Vt&&Ct!=="off"&&oi>0||rs),Qn=!!(vi&&os!=="off"||Si&&jn!=="off"||Jc),Za=w.useMemo(()=>`biome-undercurrent-${e.floor}`,[e.floor]),$o=w.useMemo(()=>`biome-crust-${e.floor}`,[e.floor]),Ai=w.useMemo(()=>`biome-crust-mask-${e.floor}`,[e.floor]),cs=w.useMemo(()=>`biome-crust-detail-a-${e.floor}`,[e.floor]),Vo=w.useMemo(()=>`biome-crust-detail-b-${e.floor}`,[e.floor]),cr=!!(Si&&jn!=="off"||rt&&Dn!=="off"&&Xn>0||Vt&&Ct!=="off"&&oi>0||rs),Bs=w.useMemo(()=>{const E=[];for(const B of De){const z=he(B),le=en.get(z);if(!le||!le.isLava&&!le.isFire)continue;const{x:re,y:fe}=ut(B,se);E.push({key:z,x:re,y:fe})}return E},[De,en]),ur=w.useMemo(()=>{const E=ey({isStairs:!0});return E?dn.get(E):void 0},[dn]),Yo=w.useMemo(()=>{const E=ey({isShrine:!0});return E?dn.get(E):void 0},[dn]),eo=w.useMemo(()=>{const E=[];return e.stairsPosition&&E.push({id:`stairs-${he(e.stairsPosition)}`,kind:"stairs",position:e.stairsPosition,asset:ur}),e.shrinePosition&&E.push({id:`shrine-${he(e.shrinePosition)}`,kind:"shrine",position:e.shrinePosition,asset:Yo}),E},[e.stairsPosition,e.shrinePosition,ur,Yo]),Gi=w.useMemo(()=>{const B=(r?.assets||[]).filter(fe=>{if(fe.type!=="prop")return!1;const ye=fe.id.toLowerCase(),Fe=new Set((fe.tags||[]).map(zt=>zt.toLowerCase()));if(!(ye.includes("mountain")||Fe.has("mountain")))return!1;if(!fe.theme)return!0;const qt=fe.theme.toLowerCase();return qt===Ue||qt==="core"}).sort((fe,ye)=>fe.id.localeCompare(ye.id)),z=String($e?.mountainPath||Le?.mountainPath||"").trim(),le=String(f?.mountainAssetPath||z).trim();if(!le)return B;const re=B.find(fe=>fe.path===le);return re?[re]:[]},[r?.assets,Ue,f?.mountainAssetPath,Le?.mountainPath,$e?.mountainPath]),Fo=w.useMemo(()=>{const E=new Map;for(const B of Gi)E.set(B.id,Ki(B));return E},[Gi,Ki]),to=w.useMemo(()=>{if(!Gi.length)return[];const E=Gi.filter(le=>oT(le)===1),B=E.length?E:Gi,z=De.filter(le=>en.get(he(le))?.isWall).sort((le,re)=>he(le).localeCompare(he(re)));return z.length?z.map(le=>{const re=he(le),fe=Math.floor(Gl(`${Tt}|mountain-tile|${re}|asset`)*B.length)%B.length,ye=B[fe],Fe=Fo.get(ye.id)||Ki(ye),{y:Ze}=ut(le,se);return{id:`mountain-${re}-${ye.id}`,kind:"mountain",position:le,asset:ye,renderScale:Fe.scale,zAnchorY:Ze+se*.42+Fe.offsetY}}):[]},[Gi,De,en,Tt,Fo,Ki]),Wi=w.useMemo(()=>{const E=new Set((Fn?.tags?.length?Fn.tags:["clutter","obstacle"]).map(B=>B.toLowerCase()));return(r?.assets||[]).filter(B=>{if(B.type!=="prop"&&B.type!=="decal"||B.id.toLowerCase().includes("mountain"))return!1;const le=(B.tags||[]).map(re=>re.toLowerCase());return le.includes("mountain")||!le.some(re=>E.has(re))?!1:B.theme?B.theme.toLowerCase()===Ue||B.theme.toLowerCase()==="core":!0})},[r?.assets,Fn?.tags,Ue]),Ti=w.useMemo(()=>{if(!Wi.length)return[];const E=Math.min(.6,Math.max(0,Number(Fn?.density??.08))),B=Math.max(1,Math.floor(Number(Fn?.maxPerHex??1))),z=Math.min(2,Math.max(1,Number(Fn?.bleedScaleMax??2))),le=[];for(const re of De){const fe=he(re),ye=en.get(fe);if(ye?.isWall||ye?.isLava||ye?.isFire)continue;const{y:Fe}=ut(re,se);for(let Ze=0;Ze<B;Ze++){if(Gl(`${Tt}|clutter|${fe}|slot:${Ze}|roll`)>E/(Ze+1))continue;const zt=Math.floor(Gl(`${Tt}|clutter|${fe}|slot:${Ze}|pick`)*Wi.length)%Wi.length,Et=Wi[zt],nt=1+Gl(`${Tt}|clutter|${fe}|slot:${Ze}|scale`)*(z-1),gt=(Gl(`${Tt}|clutter|${fe}|slot:${Ze}|depth`)-.5)*se*.28;le.push({id:`clutter-${fe}-${Ze}-${Et.id}`,kind:"clutter",position:re,asset:Et,renderScale:nt,zAnchorY:Fe+gt})}}return le},[De,en,Wi,Fn?.density,Fn?.maxPerHex,Fn?.bleedScaleMax,Tt]),Ko=w.useMemo(()=>{const E=[...to,...Ti];for(const B of eo){const{y:z}=ut(B.position,se),le=B.kind==="shrine";E.push({id:B.id,kind:B.kind,position:B.position,asset:B.asset,renderScale:Math.min(2,le?1.5:1.42),zAnchorY:z+(le?se*.32:se*.28),fallback:B.kind})}return E.sort((B,z)=>B.zAnchorY===z.zAnchorY?B.id.localeCompare(z.id):B.zAnchorY-z.zAnchorY),E},[to,Ti,eo]),Go=w.useMemo(()=>{const E=new Set;for(const B of to)E.add(he(B.position));return E},[to]),Xi=w.useCallback(E=>{if(!E)return null;const B=E.position||E.destination||E.origin||E.target;return B&&typeof B.q=="number"&&typeof B.r=="number"&&typeof B.s=="number"?B:null},[]);w.useEffect(()=>{if(!Bn)return;const E=e.timelineEvents||[],B=e.visualEvents||[];E.length<ae.current&&(ae.current=0);const z=E.slice(ae.current);ae.current=E.length,B.length<Te.current&&(Te.current=0);const le=B.slice(Te.current);Te.current=B.length;const re=[],fe=Date.now();for(const ye of z){if(ye.phase!=="DEATH_RESOLVE")continue;const Fe=Xi(ye.payload);Fe&&re.push({id:`decal-tl-${ye.id}-${fe}-${re.length}`,position:Fe,href:Bn,createdAt:fe})}for(const ye of le){if(ye.type!=="vfx")continue;const Fe=ye.payload?.type;if(Fe!=="vaporize"&&Fe!=="explosion_ring")continue;const Ze=Xi(ye.payload);Ze&&re.push({id:`decal-vx-${Fe}-${fe}-${re.length}`,position:Ze,href:Bn,createdAt:fe})}re.length>0&&N(ye=>[...ye,...re].slice(-80))},[e.timelineEvents,e.visualEvents,Bn,Xi]),w.useEffect(()=>{const E=e.simulationEvents||[];E.length<xe.current&&(xe.current=0);const B=E.slice(xe.current);xe.current=E.length,B.length>0&&h?.(B)},[e.simulationEvents,h]),w.useEffect(()=>{if(M.length===0)return;const E=12e3,B=window.setTimeout(()=>{const z=Date.now();N(le=>le.filter(re=>z-re.createdAt<E))},1e3);return()=>window.clearTimeout(B)},[M]);const li=w.useCallback((E,B)=>{const z=W.current;if(!z||!z.getScreenCTM)return null;const le=z.getScreenCTM();if(!le)return null;const re=z.createSVGPoint();re.x=E,re.y=B;const fe=re.matrixTransform(le.inverse());return{x:fe.x,y:fe.y}},[]),Wo=w.useCallback(E=>{const B={x:J.current.x+E.x,y:J.current.y+E.y};J.current=B,gn(),At(Vn({panOffset:B}))},[gn,At,Vn]),us=w.useCallback(E=>{X(B=>B===E?B:E)},[]),dr=w.useCallback(()=>{J.current={x:0,y:0},Bt({panOffset:{x:0,y:0},durationMs:220})},[Bt]),va=w.useCallback(E=>{Date.now()<ke.current||i(E)},[i]),Hi=w.useCallback(E=>{me.current||Me.current||p(E)},[]),Qi=w.useCallback(()=>Array.from(Ie.current.entries()),[]),Sa=w.useCallback(E=>{if(E.pointerType==="mouse"&&E.button!==0)return;if(Ie.current.set(E.pointerId,{x:E.clientX,y:E.clientY}),E.pointerType!=="mouse")try{E.currentTarget.setPointerCapture(E.pointerId)}catch{}const B=Qi();if(B.length>=2){Me.current=!0,me.current=!1,ue(!1),pt.current.didPan=!0,ke.current=Date.now()+250;const[z,le]=B,re=z[1].x-le[1].x,fe=z[1].y-le[1].y;ze.current={startDistance:Math.hypot(re,fe),startPreset:Y,appliedPreset:Y};return}pt.current={activePointerId:E.pointerId,startClient:{x:E.clientX,y:E.clientY},lastWorld:li(E.clientX,E.clientY),didPan:!1}},[li,Qi,Y]),Ji=w.useCallback(E=>{if(!Ie.current.has(E.pointerId))return;Ie.current.set(E.pointerId,{x:E.clientX,y:E.clientY});const B=Qi();if(Me.current||B.length>=2){if(B.length>=2){Me.current=!0;const[qt,zt]=B,Et=qt[1].x-zt[1].x,nt=qt[1].y-zt[1].y,gt=Math.max(1,Math.hypot(Et,nt));if(!ze.current)ze.current={startDistance:gt,startPreset:Y,appliedPreset:Y};else{const Qt=gt/Math.max(1,ze.current.startDistance);let kt=ze.current.startPreset;Qt>1.08&&(kt=7),Qt<.92&&(kt=11),kt!==ze.current.appliedPreset&&(ze.current.appliedPreset=kt,us(kt))}ke.current=Date.now()+250,E.preventDefault()}return}const z=pt.current;if(!z.startClient||z.activePointerId!==E.pointerId)return;const le=E.clientX-z.startClient.x,re=E.clientY-z.startClient.y,fe=Math.hypot(le,re);if(!z.didPan&&fe>10&&(z.didPan=!0,me.current=!0,ue(!0),ke.current=Date.now()+250,p(null)),!z.didPan)return;const Fe=li(E.clientX,E.clientY);if(!z.lastWorld||!Fe)return;const Ze={x:z.lastWorld.x-Fe.x,y:z.lastWorld.y-Fe.y};z.lastWorld=Fe,Wo(Ze),E.preventDefault()},[li,Qi,us,Wo,Y]),js=w.useCallback(E=>{Ie.current.delete(E);const B=Qi();B.length<2&&(Me.current=!1,ze.current=null);const z=pt.current;z.activePointerId===E&&(z.didPan&&(ke.current=Date.now()+250),pt.current={activePointerId:B[0]?.[0]??null,startClient:B[0]?{...B[0][1]}:null,lastWorld:B[0]?li(B[0][1].x,B[0][1].y):null,didPan:!1}),Ie.current.size===0&&(me.current=!1,ue(!1))},[li,Qi]),no=w.useCallback(E=>{js(E.pointerId);try{E.currentTarget.releasePointerCapture(E.pointerId)}catch{}},[js]),fr=w.useCallback(E=>{js(E.pointerId)},[js]),io=w.useCallback(E=>{if((E.ctrlKey||E.deltaY!==0)&&E.preventDefault(),Math.abs(E.deltaY)<.1)return;const B=E.deltaY<0?7:11;us(B),ke.current=Date.now()+120},[us]);w.useEffect(()=>{c?.(g||I)},[g,I,c]);const ds=w.useMemo(()=>{const E=new Map;E.set(e.player.id,e.player.position);for(const B of e.enemies)E.set(B.id,B.position);for(const B of e.companions||[])E.set(B.id,B.position);for(const B of e.dyingEntities||[])E.set(B.id,B.position);return E},[e.player.id,e.player.position,e.enemies,e.companions,e.dyingEntities]),mr=w.useMemo(()=>[{id:e.player.id,position:e.player.position,subtype:e.player.subtype||"player"},...e.enemies.map(E=>({id:E.id,position:E.position,subtype:E.subtype})),...(e.companions||[]).map(E=>({id:E.id,position:E.position,subtype:E.subtype})),...(e.dyingEntities||[]).map(E=>({id:E.id,position:E.position,subtype:E.subtype}))],[e.player.id,e.player.position,e.player.subtype,e.enemies,e.companions,e.dyingEntities]);w.useEffect(()=>{if(!b)return;const E={turn:e.turnNumber||0,stackTick:e.stackTrace?.length||0,actors:[...ds.entries()].map(([B,z])=>({id:B,position:{q:z.q,r:z.r,s:z.s}}))};b(E)},[b,e.turnNumber,e.stackTrace,ds]);const sn=w.useMemo(()=>(e.visualEvents||[]).filter(E=>E.type==="kinetic_trace").map(E=>E.payload).filter(E=>{if(!E?.actorId||!E.origin||!E.destination)return!1;const B=ds.get(E.actorId);return!!B&&he(B)===he(E.destination)}),[e.visualEvents,ds]),Ei=w.useMemo(()=>{if(!sn.length)return"";const E=e.turnNumber??0,B=sn.map(z=>{const le=(z.path||[]).map(re=>`${re.q},${re.r},${re.s}`).join(">");return[z.actorId,`${z.origin.q},${z.origin.r},${z.origin.s}`,`${z.destination.q},${z.destination.r},${z.destination.s}`,z.movementType||"slide",z.startDelayMs||0,z.durationMs||0,le].join("|")}).join("||");return`${E}::${B}`},[sn,e.turnNumber]),Ds=w.useCallback(async(E,B,z,le)=>{if(le!==H.current)return;const re=E.animate(B,{...z,fill:z.fill??"forwards"});pe.current.push(re);try{await re.finished}catch{}finally{pe.current=pe.current.filter(fe=>fe!==re)}},[]),Hs=w.useCallback(async(E,B,z)=>{if(B!==H.current)return;const le=.76,re=W.current?.querySelector(`[data-actor-node="${E.actorId}"]`),fe=Mn=>{const wi=ut(Mn,se);return`translate(${wi.x}px, ${wi.y}px)`},ye=Math.max(0,E.startDelayMs||0),Fe=Math.max(0,performance.now()-z),Ze=Math.round(ye*le),qt=Math.max(0,Ze-Fe),zt=E.path&&E.path.length>1?E.path:[E.origin,E.destination],Et=Math.max(1,zt.length-1),nt=Math.max(90,Math.round((E.durationMs||Et*110)*le));if(!re){const Mn=Math.max(0,qt+nt);Mn>0&&await new Promise(wi=>window.setTimeout(wi,Mn));return}if(qt>0&&(await new Promise(Mn=>window.setTimeout(Mn,qt)),B!==H.current))return;if((E.movementType||"slide")==="teleport"){const Mn=Math.max(100,Math.round((E.durationMs||180)*le));await Ds(re,[{transform:fe(E.origin),opacity:1,offset:0},{transform:fe(E.origin),opacity:0,offset:.45},{transform:fe(E.destination),opacity:0,offset:.55},{transform:fe(E.destination),opacity:1,offset:1}],{duration:Mn,easing:"linear"},B),B===H.current&&(re.style.transform=fe(E.destination),re.style.opacity="1");return}const gt=[...zt],Qt=gt[gt.length-1];(!Qt||Qt.q!==E.destination.q||Qt.r!==E.destination.r||Qt.s!==E.destination.s)&&gt.push(E.destination);const kt=gt.map((Mn,wi)=>({transform:fe(Mn),offset:gt.length===1?1:wi/(gt.length-1)}));kt[kt.length-1]={...kt[kt.length-1],transform:fe(E.destination),offset:1},await Ds(re,kt,{duration:nt,easing:"linear"},B),B===H.current&&(re.style.transform=fe(E.destination),re.style.opacity="1")},[Ds]),pr=w.useCallback(async()=>{if(be.current)return;be.current=!0,R(!0);const E=++H.current,B=performance.now();try{for(;oe.current.length>0&&E===H.current;){const z=oe.current.shift();z&&await Hs(z,E,B)}}finally{E===H.current&&(be.current=!1,R(!1))}},[Hs]);w.useEffect(()=>{if(!Ei){ee.current="";return}Ei!==ee.current&&(ee.current=Ei,oe.current.push(...sn),pr())},[Ei,sn,pr]),w.useEffect(()=>()=>{gn(),H.current++,oe.current=[],be.current=!1,pe.current.forEach(E=>{try{E.cancel()}catch{}}),pe.current=[],R(!1)},[gn]),w.useEffect(()=>{gn(),H.current++,oe.current=[],be.current=!1,pe.current.forEach(E=>{try{E.cancel()}catch{}}),pe.current=[],R(!1),ee.current="",N([]),ae.current=0,Te.current=0},[e.floor,gn]);const Xo=w.useMemo(()=>gf(se-1),[]),Qo=w.useMemo(()=>gf(se+1),[]),Aa=w.useMemo(()=>gf(se-2),[]),Ps=w.useMemo(()=>`biome-map-clip-${e.floor}`,[e.floor]),Je=w.useMemo(()=>({x:Ne.minX-se*2,y:Ne.minY-se*2,width:Ne.width+se*4,height:Ne.height+se*4}),[Ne.minX,Ne.minY,Ne.width,Ne.height]),Ta=w.useMemo(()=>{const E=Math.max(Math.abs(Number(nn?.x??0)),Math.abs(Number(nn?.y??0)),Math.abs(Number(ve?.x??0)),Math.abs(Number(ve?.y??0)),Math.abs(Number(wn?.x??0)),Math.abs(Number(wn?.y??0)),Math.abs(Number(_n?.x??0)),Math.abs(Number(_n?.y??0)));return Math.min(se*32,Math.max(se*8,Math.ceil(E+se*6)))},[nn?.x,nn?.y,ve?.x,ve?.y,wn?.x,wn?.y,_n?.x,_n?.y]),vn=w.useMemo(()=>({x:Je.x-Ta,y:Je.y-Ta,width:Je.width+Ta*2,height:Je.height+Ta*2}),[Je.x,Je.y,Je.width,Je.height,Ta]);return m.jsxs("div",{ref:_e,className:`relative w-full h-full flex justify-center items-center overflow-hidden transition-transform duration-75 ${v?"animate-shake":""} ${K?"cursor-grabbing":""}`,children:[m.jsxs("svg",{ref:W,width:"100%",height:"100%",viewBox:`${Yn.x} ${Yn.y} ${Yn.width} ${Yn.height}`,preserveAspectRatio:"xMidYMid meet",shapeRendering:"geometricPrecision",className:"max-h-full max-w-full",onMouseLeave:()=>p(null),onWheel:io,onPointerDown:Sa,onPointerMove:Ji,onPointerUp:no,onPointerCancel:fr,style:{touchAction:"none"},children:[m.jsxs("defs",{children:[m.jsx("clipPath",{id:Ps,clipPathUnits:"userSpaceOnUse",children:De.map(E=>{const{x:B,y:z}=ut(E,se);return m.jsx("polygon",{points:Aa,transform:`translate(${B},${z})`},`biome-clip-${he(E)}`)})}),vi&&os==="repeat"&&m.jsxs("pattern",{id:Za,patternUnits:"userSpaceOnUse",width:Fi,height:Fi,patternTransform:`translate(${nn.x} ${nn.y})`,children:[m.jsx("image",{href:vi,x:"0",y:"0",width:Fi,height:Fi,preserveAspectRatio:"xMidYMid slice"}),(Di.x!==0||Di.y!==0)&&m.jsx("animateTransform",{attributeName:"patternTransform",type:"translate",from:`${nn.x} ${nn.y}`,to:`${nn.x+Di.x} ${nn.y+Di.y}`,dur:`${Di.durationMs}ms`,repeatCount:"indefinite"})]}),Si&&jn==="repeat"&&m.jsx("pattern",{id:$o,patternUnits:"userSpaceOnUse",width:F,height:F,patternTransform:`translate(${ve.x} ${ve.y})`,children:m.jsx("image",{href:Si,x:"0",y:"0",width:F,height:F,preserveAspectRatio:"xMidYMid slice"})}),rt&&Dn==="repeat"&&m.jsxs("pattern",{id:cs,patternUnits:"userSpaceOnUse",width:ls,height:ls,patternTransform:`translate(${wn.x} ${wn.y})`,children:[m.jsx("image",{href:rt,x:"0",y:"0",width:ls,height:ls,preserveAspectRatio:"xMidYMid slice"}),(ya.x!==0||ya.y!==0)&&m.jsx("animateTransform",{attributeName:"patternTransform",type:"translate",from:`${wn.x} ${wn.y}`,to:`${wn.x+ya.x} ${wn.y+ya.y}`,dur:`${ya.durationMs}ms`,repeatCount:"indefinite"})]}),Vt&&Ct==="repeat"&&m.jsxs("pattern",{id:Vo,patternUnits:"userSpaceOnUse",width:ga,height:ga,patternTransform:`translate(${_n.x} ${_n.y})`,children:[m.jsx("image",{href:Vt,x:"0",y:"0",width:ga,height:ga,preserveAspectRatio:"xMidYMid slice"}),(Is.x!==0||Is.y!==0)&&m.jsx("animateTransform",{attributeName:"patternTransform",type:"translate",from:`${_n.x} ${_n.y}`,to:`${_n.x+Is.x} ${_n.y+Is.y}`,dur:`${Is.durationMs}ms`,repeatCount:"indefinite"})]}),cr&&m.jsxs("mask",{id:Ai,maskUnits:"userSpaceOnUse",maskContentUnits:"userSpaceOnUse",children:[m.jsx("rect",{x:Je.x,y:Je.y,width:Je.width,height:Je.height,fill:"white"}),Bs.map(E=>m.jsx("polygon",{points:Qo,transform:`translate(${E.x},${E.y})`,fill:"black",opacity:1},`hole-${E.key}`))]})]}),m.jsxs("g",{"data-layer":"biome-undercurrent",pointerEvents:"none",clipPath:`url(#${Ps})`,children:[vi&&os==="repeat"&&m.jsx("rect",{x:Je.x,y:Je.y,width:Je.width,height:Je.height,fill:`url(#${Za})`,opacity:Ls}),vi&&os==="cover"&&m.jsx("image",{href:vi,x:vn.x+nn.x,y:vn.y+nn.y,width:vn.width,height:vn.height,preserveAspectRatio:"xMidYMid slice",opacity:Ls})]}),m.jsxs("g",{"data-layer":"biome-crust",pointerEvents:"none",clipPath:`url(#${Ps})`,children:[Si&&jn==="repeat"&&m.jsx("rect",{x:Je.x,y:Je.y,width:Je.width,height:Je.height,fill:`url(#${$o})`,opacity:te,mask:`url(#${Ai})`}),Si&&jn==="cover"&&m.jsx("image",{href:Si,x:vn.x+ve.x,y:vn.y+ve.y,width:vn.width,height:vn.height,preserveAspectRatio:"xMidYMid slice",opacity:te,mask:`url(#${Ai})`}),rt&&Dn==="repeat"&&Xn>0&&m.jsx("rect",{x:Je.x,y:Je.y,width:Je.width,height:Je.height,fill:`url(#${cs})`,opacity:Xn,mask:`url(#${Ai})`}),rt&&Dn==="cover"&&Xn>0&&m.jsx("image",{href:rt,x:vn.x+wn.x,y:vn.y+wn.y,width:vn.width,height:vn.height,preserveAspectRatio:"xMidYMid slice",opacity:Xn,mask:`url(#${Ai})`}),Vt&&Ct==="repeat"&&oi>0&&m.jsx("rect",{x:Je.x,y:Je.y,width:Je.width,height:Je.height,fill:`url(#${Vo})`,opacity:oi,mask:`url(#${Ai})`}),Vt&&Ct==="cover"&&oi>0&&m.jsx("image",{href:Vt,x:vn.x+_n.x,y:vn.y+_n.y,width:vn.width,height:vn.height,preserveAspectRatio:"xMidYMid slice",opacity:oi,mask:`url(#${Ai})`}),rs&&xn&&m.jsx("rect",{x:Je.x,y:Je.y,width:Je.width,height:Je.height,fill:xn,opacity:xa,mask:`url(#${Ai})`,style:Ja!=="normal"?{mixBlendMode:Ja}:void 0})]}),m.jsx("g",{"data-layer":"interaction-preview",children:m.jsx(_A,{gameState:e,selectedSkillId:a,showMovementRange:o,hoveredTile:_,enginePreviewGhost:xi})}),m.jsxs("g",{"data-layer":"interaction-tiles",children:[De.map(E=>{const B=he(E),z=en.get(B)||{isWall:!1,isLava:!1,isFire:!1},le=z.isWall,re=z.isLava,fe=z.isFire,ye=o&&!a&&Wt.has(B)||o&&!a&&!In&&Ut.has(B)&&!le,Ze=!!a&&An.has(B)||ye,qt=B===Xt,zt=yn?B===yn:!1,Et=le&&!Go.has(B),nt=Qn&&!Et,gt=kA({isWall:Et,isLava:re,isFire:fe,theme:e.theme}),Qt=nt?void 0:dn.get(gt)?.path;return m.jsx(SA,{hex:E,onClick:va,isValidMove:Ze,isTargeted:!1,isStairs:qt,isLava:re,isFire:fe,isShrine:zt,isWall:Et,onMouseEnter:Hi,assetHref:Qt,interactionOnly:nt},B)}),m.jsx("g",{children:M.map(E=>{const{x:B,y:z}=ut(E.position,se),le=Date.now()-E.createdAt,re=Math.max(.18,.75-le/12e3*.57);return m.jsx("image",{href:E.href,x:B-se*.7,y:z-se*.7,width:se*1.4,height:se*1.4,preserveAspectRatio:"xMidYMid meet",opacity:re},E.id)})})]}),m.jsx("g",{"data-layer":"clutter-obstacles",pointerEvents:"none",children:Ko.map(E=>{const{x:B,y:z}=ut(E.position,se);if(E.asset?.path){const le=Math.min(1,Math.max(0,E.asset.anchor?.x??.5)),re=Math.min(1,Math.max(0,E.asset.anchor?.y??.5)),fe=E.kind==="mountain",ye=fe?Fo.get(E.asset.id)||Ki(E.asset):null,Fe=ye?ye.anchorX:le,Ze=ye?ye.anchorY:re,qt=B+(ye?ye.offsetX:0),zt=z+(ye?ye.offsetY:0),Et=Math.max(8,E.asset.width*En*E.renderScale),nt=Math.max(8,E.asset.height*En*E.renderScale),gt=E.kind==="shrine",Qt=E.kind==="stairs",kt=gt||Qt,Mn=gt?"rgba(251,146,60,0.25)":"rgba(74,222,128,0.22)",wi=gt?"#fdba74":"#86efac",hr=B,gr=z-nt*Ze+nt*.84,yr=Math.max(14,Et*.32),br=Math.max(8,nt*.14);return m.jsxs("g",{children:[kt&&m.jsxs(m.Fragment,{children:[m.jsx("ellipse",{cx:hr,cy:gr,rx:yr,ry:br,fill:Mn,opacity:.95}),m.jsx("ellipse",{cx:hr,cy:gr,rx:yr*1.14,ry:br*1.14,fill:"none",stroke:wi,strokeWidth:2,opacity:.72,style:{animation:`shrineGlow ${gt?1.8:2.4}s ease-in-out infinite`}})]}),(()=>{const Zc=kt?gt?"drop-shadow(0 4px 6px rgba(0,0,0,0.55)) drop-shadow(0 0 4px rgba(251,146,60,0.45)) saturate(1.08) contrast(1.06)":"drop-shadow(0 4px 6px rgba(0,0,0,0.55)) drop-shadow(0 0 4px rgba(74,222,128,0.42)) saturate(1.08) contrast(1.06)":fe?"drop-shadow(0 7px 10px rgba(0,0,0,0.56)) saturate(1.04) contrast(1.08)":"drop-shadow(0 5px 8px rgba(0,0,0,0.48)) saturate(0.98) contrast(1.04)",eu=kt?.99:fe?.96:.9,Jo=!!(ye&&ye.crustBlendMode!=="off"&&ye.crustBlendOpacity>0),Zo=!!(ye&&ye.tintBlendMode!=="off"&&ye.tintOpacity>0),el=ye?.crustBlendMode!=="off"?ye?.crustBlendMode:void 0,Ea=ye?.tintBlendMode!=="off"?ye?.tintBlendMode:void 0,so=qt-Et*Fe,wa=zt-nt*Ze,ao=uT(E.id),tl=`mountain-ground-gradient-${e.floor}-${ao}`,nl=`mountain-ground-mask-${e.floor}-${ao}`,il=`mountain-tint-filter-${e.floor}-${ao}`;return m.jsxs(m.Fragment,{children:[(Jo||Zo)&&m.jsxs("defs",{children:[Jo&&m.jsxs(m.Fragment,{children:[m.jsxs("linearGradient",{id:tl,x1:"0",y1:"0",x2:"0",y2:"1",children:[m.jsx("stop",{offset:"0%",stopColor:"#ffffff",stopOpacity:"0"}),m.jsx("stop",{offset:"42%",stopColor:"#ffffff",stopOpacity:"0.04"}),m.jsx("stop",{offset:"64%",stopColor:"#ffffff",stopOpacity:"0.42"}),m.jsx("stop",{offset:"82%",stopColor:"#ffffff",stopOpacity:"0.82"}),m.jsx("stop",{offset:"100%",stopColor:"#ffffff",stopOpacity:"1"})]}),m.jsx("mask",{id:nl,maskUnits:"userSpaceOnUse",maskContentUnits:"userSpaceOnUse",children:m.jsx("rect",{x:so,y:wa,width:Et,height:nt,fill:`url(#${tl})`})})]}),Zo&&m.jsx("filter",{id:il,x:"-10%",y:"-10%",width:"120%",height:"120%",children:m.jsx("feColorMatrix",{type:"matrix",values:ye?.tintMatrixValues})})]}),m.jsx("image",{href:E.asset.path,x:so,y:wa,width:Et,height:nt,preserveAspectRatio:"xMidYMid meet",opacity:eu,style:{filter:Zc}}),Jo&&m.jsx("image",{href:E.asset.path,x:so,y:wa,width:Et,height:nt,preserveAspectRatio:"xMidYMid meet",opacity:Math.min(.9,ye?.crustBlendOpacity||0),mask:`url(#${nl})`,style:{mixBlendMode:el,filter:"brightness(0.92) saturate(0.76) contrast(1.03)"}}),Zo&&m.jsx("image",{href:E.asset.path,x:so,y:wa,width:Et,height:nt,preserveAspectRatio:"xMidYMid meet",opacity:Math.min(.95,ye?.tintOpacity||0),filter:`url(#${il})`,style:{mixBlendMode:Ea}})]})})()]},E.id)}return E.fallback==="shrine"?m.jsxs("g",{transform:`translate(${B},${z})`,children:[m.jsx("polygon",{points:"0,-18 8,-4 5,12 -5,12 -8,-4",fill:"#f97316",stroke:"#fff",strokeWidth:"1",opacity:"0.9"}),m.jsx("polygon",{points:"-2,-14 2,-14 1,-2 -1,-2",fill:"rgba(255,255,255,0.6)"}),m.jsx("circle",{cx:"0",cy:"0",r:"14",fill:"none",stroke:"#fdba74",strokeWidth:"2",opacity:"0.4",style:{animation:"shrineGlow 2s ease-in-out infinite"}})]},E.id):m.jsxs("g",{transform:`translate(${B},${z})`,children:[m.jsx("rect",{x:"-12",y:"6",width:"8",height:"4",fill:"#1f2937",rx:"1"}),m.jsx("rect",{x:"-6",y:"2",width:"8",height:"4",fill:"#374151",rx:"1"}),m.jsx("rect",{x:"0",y:"-2",width:"8",height:"4",fill:"#4b5563",rx:"1"}),m.jsx("rect",{x:"6",y:"-6",width:"8",height:"4",fill:"#6b7280",rx:"1"}),m.jsx("path",{d:"M 2 -14 L 2 -20 L -4 -20 L 2 -26 L 8 -20 L 2 -20",fill:"#22c55e",stroke:"#16a34a",strokeWidth:"1"})]},E.id)})}),m.jsxs("g",{children:[e.lastSpearPath&&e.lastSpearPath.length>=2&&(()=>{const B=e.lastSpearPath.map(z=>ut(z,se)).map((z,le)=>`${le===0?"M":"L"} ${z.x} ${z.y}`).join(" ");return m.jsx("path",{d:B,stroke:"rgba(255, 255, 255, 0.15)",strokeWidth:"2",fill:"none",strokeDasharray:"4 2",strokeLinecap:"round"})})(),e.spearPosition&&m.jsx(Nc,{entity:{id:"spear",type:"player",subtype:"footman",position:e.spearPosition,hp:1,maxHp:1,statusEffects:[],temporaryArmor:0,activeSkills:[],speed:0,factionId:"player"},isSpear:!0}),m.jsx(Nc,{entity:e.player,movementTrace:$t[e.player.id],waapiControlled:!0,assetHref:dn.get(zc(e.player))?.path,fallbackAssetHref:pf(e.player),floorTheme:Ue},`player-${e.floor}`),e.enemies.map(E=>m.jsx(Nc,{entity:E,movementTrace:$t[E.id],waapiControlled:!0,assetHref:dn.get(zc(E))?.path,fallbackAssetHref:pf(E),floorTheme:Ue},`${E.id}-${e.floor}`)),e.dyingEntities?.map(E=>m.jsx(Nc,{entity:E,isDying:!0,movementTrace:$t[E.id],waapiControlled:!0,assetHref:dn.get(zc(E))?.path,fallbackAssetHref:pf(E),floorTheme:Ue},`dying-${E.id}-${e.floor}-${e.turnNumber}`)),m.jsx(zA,{visualEvents:e.visualEvents||[],timelineEvents:e.timelineEvents||[],simulationEvents:e.simulationEvents||[],actorSnapshots:mr,onBusyStateChange:C,assetManifest:r})]}),m.jsx("g",{"data-layer":"interaction-ui-grid",pointerEvents:"none",shapeRendering:"crispEdges",children:De.map(E=>{const{x:B,y:z}=ut(E,se);return m.jsx("g",{transform:`translate(${B},${z})`,children:m.jsx("polygon",{points:Xo,fill:"none",stroke:"rgba(201,224,255,0.12)",strokeWidth:.9})},`grid-${he(E)}`)})}),m.jsx("g",{"data-layer":"ui-objective-markers",pointerEvents:"none",children:eo.map(E=>{const{x:B,y:z}=ut(E.position,se),le=E.kind==="shrine",re=le?"#c2410c":"#15803d",fe=le?"S":"E",ye=B+se*.52,Fe=z-se*.52;return m.jsxs("g",{transform:`translate(${ye},${Fe})`,children:[m.jsx("circle",{r:14,fill:"none",stroke:"rgba(255,255,255,0.55)",strokeWidth:2,style:{animation:`shrineGlow ${le?1.6:1.9}s ease-in-out infinite`}}),m.jsx("circle",{r:10.5,fill:re,stroke:"#ffffff",strokeWidth:2}),m.jsx("text",{x:0,y:0,textAnchor:"middle",dy:".34em",fill:"#ffffff",fontSize:10,fontWeight:900,style:{textShadow:"0 1px 2px rgba(0,0,0,0.7)"},children:fe})]},`marker-${E.id}`)})})]}),m.jsx("div",{className:"absolute top-2 right-2 sm:top-3 sm:right-3 z-30 flex items-center gap-1.5 pointer-events-auto",children:m.jsxs("div",{className:"flex items-center gap-1 rounded-xl border border-white/15 bg-black/35 backdrop-blur-sm p-1",children:[JA.map(E=>{const B=Y===E;return m.jsx("button",{type:"button",onPointerDown:z=>z.stopPropagation(),onClick:()=>us(E),className:`px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest transition-colors ${B?"bg-white text-black":"bg-white/5 text-white/70 hover:bg-white/10"}`,"aria-label":`Set zoom to ${E} tiles wide`,children:E},`zoom-${E}`)}),m.jsx("button",{type:"button",onPointerDown:E=>E.stopPropagation(),onClick:dr,className:"px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest bg-white/5 text-white/70 hover:bg-white/10","aria-label":"Reset camera to player",children:"Fit"})]})})]})},dT=({gameState:e})=>{const{initiativeQueue:i,player:a,enemies:o}=e;if(!i||!i.entries||i.entries.length===0)return null;const c=i.entries.map(r=>r.actorId===a.id?a:o.find(f=>f.id===r.actorId)).filter(r=>!!r);return m.jsxs("div",{className:"flex flex-col gap-2 p-4 bg-white/5 border border-white/10 rounded-2xl backdrop-blur-md",children:[m.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-1",children:"Turn Sequence"}),m.jsx("div",{className:"flex items-center gap-3 overflow-x-auto pb-2 scrollbar-none",children:c.map((r,f)=>{const h=r.id===a.id,b=f===i.currentIndex,A=i.entries.find(v=>v.actorId===r.id)?.hasActed;return m.jsxs("div",{className:`flex flex-col items-center shrink-0 transition-all duration-300 ${b?"scale-110":"opacity-60 scale-90"}`,children:[m.jsxs("div",{className:`
                                w-10 h-10 rounded-xl flex items-center justify-center border-2 transition-all relative
                                ${h?"bg-blue-500/20 border-blue-500/50":"bg-red-500/20 border-red-500/50"}
                                ${b?"shadow-[0_0_15px_rgba(255,255,255,0.2)] border-white/80":""}
                                ${A?"grayscale":""}
                            `,children:[m.jsx("span",{className:"text-xl",children:or(r.subtype,r.type,r.enemyType,r.archetype).icon}),b&&m.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-white rounded-full animate-ping"}),A&&!b&&m.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center border-2 border-[#030712] text-[8px]",children:""})]}),m.jsx("div",{className:"w-8 h-1 bg-white/10 rounded-full mt-2 overflow-hidden",children:m.jsx("div",{className:`h-full ${h?"bg-blue-400":"bg-red-400"}`,style:{width:`${r.hp/r.maxHp*100}%`}})}),m.jsx("span",{className:`text-[8px] font-bold uppercase mt-1 ${h?"text-blue-300":"text-red-300"} ${b?"text-white":""}`,children:h?"You":r.subtype||"Enemy"})]},`${r.id}-${f}`)})})]})},fT=({gameState:e,onReset:i,onWait:a,onExitToHub:o,inputLocked:c=!1,compact:r=!1,hideInitiativeQueue:f=!1,hideLog:h=!1})=>{const b=By(e),y=Array.isArray(e.message)?e.message:[],A=$i.useRef(null),[v,S]=$i.useState("all"),[_,p]=$i.useState("all"),g=(C,M)=>{const N=C||"",Y=N.toLowerCase(),X=N.match(/^\[(INFO|VERBOSE|DEBUG|CRITICAL)\|([A-Z_]+)\]\s*(.*)$/i);if(X){const K=X[1].toLowerCase(),ue=X[2].toLowerCase(),W=X[3]||"",_e=ue.includes("combat")?"combat":ue.includes("hazard")?"hazard":ue.includes("objective")||ue.includes("score")?"objective":ue.includes("ai")?"ai":"system";return{idx:M,raw:C,text:W,level:K,channel:_e}}const O=/(attacked|killed|blast|stunned|damage|hit|healed|shield|bash|spear|fireball|jump|dash)/i.test(Y)?"combat":/(lava|burn|hazard|void|sink|fire damage)/i.test(Y)?"hazard":/(score|objective|floor|stairs|descending|arcade cleared)/i.test(Y)?"objective":/(enemy|falcon|intent|telegraph|moves to|repositioning|attacks)/i.test(Y)?"ai":"system",q=/(fallen|warning|error|failed|invalid|blocked|cannot)/i.test(Y)?"critical":/(debug|trace|telemetry|seed|counter|rng)/i.test(Y)?"debug":/(marks the impact zone|telegraph|planning|intent)/i.test(Y)?"verbose":"info";return{idx:M,raw:C,text:N,level:q,channel:O}},R=$i.useMemo(()=>y.map((C,M)=>g(C,M)),[y]),I=$i.useMemo(()=>R.filter(C=>(v==="all"||C.level===v)&&(_==="all"||C.channel===_)),[R,v,_]);return $i.useEffect(()=>{A.current&&(A.current.scrollTop=A.current.scrollHeight)},[I]),m.jsxs("div",{className:"flex flex-col h-full max-h-screen",children:[m.jsxs("div",{className:`flex flex-col overflow-y-auto flex-1 min-h-0 ${r?"gap-4 p-4":"gap-8 p-8"}`,children:[m.jsxs("div",{className:"flex justify-between items-start",children:[m.jsxs("div",{children:[m.jsx("h1",{className:`${r?"text-base":"text-xl"} font-black uppercase tracking-widest text-white/90 mb-1`,children:"Hoplite"}),m.jsx("p",{className:"text-[10px] font-bold text-white/30 uppercase tracking-[0.2em]",children:"Tactical Arena"})]}),m.jsx("div",{className:`px-2 py-1 bg-white/10 rounded border border-white/20 text-[10px] font-black text-white/60 ${r?"hidden sm:block":""}`,children:"V2.1.0"})]}),!f&&m.jsx(dT,{gameState:e}),m.jsxs("div",{className:r?"space-y-4":"space-y-6",children:[m.jsxs("div",{className:"flex flex-col",children:[m.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-2",children:"Vitality"}),m.jsxs("div",{className:"flex items-end gap-2",children:[m.jsx("span",{className:`${r?"text-3xl":"text-4xl"} font-black text-red-500 leading-none`,children:e.player.hp}),m.jsx("span",{className:"text-xl text-white/20 font-bold leading-none mb-1",children:"/"}),m.jsx("span",{className:"text-xl text-gray-500 font-bold leading-none mb-1",children:e.player.maxHp})]})]}),m.jsxs("div",{className:"flex flex-col",children:[m.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-2",children:"Guardian Plating"}),m.jsxs("div",{className:"flex items-center gap-3",children:[m.jsx("div",{className:`w-3 h-3 rounded-sm ${e.player.temporaryArmor?"bg-blue-400 rotate-45":"bg-white/5 border border-white/10"}`}),m.jsx("span",{className:"text-2xl font-black text-blue-400 leading-none",children:e.player.temporaryArmor||0})]})]}),e.enemies.filter(C=>C.subtype==="sentinel").map(C=>m.jsxs("div",{className:"pt-4 animate-in slide-in-from-right-8 duration-500",children:[m.jsxs("div",{className:"flex justify-between items-end mb-2",children:[m.jsx("span",{className:"text-xs font-black text-red-500 uppercase tracking-tighter italic",children:"Sentinel Directive"}),m.jsxs("span",{className:"text-lg font-black",children:[C.hp," ",m.jsxs("span",{className:"text-white/20 text-xs",children:["/ ",C.maxHp]})]})]}),m.jsx("div",{className:"h-4 w-full bg-red-950/30 rounded-md border border-red-500/20 overflow-hidden",children:m.jsx("div",{className:"h-full bg-gradient-to-r from-red-600 to-red-400 shadow-[0_0_20px_rgba(239,68,68,0.4)] transition-all duration-300",style:{width:`${C.hp/C.maxHp*100}%`}})})]},C.id))]}),m.jsxs("div",{className:`${r?"py-4 space-y-4":"py-8 space-y-6"} border-y border-white/5`,children:[m.jsxs("div",{className:"flex flex-col gap-3",children:[m.jsxs("div",{className:"flex justify-between items-center",children:[m.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold",children:"Arcade Progress"}),m.jsxs("span",{className:"text-xl font-black",children:[e.floor," ",m.jsx("span",{className:"text-white/20 text-sm",children:"/ 10"})]})]}),m.jsx("div",{className:"h-1.5 w-full bg-white/5 rounded-full overflow-hidden border border-white/5",children:m.jsx("div",{className:"h-full bg-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.4)] transition-all duration-1000 ease-out",style:{width:`${e.floor/10*100}%`}})})]}),m.jsxs("div",{className:"flex justify-between items-center",children:[m.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold",children:"Current Score"}),m.jsx("span",{className:"text-xl font-black text-white",children:b.toLocaleString()})]})]}),m.jsxs("div",{className:`flex flex-col ${r?"gap-2":"gap-3"}`,children:[m.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold mb-1",children:"Directives"}),m.jsxs("button",{disabled:c,onClick:a,className:`w-full flex justify-between items-center ${r?"px-3 py-2.5":"px-4 py-3"} border rounded-xl transition-all group ${c?"bg-white/[0.03] border-white/5 text-white/30 cursor-not-allowed opacity-50":"bg-white/5 hover:bg-white/10 border-white/10"}`,children:[m.jsx("span",{className:"text-sm font-bold text-white/70",children:"Secure & Wait"}),m.jsx("span",{className:"text-lg grayscale group-hover:grayscale-0 transition-all",children:""})]}),m.jsxs("button",{onClick:i,className:`w-full flex justify-between items-center ${r?"px-3 py-2.5":"px-4 py-3"} bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 rounded-xl transition-all group`,children:[m.jsx("span",{className:"text-sm font-bold text-red-400/80",children:"Reset Chronology"}),m.jsx("span",{className:"text-lg grayscale group-hover:grayscale-0 transition-all",children:""})]}),m.jsxs("button",{onClick:o,className:`w-full flex justify-between items-center ${r?"px-3 py-2.5":"px-4 py-3"} bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl transition-all group`,children:[m.jsx("span",{className:"text-sm font-bold text-white/70",children:"Return to Hub"}),m.jsx("span",{className:"text-lg grayscale group-hover:grayscale-0 transition-all",children:""})]})]})]}),!h&&y.length>0&&m.jsxs("div",{className:`${r?"p-4":"p-8"} border-t border-white/5 bg-[#030712]/80 backdrop-blur-sm`,children:[m.jsxs("div",{className:"flex items-center justify-between mb-3",children:[m.jsx("span",{className:"text-[10px] uppercase tracking-widest text-white/40 font-bold block",children:"Tactical Log"}),m.jsxs("div",{className:`items-center gap-2 ${r?"hidden sm:flex":"flex"}`,children:[m.jsxs("select",{value:_,onChange:C=>p(C.target.value),className:"text-[10px] bg-white/5 border border-white/10 rounded px-2 py-1 text-white/80",children:[m.jsx("option",{value:"all",children:"All Channels"}),m.jsx("option",{value:"combat",children:"Combat"}),m.jsx("option",{value:"hazard",children:"Hazard"}),m.jsx("option",{value:"objective",children:"Objective"}),m.jsx("option",{value:"ai",children:"AI"}),m.jsx("option",{value:"system",children:"System"})]}),m.jsxs("select",{value:v,onChange:C=>S(C.target.value),className:"text-[10px] bg-white/5 border border-white/10 rounded px-2 py-1 text-white/80",children:[m.jsx("option",{value:"all",children:"All Levels"}),m.jsx("option",{value:"info",children:"Info"}),m.jsx("option",{value:"verbose",children:"Verbose"}),m.jsx("option",{value:"debug",children:"Debug"}),m.jsx("option",{value:"critical",children:"Critical"})]})]})]}),m.jsxs("div",{ref:A,className:"flex flex-col gap-2 bg-white/[0.02] border border-white/5 p-4 rounded-2xl overflow-y-auto max-h-[140px]",children:[I.slice(-20).map(C=>m.jsxs("div",{className:"flex gap-2 items-start",children:[m.jsxs("span",{className:"text-[10px] text-white/20 font-bold mt-1 leading-none shrink-0",children:["[",C.idx,"]"]}),m.jsx("span",{className:`text-[9px] mt-1 px-1.5 py-0.5 rounded border shrink-0 ${C.level==="critical"?"text-red-300 border-red-400/40 bg-red-500/10":C.level==="debug"?"text-cyan-300 border-cyan-400/40 bg-cyan-500/10":C.level==="verbose"?"text-amber-300 border-amber-400/40 bg-amber-500/10":"text-white/60 border-white/20 bg-white/5"}`,children:C.level.toUpperCase()}),m.jsx("span",{className:"text-[9px] mt-1 px-1.5 py-0.5 rounded border border-white/20 bg-white/5 text-white/60 shrink-0",children:C.channel.toUpperCase()}),m.jsx("p",{className:"text-[11px] leading-tight text-white/70 font-medium whitespace-pre-wrap",children:C.text})]},C.idx)),I.length===0&&m.jsx("div",{className:"text-[11px] text-white/40 italic",children:"No messages match current filters."})]})]})]})},mT=({onSelect:e,gameState:i})=>{const a=i.player,c=(i.pendingStatus?.shrineOptions||i.shrineOptions||["EXTRA_HP"]).map(r=>{if(r==="EXTRA_HP")return{id:"EXTRA_HP",label:"Extra Heart",desc:"Increases your Max HP by 1 and heals you to full.",color:"bg-red-900/40 border-red-500"};const f=Ln.getUpgrade(r),h=Ln.getSkillForUpgrade(r),b=a.activeSkills?.find(A=>A.id===h),y=b?.slot==="offensive"?"bg-orange-900/40 border-orange-500":b?.slot==="defensive"?"bg-blue-900/40 border-blue-500":"bg-green-900/40 border-green-500";return{id:r,label:f?f.name:r,desc:f?.description||"Unknown upgrade.",color:y}});return m.jsx("div",{className:"fixed inset-0 bg-slate-950/90 backdrop-blur-md flex items-center justify-center z-[100] p-4",children:m.jsxs("div",{className:"bg-gray-900 p-8 rounded-3xl border-2 border-slate-700 max-w-2xl w-full shadow-2xl relative overflow-hidden",children:[m.jsx("div",{className:"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 via-blue-500 to-green-500"}),m.jsx("h2",{className:"text-4xl font-black text-white mb-2 text-center tracking-tight",children:"SHRINE BLESSING"}),m.jsx("p",{className:"text-slate-400 mb-8 text-center text-lg",children:"The gods offer you a choice. Choose wisely."}),m.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:c.map(r=>m.jsxs("button",{onClick:()=>e(r.id),className:`
                                relative p-6 border-2 rounded-2xl text-left transition-all group overflow-hidden
                                hover:scale-[1.02] active:scale-[0.98]
                                ${r.color} hover:bg-slate-800
                            `,children:[m.jsx("h3",{className:"text-xl font-bold text-white mb-2 group-hover:text-blue-200",children:r.label}),m.jsx("p",{className:"text-sm text-slate-400 group-hover:text-slate-300 leading-relaxed",children:r.desc}),m.jsx("div",{className:"absolute -right-2 -bottom-2 opacity-0 group-hover:opacity-10 scale-0 group-hover:scale-150 transition-all font-bold text-4xl",children:"*"})]},r.id))})]})})},xy=({skills:e,selectedSkillId:i,onSelectSkill:a,hasSpear:o,gameState:c,inputLocked:r=!1,compact:f=!1})=>{const h=["offensive","defensive","utility"];return m.jsx("div",{className:f?"grid grid-cols-3 gap-2 sm:grid-cols-4":"flex flex-col gap-4",children:h.flatMap(b=>e.filter(A=>A.slot===b).map(A=>{const v=i===A.id,S=A.currentCooldown>0,_=A.id==="SPEAR_THROW",p=r||S&&!_||_&&!o,g=O1(A.id),R=g?.name||A.name,I=typeof R=="function"?R(c):R,C=g?.icon||"";return m.jsxs("button",{disabled:p,onClick:()=>a(v?null:A.id),className:`
                            relative w-full ${f?"h-20 rounded-xl gap-0.5":"h-24 rounded-2xl gap-1"} flex flex-col items-center justify-center
                            border transition-all transform hover:translate-x-1
                            ${v?"bg-blue-600 border-white shadow-[0_0_20px_rgba(59,130,246,0.5)]":"bg-white/5 border-white/10 hover:border-blue-500/50"}
                            ${p?"opacity-40 grayscale pointer-events-none":"cursor-pointer"}
                        `,children:[m.jsx("span",{className:f?"text-2xl":"text-3xl",children:C}),m.jsx("span",{className:`${f?"text-[9px] tracking-[0.12em]":"text-[10px] tracking-widest"} uppercase font-bold text-white/50 text-center px-2 leading-tight`,children:I}),S&&!_&&m.jsx("div",{className:`absolute inset-0 flex items-center justify-center bg-black/40 ${f?"rounded-xl":"rounded-2xl"} backdrop-blur-[2px]`,children:m.jsx("span",{className:`${f?"text-2xl":"text-3xl"} font-black text-white`,children:A.currentCooldown})}),m.jsx("div",{className:`absolute ${f?"-top-1 left-2 px-1.5":"-top-2 left-4 px-2"} py-0.5 bg-[#030712] rounded-full border border-white/10 text-[8px] uppercase font-black tracking-widest text-white/40`,children:b})]},A.id)}))})},pT=({onSelect:e})=>m.jsxs("div",{className:"relative z-50 flex flex-col items-center justify-center p-8 gap-8 animate-in fade-in zoom-in duration-500",children:[m.jsxs("div",{className:"text-center space-y-2",children:[m.jsx("h1",{className:"text-4xl font-black uppercase tracking-widest text-white mb-2",children:"Select Class"}),m.jsx("p",{className:"text-white/40 text-sm uppercase tracking-wider",children:"Choose your combat doctrine"})]}),m.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl",children:Object.values(Uo).map(i=>m.jsxs("button",{onClick:()=>{console.log("Archetype Selected:",i.id),e(i)},className:"group relative flex flex-col items-start p-8 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/30 rounded-3xl transition-all hover:scale-[1.02] text-left cursor-pointer",children:[m.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 rounded-3xl transition-opacity"}),m.jsxs("div",{className:"relative z-10 w-full",children:[m.jsxs("div",{className:"flex justify-between items-start mb-4",children:[m.jsx("div",{className:"p-3 bg-white/5 rounded-xl border border-white/10 group-hover:border-white/30 transition-colors",children:m.jsx("span",{className:"text-3xl",children:or(i.id==="ASSASSIN"?"assassin_player":i.id.toLowerCase(),"player").icon})}),m.jsx("div",{className:"px-3 py-1 bg-white/5 rounded-full border border-white/10 text-[10px] font-bold uppercase tracking-widest text-white/50",children:i.id==="VANGUARD"?"Standard":"Advanced"})]}),m.jsx("h3",{className:"text-2xl font-black uppercase tracking-wide text-white mb-2",children:i.name}),m.jsx("p",{className:"text-white/60 text-sm leading-relaxed mb-6 h-12",children:i.description}),m.jsxs("div",{className:"space-y-3",children:[m.jsx("div",{className:"text-[10px] uppercase tracking-widest text-white/30 font-bold border-b border-white/5 pb-1",children:"Starting Loadout"}),m.jsx("div",{className:"flex flex-wrap gap-2",children:i.startingSkills.map(a=>m.jsx("div",{className:"px-2 py-1 bg-black/40 rounded border border-white/10 text-[10px] text-blue-200",children:a.replace("_"," ")},a))})]})]})]},i.id))})]}),hT="hop_replays_v1",gT="hop_leaderboard_v1",vy=()=>{try{const e=localStorage.getItem(hT);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load replays",e),[]}},Sy=()=>{try{const e=localStorage.getItem(gT);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load leaderboard",e),[]}},Ay=e=>{const i=Array.isArray(e.actions)?e.actions:[],a=new Set(i.map(y=>y?.type)),o=a.has("ADVANCE_TURN"),c=a.has("RESOLVE_PENDING"),r=(e.floor||0)>=5&&i.length<Math.max(25,(e.floor||0)*4),f=(e.replayVersion??1)<2,h=i.length===0,b=h?"invalid replay":r?"truncated replay":f?"legacy replay":null;return{isLegacy:f,invalid:h,suspicious:r||e.floor>1&&!c,label:b,hasTurnAdvance:o,hasPendingResolve:c,actionCount:i.length}},Ty=({onStartReplay:e})=>{const[i,a]=w.useState(()=>vy()),[o,c]=w.useState(()=>Sy()),[r,f]=w.useState(""),[h,b]=w.useState(""),[y,A]=w.useState(""),[v,S]=w.useState(null);w.useEffect(()=>{const g=()=>{a(vy()),c(Sy())};return window.addEventListener("storage",g),()=>window.removeEventListener("storage",g)},[]);const _=()=>{S(null);try{const g=y.trim();if(!g)return S("Paste actions JSON first."),null;const R=JSON.parse(g);let I=r.trim()||void 0,C=h.trim()||void 0,M=[];return Array.isArray(R)?M=R:R&&typeof R=="object"&&(M=Array.isArray(R.actions)?R.actions:[],I=I||(typeof R.seed=="string"?R.seed:void 0),C=C||(typeof R.loadoutId=="string"?R.loadoutId:void 0)),!Array.isArray(M)||M.length===0?(S('No actions found. Provide a JSON action array or object with "actions".'),null):M.filter(X=>X&&typeof X.type=="string").length===0?(S('Actions must be objects with a "type" field.'),null):{id:`manual-${Date.now()}`,seed:I,loadoutId:C,actions:M,score:0,floor:1,date:new Date().toISOString(),replayVersion:2,diagnostics:{actionCount:M.length,hasTurnAdvance:M.some(X=>X?.type==="ADVANCE_TURN"),hasPendingResolve:M.some(X=>X?.type==="RESOLVE_PENDING"),suspiciouslyShort:!1}}}catch(g){return S(`Invalid JSON: ${g?.message||"parse error"}`),null}},p=()=>{const g=_();g&&e(g)};return m.jsxs("div",{className:"flex flex-col gap-8",children:[m.jsxs("section",{children:[m.jsxs("div",{className:"flex items-center justify-between mb-4",children:[m.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-emerald-400",children:"Manual Replay"}),m.jsx("span",{className:"text-[10px] text-white/20 font-bold uppercase tracking-widest",children:"Paste from UPA"})]}),m.jsxs("div",{className:"space-y-2 p-3 rounded-2xl border border-white/5 bg-white/[0.02]",children:[m.jsx("input",{value:r,onChange:g=>f(g.target.value),placeholder:"Seed (optional if included in JSON)",className:"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-emerald-400/40"}),m.jsx("input",{value:h,onChange:g=>b(g.target.value),placeholder:"Loadout ID (optional)",className:"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-emerald-400/40"}),m.jsx("textarea",{value:y,onChange:g=>A(g.target.value),placeholder:'Paste JSON actions array, or object: {"seed":"...","loadoutId":"...","actions":[...]}',rows:6,className:"w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-emerald-400/40 font-mono"}),v&&m.jsx("div",{className:"text-[10px] text-red-400 font-bold uppercase tracking-wider",children:v}),m.jsx("button",{onClick:p,className:"w-full py-2 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-400/30 text-emerald-300 text-xs font-black uppercase tracking-widest transition-colors",children:"Start Manual Replay"})]})]}),m.jsxs("section",{children:[m.jsxs("div",{className:"flex items-center justify-between mb-4",children:[m.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400",children:"Hall of Fame"}),m.jsx("span",{className:"text-[10px] text-white/20 font-bold uppercase tracking-widest",children:"Top 5 Only"})]}),m.jsxs("div",{className:"space-y-2",children:[o.length===0&&m.jsx("div",{className:"p-4 rounded-xl border border-white/5 bg-white/[0.02] text-center",children:m.jsx("span",{className:"text-[10px] text-white/30 uppercase font-black",children:"No Champions Yet"})}),o.slice(0,5).map((g,R)=>{const I={id:g.id,seed:g.seed,loadoutId:g.loadoutId,actions:g.actions||[],score:g.score,floor:g.floor,date:g.date,replayVersion:g.replayVersion,diagnostics:g.diagnostics},C=Ay(I);return m.jsxs("button",{onClick:()=>e(I),className:"w-full group relative flex items-center gap-4 p-4 bg-white/[0.03] hover:bg-white/[0.07] border border-white/5 hover:border-indigo-500/30 rounded-2xl transition-all text-left",children:[m.jsx("div",{className:"flex-shrink-0 w-8 h-8 flex items-center justify-center bg-indigo-500/10 rounded-lg text-indigo-400 font-black text-sm border border-indigo-500/20",children:R+1}),m.jsxs("div",{className:"flex-1 min-w-0",children:[m.jsxs("div",{className:"flex justify-between items-center mb-0.5",children:[m.jsx("span",{className:"font-black text-white uppercase text-xs truncate tracking-wider",children:g.name}),m.jsx("span",{className:"text-[10px] font-black text-indigo-400 tabular-nums",children:g.score.toLocaleString()})]}),m.jsxs("div",{className:"text-[9px] text-white/30 font-bold uppercase tracking-widest",children:["Floor ",g.floor," * ",new Date(g.date).toLocaleDateString()," * ",C.actionCount," acts"]}),C.label&&m.jsx("div",{className:"text-[9px] mt-1 text-amber-400/80 font-bold uppercase tracking-widest",children:C.label})]}),m.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity text-indigo-400 text-xs",children:"Play"})]},g.id)})]})]}),m.jsxs("section",{children:[m.jsx("div",{className:"flex items-center justify-between mb-4",children:m.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-white/30",children:"Recent Simulations"})}),m.jsxs("div",{className:"space-y-1 max-h-[300px] overflow-y-auto custom-scrollbar pr-2",children:[i.length===0&&m.jsx("div",{className:"text-center py-4",children:m.jsx("span",{className:"text-[10px] text-white/10 uppercase font-bold",children:"Log Empty"})}),i.slice(0,10).map(g=>{const R=Ay(g);return m.jsxs("button",{onClick:()=>e(g),className:"w-full flex items-center justify-between p-3 hover:bg-white/[0.04] rounded-xl transition-colors text-left group",children:[m.jsxs("div",{className:"min-w-0",children:[m.jsxs("div",{className:"text-[10px] font-bold text-white/60 mb-0.5 truncate uppercase",children:["Score: ",m.jsx("span",{className:"text-white",children:g.score})," * F",g.floor," * ",R.actionCount," acts"]}),m.jsx("div",{className:"text-[9px] text-white/20 font-medium",children:new Date(g.date).toLocaleTimeString()}),R.label&&m.jsx("div",{className:"text-[9px] mt-1 text-amber-400/80 font-bold uppercase tracking-widest",children:R.label})]}),m.jsx("div",{className:"text-[10px] text-white/0 group-hover:text-white/40 font-black uppercase tracking-widest transition-all",children:"Replay"})]},g.id)})]})]})]})};class yT{state;constructor(){this.state=Cs(1,"tutorial-seed"),this.state.enemies=[],this.state.tiles=new Map}setPlayer(i,a){this.state.player={...this.state.player,position:i,previousPosition:i,activeSkills:a.map(o=>{const c=Ln.get(o);return{id:o,name:typeof c?.name=="function"?c.name(this.state):c?.name||o,description:c?.description||"",slot:c?.slot||"offensive",cooldown:c?.baseVariables.cooldown||0,currentCooldown:0,range:c?.baseVariables.range||0,upgrades:Object.keys(c?.upgrades||{}),activeUpgrades:[]}})}}spawnEnemy(i,a,o){const c=Sf[i]||{hp:1,maxHp:1};this.state.enemies.push({id:o,type:"enemy",subtype:i,position:a,previousPosition:a,hp:c.hp,maxHp:c.maxHp,enemyType:c.type||"melee",statusEffects:[],temporaryArmor:0,activeSkills:[],speed:c.speed||1,factionId:"enemy"})}spawnFalcon(i,a){const o={id:a,type:"enemy",subtype:"falcon",factionId:"player",speed:95,position:{...i},previousPosition:{...i},hp:1,maxHp:1,statusEffects:[],temporaryArmor:0,activeSkills:[],isFlying:!0,companionOf:"player",companionState:{mode:"roost",orbitStep:0,apexStrikeCooldown:0}};this.state.enemies.push(o),this.state.companions||(this.state.companions=[]),this.state.companions.push(o)}spawnCompanion(i,a,o){i==="falcon"&&this.spawnFalcon(a,o)}setTile(i,a){const o=a.toUpperCase(),c=he(i),r=Ho[o];if(!r){console.warn(`Attempted to set unknown tile type: ${o}`);return}this.state.tiles.set(c,{baseId:o,position:i,traits:new Set(r.defaultTraits||[]),effects:[],occupantId:void 0})}addUpgrade(i,a){this.state.player.activeSkills=(this.state.player.activeSkills||[]).map(o=>o.id===i?{...o,activeUpgrades:[...o.activeUpgrades,a]}:o)}useSkill(i,a){}wait(){}move(i){}getEnemy(i){return this.state.enemies.find(a=>a.id===i)}setTurn(i){this.state.turnNumber=i}exitToHub(){}applyStatus(i,a){const o=this.state.enemies.findIndex(c=>c.id===i);o!==-1&&(this.state.enemies[o]=Af(this.state.enemies[o],a,1))}}const Ey=({onLoadScenario:e})=>{const i=Object.values(Qc),a=o=>{const c=new yT;o.setup(c),c.state.initiativeQueue=Wa(c.state),e(c.state,o.description)};return m.jsx("div",{className:"flex flex-col gap-4",children:i.map(o=>m.jsxs("div",{className:"flex flex-col gap-2",children:[m.jsx("h4",{className:"text-[10px] font-bold uppercase tracking-wider text-white/50",children:typeof o.name=="function"?o.name(Cs(1,"temp")):o.name}),m.jsx("div",{className:"flex flex-col gap-1",children:o.scenarios?.map(c=>m.jsx("button",{onClick:()=>a(c),className:"text-left px-3 py-2 bg-white/5 hover:bg-white/10 rounded text-xs text-white/80 transition-colors border border-transparent hover:border-white/20",children:c.title},c.id))})]},o.id))})},bT=({gameState:e,onSelectLoadout:i,onStartRun:a,onOpenArcade:o,onLoadScenario:c,onStartReplay:r})=>m.jsxs("div",{className:"w-full h-full flex flex-col bg-[#020617]",children:[m.jsx("header",{className:"border-b border-white/5 px-4 sm:px-6 lg:px-12 py-3 sm:py-4 bg-[#030712]/50 backdrop-blur-xl z-30",children:m.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[m.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[m.jsx("div",{className:"w-9 h-9 sm:w-10 sm:h-10 bg-indigo-500 rounded-lg flex items-center justify-center font-black text-lg sm:text-xl shadow-[0_0_20px_rgba(99,102,241,0.5)]",children:"H"}),m.jsxs("div",{children:[m.jsxs("h1",{className:"text-base sm:text-lg font-black uppercase tracking-tighter leading-none italic",children:["Hop ",m.jsx("span",{className:"text-indigo-500",children:"Engine"})]}),m.jsx("div",{className:"text-[9px] sm:text-[10px] font-bold text-white/30 tracking-[0.22em] sm:tracking-[0.3em] uppercase mt-1",children:"Strategic Hub v5.0"})]})]}),m.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6 lg:gap-8",children:[m.jsxs("div",{className:"rounded-xl border border-white/10 bg-white/[0.03] px-3 py-2 sm:bg-transparent sm:border-0 sm:p-0",children:[m.jsx("div",{className:"text-[10px] uppercase tracking-widest text-white/40 mb-1",children:"Current Loadout"}),m.jsx("div",{className:"text-sm font-bold text-indigo-400 truncate",children:e.selectedLoadoutId||"No Archetype Selected"})]}),e.selectedLoadoutId&&m.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:flex sm:items-center sm:gap-3",children:[m.jsxs("button",{onClick:()=>a("normal"),className:"px-4 sm:px-6 py-2.5 sm:py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-black uppercase text-xs sm:text-sm tracking-widest transition-all hover:scale-[1.02] active:scale-95 shadow-[0_0_30px_rgba(79,70,229,0.3)] flex flex-col items-center justify-center leading-tight",children:[m.jsx("span",{children:"Start Run"}),m.jsx("span",{className:"hidden sm:block text-[9px] opacity-50 tracking-[0.2em]",children:"10 Floors | Boss Defeat"})]}),m.jsxs("button",{onClick:()=>a("daily"),className:"px-4 sm:px-6 py-2.5 sm:py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-black uppercase text-xs sm:text-sm tracking-widest transition-all hover:scale-[1.02] active:scale-95 shadow-[0_0_30px_rgba(16,185,129,0.3)] flex flex-col items-center justify-center leading-tight",children:[m.jsx("span",{children:"Daily"}),m.jsx("span",{className:"hidden sm:block text-[9px] opacity-50 tracking-[0.2em]",children:"Seeded Challenge"})]})]})]})]})}),m.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden",children:[m.jsx("main",{className:"flex-1 overflow-y-auto p-4 sm:p-6 lg:p-12 custom-scrollbar",children:m.jsxs("div",{className:"max-w-4xl mx-auto",children:[m.jsxs("div",{className:"mb-6 sm:mb-10 lg:mb-12",children:[m.jsx("button",{onClick:o,className:"mb-4 sm:mb-5 w-full sm:w-auto px-5 sm:px-6 py-2.5 sm:py-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-200 font-black uppercase tracking-widest text-xs sm:text-sm transition-all",children:"Arcade Mode"}),m.jsxs("h2",{className:"text-xl sm:text-2xl lg:text-3xl font-black uppercase tracking-tighter mb-2 italic",children:["Select Your ",m.jsx("span",{className:"text-indigo-500",children:"Archetype"})]}),m.jsx("p",{className:"text-sm sm:text-base text-white/40 max-w-xl",children:"Choose your tactical specialty. Each archetype provides unique skills and modifies your core interaction with the engine."})]}),m.jsx(pT,{onSelect:i})]})}),m.jsxs("section",{className:"lg:hidden border-t border-white/5 bg-[#030712]/50 backdrop-blur-sm p-4 sm:p-6 space-y-4",children:[m.jsxs("details",{className:"rounded-2xl border border-white/10 bg-white/[0.02] p-3",children:[m.jsxs("summary",{className:"cursor-pointer list-none flex items-center justify-between",children:[m.jsx("span",{className:"text-[11px] font-black uppercase tracking-[0.2em] text-white/60",children:"Historical Replay"}),m.jsx("span",{className:"text-[10px] text-white/30 uppercase tracking-widest",children:"Optional"})]}),m.jsx("div",{className:"mt-3",children:m.jsx(Ty,{gameState:e,onStartReplay:r})})]}),m.jsxs("details",{className:"rounded-2xl border border-white/10 bg-white/[0.02] p-3",children:[m.jsxs("summary",{className:"cursor-pointer list-none flex items-center justify-between",children:[m.jsx("span",{className:"text-[11px] font-black uppercase tracking-[0.2em] text-white/60",children:"Training Simulations"}),m.jsx("span",{className:"text-[10px] text-white/30 uppercase tracking-widest",children:"Optional"})]}),m.jsx("div",{className:"mt-3",children:m.jsx(Ey,{onLoadScenario:c})})]})]}),m.jsx("aside",{className:"hidden lg:flex w-[450px] border-l border-white/5 bg-[#030712]/80 backdrop-blur-md flex-col z-20",children:m.jsxs("div",{className:"p-8 flex flex-col gap-12 h-full overflow-y-auto custom-scrollbar",children:[m.jsxs("section",{children:[m.jsxs("div",{className:"flex items-center justify-between mb-6",children:[m.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/30",children:"Historical Replay"}),m.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500 animate-pulse"})]}),m.jsx("div",{className:"bg-white/[0.02] border border-white/5 rounded-2xl p-4 overflow-hidden",children:m.jsx(Ty,{gameState:e,onStartReplay:r})})]}),m.jsxs("section",{children:[m.jsxs("div",{className:"flex items-center justify-between mb-6",children:[m.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/30",children:"Training Simulations"}),m.jsx("div",{className:"w-2 h-2 rounded-full bg-indigo-500 animate-pulse"})]}),m.jsx("div",{className:"bg-white/[0.02] border border-white/5 rounded-2xl p-4 overflow-hidden",children:m.jsx(Ey,{onLoadScenario:c})})]}),m.jsx("div",{className:"mt-auto pt-8 border-t border-white/5 opacity-20 hover:opacity-100 transition-opacity",children:m.jsx("div",{className:"text-[10px] font-bold uppercase tracking-[0.4em] mb-2 text-center text-white/50",children:"Engine Status: Online"})})]})})]})]}),xT={VANGUARD:"V",HUNTER:"H",FIREMAGE:"F",NECROMANCER:"N",SKIRMISHER:"S"},wy=e=>{let i=2166136261;for(let a=0;a<e.length;a++)i^=e.charCodeAt(a),i+=(i<<1)+(i<<4)+(i<<7)+(i<<8)+(i<<24);return i>>>0},vT=(e=new Date)=>e.toISOString().slice(0,10),ST=(e,i)=>{if(e.length<2)throw new Error("Arcade mode requires at least two loadouts.");const o=wy(`arcade-a:${i}`)%e.length,c=e[o],r=e.filter(y=>y.id!==c.id),h=wy(`arcade-b:${i}`)%r.length,b=r[h];return[c,b]},AT=({onBack:e,onLaunchArcade:i})=>{const a=$i.useMemo(()=>Object.values(Uo),[]),o=$i.useMemo(()=>vT(),[]),[c,r]=$i.useMemo(()=>ST(a,o),[a,o]);return m.jsxs("div",{className:"w-full h-full flex flex-col bg-[#040a18]",children:[m.jsxs("header",{className:"h-20 border-b border-white/10 flex items-center justify-between px-12 bg-[#050b1f]/80 backdrop-blur-xl z-30",children:[m.jsxs("div",{children:[m.jsxs("h1",{className:"text-xl font-black uppercase tracking-tight italic",children:["Hop ",m.jsx("span",{className:"text-emerald-400",children:"Arcade"})]}),m.jsxs("div",{className:"text-[10px] uppercase tracking-[0.3em] text-white/40 mt-1",children:["Daily Draft ",o]})]}),m.jsx("button",{onClick:e,className:"px-5 py-2.5 rounded-xl border border-white/20 bg-white/5 hover:bg-white/10 text-xs font-black uppercase tracking-widest",children:"Back to Strategic Hub"})]}),m.jsx("main",{className:"flex-1 overflow-y-auto p-12",children:m.jsxs("div",{className:"max-w-5xl mx-auto",children:[m.jsxs("div",{className:"mb-10",children:[m.jsx("h2",{className:"text-4xl font-black uppercase tracking-tight italic mb-3",children:"Arcade Mode"}),m.jsx("p",{className:"text-white/60 max-w-3xl",children:"Pick one of two daily archetypes and run the seeded challenge. Both options share the same seed for fair comparison."})]}),m.jsx("div",{className:"flex flex-col gap-6",children:[c,r].map((f,h)=>{const b=h===1,y=xT[f.id]||f.id.slice(0,1);return m.jsx("button",{onClick:()=>i(f.id),className:"w-full text-left group rounded-3xl border border-white/10 bg-gradient-to-r from-white/[0.06] to-white/[0.02] hover:from-emerald-500/20 hover:to-cyan-500/10 transition-all p-6",children:m.jsxs("div",{className:`flex items-center justify-between gap-6 ${b?"flex-row-reverse":""}`,children:[m.jsxs("div",{className:"flex items-center gap-4 min-w-[200px]",children:[m.jsx("div",{className:`w-20 h-20 rounded-2xl border border-white/15 bg-[#0b1733] flex items-center justify-center text-4xl font-black text-emerald-300 shadow-[0_0_35px_rgba(16,185,129,0.25)] ${b?"-scale-x-100":""}`,children:y}),m.jsxs("div",{children:[m.jsx("div",{className:"text-[10px] uppercase tracking-[0.25em] text-white/40",children:"Daily Archetype"}),m.jsx("div",{className:"text-2xl font-black uppercase tracking-tight",children:f.name})]})]}),m.jsxs("div",{className:"flex-1",children:[m.jsx("div",{className:"text-[10px] uppercase tracking-[0.2em] text-white/40 mb-2",children:"Starting Skills"}),m.jsx("div",{className:"flex flex-wrap gap-2",children:f.startingSkills.slice(0,6).map(A=>m.jsx("span",{className:"text-[10px] px-2 py-1 rounded-full border border-white/20 bg-white/5 font-bold tracking-wide",children:A},A))})]}),m.jsxs("div",{className:"text-right min-w-[150px]",children:[m.jsx("div",{className:"text-[10px] uppercase tracking-[0.25em] text-white/40",children:"Launch"}),m.jsx("div",{className:"text-sm font-black uppercase tracking-widest text-emerald-300 group-hover:text-emerald-200",children:"Start Arcade Run"})]})]})},f.id)})})]})})]})},TT=["catacombs","inferno","throne","frozen","void"],Bc=["off","repeat","cover"],_y="hop_biome_sandbox_settings_v1",sr="/Hop",qa=64,za=192,ii=64,si=512,ET=["normal","multiply","overlay","soft-light","screen","color-dodge"],My=["off","multiply","overlay","soft-light","screen","color-dodge","normal"],wT=["#8b6f4a","#8f4a2e","#5b6d41","#536e8e","#5f5977","#b79a73","#d15a3a","#3e4f3a"],_T=["native","additive","custom"],MT=[{q:1,r:0,s:-1},{q:0,r:1,s:-1},{q:-1,r:1,s:0},{q:-1,r:0,s:1},{q:0,r:-1,s:1},{q:1,r:-1,s:0}],Oy=(e,i)=>`${e.endsWith("/")?e:`${e}/`}${i.replace(/^\/+/,"")}`,Wl=e=>{const i=e.trim();return!i||/^(?:[a-z]+:)?\/\//i.test(i)||i.startsWith("data:")?i:i.startsWith("/")?i.startsWith("/assets/")?Oy(sr,i.slice(1)):i:Oy(sr,i)},Xl=e=>{const i=e.trim();if(!i||/^\/assets\/[a-z0-9/_\-.]+$/i.test(i))return i;const o=`${sr.endsWith("/")?sr:`${sr}/`}assets/`;return i.startsWith(o)?`/assets/${i.slice(o.length)}`:i},Bi=(e,i="#8b6f4a")=>{const a=String(e||"").trim();if(/^#([0-9a-f]{6})$/i.test(a))return a.toLowerCase();if(/^#([0-9a-f]{3})$/i.test(a)){const[r,f,h]=a.slice(1).split("");return`#${r}${r}${f}${f}${h}${h}`.toLowerCase()}return i},OT=e=>{let i=2166136261;for(let a=0;a<e.length;a++)i^=e.charCodeAt(a),i=Math.imul(i,16777619);return i>>>0},Cy=e=>OT(e)/4294967295,l0=e=>e.has("BLOCKS_MOVEMENT")&&e.has("BLOCKS_LOS"),CT=e=>e.has("LAVA")||e.has("FIRE")||e.has("HAZARDOUS")&&e.has("LIQUID"),zf=e=>MT.map(i=>he({q:e.q+i.q,r:e.r+i.r,s:e.s+i.s})),NT=e=>{const i=new Set;for(const[a,o]of e.entries())zf(o.position).some(r=>!e.has(r))&&i.add(a);return i},RT=(e,i,a)=>{const o=new Set,c=[{point:i,depth:0}];for(;c.length>0;){const r=c.shift(),f=he(r.point);if(!o.has(f)&&e.has(f)&&(o.add(f),!(r.depth>=a)))for(const h of zf(r.point)){const b=e.get(h);b&&c.push({point:b.position,depth:r.depth+1})}}return o},yf=(e,i,a)=>{const o=e.get(i);if(!o)return;const c=new Set(Array.from(o.traits));a?(c.add("BLOCKS_MOVEMENT"),c.add("BLOCKS_LOS"),c.delete("LAVA"),c.delete("FIRE"),c.delete("LIQUID"),c.delete("HAZARDOUS")):(c.delete("BLOCKS_MOVEMENT"),c.delete("BLOCKS_LOS")),e.set(i,{...o,traits:c})},ce=(e,i,a)=>Math.min(a,Math.max(i,e)),jc=(e,i)=>e?i&&e.themes?.[i]?e.themes[i]:e.default||"":"",Dc=e=>e?e.mode==="cover"||e.mode==="repeat"||e.mode==="off"?e.mode:"repeat":"off",kT=(e,i)=>e?i&&e.themes?.[i]?e.themes[i]:e.default||"#8b6f4a":"#8b6f4a",$a=e=>e==="normal"||e==="multiply"||e==="overlay"||e==="soft-light"||e==="screen"||e==="color-dodge"?e:"multiply",hi=e=>e==="off"?"off":$a(e),bf=(e,i,a,o)=>{const c=e?.[a]??e?.[o];return c!==void 0?c:i?.[a]??i?.[o]},LT=e=>{switch(e){case"inferno":return 4;case"throne":return 6;case"frozen":return 8;case"void":return 10;default:return 1}},IT=e=>{const i=new Map;for(const[a,o]of e.tiles.entries())i.set(a,{...o,traits:new Set(o.traits),effects:Array.isArray(o.effects)?[...o.effects]:[]});return i},BT=(e,i)=>{const a=(r,f,h)=>{const y=he({q:r,r:f}),A=e.get(y);if(!A)return;const v=new Set(Array.from(A.traits));if(!l0(v)){for(const S of h)v.add(S);e.set(y,{...A,traits:v})}},o=[[0,0],[1,0],[0,1],[-1,1],[-1,0],[0,-1],[1,-1],[2,-1],[2,0],[1,1],[-2,1],[-2,0],[-1,-1]];for(const[r,f]of o)a(i.q+r,i.r+f,["HAZARDOUS","LIQUID","LAVA"]);const c=[[3,-1],[3,0],[2,1],[-3,1],[-3,0],[-2,-1]];for(const[r,f]of c)a(i.q+r,i.r+f,["HAZARDOUS","FIRE"])},jT=(e,i,a,o)=>{const c=o.mode,r=NT(e),f=RT(e,a,2),h=Array.from(e.keys()).sort((_,p)=>_.localeCompare(p));if(c==="custom")for(const _ of h){if(f.has(_)){yf(e,_,!1);continue}const p=o.keepPerimeter&&r.has(_);yf(e,_,p)}if(c==="native")return;const b=ce(Number(o.interiorDensity||0),0,.45),y=ce(Number(o.clusterBias||0),0,1);if(b<=0&&y<=0)return;const A=h.filter(_=>{if(r.has(_)||f.has(_))return!1;const p=e.get(_);if(!p)return!1;const g=p.traits;return!CT(g)}),v=_=>{const p=e.get(_);return p?l0(p.traits):!1},S=new Set;for(const _ of A){if(v(_))continue;Cy(`${i}|sandbox-wall-seed|${_}`)<b&&S.add(_)}for(let _=0;_<2;_++)for(const p of A){if(v(p)||S.has(p))continue;const g=e.get(p);if(!g)continue;const R=zf(g.position).filter(N=>e.has(N));let I=0;for(const N of R)(v(N)||S.has(N))&&I++;if(I===0)continue;const C=y*(I/6);Cy(`${i}|sandbox-wall-grow|pass:${_}|${p}`)<C&&S.add(p)}for(const _ of S)yf(e,_,!0)},DT=(e,i,a,o)=>{const c=LT(e),r=i.trim()||"biome-sandbox-seed",f=Cs(c,r,r,void 0,Uo.VANGUARD),h=IT(f);return jT(h,r,f.player.position,o),a&&BT(h,f.player.position),{...f,floor:c,theme:e,rngSeed:r,initialSeed:r,turnNumber:1,tiles:h,visualEvents:[],timelineEvents:[],intentPreview:void 0}},Ny=(e,i)=>{const a=i.toLowerCase(),o=Uf(e,a),c=o?.biomeLayers?.undercurrent??e.biomeLayers?.undercurrent,r=o?.biomeLayers?.crust??e.biomeLayers?.crust??(e.biomeUnderlay?{default:e.biomeUnderlay.default,themes:e.biomeUnderlay.themes,mode:e.biomeUnderlay.mode,scalePx:e.biomeUnderlay.scalePx,opacity:e.biomeUnderlay.opacity}:void 0),f=o?.biomeMaterials?.crust??e.biomeMaterials?.crust,h=f?.detailA,b=f?.detailB,y=f?.tint,A=o?.walls||e.walls,v=o?.walls?o.walls:e.walls?.themes?.[a],S=(e.assets||[]).filter(X=>{if(X.type!=="prop")return!1;const O=X.id.toLowerCase(),q=new Set((X.tags||[]).map(ue=>ue.toLowerCase()));if(!O.includes("mountain")&&!q.has("mountain"))return!1;if(!X.theme)return!0;const K=X.theme.toLowerCase();return K===a||K==="core"}).sort((X,O)=>X.id.localeCompare(O.id)),p=String(v?.mountainPath??A?.mountainPath??"").trim()||S.find(X=>X.path.toLowerCase().includes("biome.volcano.mountain.03.webp"))?.path||S[0]?.path||"",g=S.find(X=>X.path===p)||S[0],R=g?.mountainSettings,I=g?.mountainSettingsByTheme?.[a],C=g?o?.assetOverrides?.[g.id]?.mountainSettings:void 0,M=(X,O,q)=>{const ue=bf(v,A,X,O)??C?.[X]??I?.[X]??R?.[X]??q,W=Number(ue);return Number.isFinite(W)?W:q},N=(X,O,q)=>{const ue=bf(v,A,X,O)??C?.[X]??I?.[X]??R?.[X]??q;return hi(ue)},Y=(X,O,q)=>{const ue=bf(v,A,X,O)??C?.[X]??I?.[X]??R?.[X]??q;return Bi(String(ue||""),q)};return{theme:i,seed:String(o?.seed||"biome-sandbox-seed"),injectHazards:o?.injectHazards!==void 0?!!o.injectHazards:!0,undercurrent:{path:jc(c,a),mode:Dc(c),scalePx:ce(Number(c?.scalePx??e.tileUnitPx??256),qa,za),opacity:ce(Number(c?.opacity??.6),0,1),scrollX:Number(c?.scroll?.x??120),scrollY:Number(c?.scroll?.y??90),scrollDurationMs:Math.max(1e3,Number(c?.scroll?.durationMs??92e3)),offsetX:Number(c?.offsetX??0),offsetY:Number(c?.offsetY??0)},crust:{path:jc(r,a),mode:Dc(r),scalePx:Math.max(64,Number(r?.scalePx??e.tileUnitPx??256)),opacity:1,seedShiftPx:Math.max(0,Number(r?.seedShiftPx??96)),offsetX:Number(r?.offsetX??0),offsetY:Number(r?.offsetY??0)},clutter:{density:ce(Number((o?.biomeLayers?.clutter??e.biomeLayers?.clutter)?.density??.14),0,1),maxPerHex:Math.max(0,Number((o?.biomeLayers?.clutter??e.biomeLayers?.clutter)?.maxPerHex??1)),bleedScaleMax:ce(Number((o?.biomeLayers?.clutter??e.biomeLayers?.clutter)?.bleedScaleMax??2),1,2)},walls:{mode:A?.mode==="native"||A?.mode==="additive"||A?.mode==="custom"?A.mode:"custom",interiorDensity:ce(Number(A?.interiorDensity??.05),0,.45),clusterBias:ce(Number(A?.clusterBias??0),0,1),keepPerimeter:A?.keepPerimeter!==void 0?!!A.keepPerimeter:!0,mountainPath:p,mountainScale:ce(M("scale","mountainScale",.53),.2,3),mountainOffsetX:M("offsetX","mountainOffsetX",0),mountainOffsetY:M("offsetY","mountainOffsetY",0),mountainAnchorX:ce(M("anchorX","mountainAnchorX",.5),0,1),mountainAnchorY:ce(M("anchorY","mountainAnchorY",.55),0,1),mountainCrustBlendMode:N("crustBlendMode","mountainCrustBlendMode","multiply"),mountainCrustBlendOpacity:ce(M("crustBlendOpacity","mountainCrustBlendOpacity",1),0,1),mountainTintColor:Y("tintColor","mountainTintColor","#7d7d7d"),mountainTintBlendMode:N("tintBlendMode","mountainTintBlendMode","overlay"),mountainTintOpacity:ce(M("tintOpacity","mountainTintOpacity",1),0,1)},materials:{detailA:{path:jc(h,a),mode:Dc(h),scalePx:ce(Number(h?.scalePx??192),ii,si),opacity:ce(Number(h?.opacity??0),0,1)},detailB:{path:jc(b,a),mode:Dc(b),scalePx:ce(Number(b?.scalePx??256),ii,si),opacity:ce(Number(b?.opacity??0),0,1)},tintColor:kT(y,a),tintOpacity:ce(Number(y?.opacity??0),0,1),tintBlend:$a(y?.blendMode)}}},HT=e=>{if(!e)return null;try{const i=JSON.parse(e);return!i||typeof i!="object"?null:i}catch{return null}},ct=(e,i)=>{const a=Number(e);return Number.isFinite(a)?a:i},PT=({assetManifest:e,onBack:i})=>{const a=w.useRef(!1),[o,c]=w.useState(""),[r,f]=w.useState(null);w.useEffect(()=>{if(!e||a.current)return;const p=Ny(e,"inferno"),g=HT(localStorage.getItem(_y));if(!g){f(p),a.current=!0;return}f({...p,...g,undercurrent:{...p.undercurrent,...g.undercurrent||{},scalePx:ce(Number((g.undercurrent||{}).scalePx??p.undercurrent.scalePx),qa,za)},crust:{...p.crust,...g.crust||{},opacity:1},clutter:{...p.clutter,...g.clutter||{}},walls:{...p.walls,...g.walls||{},mode:(g.walls||{}).mode==="native"||(g.walls||{}).mode==="additive"||(g.walls||{}).mode==="custom"?(g.walls||{}).mode:p.walls.mode,interiorDensity:ce(Number((g.walls||{}).interiorDensity??p.walls.interiorDensity),0,.45),clusterBias:ce(Number((g.walls||{}).clusterBias??p.walls.clusterBias),0,1),keepPerimeter:(g.walls||{}).keepPerimeter!==void 0?!!(g.walls||{}).keepPerimeter:p.walls.keepPerimeter,mountainPath:String((g.walls||{}).mountainPath||p.walls.mountainPath||""),mountainScale:ce(Number((g.walls||{}).mountainScale??p.walls.mountainScale),.2,3),mountainOffsetX:ct(String((g.walls||{}).mountainOffsetX??p.walls.mountainOffsetX),p.walls.mountainOffsetX),mountainOffsetY:ct(String((g.walls||{}).mountainOffsetY??p.walls.mountainOffsetY),p.walls.mountainOffsetY),mountainAnchorX:ce(Number((g.walls||{}).mountainAnchorX??p.walls.mountainAnchorX),0,1),mountainAnchorY:ce(Number((g.walls||{}).mountainAnchorY??p.walls.mountainAnchorY),0,1),mountainCrustBlendMode:hi((g.walls||{}).mountainCrustBlendMode??p.walls.mountainCrustBlendMode),mountainCrustBlendOpacity:ce(Number((g.walls||{}).mountainCrustBlendOpacity??p.walls.mountainCrustBlendOpacity),0,1),mountainTintColor:Bi(String((g.walls||{}).mountainTintColor??p.walls.mountainTintColor),p.walls.mountainTintColor),mountainTintBlendMode:hi((g.walls||{}).mountainTintBlendMode??p.walls.mountainTintBlendMode),mountainTintOpacity:ce(Number((g.walls||{}).mountainTintOpacity??p.walls.mountainTintOpacity),0,1)},materials:{...p.materials,...g.materials||{},detailA:{...p.materials.detailA,...(g.materials||{}).detailA||{},scalePx:ce(Number(((g.materials||{}).detailA||{}).scalePx??p.materials.detailA.scalePx),ii,si),opacity:ce(Number(((g.materials||{}).detailA||{}).opacity??p.materials.detailA.opacity),0,1)},detailB:{...p.materials.detailB,...(g.materials||{}).detailB||{},scalePx:ce(Number(((g.materials||{}).detailB||{}).scalePx??p.materials.detailB.scalePx),ii,si),opacity:ce(Number(((g.materials||{}).detailB||{}).opacity??p.materials.detailB.opacity),0,1)},tintOpacity:ce(Number((g.materials||{}).tintOpacity??p.materials.tintOpacity),0,1),tintBlend:$a((g.materials||{}).tintBlend)}}),a.current=!0},[e]),w.useEffect(()=>{r&&localStorage.setItem(_y,JSON.stringify(r))},[r]);const h=r?.theme?.toLowerCase()||"inferno",b=w.useMemo(()=>Bi(r?.materials.tintColor||"#8b6f4a"),[r?.materials.tintColor]),y=w.useMemo(()=>Bi(r?.walls.mountainTintColor||"#8b6f4a"),[r?.walls.mountainTintColor]),A=w.useMemo(()=>{const p=new Set,g=new Set,R=new Set,I=new Set;if(!e)return{undercurrent:[],crust:[],detail:[],mountain:[]};const C=M=>{if(M){M.default&&(p.add(M.default),g.add(M.default),R.add(M.default));for(const N of Object.values(M.themes||{}))p.add(N),g.add(N),R.add(N)}};C(e.biomeLayers?.undercurrent),C(e.biomeLayers?.crust);for(const M of Object.values(e.biomePresets||{}))C(M?.biomeLayers?.undercurrent),C(M?.biomeLayers?.crust),M?.biomeMaterials?.crust?.detailA&&C(M.biomeMaterials.crust.detailA),M?.biomeMaterials?.crust?.detailB&&C(M.biomeMaterials.crust.detailB);if(e.biomeUnderlay){e.biomeUnderlay.default&&g.add(e.biomeUnderlay.default);for(const M of Object.values(e.biomeUnderlay.themes||{}))g.add(M)}e.biomeMaterials?.crust?.detailA&&C(e.biomeMaterials.crust.detailA),e.biomeMaterials?.crust?.detailB&&C(e.biomeMaterials.crust.detailB);for(const M of e.assets||[]){const N=new Set((M.tags||[]).map(X=>X.toLowerCase())),Y=M.type==="prop"&&(M.id.toLowerCase().includes("mountain")||N.has("mountain"));(N.has("floor")||N.has("stone")||N.has("void")||N.has("frozen")||N.has("inferno"))&&(g.add(M.path),R.add(M.path)),(N.has("lava")||N.has("hazard")||N.has("fire")||N.has("quicksand"))&&p.add(M.path),(M.type==="decal"||M.type==="prop"||M.type==="tile")&&R.add(M.path),Y&&I.add(M.path)}e.walls?.mountainPath&&I.add(e.walls.mountainPath);for(const M of Object.values(e.walls?.themes||{}))M?.mountainPath&&I.add(M.mountainPath);for(const M of Object.values(e.biomePresets||{})){M?.walls?.mountainPath&&I.add(M.walls.mountainPath);for(const N of Object.values(M?.walls?.themes||{}))N?.mountainPath&&I.add(N.mountainPath)}return{undercurrent:Array.from(p).sort((M,N)=>M.localeCompare(N)),crust:Array.from(g).sort((M,N)=>M.localeCompare(N)),detail:Array.from(R).sort((M,N)=>M.localeCompare(N)),mountain:Array.from(I).sort((M,N)=>M.localeCompare(N))}},[e]),v=w.useMemo(()=>{if(!e||!r)return null;const p=Wl(r.undercurrent.path),g=Wl(r.crust.path),R=Wl(r.materials.detailA.path),I=Wl(r.materials.detailB.path),C=Uf(e,h),M=C?.biomeLayers?.undercurrent??e.biomeLayers?.undercurrent,N=C?.biomeLayers?.crust??e.biomeLayers?.crust??(e.biomeUnderlay?{default:e.biomeUnderlay.default,themes:e.biomeUnderlay.themes,mode:e.biomeUnderlay.mode,scalePx:e.biomeUnderlay.scalePx,opacity:e.biomeUnderlay.opacity}:void 0),Y=C?.biomeMaterials?.crust??e.biomeMaterials?.crust,X=M||p?{...M||{default:p||g||""},default:p||M?.default||"",themes:{...M?.themes||{},[h]:p||M?.default||""},mode:r.undercurrent.mode,scalePx:ce(r.undercurrent.scalePx,qa,za),opacity:ce(r.undercurrent.opacity,0,1),offsetX:r.undercurrent.offsetX,offsetY:r.undercurrent.offsetY,scroll:{x:r.undercurrent.scrollX,y:r.undercurrent.scrollY,durationMs:Math.max(1e3,r.undercurrent.scrollDurationMs)}}:void 0,O=N||g?{...N||{default:g||p||""},default:g||N?.default||"",themes:{...N?.themes||{},[h]:g||N?.default||""},mode:r.crust.mode,scalePx:Math.max(64,r.crust.scalePx),opacity:1,seedShiftPx:Math.max(0,r.crust.seedShiftPx),offsetX:r.crust.offsetX,offsetY:r.crust.offsetY}:void 0,q=R||Y?.detailA?.default||"",K={...Y?.detailA?.themes||{}};q&&(K[h]=q);const ue=q?{...Y?.detailA||{default:q},default:q,themes:K,mode:r.materials.detailA.mode,scalePx:ce(r.materials.detailA.scalePx,ii,si),opacity:ce(r.materials.detailA.opacity,0,1)}:void 0,W=I||Y?.detailB?.default||"",_e={...Y?.detailB?.themes||{}};W&&(_e[h]=W);const oe=W?{...Y?.detailB||{default:W},default:W,themes:_e,mode:r.materials.detailB.mode,scalePx:ce(r.materials.detailB.scalePx,ii,si),opacity:ce(r.materials.detailB.opacity,0,1)}:void 0,be=String(r.materials.tintColor||"").trim()||Y?.tint?.default||"#8b6f4a",pe={...Y?.tint?.themes||{}};pe[h]=be;const H={...Y?.tint||{default:be},default:be,themes:pe,opacity:ce(r.materials.tintOpacity,0,1),blendMode:$a(r.materials.tintBlend)},ee=ue||oe||H?{...Y||{},detailA:ue,detailB:oe,tint:H}:void 0,ae=Wl(r.walls.mountainPath),Te=C?.walls,xe={...Te||e.walls?.themes?.[h]||{},mountainPath:ae,scale:ce(r.walls.mountainScale,.2,3),offsetX:r.walls.mountainOffsetX,offsetY:r.walls.mountainOffsetY,anchorX:ce(r.walls.mountainAnchorX,0,1),anchorY:ce(r.walls.mountainAnchorY,0,1),crustBlendMode:hi(r.walls.mountainCrustBlendMode),crustBlendOpacity:ce(r.walls.mountainCrustBlendOpacity,0,1),tintColor:Bi(r.walls.mountainTintColor,"#7d7d7d"),tintBlendMode:hi(r.walls.mountainTintBlendMode),tintOpacity:ce(r.walls.mountainTintOpacity,0,1),mountainScale:ce(r.walls.mountainScale,.2,3),mountainOffsetX:r.walls.mountainOffsetX,mountainOffsetY:r.walls.mountainOffsetY,mountainAnchorX:ce(r.walls.mountainAnchorX,0,1),mountainAnchorY:ce(r.walls.mountainAnchorY,0,1),mountainCrustBlendMode:hi(r.walls.mountainCrustBlendMode),mountainCrustBlendOpacity:ce(r.walls.mountainCrustBlendOpacity,0,1),mountainTintColor:Bi(r.walls.mountainTintColor,"#7d7d7d"),mountainTintBlendMode:hi(r.walls.mountainTintBlendMode),mountainTintOpacity:ce(r.walls.mountainTintOpacity,0,1)},k={...e.walls||{},...Te||{},mode:r.walls.mode,interiorDensity:ce(r.walls.interiorDensity,0,.45),clusterBias:ce(r.walls.clusterBias,0,1),keepPerimeter:!!r.walls.keepPerimeter,mountainPath:ae,scale:xe.scale,offsetX:xe.offsetX,offsetY:xe.offsetY,anchorX:xe.anchorX,anchorY:xe.anchorY,crustBlendMode:xe.crustBlendMode,crustBlendOpacity:xe.crustBlendOpacity,tintColor:xe.tintColor,tintBlendMode:xe.tintBlendMode,tintOpacity:xe.tintOpacity,mountainScale:xe.mountainScale,mountainOffsetX:xe.mountainOffsetX,mountainOffsetY:xe.mountainOffsetY,mountainAnchorX:xe.mountainAnchorX,mountainAnchorY:xe.mountainAnchorY,mountainCrustBlendMode:xe.mountainCrustBlendMode,mountainCrustBlendOpacity:xe.mountainCrustBlendOpacity,mountainTintColor:xe.mountainTintColor,mountainTintBlendMode:xe.mountainTintBlendMode,mountainTintOpacity:xe.mountainTintOpacity,themes:{...e.walls?.themes||{},[h]:xe}},$={...C?.biomeLayers||{},undercurrent:X,crust:O,clutter:{...C?.biomeLayers?.clutter||e.biomeLayers?.clutter||{},density:ce(r.clutter.density,0,1),maxPerHex:Math.max(0,Math.floor(r.clutter.maxPerHex)),bleedScaleMax:ce(r.clutter.bleedScaleMax,1,2)}},J={...C?.biomeMaterials||{},crust:ee},me={...C||{},seed:r.seed.trim()||"biome-sandbox-seed",injectHazards:r.injectHazards,biomeLayers:$,biomeMaterials:J,walls:k};return{...e,biomeLayers:{...e.biomeLayers||{},undercurrent:X,crust:O,clutter:{...e.biomeLayers?.clutter||{},density:ce(r.clutter.density,0,1),maxPerHex:Math.max(0,Math.floor(r.clutter.maxPerHex)),bleedScaleMax:ce(r.clutter.bleedScaleMax,1,2)}},biomeMaterials:{...e.biomeMaterials||{},crust:ee},walls:k,biomePresets:{...e.biomePresets||{},[h]:me}}},[e,r,h]),S=w.useMemo(()=>r?DT(r.theme,r.seed,r.injectHazards,r.walls):null,[r]),_=async()=>{if(!r)return;const p=Xl(r.undercurrent.path),g=Xl(r.crust.path),R=Xl(r.materials.detailA.path),I=Xl(r.materials.detailB.path),M={mountainPath:Xl(r.walls.mountainPath),mountainScale:ce(r.walls.mountainScale,.2,3),mountainOffsetX:r.walls.mountainOffsetX,mountainOffsetY:r.walls.mountainOffsetY,mountainAnchorX:ce(r.walls.mountainAnchorX,0,1),mountainAnchorY:ce(r.walls.mountainAnchorY,0,1),mountainCrustBlendMode:hi(r.walls.mountainCrustBlendMode),mountainCrustBlendOpacity:ce(r.walls.mountainCrustBlendOpacity,0,1),mountainTintColor:Bi(r.walls.mountainTintColor,"#7d7d7d"),mountainTintBlendMode:hi(r.walls.mountainTintBlendMode),mountainTintOpacity:ce(r.walls.mountainTintOpacity,0,1),scale:ce(r.walls.mountainScale,.2,3),offsetX:r.walls.mountainOffsetX,offsetY:r.walls.mountainOffsetY,anchorX:ce(r.walls.mountainAnchorX,0,1),anchorY:ce(r.walls.mountainAnchorY,0,1),crustBlendMode:hi(r.walls.mountainCrustBlendMode),crustBlendOpacity:ce(r.walls.mountainCrustBlendOpacity,0,1),tintColor:Bi(r.walls.mountainTintColor,"#7d7d7d"),tintBlendMode:hi(r.walls.mountainTintBlendMode),tintOpacity:ce(r.walls.mountainTintOpacity,0,1)},N={seed:r.seed.trim()||"biome-sandbox-seed",injectHazards:r.injectHazards,biomeLayers:{undercurrent:{default:p,mode:r.undercurrent.mode,scalePx:ce(r.undercurrent.scalePx,qa,za),opacity:ce(r.undercurrent.opacity,0,1),offsetX:r.undercurrent.offsetX,offsetY:r.undercurrent.offsetY,scroll:{x:r.undercurrent.scrollX,y:r.undercurrent.scrollY,durationMs:Math.max(1e3,r.undercurrent.scrollDurationMs)}},crust:{default:g,mode:r.crust.mode,scalePx:Math.max(64,r.crust.scalePx),opacity:1,seedShiftPx:r.crust.seedShiftPx,offsetX:r.crust.offsetX,offsetY:r.crust.offsetY},clutter:{density:r.clutter.density,maxPerHex:r.clutter.maxPerHex,bleedScaleMax:r.clutter.bleedScaleMax}},walls:{mode:r.walls.mode,interiorDensity:r.walls.interiorDensity,clusterBias:r.walls.clusterBias,keepPerimeter:r.walls.keepPerimeter,...M},biomeMaterials:{crust:{detailA:{default:R,mode:r.materials.detailA.mode,scalePx:ce(r.materials.detailA.scalePx,ii,si),opacity:ce(r.materials.detailA.opacity,0,1)},detailB:{default:I,mode:r.materials.detailB.mode,scalePx:ce(r.materials.detailB.scalePx,ii,si),opacity:ce(r.materials.detailB.opacity,0,1)},tint:{default:Bi(r.materials.tintColor,"#8b6f4a"),opacity:ce(r.materials.tintOpacity,0,1),blendMode:$a(r.materials.tintBlend)}}}},Y={theme:r.theme,seed:r.seed.trim()||"biome-sandbox-seed",injectHazards:r.injectHazards,biomeLayers:{undercurrent:{default:p,mode:r.undercurrent.mode,scalePx:ce(r.undercurrent.scalePx,qa,za),opacity:ce(r.undercurrent.opacity,0,1),offsetX:r.undercurrent.offsetX,offsetY:r.undercurrent.offsetY,scroll:{x:r.undercurrent.scrollX,y:r.undercurrent.scrollY,durationMs:Math.max(1e3,r.undercurrent.scrollDurationMs)}},crust:{default:g,mode:r.crust.mode,scalePx:Math.max(64,r.crust.scalePx),opacity:1,seedShiftPx:r.crust.seedShiftPx,offsetX:r.crust.offsetX,offsetY:r.crust.offsetY},clutter:{density:r.clutter.density,maxPerHex:r.clutter.maxPerHex,bleedScaleMax:r.clutter.bleedScaleMax}},walls:{mode:r.walls.mode,interiorDensity:r.walls.interiorDensity,clusterBias:r.walls.clusterBias,keepPerimeter:r.walls.keepPerimeter,...M,themes:{[h]:M}},biomeMaterials:{crust:{detailA:{default:R,mode:r.materials.detailA.mode,scalePx:ce(r.materials.detailA.scalePx,ii,si),opacity:ce(r.materials.detailA.opacity,0,1)},detailB:{default:I,mode:r.materials.detailB.mode,scalePx:ce(r.materials.detailB.scalePx,ii,si),opacity:ce(r.materials.detailB.opacity,0,1)},tint:{default:Bi(r.materials.tintColor,"#8b6f4a"),opacity:ce(r.materials.tintOpacity,0,1),blendMode:$a(r.materials.tintBlend)}}},biomePresets:{[h]:N}};try{await navigator.clipboard.writeText(JSON.stringify(Y,null,2)),c("Copied"),window.setTimeout(()=>c(""),1600)}catch{c("Copy failed"),window.setTimeout(()=>c(""),1600)}};return!e||!r||!v||!S?m.jsxs("div",{className:"w-screen h-screen bg-[#030712] text-white flex items-center justify-center",children:[m.jsx("button",{type:"button",onClick:i,className:"absolute top-5 left-5 px-4 py-2 rounded-lg border border-white/20 bg-white/5 hover:bg-white/10 text-xs font-black uppercase tracking-[0.2em]",children:"Back"}),m.jsx("div",{className:"text-sm text-white/70 uppercase tracking-[0.25em] font-black",children:"Loading Biome Sandbox..."})]}):m.jsxs("div",{className:"w-screen h-screen bg-[#030712] text-white flex",children:[m.jsxs("aside",{className:"w-[420px] border-r border-white/10 bg-[#02040a] overflow-y-auto",children:[m.jsxs("div",{className:"sticky top-0 z-20 border-b border-white/10 bg-[#02040a]/95 backdrop-blur p-4",children:[m.jsxs("div",{className:"flex items-center justify-between gap-3",children:[m.jsx("button",{type:"button",onClick:i,className:"px-3 py-2 rounded-lg border border-white/20 bg-white/5 hover:bg-white/10 text-[11px] font-black uppercase tracking-[0.18em]",children:"Back"}),m.jsx("button",{type:"button",onClick:()=>f(Ny(e,r.theme)),className:"px-3 py-2 rounded-lg border border-amber-300/40 bg-amber-500/10 hover:bg-amber-500/20 text-[11px] font-black uppercase tracking-[0.18em]",children:"Reset"}),m.jsx("button",{type:"button",onClick:_,className:"px-3 py-2 rounded-lg border border-cyan-300/40 bg-cyan-500/10 hover:bg-cyan-500/20 text-[11px] font-black uppercase tracking-[0.18em]",children:"Copy JSON"})]}),m.jsxs("div",{className:"mt-3 text-[10px] uppercase tracking-[0.22em] text-white/50",children:["Hop / Biomes ",o?`* ${o}`:""]})]}),m.jsxs("div",{className:"p-4 space-y-6",children:[m.jsxs("section",{className:"space-y-3",children:[m.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/75",children:"Preview"}),m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Theme"}),m.jsx("select",{value:r.theme,onChange:p=>f(g=>g&&{...g,theme:p.target.value}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:TT.map(p=>m.jsx("option",{value:p,children:p},p))}),m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Seed"}),m.jsx("input",{value:r.seed,onChange:p=>f(g=>g&&{...g,seed:p.target.value}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"}),m.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/80",children:[m.jsx("input",{type:"checkbox",checked:r.injectHazards,onChange:p=>f(g=>g&&{...g,injectHazards:p.target.checked})}),"Inject synthetic lava/fire patches for mask testing"]})]}),m.jsxs("section",{className:"space-y-3",children:[m.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-cyan-200",children:"Undercurrent"}),m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Asset Path"}),m.jsx("input",{list:"sandbox-undercurrent-paths",value:r.undercurrent.path,onChange:p=>f(g=>g&&{...g,undercurrent:{...g.undercurrent,path:p.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),m.jsx("datalist",{id:"sandbox-undercurrent-paths",children:A.undercurrent.map(p=>m.jsx("option",{value:p},p))}),m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Mode"}),m.jsx("select",{value:r.undercurrent.mode,onChange:p=>f(g=>g&&{...g,undercurrent:{...g.undercurrent,mode:p.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Bc.map(p=>m.jsx("option",{value:p,children:p},p))}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scale Px"}),m.jsx("input",{type:"number",min:qa,max:za,step:16,value:r.undercurrent.scalePx,onChange:p=>f(g=>g&&{...g,undercurrent:{...g.undercurrent,scalePx:ce(ct(p.target.value,g.undercurrent.scalePx),qa,za)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Opacity"}),m.jsx("input",{type:"number",min:0,max:1,step:.01,value:r.undercurrent.opacity,onChange:p=>f(g=>g&&{...g,undercurrent:{...g.undercurrent,opacity:ce(ct(p.target.value,g.undercurrent.opacity),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),m.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scroll X"}),m.jsx("input",{type:"number",step:5,value:r.undercurrent.scrollX,onChange:p=>f(g=>g&&{...g,undercurrent:{...g.undercurrent,scrollX:ct(p.target.value,g.undercurrent.scrollX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scroll Y"}),m.jsx("input",{type:"number",step:5,value:r.undercurrent.scrollY,onChange:p=>f(g=>g&&{...g,undercurrent:{...g.undercurrent,scrollY:ct(p.target.value,g.undercurrent.scrollY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Duration"}),m.jsx("input",{type:"number",min:1e3,step:500,value:r.undercurrent.scrollDurationMs,onChange:p=>f(g=>g&&{...g,undercurrent:{...g.undercurrent,scrollDurationMs:Math.max(1e3,ct(p.target.value,g.undercurrent.scrollDurationMs))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset X"}),m.jsx("input",{type:"number",step:4,value:r.undercurrent.offsetX,onChange:p=>f(g=>g&&{...g,undercurrent:{...g.undercurrent,offsetX:ct(p.target.value,g.undercurrent.offsetX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset Y"}),m.jsx("input",{type:"number",step:4,value:r.undercurrent.offsetY,onChange:p=>f(g=>g&&{...g,undercurrent:{...g.undercurrent,offsetY:ct(p.target.value,g.undercurrent.offsetY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]})]}),m.jsxs("section",{className:"space-y-3",children:[m.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-amber-200",children:"Crust"}),m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Asset Path"}),m.jsx("input",{list:"sandbox-crust-paths",value:r.crust.path,onChange:p=>f(g=>g&&{...g,crust:{...g.crust,path:p.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),m.jsx("datalist",{id:"sandbox-crust-paths",children:A.crust.map(p=>m.jsx("option",{value:p},p))}),m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Mode"}),m.jsx("select",{value:r.crust.mode,onChange:p=>f(g=>g&&{...g,crust:{...g.crust,mode:p.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Bc.map(p=>m.jsx("option",{value:p,children:p},p))}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scale Px"}),m.jsx("input",{type:"number",min:64,step:16,value:r.crust.scalePx,onChange:p=>f(g=>g&&{...g,crust:{...g.crust,scalePx:Math.max(64,ct(p.target.value,g.crust.scalePx))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Opacity"}),m.jsx("input",{type:"number",min:1,max:1,step:.01,value:1,onChange:()=>f(p=>p&&{...p,crust:{...p.crust,opacity:1}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Seed Shift Budget"}),m.jsx("input",{type:"number",min:0,step:8,value:r.crust.seedShiftPx,onChange:p=>f(g=>g&&{...g,crust:{...g.crust,seedShiftPx:Math.max(0,ct(p.target.value,g.crust.seedShiftPx))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset X"}),m.jsx("input",{type:"number",step:4,value:r.crust.offsetX,onChange:p=>f(g=>g&&{...g,crust:{...g.crust,offsetX:ct(p.target.value,g.crust.offsetX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset Y"}),m.jsx("input",{type:"number",step:4,value:r.crust.offsetY,onChange:p=>f(g=>g&&{...g,crust:{...g.crust,offsetY:ct(p.target.value,g.crust.offsetY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]})]}),m.jsxs("section",{className:"space-y-3",children:[m.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-rose-200",children:"Walls / Mountains"}),m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Mountain Asset"}),m.jsx("input",{list:"sandbox-mountain-paths",value:r.walls.mountainPath,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainPath:p.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs",placeholder:"/assets/biomes/biome.volcano.mountain.01.webp"}),m.jsx("datalist",{id:"sandbox-mountain-paths",children:A.mountain.map(p=>m.jsx("option",{value:p},p))}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Scale"}),m.jsx("input",{type:"number",min:.2,max:3,step:.01,value:r.walls.mountainScale,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainScale:ce(ct(p.target.value,g.walls.mountainScale),.2,3)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Anchor X"}),m.jsx("input",{type:"number",min:0,max:1,step:.01,value:r.walls.mountainAnchorX,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainAnchorX:ce(ct(p.target.value,g.walls.mountainAnchorX),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset X"}),m.jsx("input",{type:"number",step:2,value:r.walls.mountainOffsetX,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainOffsetX:ct(p.target.value,g.walls.mountainOffsetX)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Offset Y"}),m.jsx("input",{type:"number",step:2,value:r.walls.mountainOffsetY,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainOffsetY:ct(p.target.value,g.walls.mountainOffsetY)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Anchor Y"}),m.jsx("input",{type:"number",min:0,max:1,step:.01,value:r.walls.mountainAnchorY,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainAnchorY:ce(ct(p.target.value,g.walls.mountainAnchorY),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Crust Blend"}),m.jsx("select",{value:r.walls.mountainCrustBlendMode,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainCrustBlendMode:hi(p.target.value)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:My.map(p=>m.jsx("option",{value:p,children:p},`mountain-blend-${p}`))})]}),m.jsxs("div",{children:[m.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Blend Opacity ",r.walls.mountainCrustBlendOpacity.toFixed(2)]}),m.jsx("input",{type:"number",min:0,max:1,step:.01,value:r.walls.mountainCrustBlendOpacity,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainCrustBlendOpacity:ce(ct(p.target.value,g.walls.mountainCrustBlendOpacity),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),m.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45",children:"Mountain Tint"}),m.jsxs("div",{className:"grid grid-cols-[72px_1fr] gap-3",children:[m.jsx("input",{type:"color",value:y,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainTintColor:p.target.value}}),className:"h-10 w-full rounded-lg border border-white/15 bg-white/5 p-1 cursor-pointer","aria-label":"Mountain Tint Color Picker"}),m.jsx("input",{value:r.walls.mountainTintColor,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainTintColor:p.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",placeholder:"#8b6f4a"})]}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Tint Blend"}),m.jsx("select",{value:r.walls.mountainTintBlendMode,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainTintBlendMode:hi(p.target.value)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:My.map(p=>m.jsx("option",{value:p,children:p},`mountain-tint-blend-${p}`))})]}),m.jsxs("div",{children:[m.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Tint Opacity ",r.walls.mountainTintOpacity.toFixed(2)]}),m.jsx("input",{type:"number",min:0,max:1,step:.01,value:r.walls.mountainTintOpacity,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mountainTintOpacity:ce(ct(p.target.value,g.walls.mountainTintOpacity),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]}),m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Wall Layout Mode"}),m.jsx("select",{value:r.walls.mode,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,mode:p.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:_T.map(p=>m.jsx("option",{value:p,children:p},`wall-mode-${p}`))}),m.jsxs("div",{className:"space-y-2",children:[m.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Interior Density ",r.walls.interiorDensity.toFixed(2)]}),m.jsx("input",{type:"range",min:0,max:.45,step:.01,value:r.walls.interiorDensity,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,interiorDensity:ce(ct(p.target.value,g.walls.interiorDensity),0,.45)}}),className:"w-full"})]}),m.jsxs("div",{className:"space-y-2",children:[m.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Cluster Bias ",r.walls.clusterBias.toFixed(2)]}),m.jsx("input",{type:"range",min:0,max:1,step:.01,value:r.walls.clusterBias,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,clusterBias:ce(ct(p.target.value,g.walls.clusterBias),0,1)}}),className:"w-full"})]}),m.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/80",children:[m.jsx("input",{type:"checkbox",checked:r.walls.keepPerimeter,onChange:p=>f(g=>g&&{...g,walls:{...g.walls,keepPerimeter:p.target.checked}})}),"Keep perimeter walls (custom mode)"]})]}),m.jsxs("section",{className:"space-y-3",children:[m.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-fuchsia-200",children:"Crust Materials"}),m.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45",children:"Detail A"}),m.jsx("input",{list:"sandbox-detail-paths",value:r.materials.detailA.path,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,detailA:{...g.materials.detailA,path:p.target.value}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),m.jsx("datalist",{id:"sandbox-detail-paths",children:A.detail.map(p=>m.jsx("option",{value:p},p))}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsx("select",{value:r.materials.detailA.mode,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,detailA:{...g.materials.detailA,mode:p.target.value}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Bc.map(p=>m.jsx("option",{value:p,children:p},`detail-a-${p}`))}),m.jsx("input",{type:"number",min:0,max:1,step:.01,value:r.materials.detailA.opacity,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,detailA:{...g.materials.detailA,opacity:ce(ct(p.target.value,g.materials.detailA.opacity),0,1)}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsx("input",{type:"number",min:ii,max:si,step:16,value:r.materials.detailA.scalePx,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,detailA:{...g.materials.detailA,scalePx:ce(ct(p.target.value,g.materials.detailA.scalePx),ii,si)}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"}),m.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45 pt-1",children:"Detail B"}),m.jsx("input",{list:"sandbox-detail-paths",value:r.materials.detailB.path,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,detailB:{...g.materials.detailB,path:p.target.value}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs"}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsx("select",{value:r.materials.detailB.mode,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,detailB:{...g.materials.detailB,mode:p.target.value}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:Bc.map(p=>m.jsx("option",{value:p,children:p},`detail-b-${p}`))}),m.jsx("input",{type:"number",min:0,max:1,step:.01,value:r.materials.detailB.opacity,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,detailB:{...g.materials.detailB,opacity:ce(ct(p.target.value,g.materials.detailB.opacity),0,1)}}}),className:"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsx("input",{type:"number",min:ii,max:si,step:16,value:r.materials.detailB.scalePx,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,detailB:{...g.materials.detailB,scalePx:ce(ct(p.target.value,g.materials.detailB.scalePx),ii,si)}}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"}),m.jsx("div",{className:"text-[10px] uppercase tracking-[0.18em] text-white/45 pt-1",children:"Tint"}),m.jsxs("div",{className:"grid grid-cols-[72px_1fr] gap-3",children:[m.jsx("input",{type:"color",value:b,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,tintColor:p.target.value}}),className:"h-10 w-full rounded-lg border border-white/15 bg-white/5 p-1 cursor-pointer","aria-label":"Tint Color Picker"}),m.jsx("input",{value:r.materials.tintColor,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,tintColor:p.target.value}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",placeholder:"#8b6f4a"})]}),m.jsx("div",{className:"grid grid-cols-8 gap-2",children:wT.map(p=>m.jsx("button",{type:"button",onClick:()=>f(g=>g&&{...g,materials:{...g.materials,tintColor:p}}),className:`h-6 rounded border ${Bi(r.materials.tintColor)===Bi(p)?"border-white":"border-white/20"}`,style:{backgroundColor:p},title:p},`tint-swatch-${p}`))}),m.jsxs("div",{className:"space-y-2",children:[m.jsxs("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:["Tint Opacity ",r.materials.tintOpacity.toFixed(2)]}),m.jsx("input",{type:"range",min:0,max:1,step:.01,value:r.materials.tintOpacity,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,tintOpacity:ce(ct(p.target.value,g.materials.tintOpacity),0,1)}}),className:"w-full"})]}),m.jsx("select",{value:r.materials.tintBlend,onChange:p=>f(g=>g&&{...g,materials:{...g.materials,tintBlend:$a(p.target.value)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm",children:ET.map(p=>m.jsx("option",{value:p,children:p},`blend-${p}`))})]}),m.jsxs("section",{className:"space-y-3 pb-8",children:[m.jsx("div",{className:"text-xs font-black uppercase tracking-[0.2em] text-emerald-200",children:"Clutter"}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Density"}),m.jsx("input",{type:"number",min:0,max:1,step:.01,value:r.clutter.density,onChange:p=>f(g=>g&&{...g,clutter:{...g.clutter,density:ce(ct(p.target.value,g.clutter.density),0,1)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Max / Hex"}),m.jsx("input",{type:"number",min:0,max:5,step:1,value:r.clutter.maxPerHex,onChange:p=>f(g=>g&&{...g,clutter:{...g.clutter,maxPerHex:Math.max(0,Math.floor(ct(p.target.value,g.clutter.maxPerHex)))}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]}),m.jsxs("div",{children:[m.jsx("label",{className:"block text-[11px] uppercase tracking-[0.16em] text-white/60",children:"Bleed Max"}),m.jsx("input",{type:"number",min:1,max:2,step:.01,value:r.clutter.bleedScaleMax,onChange:p=>f(g=>g&&{...g,clutter:{...g.clutter,bleedScaleMax:ce(ct(p.target.value,g.clutter.bleedScaleMax),1,2)}}),className:"w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm"})]})]})]})]})]}),m.jsxs("main",{className:"flex-1 relative bg-[#050914] overflow-hidden",children:[m.jsxs("div",{className:"absolute top-4 right-5 z-20 px-3 py-2 rounded-lg border border-white/15 bg-black/35 text-[10px] font-black uppercase tracking-[0.2em]",children:["Theme: ",r.theme]}),m.jsx("div",{className:"w-full h-full p-6",children:m.jsx("div",{className:"w-full h-full rounded-[28px] border border-white/10 bg-[#030712]/70 overflow-hidden",children:m.jsx(o0,{gameState:S,onMove:()=>{},selectedSkillId:null,showMovementRange:!1,assetManifest:v})})})]})]})},UT=e=>{const{gameStatus:i,isReplayMode:a,isBusy:o,postCommitInputLock:c,isPlayerTurn:r,hasPendingStatus:f,pendingFrameCount:h}=e,b=f||h>0;let y="IDLE";return a?y="REPLAY":i!=="playing"?y="IDLE":b?y=o?"INTERCEPT_ANIMATING":"INTERCEPT_READY":o?y="PLAYBACK":c&&r?y="POST_COMMIT_LOCK":c&&!r?y="POST_COMMIT_QUEUE":r?y="INPUT_OPEN":y="QUEUE_ADVANCE",{phase:y,canPlayerInput:y==="INPUT_OPEN",shouldAdvanceQueue:y==="QUEUE_ADVANCE"||y==="POST_COMMIT_QUEUE",shouldResolvePending:y==="INTERCEPT_READY",queueAdvanceDelayMs:380}},qT=e=>{const i=e.payload;if(!(!i||typeof i!="object")){if("q"in i&&"r"in i)return{q:Number(i.q??0),r:Number(i.r??0),s:Number(i.s??0)};if(e.type==="USE_SKILL"){const a=i;return{skillId:a.skillId??"unknown",target:a.target?{q:a.target.q,r:a.target.r,s:a.target.s}:null}}if(e.type==="START_RUN")return{loadoutId:i.loadoutId??"unknown",mode:i.mode??"normal"};if(e.type==="LOAD_STATE"){const a=i;return{floor:a?.floor??0,gameStatus:a?.gameStatus??"unknown",turnNumber:a?.turnNumber??0,queueLength:Array.isArray(a?.initiativeQueue)?a.initiativeQueue.length:0}}return{}}};function zT(){const e=(F,te)=>{const de=new Set(F.map(Ot=>Ot.type)),we=de.has("ADVANCE_TURN"),ve=de.has("RESOLVE_PENDING"),Le=F.length,$e=te>=5&&Le<Math.max(25,te*4);return{actionCount:Le,hasTurnAdvance:we,hasPendingResolve:ve,suspiciouslyShort:$e}},i=F=>{const te=F||[],de=te.length>0?te[te.length-1]:void 0;return`${te.length}:${de?.type??"none"}`},a=F=>{const te=F||[],de=te.length>0?te[te.length-1]:void 0;return`${te.length}:${de?.id??"none"}:${de?.phase??"none"}`},[o,c]=w.useState(()=>window.location.pathname);w.useEffect(()=>{const F=()=>c(window.location.pathname);return window.addEventListener("popstate",F),()=>window.removeEventListener("popstate",F)},[]);const r=F=>{window.location.pathname!==F&&window.history.pushState({},"",F),c(F)},f=o.toLowerCase().startsWith("/hop")?"/Hop":"",h=`${f||""}`||"/",b=`${f}/Arcade`||"/Arcade",y=`${f}/Biomes`||"/Biomes",v=o.toLowerCase().replace(/\/+$/,""),S=v.endsWith("/arcade")||v.endsWith("/arcarde"),_=v.endsWith("/biomes"),[p,g]=w.useReducer(lA,null,()=>{const F=localStorage.getItem("hop_save");if(F)try{const te=JSON.parse(F);if(te.tiles){const ve=Array.isArray(te.tiles)?te.tiles:Object.entries(te.tiles);te.tiles=new Map(ve.map(([Le,$e])=>[Le,{...$e,traits:new Set($e.traits)}]))}Array.isArray(te.occupancyMask)&&(te.occupancyMask=te.occupancyMask.map(ve=>typeof ve=="string"?BigInt(ve):ve));const de=ve=>ve instanceof Map?ve:Array.isArray(ve)?new Map(ve):ve&&typeof ve=="object"?new Map(Object.entries(ve)):new Map,we=ve=>{const Le={...ve,components:de(ve?.components)},$e=Zl(Le),lt=($e.components??new Map).get("trinity");if(!lt)return $e;const Ye=Wc({body:Number(lt.body||0),mind:Number(lt.mind||0),instinct:Number(lt.instinct||0)});return{...$e,maxHp:Ye,hp:Math.min(Ye,Math.max(0,Number($e.hp??Ye)))}};return te.player=_f(we(te.player)),te.enemies=Array.isArray(te.enemies)?te.enemies.map(we):[],te}catch(te){console.error("Failed to hydrate Map state:",te)}return Cf()}),R=typeof window<"u"&&!!window.__HOP_DEBUG_QUERY,[I,C]=w.useState(null);w.useEffect(()=>{let F=!0;return QA().then(te=>{F&&(C(te),window.__HOP_ASSET_MANIFEST=te)}),()=>{F=!1}},[]),w.useEffect(()=>{R&&(window.state=p,window.QUERY={tile:(F,te)=>{const we=he({q:F,r:te});return console.log(`Checking Map for Key: "${we}"`),p.tiles.get(we)},whereAmI:()=>{const F=p.player.position,te=he(F),de=p.tiles.get(te);return{coords:F,key:te,tileExists:!!de,tileData:de}},dumpKeys:()=>Array.from(p.tiles.keys())})},[p,R]);const M=w.useRef(null),N=w.useRef(""),Y=p.gameStatus==="playing"||p.gameStatus==="choosing_upgrade",X=`${p.gameStatus}|${p.floor}|${p.turnNumber}|${p.player.hp}|${he(p.player.position)}|${p.enemies.length}|${p.actionLog?.length??0}|${p.message?.length??0}`;w.useEffect(()=>{if(M.current!==null&&(typeof window.cancelIdleCallback=="function"?window.cancelIdleCallback(M.current):window.clearTimeout(M.current),M.current=null),!Y){N.current="",localStorage.removeItem("hop_save");return}if(X===N.current)return;const F=()=>{const te={...p,tiles:Array.from(p.tiles.entries()).map(([we,ve])=>[we,{...ve,traits:Array.from(ve.traits)}])},de=we=>JSON.stringify(we,(ve,Le)=>typeof Le=="bigint"?Le.toString():Le);localStorage.setItem("hop_save",de(te)),N.current=X,M.current=null};return typeof window.requestIdleCallback=="function"?M.current=window.requestIdleCallback(F,{timeout:500}):M.current=window.setTimeout(F,120),()=>{M.current!==null&&(typeof window.cancelIdleCallback=="function"?window.cancelIdleCallback(M.current):window.clearTimeout(M.current),M.current=null)}},[p,Y,X]);const[O,q]=w.useState(!1),[K,ue]=w.useState([]),[W,_e]=w.useState(!1),[oe,be]=w.useState(null),pe=w.useRef(0),H=w.useRef(null);w.useEffect(()=>{if(!(typeof window<"u"&&!!window.__HOP_DEBUG_PERF))return;let te=0,de=performance.now(),we=0,ve=0,Le=de;const $e=Ot=>{const lt=Ot-de;if(de=Ot,we++,ve+=lt,Ot-Le>=2e3){const Ye=ve/Math.max(1,we),rt=1e3/Math.max(1,Ye);console.log("[HOP_PERF]",{fps:Number(rt.toFixed(1)),avgFrameMs:Number(Ye.toFixed(2)),frames:we}),Le=Ot,we=0,ve=0}te=requestAnimationFrame($e)};return te=requestAnimationFrame($e),()=>cancelAnimationFrame(te)},[p.gameStatus,O]);const[ee,ae]=w.useState(null),[Te,xe]=w.useState(!1),[k,$]=w.useState(!1),[J,me]=w.useState(!1),[Me,ke]=w.useState(0),Ie=w.useRef(null),pt=w.useRef(null),ze=w.useRef(null),Rt=w.useRef(null),qn=p.pendingFrames?.length??0,St=w.useMemo(()=>UT({gameStatus:p.gameStatus,isReplayMode:O,isBusy:k,postCommitInputLock:J,isPlayerTurn:Ql(p),hasPendingStatus:!!p.pendingStatus,pendingFrameCount:qn}),[p.gameStatus,O,k,J,p.pendingStatus,qn,p.initiativeQueue,p.player.id,p.enemies]),Gt=!St.canPlayerInput,_t=w.useRef([]),zn=w.useRef(0),ai=w.useRef(""),Ve=p.initiativeQueue?.entries?.[Math.max(0,p.initiativeQueue.currentIndex??0)]?.actorId??p.initiativeQueue?.entries?.[0]?.actorId??"none",De=w.useCallback((F,te)=>{const de={id:++zn.current,t:Date.now(),event:F,turnNumber:p.turnNumber,phase:St.phase,gameStatus:p.gameStatus,playerTurn:Ql(p),isBusy:k,postCommitInputLock:J,pendingStatus:p.pendingStatus?.status??"none",pendingFrames:p.pendingFrames?.length??0,canPlayerInput:St.canPlayerInput,shouldAdvanceQueue:St.shouldAdvanceQueue,shouldResolvePending:St.shouldResolvePending,actionLogLength:p.actionLog?.length??0,queueHead:Ve,details:te};_t.current.push(de),_t.current.length>800&&_t.current.splice(0,_t.current.length-800)},[p.turnNumber,p.gameStatus,p.pendingStatus,p.pendingFrames,p.actionLog,p.initiativeQueue,p.player.id,p.enemies,St.phase,St.canPlayerInput,St.shouldAdvanceQueue,St.shouldResolvePending,k,J,Ve]),Ne=w.useCallback((F,te)=>{De("DISPATCH",{source:te,actionType:F.type,payload:qT(F)}),g(F)},[De]);w.useEffect(()=>{const F=[St.phase,p.turnNumber,p.gameStatus,p.pendingStatus?.status??"none",p.pendingFrames?.length??0,k?1:0,J?1:0,Ve].join("|");F!==ai.current&&(De("TURN_STATE"),ai.current=F)},[St.phase,p.turnNumber,p.gameStatus,p.pendingStatus,p.pendingFrames,k,J,Ve,De]),w.useEffect(()=>(window.__HOP_TURN_TRACE=_t.current,window.__HOP_DUMP_TURN_TRACE=()=>[..._t.current],window.__HOP_PRINT_TURN_TRACE=(F=80)=>{const te=_t.current.slice(-Math.max(1,Math.floor(F)));return console.table(te.map(de=>({id:de.id,event:de.event,turn:de.turnNumber,phase:de.phase,status:de.gameStatus,playerTurn:de.playerTurn,busy:de.isBusy,lock:de.postCommitInputLock,pending:`${de.pendingStatus}/${de.pendingFrames}`,queueHead:de.queueHead,actionLog:de.actionLogLength,details:de.details?JSON.stringify(de.details):""}))),te},window.__HOP_CLEAR_TURN_TRACE=()=>{_t.current.length=0,zn.current=0},_t.current.push({id:++zn.current,t:Date.now(),event:"TRACE_READY",turnNumber:0,phase:"INIT",gameStatus:"init",playerTurn:!1,isBusy:!1,postCommitInputLock:!1,pendingStatus:"none",pendingFrames:0,canPlayerInput:!1,shouldAdvanceQueue:!1,shouldResolvePending:!1,actionLogLength:0,queueHead:"none"}),()=>{delete window.__HOP_DUMP_TURN_TRACE,delete window.__HOP_PRINT_TURN_TRACE,delete window.__HOP_CLEAR_TURN_TRACE}),[]);const dt=w.useRef([]),Mt=w.useRef(null),gn=w.useRef(""),[$n,At]=w.useState([]),Vn=w.useCallback(F=>{const te=Date.now();At(de=>[...de,{...F,createdAt:te}].slice(-4))},[]),bi=w.useCallback(F=>{if(!(!F||F.length===0)){dt.current=[...dt.current,...F].slice(-600),window.__HOP_SIM_EVENTS=dt.current,window.dispatchEvent(new CustomEvent("hop:simulation-events",{detail:{turn:p.turnNumber,events:F}})),De("SIM_EVENTS",{count:F.length,lastType:F[F.length-1]?.type??"unknown"});for(const te of F)if(te.type==="DamageTaken"&&te.targetId===p.player.id){const de=Math.max(0,Number(te.payload?.amount||0));de>0&&Vn({id:`sim-toast-${te.id}`,text:`-${de} HP`,tone:"damage"})}else if(te.type==="Healed"&&te.targetId===p.player.id){const de=Math.max(0,Number(te.payload?.amount||0));de>0&&Vn({id:`sim-toast-${te.id}`,text:`+${de} HP`,tone:"heal"})}else if(te.type==="StatusApplied"&&te.targetId===p.player.id){const we=String(te.payload?.status||"Status").split("_").filter(Boolean).map(ve=>ve.charAt(0).toUpperCase()+ve.slice(1)).join(" ");Vn({id:`sim-toast-${te.id}`,text:we,tone:"status"})}else if(te.type==="MessageLogged"){const de=String(te.payload?.text||"").trim();if(!de)continue;const we=de.toLowerCase();if(!(we.includes("stun")||we.includes("snare")||we.includes("lava")||we.includes("fire")||we.includes("burn")||we.includes("heal")||we.includes("shrine")||we.includes("stairs")||we.includes("roll away")||we.includes("ward")||we.includes("orb")))continue;const Le=de.length>52?`${de.slice(0,49)}...`:de;Vn({id:`sim-toast-${te.id}`,text:Le,tone:"system"})}}},[De,p.turnNumber,p.player.id,Vn]),ht=w.useCallback(F=>{Mt.current=F,window.__HOP_UI_MIRROR=F},[]);w.useEffect(()=>(window.__HOP_SIM_EVENTS=dt.current,window.__HOP_DUMP_SIM_EVENTS=()=>[...dt.current],window.__HOP_CLEAR_SIM_EVENTS=()=>{dt.current=[],window.__HOP_SIM_EVENTS=[]},window.__HOP_DUMP_MIRROR=()=>window.__HOP_MIRROR_LAST,()=>{delete window.__HOP_DUMP_SIM_EVENTS,delete window.__HOP_CLEAR_SIM_EVENTS,delete window.__HOP_DUMP_MIRROR}),[]),w.useEffect(()=>{if($n.length===0)return;const F=window.setTimeout(()=>{const te=Date.now();At(de=>de.filter(we=>te-we.createdAt<2200))},180);return()=>window.clearTimeout(F)},[$n]),w.useEffect(()=>{const F=pA(p);window.__HOP_ENGINE_MIRROR=F;const te=Mt.current;if(!te||te.turn!==F.turn||te.stackTick!==F.stackTick)return;const de=hA(F,te),we=`${F.turn}:${F.stackTick}:${de.ok?"ok":de.mismatches.length}`;we!==gn.current&&(gn.current=we,window.__HOP_MIRROR_LAST={engineSnapshot:F,uiSnapshot:te,result:de},de.ok||(De("MIRROR_MISMATCH",{count:de.mismatches.length}),console.warn("[HOP_MIRROR] snapshot mismatch detected",de.mismatches)))},[p,De]),w.useEffect(()=>{if(!St.shouldAdvanceQueue)return;De("QUEUE_SCHEDULE",{delayMs:St.queueAdvanceDelayMs});const F=window.setTimeout(()=>{Ne({type:"ADVANCE_TURN"},"queue_pump")},St.queueAdvanceDelayMs);return()=>window.clearTimeout(F)},[St.shouldAdvanceQueue,St.queueAdvanceDelayMs,p.turnNumber,p.initiativeQueue,p.player.id,p.enemies,Ne,De]);const Bt=(F="unknown")=>{J&&De("LOCK_RELEASE",{reason:F,lockTurn:Ie.current,expectedActionLogLength:pt.current}),me(!1),Ie.current=null,pt.current=null,ze.current=null,In.current=!1,Xt.current="",yn.current="",Rt.current!==null&&(window.clearTimeout(Rt.current),Rt.current=null)},Yn=w.useRef(""),$t=i(p.visualEvents),as=w.useRef(""),Wt=a(p.timelineEvents),In=w.useRef(!1),Xt=w.useRef(""),yn=w.useRef(""),Ut=220,An=900,xi=w.useRef(!1),en=w.useRef(0),dn=`${p.pendingStatus?.status??"none"}:${qn}`;w.useEffect(()=>{k||(Yn.current=$t,as.current=Wt)},[k,$t,Wt]),w.useEffect(()=>{xi.current=!1,en.current=performance.now()},[dn]),w.useEffect(()=>{(p.pendingStatus||qn>0)&&k&&(xi.current=!0)},[p.pendingStatus,qn,k]),w.useEffect(()=>{J&&k&&(In.current=!0)},[J,k]),w.useEffect(()=>{if(!J)return;const F=window.setTimeout(()=>{ke(te=>te+1)},120);return()=>window.clearTimeout(F)},[J,Me]),w.useEffect(()=>{const F=!k&&$t===Yn.current&&Wt===as.current,te=(p.timelineEvents||[]).some(rt=>rt.blocking),de=(p.timelineEvents||[]).filter(rt=>rt.blocking).reduce((rt,Vt)=>rt+(Vt.suggestedDurationMs||0),0),we=(p.visualEvents||[]).reduce((rt,Vt)=>{if(Vt.type!=="kinetic_trace")return rt;const Dn=Vt.payload;if(!Dn)return rt;const Ct=Math.max(0,Number(Dn.startDelayMs||0)),ls=Math.max(0,Number(Dn.durationMs||0));return Math.max(rt,Ct+ls)},0),ve=Math.max(de,we),Le=ve>0?Math.max(160,Math.min(3200,ve+40)):0,$e=Math.max(0,performance.now()-en.current),Ot=!te||xi.current,lt=!te||$e>=Le,Ye=F&&(Ot||lt);if(St.shouldResolvePending){if(Ye){De("PENDING_RESOLVE_READY",{noPendingAnimations:F,hasBlockingTimeline:te,movementTraceBudgetMs:we,elapsedPendingMs:$e,requiredFallbackDelayMs:Le}),Ne({type:"RESOLVE_PENDING"},"pending_ready");return}if(!k&&te&&!xi.current){De("PENDING_RESOLVE_WAIT",{movementTraceBudgetMs:we,elapsedPendingMs:$e,requiredFallbackDelayMs:Le});const rt=Math.max(0,Le-$e),Vt=window.setTimeout(()=>{Ne({type:"RESOLVE_PENDING"},"pending_fallback_delay")},rt);return()=>window.clearTimeout(Vt)}}},[St.shouldResolvePending,p.timelineEvents,p.visualEvents,k,$t,Wt,Ne,De]),w.useEffect(()=>{if(!J)return;if(O||p.gameStatus!=="playing"){Bt("mode_or_status_change");return}if(p.pendingStatus||(p.pendingFrames?.length??0)>0){Bt("pending_intercept");return}const F=Ie.current,te=pt.current,de=ze.current!==null?Math.max(0,performance.now()-ze.current):Number.POSITIVE_INFINITY,we=F!==null?p.turnNumber>F:!1,ve=te!==null?(p.actionLog?.length??0)>=te:!1,Le=de>=Ut,$e=$t!==Xt.current||Wt!==yn.current,Ot=!we&&!ve,lt=!In.current&&$e&&de<An,Ye=p.gameStatus==="playing"&&!O&&!k&&!p.pendingStatus&&(p.pendingFrames?.length??0)===0&&Ql(p);if(lt){De("LOCK_WAIT_FOR_BUSY",{lockAgeMs:de,visualsChangedSinceArm:$e});return}if(Ye&&Ot&&de>450){Bt("no_progress_timeout");return}Ye&&Le&&(we||ve||de>1500)&&Bt(we?"turn_advanced":ve?"action_committed":"age_fallback")},[J,O,p.gameStatus,p.turnNumber,p.pendingStatus,p.pendingFrames,p.initiativeQueue,p.actionLog,k,p.player.id,p.enemies,De,$t,Wt,Me]),w.useEffect(()=>{p.gameStatus!=="playing"&&J&&Bt("not_playing")},[p.gameStatus,J,De]),w.useEffect(()=>{if(J)return Rt.current!==null&&window.clearTimeout(Rt.current),Rt.current=window.setTimeout(()=>{J&&(console.error("[HOP_INPUT_LOCK] Watchdog released stuck post-commit lock",{turnNumber:p.turnNumber,pendingStatus:p.pendingStatus?.status,pendingFrames:p.pendingFrames?.length??0,playerTurn:Ql(p),isBusy:k,actionLogLength:p.actionLog?.length??0,traceTail:_t.current.slice(-40)}),De("LOCK_WATCHDOG_RELEASE"),Bt("watchdog"))},8e3),()=>{Rt.current!==null&&(window.clearTimeout(Rt.current),Rt.current=null)}},[J,p.turnNumber,p.pendingStatus,p.actionLog,k,p.initiativeQueue,p.player.id,p.enemies,De]),w.useEffect(()=>{if(!J)return;const F=window.setTimeout(()=>{De("LOCK_STALL_SNAPSHOT",{lockAgeMs:ze.current!==null?Math.max(0,performance.now()-ze.current):null})},2500);return()=>window.clearTimeout(F)},[J,De]);const[Bn,Tn]=w.useState(null),[En,Ue]=w.useState(null),Tt=w.useRef(p.floor);w.useEffect(()=>{if(p.gameStatus==="playing"&&p.floor!==Tt.current){Ue({floor:p.floor,theme:p.theme||"Inferno"}),Tt.current=p.floor;const F=setTimeout(()=>Ue(null),3e3);return()=>clearTimeout(F)}},[p.floor,p.gameStatus,p.theme]),w.useEffect(()=>{if(p.gameStatus==="playing"&&p.floor===1&&!Tt.current){Ue({floor:1,theme:p.theme||"Inferno"}),Tt.current=1;const F=setTimeout(()=>Ue(null),3e3);return()=>clearTimeout(F)}},[p.gameStatus]);const bn=()=>{Rt.current!==null&&(window.clearTimeout(Rt.current),Rt.current=null),Ie.current=p.turnNumber,pt.current=(p.actionLog?.length??0)+1,ze.current=performance.now(),In.current=!1,Xt.current=$t,yn.current=Wt,me(!0),De("LOCK_ARM",{lockTurn:p.turnNumber,expectedActionLogLength:(p.actionLog?.length??0)+1,eventHashAtArm:$t,timelineHashAtArm:Wt})},ks=F=>{Gt||ae(F)},jt=F=>{if(!Gt){if(ee){bn(),Ne({type:"USE_SKILL",payload:{skillId:ee,target:F}},"player_use_skill"),ae(null);return}if(ne(F,p.player.position)){xe(!Te);return}bn(),Ne({type:"MOVE",payload:F},"player_move"),xe(!1)}},tn=F=>{O||k||Ne({type:"SELECT_UPGRADE",payload:F},"upgrade_select")},Fn=()=>{Ne({type:"RESET"},"reset"),ae(null),q(!1),be(null)},vi=()=>{Gt||(bn(),Ne({type:"WAIT"},"player_wait"),ae(null))},os=F=>{if(!F)return;const te=Wg(F.actions||[]);if(!te.valid){const Le=`Replay rejected: ${te.errors.slice(0,3).join(" | ")}`;be(Le),console.error("[HOP_REPLAY] Invalid replay actions",{replayId:F.id,errors:te.errors});return}be(null),q(!0),ue(te.actions),_e(!1),pe.current=0;const de=F.seed||F.id||String(Date.now()),we=F.loadoutId?Uo[F.loadoutId]:void 0,ve=Cs(1,de,de,void 0,we);Ne({type:"LOAD_STATE",payload:ve},"replay_start")},Fi=()=>{const F=pe.current;if(F>=K.length){_e(!1);return}Ne(K[F],"replay_step"),pe.current=F+1};w.useEffect(()=>{if(!W||!O)return;const F=window.setInterval(Fi,500);return()=>window.clearInterval(F)},[W,O,K]);const Ls=()=>{q(!1),be(null),nn()},Di=(F,te)=>{Ne({type:"LOAD_STATE",payload:F},"scenario_load"),Tn(te),ae(null)},nn=()=>{Ne({type:"EXIT_TO_HUB"},"exit_to_hub"),ae(null),q(!1),be(null),r(h)};w.useEffect(()=>{if(!O){if((p.gameStatus==="won"||p.gameStatus==="lost")&&H.current!==p.initialSeed){H.current=p.initialSeed||"default";const F=p.initialSeed??p.rngSeed??"0",te=p.completedRun?.score||(p.player.hp||0)+(p.floor||0)*100,de=Wg(p.actionLog||[]);if(!de.valid){console.error("[HOP_REPLAY] Refusing to persist replay with invalid action log",{errors:de.errors});return}const we=e(de.actions,p.floor||0),ve={id:`run-${Date.now()}`,seed:F,loadoutId:p.player.archetype,actions:de.actions,score:te,floor:p.floor,date:new Date().toISOString(),replayVersion:2,diagnostics:we},Le=localStorage.getItem("hop_replays_v1"),$e=Le?JSON.parse(Le):[],Ot=[ve,...$e].slice(0,100);localStorage.setItem("hop_replays_v1",JSON.stringify(Ot));const lt=localStorage.getItem("hop_leaderboard_v1");let Ye=lt?JSON.parse(lt):[];Ye.push({id:ve.id,name:"Player",score:ve.score,floor:ve.floor,date:ve.date,seed:ve.seed,loadoutId:ve.loadoutId,actions:ve.actions,replayVersion:ve.replayVersion,diagnostics:ve.diagnostics}),Ye.sort((rt,Vt)=>Vt.score-rt.score),Ye=Ye.slice(0,5),localStorage.setItem("hop_leaderboard_v1",JSON.stringify(Ye))}p.gameStatus==="hub"&&(H.current=null)}},[p.gameStatus,O,p.initialSeed]);const Si=F=>{const te=p.selectedLoadoutId;if(!te){console.warn("Start Run called without a selected loadout.");return}Ne({type:"START_RUN",payload:{loadoutId:te,mode:F}},"hub_start_run")},jn=F=>{Ne({type:"START_RUN",payload:{loadoutId:F,mode:"daily"}},"arcade_start_run"),r(h)};return _?m.jsx(PT,{assetManifest:I,onBack:()=>r(h)}):p.gameStatus==="hub"?m.jsxs("div",{className:"w-screen h-screen bg-[#030712] overflow-hidden text-white font-['Inter',_sans-serif]",children:[!S&&m.jsx("button",{type:"button",onClick:()=>r(y),className:"absolute top-4 right-4 z-40 px-4 py-2 rounded-xl border border-cyan-300/35 bg-cyan-500/10 hover:bg-cyan-500/20 text-[10px] font-black uppercase tracking-[0.2em]",children:"Biome Sandbox"}),S?m.jsx(AT,{onBack:()=>r(h),onLaunchArcade:jn}):m.jsx(bT,{gameState:p,onSelectLoadout:F=>{Ne({type:"APPLY_LOADOUT",payload:F},"hub_select_loadout")},onStartRun:Si,onOpenArcade:()=>r(b),onLoadScenario:Di,onStartReplay:os}),oe&&m.jsx("div",{className:"absolute top-4 right-4 z-40 max-w-xl px-4 py-3 rounded-xl border border-red-400/40 bg-red-900/70 text-red-100 text-xs font-bold tracking-wide",children:oe}),Bn&&m.jsxs("div",{className:"absolute top-8 left-1/2 -translate-x-1/2 bg-blue-900/90 border border-blue-500/30 p-4 rounded-xl backdrop-blur-md shadow-xl z-30 max-w-lg text-center animate-in fade-in slide-in-from-top-4",children:[m.jsx("h4",{className:"text-blue-200 font-bold uppercase text-xs tracking-widest mb-1",children:"Simulation Objective"}),m.jsx("p",{className:"text-white text-sm",children:Bn}),m.jsx("button",{onClick:()=>Tn(null),className:"absolute -top-2 -right-2 w-6 h-6 bg-blue-950 rounded-full border border-blue-500/50 flex items-center justify-center text-xs hover:bg-blue-800 transition-colors",children:""})]})]}):m.jsxs("div",{className:"flex flex-col lg:flex-row w-screen h-screen bg-[#030712] overflow-hidden text-white font-['Inter',_sans-serif]",children:[m.jsx("div",{className:"lg:hidden shrink-0 border-b border-white/5 bg-[#030712]/95 backdrop-blur-sm z-20",children:m.jsxs("div",{className:"px-4 py-3 flex items-center justify-between gap-4",children:[m.jsxs("div",{className:"min-w-0",children:[m.jsx("div",{className:"text-[10px] uppercase tracking-[0.2em] text-white/35 font-bold",children:"Level"}),m.jsxs("div",{className:"text-lg font-black text-white leading-none",children:[p.floor,m.jsx("span",{className:"text-white/25 text-sm ml-1",children:"/ 10"})]})]}),m.jsxs("div",{className:"ml-auto min-w-0 text-right",children:[m.jsx("div",{className:"text-[10px] uppercase tracking-[0.2em] text-white/35 font-bold",children:"HP"}),m.jsxs("div",{className:"text-lg font-black text-red-400 leading-none",children:[p.player.hp,m.jsxs("span",{className:"text-white/25 text-sm ml-1",children:["/ ",p.player.maxHp]})]})]})]})}),m.jsx("aside",{className:"hidden lg:flex w-80 border-r border-white/5 bg-[#030712] flex-col z-20 overflow-y-auto",children:m.jsx(fT,{gameState:p,onReset:Fn,onWait:vi,onExitToHub:nn,inputLocked:Gt})}),m.jsx("main",{className:"flex-1 min-h-0 relative flex items-center justify-center bg-[#020617] overflow-hidden",children:m.jsx("div",{className:"w-full h-full p-0 sm:p-3 lg:p-8 flex items-center justify-center",children:m.jsxs("div",{className:`w-full h-full relative border border-white/5 bg-[#030712]/50 rounded-none sm:rounded-3xl lg:rounded-[40px] shadow-[inset_0_0_100px_rgba(0,0,0,0.5)] flex items-center justify-center overflow-hidden ${p.isShaking?"animate-shake":""}`,children:[m.jsx(o0,{gameState:p,onMove:jt,selectedSkillId:ee,showMovementRange:Te,onBusyStateChange:$,assetManifest:I,onSimulationEvents:bi,onMirrorSnapshot:ht}),Gt&&p.gameStatus==="playing"&&m.jsx("div",{className:"absolute inset-0 z-40 pointer-events-auto",children:m.jsx("div",{className:"absolute top-3 sm:top-4 lg:top-6 left-1/2 -translate-x-1/2 h-10 w-10 rounded-full bg-black/55 border border-white/15 text-lg flex items-center justify-center text-white/80 animate-pulse","aria-label":"Resolving turn",title:"Resolving turn",children:""})})]})})}),p.gameStatus==="playing"&&$n.length>0&&m.jsx("div",{className:"lg:hidden fixed left-1/2 -translate-x-1/2 top-16 z-50 pointer-events-none flex flex-col gap-2 w-[min(92vw,26rem)]",children:$n.map(F=>{const te=F.tone==="damage"?"border-red-400/30 bg-red-950/75 text-red-100":F.tone==="heal"?"border-emerald-400/30 bg-emerald-950/70 text-emerald-100":F.tone==="status"?"border-cyan-300/30 bg-cyan-950/70 text-cyan-100":"border-white/15 bg-black/65 text-white/85";return m.jsx("div",{className:`rounded-xl border px-3 py-2 backdrop-blur-md shadow-[0_4px_20px_rgba(0,0,0,0.35)] text-xs font-bold tracking-wide ${te}`,children:F.text},F.id)})}),m.jsx("aside",{className:"lg:hidden shrink-0 h-[26svh] min-h-[160px] max-h-[250px] border-t border-white/5 bg-[#030712] z-20 overflow-y-auto",children:m.jsxs("div",{className:"p-3 flex flex-col gap-3 h-full",children:[m.jsxs("div",{className:"flex items-center justify-between gap-2",children:[m.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-white/30",children:"Skills"}),m.jsxs("div",{className:"flex items-center gap-1.5",children:[m.jsx("button",{disabled:Gt,onClick:vi,className:`px-2.5 py-1.5 rounded-lg border text-[10px] font-black uppercase tracking-widest ${Gt?"bg-white/[0.03] border-white/5 text-white/30 opacity-50":"bg-white/5 border-white/10 text-white/70 active:bg-white/10"}`,children:"Wait"}),m.jsx("button",{onClick:nn,className:"px-2.5 py-1.5 rounded-lg border border-white/10 bg-white/5 text-[10px] font-black uppercase tracking-widest text-white/70 active:bg-white/10",children:"Hub"}),m.jsx("button",{onClick:Fn,className:"px-2.5 py-1.5 rounded-lg border border-red-500/20 bg-red-500/10 text-[10px] font-black uppercase tracking-widest text-red-300/90 active:bg-red-500/20",children:"Reset"})]})]}),m.jsx(xy,{skills:p.player.activeSkills||[],selectedSkillId:ee,onSelectSkill:ks,hasSpear:p.hasSpear,gameState:p,inputLocked:Gt,compact:!0})]})}),m.jsx("aside",{className:"hidden lg:flex w-80 border-l border-white/5 bg-[#030712] flex-col z-20 overflow-y-auto",children:m.jsxs("div",{className:"p-6 flex flex-col gap-8 h-full",children:[m.jsxs("div",{className:"flex-1",children:[m.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.2em] text-white/30 mb-6",children:"Tactical Skills"}),m.jsx(xy,{skills:p.player.activeSkills||[],selectedSkillId:ee,onSelectSkill:ks,hasSpear:p.hasSpear,gameState:p,inputLocked:Gt})]}),m.jsx("div",{className:"pt-8 border-t border-white/5 text-center",children:m.jsx("div",{className:"text-[10px] font-bold uppercase tracking-widest text-white/20",children:"Hop Engine v5.0"})})]})}),Bn&&m.jsxs("div",{className:"absolute top-8 left-1/2 -translate-x-1/2 bg-blue-900/90 border border-blue-500/30 p-4 rounded-xl backdrop-blur-md shadow-xl z-30 max-w-lg text-center animate-in fade-in slide-in-from-top-4",children:[m.jsx("h4",{className:"text-blue-200 font-bold uppercase text-xs tracking-widest mb-1",children:"Simulation Objective"}),m.jsx("p",{className:"text-white text-sm",children:Bn}),m.jsx("button",{onClick:()=>Tn(null),className:"absolute -top-2 -right-2 w-6 h-6 bg-blue-950 rounded-full border border-blue-500/50 flex items-center justify-center text-xs hover:bg-blue-800 transition-colors",children:""})]}),p.gameStatus==="choosing_upgrade"&&m.jsx(mT,{onSelect:tn,gameState:p}),p.gameStatus==="lost"&&m.jsxs("div",{className:"fixed inset-0 bg-red-950/90 backdrop-blur-xl flex flex-col items-center justify-center z-[200] transition-opacity duration-500",children:[m.jsx("div",{className:"text-8xl mb-8 animate-bounce",children:""}),m.jsx("h2",{className:"text-6xl font-black text-white mb-2 tracking-tighter italic uppercase",children:"Identity Deleted"}),m.jsx("p",{className:"text-red-200/60 mb-12 text-xl font-medium tracking-widest uppercase",children:"Simulation Terminated"}),m.jsx("button",{onClick:Fn,className:"px-12 py-4 bg-white text-black rounded-2xl font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-[0_0_50px_rgba(255,255,255,0.3)]",children:"Reinitialize Simulation"})]}),p.gameStatus==="won"&&m.jsxs("div",{className:"fixed inset-0 bg-indigo-950/90 backdrop-blur-xl flex flex-col items-center justify-center z-[200] transition-opacity duration-500",children:[m.jsx("div",{className:"text-8xl mb-8 animate-bounce",children:""}),m.jsx("h2",{className:"text-6xl font-black text-white mb-2 tracking-tighter italic uppercase",children:"Arcade Mode Cleared"}),m.jsx("p",{className:"text-indigo-200/60 mb-2 text-xl font-medium tracking-widest uppercase",children:"The Sentinel has fallen"}),m.jsxs("p",{className:"text-white/20 mb-12 text-sm font-bold uppercase tracking-[0.3em]",children:["Score: ",p.completedRun?.score||0]}),m.jsx("button",{onClick:nn,className:"px-12 py-4 bg-white text-black rounded-2xl font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-[0_0_50px_rgba(255,255,255,0.3)]",children:"Return to Command Center"})]}),En&&m.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[150] pointer-events-none animate-in fade-in duration-700",children:m.jsxs("div",{className:"text-center",children:[m.jsxs("div",{className:"text-indigo-500 font-black text-2xl uppercase tracking-[0.5em] mb-4 animate-in slide-in-from-bottom-8 duration-1000",children:["Floor ",En.floor]}),m.jsx("h2",{className:"text-8xl font-black text-white uppercase tracking-tighter italic animate-in slide-in-from-top-12 duration-1000",children:En.theme}),m.jsx("div",{className:"h-1 w-64 bg-white/20 mx-auto mt-8 rounded-full overflow-hidden",children:m.jsx("div",{className:"h-full bg-indigo-500 animate-[progress_3s_linear]"})})]})}),O&&m.jsxs("div",{className:"fixed bottom-12 left-1/2 -translate-x-1/2 bg-[#030712]/90 border border-indigo-500/30 p-6 rounded-3xl backdrop-blur-2xl shadow-[0_0_50px_rgba(79,70,229,0.2)] z-[250] flex items-center gap-8 animate-in slide-in-from-bottom-8 duration-500",children:[m.jsxs("div",{className:"flex flex-col",children:[m.jsx("span",{className:"text-[10px] font-black uppercase tracking-[0.3em] text-indigo-400 mb-1",children:"Replay System"}),m.jsxs("span",{className:"text-white font-bold text-sm",children:["Step ",pe.current," / ",K.length]})]}),m.jsx("div",{className:"h-8 w-px bg-white/10"}),m.jsxs("div",{className:"flex items-center gap-4",children:[m.jsx("button",{onClick:()=>_e(!W),className:`w-12 h-12 rounded-xl flex items-center justify-center transition-all ${W?"bg-indigo-500 text-white shadow-[0_0_20px_rgba(79,70,229,0.5)]":"bg-white/5 text-white/50 hover:bg-white/10"}`,children:W?"":""}),m.jsx("button",{onClick:Fi,disabled:W,className:"w-12 h-12 bg-white/5 hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-white/5 text-white rounded-xl flex items-center justify-center transition-all",children:""})]}),m.jsx("div",{className:"h-8 w-px bg-white/10"}),m.jsx("button",{onClick:Ls,className:"px-6 py-3 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-xl font-bold uppercase text-xs tracking-widest transition-all",children:"Close"})]})]})}Gb.createRoot(document.getElementById("root")).render(m.jsx(w.StrictMode,{children:m.jsx(zT,{})}));
